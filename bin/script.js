 /* file: bin/data.js */

/* file: script/lib/ua-parser.js */

(function(window, undefined) {
    "use strict";
    var LIBVERSION = "0.7.10"
      , EMPTY = ""
      , UNKNOWN = "?"
      , FUNC_TYPE = "function"
      , UNDEF_TYPE = "undefined"
      , OBJ_TYPE = "object"
      , STR_TYPE = "string"
      , MAJOR = "major"
      , MODEL = "model"
      , NAME = "name"
      , TYPE = "type"
      , VENDOR = "vendor"
      , VERSION = "version"
      , ARCHITECTURE = "architecture"
      , CONSOLE = "console"
      , MOBILE = "mobile"
      , TABLET = "tablet"
      , SMARTTV = "smarttv"
      , WEARABLE = "wearable"
      , EMBEDDED = "embedded";
    var util = {
        extend: function(regexes, extensions) {
            var margedRegexes = {};
            for (var i in regexes) {
                if (extensions[i] && extensions[i].length % 2 === 0) {
                    margedRegexes[i] = extensions[i].concat(regexes[i])
                } else {
                    margedRegexes[i] = regexes[i]
                }
            }
            return margedRegexes
        },
        has: function(str1, str2) {
            if (typeof str1 === "string") {
                return str2.toLowerCase().indexOf(str1.toLowerCase()) !== -1
            } else {
                return false
            }
        },
        lowerize: function(str) {
            return str.toLowerCase()
        },
        major: function(version) {
            return typeof version === STR_TYPE ? version.split(".")[0] : undefined
        }
    };
    var mapper = {
        rgx: function() {
            var result, i = 0, j, k, p, q, matches, match, args = arguments;
            while (i < args.length && !matches) {
                var regex = args[i]
                  , props = args[i + 1];
                if (typeof result === UNDEF_TYPE) {
                    result = {};
                    for (p in props) {
                        if (props.hasOwnProperty(p)) {
                            q = props[p];
                            if (typeof q === OBJ_TYPE) {
                                result[q[0]] = undefined
                            } else {
                                result[q] = undefined
                            }
                        }
                    }
                }
                j = k = 0;
                while (j < regex.length && !matches) {
                    matches = regex[j++].exec(this.getUA());
                    if (!!matches) {
                        for (p = 0; p < props.length; p++) {
                            match = matches[++k];
                            q = props[p];
                            if (typeof q === OBJ_TYPE && q.length > 0) {
                                if (q.length == 2) {
                                    if (typeof q[1] == FUNC_TYPE) {
                                        result[q[0]] = q[1].call(this, match)
                                    } else {
                                        result[q[0]] = q[1]
                                    }
                                } else if (q.length == 3) {
                                    if (typeof q[1] === FUNC_TYPE && !(q[1].exec && q[1].test)) {
                                        result[q[0]] = match ? q[1].call(this, match, q[2]) : undefined
                                    } else {
                                        result[q[0]] = match ? match.replace(q[1], q[2]) : undefined
                                    }
                                } else if (q.length == 4) {
                                    result[q[0]] = match ? q[3].call(this, match.replace(q[1], q[2])) : undefined
                                }
                            } else {
                                result[q] = match ? match : undefined
                            }
                        }
                    }
                }
                i += 2
            }
            return result
        },
        str: function(str, map) {
            for (var i in map) {
                if (typeof map[i] === OBJ_TYPE && map[i].length > 0) {
                    for (var j = 0; j < map[i].length; j++) {
                        if (util.has(map[i][j], str)) {
                            return i === UNKNOWN ? undefined : i
                        }
                    }
                } else if (util.has(map[i], str)) {
                    return i === UNKNOWN ? undefined : i
                }
            }
            return str
        }
    };
    var maps = {
        browser: {
            oldsafari: {
                version: {
                    "1.0": "/8",
                    1.2: "/1",
                    1.3: "/3",
                    "2.0": "/412",
                    "2.0.2": "/416",
                    "2.0.3": "/417",
                    "2.0.4": "/419",
                    "?": "/"
                }
            }
        },
        device: {
            amazon: {
                model: {
                    "Fire Phone": ["SD", "KF"]
                }
            },
            sprint: {
                model: {
                    "Evo Shift 4G": "7373KT"
                },
                vendor: {
                    HTC: "APA",
                    Sprint: "Sprint"
                }
            }
        },
        os: {
            windows: {
                version: {
                    ME: "4.90",
                    "NT 3.11": "NT3.51",
                    "NT 4.0": "NT4.0",
                    2000: "NT 5.0",
                    XP: ["NT 5.1", "NT 5.2"],
                    Vista: "NT 6.0",
                    7: "NT 6.1",
                    8: "NT 6.2",
                    8.1: "NT 6.3",
                    10: ["NT 6.4", "NT 10.0"],
                    RT: "ARM"
                }
            }
        }
    };
    var regexes = {
        browser: [[/(opera\smini)\/([\w\.-]+)/i, /(opera\s[mobiletab]+).+version\/([\w\.-]+)/i, /(opera).+version\/([\w\.]+)/i, /(opera)[\/\s]+([\w\.]+)/i], [NAME, VERSION], [/(OPiOS)[\/\s]+([\w\.]+)/i], [[NAME, "Opera Mini"], VERSION], [/\s(opr)\/([\w\.]+)/i], [[NAME, "Opera"], VERSION], [/(kindle)\/([\w\.]+)/i, /(lunascape|maxthon|netfront|jasmine|blazer)[\/\s]?([\w\.]+)*/i, /(avant\s|iemobile|slim|baidu)(?:browser)?[\/\s]?([\w\.]*)/i, /(?:ms|\()(ie)\s([\w\.]+)/i, /(rekonq)\/([\w\.]+)*/i, /(chromium|flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs)\/([\w\.-]+)/i], [NAME, VERSION], [/(trident).+rv[:\s]([\w\.]+).+like\sgecko/i], [[NAME, "IE"], VERSION], [/(edge)\/((\d+)?[\w\.]+)/i], [NAME, VERSION], [/(yabrowser)\/([\w\.]+)/i], [[NAME, "Yandex"], VERSION], [/(comodo_dragon)\/([\w\.]+)/i], [[NAME, /_/g, " "], VERSION], [/(chrome|omniweb|arora|[tizenoka]{5}\s?browser)\/v?([\w\.]+)/i, /(qqbrowser)[\/\s]?([\w\.]+)/i], [NAME, VERSION], [/(uc\s?browser)[\/\s]?([\w\.]+)/i, /ucweb.+(ucbrowser)[\/\s]?([\w\.]+)/i, /JUC.+(ucweb)[\/\s]?([\w\.]+)/i], [[NAME, "UCBrowser"], VERSION], [/(dolfin)\/([\w\.]+)/i], [[NAME, "Dolphin"], VERSION], [/((?:android.+)crmo|crios)\/([\w\.]+)/i], [[NAME, "Chrome"], VERSION], [/XiaoMi\/MiuiBrowser\/([\w\.]+)/i], [VERSION, [NAME, "MIUI Browser"]], [/android.+version\/([\w\.]+)\s+(?:mobile\s?safari|safari)/i], [VERSION, [NAME, "Android Browser"]], [/FBAV\/([\w\.]+);/i], [VERSION, [NAME, "Facebook"]], [/fxios\/([\w\.-]+)/i], [VERSION, [NAME, "Firefox"]], [/version\/([\w\.]+).+?mobile\/\w+\s(safari)/i], [VERSION, [NAME, "Mobile Safari"]], [/version\/([\w\.]+).+?(mobile\s?safari|safari)/i], [VERSION, NAME], [/webkit.+?(mobile\s?safari|safari)(\/[\w\.]+)/i], [NAME, [VERSION, mapper.str, maps.browser.oldsafari.version]], [/(konqueror)\/([\w\.]+)/i, /(webkit|khtml)\/([\w\.]+)/i], [NAME, VERSION], [/(navigator|netscape)\/([\w\.-]+)/i], [[NAME, "Netscape"], VERSION], [/(swiftfox)/i, /(icedragon|iceweasel|camino|chimera|fennec|maemo\sbrowser|minimo|conkeror)[\/\s]?([\w\.\+]+)/i, /(firefox|seamonkey|k-meleon|icecat|iceape|firebird|phoenix)\/([\w\.-]+)/i, /(mozilla)\/([\w\.]+).+rv\:.+gecko\/\d+/i, /(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir)[\/\s]?([\w\.]+)/i, /(links)\s\(([\w\.]+)/i, /(gobrowser)\/?([\w\.]+)*/i, /(ice\s?browser)\/v?([\w\._]+)/i, /(mosaic)[\/\s]([\w\.]+)/i], [NAME, VERSION]],
        cpu: [[/(?:(amd|x(?:(?:86|64)[_-])?|wow|win)64)[;\)]/i], [[ARCHITECTURE, "amd64"]], [/(ia32(?=;))/i], [[ARCHITECTURE, util.lowerize]], [/((?:i[346]|x)86)[;\)]/i], [[ARCHITECTURE, "ia32"]], [/windows\s(ce|mobile);\sppc;/i], [[ARCHITECTURE, "arm"]], [/((?:ppc|powerpc)(?:64)?)(?:\smac|;|\))/i], [[ARCHITECTURE, /ower/, "", util.lowerize]], [/(sun4\w)[;\)]/i], [[ARCHITECTURE, "sparc"]], [/((?:avr32|ia64(?=;))|68k(?=\))|arm(?:64|(?=v\d+;))|(?=atmel\s)avr|(?:irix|mips|sparc)(?:64)?(?=;)|pa-risc)/i], [[ARCHITECTURE, util.lowerize]]],
        device: [[/\((ipad|playbook);[\w\s\);-]+(rim|apple)/i], [MODEL, VENDOR, [TYPE, TABLET]], [/applecoremedia\/[\w\.]+ \((ipad)/], [MODEL, [VENDOR, "Apple"], [TYPE, TABLET]], [/(apple\s{0,1}tv)/i], [[MODEL, "Apple TV"], [VENDOR, "Apple"]], [/(archos)\s(gamepad2?)/i, /(hp).+(touchpad)/i, /(kindle)\/([\w\.]+)/i, /\s(nook)[\w\s]+build\/(\w+)/i, /(dell)\s(strea[kpr\s\d]*[\dko])/i], [VENDOR, MODEL, [TYPE, TABLET]], [/(kf[A-z]+)\sbuild\/[\w\.]+.*silk\//i], [MODEL, [VENDOR, "Amazon"], [TYPE, TABLET]], [/(sd|kf)[0349hijorstuw]+\sbuild\/[\w\.]+.*silk\//i], [[MODEL, mapper.str, maps.device.amazon.model], [VENDOR, "Amazon"], [TYPE, MOBILE]], [/\((ip[honed|\s\w*]+);.+(apple)/i], [MODEL, VENDOR, [TYPE, MOBILE]], [/\((ip[honed|\s\w*]+);/i], [MODEL, [VENDOR, "Apple"], [TYPE, MOBILE]], [/(blackberry)[\s-]?(\w+)/i, /(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|huawei|meizu|motorola|polytron)[\s_-]?([\w-]+)*/i, /(hp)\s([\w\s]+\w)/i, /(asus)-?(\w+)/i], [VENDOR, MODEL, [TYPE, MOBILE]], [/\(bb10;\s(\w+)/i], [MODEL, [VENDOR, "BlackBerry"], [TYPE, MOBILE]], [/android.+(transfo[prime\s]{4,10}\s\w+|eeepc|slider\s\w+|nexus 7)/i], [MODEL, [VENDOR, "Asus"], [TYPE, TABLET]], [/(sony)\s(tablet\s[ps])\sbuild\//i, /(sony)?(?:sgp.+)\sbuild\//i], [[VENDOR, "Sony"], [MODEL, "Xperia Tablet"], [TYPE, TABLET]], [/(?:sony)?(?:(?:(?:c|d)\d{4})|(?:so[-l].+))\sbuild\//i], [[VENDOR, "Sony"], [MODEL, "Xperia Phone"], [TYPE, MOBILE]], [/\s(ouya)\s/i, /(nintendo)\s([wids3u]+)/i], [VENDOR, MODEL, [TYPE, CONSOLE]], [/android.+;\s(shield)\sbuild/i], [MODEL, [VENDOR, "Nvidia"], [TYPE, CONSOLE]], [/(playstation\s[34portablevi]+)/i], [MODEL, [VENDOR, "Sony"], [TYPE, CONSOLE]], [/(sprint\s(\w+))/i], [[VENDOR, mapper.str, maps.device.sprint.vendor], [MODEL, mapper.str, maps.device.sprint.model], [TYPE, MOBILE]], [/(lenovo)\s?(S(?:5000|6000)+(?:[-][\w+]))/i], [VENDOR, MODEL, [TYPE, TABLET]], [/(htc)[;_\s-]+([\w\s]+(?=\))|\w+)*/i, /(zte)-(\w+)*/i, /(alcatel|geeksphone|huawei|lenovo|nexian|panasonic|(?=;\s)sony)[_\s-]?([\w-]+)*/i], [VENDOR, [MODEL, /_/g, " "], [TYPE, MOBILE]], [/(nexus\s9)/i], [MODEL, [VENDOR, "HTC"], [TYPE, TABLET]], [/[\s\(;](xbox(?:\sone)?)[\s\);]/i], [MODEL, [VENDOR, "Microsoft"], [TYPE, CONSOLE]], [/(kin\.[onetw]{3})/i], [[MODEL, /\./g, " "], [VENDOR, "Microsoft"], [TYPE, MOBILE]], [/\s(milestone|droid(?:[2-4x]|\s(?:bionic|x2|pro|razr))?(:?\s4g)?)[\w\s]+build\//i, /mot[\s-]?(\w+)*/i, /(XT\d{3,4}) build\//i, /(nexus\s[6])/i], [MODEL, [VENDOR, "Motorola"], [TYPE, MOBILE]], [/android.+\s(mz60\d|xoom[\s2]{0,2})\sbuild\//i], [MODEL, [VENDOR, "Motorola"], [TYPE, TABLET]], [/android.+((sch-i[89]0\d|shw-m380s|gt-p\d{4}|gt-n8000|sgh-t8[56]9|nexus 10))/i, /((SM-T\w+))/i], [[VENDOR, "Samsung"], MODEL, [TYPE, TABLET]], [/((s[cgp]h-\w+|gt-\w+|galaxy\snexus|sm-n900))/i, /(sam[sung]*)[\s-]*(\w+-?[\w-]*)*/i, /sec-((sgh\w+))/i], [[VENDOR, "Samsung"], MODEL, [TYPE, MOBILE]], [/(samsung);smarttv/i], [VENDOR, MODEL, [TYPE, SMARTTV]], [/\(dtv[\);].+(aquos)/i], [MODEL, [VENDOR, "Sharp"], [TYPE, SMARTTV]], [/sie-(\w+)*/i], [MODEL, [VENDOR, "Siemens"], [TYPE, MOBILE]], [/(maemo|nokia).*(n900|lumia\s\d+)/i, /(nokia)[\s_-]?([\w-]+)*/i], [[VENDOR, "Nokia"], MODEL, [TYPE, MOBILE]], [/android\s3\.[\s\w;-]{10}(a\d{3})/i], [MODEL, [VENDOR, "Acer"], [TYPE, TABLET]], [/android\s3\.[\s\w;-]{10}(lg?)-([06cv9]{3,4})/i], [[VENDOR, "LG"], MODEL, [TYPE, TABLET]], [/(lg) netcast\.tv/i], [VENDOR, MODEL, [TYPE, SMARTTV]], [/(nexus\s[45])/i, /lg[e;\s\/-]+(\w+)*/i], [MODEL, [VENDOR, "LG"], [TYPE, MOBILE]], [/android.+(ideatab[a-z0-9\-\s]+)/i], [MODEL, [VENDOR, "Lenovo"], [TYPE, TABLET]], [/linux;.+((jolla));/i], [VENDOR, MODEL, [TYPE, MOBILE]], [/((pebble))app\/[\d\.]+\s/i], [VENDOR, MODEL, [TYPE, WEARABLE]], [/android.+;\s(glass)\s\d/i], [MODEL, [VENDOR, "Google"], [TYPE, WEARABLE]], [/android.+(\w+)\s+build\/hm\1/i, /android.+(hm[\s\-_]*note?[\s_]*(?:\d\w)?)\s+build/i, /android.+(mi[\s\-_]*(?:one|one[\s_]plus)?[\s_]*(?:\d\w)?)\s+build/i], [[MODEL, /_/g, " "], [VENDOR, "Xiaomi"], [TYPE, MOBILE]], [/\s(tablet)[;\/\s]/i, /\s(mobile)[;\/\s]/i], [[TYPE, util.lowerize], VENDOR, MODEL]],
        engine: [[/windows.+\sedge\/([\w\.]+)/i], [VERSION, [NAME, "EdgeHTML"]], [/(presto)\/([\w\.]+)/i, /(webkit|trident|netfront|netsurf|amaya|lynx|w3m)\/([\w\.]+)/i, /(khtml|tasman|links)[\/\s]\(?([\w\.]+)/i, /(icab)[\/\s]([23]\.[\d\.]+)/i], [NAME, VERSION], [/rv\:([\w\.]+).*(gecko)/i], [VERSION, NAME]],
        os: [[/microsoft\s(windows)\s(vista|xp)/i], [NAME, VERSION], [/(windows)\snt\s6\.2;\s(arm)/i, /(windows\sphone(?:\sos)*|windows\smobile|windows)[\s\/]?([ntce\d\.\s]+\w)/i], [NAME, [VERSION, mapper.str, maps.os.windows.version]], [/(win(?=3|9|n)|win\s9x\s)([nt\d\.]+)/i], [[NAME, "Windows"], [VERSION, mapper.str, maps.os.windows.version]], [/\((bb)(10);/i], [[NAME, "BlackBerry"], VERSION], [/(blackberry)\w*\/?([\w\.]+)*/i, /(tizen)[\/\s]([\w\.]+)/i, /(android|webos|palm\sos|qnx|bada|rim\stablet\sos|meego|contiki)[\/\s-]?([\w\.]+)*/i, /linux;.+(sailfish);/i], [NAME, VERSION], [/(symbian\s?os|symbos|s60(?=;))[\/\s-]?([\w\.]+)*/i], [[NAME, "Symbian"], VERSION], [/\((series40);/i], [NAME], [/mozilla.+\(mobile;.+gecko.+firefox/i], [[NAME, "Firefox OS"], VERSION], [/(nintendo|playstation)\s([wids34portablevu]+)/i, /(mint)[\/\s\(]?(\w+)*/i, /(mageia|vectorlinux)[;\s]/i, /(joli|[kxln]?ubuntu|debian|[open]*suse|gentoo|(?=\s)arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk|linpus)[\/\s-]?([\w\.-]+)*/i, /(hurd|linux)\s?([\w\.]+)*/i, /(gnu)\s?([\w\.]+)*/i], [NAME, VERSION], [/(cros)\s[\w]+\s([\w\.]+\w)/i], [[NAME, "Chromium OS"], VERSION], [/(sunos)\s?([\w\.]+\d)*/i], [[NAME, "Solaris"], VERSION], [/\s([frentopc-]{0,4}bsd|dragonfly)\s?([\w\.]+)*/i], [NAME, VERSION], [/(ip[honead]+)(?:.*os\s([\w]+)*\slike\smac|;\sopera)/i], [[NAME, "iOS"], [VERSION, /_/g, "."]], [/(mac\sos\sx)\s?([\w\s\.]+\w)*/i, /(macintosh|mac(?=_powerpc)\s)/i], [[NAME, "Mac OS"], [VERSION, /_/g, "."]], [/((?:open)?solaris)[\/\s-]?([\w\.]+)*/i, /(haiku)\s(\w+)/i, /(aix)\s((\d)(?=\.|\)|\s)[\w\.]*)*/i, /(plan\s9|minix|beos|os\/2|amigaos|morphos|risc\sos|openvms)/i, /(unix)\s?([\w\.]+)*/i], [NAME, VERSION]]
    };
    var UAParser = function(uastring, extensions) {
        if (!(this instanceof UAParser)) {
            return new UAParser(uastring,extensions).getResult()
        }
        var ua = uastring || (window && window.navigator && window.navigator.userAgent ? window.navigator.userAgent : EMPTY);
        var rgxmap = extensions ? util.extend(regexes, extensions) : regexes;
        this.getBrowser = function() {
            var browser = mapper.rgx.apply(this, rgxmap.browser);
            browser.major = util.major(browser.version);
            return browser
        }
        ;
        this.getCPU = function() {
            return mapper.rgx.apply(this, rgxmap.cpu)
        }
        ;
        this.getDevice = function() {
            return mapper.rgx.apply(this, rgxmap.device)
        }
        ;
        this.getEngine = function() {
            return mapper.rgx.apply(this, rgxmap.engine)
        }
        ;
        this.getOS = function() {
            return mapper.rgx.apply(this, rgxmap.os)
        }
        ;
        this.getResult = function() {
            return {
                ua: this.getUA(),
                browser: this.getBrowser(),
                engine: this.getEngine(),
                os: this.getOS(),
                device: this.getDevice(),
                cpu: this.getCPU()
            }
        }
        ;
        this.getUA = function() {
            return ua
        }
        ;
        this.setUA = function(uastring) {
            ua = uastring;
            return this
        }
        ;
        return this
    };
    UAParser.VERSION = LIBVERSION;
    UAParser.BROWSER = {
        NAME: NAME,
        MAJOR: MAJOR,
        VERSION: VERSION
    };
    UAParser.CPU = {
        ARCHITECTURE: ARCHITECTURE
    };
    UAParser.DEVICE = {
        MODEL: MODEL,
        VENDOR: VENDOR,
        TYPE: TYPE,
        CONSOLE: CONSOLE,
        MOBILE: MOBILE,
        SMARTTV: SMARTTV,
        TABLET: TABLET,
        WEARABLE: WEARABLE,
        EMBEDDED: EMBEDDED
    };
    UAParser.ENGINE = {
        NAME: NAME,
        VERSION: VERSION
    };
    UAParser.OS = {
        NAME: NAME,
        VERSION: VERSION
    };
    if (typeof exports !== UNDEF_TYPE) {
        if (typeof module !== UNDEF_TYPE && module.exports) {
            exports = module.exports = UAParser
        }
        exports.UAParser = UAParser
    } else {
        if (typeof define === FUNC_TYPE && define.amd) {
            define("ua-parser-js", [], function() {
                return UAParser
            })
        } else {
            window.UAParser = UAParser
        }
    }
    var $ = window.jQuery || window.Zepto;
    if (typeof $ !== UNDEF_TYPE) {
        var parser = new UAParser;
        $.ua = parser.getResult();
        $.ua.get = function() {
            return parser.getUA()
        }
        ;
        $.ua.set = function(uastring) {
            parser.setUA(uastring);
            var result = parser.getResult();
            for (var prop in result) {
                $.ua[prop] = result[prop]
            }
        }
    }
}
)(typeof window === "object" ? window : this);

/* file: script/lib/top.js */

/* Array from polyfill */

if (!Array.from) {
    Array.from = function(object) {
        'use strict';
        return [].slice.call(object);
    }
    ;
}

/* Promise polyfill */

(function(root) {

    // Store setTimeout reference so promise-polyfill will be unaffected by
    // other code modifying setTimeout (like sinon.useFakeTimers())
    var setTimeoutFunc = setTimeout;

    function noop() {}

    // Use polyfill for setImmediate for performance gains
    var asap = (typeof setImmediate === 'function' && setImmediate) || function(fn) {
        setTimeoutFunc(fn, 1);
    }
    ;

    var onUnhandledRejection = function onUnhandledRejection(err) {
        console.warn('Possible Unhandled Promise Rejection:', err);
        // eslint-disable-line no-console
    };

    // Polyfill for Function.prototype.bind
    function bind(fn, thisArg) {
        return function() {
            fn.apply(thisArg, arguments);
        }
        ;
    }

    var isArray = Array.isArray || function(value) {
        return Object.prototype.toString.call(value) === '[object Array]';
    }
    ;

    function Promise(fn) {
        if (typeof this !== 'object')
            throw new TypeError('Promises must be constructed via new');
        if (typeof fn !== 'function')
            throw new TypeError('not a function');
        this._state = 0;
        this._handled = false;
        this._value = undefined;
        this._deferreds = [];

        doResolve(fn, this);
    }

    function handle(self, deferred) {
        while (self._state === 3) {
            self = self._value;
        }
        if (self._state === 0) {
            self._deferreds.push(deferred);
            return;
        }
        self._handled = true;
        asap(function() {
            var cb = self._state === 1 ? deferred.onFulfilled : deferred.onRejected;
            if (cb === null) {
                (self._state === 1 ? resolve : reject)(deferred.promise, self._value);
                return;
            }
            var ret;
            try {
                ret = cb(self._value);
            } catch (e) {
                reject(deferred.promise, e);
                return;
            }
            resolve(deferred.promise, ret);
        });
    }

    function resolve(self, newValue) {
        try {
            // Promise Resolution Procedure: https://github.com/promises-aplus/promises-spec#the-promise-resolution-procedure
            if (newValue === self)
                throw new TypeError('A promise cannot be resolved with itself.');
            if (newValue && (typeof newValue === 'object' || typeof newValue === 'function')) {
                var then = newValue.then;
                if (newValue instanceof Promise) {
                    self._state = 3;
                    self._value = newValue;
                    finale(self);
                    return;
                } else if (typeof then === 'function') {
                    doResolve(bind(then, newValue), self);
                    return;
                }
            }
            self._state = 1;
            self._value = newValue;
            finale(self);
        } catch (e) {
            reject(self, e);
        }
    }

    function reject(self, newValue) {
        self._state = 2;
        self._value = newValue;
        finale(self);
    }

    function finale(self) {
        if (self._state === 2 && self._deferreds.length === 0) {
            setTimeout(function() {
                if (!self._handled) {
                    onUnhandledRejection(self._value);
                }
            }, 1);
        }

        for (var i = 0, len = self._deferreds.length; i < len; i++) {
            handle(self, self._deferreds[i]);
        }
        self._deferreds = null;
    }

    function Handler(onFulfilled, onRejected, promise) {
        this.onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : null;
        this.onRejected = typeof onRejected === 'function' ? onRejected : null;
        this.promise = promise;
    }

    /**
   * Take a potentially misbehaving resolver function and make sure
   * onFulfilled and onRejected are only called once.
   *
   * Makes no guarantees about asynchrony.
   */
    function doResolve(fn, self) {
        var done = false;
        try {
            fn(function(value) {
                if (done)
                    return;
                done = true;
                resolve(self, value);
            }, function(reason) {
                if (done)
                    return;
                done = true;
                reject(self, reason);
            });
        } catch (ex) {
            if (done)
                return;
            done = true;
            reject(self, ex);
        }
    }

    Promise.prototype['catch'] = function(onRejected) {
        return this.then(null, onRejected);
    }
    ;

    Promise.prototype.then = function(onFulfilled, onRejected) {
        var prom = new Promise(noop);
        handle(this, new Handler(onFulfilled,onRejected,prom));
        return prom;
    }
    ;

    Promise.all = function() {
        var args = Array.prototype.slice.call(arguments.length === 1 && isArray(arguments[0]) ? arguments[0] : arguments);

        return new Promise(function(resolve, reject) {
            if (args.length === 0)
                return resolve([]);
            var remaining = args.length;

            function res(i, val) {
                try {
                    if (val && (typeof val === 'object' || typeof val === 'function')) {
                        var then = val.then;
                        if (typeof then === 'function') {
                            then.call(val, function(val) {
                                res(i, val);
                            }, reject);
                            return;
                        }
                    }
                    args[i] = val;
                    if (--remaining === 0) {
                        resolve(args);
                    }
                } catch (ex) {
                    reject(ex);
                }
            }

            for (var i = 0; i < args.length; i++) {
                res(i, args[i]);
            }
        }
        );
    }
    ;

    Promise.resolve = function(value) {
        if (value && typeof value === 'object' && value.constructor === Promise) {
            return value;
        }

        return new Promise(function(resolve) {
            resolve(value);
        }
        );
    }
    ;

    Promise.reject = function(value) {
        return new Promise(function(resolve, reject) {
            reject(value);
        }
        );
    }
    ;

    Promise.race = function(values) {
        return new Promise(function(resolve, reject) {
            for (var i = 0, len = values.length; i < len; i++) {
                values[i].then(resolve, reject);
            }
        }
        );
    }
    ;

    /**
   * Set the immediate function to execute callbacks
   * @param fn {function} Function to execute
   * @private
   */
    Promise._setImmediateFn = function _setImmediateFn(fn) {
        asap = fn;
    }
    ;

    Promise._setUnhandledRejectionFn = function _setUnhandledRejectionFn(fn) {
        onUnhandledRejection = fn;
    }
    ;

    if (typeof module !== 'undefined' && module.exports) {
        module.exports = Promise;
    } else if (!root.Promise) {
        root.Promise = Promise;
    }

}
)(this);

/* file: ../../canvasquery/github/canvasquery.js */

/*     

  Canvas Query r11
  
  http://canvasquery.com
  
  (c) 2012-2019 http://rezoner.net
  
  Canvas Query may be freely distributed under the MIT license.

  r11

  - removed webkit hacks for fillText
  - removed support for now dead CocoonJS

  r10

  + frameRect

  r9

  + even more precise fontHeight and fontTop
  + textBoundaries and wrappedText use same alg for maxWidth when newline is detected

  r8

  + improved matchPalette performance
  + defaultFont

  r7

  + more accurate fontHeight()
  + fillText respects no antialiasing when using pixel font
  + textBaseline("top") consistent among browsers
  + align state is added to the stack
  + new canvases are pulled from the pool  
  + filter (experimetnal)

  r6

  + ImageBitmap support
  + drawImageCentered
  + drawRegionCentered
  + default textBaseline
  + resizeBounds

  r5

  ! fixed: leaking arguments in fastApply bailing out optimization
  + cacheText
  + compare
  + checkerboard

*/

(function() {

    var Canvas = window.HTMLCanvasElement;
    var orgImage = window.Image;
    var Image = window.HTMLImageElement;
    var ImageBitmap = window.ImageBitmap || window.HTMLImageElement;

    var cq = function(selector) {

        if (arguments.length === 0) {

            var canvas = cq.pool();

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

        } else if (typeof selector === "string") {

            var canvas = document.querySelector(selector);

        } else if (typeof selector === "number") {

            var canvas = cq.pool();

            canvas.width = arguments[0];
            canvas.height = arguments[1];

        } else if (selector instanceof Image) {

            var canvas = cq.pool();

            canvas.width = selector.width;
            canvas.height = selector.height;
            canvas.getContext("2d").drawImage(selector, 0, 0);

        } else if (selector instanceof ImageBitmap) {

            var canvas = cq.pool();

            canvas.width = selector.width;
            canvas.height = selector.height;
            canvas.getContext("2d").drawImage(selector, 0, 0);

        } else if (selector instanceof cq.Layer) {

            return selector;

        } else {

            var canvas = selector;

        }

        return new cq.Layer(canvas);

    };

    cq.lineSpacing = 1.0;
    cq.defaultFont = "";
    cq.textBaseline = "alphabetic";
    cq.matchPalettePrecision = 10;
    cq.strokeStyle = false;
    cq.fillStyle = false;

    cq.palettes = {

        db16: ["#140c1c", "#442434", "#30346d", "#4e4a4e", "#854c30", "#346524", "#d04648", "#757161", "#597dce", "#d27d2c", "#8595a1", "#6daa2c", "#d2aa99", "#6dc2ca", "#dad45e", "#deeed6"],
        db32: ["#000000", "#222034", "#45283c", "#663931", "#8f563b", "#df7126", "#d9a066", "#eec39a", "#fbf236", "#99e550", "#6abe30", "#37946e", "#4b692f", "#524b24", "#323c39", "#3f3f74", "#306082", "#5b6ee1", "#639bff", "#5fcde4", "#cbdbfc", "#ffffff", "#9badb7", "#847e87", "#696a6a", "#595652", "#76428a", "#ac3232", "#d95763", "#d77bba", "#8f974a", "#8a6f30"],
        c64: ["#000000", "#6a5400", "#68ae5c", "#8a8a8a", "#adadad", "#636363", "#c37b75", "#c9d684", "#ffffff", "#984b43", "#a3e599", "#79c1c8", "#9b6739", "#9b51a5", "#52429d", "#8a7bce"],
        gameboy: ["#0f380f", "#306230", "#8bac0f", "#9bbc0f"],
        sega: ["#000000", "#555500", "#005500", "#555555", "#55aa00", "#550000", "#aaffaa", "#aaaaaa", "#ff5555", "#005555", "#550055", "#aaaa55", "#ffffaa", "#aa5555", "#ffaa55", "#ffff55", "#ffffff", "#ffaaaa", "#000055", "#55aaaa", "#aa0000", "#ff5500", "#ffaa00", "#aa5500", "#ff0000", "#ffaaff", "#aa55aa", "#aaaa00", "#aaff00", "#aaaaff", "#5555aa", "#aaffff"],
        cga: ["#000000", "#ff5555", "#55ff55", "#ffff55"],
        nes: ["#7C7C7C", "#0000FC", "#0000BC", "#4428BC", "#940084", "#A80020", "#A81000", "#881400", "#503000", "#007800", "#006800", "#005800", "#004058", "#000000", "#000000", "#000000", "#BCBCBC", "#0078F8", "#0058F8", "#6844FC", "#D800CC", "#E40058", "#F83800", "#E45C10", "#AC7C00", "#00B800", "#00A800", "#00A844", "#008888", "#000000", "#000000", "#000000", "#F8F8F8", "#3CBCFC", "#6888FC", "#9878F8", "#F878F8", "#F85898", "#F87858", "#FCA044", "#F8B800", "#B8F818", "#58D854", "#58F898", "#00E8D8", "#787878", "#000000", "#000000", "#FCFCFC", "#A4E4FC", "#B8B8F8", "#D8B8F8", "#F8B8F8", "#F8A4C0", "#F0D0B0", "#FCE0A8", "#F8D878", "#D8F878", "#B8F8B8", "#B8F8D8", "#00FCFC", "#F8D8F8", "#000000"],

    };

    cq.extend = function() {
        for (var i = 1; i < arguments.length; i++) {
            for (var j in arguments[i]) {
                arguments[0][j] = arguments[i][j];
            }
        }

        return arguments[0];
    }
    ;

    cq.augment = function() {
        for (var i = 1; i < arguments.length; i++) {
            _.extend(arguments[0], arguments[i]);
            arguments[i](arguments[0]);
        }
    }
    ;

    cq.distance = function(x1, y1, x2, y2) {
        if (arguments.length > 2) {
            var dx = x1 - x2;
            var dy = y1 - y2;

            return Math.sqrt(dx * dx + dy * dy);
        } else {
            return Math.abs(x1 - y1);
        }
    }
    ;

    /* fast.js */

    cq.fastApply = function(subject, thisContext, args) {

        switch (args.length) {
        case 0:
            return subject.call(thisContext);
        case 1:
            return subject.call(thisContext, args[0]);
        case 2:
            return subject.call(thisContext, args[0], args[1]);
        case 3:
            return subject.call(thisContext, args[0], args[1], args[2]);
        case 4:
            return subject.call(thisContext, args[0], args[1], args[2], args[3]);
        case 5:
            return subject.call(thisContext, args[0], args[1], args[2], args[3], args[4]);
        case 6:
            return subject.call(thisContext, args[0], args[1], args[2], args[3], args[4], args[5]);
        case 7:
            return subject.call(thisContext, args[0], args[1], args[2], args[3], args[4], args[5], args[6]);
        case 8:
            return subject.call(thisContext, args[0], args[1], args[2], args[3], args[4], args[5], args[6], args[7]);
        case 9:
            return subject.call(thisContext, args[0], args[1], args[2], args[3], args[4], args[5], args[6], args[7], args[8]);
        default:
            return subject.apply(thisContext, args);
        }

    }
    ;

    cq.extend(cq, {

        smoothing: true,

        blend: function(below, above, mode, mix) {

            if (typeof mix === "undefined")
                mix = 1;

            var below = cq(below);
            var mask = below.clone();
            var above = cq(above);

            below.save();
            below.globalAlpha(mix);
            below.globalCompositeOperation(mode);
            below.drawImage(above.canvas, 0, 0);
            below.restore();

            mask.save();
            mask.globalCompositeOperation("source-in");
            mask.drawImage(below.canvas, 0, 0);
            mask.restore();

            return mask;
        },

        matchColor: function(color, palette) {
            var rgbPalette = [];

            for (var i = 0; i < palette.length; i++) {
                rgbPalette.push(cq.color(palette[i]));
            }

            var imgData = cq.color(color);

            var difList = [];
            for (var j = 0; j < rgbPalette.length; j++) {
                var rgbVal = rgbPalette[j];
                var rDif = Math.abs(imgData[0] - rgbVal[0])
                  , gDif = Math.abs(imgData[1] - rgbVal[1])
                  , bDif = Math.abs(imgData[2] - rgbVal[2]);
                difList.push(rDif + gDif + bDif);
            }

            var closestMatch = 0;
            for (var j = 0; j < palette.length; j++) {
                if (difList[j] < difList[closestMatch]) {
                    closestMatch = j;
                }
            }

            return palette[closestMatch];
        },

        temp: function(width, height) {

            if (!this.tempLayer) {

                this.tempLayer = cq(1, 1);

            }

            if (width instanceof Image || width instanceof ImageBitmap) {
                this.tempLayer.width = width.width;
                this.tempLayer.height = width.height;
                this.tempLayer.context.drawImage(width, 0, 0);
            } else if (width instanceof Canvas) {
                this.tempLayer.width = width.width;
                this.tempLayer.height = width.height;
                this.tempLayer.context.drawImage(width, 0, 0);
            } else if (width instanceof CanvasQuery.Layer) {
                this.tempLayer.width = width.width;
                this.tempLayer.height = width.height;
                this.tempLayer.context.drawImage(width.canvas, 0, 0);
            } else {
                this.tempLayer.width = width;
                this.tempLayer.height = height;
            }

            return this.tempLayer;
        },

        wrapValue: function(value, min, max) {
            if (value < min)
                return max + (value % max);
            if (value >= max)
                return value % max;
            return value;
        },

        limitValue: function(value, min, max) {
            return value < min ? min : value > max ? max : value;
        },

        mix: function(a, b, amount) {
            return a + (b - a) * amount;
        },

        hexToRgb: function(hex) {
            if (hex.length === 7)
                return ['0x' + hex[1] + hex[2] | 0, '0x' + hex[3] + hex[4] | 0, '0x' + hex[5] + hex[6] | 0];
            else
                return ['0x' + hex[1] + hex[1] | 0, '0x' + hex[2] + hex[2] | 0, '0x' + hex[3] + hex[3] | 0];
        },

        rgbToHex: function(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1, 7);
        },

        extractCanvas: function(o) {

            if (o.canvas)
                return o.canvas;
            else
                return o;

        },

        compare: function(a, b) {

            a = this.extractCanvas(a);
            b = this.extractCanvas(b);

            a = a.getContext("2d").getImageData(0, 0, a.width, a.height).data;
            b = b.getContext("2d").getImageData(0, 0, b.width, b.height).data;

            if (a.length !== b.length)
                return false;

            for (var i = 0; i < a.length; i++) {

                if (a[i] !== b[i])
                    return false;

            }

            return true;

        },

        /* author: http://mjijackson.com/ */

        rgbToHsl: function(r, g, b) {

            if (r instanceof Array) {
                b = r[2];
                g = r[1];
                r = r[0];
            }

            r /= 255,
            g /= 255,
            b /= 255;
            var max = Math.max(r, g, b)
              , min = Math.min(r, g, b);
            var h, s, l = (max + min) / 2;

            if (max == min) {
                h = s = 0;
                // achromatic
            } else {
                var d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                case r:
                    h = (g - b) / d + (g < b ? 6 : 0);
                    break;
                case g:
                    h = (b - r) / d + 2;
                    break;
                case b:
                    h = (r - g) / d + 4;
                    break;
                }
                h /= 6;
            }

            return [h, s, l];
        },

        /* author: http://mjijackson.com/ */

        hue2rgb: function(p, q, t) {
            if (t < 0)
                t += 1;
            if (t > 1)
                t -= 1;
            if (t < 1 / 6)
                return p + (q - p) * 6 * t;
            if (t < 1 / 2)
                return q;
            if (t < 2 / 3)
                return p + (q - p) * (2 / 3 - t) * 6;
            return p;
        },

        hslToRgb: function(h, s, l) {
            var r, g, b;

            if (s == 0) {
                r = g = b = l;
                // achromatic
            } else {

                var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                var p = 2 * l - q;
                r = this.hue2rgb(p, q, h + 1 / 3);
                g = this.hue2rgb(p, q, h);
                b = this.hue2rgb(p, q, h - 1 / 3);
            }

            return [r * 255 | 0, g * 255 | 0, b * 255 | 0];
        },

        rgbToHsv: function(r, g, b) {
            if (r instanceof Array) {
                b = r[2];
                g = r[1];
                r = r[0];
            }

            r = r / 255,
            g = g / 255,
            b = b / 255;
            var max = Math.max(r, g, b)
              , min = Math.min(r, g, b);
            var h, s, v = max;

            var d = max - min;
            s = max == 0 ? 0 : d / max;

            if (max == min) {
                h = 0;
                // achromatic
            } else {
                switch (max) {
                case r:
                    h = (g - b) / d + (g < b ? 6 : 0);
                    break;
                case g:
                    h = (b - r) / d + 2;
                    break;
                case b:
                    h = (r - g) / d + 4;
                    break;
                }
                h /= 6;
            }

            return [h, s, v];
        },

        hsvToRgb: function(h, s, v) {
            var r, g, b;

            var i = Math.floor(h * 6);
            var f = h * 6 - i;
            var p = v * (1 - s);
            var q = v * (1 - f * s);
            var t = v * (1 - (1 - f) * s);

            switch (i % 6) {
            case 0:
                r = v,
                g = t,
                b = p;
                break;
            case 1:
                r = q,
                g = v,
                b = p;
                break;
            case 2:
                r = p,
                g = v,
                b = t;
                break;
            case 3:
                r = p,
                g = q,
                b = v;
                break;
            case 4:
                r = t,
                g = p,
                b = v;
                break;
            case 5:
                r = v,
                g = p,
                b = q;
                break;
            }

            return [r * 255, g * 255, b * 255];
        },

        color: function() {
            var result = new cq.Color();
            result.parse(arguments[0], arguments[1]);
            return result;
        },

        poolArray: [],

        pool: function() {

            if (!this.poolArray.length) {
                for (var i = 0; i < 100; i++) {
                    this.poolArray.push(this.createCanvas(1, 1));
                }
            }

            return this.poolArray.pop();

        },

        reuse: function(object) {

            return this.recycle(object);

        },

        recycle: function(object) {

            if (object instanceof CanvasQuery.Layer) {

                this.poolArray.push(object.canvas);

            } else {

                this.poolArray.push(object);

            }

        },

        setContextSmoothing: function(context, smoothing) {

            context.mozImageSmoothingEnabled = smoothing;
            context.msImageSmoothingEnabled = smoothing;
            context.webkitImageSmoothingEnabled = smoothing;
            context.imageSmoothingEnabled = smoothing;

        },

        createCanvas: function(width, height) {

            var result = document.createElement("canvas");

            if (arguments[0]instanceof Image || arguments[0]instanceof Canvas || arguments[0]instanceof ImageBitmap) {

                var image = arguments[0];

                result.width = image.width;
                result.height = image.height;

                result.getContext("2d").drawImage(image, 0, 0);

            } else {

                result.width = width;
                result.height = height;

            }

            return result;

        },

        createImageData: function(width, height) {

            return cq.createCanvas(width, height).getContext("2d").createImageData(width, height);

        }

    });

    cq.Layer = function(canvas) {

        this.useAlpha = true;
        this.canvas = canvas;
        this.prevAlignX = [];
        this.prevAlignY = [];
        this.alignX = 0;
        this.alignY = 0;
        this.aligned = false;
        this.update();

    }
    ;

    cq.Layer.prototype = {

        constructor: cq.Layer,

        update: function() {

            var smoothing = cq.smoothing;

            if (typeof this.smoothing !== "undefined")
                smoothing = this.smoothing;

            this.context = this.canvas.getContext("2d", {
                alpha: Boolean(this.useAlpha)
            });

            this.context.mozImageSmoothingEnabled = smoothing;
            this.context.msImageSmoothingEnabled = smoothing;
            this.context.webkitImageSmoothingEnabled = smoothing;
            this.context.imageSmoothingEnabled = smoothing;

            if (cq.defaultFont)
                this.context.font = cq.defaultFont;

            this.context.textBaseline = cq.textBaseline;

            if (cq.strokeStyle)
                this.context.strokeStyle = cq.strokeStyle;
            if (cq.fillStyle)
                this.context.fillStyle = cq.fillStyle;
        },

        appendTo: function(selector) {

            if (typeof selector === "object") {

                var element = selector;

            } else {

                var element = document.querySelector(selector);

            }

            /*
                  this.width = element.clientWidth;
                  this.height = element.clientHeight;
            */

            element.appendChild(this.canvas);

            return this;
        },

        a: function(a) {

            if (arguments.length) {

                this.previousAlpha = this.globalAlpha();

                return this.globalAlpha(a);

            } else {

                return this.globalAlpha();

            }

        },

        ra: function() {

            return this.a(this.previousAlpha);

        },
        /*
            drawImage: function() {

              if (!this.alignX && !this.alignY) {
                this.context.call
              }

                return this;


            },

            restore: function() {
              this.context.restore();
              this.alignX = 0;
              this.alignY = 0;
            },
            */

        realign: function() {

            this.alignX = this.prevAlignX[this.prevAlignX.length - 1];
            this.alignY = this.prevAlignY[this.prevAlignY.length - 1];

            return this;

        },

        align: function(x, y) {

            if (typeof y === "undefined")
                y = x;

            this.alignX = x;
            this.alignY = y;

            return this;
        },

        /* save translate align rotate scale */

        stars: function(x, y, alignX, alignY, rotation, scaleX, scaleY) {

            if (typeof alignX === "undefined")
                alignX = 0.5;
            if (typeof alignY === "undefined")
                alignY = 0.5;
            if (typeof rotation === "undefined")
                rotation = 0;
            if (typeof scaleX === "undefined")
                scaleX = 1.0;
            if (typeof scaleY === "undefined")
                scaleY = scaleX;

            this.save();
            this.translate(x, y);
            this.align(alignX, alignY);
            this.rotate(rotation);
            this.scale(scaleX, scaleY);

            return this;
        },

        tars: function(x, y, alignX, alignY, rotation, scaleX, scaleY) {

            if (typeof alignX === "undefined")
                alignX = 0.5;
            if (typeof alignY === "undefined")
                alignY = 0.5;
            if (typeof rotation === "undefined")
                rotation = 0;
            if (typeof scaleX === "undefined")
                scaleX = 1.0;
            if (typeof scaleY === "undefined")
                scaleY = scaleX;

            this.translate(x, y);
            this.align(alignX, alignY);
            this.rotate(rotation);
            this.scale(scaleX, scaleY);

            return this;

        },

        webkit: ('WebkitAppearance'in document.documentElement.style),

        fillText: function(text, x, y, gap) {

            text = String(text);

            if (!text.length)
                return;

            var webkitHack = !cq.smoothing && (this.fontHeight() <= 64) && ('WebkitAppearance'in document.documentElement.style);

            if (false && webkitHack) {

                var scale = this.webkit ? 4 : 5;

                var canvas = cq.pool();
                var context = canvas.getContext("2d");

                context.font = this.context.font;

                var realWidth = context.measureText(text).width;
                var width = Math.ceil(realWidth);
                var gap = gap || (width - realWidth);

                var height = this.fontHeight();

                canvas.width = width * scale;
                canvas.height = height * scale;

                cq.setContextSmoothing(context, false);

                // context.fillStyle = "#fff"; 
                // context.fillRect(0,0,canvas.width, canvas.height);

                context.font = this.context.font;
                context.fillStyle = this.context.fillStyle;
                context.textBaseline = "top";

                context.scale(scale, scale);
                context.fillText(text, gap, -this.fontTop());

                if (this.context.textAlign === "center")
                    x -= width * 0.5;
                else if (this.context.textAlign === "right")
                    x -= width;

                this.drawImage(canvas, 0, 0, canvas.width, canvas.height, x, y, canvas.width / scale, canvas.height / scale);

            } else {

                this.context.fillText(text, x, y - this.fontTop());

            }

            return this;

        },

        frameRect(x, y, width, height, frameWidth) {

            this.context.fillRect(x, y, width, frameWidth);
            this.context.fillRect(x, y + height - frameWidth, width, frameWidth);
            this.context.fillRect(x, y, frameWidth, height);
            this.context.fillRect(x + width - frameWidth, y, frameWidth, height);

            return this;

        },

        fillRect: function() {

            if (this.alignX || this.alignY) {

                this.context.fillRect(arguments[0] - arguments[2] * this.alignX | 0, arguments[1] - arguments[3] * this.alignY | 0, arguments[2], arguments[3]);

            } else {

                this.context.fillRect(arguments[0], arguments[1], arguments[2], arguments[3]);

            }

            return this;

        },

        strokeRect: function() {

            if (this.alignX || this.alignY) {

                this.context.strokeRect(arguments[0] - arguments[2] * this.alignX | 0, arguments[1] - arguments[3] * this.alignY | 0, arguments[2], arguments[3]);

            } else {

                this.context.strokeRect(arguments[0], arguments[1], arguments[2], arguments[3]);

            }

            return this;

        },

        drawImage: function(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight) {

            if (this.alignX || this.alignY) {

                if (typeof sWidth === "undefined") {
                    sx -= image.width * this.alignX | 0;
                    sy -= image.height * this.alignY | 0;
                } else {
                    dx -= dWidth * this.alignX | 0;
                    dy -= dHeight * this.alignY | 0;
                }

            }

            if (typeof sWidth === "undefined") {

                this.context.drawImage(image, sx, sy);

            } else if (typeof dx === "undefined") {

                this.context.drawImage(image, sx, sy, sWidth, sHeight);

            } else {

                this.context.drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);

            }

            return this;

        },

        drawImageCentered: function(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight) {

            if (sWidth == null) {
                sx -= image.width * 0.5 | 0;
                sy -= image.height * 0.5 | 0;
            } else {
                dx -= dWidth * 0.5 | 0;
                dy -= dHeight * 0.5 | 0;
            }

            if (sWidth == null) {

                this.context.drawImage(image, sx, sy);

            } else if (dx == null) {

                this.context.drawImage(image, sx, sy, sWidth, sHeight);

            } else {

                this.context.drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);

            }

            return this;

        },

        save: function() {

            this.prevAlignX.push(this.alignX);
            this.prevAlignY.push(this.alignY);

            this.context.save();

            return this;

        },

        restore: function() {

            this.realign();
            this.alignX = this.prevAlignX.pop();
            this.alignY = this.prevAlignY.pop();
            this.context.restore();

            return this;

        },

        drawTile: function(image, x, y, frameX, frameY, frameWidth, frameHeight, frames, frame) {
        },

        checkerboard: function(x, y, w, h, grid, colorA, colorB) {

            var tx = w / grid | 0;
            var ty = h / grid | 0;

            this.save();
            this.rect(x, y, w, h).clip();

            for (var i = 0; i <= tx; i++) {
                for (var j = 0; j <= ty; j++) {

                    if (j % 2)
                        var color = i % 2 ? colorA : colorB;
                    else
                        var color = i % 2 ? colorB : colorA;

                    this.fillStyle(color);
                    this.fillRect(x + i * grid, y + j * grid, grid, grid);

                }
            }

            this.restore();

        },

        drawAtlasFrame: function(atlas, frame, x, y) {

            var frame = atlas.frames[frame];

            this.drawRegion(atlas.image, frame.region, x - frame.width * this.alignX + frame.offset[0] + frame.region[2] * this.alignX, y - frame.height * this.alignY + frame.offset[1] + frame.region[3] * this.alignY);

            return this;

        },

        coverImage: function(image, width, height) {

            if (typeof width === "undefined")
                width = this.width;
            if (typeof height === "undefined")
                height = this.height;

            var scale = Math.max(width / image.width, height / image.height);

            this.save();
            this.scale(scale, scale);
            this.drawImage(image, 0, 0);
            this.restore();

        },

        fitImage: function(image, width, height) {

            if (typeof width === "undefined")
                width = this.width;
            if (typeof height === "undefined")
                height = this.height;

            var scale = Math.min(width / image.width, height / image.height);

            this.save();
            this.scale(scale, scale);
            this.drawImage(image, 0, 0);
            this.restore();

        },

        drawRegion: function(image, region, x, y, scale) {

            scale = scale || 1;

            return this.drawImage(image, region[0], region[1], region[2], region[3], x | 0, y | 0, region[2] * scale | 0, region[3] * scale | 0);

        },

        drawRegionCentered: function(image, region, x, y, scale) {

            scale = scale || 1;

            return this.drawImageCentered(image, region[0], region[1], region[2], region[3], x | 0, y | 0, region[2] * scale | 0, region[3] * scale | 0);

        },

        cache: function() {

            return this.clone().canvas;

        },

        popup: function() {

            window.open(this.canvas.toDataURL());

            return this;

        },

        blendOn: function(what, mode, mix) {
            cq.blend(what, this, mode, mix);

            return this;
        },

        posterize: function(pc, inc) {
            pc = pc || 32;
            inc = inc || 4;
            var imgdata = this.getImageData(0, 0, this.width, this.height);
            var data = imgdata.data;

            for (var i = 0; i < data.length; i += inc) {
                data[i] -= data[i] % pc;
                // set value to nearest of 8 possibilities
                data[i + 1] -= data[i + 1] % pc;
                // set value to nearest of 8 possibilities
                data[i + 2] -= data[i + 2] % pc;
                // set value to nearest of 8 possibilities
            }

            this.putImageData(imgdata, 0, 0);
            // put image data to canvas

            return this;
        },

        posterizeAlpha: function(pc, inc) {
            pc = pc || 32;
            inc = inc || 4;
            var imgdata = this.getImageData(0, 0, this.width, this.height);
            var data = imgdata.data;

            for (var i = 0; i < data.length; i += inc) {

                data[i + 3] -= data[i + 3] % pc;
                // set value to nearest of 8 possibilities

            }

            this.putImageData(imgdata, 0, 0);
            // put image data to canvas

            return this;
        },

        bw: function(pc) {
            pc = 128;
            var imgdata = this.getImageData(0, 0, this.width, this.height);
            var data = imgdata.data;
            // 8-bit: rrr ggg bb
            for (var i = 0; i < data.length; i += 4) {
                var v = ((data[i] + data[i + 1] + data[i + 2]) / 3);

                v = (v / 128 | 0) * 128;
                //data[i] = v; // set value to nearest of 8 possibilities
                //data[i + 1] = v; // set value to nearest of 8 possibilities
                data[i + 2] = (v / 255) * data[i];
                // set value to nearest of 8 possibilities

            }

            this.putImageData(imgdata, 0, 0);
            // put image data to canvas
        },

        blend: function(what, mode, mix) {
            if (typeof what === "string") {
                var color = what;
                what = cq(this.canvas.width, this.canvas.height);
                what.fillStyle(color).fillRect(0, 0, this.canvas.width, this.canvas.height);
            }

            var result = cq.blend(this, what, mode, mix);

            this.canvas = result.canvas;
            this.context = result.context;

            return this;
        },

        textWithBackground: function(text, x, y, background, padding) {
            var w = this.measureText(text).width;
            var h = this.fontHeight() * 0.8;
            var f = this.fillStyle();
            var padding = padding || 2;

            var a = this.context.textAlign;

            this.fillStyle(background).fillRect(x - padding * 2, y - padding, w + padding * 4, h + padding * 2)
            this.fillStyle(f).textAlign("left").textBaseline("top").fillText(text, x, y);

            return this;
        },

        fillCircle: function(x, y, r) {
            this.context.beginPath();
            this.context.arc(x, y, r, 0, Math.PI * 2);
            this.context.fill();
            return this;
        },

        strokeCircle: function(x, y, r) {
            this.context.beginPath();
            this.context.arc(x, y, r, 0, Math.PI * 2);
            this.context.stroke();
            return this;
        },

        circle: function(x, y, r) {
            this.context.arc(x, y, r, 0, Math.PI * 2);
            return this;
        },

        crop: function(x, y, w, h) {

            if (arguments.length === 1) {

                var y = arguments[0][1];
                var w = arguments[0][2];
                var h = arguments[0][3];
                var x = arguments[0][0];
            }

            var canvas = cq.createCanvas(w, h);
            var context = canvas.getContext("2d");

            context.drawImage(this.canvas, x, y, w, h, 0, 0, w, h);
            this.canvas.width = w;
            this.canvas.height = h;

            cq.setContextSmoothing(this.context, false);

            this.clear();
            this.context.drawImage(canvas, 0, 0);

            return this;
        },

        set: function(properties) {

            cq.extend(this.context, properties);

        },

        resize: function(width, height) {

            var w = width
              , h = height;

            if (arguments.length === 1) {

                w = arguments[0] * this.canvas.width | 0;
                h = arguments[0] * this.canvas.height | 0;

            } else {

                if (height === false) {

                    if (this.canvas.width > width) {

                        h = this.canvas.height * (width / this.canvas.width) | 0;
                        w = width;

                    } else {

                        w = this.canvas.width;
                        h = this.canvas.height;

                    }

                } else if (width === false) {

                    if (this.canvas.width > width) {

                        w = this.canvas.width * (height / this.canvas.height) | 0;
                        h = height;

                    } else {

                        w = this.canvas.width;
                        h = this.canvas.height;

                    }

                }

            }

            var cqresized = cq(w, h).drawImage(this.canvas, 0, 0, this.canvas.width, this.canvas.height, 0, 0, w, h);

            this.canvas = cqresized.canvas;
            this.context = cqresized.context;

            return this;

        },

        resizeBounds: function(width, height) {

            var temp = cq(width, height);

            temp.drawImage(this.canvas, 0, 0);

            this.canvas = temp.canvas;
            this.context = temp.context;

            return this;

        },

        imageLine: function(image, region, x, y, ex, ey, scale) {

            if (!region)
                region = [0, 0, image.width, image.height];

            var distance = cq.distance(x, y, ex, ey);
            var count = distance / region[3] + 0.5 | 0;
            var angle = Math.atan2(ey - y, ex - x) + Math.PI / 2;

            this.save();

            this.translate(x, y);
            this.rotate(angle);

            if (scale)
                this.scale(scale, 1.0);

            for (var i = 0; i <= count; i++) {
                this.drawRegion(image, region, -region[2] / 2 | 0, -region[3] * (i + 1));
            }

            this.restore();

            return this;

        },

        trim: function(color, changes) {

            var transparent;

            if (color) {
                color = cq.color(color).toArray();
                transparent = !color[3];
            } else
                transparent = true;

            var sourceData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            var sourcePixels = sourceData.data;

            let minX = this.canvas.width;
            let minY = this.canvas.height;
            let maxX = 0;
            let maxY = 0;

            var width = this.canvas.width;
            var height = this.canvas.height;

            for (var i = 0, len = sourcePixels.length; i < len; i += 4) {

                if (transparent) {

                    if (!sourcePixels[i + 3])
                        continue;

                } else if (sourcePixels[i + 0] === color[0] && sourcePixels[i + 1] === color[1] && sourcePixels[i + 2] === color[2])
                    continue;

                var x = (i / 4 | 0) % this.canvas.width | 0;
                var y = (i / 4 | 0) / this.canvas.width | 0;

                if (x < minX)
                    minX = x;
                if (x > maxX)
                    maxX = x;

                if (y < minY)
                    minY = y;
                if (y > maxY)
                    maxY = y;
            }

            if (maxX === 0 && maxY === 0) {

                if (changes)
                    changes.none = true;

            } else {

                if (changes) {

                    changes.left = minX;
                    changes.top = minY;

                    changes.right = maxX - width;
                    changes.bottom = maxY - height;

                    changes.width = maxX - minX + 1;
                    changes.height = maxY - minY + 1;

                }

                this.crop(minX, minY, maxX - minX + 1, maxY - minY + 1);
            }

            return this;

        },

        matchPalette: function(palette) {

            if (!palette.matches)
                palette.matches = new Map;

            if (!palette.colors) {

                palette.colors = [];

                for (var i = 0; i < palette.length; i++) {

                    palette.colors.push(cq.color(palette[i]));

                }
            }

            var imageData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            var pixels = imageData.data;

            for (var i = 0; i < pixels.length; i += 4) {

                var difList = [];

                if (!pixels[i + 3])
                    continue;

                var key = (pixels[i + 0] / cq.matchPalettePrecision | 0) * cq.matchPalettePrecision + (pixels[i + 1] / cq.matchPalettePrecision | 0) * cq.matchPalettePrecision * 1000 + (pixels[i + 2] / cq.matchPalettePrecision | 0) * cq.matchPalettePrecision * 1000000;

                if (!palette.matches.has(key)) {

                    for (var j = 0; j < palette.colors.length; j++) {

                        var rgb = palette.colors[j];
                        var rDif = Math.abs(pixels[i] - rgb[0]);
                        var gDif = Math.abs(pixels[i + 1] - rgb[1])
                        var bDif = Math.abs(pixels[i + 2] - rgb[2]);

                        difList.push(rDif + gDif + bDif);

                    }

                    var closestMatch = 0;

                    for (var j = 0; j < palette.length; j++) {

                        if (difList[j] < difList[closestMatch]) {

                            closestMatch = j;

                        }

                    }

                    palette.matches.set(key, palette.colors[closestMatch]);

                }

                var matchedColor = palette.matches.get(key);

                pixels[i] = matchedColor[0];
                pixels[i + 1] = matchedColor[1];
                pixels[i + 2] = matchedColor[2];

                /* dithering */

                //imageData.data[i + 3] = (255 * Math.random() < imageData.data[i + 3]) ? 255 : 0;

                //imageData.data[i + 3] = imageData.data[i + 3] > 128 ? 255 : 0;
                /*
                if (i % 3 === 0) {
                  imageData.data[i] -= cq.limitValue(imageData.data[i] - 50, 0, 255);
                  imageData.data[i + 1] -= cq.limitValue(imageData.data[i + 1] - 50, 0, 255);
                  imageData.data[i + 2] -= cq.limitValue(imageData.data[i + 2] - 50, 0, 255);
                }
                */

            }

            this.context.putImageData(imageData, 0, 0);

            return this;

        },

        swapColors: function(colors) {

            var colormap = {};

            for (var key in colors) {

                var color = cq.color(key);
                var index = color[0] + color[1] * 1000 + color[2] * 1000000;
                // var index = String(color[0]) + "," + String(color[1]) + "," + String(color[2]);

                colormap[index] = cq.color(colors[key]);

            }

            var imageData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            var pixels = imageData.data;

            for (var i = 0; i < pixels.length; i += 4) {

                if (!pixels[i + 3])
                    continue;

                var index = pixels[i] + pixels[i + 1] * 1000 + pixels[i + 2] * 1000000;
                // var index = String(pixels[i + 0]) + "," + String(pixels[i + 1]) + "," + String(pixels[i + 2]);

                if (colormap[index]) {

                    pixels[i] = colormap[index][0];
                    pixels[i + 1] = colormap[index][1];
                    pixels[i + 2] = colormap[index][2];

                }

            }

            this.context.putImageData(imageData, 0, 0);

            return this;

        },

        getPalette: function() {

            var palette = [];
            var sourceData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            var sourcePixels = sourceData.data;

            for (var i = 0, len = sourcePixels.length; i < len; i += 4) {
                if (sourcePixels[i + 3]) {
                    var hex = cq.rgbToHex(sourcePixels[i + 0], sourcePixels[i + 1], sourcePixels[i + 2]);
                    if (palette.indexOf(hex) === -1)
                        palette.push(hex);
                }
            }

            return palette;
        },

        mapPalette: function() {
        },

        lines: function() {

            for (var i = 0; i < arguments.length; i += 2) {

                this.lineTo(arguments[i], arguments[i + 1]);

            }

            return this;

        },

        polygon: function(array, x, y) {

            if (x === undefined) {
                x = 0;
            }
            if (y === undefined) {
                y = 0;
            }

            this.beginPath();

            this.moveTo(array[0][0] + x, array[0][1] + y);

            for (var i = 1; i < array.length; i++) {
                this.lineTo(array[i][0] + x, array[i][1] + y);
            }

            this.closePath();

            return this;

        },

        fillPolygon: function(polygon) {

            this.polygon(polygon);
            this.fill();

        },

        strokePolygon: function(polygon) {

            this.polygon(polygon);
            this.stroke();

        },

        rotate: function(angle) {

            this.context.rotate(angle);

            return this;

        },

        scale: function(x, y) {

            this.context.scale(x, y);

            return this;

        },

        translate: function(x, y) {

            this.context.translate(x, y);

            return this;

        },

        colorToMask: function(color, inverted) {

            color = cq.color(color).toArray();

            var sourceData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            var sourcePixels = sourceData.data;

            var mask = [];

            for (var i = 0, len = sourcePixels.length; i < len; i += 4) {
                if (sourcePixels[i + 3] > 0)
                    mask.push(inverted ? false : true);
                else
                    mask.push(inverted ? true : false);
            }

            return mask;
        },

        grayscaleToMask: function() {

            var sourceData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            var sourcePixels = sourceData.data;

            var mask = [];

            for (var i = 0, len = sourcePixels.length; i < len; i += 4) {
                mask.push(((sourcePixels[i + 0] + sourcePixels[i + 1] + sourcePixels[i + 2]) / 3) / 255);
            }

            return mask;
        },

        applyMask: function(mask) {
            var sourceData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            var sourcePixels = sourceData.data;

            var mode = typeof mask[0] === "boolean" ? "bool" : "byte";

            for (var i = 0, len = sourcePixels.length; i < len; i += 4) {
                var value = mask[i / 4];
                sourcePixels[i + 3] = value * 255 | 0;
            }

            this.context.putImageData(sourceData, 0, 0);
            return this;
        },

        fillMask: function(mask) {

            var sourceData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            var sourcePixels = sourceData.data;

            var maskType = typeof mask[0] === "boolean" ? "bool" : "byte";
            var colorMode = arguments.length === 2 ? "normal" : "gradient";

            var color = cq.color(arguments[1]);
            if (colorMode === "gradient")
                colorB = cq.color(arguments[2]);

            for (var i = 0, len = sourcePixels.length; i < len; i += 4) {
                var value = mask[i / 4];

                if (maskType === "byte")
                    value /= 255;

                if (colorMode === "normal") {
                    if (value) {
                        sourcePixels[i + 0] = color[0] | 0;
                        sourcePixels[i + 1] = color[1] | 0;
                        sourcePixels[i + 2] = color[2] | 0;
                        sourcePixels[i + 3] = value * 255 | 0;
                    }
                } else {
                    sourcePixels[i + 0] = color[0] + (colorB[0] - color[0]) * value | 0;
                    sourcePixels[i + 1] = color[1] + (colorB[1] - color[1]) * value | 0;
                    sourcePixels[i + 2] = color[2] + (colorB[2] - color[2]) * value | 0;
                    sourcePixels[i + 3] = 255;
                }
            }

            this.context.putImageData(sourceData, 0, 0);
            return this;
        },

        clear: function(color) {
            if (color) {
                this.context.fillStyle = color;
                this.context.fillRect(0, 0, this.canvas.width, this.canvas.height);
            } else {
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }

            return this;
        },

        clone: function() {

            // var result = cq.createCanvas(this.canvas);

            var result = cq.pool();
            result.width = this.width;
            result.height = this.height;
            result.getContext("2d").drawImage(this.canvas, 0, 0);

            return cq(result);
        },

        gradientText: function(text, x, y, maxWidth, gradient) {

            var words = text.split(" ");

            var h = this.fontHeight() * 2;

            var ox = 0;
            var oy = 0;

            if (maxWidth) {
                var line = 0;
                var lines = [""];

                for (var i = 0; i < words.length; i++) {
                    var word = words[i] + " ";
                    var wordWidth = this.context.measureText(word).width;

                    if (ox + wordWidth > maxWidth) {
                        lines[++line] = "";
                        ox = 0;
                    }

                    lines[line] += word;

                    ox += wordWidth;
                }
            } else
                var lines = [text];

            for (var i = 0; i < lines.length; i++) {
                var oy = y + i * h * 0.6 | 0;
                var lingrad = this.context.createLinearGradient(0, oy, 0, oy + h * 0.6 | 0);

                for (var j = 0; j < gradient.length; j += 2) {
                    lingrad.addColorStop(gradient[j], gradient[j + 1]);
                }

                var text = lines[i];

                this.fillStyle(lingrad).fillText(text, x, oy);
            }

            return this;
        },

        removeColor: function(color) {

            color = cq.color(color);

            var data = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            var pixels = data.data;

            for (var x = 0; x < this.canvas.width; x++) {
                for (var y = 0; y < this.canvas.height; y++) {
                    var i = (y * this.canvas.width + x) * 4;

                    if (pixels[i + 0] === color[0] && pixels[i + 1] === color[1] && pixels[i + 2] === color[2]) {
                        pixels[i + 3] = 0;
                    }

                }
            }

            this.clear();
            this.context.putImageData(data, 0, 0);

            return this;
        },

        _outlineCheck: function check(x, y, width, height, pixels) {

            if (x < 0)
                return 0;
            if (x >= width)
                return 0;
            if (y < 0)
                return 0;
            if (y >= height)
                return 0;

            var i = (x + y * width) * 4;

            return pixels[i + 3] > 0;

        },

        outline: function(color) {

            var color = cq.color(color || "#fff");

            var data = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            var pixels = data.data;

            var newData = this.createImageData(this.canvas.width, this.canvas.height);
            var newPixels = newData.data;

            var canvas = this.canvas;

            for (var x = 0; x < this.canvas.width; x++) {
                for (var y = 0; y < this.canvas.height; y++) {

                    var full = 0;
                    var i = (y * canvas.width + x) * 4;

                    if (!pixels[i + 3])
                        continue;

                    full += this._outlineCheck(x - 1, y, canvas.width, canvas.height, pixels);
                    full += this._outlineCheck(x + 1, y, canvas.width, canvas.height, pixels);
                    full += this._outlineCheck(x, y - 1, canvas.width, canvas.height, pixels);
                    full += this._outlineCheck(x, y + 1, canvas.width, canvas.height, pixels);

                    if (full !== 4) {

                        newPixels[i] = color[0];
                        newPixels[i + 1] = color[1];
                        newPixels[i + 2] = color[2];
                        newPixels[i + 3] = 255;

                    }

                }
            }

            this.context.putImageData(newData, 0, 0);

            return this;
        },

        setHsl: function() {

            if (arguments.length === 1) {
                var args = arguments[0];
            } else {
                var args = arguments;
            }

            var data = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            var pixels = data.data;
            var r, g, b, a, h, s, l, hsl = [], newPixel = [];

            for (var i = 0, len = pixels.length; i < len; i += 4) {
                hsl = cq.rgbToHsl(pixels[i + 0], pixels[i + 1], pixels[i + 2]);

                h = args[0] === false ? hsl[0] : cq.limitValue(args[0], 0, 1);
                s = args[1] === false ? hsl[1] : cq.limitValue(args[1], 0, 1);
                l = args[2] === false ? hsl[2] : cq.limitValue(args[2], 0, 1);

                newPixel = cq.hslToRgb(h, s, l);

                pixels[i + 0] = newPixel[0];
                pixels[i + 1] = newPixel[1];
                pixels[i + 2] = newPixel[2];
            }

            this.context.putImageData(data, 0, 0);

            return this;
        },

        shiftHsl: function() {

            if (arguments.length === 1) {
                var args = arguments[0];
            } else {
                var args = arguments;
            }

            var data = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            var pixels = data.data;
            var r, g, b, a, h, s, l, hsl = [], newPixel = [];

            for (var i = 0, len = pixels.length; i < len; i += 4) {
                hsl = cq.rgbToHsl(pixels[i + 0], pixels[i + 1], pixels[i + 2]);

                if (pixels[i + 0] !== pixels[i + 1] || pixels[i + 1] !== pixels[i + 2]) {
                    h = args[0] === false ? hsl[0] : cq.wrapValue(hsl[0] + args[0], 0, 1);
                    s = args[1] === false ? hsl[1] : cq.limitValue(hsl[1] + args[1], 0, 1);
                } else {
                    h = hsl[0];
                    s = hsl[1];
                }

                l = args[2] === false ? hsl[2] : cq.limitValue(hsl[2] + args[2], 0, 1);

                newPixel = cq.hslToRgb(h, s, l);

                pixels[i + 0] = newPixel[0];
                pixels[i + 1] = newPixel[1];
                pixels[i + 2] = newPixel[2];
            }

            this.context.putImageData(data, 0, 0);

            return this;
        },

        applyColor: function(color) {

            this.save();

            this.globalCompositeOperation("source-in");
            this.clear(color);

            this.restore();

            return this;
        },

        negative: function(src, dst) {

            var data = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            var pixels = data.data;
            var r, g, b, a, h, s, l, hsl = [], newPixel = [];

            for (var i = 0, len = pixels.length; i < len; i += 4) {
                pixels[i + 0] = 255 - pixels[i + 0];
                pixels[i + 1] = 255 - pixels[i + 1];
                pixels[i + 2] = 255 - pixels[i + 2];
            }

            this.context.putImageData(data, 0, 0);

            return this;
        },

        roundRect: function(x, y, width, height, radius) {

            this.moveTo(x + radius, y);
            this.lineTo(x + width - radius, y);
            this.quadraticCurveTo(x + width, y, x + width, y + radius);
            this.lineTo(x + width, y + height - radius);
            this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            this.lineTo(x + radius, y + height);
            this.quadraticCurveTo(x, y + height, x, y + height - radius);
            this.lineTo(x, y + radius);
            this.quadraticCurveTo(x, y, x + radius, y);
            this.closePath();

            return this;
        },

        markupText: function(text) {
        },

        charWidth: function(char) {

            if (!cq.charWidthCache)
                cq.charWidthCache = new Map();

            if (!cq.charWidthCache.has(this.context.font + char)) {

                var width = this.measureText(char).width;

                cq.charWidthCache.set(this.context.font + char, width);

            }

            return cq.charWidthCache.get(this.context.font + char);

        },

        pixelText: function(text, x, y) {

            var prevTextAlign = this.context.textAlign;

            this.context.textAlign = "left";

            var textWidth = 0;

            if (prevTextAlign === "center") {

                for (var i = 0; i < text.length; i++) {

                    var w = this.charWidth(text[i]);

                    var o = w - (w | 0);

                    textWidth += w + (o > 0.5 ? 1 : 0) | 0;

                }

                x -= textWidth / 2 | 0;

            }

            for (var i = 0; i < text.length; i++) {

                var c = text[i];

                var w = this.charWidth(c);

                var o = w - (w | 0);

                this.context.fillText(c, x, y);

                x += w + (o > 0.5 ? 1 : 0) | 0;

            }

            this.context.textAlign = prevTextAlign;

            return this;

        },

        wrappedText: function(text, x, y, maxWidth, lineHeight) {

            if (maxWidth < 0)
                maxWidth = 0;

            var words = text.split(" ");

            var lineHeight = lineHeight || this.fontHeight();

            var ox = 0;
            var oy = 0;

            var textAlign = this.context.textAlign;
            var textBaseline = this.context.textBaseline;

            this.textBaseline("top");

            var spaceWidth = this.context.measureText(" ").width + 0.5 | 0;
            // var newlineOnly = !maxWidth && text.indexOf("\n") > -1;

            if (!maxWidth && text.indexOf("\n") > -1) {

                maxWidth = this.textBoundaries(text).width;

            }

            if (maxWidth) {

                var line = 0;
                var lines = [""];
                var linesWidth = [0];

                for (var i = 0; i < words.length; i++) {

                    var word = words[i];

                    var wordWidth = Math.ceil(this.context.measureText(word).width);

                    if (maxWidth && wordWidth > maxWidth) {

                        /* 4 is still risky, it's valid as long as `-` is the delimiter */

                        if (word.length <= 5)
                            return;

                        var split = word.length / 2 | 0;

                        words.splice(i, 1);
                        words.splice(i, 0, "-" + word.substr(split));
                        words.splice(i, 0, word.substr(0, split) + "-");

                        i--;

                        continue;
                    }

                    if ((ox + wordWidth > maxWidth) || words[i] === "\n") {

                        lines[line] = lines[line].substr(0, lines[line].length - 1);
                        linesWidth[line] -= spaceWidth;

                        lines[++line] = "";
                        linesWidth[line] = 0;
                        ox = 0;
                    }

                    if (words[i] !== "\n") {

                        lines[line] += word + " ";

                        ox += wordWidth + spaceWidth;

                        linesWidth[line] += wordWidth + spaceWidth;

                    }

                }

                if (words[i] !== "\n") {
                    lines[line] = lines[line].substr(0, lines[line].length - 1);
                    linesWidth[line] -= spaceWidth;
                }

            } else {

                var lines = [text];
                var linesWidth = [this.context.measureText(text).width + 0.5 | 0];

            }

            for (var i = 0; i < lines.length; i++) {

                var oy = y + i * lineHeight | 0;

                var text = lines[i];
                var width = linesWidth[i];

                this.textAlign("left");

                if (textAlign === "left" || textAlign === "start")
                    this.fillText(text, x, oy);
                else if (textAlign === "center")
                    this.fillText(text, x - width * 0.5 | 0, oy);
                else
                    this.fillText(text, x - width, oy);

            }

            this.textAlign(textAlign);
            this.textBaseline(textBaseline);

            return this;

        },

        fontHeights: {},
        fontTops: {},

        fontTop: function() {

            if (!this.fontTops[this.context.font])
                this.fontHeight();

            return this.fontTops[this.context.font];

        },

        parseFontHeight: function(font) {

            var match = font.match(/([0-9]+)(px|pt)/);

            return match[2] === "px" ? (match[1] | 0) : (math[1] * 1.33 | 0);

        },

        fontHeight: function() {

            var font = this.font();

            if (!this.fontHeights[font]) {

                var fontStyleHeight = this.parseFontHeight(font);

                var temp = cq(100, 10 + fontStyleHeight * 2 | 0);

                cq.setContextSmoothing(temp.context, false);

                temp.font(font).fillStyle("#fff");
                temp.textBaseline("top");

                /* Use direct fillText as internal inmplementation uses fontWidth() */
                var oy = 10;

                temp.context.fillText("Play Moog", 20, oy);

                var data = temp.getImageData(0, 0, temp.width, temp.height).data;

                var top = temp.height;
                var bottom = 0;

                for (var i = 0; i < data.length; i += 4) {

                    var x = (i / 4 | 0) % temp.width;
                    var y = (i / 4 | 0) / temp.width | 0;

                    /* A little threshold for anti-alias */

                    if (data[i + 3] < 200)
                        continue;

                    if (y < top)
                        top = y;
                    if (y > bottom)
                        bottom = y;

                }

                this.fontHeights[font] = bottom - oy + 1;
                this.fontTops[font] = top - oy;

            }

            return this.fontHeights[font];

        },

        textBoundaries: function(text, maxWidth) {

            if (maxWidth < 0)
                maxWidth = 0;

            var words = text.split(" ");

            var h = this.fontHeight();

            var ox = 0;
            var oy = 0;

            var spaceWidth = this.context.measureText(" ").width + 0.5 | 0;

            var line = 0;
            var lines = [""];

            var width = 0;

            for (var i = 0; i < words.length; i++) {

                var word = words[i];
                var wordWidth = Math.ceil(this.context.measureText(word).width);

                if (maxWidth && (wordWidth > maxWidth)) {

                    if (word.length <= 5)
                        continue;

                    var split = word.length / 2 | 0;

                    words.splice(i, 1);
                    words.splice(i, 0, "-" + word.substr(split));
                    words.splice(i, 0, word.substr(0, split) + "-");

                    i--;

                    continue;
                }

                if (((ox + wordWidth > maxWidth) && maxWidth) || words[i] === "\n") {

                    if (ox > width)
                        width = ox;

                    lines[++line] = "";

                    ox = 0;

                }

                if (words[i] !== "\n") {

                    lines[line] += word;

                    ox += wordWidth + spaceWidth;

                }

            }

            if (maxWidth) {

                var width = maxWidth;

            } else {

                if (!width) {

                    width = this.context.measureText(text).width + 0.5 | 0;

                }

            }

            return {
                height: lines.length * h,
                width: Math.ceil(width),
                lines: lines.length,
                fontHeight: h
            }

        },

        repeatImageRegion: function(image, sx, sy, sw, sh, dx, dy, dw, dh) {

            if (!image || !image.width)
                return;

            this.save();
            this.rect(dx, dy, dw, dh);
            this.clip();

            for (var x = 0, len = Math.ceil(dw / sw); x < len; x++) {

                for (var y = 0, leny = Math.ceil(dh / sh); y < leny; y++) {

                    this.drawImage(image, sx, sy, sw, sh, dx + x * sw, dy + y * sh, sw, sh);

                }

            }

            this.restore();

            return this;

        },

        repeatImage: function(image, x, y, w, h) {
            // if (!env.details) return this;

            if (!image || !image.width || !image.height)
                return this;

            if (arguments.length < 9) {

                this.repeatImageRegion(image, 0, 0, image.width, image.height, x, y, w, h);

            } else {

                this.repeatImageRegion.apply(this, arguments);

            }

            return this;
        },

        borderImageEmptyRegion: [0, 0, 0, 0],

        borderImage: function(image, x, y, w, h, t, r, b, l, fill) {

            if (!image || !image.width)
                return this;

            // if (!env.details) return this;

            if (typeof t === "object") {

                var region = t.region;

                if (!region) {

                    region = this.borderImageEmptyRegion;
                    region[2] = image.width;
                    region[3] = image.height;

                }

                if (t.outset) {

                    var outset = t.outset;

                    if (w > outset * 2 && h > outset * 2) {

                        if (t.fill !== false) {

                            this.drawImage(image, region[0] + outset, region[1] + outset, (region[2] - outset * 2), (region[3] - outset * 2), x + outset, y + outset, w - outset * 2, h - outset * 2);

                        }

                        /* edges */

                        this.drawImage(image, region[0], region[1] + outset, outset, region[3] - 2 * outset, x, y + outset, outset, h - outset * 2);
                        this.drawImage(image, region[0] + region[2] - outset, region[1] + outset, outset, region[3] - 2 * outset, x + w - outset, y + outset, outset, h - outset * 2);
                        this.drawImage(image, region[0] + outset, region[1], region[2] - outset * 2, outset, x + outset, y, w - outset * 2, outset);
                        this.drawImage(image, region[0] + outset, region[1] + region[3] - outset, region[2] - outset * 2, outset, x + outset, y + h - outset, w - outset * 2, outset);

                        /* corners */

                        this.drawImage(image, region[0], region[1], outset, outset, x, y, outset, outset);
                        this.drawImage(image, region[0], region[1] + region[3] - outset, outset, outset, x, y + h - outset, outset, outset);
                        this.drawImage(image, region[0] + region[2] - outset, region[1], outset, outset, x + w - outset, y, outset, outset);
                        this.drawImage(image, region[0] + region[2] - outset, region[1] + region[3] - outset, outset, outset, x + w - outset, y + h - outset, outset, outset);

                    }

                }
                /* complex */
                else {

                    var bottomLeft = t.bottomLeft || [0, 0, 0, 0];
                    var bottomRight = t.bottomRight || [0, 0, 0, 0];
                    var topLeft = t.topLeft || [0, 0, 0, 0];
                    var topRight = t.topRight || [0, 0, 0, 0];

                    var clh = bottomLeft[3] + topLeft[3];
                    var crh = bottomRight[3] + topRight[3];
                    var ctw = topLeft[2] + topRight[2];
                    var cbw = bottomLeft[2] + bottomRight[2];

                    t.fillPadding = [0, 0, 0, 0];

                    if (t.left)
                        t.fillPadding[0] = t.left[2];
                    if (t.top)
                        t.fillPadding[1] = t.top[3];
                    if (t.right)
                        t.fillPadding[2] = t.right[2];
                    if (t.bottom)
                        t.fillPadding[3] = t.bottom[3];

                    // if (!t.fillPadding) t.fillPadding = [0, 0, 0, 0];

                    if (t.fill) {
                        this.drawImage(image, t.fill[0], t.fill[1], t.fill[2], t.fill[3], x + t.fillPadding[0], y + t.fillPadding[1], w - t.fillPadding[2] - t.fillPadding[0], h - t.fillPadding[3] - t.fillPadding[1]);
                    } else {// this.fillRect(x + t.fillPadding[0], y + t.fillPadding[1], w - t.fillPadding[2] - t.fillPadding[0], h - t.fillPadding[3] - t.fillPadding[1]);
                    }

                    /* sides */

                    if (t.left)
                        this[t.left[4] === "stretch" ? "drawImage" : "repeatImage"](image, t.left[0], t.left[1], t.left[2], t.left[3], x, y + topLeft[3], t.left[2], h - clh);
                    if (t.right)
                        this[t.right[4] === "stretch" ? "drawImage" : "repeatImage"](image, t.right[0], t.right[1], t.right[2], t.right[3], x + w - t.right[2], y + topRight[3], t.right[2], h - crh);
                    if (t.top)
                        this[t.top[4] === "stretch" ? "drawImage" : "repeatImage"](image, t.top[0], t.top[1], t.top[2], t.top[3], x + topLeft[2], y, w - ctw, t.top[3]);
                    if (t.bottom)
                        this[t.bottom[4] === "stretch" ? "drawImage" : "repeatImage"](image, t.bottom[0], t.bottom[1], t.bottom[2], t.bottom[3], x + bottomLeft[2], y + h - t.bottom[3], w - cbw, t.bottom[3]);

                    /* corners */

                    if (t.bottomLeft)
                        this.drawImage(image, t.bottomLeft[0], t.bottomLeft[1], t.bottomLeft[2], t.bottomLeft[3], x, y + h - t.bottomLeft[3], t.bottomLeft[2], t.bottomLeft[3]);
                    if (t.topLeft)
                        this.drawImage(image, t.topLeft[0], t.topLeft[1], t.topLeft[2], t.topLeft[3], x, y, t.topLeft[2], t.topLeft[3]);
                    if (t.topRight)
                        this.drawImage(image, t.topRight[0], t.topRight[1], t.topRight[2], t.topRight[3], x + w - t.topRight[2], y, t.topRight[2], t.topRight[3]);
                    if (t.bottomRight)
                        this.drawImage(image, t.bottomRight[0], t.bottomRight[1], t.bottomRight[2], t.bottomRight[3], x + w - t.bottomRight[2], y + h - t.bottomRight[3], t.bottomRight[2], t.bottomRight[3]);

                }

            } else {

                /* top */
                if (t > 0 && w - l - r > 0)
                    this.drawImage(image, l, 0, image.width - l - r, t, x + l, y, w - l - r, t);

                /* bottom */
                if (b > 0 && w - l - r > 0)
                    this.drawImage(image, l, image.height - b, image.width - l - r, b, x + l, y + h - b, w - l - r, b);
                //      console.log(x, y, w, h, t, r, b, l);
                //      console.log(image, 0, t, l, image.height - b - t, x, y + t, l, h - b - t);
                /* left */
                if (l > 0 && h - b - t > 0)
                    this.drawImage(image, 0, t, l, image.height - b - t, x, y + t, l, h - b - t);

                /* right */
                if (r > 0 && h - b - t > 0)
                    this.drawImage(image, image.width - r, t, r, image.height - b - t, x + w - r, y + t, r, h - b - t);

                /* top-left */
                if (l > 0 && t > 0)
                    this.drawImage(image, 0, 0, l, t, x, y, l, t);

                /* top-right */
                if (r > 0 && t > 0)
                    this.drawImage(image, image.width - r, 0, r, t, x + w - r, y, r, t);

                /* bottom-right */
                if (r > 0 && b > 0)
                    this.drawImage(image, image.width - r, image.height - b, r, b, x + w - r, y + h - b, r, b);

                /* bottom-left */
                if (l > 0 && b > 0)
                    this.drawImage(image, 0, image.height - b, l, b, x, y + h - b, l, b);

                if (fill) {
                    if (typeof fill === "string") {
                        this.fillStyle(fill).fillRect(x + l, y + t, w - l - r, h - t - b);
                    } else {
                        if (w - l - r > 0 && h - t - b > 0)
                            this.drawImage(image, l, t, image.width - r - l, image.height - b - t, x + l, y + t, w - l - r, h - t - b);
                    }
                }
            }
        },

        setPixel: function(color, x, y) {

            /* fillRect is slow! */

            return this.fillStyle(color).fillRect(x, y, 1, 1);

            /* this is how it should work - but it does not */

            color = cq.color(color);

            var pixel = this.createImageData(1, 1);

            pixel.data[0] = color[0];
            pixel.data[1] = color[1];
            pixel.data[2] = color[2];
            pixel.data[3] = 255;

            this.putImageData(pixel, x, y);

            return this;
        },

        getPixel: function(x, y) {

            var pixel = this.context.getImageData(x, y, 1, 1).data;

            return cq.color([pixel[0], pixel[1], pixel[2], pixel[3]]);

        },

        clearRect: function(x, y, w, h) {

            this.context.clearRect(x, y, w, h);

            return this;

        },

        fill: function() {

            this.context.fill();

            return this;

        },

        stroke: function() {

            this.context.stroke();

            return this;

        },

        createImageData: function(width, height) {

            if (false && this.context.createImageData) {

                return this.context.createImageData.apply(this.context, arguments);

            } else {

                if (!this.emptyCanvas) {

                    this.emptyCanvas = cq.createCanvas(width, height);
                    this.emptyCanvasContext = this.emptyCanvas.getContext("2d");

                }

                this.emptyCanvas.width = width;
                this.emptyCanvas.height = height;

                return this.emptyCanvasContext.getImageData(0, 0, width, height);
            }

        },

        strokeLine: function(x1, y1, x2, y2) {

            this.beginPath();

            if (typeof x2 === "undefined") {
                this.moveTo(x1.x, x1.y);
                this.lineTo(y1.x, y1.y);
            } else {
                this.moveTo(x1, y1);
                this.lineTo(x2, y2);
            }

            this.stroke();

            return this;

        },

        shadowOffset: function(x, y) {

            this.context.shadowOffsetX = x;
            this.context.shadowOffsetY = y;

            return this;

        },

        noLineDash: [],
        tempLineDash: [2, 2],

        setLineDash: function(dash) {

            if (typeof dash === "number") {

                this.tempLineDash[0] = dash;
                this.tempLineDash[1] = dash;

                dash = this.tempLineDash;

            }

            this.context.setLineDash(dash ? dash : this.noLineDash);

            return this;

        },

        measureText: function(text) {

            return this.context.measureText(text);

        },

        getLineDash: function() {

            return this.context.getLineDash();

        },

        createRadialGradient: function(x0, y0, r0, x1, y1, r1) {

            return this.context.createRadialGradient(x0, y0, r0, x1, y1, r1);

        },

        createLinearGradient: function(x0, y0, x1, y1) {

            return this.context.createLinearGradient(x0, y0, x1, y1);

        },

        createPattern: function(image, repeat) {

            return this.context.createPattern(image, repeat);

        },

        getImageData: function(sx, sy, sw, sh) {

            return this.context.getImageData(sx, sy, sw, sh);

        },

        /* If you think that I am retarded because I use fillRect to set
           pixels - read about premultipled alpha in canvas */

        writeMeta: function(data) {

            var json = JSON.stringify(data);

            json = encodeURIComponent(json);

            var bytes = [];

            for (var i = 0; i < json.length; i++) {
                bytes.push(json.charCodeAt(i));
                //      console.log(json[i])
            }

            bytes.push(127);

            var x = this.width - 1;
            var y = this.height - 1;

            var pixel = [];

            while (bytes.length) {

                var byte = bytes.shift();

                pixel.unshift(byte * 2);
                //        console.log(x + String.fromCharCode(byte), byte);

                if (!bytes.length)
                    for (var i = 0; i < 3 - pixel.length; i++)
                        pixel.unshift(254);

                if (pixel.length === 3) {
                    this.fillStyle(cq.color(pixel).toRgb()).fillRect(x, y, 1, 1);
                    pixel = [];
                    x--;

                    if (x < 0) {
                        y--;
                        x = this.width - 1;
                    }
                }
            }

            return this;

        },

        /* setters / getters */

        strokeStyle: function(style) {

            if (style == null) {

                return this.context.strokeStyle;

            } else {

                this.context.strokeStyle = style;

                return this;

            }

        },

        fillStyle: function(style) {

            if (style == null) {

                return this.context.fillStyle;

            } else {

                this.context.fillStyle = style;

                return this;

            }

        },

        font: function(font) {

            if (font == null) {

                return this.context.font;

            } else {

                this.context.font = font;

                return this;
            }

        },

        filter: function(filter) {

            if (filter) {

                this.context.filter = filter;

                return this;

            } else {

                return this.context.filter;

            }

            return this;

        },

        readMeta: function() {

            var bytes = [];

            var x = this.width - 1;
            var y = this.height - 1;

            while (true) {
                var pixel = this.getPixel(x, y);

                var stop = false;

                for (var i = 0; i < 3; i++) {

                    if (pixel[2 - i] === 254)
                        stop = true;

                    else
                        bytes.push(pixel[2 - i] / 2 | 0);

                }

                if (stop)
                    break;

                x--;

                if (x < 0) {
                    y--;
                    x = this.width - 1;
                    break;
                }
            }

            var json = "";

            while (bytes.length) {
                json += String.fromCharCode(bytes.shift());
            }

            var data = false;

            console.log(json);

            try {
                data = JSON.parse(decodeURIComponent(json));
            } catch (e) {
            }

            return data;

        },

        get width() {

            return this.canvas.width;

        },

        get height() {

            return this.canvas.height;

        },

        set width(w) {

            this.canvas.width = w;
            this.update();

            return this.canvas.width;

        },

        set height(h) {

            this.canvas.height = h;
            this.update();

            return this.canvas.height;

        }

    };

    /* extend Layer with drawing context methods */

    var methods = ["arc", "arcTo", "beginPath", "bezierCurveTo", "clip", "closePath", "createLinearGradient", "createRadialGradient", "createPattern", "drawFocusRing", "drawImage", "fill", "fillRect", "fillText", "getImageData", "isPointInPath", "lineTo", "measureText", "moveTo", "putImageData", "quadraticCurveTo", "rect", "restore", "rotate", "scale", "setTransform", "strokeRect", "strokeText", "transform", "translate", "setLineDash"];

    for (var i = 0; i < methods.length; i++) {

        var name = methods[i];

        if (cq.Layer.prototype[name])
            continue;

        cq.Layer.prototype[name] = (function(method) {

            return function() {

                var args = new Array(arguments.length);

                for (var i = 0; i < args.length; ++i) {

                    args[i] = arguments[i];

                }

                cq.fastApply(method, this.context, args);

                return this;
            }

        }
        )(CanvasRenderingContext2D.prototype[name]);

        continue;

        if (!this.debug) {
            // if (!cq.Layer.prototype[name]) cq.Layer.prototype[name] = Function("this.context." + name + ".apply(this.context, arguments); return this;");

            var self = this;

            (function(name) {

                cq.Layer.prototype[name] = function() {
                    // this.context[name].apply(this.context, arguments);

                    cq.fastApply(this.context[name], this.context, arguments);

                    return this;
                }

            }
            )(name);

        } else {

            var self = this;

            (function(name) {

                cq.Layer.prototype[name] = function() {
                    try {
                        this.context[name].apply(this.context, arguments);
                        return this;
                    } catch (e) {
                        var err = new Error();
                        console.log(err.stack);
                        throw (e + err.stack);

                        console.log(e, name, arguments);
                    }
                }

            }
            )(name);

        }

    }
    ;
    /* create setters and getters */

    var properties = ["globalAlpha", "globalCompositeOperation", "lineCap", "lineJoin", "lineWidth", "miterLimit", "shadowOffsetX", "shadowOffsetY", "shadowBlur", "shadowColor", "textAlign", "textBaseline", "lineDashOffset"];

    for (var i = 0; i < properties.length; i++) {

        var name = properties[i];

        if (!cq.Layer.prototype[name])
            cq.Layer.prototype[name] = Function("if(arguments.length) { this.context." + name + " = arguments[0]; return this; } else { return this.context." + name + "; }");

    }
    ;
    /* color */

    cq.Color = function(data, type) {

        if (arguments.length)
            this.parse(data, type);
    }

    cq.Color.prototype = {

        toString: function() {
            return this.toRgb();
        },

        parse: function(args, type) {
            if (args[0]instanceof cq.Color) {
                this[0] = args[0][0];
                this[1] = args[0][1];
                this[2] = args[0][2];
                this[3] = args[0][3];
                return;
            }

            if (typeof args === "string") {
                var match = null;

                if (args[0] === "#") {
                    var rgb = cq.hexToRgb(args);
                    this[0] = rgb[0];
                    this[1] = rgb[1];
                    this[2] = rgb[2];
                    this[3] = 1.0;
                } else if (match = args.match(/rgb\((.*),(.*),(.*)\)/)) {
                    this[0] = match[1] | 0;
                    this[1] = match[2] | 0;
                    this[2] = match[3] | 0;
                    this[3] = 1.0;
                } else if (match = args.match(/rgba\((.*),(.*),(.*)\)/)) {
                    this[0] = match[1] | 0;
                    this[1] = match[2] | 0;
                    this[2] = match[3] | 0;
                    this[3] = match[4] | 0;
                } else if (match = args.match(/hsl\((.*),(.*),(.*)\)/)) {
                    this.fromHsl(match[1], match[2], match[3]);
                } else if (match = args.match(/hsv\((.*),(.*),(.*)\)/)) {
                    this.fromHsv(match[1], match[2], match[3]);
                }
            } else {
                switch (type) {
                case "hsl":
                case "hsla":

                    this.fromHsl(args[0], args[1], args[2], args[3]);
                    break;

                case "hsv":
                case "hsva":

                    this.fromHsv(args[0], args[1], args[2], args[3]);
                    break;

                default:
                    this[0] = args[0];
                    this[1] = args[1];
                    this[2] = args[2];
                    this[3] = typeof args[3] === "undefined" ? 1.0 : args[3];
                    break;
                }
            }
        },

        a: function(a) {

            if (arguments.length === 1) {

                this[3] = a;

            } else {

                return this[3];

            }

            return this;

        },

        alpha: function(a) {

            if (arguments.length === 1) {

                this[3] = a;

            } else {

                return this[3];

            }

            return this;

        },

        fromHsl: function() {
            var components = arguments[0]instanceof Array ? arguments[0] : arguments;

            var color = cq.hslToRgb(parseFloat(components[0]), parseFloat(components[1]), parseFloat(components[2]));

            this[0] = color[0];
            this[1] = color[1];
            this[2] = color[2];
            this[3] = typeof arguments[3] === "undefined" ? 1.0 : arguments[3];
        },

        fromHsv: function() {
            var components = arguments[0]instanceof Array ? arguments[0] : arguments;
            var color = cq.hsvToRgb(parseFloat(components[0]), parseFloat(components[1]), parseFloat(components[2]));

            this[0] = color[0];
            this[1] = color[1];
            this[2] = color[2];
            this[3] = typeof arguments[3] === "undefined" ? 1.0 : arguments[3];
        },

        toArray: function() {

            return [this[0], this[1], this[2], this[3]];

        },

        toFloatArray: function() {

            return [this[0] / 255, this[1] / 255, this[2] / 255, this[3]];

        },

        toRgb: function() {
            return "rgb(" + this[0] + ", " + this[1] + ", " + this[2] + ")";
        },

        toRgba: function() {
            return "rgba(" + this[0] + ", " + this[1] + ", " + this[2] + ", " + this[3] + ")";
        },

        toHex: function() {
            return cq.rgbToHex(this[0], this[1], this[2]);
        },

        toHsl: function() {
            var c = cq.rgbToHsl(this[0], this[1], this[2]);
            c[3] = this[3];
            return c;
        },

        toHsv: function() {
            var c = cq.rgbToHsv(this[0], this[1], this[2]);
            c[3] = this[3];
            return c;
        },

        gradient: function(target, steps) {
            var targetColor = cq.color(target);
        },

        shiftHsl: function() {
            var hsl = this.toHsl();

            if (this[0] !== this[1] || this[1] !== this[2]) {
                var h = arguments[0] === false ? hsl[0] : cq.wrapValue(hsl[0] + arguments[0], 0, 1);
                var s = arguments[1] === false ? hsl[1] : cq.limitValue(hsl[1] + arguments[1], 0, 1);
            } else {
                var h = hsl[0];
                var s = hsl[1];
            }

            var l = arguments[2] === false ? hsl[2] : cq.limitValue(hsl[2] + arguments[2], 0, 1);

            this.fromHsl(h, s, l);

            return this;
        },

        setHsl: function() {
            var hsl = this.toHsl();

            var h = arguments[0] === false ? hsl[0] : cq.limitValue(arguments[0], 0, 1);
            var s = arguments[1] === false ? hsl[1] : cq.limitValue(arguments[1], 0, 1);
            var l = arguments[2] === false ? hsl[2] : cq.limitValue(arguments[2], 0, 1);

            this.fromHsl(h, s, l);

            return this;
        },

        mix: function(color, amount) {

            color = cq.color(color);

            for (var i = 0; i < 4; i++) {

                this[i] = cq.mix(this[i], color[i], amount);

            }

            return this;

        }

    };

    /* Utilities / Framework */

    cq.images = {};

    cq.loadImages = function() {

        var promises = [];

        for (var i = 0; i < arguments.length; i++) {

            var current = arguments[i];
            var keys;

            keys = current;

            for (var key in keys) {

                cq.loaderscount++;

                var path = keys[key];

                var image = new orgImage();

                cq.images[key] = image;
                cq.loaderscount++;

                var promise = new Promise(function(resolve, reject) {

                    image.addEventListener("load", function() {

                        // cq.loadercallback();

                        resolve();

                    });

                    image.addEventListener("error", function() {

                        throw ("unable to load " + this.src);

                    });

                }
                );

                image.src = path;

            }

            promises.push(promise);

        }

        return Promise.all(promises);

    }
    ;

    cq.fn = cq.Layer.prototype;

    window["cq"] = window["CanvasQuery"] = cq;

    return cq;

}
)();

/* file: ../../playground/build/playground-base.js */

/* file: license.txt */

/*     

  PlaygroundJS r12
  
  http://playgroundjs.com
  
  (c) 2012-2016 http://rezoner.net
  
  Playground may be freely distributed under the MIT license.

  latest major changes:

  r12

  + fixed font loader and antialias
  + updated canvasquery

  r11

  + sound panning
  
  r10

  + tween.call
  + pointer now takes care of cursor that left the window
  + this.keyboard.any (is any key pressed)

  r9

  + json data cascade
  + tween step event

  r8

  + fixed Transitions for CommonJS
  + images expand into hierarchy

  r7

  + fixed event.off
  + temporary fixes for gamepad d-pad

  r6

  + custom transitions
  + fixes for gamepad
  + updated CanvasQuery
  
  r5

  + game loop split into render and step - check profiler
  + fixed loader last item
  + fixed some flow issues
  + imageready event
  + loadFont
  + gamepad stick issue
  + pointerwheel event
  + updated CanvasQuery
  - removed video recorder  

  r4

  + tweens with events
  + context argument for events

  r3

  + pointer = mouse + touch

*/

/* file: src/lib/Ease.js */

/*     

  Ease 1.1
  
  http://canvasquery.com
  
  (c) 2015 by Rezoner - http://rezoner.net

  `ease` may be freely distributed under the MIT license.
     
  Cubic-spline interpolation by Ivan Kuckir

  http://blog.ivank.net/interpolation-with-cubic-splines.html

  With slight modifications by Morgan Herlocker

  https://github.com/morganherlocker/cubic-spline

*/

(function() {

    var ease = function(progress, easing) {

        if (typeof ease.cache[easing] === "function") {

            return ease.cache[easing](progress);

        } else {

            return ease.spline(progress, easing || ease.defaultEasing);

        }

    };

    var extend = function() {
        for (var i = 1; i < arguments.length; i++) {
            for (var j in arguments[i]) {
                arguments[0][j] = arguments[i][j];
            }
        }

        return arguments[0];
    };

    extend(ease, {

        defaultEasing: "016",

        cache: {

            linear: function(t) {
                return t
            },

            inQuad: function(t) {
                return t * t
            },
            outQuad: function(t) {
                return t * (2 - t)
            },
            inOutQuad: function(t) {
                return t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t
            },
            inCubic: function(t) {
                return t * t * t
            },
            outCubic: function(t) {
                return (--t) * t * t + 1
            },
            inOutCubic: function(t) {
                return t < .5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1
            },
            inQuart: function(t) {
                return t * t * t * t
            },
            outQuart: function(t) {
                return 1 - (--t) * t * t * t
            },
            inOutQuart: function(t) {
                return t < .5 ? 8 * t * t * t * t : 1 - 8 * (--t) * t * t * t
            },
            inQuint: function(t) {
                return t * t * t * t * t
            },
            outQuint: function(t) {
                return 1 + (--t) * t * t * t * t
            },
            inOutQuint: function(t) {
                return t < .5 ? 16 * t * t * t * t * t : 1 + 16 * (--t) * t * t * t * t
            },
            inSine: function(t) {
                return -1 * Math.cos(t / 1 * (Math.PI * 0.5)) + 1;
            },
            outSine: function(t) {
                return Math.sin(t / 1 * (Math.PI * 0.5));
            },
            inOutSine: function(t) {
                return -1 / 2 * (Math.cos(Math.PI * t) - 1);
            },
            inExpo: function(t) {
                return (t == 0) ? 0 : Math.pow(2, 10 * (t - 1));
            },
            outExpo: function(t) {
                return (t == 1) ? 1 : (-Math.pow(2, -10 * t) + 1);
            },
            inOutExpo: function(t) {
                if (t == 0)
                    return 0;
                if (t == 1)
                    return 1;
                if ((t /= 1 / 2) < 1)
                    return 1 / 2 * Math.pow(2, 10 * (t - 1));
                return 1 / 2 * (-Math.pow(2, -10 * --t) + 2);
            },
            inCirc: function(t) {
                return -1 * (Math.sqrt(1 - t * t) - 1);
            },
            outCirc: function(t) {
                return Math.sqrt(1 - (t = t - 1) * t);
            },
            inOutCirc: function(t) {
                if ((t /= 1 / 2) < 1)
                    return -1 / 2 * (Math.sqrt(1 - t * t) - 1);
                return 1 / 2 * (Math.sqrt(1 - (t -= 2) * t) + 1);
            },
            inElastic: function(t) {
                var s = 1.70158;
                var p = 0;
                var a = 1;
                if (t == 0)
                    return 0;
                if (t == 1)
                    return 1;
                if (!p)
                    p = 0.3;
                if (a < 1) {
                    a = 1;
                    var s = p / 4;
                } else
                    var s = p / (2 * Math.PI) * Math.asin(1 / a);
                return -(a * Math.pow(2, 10 * (t -= 1)) * Math.sin((t - s) * (2 * Math.PI) / p));
            },
            outElastic: function(t) {
                var s = 1.70158;
                var p = 0;
                var a = 1;
                if (t == 0)
                    return 0;
                if (t == 1)
                    return 1;
                if (!p)
                    p = 0.3;
                if (a < 1) {
                    a = 1;
                    var s = p / 4;
                } else
                    var s = p / (2 * Math.PI) * Math.asin(1 / a);
                return a * Math.pow(2, -10 * t) * Math.sin((t - s) * (2 * Math.PI) / p) + 1;
            },
            inOutElastic: function(t) {
                var s = 1.70158;
                var p = 0;
                var a = 1;
                if (t == 0)
                    return 0;
                if ((t /= 1 / 2) == 2)
                    return 1;
                if (!p)
                    p = (0.3 * 1.5);
                if (a < 1) {
                    a = 1;
                    var s = p / 4;
                } else
                    var s = p / (2 * Math.PI) * Math.asin(1 / a);
                if (t < 1)
                    return -.5 * (a * Math.pow(2, 10 * (t -= 1)) * Math.sin((t - s) * (2 * Math.PI) / p));
                return a * Math.pow(2, -10 * (t -= 1)) * Math.sin((t - s) * (2 * Math.PI) / p) * 0.5 + 1;
            },
            inBack: function(t, s) {
                if (s == undefined)
                    s = 1.70158;
                return 1 * t * t * ((s + 1) * t - s);
            },
            outBack: function(t, s) {
                if (s == undefined)
                    s = 1.70158;
                return 1 * ((t = t / 1 - 1) * t * ((s + 1) * t + s) + 1);
            },
            inOutBack: function(t, s) {
                if (s == undefined)
                    s = 1.70158;
                if ((t /= 1 / 2) < 1)
                    return 1 / 2 * (t * t * (((s *= (1.525)) + 1) * t - s));
                return 1 / 2 * ((t -= 2) * t * (((s *= (1.525)) + 1) * t + s) + 2);
            },
            inBounce: function(t) {
                return 1 - this.outBounce(1 - t);
            },
            outBounce: function(t) {
                if ((t /= 1) < (1 / 2.75)) {
                    return (7.5625 * t * t);
                } else if (t < (2 / 2.75)) {
                    return (7.5625 * (t -= (1.5 / 2.75)) * t + .75);
                } else if (t < (2.5 / 2.75)) {
                    return (7.5625 * (t -= (2.25 / 2.75)) * t + .9375);
                } else {
                    return (7.5625 * (t -= (2.625 / 2.75)) * t + .984375);
                }
            },
            inOutBounce: function(t) {
                if (t < 1 / 2)
                    return this.inBounce(t * 2) * 0.5;
                return this.outBounce(t * 2 - 1) * 0.5 + 0.5;
            }
        },

        translateEasing: function(key) {

            if (!this.cache[key]) {
                var array = key.split('');

                var sign = 1;
                var signed = false;
                var trimming = false;

                for (var i = 0; i < array.length; i++) {

                    var char = array[i];

                    if (char === "-") {
                        sign = -1;
                        signed = true;
                        array.splice(i--, 1);
                    } else if (char === "+") {
                        sign = 1;
                        array.splice(i--, 1);
                    } else if (char === "t") {
                        trimming = !trimming;
                        array.splice(i--, 1);
                    } else
                        array[i] = parseInt(array[i], 16) * sign;

                }

                var min = Math.min.apply(null, array);
                var max = Math.max.apply(null, array);
                var diff = max - min;
                var cache = [];
                var normalized = [];

                for (var i = 0; i < array.length; i++) {

                    if (signed) {

                        var diff = Math.max(Math.abs(min), Math.abs(max))
                        var value = array[i] / diff;

                    } else {

                        var diff = max - min;
                        var value = (array[i] - min) / diff;

                    }

                    if (trimming) {

                        if (value < 0)
                            value = 0;
                        if (value > 1.0)
                            value = 1.0;

                    }

                    normalized.push(value);

                }

                this.cache[key] = normalized;

            }

            return this.cache[key]

        },

        splineK: {},
        splineX: {},
        splineY: {},

        insertIntermediateValues: function(a) {
            var result = [];
            for (var i = 0; i < a.length; i++) {
                result.push(a[i]);

                if (i < a.length - 1)
                    result.push(a[i + 1] + (a[i] - a[i + 1]) * 0.6);
            }

            return result;
        },

        spline: function(x, key) {

            if (!this.splineK[key]) {

                var xs = [];
                var ys = this.translateEasing(key);

                // ys = this.insertIntermediateValues(ys);

                if (!ys.length)
                    return 0;

                for (var i = 0; i < ys.length; i++)
                    xs.push(i * (1 / (ys.length - 1)));

                var ks = xs.map(function() {
                    return 0
                });

                ks = this.getNaturalKs(xs, ys, ks);

                this.splineX[key] = xs;
                this.splineY[key] = ys;
                this.splineK[key] = ks;

            }

            if (x > 1)
                return this.splineY[key][this.splineY[key].length - 1];

            var ks = this.splineK[key];
            var xs = this.splineX[key];
            var ys = this.splineY[key];

            var i = 1;

            while (xs[i] < x)
                i++;

            var t = (x - xs[i - 1]) / (xs[i] - xs[i - 1]);
            var a = ks[i - 1] * (xs[i] - xs[i - 1]) - (ys[i] - ys[i - 1]);
            var b = -ks[i] * (xs[i] - xs[i - 1]) + (ys[i] - ys[i - 1]);
            var q = (1 - t) * ys[i - 1] + t * ys[i] + t * (1 - t) * (a * (1 - t) + b * t);

            /*
      var py = ys[i - 2];
      var cy = ys[i - 1];
      var ny = (i < ys.length - 1) ? ys[i] : ys[i - 1];

      if (q > ny) {
        var diff = (q - py);
        //q = py + diff;

      }

    if (cy === ny && cy === py) q = py;
    */

            return q;
        },

        getNaturalKs: function(xs, ys, ks) {
            var n = xs.length - 1;
            var A = this.zerosMat(n + 1, n + 2);

            for (var i = 1; i < n; i++) // rows
            {
                A[i][i - 1] = 1 / (xs[i] - xs[i - 1]);
                A[i][i] = 2 * (1 / (xs[i] - xs[i - 1]) + 1 / (xs[i + 1] - xs[i]));
                A[i][i + 1] = 1 / (xs[i + 1] - xs[i]);
                A[i][n + 1] = 3 * ((ys[i] - ys[i - 1]) / ((xs[i] - xs[i - 1]) * (xs[i] - xs[i - 1])) + (ys[i + 1] - ys[i]) / ((xs[i + 1] - xs[i]) * (xs[i + 1] - xs[i])));
            }

            A[0][0] = 2 / (xs[1] - xs[0]);
            A[0][1] = 1 / (xs[1] - xs[0]);
            A[0][n + 1] = 3 * (ys[1] - ys[0]) / ((xs[1] - xs[0]) * (xs[1] - xs[0]));

            A[n][n - 1] = 1 / (xs[n] - xs[n - 1]);
            A[n][n] = 2 / (xs[n] - xs[n - 1]);
            A[n][n + 1] = 3 * (ys[n] - ys[n - 1]) / ((xs[n] - xs[n - 1]) * (xs[n] - xs[n - 1]));

            return this.solve(A, ks);
        },

        solve: function(A, ks) {
            var m = A.length;
            for (var k = 0; k < m; k++) // column
            {
                // pivot for column
                var i_max = 0;
                var vali = Number.NEGATIVE_INFINITY;
                for (var i = k; i < m; i++)
                    if (A[i][k] > vali) {
                        i_max = i;
                        vali = A[i][k];
                    }
                this.splineSwapRows(A, k, i_max);

                // for all rows below pivot
                for (var i = k + 1; i < m; i++) {
                    for (var j = k + 1; j < m + 1; j++)
                        A[i][j] = A[i][j] - A[k][j] * (A[i][k] / A[k][k]);
                    A[i][k] = 0;
                }
            }
            for (var i = m - 1; i >= 0; i--) // rows = columns
            {
                var v = A[i][m] / A[i][i];
                ks[i] = v;
                for (var j = i - 1; j >= 0; j--) // rows
                {
                    A[j][m] -= A[j][i] * v;
                    A[j][i] = 0;
                }
            }
            return ks;
        },

        zerosMat: function(r, c) {
            var A = [];
            for (var i = 0; i < r; i++) {
                A.push([]);
                for (var j = 0; j < c; j++)
                    A[i].push(0);
            }
            return A;
        },

        splineSwapRows: function(m, k, l) {
            var p = m[k];
            m[k] = m[l];
            m[l] = p;
        }
    });

    window.ease = ease;

}
)();

/* file: src/Playground.js */

window.PLAYGROUND = {};

PLAYGROUND.MOBILE = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
PLAYGROUND.OSX = navigator.userAgent.indexOf('Mac OS X');

function playground(args) {

    return new PLAYGROUND.Application(args);

}
;
PLAYGROUND.data = {};
PLAYGROUND.images = {};
PLAYGROUND.atlases = {};

/* file: src/Utils.js */

PLAYGROUND.Utils = {

    extend: function() {

        for (var i = 1; i < arguments.length; i++) {

            for (var j in arguments[i]) {

                arguments[0][j] = arguments[i][j];

            }

        }

        return arguments[0];

    },

    defaults: function() {

        for (var i = 1; i < arguments.length; i++) {

            for (var j in arguments[i]) {

                if (typeof arguments[0][j] === "undefined")
                    arguments[0][j] = arguments[i][j];

            }

        }

        return arguments[0];

    },

    /* deep extend */

    merge: function(a) {

        for (var i = 1; i < arguments.length; i++) {

            var b = arguments[i];

            for (var key in b) {

                var value = b[key];

                if (typeof a[key] !== "undefined") {
                    if (typeof a[key] === "object")
                        this.merge(a[key], value);
                    else
                        a[key] = value;
                } else {
                    a[key] = value;
                }
            }
        }
        return a;

    },

    invoke: function(object, methodName) {

        var args = Array.prototype.slice.call(arguments, 2);

        for (var i = 0; i < object.length; i++) {
            var current = object[i];

            if (current[methodName])
                current[methodName].apply(current, args);

        }

    },

    throttle: function(fn, delay) {

        var timeout;
        var last = 0;

        return function() {

            var args = [];

            for (var i = 0; i < arguments.length; i++)
                args.push(arguments[i]);

            var context = this;

            if (Date.now() - last > delay) {

                last = Date.now();

                fn.apply(context, args);

                clearTimeout(timeout);

            } else {

                clearTimeout(timeout);

                timeout = setTimeout(function() {

                    fn.apply(context, args);

                    last = Date.now();

                }, Date.now() - last);

            }

        }
        ;

    },

    wrapTo: function(value, target, max, step) {
        if (value === target)
            return target;

        var result = value;

        var d = this.wrappedDistance(value, target, max);

        if (Math.abs(d) < step)
            return target;

        result += (d < 0 ? -1 : 1) * step;

        if (result > max) {
            result = result - max;
        } else if (result < 0) {
            result = max + result;
        }

        return result;
    },

    /** Bring the value between min and max.
   *
   * Values larger than `max` are wrapped back to `min`
   * and vice-versa.
   *
   * @param value value to process
   * @param min lowest valid value
   * @param max largest valid value
   * @return result
   */
    wrap: function(value, min, max) {

        if (value < min)
            return max + (value % max);
        if (value >= max)
            return value % max;
        return value;

    },

    /** Bring the value between 0 and 2*PI.
   *
   * Valid values for the length of a circle in radians is
   * 2*PI.
   *
   * @param val value to process
   * @return a value in 0..2*PI interval
   */
    circWrap: function(val) {

        return this.wrap(val, 0, Math.PI * 2);

    },

    /** Bring the value between 0 and 2*PI.
   *
   * Valid values for the length of a circle in radians is
   * 2*PI.
   *
   * @param val value to process
   * @return a value in 0..2*PI interval
   */
    circWrapTo: function(value, target, step) {

        return this.wrapTo(value, target, Math.PI * 2, step);

    },

    wrappedDistance: function(a, b, max) {

        if (a === b)
            return 0;
        else if (a < b) {
            var l = -a - max + b;
            var r = b - a;
        } else {
            var l = b - a;
            var r = max - a + b;
        }

        if (Math.abs(l) > Math.abs(r))
            return r;
        else
            return l;

    },

    circWrappedDistance: function(a, b) {

        return this.wrappedDistance(a, b, Math.PI * 2)

    },

    /** Compute first multiple of threshold that is smaller or equal to num.
   *
   * Valid values for the length of a circle in radians is
   * 2*PI.
   *
   * @param num the number to adjust
   * @param threshold reference value
   * @return an even multiple of `threshold` smaller or equal to `num`
   */
    ground: function(num, threshold) {

        return (num / threshold | 0) * threshold;

    },

    /** TBD
   *  Alias to `circWrappedDistance`.
   */
    circDistance: function(a, b) {

        return this.circWrappedDistance(a, b)

    },

    distance: function(x1, y1, x2, y2) {

        if (arguments.length > 2) {

            var dx = x1 - x2;
            var dy = y1 - y2;

            return Math.sqrt(dx * dx + dy * dy);

        } else {

            var dx = x1.x - y1.x;
            var dy = x1.y - y1.y;

            return Math.sqrt(dx * dx + dy * dy);

        }

    },

    sprintf: function(string, replace) {

        for (var key in replace) {

            var find = new RegExp("{" + key + "}","g");

            string = string.replace(find, replace[key]);

        }

        return string;

    },

    classInParents: function(element, className) {

        var parent = element;

        while (parent) {

            if (parent.classList.contains(className)) {

                return true;

            }

            parent = parent.parentElement;

        }

        return false;

    }

};

PLAYGROUND.Utils.ease = ease;

/* file: src/Events.js */

/** Base class for objects emmiting events.
 *
 * An associative array for listners is maintained internally.
 * The keys are the names of the event while the values are
 * lists of listners objects with three properties:
 * - once: is this a one time event or a recurring one
 * - callback: function to call
 * - context: the value for *this* inside *callback*.
 *
 * A special event is called `event`. The listners for
 * this event will receive all broadcasted events
 * with three arguments: `context`, `event name`, `data`.
 * Callbacks for other events are simply called with
 * `context` and `data`.
 */

PLAYGROUND.Events = function() {

    this.listeners = {};

}
;

PLAYGROUND.Events.prototype = {

    /** Add a listner for an event.
   *
   * @param event name of the event or an associative array
   *              where keys are event names and values are
   *              callbacks to use
   * @param callback the function to call for this listner; if
   *                 *event* is an object this parameter is ignored
   * @param context *this* when calling the callback(s)
   *
   * @returns the listner object
   */

    on: function(event, callback, context) {

        if (typeof event === "object") {
            var result = {};
            for (var key in event) {
                result[key] = this.on(key, event[key], context)
            }
            return result;
        }

        if (!this.listeners[event])
            this.listeners[event] = [];

        var listener = {
            once: false,
            callback: callback,
            context: context
        };

        this.listeners[event].push(listener);

        return listener;
    },

    /** Add a listner for an event.
   *
   * @param event name of the event or an associative array
   *              where keys are event names and values are
   *              callbacks to use
   * @param callback the function to call for this listner; if
   *                 *event* is an object this parameter is ignored
   * @param context *this* when calling the callback(s)
   *
   * @returns the listner object
   */

    once: function(event, callback, context) {

        if (typeof event === "object") {
            var result = {};
            for (var key in event) {
                result[key] = this.once(key, event[key], context)
            }
            return result;
        }

        if (!this.listeners[event])
            this.listeners[event] = [];

        var listener = {
            once: true,
            callback: callback,
            context: context
        };

        this.listeners[event].push(listener);

        return listener;
    },

    /** Remove an event listner from an event.
   *
   * The function will remove all occurences that use that particular
   * callback (will be a single instance in well behaved applications).
   *
   * @param event the name of the event
   * @param callback identifying the listner
   */

    off: function(event, callback) {

        for (var i = 0, len = this.listeners[event].length; i < len; i++) {

            if (this.listeners[event][i].callback === callback) {

                this.listeners[event].splice(i--, 1);
                len--;

            }

        }

    },

    /** Raise an event.
   *
   *  If the listner is only to be raised once this function
   * removes it from the list of listners.
   *
   * @param event the name of the event being raised
   * @param data array of arguments for the callbacks
   *
   */

    trigger: function(event, data) {

        /* if you prefer events pipe */

        if (this.listeners["event"]) {

            for (var i = 0, len = this.listeners["event"].length; i < len; i++) {

                var listener = this.listeners["event"][i];

                listener.callback.call(listener.context || this, event, data);

            }

        }

        /* or subscribed to a single event */

        if (this.listeners[event]) {

            for (var i = 0, len = this.listeners[event].length; i < len; i++) {

                var listener = this.listeners[event][i];

                listener.callback.call(listener.context || this, data);

                if (listener.once) {
                    this.listeners[event].splice(i--, 1);
                    len--;
                }

            }

        }

    }

};

/* file: src/States.js */

/** Manages the states the application can be in.
 *
 * A state can be an object or a function that
 * creates the object. Current state is in `current`.
 *
 * Properties of a state:
 * - __created: is managed by `step` function;
 *   if not found the state is set up and `create()`
 *   method of the state is called.
 * - locked: if current state has this set to `true`
 *   current state can't be changed
 * - app: the main application object
 * - create: if this function exists it is called
 *   the first time a state is encountered
 * - enter: if this function exists it is called
 *   when the state becomes current
 * - leave: if this function exists it is called
 *   when the state is no longer the current one
 *
 * Events generated by this object:
 * - createstate: first time an state is encountered
 * - enterstate: a state is entered
 * - leavestate: a state is no longer current
 *
 * Reference: http://playgroundjs.com/playground-states
 */

PLAYGROUND.States = function(app) {

    this.app = app;

    PLAYGROUND.Events.call(this);

    app.on("step", this.step.bind(this));

}
;

PLAYGROUND.States.prototype = {

    /** Called each frame to update logic. */

    step: function(delta) {

        if (!this.next)
            return;

        if (this.current && this.current.locked)
            return;

        var state = this.next;

        if (typeof state === "function")
            state = new state;

        /* create state if object has never been used as a state before */

        if (!state.__created) {

            state.__created = true;

            state.app = this.app;

            this.trigger("createstate", {
                state: state
            });

            if (state.create)
                state.create();

        }

        /* enter new state */

        if (this.current) {
            this.trigger("leavestate", {
                prev: this.current,
                next: state,
                state: this.current
            });
        }

        this.trigger("enterstate", {
            prev: this.current,
            next: state,
            state: state
        });

        this.current = state;

        if (this.current && this.current.enter) {
            this.current.enter();
        }

        this.app.state = this.current;

        this.next = false;

    },

    /** Used by application to set the state.
   *
   * Don't call this function directly. Instead, use
   * `PLAYGROUND.Application.setState()`.
   */

    set: function(state) {

        if (this.current && this.current.leave)
            this.current.leave();

        this.next = state;

        this.step(0);

    }

};

PLAYGROUND.Utils.extend(PLAYGROUND.States.prototype, PLAYGROUND.Events.prototype);

/* file: src/Application.js */

PLAYGROUND.Application = function(args) {

    var app = this;

    this.preventDefaults = true;
    this.killed = false;
    this.promises = {};

    this.dataSource = {};

    /* events */

    PLAYGROUND.Events.call(this);

    /* defaults */

    PLAYGROUND.Utils.merge(this, this.defaults, args);

    /* guess scaling mode */

    this.autoWidth = this.width ? false : true;
    this.autoHeight = this.height ? false : true;
    this.autoScale = this.scale ? false : true;

    /* get container */

    if (!this.container)
        this.container = document.body;

    if (this.container !== document.body)
        this.customContainer = true;

    if (typeof this.container === "string")
        this.container = document.querySelector(this.container);

    // if (args.background !== false) this.container.style.background = this.background;

    this.updateSize();

    /* events */

    // this.emitLocalEvent = this.emitLocalEvent.bind(this);
    // this.emitGlobalEvent = this.emitGlobalEvent.bind(this);

    /* states manager */

    this.states = new PLAYGROUND.States(this);
    this.states.on("event", this.emitLocalEvent, this);

    /* mouse */

    this.mouse = new PLAYGROUND.Mouse(this,this.container);
    this.mouse.on("event", this.emitGlobalEvent, this);

    /* touch */

    this.touch = new PLAYGROUND.Touch(this,this.container);
    this.touch.on("event", this.emitGlobalEvent, this);

    /* keyboard */

    this.keyboard = new PLAYGROUND.Keyboard(this);
    this.keyboard.on("event", this.emitGlobalEvent, this);

    /* gamepads */

    this.gamepads = new PLAYGROUND.Gamepads(this);
    this.gamepads.on("event", this.emitGlobalEvent, this);

    /* tweens */

    this.tweens = new PLAYGROUND.TweenManager(this);

    /* ease */

    this.ease = PLAYGROUND.Utils.ease;

    /* local storage event */

    window.addEventListener("storage", this.handleLocalStorage.bind(this));

    /* video recorder */

    // this.videoRecorder = new PLAYGROUND.VideoRecorder(this);

    /* sound */

    PLAYGROUND.Sound(this);

    /* visibility API */

    document.addEventListener("visibilitychange", function() {

        app.handleVisibilityChange(document.hidden);

    });

    window.addEventListener("blur", this.handleBlur.bind(this));
    window.addEventListener("focus", this.handleFocus.bind(this));

    /* window resize */

    this.resizelistener = PLAYGROUND.Utils.throttle(this.handleResize.bind(this), 100);

    window.addEventListener("resize", this.resizelistener);

    /* assets containers */

    this.images = PLAYGROUND.images;
    this.atlases = PLAYGROUND.atlases;
    this.data = PLAYGROUND.data;

    this.loader = new PLAYGROUND.Loader(this);

    this.loadFoo(0.25);

    /* create plugins in the same way */

    this.plugins = [];

    for (var key in PLAYGROUND) {

        var property = PLAYGROUND[key];

        if (property.plugin)
            this.plugins.push(new property(this));

    }

    /* flow */

    setTimeout(()=>{

        this.emitLocalEvent("preload");

        this.firstBatch = true;

        if (this.disabledUntilLoaded)
            this.skipEvents = true;

        function onPreloadEnd() {

            app.loadFoo(0.25);

            /* run everything in the next frame */

            setTimeout(function() {

                app.emitLocalEvent("create");

                app.setState(PLAYGROUND.DefaultState);
                app.handleResize();

                if (PLAYGROUND.LoadingScreen)
                    app.setState(PLAYGROUND.LoadingScreen);

                /* game loop */

                PLAYGROUND.GameLoop(app);

                /* stage proper loading step */

                app.loader.once("ready", function() {

                    app.firstBatch = false;

                    if (app.disabledUntilLoaded)
                        app.skipEvents = false;

                    app.setState(PLAYGROUND.DefaultState);

                    app.emitLocalEvent("ready");
                    app.handleResize();

                });

            });

        }
        ;
        this.loader.once("ready", onPreloadEnd);

    }
    , 100);

}
;

PLAYGROUND.Application.prototype = {

    defaults: {
        background: "#272822",
        smoothing: 1,
        paths: {
            base: "",
            images: "images/",
            fonts: "fonts/",
            rewrite: {},
            rewriteURL: {}
        },
        offsetX: 0,
        offsetY: 0,
        skipEvents: false,
        disabledUntilLoaded: true,
        mouseThrottling: 15
    },

    /**
        Change active state.
        Simply forwarded to PLAYGROUND.States.  

    */

    setState: function(state) {

        this.states.set(state);

    },

    /**

      Expand string "path/to/something" into objects path.to.something
      and insert the asset in the end

    */

    insertAsset: function(asset, collection, path=false) {

        var pathArray = path.split("/");
        var current = collection;

        for (var i = 0; i < pathArray.length - 1; i++) {

            var segment = pathArray[i];

            if (!current[segment])
                current[segment] = {};

            current = current[segment];

        }
        let last = pathArray.pop();

        current[last] = asset;

        collection[path] = asset;

    },

    /* Compute a fully qualified path.
     *
     * `paths.base` is always prepended to the result.
     *
     * @param to a key in `paths` or a string (without ending `/`).
     */

    getPath: function(to) {

        return this.paths.base + (this.paths[to] || (to + "/"));

    },

    /** Create a standardised representation for an asset.
     *
     * The result contains:
     *   - key: a unique string that identifies this resource
     *   - url: full path for this asset
     *   - path: the directory where the asset resides
     *   - ext: the extension for the file (without a leading dot)
     *
     * @returns a dictionary with standardised information
     */

    rewriteURL: function(url) {

        return this.paths.rewriteURL[url] || url;

    },

    getAssetEntry: function(path, folder, defaultExtension) {

        /* translate folder according to user provided paths
           or leave it as is */

        var key;
        var url;
        var absolute = false;

        if (path[0] === "<") {

            absolute = true;

            var abslimit = path.indexOf(">");

            url = path.substr(1, abslimit - 1);
            key = path.substr(abslimit + 1).trim();
            path = url;

            url = this.rewriteURL(url);

        }

        var folder = this.paths[folder] || (folder + "/");

        var fileinfo = path.match(/(.*)\..*/);

        if (!key)
            key = fileinfo ? fileinfo[1] : path;

        var temp = path.split(".");
        var basename = path;

        if (temp.length > 1) {

            var ext = temp.pop();
            path = temp.join(".");

        } else {

            var ext = defaultExtension;
            basename += "." + defaultExtension;

        }

        if (!url)
            url = this.rewriteURL(this.paths.base + folder + basename);

        /*
          key: key to store
          url: url to load
          path: url without extension.. pretty much useless?
          ext: extension
        */

        return {
            key: key,
            url: url,
            path: this.paths.base + folder + path,
            ext: ext
        };

    },

    /** Emits events that shouldn't flow down to the state. */

    emitLocalEvent: function(event, data) {

        this.trigger(event, data);

        if ((event !== "render" || !this.skipEvents || this.loader.ready) && this[event])
            this[event](data);

    },

    /** Emits events that should be passed to the state. */

    emitGlobalEvent: function(event, data) {

        if (!this.state)
            return this.emitLocalEvent(event, data);

        this.trigger(event, data);

        if ((event !== "render" || !this.skipEvents || this.loader.ready) && this.event)
            this.event(event, data);

        if ((event !== "render" || !this.skipEvents || this.loader.ready) && this[event])
            this[event](data);

        if (this.state.event)
            this.state.event(event, data);

        if (this.state[event])
            this.state[event](data);

        this.trigger("after" + event, data);

        // if (this.state.proxy) this.state.proxy(event, data);

    },

    /** Responds to a resize event by updating some internal variables.
     *
     * `offsetX`, `offsetY` and `center` are always updated.
     * `width`, `height` and `scale` may also be updated.
     */

    updateSize: function() {

        if (this.customContainer) {

            var containerWidth = this.container.offsetWidth;
            var containerHeight = this.container.offsetHeight;

        } else {

            var containerWidth = window.innerWidth;
            var containerHeight = window.innerHeight;

        }

        if (!this.autoScale && !this.autoWidth && !this.autoHeight) {
        } else if (!this.autoHeight && this.autoWidth) {

            if (this.autoScale)
                this.scale = containerHeight / this.height;

            this.width = Math.ceil(containerWidth / this.scale);

        } else if (!this.autoWidth && this.autoHeight) {

            if (this.autoScale)
                this.scale = containerWidth / this.width;

            this.height = Math.ceil(containerHeight / this.scale);

        } else if (this.autoWidth && this.autoHeight && this.autoScale) {

            this.scale = 1;
            this.width = containerWidth;
            this.height = containerHeight;

        } else if (this.autoWidth && this.autoHeight) {

            this.width = Math.ceil(containerWidth / this.scale);
            this.height = Math.ceil(containerHeight / this.scale);

        } else {

            this.scale = Math.min(containerWidth / this.width, containerHeight / this.height);

        }

        this.offsetX = (containerWidth - this.width * this.scale) / 2 | 0;
        this.offsetY = (containerHeight - this.height * this.scale) / 2 | 0;

        this.center = {
            x: this.width / 2 | 0,
            y: this.height / 2 | 0
        };

    },

    handleLocalStorage(e) {

        this.emitGlobalEvent("localstorage", e);

    },

    handleVisibilityChange: function(hidden) {

        this.emitGlobalEvent("visibilitychange", {
            visible: !hidden,
            hidden: hidden
        });

    },

    handleBlur: function(e) {

        this.emitGlobalEvent("blur", {});

    },

    handleFocus: function(e) {

        this.emitGlobalEvent("focus", {});

    },

    /** Responds to windows resize event. */

    handleResize: function() {

        this.updateSize();

        this.emitGlobalEvent("beforeresize", {});

        this.mouse.handleResize();
        this.touch.handleResize();

        this.emitGlobalEvent("resize", {});

    },

    /** Request a file over http.
     *
     * It shall be later an abstraction using 'fs' in node-webkit
     *
     * @returns a promise
     */

    request: function(url) {

        url = this.rewriteURL(url);

        var app = this;

        function promise(resolve, reject) {

            var baseurl = url.split("?")[0];

            if (app.dataSource[baseurl]) {

                return resolve({
                    responseText: app.dataSource[baseurl]
                });

            }

            var request = new XMLHttpRequest();

            request.open("GET", url, true);

            request.onload = function(event) {

                var xhr = event.target;

                if (xhr.status !== 200 && xhr.status !== 0) {

                    return reject(new Error("Failed to get " + url));

                }

                resolve(xhr);

            }

            request.send();

        }

        return new Promise(promise);

    },

    /** Imaginary timeout to delay loading. */

    loadFoo: function(timeout) {

        var loader = this.loader;

        this.loader.add("foo " + timeout);

        setTimeout(function() {

            loader.success("foo " + timeout);

        }, timeout * 1000);

    },

    /** Loads assets as data/json or text.
     *
     * The list may be nested.
     */

    xloadData: function() {

        for (var i = 0; i < arguments.length; i++) {

            var arg = arguments[i];

            if (typeof arg === "object") {

                for (var key in arg)
                    this.loadData(arg[key]);

            } else {

                this.loadDataItem(arg);

            }

        }

    },

    /** Loads one asset as data/json or text (internal). */

    loadData: function(name) {

        if (this.promises["data_" + name])
            return this.promises["data_name"];

        let resolve;
        let promise = new Promise((_resolve)=>{
            resolve = _resolve
        }
        );
        this.promises["data_" + name] = promise;

        var entry = this.getAssetEntry(name, "data", "json");

        var app = this;

        this.loader.add();

        this.request(entry.url + (this.purgeCache ? ("?" + Date.now()) : "")).then(processData);

        function processData(request) {

            // entry.ext === "json" && entry.key.indexOf("/") > -1;

            let result;

            if (entry.ext === "json") {

                try {

                    var data = JSON.parse(request.responseText);

                } catch (e) {

                    console.error("JSON file corrupt " + name);

                    return;

                }

                app.insertAsset(result = data, app.data, entry.key);

            } else {

                app.insertAsset(result = request.responseText, app.data, entry.key);

            }

            app.loader.success(entry.url);

            resolve(result);

        }

        return promise;

    },

    loadImage: function() {

        return this.loadImages.apply(this, arguments);

    },

    /*

      Loads images.
     
      The list may be nested.

    */

    loadImages: function() {

        var promises = [];

        for (var i = 0; i < arguments.length; i++) {

            var arg = arguments[i];

            /* polymorphism at its finest */

            if (typeof arg === "object") {

                for (var key in arg)
                    promises = promises.concat(this.loadImages(arg[key]));

            } else {

                promises.push(this.loadOneImage(arg));

            }

        }

        return Promise.all(promises);

    },

    /** Loads a single image (internal). */

    loadOneImage: function(name) {

        var app = this;

        if (!this._imageLoaders)
            this._imageLoaders = {};

        if (!this._imageLoaders[name]) {

            var promise = function(resolve, reject) {

                /* if argument is not an object/array let's try to load it */

                var loader = app.loader;

                var entry = app.getAssetEntry(name, "images", "png");

                app.loader.add(entry.url);

                var image = new Image;

                image.addEventListener("load", function() {

                    app.images[entry.key] = image;

                    resolve(image);
                    loader.success(entry.url);

                    entry.image = image;

                    app.insertAsset(image, app.images, entry.key);

                    app.emitLocalEvent("imageready", entry);

                });

                image.addEventListener("error", function() {

                    reject("can't load " + entry.url);
                    loader.error(entry.url);

                });

                image.src = entry.url;

            };

            app._imageLoaders[name] = new Promise(promise);

        }

        return this._imageLoaders[name];

    },

    /* 
      Load a single font.
     
      At this point it doesn't really load font
      it just ensures the font has been loaded (use css font-face)

    */

    loadFont: function() {

        var promises = [];

        for (var i = 0; i < arguments.length; i++) {

            var arg = arguments[i];

            promises.push(this.loadFontItem(arg));

        }

        return Promise.all(promises);

    },

    loadFonts: function() {

        return this.loadFont.apply(this, arguments);

    },

    /* 

      Load a single font (internal).  
      It actually doesn't load any font - just ensures it has been loaded (with css)

    */

    loadFontItem: function(name) {

        /* insert font into a stylesheet */

        if (!this.fontStyleSheet) {

            var style = document.createElement("style");

            document.head.appendChild(style);

            this.fontStyleSheet = style;

        }

        var entry = this.getAssetEntry(name, "fonts", "ttf");

        var format = {
            woff: "woff",
            otf: "opentype",
            ttf: "truetype"
        }[entry.ext];

        var raw = "@font-face { font-family: '{name}'; font-style: 'normal'; font-weight: 400, 800; src: url(fonts/{name}.{ext}) format('{format}'); }";

        var rule = PLAYGROUND.Utils.sprintf(raw, {
            name: name,
            ext: entry.ext,
            format: format
        });

        this.fontStyleSheet.innerHTML += rule;

        /* wait until font has been loaded */

        var app = this;

        if (!this._fontPromises)
            this._fontPromises = {};

        if (!this._fontPromises[name]) {

            var promise = function(resolve, reject) {

                app.loader.add("font " + name);

                var checkingTimer = setInterval(function() {

                    var base = cq(100, 32).font("14px somethingrandom").fillStyle("#fff").textBaseline("top");
                    base.context.fillText("lorem ipsum dolores sit", 0, 4);

                    var test = cq(100, 32).font("14px '" + name + "'").fillStyle("#fff").textBaseline("top");
                    test.context.fillText("lorem ipsum dolores sit", 0, 4);

                    if (!cq.compare(base, test)) {

                        app.loader.success("font" + name);

                        clearInterval(checkingTimer);

                        resolve();

                    }

                }, 100);

            }

            this._fontPromises[name] = new Promise(promise);

        }

        return this._fontPromises[name];

    },

    render: function() {},

    enableInputs: function() {

        this.mouse.enabled = true;
        this.touch.enabled = true;
        this.keyboard.enabled = true;

    },

    disableInputs: function() {

        this.mouse.enabled = false;
        this.touch.enabled = false;
        this.keyboard.enabled = false;

    },

    kill: function() {

        this.killed = true;

        this.trigger("kill");

        window.removeEventListener("resize", this.resizelistener);

    }

};

PLAYGROUND.Utils.extend(PLAYGROUND.Application.prototype, PLAYGROUND.Events.prototype);

/* file: src/GameLoop.js */

PLAYGROUND.GameLoop = function(app) {

    let fpses = [];
    let lastFPSIndex = 0;

    app.loop = {};

    app.lifetime = 0;
    app.ops = 0;
    app.opcost = 0;

    var lastTick = Date.now();
    var frame = 0;

    function render(dt) {

        app.emitGlobalEvent("prerender", dt)
        app.emitGlobalEvent("render", dt)
        app.emitGlobalEvent("postrender", dt)

    }
    ;
    function step(dt) {

        app.emitGlobalEvent("step", dt)

    }
    ;
    function gameLoop() {

        if (app.killed)
            return;

        requestAnimationFrame(gameLoop);

        if (app.frameskip) {
            frame++;
            if (frame === app.frameskip) {
                frame = 0;
            } else
                return;
        }

        var delta = Date.now() - lastTick;

        lastTick = Date.now();

        if (delta > 1000)
            return;

        var dt = delta / 1000;

        app.lifetime += dt;
        app.elapsed = dt;

        // app.emitLocalEvent("framestart", dt);

        step(dt);

        // app.emitLocalEvent("framemid", dt);

        render(dt);

        // app.emitLocalEvent("frameend", dt);

        app.opcost = delta / 1000;
        app.ops = 1000 / app.opcost;

        fpses[lastFPSIndex++ % 60] = 1 / dt;

        app.fps = 0;

        for (let fps of fpses)
            app.fps += fps;

        app.fps = app.fps / fpses.length | 0;

    }
    ;
    requestAnimationFrame(gameLoop);

    app.loop.loop = gameLoop;
    app.loop.step = step;
    app.loop.render = render;

}
;

/* file: src/Gamepads.js */

/* THIS HAS TO BE REWRITEN! */
/* add method .getGamepad() */
/* hold gamepad state in this[0], [1] and so on */
/* (dpad) buttons 12-14 are currently overwriten - check step method */

/** Gamepads related functionality.
 *
 * The object also works as an array of gamepads, thus
 * PLAYGROUND.Gamepads[0] is the first one.
 *
 * Properties:
 * - app: the main application object
 * - buttons: maps numeric ids to button names
 * - gamepads:
 * - gamepadmoveEvent: cached event
 * - gamepaddownEvent: cached event
 * - gamepadupEvent: cached event
 *
 * Events generated by this object:
 * - gamepadmove: change in position
 * - gamepaddown:
 * - gamepadup:
 *
 * Reference: http://playgroundjs.com/playground-gamepads
 */

PLAYGROUND.Gamepads = function(app) {

    this.app = app;

    PLAYGROUND.Events.call(this);

    this.getGamepads = navigator.getGamepads || navigator.webkitGetGamepads;

    this.gamepadmoveEvent = {};
    this.gamepaddownEvent = {};
    this.gamepadupEvent = {};
    this.gamepadholdEvent = {};

    this.gamepads = {};

    this.app.on("step", this.step.bind(this));

}
;

PLAYGROUND.Gamepads.prototype = {

    buttons: {
        0: "1",
        1: "2",
        2: "3",
        3: "4",
        4: "l1",
        5: "r1",
        6: "l2",
        7: "r2",
        8: "select",
        9: "start",
        10: "stick1",
        11: "stick2",
        12: "up",
        13: "down",
        14: "left",
        15: "right",
        16: "super"
    },

    zeroState: function() {

        var buttons = [];

        for (var i = 0; i <= 15; i++) {
            buttons.push({
                pressed: false,
                value: 0
            });
        }

        return {
            axes: [],
            buttons: buttons
        };

    },

    createGamepad: function() {

        var result = {
            buttons: {},
            sticks: [{
                x: 0,
                y: 0
            }, {
                x: 0,
                y: 0
            }]
        };

        for (var i = 0; i < 16; i++) {
            var key = this.buttons[i];
            result.buttons[key] = false;
        }

        return result;

    },

    step: function() {

        if (!navigator.getGamepads)
            return;

        var gamepads = navigator.getGamepads();

        for (var i = 0; i < gamepads.length; i++) {

            var current = gamepads[i];

            if (!current)
                continue;

            if (!this[i])
                this[i] = this.createGamepad();

            /* have to concat the current.buttons because the are read-only */

            var buttons = [].concat(current.buttons);

            /* hack for missing  dpads */
            /*
            for (var h = 12; h <= 15; h++) {

              // if (!buttons[h]) 

              buttons[h] = {
                pressed: false,
                value: 0
              };
            }
      */
            var previous = this[i];

            /* axes (sticks) to buttons */

            if (current.axes) {

                /*
                if (Math.abs(current.axes[0]) > 0.01) {
                  if (current.axes[0] < 0) buttons[14].pressed = true;
                  if (current.axes[0] > 0) buttons[15].pressed = true;
                }

                if (Math.abs(current.axes[1]) > 0.01) {
                  if (current.axes[1] < 0) buttons[12].pressed = true;
                  if (current.axes[1] > 0) buttons[13].pressed = true;
                }
                */

                var stickChanged = false;
                var stickA = false;
                var stickB = false;

                if (previous.sticks[0].x !== current.axes[0]) {

                    stickChanged = true;
                    stickA = true;

                }

                if (previous.sticks[0].y !== current.axes[1]) {

                    stickChanged = true;
                    stickA = true;

                }

                if (previous.sticks[1].x !== current.axes[2]) {

                    stickChanged = true;
                    stickB = true;

                }

                if (previous.sticks[1].y !== current.axes[3]) {

                    stickChanged = true;
                    stickB = true;

                }

                if (stickChanged) {

                    this.gamepadmoveEvent.old = [PLAYGROUND.Utils.extend({}, previous.sticks[0]), PLAYGROUND.Utils.extend({}, previous.sticks[1])];

                    previous.sticks[0].x = current.axes[0];
                    previous.sticks[0].y = current.axes[1];
                    previous.sticks[1].x = current.axes[2];
                    previous.sticks[1].y = current.axes[3];

                    this.gamepadmoveEvent.sticks = previous.sticks;
                    this.gamepadmoveEvent.gamepad = i;

                    if (stickA) {

                        this.gamepadmoveEvent.b = false;
                        this.gamepadmoveEvent.a = previous.sticks[0];
                        this.trigger("gamepadmove", this.gamepadmoveEvent);

                    }

                    if (stickB) {

                        this.gamepadmoveEvent.a = false;
                        this.gamepadmoveEvent.b = previous.sticks[1];
                        this.trigger("gamepadmove", this.gamepadmoveEvent);

                    }

                }

            }

            /* check buttons changes */

            for (var j = 0; j < buttons.length; j++) {

                var key = this.buttons[j];

                /* gamepad down */

                if (buttons[j].pressed && !previous.buttons[key]) {

                    previous.buttons[key] = true;
                    this.gamepaddownEvent.button = this.buttons[j];
                    this.gamepaddownEvent.gamepad = i;
                    this.trigger("gamepaddown", this.gamepaddownEvent);
                    this.trigger("keydown", {
                        key: "gamepad" + this.gamepaddownEvent.button,
                        gamepad: i
                    });

                }

                /* gamepad hold */

                if (buttons[j].pressed) {

                    this.gamepadholdEvent.button = this.buttons[j];
                    this.gamepadholdEvent.gamepad = i;
                    this.gamepadholdEvent.dt = this.app.elapsed;
                    this.trigger("gamepadhold", this.gamepadholdEvent);

                }
                /* gamepad up */
                else if (!buttons[j].pressed && previous.buttons[key]) {

                    previous.buttons[key] = false;
                    this.gamepadupEvent.button = this.buttons[j];
                    this.gamepadupEvent.gamepad = i;
                    this.trigger("gamepadup", this.gamepadupEvent);
                    this.trigger("keyup", {
                        key: "gamepad" + this.gamepadupEvent.button,
                        gamepad: i
                    });

                }

            }

        }

    }
};

PLAYGROUND.Utils.extend(PLAYGROUND.Gamepads.prototype, PLAYGROUND.Events.prototype);

/* file: src/Keyboard.js */

/** Keyboard related functionality.
 *
 * A key name is computed by either taking the ASCII representation or
 * using the `keycodes` array to assign a name. To get corresponding code
 * use `original.which` in event handler.
 *
 * Properties:
 * - keys: associative array that maps key names to either true or false
 *   if a key is not in this array it was never pressed
 * - preventDefault: stop event propagation
 * - bypassKeys: `preventDefault` will not act on these keys
 * - keydownEvent: caches information about last key down event
 *     - key: name of the key
 *     - original: original event
 * - keyupEvent: caches information about last key up event
 *     - key: name of the key
 *     - original: original event
 *
 * Events generated by this object:
 * - keydown: a key was pressed (handler receives `keydownEvent` object)
 * - keyup: a key was released (handler receives `keyupEvent` object)
 *
 * Reference: http://playgroundjs.com/playground-keyboard
 */

PLAYGROUND.Keyboard = function(app) {

    PLAYGROUND.Events.call(this);

    this.app = app;
    this.keys = {};
    this.timestamps = {};
    this.any = false;
    this.lastKey = -1;

    this.keydownlistener = this.keydown.bind(this);
    this.keyuplistener = this.keyup.bind(this);
    this.keypresslistener = this.keypress.bind(this);

    document.addEventListener("keydown", this.keydownlistener);
    document.addEventListener("keyup", this.keyuplistener);
    document.addEventListener("keypress", this.keypresslistener);

    this.keydownEvent = {};
    this.keyupEvent = {};
    this.keypressEvent = {};

    this.preventDefault = true;

    this.enabled = true;

    this.app.on("kill", this.kill.bind(this));
    this.app.on("blur", this.blur.bind(this));

    this.mapping = {};

    this.keyToCode = {};

    for (var code in this.keycodes)
        this.keyToCode[this.keycodes[code]] = code;

}
;

PLAYGROUND.Keyboard.prototype = {

    doubleTimeframe: 0.25,

    kill: function() {

        document.removeEventListener("keydown", this.keydownlistener);
        document.removeEventListener("keyup", this.keyuplistener);
        document.removeEventListener("keypress", this.keypresslistener);

    },

    keycodes: {
        37: "left",
        38: "up",
        39: "right",
        40: "down",
        45: "insert",
        46: "delete",
        8: "backspace",
        9: "tab",
        13: "enter",
        16: "shift",
        17: "ctrl",
        18: "alt",
        19: "pause",
        20: "capslock",
        27: "escape",
        32: "space",
        33: "pageup",
        34: "pagedown",
        35: "end",
        36: "home",
        96: "numpad0",
        97: "numpad1",
        98: "numpad2",
        99: "numpad3",
        100: "numpad4",
        101: "numpad5",
        102: "numpad6",
        103: "numpad7",
        104: "numpad8",
        105: "numpad9",
        106: "numpadmul",
        107: "numpadadd",
        109: "numpadsub",
        110: "numpaddec",
        111: "numpaddiv",
        112: "f1",
        113: "f2",
        114: "f3",
        115: "f4",
        116: "f5",
        117: "f6",
        118: "f7",
        119: "f8",
        120: "f9",
        121: "f10",
        122: "f11",
        123: "f12",
        144: "numlock",
        145: "scrolllock",
        186: "semicolon",
        187: "equal",
        188: "comma",
        189: "dash",
        190: "period",
        191: "slash",
        192: "graveaccent",
        219: "openbracket",
        220: "backslash",
        221: "closebracket",
        222: "singlequote"
    },

    bypassKeys: ["f12", "f11", "f5", "ctrl", "alt", "shift"],

    keydown: function(e) {

        if (!this.enabled)
            return;

        if (e.which >= 48 && e.which <= 90)
            var keyName = String.fromCharCode(e.which).toLowerCase();
        else
            var keyName = this.keycodes[e.which];

        if (this.mapping[keyName])
            keyName = this.mapping[keyName];

        if (this.keys[keyName])
            return;

        this.any++;

        this.keydownEvent.key = keyName;
        this.keydownEvent.original = e;

        this.keys[keyName] = true;

        if (keyName === this.lastKey && Date.now() - this.timestamps[keyName] < this.doubleTimeframe * 1000) {

            this.timestamps[keyName] = Date.now() - this.doubleTimeframe;
            this.keydownEvent.double = true;

        } else {

            this.timestamps[keyName] = Date.now();
            this.keydownEvent.double = false;

        }

        this.trigger("keydown", this.keydownEvent);

        if (this.preventDefault && document.activeElement === document.body) {

            var bypass = e.metaKey;

            if (!bypass) {

                for (var i = 0; i < this.bypassKeys.length; i++) {

                    if (this.keys[this.bypassKeys[i]]) {
                        bypass = true;
                        break
                    }

                }

            }

            if (!bypass) {
                // e.returnValue = false;
                // e.keyCode = 0;
                e.preventDefault();
                e.stopPropagation();
            }

        }

        this.lastKey = keyName;

    },

    keyup: function(e) {

        if (!this.enabled)
            return;

        if (e.which >= 48 && e.which <= 90)
            var keyName = String.fromCharCode(e.which).toLowerCase();
        else
            var keyName = this.keycodes[e.which];

        if (this.mapping[keyName])
            keyName = this.mapping[keyName];

        this.any--;

        this.keyupEvent.key = keyName;
        this.keyupEvent.original = e;

        this.keys[keyName] = false;

        this.trigger("keyup", this.keyupEvent);

    },

    keypress: function(e) {

        if (!this.enabled)
            return;

        if (e.which >= 48 && e.which <= 90)
            var keyName = String.fromCharCode(e.which).toLowerCase();
        else
            var keyName = this.keycodes[e.which];

        if (this.mapping[keyName])
            keyName = this.mapping[keyName];

        this.keypressEvent.key = keyName;
        this.keypressEvent.original = e;

        this.trigger("keypress", this.keypressEvent);

    },

    blur: function(e) {

        for (var key in this.keys) {

            var state = this.keys[key];

            if (!state)
                continue;

            this.keyup({
                which: this.keyToCode[key]
            });

        }

    }

};

PLAYGROUND.Utils.extend(PLAYGROUND.Keyboard.prototype, PLAYGROUND.Events.prototype);

/* file: src/Pointer.js */

/** Abstracts away differences between mouse and touches.
 *
 * The object simply listens to global events raised by application and
 * raises new (global) events on behalf of the application.
 *
 * Following events are raised:
 * - pointerdown:mouse button down or start tracking touch point
 * - pointerup: mouse button release or touch point release
 * - pointermove: mouse pointer or touch point moved
 * - pointerwheel: mouse wheel rotated
 *
 * Reference: http://playgroundjs.com/playground-pointer
 */

PLAYGROUND.Pointer = function(app) {

    this.app = app;

    this.x = 0;
    this.y = 0;

    app.on("touchstart", this.touchstart, this);
    app.on("touchend", this.touchend, this);
    app.on("touchmove", this.touchmove, this);

    app.on("mousemove", this.mousemove, this);
    app.on("mousedown", this.mousedown, this);
    app.on("mouseup", this.mouseup, this);
    app.on("mousewheel", this.mousewheel, this);

    this.pointers = app.pointers = {};

    this.app.pointer = this;

    this.lastTap = 0;

}
;

PLAYGROUND.Pointer.plugin = true;

PLAYGROUND.Pointer.prototype = {

    updatePointer: function(e) {

        if (!this.pointers[e.id])
            this.pointers[e.id] = {};

        var pointer = this.pointers[e.id];

        pointer.x = e.x;
        pointer.y = e.y;
        // pointer.touch = e.touch;
        // pointer.mouse = e.mouse;    
        pointer.id = e.id;

        return pointer;

    },

    removePointer: function(e) {

        delete this.pointers[e.id];

    },

    touchstart: function(e) {

        e.touch = true;

        this.updatePointer(e);

        this.x = this.app.touch.x;
        this.y = this.app.touch.y;

        this.pointerdown(e);

        this.app.emitGlobalEvent("pointerdown", e);

    },

    touchend: function(e) {

        e.touch = true;

        this.pointerup(e);

        this.removePointer(e);

        this.app.emitGlobalEvent("pointerup", e);

    },

    touchmove: function(e) {

        e.touch = true;

        this.updatePointer(e);

        this.pointermove(e);

        this.x = this.app.touch.x;
        this.y = this.app.touch.y;

        this.app.emitGlobalEvent("pointermove", e);

    },

    mousemove: function(e) {

        e.mouse = true;

        this.updatePointer(e);

        this.pointermove(e);

        this.x = this.app.mouse.x;
        this.y = this.app.mouse.y;

        this.app.emitGlobalEvent("pointermove", e);

    },

    mousedown: function(e) {

        e.mouse = true;

        this.pressed = true;

        this.updatePointer(e);

        this.app.emitGlobalEvent("pointerdown", e);

        this.pointerdown(e);

    },

    mouseup: function(e) {

        e.mouse = true;

        this.pressed = false;

        this.pointerup(e);

        this.app.emitGlobalEvent("pointerup", e);

    },

    mousewheel: function(e) {

        e.mouse = true;

        this.app.emitGlobalEvent("pointerwheel", e);

    },

    pointerdown: function(e) {

        var pointer = this.pointers[e.id];

        e.double = false

        pointer.pressed = true;

        this.pressed = true;

        var timeFrame = this.app.lifetime - this.lastTap;

        this.lastTap = this.app.lifetime;

        if (timeFrame < 0.4 && this.lastTapPosition && PLAYGROUND.Utils.distance(e, this.lastTapPosition) < 5) {

            this.app.emitGlobalEvent("pointerdoubletap", pointer);

            e.double = true;

            this.lastTap = 0;

        }

        this.lastTapPosition = {
            x: e.x,
            y: e.y
        };

    },

    pointermove: function(e) {

        var pointer = this.pointers[e.id];

        /*
        if (!pointer.dragging && pointer.pressed && PLAYGROUND.Utils.distance(pointer.tapPosition, e) > 5) {

          pointer.dragging = true;

        }
        */

        e.dragging = pointer.dragging;

    },

    pointerup: function(e) {

        var pointer = this.pointers[e.id];

        pointer.pressed = false;
        pointer.dragging = false;
        this.pressed = false;

    }

};

/* file: src/Loader.js */

/** Resources loading.
 *
 * This object - despite its name - does not load anything. Instead, it
 * acts as a central hub for reporting and tracking the progress of
 * resource loading. Each load element is given an unique id by the caller
 * and that id is used when events are raised.
 *
 * Properties:
 * - app: the main application object
 * - queue: number of elements to be loaded
 * - count: total number of elements (loading and loaded)
 * - ready: true if all requested elements were retrieved
 * - progress: [0..1] fraction of resources loaded so far
 *     - id, identifier: event id for compatibility with touches
 *     - x, y: the absolute position in pixels
 *     - original: original event
 *     - mozMovementX, mozMovementY: change in position from previous event
 * - mousedownEvent and mouseupEvent: last button press or release event
 *     - id, identifier: event id for compatibility with touches
 *     - x, y: the absolute position in pixels
 *     - original: original event
 *     - button: one of `left`, `middle`, `right`
 * - x, y: alias for mousemoveEvent.x, .y
 *
 * Events generated by this object (PLAYGROUND.Application.mouseToTouch
 * decides the variant to trigger):
 * - add: an element was added to the queue
 * - load: an element was successfully loaded
 * - error: an element could not be loaded
 * - ready: *all* elements were successfully loaded; this *is not* triggered
 *   if any element reported an error.
 */

PLAYGROUND.Loader = function(app) {

    this.app = app;

    PLAYGROUND.Events.call(this);

    this.reset();

}
;

PLAYGROUND.Loader.prototype = {

    /** Start retreiving an element */

    add: function(id) {

        this.queue++;
        this.count++;
        this.ready = false;
        this.trigger("add", id);

        return id;

    },

    /** Report an error to the loader. */

    error: function(id) {

        this.trigger("error", id);

    },

    /** Report a success to the loader. */

    success: function(id) {

        this.queue--;

        this.progress = 1 - this.queue / this.count;

        this.trigger("progress", this.progress);

        this.trigger("load", id);

        if (this.queue <= 0) {
            this.reset();
            this.trigger("ready");
        }

    },

    /** Bring loader back to the ground state */

    reset: function() {

        this.progress = 0;
        this.queue = 0;
        this.count = 0;
        this.ready = true;

    }
};

PLAYGROUND.Utils.extend(PLAYGROUND.Loader.prototype, PLAYGROUND.Events.prototype);

/* file: src/Mouse.js */

PLAYGROUND.Mouse = function(app, element) {

    var self = this;

    this.app = app;

    PLAYGROUND.Events.call(this);

    this.element = element;

    this.preventContextMenu = true;

    this.enabled = true;
    this.releaseButtonsWhenOffscreen = true;

    this.mousemoveEvent = {};
    this.mousedownEvent = {};
    this.mouseupEvent = {};
    this.mousewheelEvent = {};

    this.x = 0;
    this.y = 0;

    if (app.mouseThrottling) {

        this.mousemove = PLAYGROUND.Utils.throttle(this.mousemove, app.mouseThrottling);

    }

    this.mousemovelistener = this.mousemove.bind(this);
    this.mousedownlistener = this.mousedown.bind(this);
    this.mouseuplistener = this.mouseup.bind(this);
    this.mouseoutlistener = this.mouseout.bind(this);

    this.contextmenulistener = function(e) {

        if (self.preventContextMenu && !e.metaKey) {

            e.preventDefault();

        }

    }
    ;

    element.addEventListener("mousemove", this.mousemovelistener);
    element.addEventListener("mousedown", this.mousedownlistener);
    element.addEventListener("mouseup", this.mouseuplistener);
    element.addEventListener("mouseout", this.mouseoutlistener);
    element.addEventListener("contextmenu", this.contextmenulistener);

    this.app.on("kill", this.kill.bind(this));

    this.enableMousewheel();

    element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;

    document.exitPointerLock = document.exitPointerLock || document.mozExitPointerLock || document.webkitExitPointerLock;

    this.handleResize();

}
;

PLAYGROUND.Mouse.prototype = {

    kill: function() {

        this.element.removeEventListener("mousemove", this.mousemovelistener);
        this.element.removeEventListener("mousedown", this.mousedownlistener);
        this.element.removeEventListener("mouseup", this.mouseuplistener);
        this.element.removeEventListener("mouseout", this.mouseoutlistener);
        this.element.removeEventListener("contextmenu", this.contextmenulistener);

    },

    mouseout: function(button) {

        if (!this.releaseButtonsWhenOffscreen)
            return;

        for (var i = 0; i < 3; i++) {

            this.mouseup({
                button: i
            });

        }

    },

    lock: function() {

        this.locked = true;
        this.element.requestPointerLock();

    },

    unlock: function() {

        this.locked = false;
        document.exitPointerLock();

    },

    getElementOffset: function(element) {

        var offsetX = 0;
        var offsetY = 0;

        do {

            offsetX += element.offsetLeft;
            offsetY += element.offsetTop;

        }
        while ((element = element.offsetParent));

        return {
            x: offsetX,
            y: offsetY
        };

    },

    handleResize: function() {

        this.elementOffset = this.getElementOffset(this.element);

    },

    mousemove: function(e) {

        if (!this.enabled)
            return;

        this.x = this.mousemoveEvent.x = (e.pageX - this.elementOffset.x - this.app.offsetX) / this.app.scale | 0;
        this.y = this.mousemoveEvent.y = (e.pageY - this.elementOffset.y - this.app.offsetY) / this.app.scale | 0;

        this.mousemoveEvent.original = e;

        if (this.locked) {

            this.mousemoveEvent.movementX = e.movementX || e.mozMovementX || e.webkitMovementX || 0;

            this.mousemoveEvent.movementY = e.movementY || e.mozMovementY || e.webkitMovementY || 0;
        }

        if (this.app.mouseToTouch) {
            //      if (this.left) {
            this.mousemoveEvent.id = this.mousemoveEvent.identifier = 255;
            this.trigger("touchmove", this.mousemoveEvent);
            //      }
        } else {
            this.mousemoveEvent.id = this.mousemoveEvent.identifier = 255;
            this.trigger("mousemove", this.mousemoveEvent);
        }

    },

    mousedown: function(e) {

        if (!this.enabled)
            return;

        var buttonName = ["left", "middle", "right"][e.button];

        this.mousedownEvent.x = this.mousemoveEvent.x;
        this.mousedownEvent.y = this.mousemoveEvent.y;
        this.mousedownEvent.button = buttonName;
        this.mousedownEvent.original = e;

        this[buttonName] = true;

        this.mousedownEvent.id = this.mousedownEvent.identifier = 255;

        if (this.app.mouseToTouch) {
            this.trigger("touchmove", this.mousedownEvent);
            this.trigger("touchstart", this.mousedownEvent);
        } else {
            this.trigger("mousedown", this.mousedownEvent);
        }

        this.trigger("keydown", {
            key: "mouse" + buttonName
        });

    },

    mouseup: function(e) {

        if (!this.enabled)
            return;

        var buttonName = ["left", "middle", "right"][e.button];

        if (!this[buttonName])
            return;

        this.mouseupEvent.x = this.mousemoveEvent.x;
        this.mouseupEvent.y = this.mousemoveEvent.y;
        this.mouseupEvent.button = buttonName;
        this.mouseupEvent.original = e;

        this.mouseupEvent.id = this.mouseupEvent.identifier = 255;

        if (this.app.mouseToTouch) {

            this.trigger("touchend", this.mouseupEvent);

        } else {

            this.trigger("mouseup", this.mouseupEvent);

        }

        this.trigger("keyup", {

            key: "mouse" + buttonName

        });

        this[buttonName] = false;

    },

    mousewheel: function(e) {

        this.mousewheelEvent.x = this.mousemoveEvent.x;
        this.mousewheelEvent.y = this.mousemoveEvent.y;
        this.mousewheelEvent.button = ["none", "left", "middle", "right"][e.button];
        this.mousewheelEvent.original = e;
        this.mousewheelEvent.id = this.mousewheelEvent.identifier = 255;

        this[e.button] = false;

        this.trigger("mousewheel", this.mousewheelEvent);

        this.trigger("keydown", {
            key: e.delta > 0 ? "mousewheelup" : "mousewheeldown"
        });

    },

    enableMousewheel: function() {

        var eventNames = 'onwheel'in document || document.documentMode >= 9 ? ['wheel'] : ['mousewheel', 'DomMouseScroll', 'MozMousePixelScroll'];
        var callback = this.mousewheel.bind(this);
        var self = this;

        var throttled = PLAYGROUND.Utils.throttle(function(event) {

            var orgEvent = event || window.event, args = [].slice.call(arguments, 1), delta = 0, deltaX = 0, deltaY = 0, absDelta = 0, absDeltaXY = 0, fn;

            // orgEvent.type = "mousewheel";

            // Old school scrollwheel delta
            if (orgEvent.wheelDelta) {
                delta = orgEvent.wheelDelta;
            }

            if (orgEvent.detail) {
                delta = orgEvent.detail * -1;
            }

            // New school wheel delta (wheel event)
            if (orgEvent.deltaY) {
                deltaY = orgEvent.deltaY * -1;
                delta = deltaY;
            }

            // Webkit
            if (orgEvent.wheelDeltaY !== undefined) {
                deltaY = orgEvent.wheelDeltaY;
            }

            var result = delta ? delta : deltaY;

            self.mousewheelEvent.x = self.mousemoveEvent.x;
            self.mousewheelEvent.y = self.mousemoveEvent.y;
            self.mousewheelEvent.delta = result / Math.abs(result);
            self.mousewheelEvent.original = orgEvent;

            callback(self.mousewheelEvent);

            orgEvent.preventDefault();

        }, 40);

        for (var i = eventNames.length; i; ) {

            self.element.addEventListener(eventNames[--i], function(event) {

                throttled(event);

                var prevent = self.app.preventDefaults && !PLAYGROUND.Utils.classInParents(event.target, "scroll");

                if (prevent) {

                    event.preventDefault();
                    event.stopPropagation();

                }

            }, false);
            /*
            self.element.addEventListener(eventNames[--i], function(event) {

              e.preventDefault();
              e.stopPropagation();

            });
            */

        }

    }

};

PLAYGROUND.Utils.extend(PLAYGROUND.Mouse.prototype, PLAYGROUND.Events.prototype);

/* file: src/Sound.js */

/** Factory that creates sound related objects in application.
 *
 * The back-end is either PLAYGROUND.SoundWebAudioAPI or PLAYGROUND.SoundAudio.
 *
 * The application object will have tow (identical) objects inserted:
 * `sound` and `music`.
 */
PLAYGROUND.Sound = function(app) {

    var audioContext = window.AudioContext || window.webkitAudioContext || window.mozAudioContext;

    if (audioContext && !app.forceAudioFallback) {

        if (!PLAYGROUND.audioContext)
            PLAYGROUND.audioContext = new audioContext;

        app.audioContext = PLAYGROUND.audioContext;
        app.sound = new PLAYGROUND.SoundWebAudioAPI(app,app.audioContext);
        app.music = new PLAYGROUND.SoundWebAudioAPI(app,app.audioContext);

    } else {

        app.sound = new PLAYGROUND.SoundAudio(app);
        app.music = new PLAYGROUND.SoundAudio(app);

    }

}
;

/** Play a sound */
PLAYGROUND.Application.prototype.playSound = function(key, loop) {

    return this.sound.play(key, loop);

}
;

/** Stop a sound from playing */
PLAYGROUND.Application.prototype.stopSound = function(sound) {

    this.sound.stop(sound);

}
;

/** Load the sound */
PLAYGROUND.Application.prototype.loadSound = function() {

    return this.loadSounds.apply(this, arguments);

}
;

/** Load multiple sounds */
PLAYGROUND.Application.prototype.loadSounds = function() {

    for (var i = 0; i < arguments.length; i++) {

        var arg = arguments[i];

        /* polymorphism at its finest */

        if (typeof arg === "object") {

            for (var key in arg)
                this.loadSounds(arg[key]);

        } else {
            this.sound.load(arg);
        }
    }

}
;

/* file: src/SoundWebAudioAPI.js */

/* Stereo panner SHIM */

(function e(t, n, r) {
    function s(o, u) {
        if (!n[o]) {
            if (!t[o]) {
                var a = typeof require == "function" && require;
                if (!u && a)
                    return a(o, !0);
                if (i)
                    return i(o, !0);
                var f = new Error("Cannot find module '" + o + "'");
                throw f.code = "MODULE_NOT_FOUND",
                f
            }
            var l = n[o] = {
                exports: {}
            };
            t[o][0].call(l.exports, function(e) {
                var n = t[o][1][e];
                return s(n ? n : e)
            }, l, l.exports, e, t, n, r)
        }
        return n[o].exports
    }
    var i = typeof require == "function" && require;
    for (var o = 0; o < r.length; o++)
        s(r[o]);
    return s
}
)({
    1: [function(require, module, exports) {
        (function(global) {
            "use strict";
            var AudioContext = global.AudioContext || global.webkitAudioContext;
            var StereoPannerNode = require("stereo-panner-node");
            if (AudioContext && !AudioContext.prototype.createStereoPanner) {
                AudioContext.prototype.createStereoPanner = function() {
                    return new StereoPannerNode(this)
                }
            }
        }
        ).call(this, typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
    }
    , {
        "stereo-panner-node": 4
    }],
    2: [function(require, module, exports) {
        "use strict";
        var WS_CURVE_SIZE = 4096;
        var curveL = new Float32Array(WS_CURVE_SIZE);
        var curveR = new Float32Array(WS_CURVE_SIZE);
        (function() {
            for (var i = 0; i < WS_CURVE_SIZE; i++) {
                curveL[i] = Math.cos(i / WS_CURVE_SIZE * Math.PI * .5);
                curveR[i] = Math.sin(i / WS_CURVE_SIZE * Math.PI * .5)
            }
        }
        )();
        module.exports = {
            L: curveL,
            R: curveR
        }
    }
    , {}],
    3: [function(require, module, exports) {
        (function(global) {
            "use strict";
            var curve = require("./curve");

            function StereoPannerImpl(audioContext) {
                this.audioContext = audioContext;
                this.inlet = audioContext.createChannelSplitter(2);
                this._pan = audioContext.createGain();
                this.pan = this._pan.gain;
                this._wsL = audioContext.createWaveShaper();
                this._wsR = audioContext.createWaveShaper();
                this._L = audioContext.createGain();
                this._R = audioContext.createGain();
                this.outlet = audioContext.createChannelMerger(2);
                this.inlet.channelCount = 2;
                this.inlet.channelCountMode = "explicit";
                this._pan.gain.value = 0;
                this._wsL.curve = curve.L;
                this._wsR.curve = curve.R;
                this._L.gain.value = 0;
                this._R.gain.value = 0;
                this.inlet.connect(this._L, 0);
                this.inlet.connect(this._R, 1);
                this._L.connect(this.outlet, 0, 0);
                this._R.connect(this.outlet, 0, 1);
                this._pan.connect(this._wsL);
                this._pan.connect(this._wsR);
                this._wsL.connect(this._L.gain);
                this._wsR.connect(this._R.gain);
                this._isConnected = false;
                this._dc1buffer = null;
                this._dc1 = null
            }
            StereoPannerImpl.prototype.connect = function(destination) {
                var audioContext = this.audioContext;
                if (!this._isConnected) {
                    this._isConnected = true;
                    this._dc1buffer = audioContext.createBuffer(1, 2, audioContext.sampleRate);
                    this._dc1buffer.getChannelData(0).set([1, 1]);
                    this._dc1 = audioContext.createBufferSource();
                    this._dc1.buffer = this._dc1buffer;
                    this._dc1.loop = true;
                    this._dc1.start(audioContext.currentTime);
                    this._dc1.connect(this._pan)
                }
                global.AudioNode.prototype.connect.call(this.outlet, destination)
            }
            ;
            StereoPannerImpl.prototype.disconnect = function() {
                var audioContext = this.audioContext;
                if (this._isConnected) {
                    this._isConnected = false;
                    this._dc1.stop(audioContext.currentTime);
                    this._dc1.disconnect();
                    this._dc1 = null;
                    this._dc1buffer = null
                }
                global.AudioNode.prototype.disconnect.call(this.outlet)
            }
            ;
            module.exports = StereoPannerImpl
        }
        ).call(this, typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
    }
    , {
        "./curve": 2
    }],
    4: [function(require, module, exports) {
        "use strict";
        var StereoPannerImpl = require("./stereo-panner-impl");

        function StereoPanner(audioContext) {
            var impl = new StereoPannerImpl(audioContext);
            Object.defineProperties(impl.inlet, {
                pan: {
                    value: impl.pan,
                    enumerable: true
                },
                connect: {
                    value: function(node) {
                        return impl.connect(node)
                    }
                },
                disconnect: {
                    value: function() {
                        return impl.disconnect()
                    }
                }
            });
            return impl.inlet
        }
        module.exports = StereoPanner
    }
    , {
        "./stereo-panner-impl": 3
    }]
}, {}, [1]);

/** Sound back-end using Web Audio API
 *
 * Reference: https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API
 */

PLAYGROUND.SoundWebAudioAPI = function(app, audioContext) {

    this.app = app;

    var canPlayMp3 = (new Audio).canPlayType("audio/mp3");
    var canPlayOgg = (new Audio).canPlayType('audio/ogg; codecs="vorbis"');

    if (this.app.preferedAudioFormat === "mp3") {

        if (canPlayMp3)
            this.audioFormat = "mp3";
        else
            this.audioFormat = "ogg";

    } else {

        if (canPlayOgg)
            this.audioFormat = "ogg";
        else
            this.audioFormat = "mp3";

    }

    this.context = audioContext;

    this.gainNode = this.context.createGain()
    this.gainNode.connect(this.context.destination);

    this.compressor = this.context.createDynamicsCompressor();
    this.compressor.connect(this.gainNode);

    this.output = this.compressor;

    this.gainNode.gain.value = 1.0;

    this.pool = [];
    this.volume = 1.0;

    this.loops = [];

    this.app.on("step", this.step.bind(this));

}
;

PLAYGROUND.SoundWebAudioAPI.prototype = {

    buffers: {},
    aliases: {},

    alias: function(alias, source, volume, rate) {

        this.aliases[alias] = {
            source: source,
            volume: volume,
            rate: rate
        };

    },

    setMaster: function(volume) {

        this.volume = volume;

        this.gainNode.gain.value = volume;

    },

    load: function(file) {

        var entry = this.app.getAssetEntry(file, "sounds", this.audioFormat);

        var sampler = this;

        var request = new XMLHttpRequest();

        request.open("GET", entry.url, true);
        request.responseType = "arraybuffer";

        var id = this.app.loader.add(entry.url);

        request.onload = function() {

            sampler.context.decodeAudioData(this.response, function(decodedBuffer) {
                sampler.buffers[entry.key] = decodedBuffer;
                sampler.app.loader.success(entry.url);
            });

        }

        request.send();

    },

    cleanArray: function(array, property) {
        for (var i = 0, len = array.length; i < len; i++) {
            if (array[i] === null || (property && array[i][property])) {
                array.splice(i--, 1);
                len--;
            }
        }
    },

    getSoundBuffer: function() {

        if (!this.pool.length) {
            for (var i = 0; i < 100; i++) {

                var buffer, gain, panner;

                var nodes = [buffer = this.context.createBufferSource(), gain = this.context.createGain(), panner = this.context.createStereoPanner()];

                this.pool.push(nodes);

                if (!PLAYGROUND.MOBILE) {

                    nodes[0].connect(nodes[1]);
                    nodes[1].connect(nodes[2]);
                    nodes[2].connect(this.output);

                } else {

                    nodes[0].connect(nodes[1]);
                    nodes[1].connect(this.gainNode);

                }

            }
        }

        return this.pool.pop();
    },

    play: function(name, loop) {

        var alias = this.aliases[name];

        var nodes = this.getSoundBuffer();

        if (alias)
            name = alias.source;

        bufferSource = nodes[0];
        bufferSource.gainNode = nodes[1];
        bufferSource.pannerNode = nodes[2];
        bufferSource.buffer = this.buffers[name];
        bufferSource.loop = loop || false;
        bufferSource.key = name;

        bufferSource.alias = alias;

        this.setVolume(bufferSource, 1.0);
        this.setPlaybackRate(bufferSource, 1.0);

        if (this.loop) {//  bufferSource.loopStart = this.loopStart;
        // bufferSource.loopEnd = this.loopEnd;
        }

        bufferSource.start(0);

        bufferSource.volumeLimit = 1;

        return bufferSource;
    },

    stop: function(what) {

        if (!what)
            return;

        what.stop(0);

    },

    setPlaybackRate: function(sound, rate) {

        if (!sound)
            return;

        if (sound.alias)
            rate *= sound.alias.rate;

        return sound.playbackRate.value = rate;
    },

    getVolume: function(sound) {

        if (!sound)
            return;

        return sound.gainNode.gain.value;

    },

    setVolume: function(sound, volume) {

        if (!sound)
            return;

        if (sound.alias)
            volume *= sound.alias.volume;

        return sound.gainNode.gain.value = Math.max(0, volume);
    },

    setPanning: function(sound, pan) {

        sound.pannerNode.pan.value = pan;

    },

    getPanning: function(sound) {

        return sound.pannerNode.pan.value;

    },

    fadeOut: function(sound) {

        if (!sound)
            return;

        sound.fadeOut = true;

        this.loops.push(sound);

        return sound;

    },

    fadeIn: function(sound) {

        if (!sound)
            return;

        sound.fadeIn = true;

        this.loops.push(sound);
        this.setVolume(sound, 0);

        return sound;

    },

    step: function(delta) {

        for (var i = 0; i < this.loops.length; i++) {

            var loop = this.loops[i];

            if (loop.fadeIn) {
                var volume = this.getVolume(loop);
                volume = this.setVolume(loop, Math.min(1.0, volume + delta * 0.5));

                if (volume >= 1.0) {
                    this.loops.splice(i--, 1);
                }
            }

            if (loop.fadeOut) {
                var volume = this.getVolume(loop);
                volume = this.setVolume(loop, Math.min(1.0, volume - delta * 0.5));

                if (volume <= 0) {
                    this.loops.splice(i--, 1);
                    this.stop(loop);
                }
            }

        }

    }

};

/* file: src/SoundAudio.js */

/** Sound back-end using HTML DOM Audio object.
 *
 */
PLAYGROUND.SoundAudio = function(app) {

    this.app = app;

    var canPlayMp3 = (new Audio).canPlayType("audio/mp3");
    var canPlayOgg = (new Audio).canPlayType('audio/ogg; codecs="vorbis"');

    if (this.app.preferedAudioFormat === "mp3") {

        if (canPlayMp3)
            this.audioFormat = "mp3";
        else
            this.audioFormat = "ogg";

    } else {

        if (canPlayOgg)
            this.audioFormat = "ogg";
        else
            this.audioFormat = "mp3";

    }

}
;

PLAYGROUND.SoundAudio.prototype = {

    samples: {},

    setMaster: function(volume) {

        this.volume = volume;

    },

    setMasterPosition: function() {
    },

    setPosition: function(x, y, z) {
        return;
    },

    load: function(file) {

        console.log(file, this.audioFormat)

        var url = "sounds/" + file + "." + this.audioFormat;

        var loader = this.app.loader;

        this.app.loader.add(url);

        var audio = this.samples[file] = new Audio;

        audio.addEventListener("canplay", function() {

            console.log("CANPLAY");

            this.pause();
            loader.success(url);

        });
        /*
        audio.addEventListener("canplaythrough", function() {

          console.log("CANPLAYTHROUGH");

          loader.success(url);

        });

        audio.addEventListener("load", function() {

          console.log("LOAD");

          loader.success(url);

        });
    */
        audio.addEventListener("error", function() {

            loader.error(url);

        });

        audio.src = url;
        audio.play();

    },

    play: function(key, loop) {

        var sound = this.samples[key];

        sound.currentTime = 0;
        sound.loop = loop;
        sound.play();

        return sound;

    },

    stop: function(what) {

        if (!what)
            return;

        what.pause();

    },

    step: function(delta) {
    },

    setPlaybackRate: function(sound, rate) {

        return;
    },

    setVolume: function(sound, volume) {

        sound.volume = volume * this.volume;

    },

    setPosition: function() {
    },

    setPanning: function(sound, pan) {
    }

};

/* file: src/Touch.js */

/** Touch related functionality.
 *
 * The object keeps track of active touches using an unique id
 * provided by the browser. When a touch starts an entry is added
 * to the `touches` associative array with the key being the
 * unique identifier and the value an object with following members:
 * - x: horizontal position in pixels/scale
 * - y: vertical position in pixels/scale
 *
 * When the tracking point changes location the values are updated and
 * when the touches ends the entry is removed from the `touches` array.
 *
 * Properties:
 * - app: the main application object
 * - element: the DOM element we're handling events for
 * - touches: list of active touches
 * - x, y: last changed position across all touches
 *
 * Events generated by this object:
 * - touchmove: a touch changed its position
 * - touchstart: a touch was added
 * - touchend: a touch ended
 *
 * Event handlers receive the position (x, y), the id (identifier) and
 * original event.
 *
 * Reference: http://playgroundjs.com/playground-touch
 */
PLAYGROUND.Touch = function(app, element) {

    PLAYGROUND.Events.call(this);

    this.app = app;

    this.element = element;

    this.touches = {};

    this.enabled = true;

    this.x = 0;
    this.y = 0;

    this.touchmovelistener = this.touchmove.bind(this);
    this.touchstartlistener = this.touchstart.bind(this);
    this.touchendlistener = this.touchend.bind(this);

    element.addEventListener("touchmove", this.touchmovelistener, {
        passive: false
    });
    element.addEventListener("touchstart", this.touchstartlistener, {
        passive: false
    });
    element.addEventListener("touchend", this.touchendlistener, {
        passive: false
    });

    this.app.on("kill", this.kill.bind(this));

}
;

PLAYGROUND.Touch.prototype = {

    kill: function() {

        this.element.removeEventListener("touchmove", this.touchmovelistener);
        this.element.removeEventListener("touchstart", this.touchstartlistener);
        this.element.removeEventListener("touchend", this.touchendlistener);

    },

    getElementOffset: function(element) {

        var offsetX = 0;
        var offsetY = 0;

        do {
            offsetX += element.offsetLeft;
            offsetY += element.offsetTop;
        }
        while ((element = element.offsetParent));

        return {
            x: offsetX,
            y: offsetY
        };

    },

    handleResize: function() {

        this.elementOffset = this.getElementOffset(this.element);

    },

    touchmove: function(e) {

        if (!this.enabled)
            return;

        for (var i = 0; i < e.changedTouches.length; i++) {

            var touch = e.changedTouches[i];

            touchmoveEvent = {}

            this.x = touchmoveEvent.x = (touch.pageX - this.elementOffset.x - this.app.offsetX) / this.app.scale | 0;
            this.y = touchmoveEvent.y = (touch.pageY - this.elementOffset.y - this.app.offsetY) / this.app.scale | 0;

            touchmoveEvent.original = touch;
            touchmoveEvent.id = touchmoveEvent.identifier = touch.identifier;

            this.touches[touch.identifier].x = touchmoveEvent.x;
            this.touches[touch.identifier].y = touchmoveEvent.y;

            this.trigger("touchmove", touchmoveEvent);

        }

        var prevent = this.app.preventDefaults && !PLAYGROUND.Utils.classInParents(e.target, "ui");

        if (prevent)
            e.preventDefault();

    },

    touchstart: function(e) {

        if (!this.enabled)
            return;

        for (var i = 0; i < e.changedTouches.length; i++) {

            var touch = e.changedTouches[i];

            var touchstartEvent = {}

            this.x = touchstartEvent.x = (touch.pageX - this.elementOffset.x - this.app.offsetX) / this.app.scale | 0;
            this.y = touchstartEvent.y = (touch.pageY - this.elementOffset.y - this.app.offsetY) / this.app.scale | 0;

            touchstartEvent.original = e.touch;
            touchstartEvent.id = touchstartEvent.identifier = touch.identifier;

            this.touches[touch.identifier] = {
                x: touchstartEvent.x,
                y: touchstartEvent.y
            };

            this.trigger("touchstart", touchstartEvent);

        }

        var prevent = this.app.preventDefaults && !PLAYGROUND.Utils.classInParents(e.target, "ui");

        if (prevent)
            e.preventDefault();

    },

    touchend: function(e) {

        if (!this.enabled)
            return;

        for (var i = 0; i < e.changedTouches.length; i++) {

            var touch = e.changedTouches[i];
            var touchendEvent = {};

            touchendEvent.x = (touch.pageX - this.elementOffset.x - this.app.offsetX) / this.app.scale | 0;
            touchendEvent.y = (touch.pageY - this.elementOffset.y - this.app.offsetY) / this.app.scale | 0;

            touchendEvent.original = touch;
            touchendEvent.id = touchendEvent.identifier = touch.identifier;

            delete this.touches[touch.identifier];

            this.trigger("touchend", touchendEvent);

        }

        var prevent = this.app.preventDefaults && !PLAYGROUND.Utils.classInParents(e.target, "ui");

        if (prevent)
            e.preventDefault();

    }

};

PLAYGROUND.Utils.extend(PLAYGROUND.Touch.prototype, PLAYGROUND.Events.prototype);

/* file: src/Tween.js */

PLAYGROUND.Tween = function(manager, context) {

    PLAYGROUND.Events.call(this);

    this.manager = manager;
    this.context = context;
    this.auto = true;

    PLAYGROUND.Utils.extend(this, {

        prevEasing: "linear",
        prevDuration: 0.5

    });

    this.clear();

}
;

PLAYGROUND.Tween.prototype = {

    manual: function() {

        this.auto = false;

        return this;

    },

    /* 

    Add an action to the end of the list
     
    @param properties
    @param duration in miliseconds (optional, default is 0.5)
    @param easing (optional, default is linear)
    @returns `this` object so that calls can be chained.

  */

    add: function(properties, duration, easing) {

        if (typeof duration !== "undefined")
            this.prevDuration = duration;
        else
            duration = 0.5;

        if (easing)
            this.prevEasing = easing;
        else
            easing = "linear";

        this.actions.push([properties, duration, easing]);

        return this;

    },

    /* Clear animations */

    clear: function() {

        this.actions = [];
        this.index = -1;
        this.current = false;

        return this;

    },

    /* Discard all other tweens associated with same context as ours */

    discard: function() {

        this.manager.discard(this.context, this);

        return this;

    },

    /* Alias for `add()` */

    to: function(properties, duration, easing) {

        return this.add(properties, duration, easing);

    },

    /* Enqueue a method call */

    call: function(methodName, context) {

        var action = ["call", methodName, context || this.context];

        for (var i = 2; i < arguments.length; i++)
            action.push(arguments[i]);

        this.actions.push(action);

        return this;

    },

    /* Mark the instance as being a repeated tween */

    loop: function() {

        this.looped = true;

        return this;

    },

    /* Add a repeat action for specified number of times */

    repeat: function(times) {

        this.actions.push(["repeat", times]);

        return this;

    },

    /* Add a wait action for specified number of miliseconds */

    wait: function(time) {

        this.actions.push(["wait", time]);

        return this;

    },

    /* Alias for `wait()` */

    delay: function(time) {

        this.actions.push(["wait", time]);

        return this;

    },

    set: function(key, val) {

        this.actions.push(["set", key, val]);

        return this;

    },

    then: function(callback) {

        this.actions.push(["then", callback]);

        return this;

    },

    /* Remove this tween from the manager */

    stop: function() {

        this.manager.remove(this);

        return this;

    },

    /* Inserts the tween into the manager if not already inside. */

    play: function() {

        this.manager.add(this);

        this.finished = false;

        return this;

    },

    /* Performs last step in the animation list. */

    end: function() {

        var lastAnimationIndex = 0;

        for (var i = this.index + 1; i < this.actions.length; i++) {
            if (typeof this.actions[i][0] === "object")
                lastAnimationIndex = i;
        }

        this.index = lastAnimationIndex - 1;
        this.next();
        this.delta = this.duration;
        this.step(0);

        return this;

    },

    /* TBD */

    forward: function() {

        this.delta = this.duration;
        this.step(0);

    },

    /* TBD */

    rewind: function() {

        this.delta = 0;
        this.step(0);

    },

    /* 

    Perform one animation step
   
    Advances the index and, if the index reached the end of the
    `actions` array, either restarts it (for looped tweens) or terminates it.
   
    The function will set a string in `currentAction` indicating what it
    should be done next but it does not perform the action itself.

  */

    next: function() {

        this.delta = 0;

        this.index++;

        if (this.index >= this.actions.length) {

            if (this.looped) {

                this.trigger("loop", {
                    tween: this
                });

                this.index = 0;

            } else {

                this.manager.remove(this);

                return;

            }
        }

        this.current = this.actions[this.index];

        if (this.current[0] === "call") {

            var args = this.current.slice(2);

            var methodName = this.current[1];
            var context = this.current[2];
            var method = context[methodName];

            method.apply(context, args);
            this.next();

        } else if (this.current[0] === "set") {

            this.context[this.current[1]] = this.current[2];
            this.next();

        } else if (this.current[0] === "wait") {

            this.duration = this.current[1];
            this.currentAction = "wait";

        } else if (this.current[0] === "then") {

            this.current[1](this.context);
            this.currentAction = "then";
            this.next();

        } else {

            /* calculate changes */

            var properties = this.current[0];

            /* keep keys as array for 0.0001% performance boost */

            this.keys = Object.keys(properties);

            this.change = [];
            this.before = [];
            this.types = [];

            for (var i = 0; i < this.keys.length; i++) {

                var key = this.keys[i];
                var value = this.context[key];

                if (typeof properties[key] === "number") {

                    value = value || 0;

                    this.before.push(value);
                    this.change.push(properties[key] - value);
                    this.types.push(0);

                } else if (typeof properties[key] === "string" && properties[key].indexOf("rad") > -1) {

                    value = value || 0;

                    this.before.push(value);
                    this.change.push(PLAYGROUND.Utils.circWrappedDistance(value, parseFloat(properties[key])));
                    this.types.push(2);

                } else {

                    value = value || "#000";

                    var before = cq.color(value);

                    this.before.push(before);

                    var after = cq.color(properties[key]);

                    var temp = [];

                    for (var j = 0; j < 3; j++) {
                        temp.push(after[j] - before[j]);
                    }

                    this.change.push(temp);

                    this.types.push(1);

                }

            }

            this.currentAction = "animate";

            this.duration = this.current[1];
            this.easing = this.current[2];

        }

    },

    /* TBD */

    prev: function() {
    },

    /* Select an action if none is current then perform required steps. */

    step: function(delta) {

        this.delta += delta;

        if (!this.current)
            this.next();

        switch (this.currentAction) {

        case "animate":
            this.doAnimate(delta);
            break;

        case "wait":
            this.doWait(delta);
            break;

        }

    },

    doAnimate: function(delta) {

        this.progress = this.duration ? Math.min(1, this.delta / this.duration) : 1.0;

        var mod = PLAYGROUND.Utils.ease(this.progress, this.easing);

        for (var i = 0; i < this.keys.length; i++) {

            var key = this.keys[i];

            switch (this.types[i]) {

                /* number */

            case 0:

                this.context[key] = this.before[i] + this.change[i] * mod;

                break;

                /* color */

            case 1:

                var change = this.change[i];
                var before = this.before[i];
                var color = [];

                for (var j = 0; j < 3; j++) {
                    color.push(before[j] + change[j] * mod | 0);
                }

                this.context[key] = "rgb(" + color.join(",") + ")";

                break;

                /* angle */

            case 2:

                this.context[key] = PLAYGROUND.Utils.circWrap(this.before[i] + this.change[i] * mod);

                break;
            }
        }

        if (this.progress >= 1) {

            this.next();

        }

        if (this.listeners["step"]) {

            this.trigger("step", {
                tween: this,
                dt: delta
            });

        }

    },

    /* 

    Advances the animation if enough time has passed
   
    The function is called in response to `step()`; it will advance the
    index to next slot in the animation if

  */

    doWait: function(delta) {

        if (this.delta >= this.duration)
            this.next();

    },

    onremove: function() {

        this.trigger("finished", {
            tween: this
        });

        this.trigger("finish", {
            tween: this
        });

        this.finished = true;

    }

};

PLAYGROUND.Utils.extend(PLAYGROUND.Tween.prototype, PLAYGROUND.Events.prototype);

/* 

  Manager for easing effects (transition between various states).
 
  If `app` is provided the manager becomes application's manager
  for tween effects. The constructor inserts a `tween()` function
  in application for simplicity.
 
  Properties:
  - delta:
  - defaultEasing:
  - tweens: the list of active animations

*/

PLAYGROUND.TweenManager = function(app) {

    this.tweens = [];

    if (app) {
        this.app = app;
        this.app.tween = this.tween.bind(this);
    }

    this.delta = 0;

    this.app.on("step", this.step.bind(this));

}
;

PLAYGROUND.TweenManager.prototype = {

    defaultEasing: "128",

    /* TBD */

    circ: function(value) {

        return {
            type: "circ",
            value: value
        };

    },

    /* 

    Marks the tween for removing.
   
    The tween is actually removed in `step()` function.
   
    @param object the object associated with the tween
    @param safe if the tween located using `object` is `safe` then it is not removed.

  */

    discard: function(object, safe) {

        for (var i = 0; i < this.tweens.length; i++) {

            var tween = this.tweens[i];

            if (tween.context === object && tween !== safe)
                this.remove(tween);

        }

    },

    /* 

    Create a new tween.
   
    The tween is also added to internal list (you don't have to call
    `add()` yourself).
   
    @param context the object to associate with the new tween
    @returns a new PLAYGROUND.Tween object
  
  */

    tween: function(context) {

        var tween = new PLAYGROUND.Tween(this,context);

        this.add(tween);

        return tween;

    },

    /* 

    Called each frame to update logic.
   
    The function updates all active tweens and removes the ones
    tagged as such.
   
  */

    step: function(delta) {

        this.delta += delta;

        for (var i = 0; i < this.tweens.length; i++) {

            var tween = this.tweens[i];

            if (!tween.auto)
                continue;

            if (!tween._remove)
                tween.step(delta);

            if (tween._remove)
                this.tweens.splice(i--, 1);

        }

    },

    /* Add a tween to internal list. */

    add: function(tween) {

        tween._remove = false;

        var index = this.tweens.indexOf(tween);

        if (index === -1)
            this.tweens.push(tween);

    },

    /* Marks a tween for removing during next step(). */

    remove: function(tween) {

        if (tween._remove)
            return;

        tween._remove = true;

        tween.onremove();

    }

};

/* file: src/Atlases.js */

/** Extend Application object with a function to load any number of atlases
 *
 * Each atlas consists of a pair of image file and a json file
 *
 * The application is extended with an `atlases` associative array.
 * The keys are file keys generated by `getAssetEntry()` and
 * values have following structure:
 * - image: the image object
 * - frames: array of objects:
 *     - region: [x, y, w, h],
 *     - offset: [x, y],
 *     - width
 *     - height
 *
 * Default renderer can draw such an atlas using
 * `drawAtlasFrame(atlas, frame, x, y)` function.
 *
 * Reference: http://playgroundjs.com/playground-atlases
 */
PLAYGROUND.Application.prototype.loadAtlases = function() {

    for (var i = 0; i < arguments.length; i++) {

        var arg = arguments[i];

        /* polymorphism at its finest */

        if (typeof arg === "object") {

            for (var key in arg)
                this.loadAtlases(arg[key]);

        } else {

            /* if argument is not an object/array let's try to load it */

            this._loadAtlas(arg)

        }
    }

}
;

/** Alias for `loadAtlases()`. */
PLAYGROUND.Application.prototype.loadAtlas = function() {

    return this.loadAtlases.apply(this, arguments);

}
;

/** Load a single atlas (internal). */
PLAYGROUND.Application.prototype._loadAtlas = function(filename) {

    var entry = this.getAssetEntry(filename, "atlases", "png");

    this.loader.add(entry.url);

    var atlas = this.atlases[entry.key] = {};

    var image = atlas.image = new Image;

    image.addEventListener("load", function() {
        loader.success(entry.url);
    });

    image.addEventListener("error", function() {
        loader.error(entry.url);
    });

    image.src = entry.url;

    /* data */

    var request = new XMLHttpRequest();

    request.open("GET", entry.path + ".json", true);

    this.loader.add(entry.path + ".json");

    var loader = this.loader;

    request.onload = function() {

        var data = JSON.parse(this.response);

        atlas.frames = [];

        for (var i = 0; i < data.frames.length; i++) {
            var frame = data.frames[i];

            atlas.frames.push({
                region: [frame.frame.x, frame.frame.y, frame.frame.w, frame.frame.h],
                offset: [frame.spriteSourceSize.x || 0, frame.spriteSourceSize.y || 0],
                width: frame.sourceSize.w,
                height: frame.sourceSize.h
            });
        }

        loader.success(entry.path + ".json");

    }

    request.send();
}
;

/* file: src/Fonts.js */

/** Load a font.
 * @deprecated Use `Application.loadFont()` instead.
 */
PLAYGROUND.Application.prototype.loadFontOld = function(name) {

    var styleNode = document.createElement("style");
    styleNode.type = "text/css";

    var formats = {
        "woff": "woff",
        "ttf": "truetype"
    };

    var sources = "";

    for (var ext in formats) {
        var type = formats[ext];
        sources += " url(\"fonts/" + name + "." + ext + "\") format('" + type + "');"
    }

    styleNode.textContent = "@font-face { font-family: '" + name + "'; src: " + sources + " }";

    document.head.appendChild(styleNode);

    var layer = cq(32, 32);

    layer.font("10px Testing");
    layer.fillText(16, 16, 16).trim();

    var width = layer.width;
    var height = layer.height;

    this.loader.add("font " + name);

    var self = this;

    function check() {

        var layer = cq(32, 32);

        layer.font("10px " + name).fillText(16, 16, 16);
        layer.trim();

        if (layer.width !== width || layer.height !== height) {

            self.loader.ready("font " + name);

        } else {

            setTimeout(check, 250);

        }

    }
    ;
    check();

}
;

/* file: src/DefaultState.js */

/** State used while initializing the application */
PLAYGROUND.DefaultState = {
};

/* file: src/LoadingScreen.js */

/** Basic loading screen using DOM
 *
 * Loading screen is a state like any other except that
 * it is loaded from `PLAYGROUND.LoadingScreen`. To override
 * simply define a `PLAYGROUND.LoadingScreen` in your code after
 * playground.js was imported.
 */
PLAYGROUND.LoadingScreen = {

    logoRaw: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANoAAAASBAMAAADPiN0xAAAAGFBMVEUAAQAtLixHSUdnaGaJioimqKXMzsv7/fr5shgVAAAAAWJLR0QAiAUdSAAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB98EAwkeA4oQWJ4AAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAB9klEQVQ4y72UvW+rMBDAz+FrpVKrrFmesmapWNOlrKjSe1kZ+uoVAvj+/frujG1SaJcqJwU7voOf7xMQzQmsIDi5NPTMsLRntH3U+F6SAZo3NlCvcgBFJz8o+vkDiE63lI95Y/UmpinsZWkgJWJiDbAVQ16htptxSTNloIlugwaw001Ey3ASF3so6L1qLNXzQS5S0UGKL/CI5wWNriE0UH9Yty37LqIVg+wsqu7Ix0MwVBSF/dU+jv2SNnma021LEdPqVnMeU3xAu0kXcSGjmq7Ox4E2Wn88LZ2+EFj3avjixzai6VPVyuYveZLHF2XfdDnvAq27DIHGuq+0DJFsE30OtB1KqOwd8Dr7PcM4b+jfj2g5lp4WyntBK66qua3JzEA+uXJpwH/NlVuzRVPY/kTLB2mjuN+KwdZ8FOy8j2gDbEUSqumnSCY4lf4ibq3IhVM4ycZQRnv+zFqVdJQVn6BxvUqebGpuaNo3sZxwBzjajiMZOoBiwyVF+kCr+nUaJOaGpnAeRPPJZTr4FqmHRXcneEo4DqQ/ftfdnLeDrUAME8xWKPeKCwW6YkEpXfs3p1EWJhdcUAYP0TI/uYaV8cgjwBovaeyWwji2T9rTFIdS/cP/MnkTLRUWxgNNZVin7bT5fqT9miDcUVJzR1gRpfIONMmulU+5Qqr6zXAUqAAAAABJRU5ErkJggg==",

    create: function() {

        var self = this;

        this.logo = new Image;

        this.logo.addEventListener("load", function() {
            self.ready = true;
            self.createElements();
        });

        this.logo.src = this.logoRaw;

        this.background = "#000";

        if (window.getComputedStyle) {

            this.background = window.getComputedStyle(document.body).backgroundColor || "#000";

        }

    },

    enter: function() {

        this.current = 0;

    },

    leave: function() {

        this.locked = true;

        this.animation = this.app.tween(this).to({
            current: 1
        }, 0.5);

    },

    step: function(delta) {

        if (this.locked) {

            if (this.animation.finished) {
                this.locked = false;
                this.wrapper.parentNode.removeChild(this.wrapper);
            }

        } else {

            this.current = this.current + Math.abs(this.app.loader.progress - this.current) * delta;
        }

    },

    createElements: function() {

        this.width = window.innerWidth * 0.6 | 0;
        this.height = window.innerHeight * 0.1 | 0;

        this.wrapper = document.createElement("div");
        this.wrapper.style.width = this.width + "px";
        this.wrapper.style.height = this.height + "px";
        // this.wrapper.style.background = "#000";
        this.wrapper.style.border = "4px solid #fff";
        this.wrapper.style.position = "absolute";
        this.wrapper.style.left = (window.innerWidth / 2 - this.width / 2 | 0) + "px";
        this.wrapper.style.top = (window.innerHeight / 2 - this.height / 2 | 0) + "px";
        this.wrapper.style.zIndex = 100;

        this.app.container.appendChild(this.wrapper);

        this.progressBar = document.createElement("div");
        this.progressBar.style.width = "0%";
        this.progressBar.style.height = this.height + "px";
        this.progressBar.style.background = "#fff";

        this.wrapper.appendChild(this.progressBar);

    },

    render: function() {

        if (!this.ready)
            return;

        this.progressBar.style.width = (this.current * 100 | 0) + "%";

    }

};

/* file: src/Pool.js */

(function() {

    var lib = {

        pools: new Map,

        resetMethod: "reset",

        getPool: function(constructor) {

            var pool = this.pools.get(constructor);

            if (!pool) {

                this.pools.set(constructor, []);

                return this.getPool(constructor);

            }

            return pool;

        },

        pull: function(constructor, args) {

            var pool = this.getPool(constructor);

            if (!pool.length) {

                for (var i = 0; i < 10; i++) {

                    pool.push(new constructor());

                }

            }

            var result = pool.pop();

            result[this.resetMethod](args);

            return result;

        },

        push: function(object) {

            var pool = this.getPool(object.constructor);

            if (pool.length < 100)
                pool.push(object);

        }

    };

    /* API */

    var api = function() {

        if (typeof arguments[0] === "function") {

            return lib.pull(arguments[0], arguments[1]);

        } else {

            return lib.push(arguments[0]);

        }

    };

    api.pull = lib.pull.bind(lib);
    api.push = lib.push.bind(lib);

    PLAYGROUND.Application.prototype.pool = api;
    PLAYGROUND.Application.prototype.pool_debug = lib;

}
)();

/* file: ../../playground/plugins/playground.webgl.js */

/* shader loader */

PLAYGROUND.Application.prototype.loadShader = function(path) {

    let gl = this.gl;

    if (!this.shaders)
        this.shaders = {};

    let app = this;

    this.loader.add();

    let entry = this.getAssetEntry(path, "shaders", "glsl");

    let type = path.indexOf("_vertex") > -1 ? "vertex" : "fragment";

    return app.request(entry.url).then((response)=>{

        let text = response.responseText;

        let result = null;
        let shader = gl.createShader(type === "vertex" ? gl.VERTEX_SHADER : gl.FRAGMENT_SHADER);

        gl.shaderSource(shader, text);
        gl.compileShader(shader);

        var success = gl.getShaderParameter(shader, gl.COMPILE_STATUS);

        if (success) {

            let asset = {
                native: shader,
                variables: {}
            };

            result = asset;

            let regexp = /(uniform|attribute) (.*) (.*);/g;
            let match;

            while (match = regexp.exec(text)) {

                let qualifier = match[1].trim();
                let type = match[2].trim();
                let name = match[3].trim();

                asset.variables[name] = {
                    qualifier,
                    type
                }

            }

            app.insertAsset(asset, this.shaders, entry.key);

        } else {

            console.log("Error in shader ", entry.key)
            console.log(gl.getShaderInfoLog(shader));

        }

        this.loader.success();

        return result;

    }
    );

}
;

PLAYGROUND.ProgramAsset = function(app, vertexShaderAsset, fragmentShaderAsset) {

    this.app = app;

    let gl = app.gl;

    let program = gl.createProgram();

    this.program = this.native = program;
    this.variables = {};

    gl.attachShader(program, vertexShaderAsset.native);
    gl.attachShader(program, fragmentShaderAsset.native);

    gl.linkProgram(program);

    var success = gl.getProgramParameter(program, gl.LINK_STATUS);

    if (success) {

        Object.assign(this.variables, vertexShaderAsset.variables, fragmentShaderAsset.variables);

    } else {

        console.log(gl.getProgramInfoLog(program));

        return null;

    }

    this.locations = {};

    for (let name in this.variables) {

        let def = this.variables[name];

        if (def.qualifier === "uniform")
            def.location = gl.getUniformLocation(program, name);
        else if (def.qualifier === "attribute")
            def.location = gl.getAttribLocation(program, name);

        this.locations[name] = def.location;

    }

}
;

Object.assign(PLAYGROUND.ProgramAsset.prototype, {

    set(name, a, b, c, d) {

        let def = this.variables[name];

        if (def.qualifier === "uniform") {

            if (def.type === "float")
                this.app.gl.uniform1f(def.location, a);
            else if (def.type === "bool")
                this.app.gl.uniform1i(def.location, a);
            else if (def.type === "vec2")
                this.app.gl.uniform2f(def.location, a, b);
            else if (def.type === "vec3")
                this.app.gl.uniform3f(def.location, a, b, c, d);
            else if (def.type === "vec4")
                this.app.gl.uniform4f(def.location, a, b, c, d);
            else if (def.type === "mat3")
                this.app.gl.uniformMatrix3fv(def.location, false, a);
            else if (def.type === "mat4")
                this.app.gl.uniformMatrix4fv(def.location, false, a);
            else if (def.type === "sampler2D")
                this.app.gl.uniform1i(def.location, a);

        }

    }

});

PLAYGROUND.Application.prototype.loadProgram = function(programName, vertexPath, fragmentPath) {

    let gl = this.gl;

    if (!this.programs)
        this.programs = {};

    this.loader.add();

    return Promise.all([this.loadShader(vertexPath), this.loadShader(fragmentPath)])
    .then((shaders)=>{

        var programAsset = new PLAYGROUND.ProgramAsset(this,shaders[0],shaders[1]);

        this.programs[programName] = programAsset;

        this.loader.success();

        return programAsset;

    }
    );

}

PLAYGROUND.Application.prototype.nearestPOT = function(value, pow) {

    pow = pow || 1;

    while (pow < value) {

        pow *= 2;

    }

    return pow;

}
;

PLAYGROUND.Application.prototype.shouldUsePalette = function(url) {
}
;

PLAYGROUND.Application.prototype.loadTexture = function(path, options={}) {

    let app = this;

    if (!this.textures)
        this.textures = {};

    let gl = this.gl;

    let entry = this.getAssetEntry(path, "textures", "png");

    var image = new Image();

    image.src = entry.url;

    if (this.promises[entry.url])
        return this.promises[entry.url];

    this.loader.add(path);

    return this.promises[entry.url] = new Promise(function(resolve, reject) {

        image.addEventListener('load', function() {

            let texture = gl.createTexture();

            // Now that the image has loaded make copy it to the texture.

            let canvas = document.createElement("canvas");

            canvas.width = app.nearestPOT(image.width);
            canvas.height = app.nearestPOT(image.height);

            canvas.getContext("2d").drawImage(image, 0, 0);

            if (app.shouldUsePalette(entry.url) || options.usePalette) {

                cq(canvas).matchPalette(cq.palettes.db32).swapColors(app.paletteMap);

                texture.paletteReady = true;

            }

            gl.bindTexture(gl.TEXTURE_2D, texture);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, canvas);

            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);

            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

            gl.generateMipmap(gl.TEXTURE_2D);

            texture.width = canvas.width;
            texture.height = canvas.height;

            texture.originalWidth = image.width;
            texture.originalHeight = image.height;
            texture.src = entry.url;

            app.insertAsset(texture, app.textures, entry.key);

            app.loader.success();

            resolve(texture)

        });

    }
    );

}
;

PLAYGROUND.Application.prototype.textureFromCanvas = function(canvas) {

    let gl = this.gl;

    let texture = gl.createTexture();

    gl.bindTexture(gl.TEXTURE_2D, texture);
    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, canvas);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
    gl.generateMipmap(gl.TEXTURE_2D);

    gl.bindTexture(gl.TEXTURE_2D, null);

    texture.originalWidth = texture.width = canvas.width;
    texture.originalHeight = texture.height = canvas.height;

    return texture;

}

/* file: ../../playground/plugins/playground.SoundOnDemand.js */

/*     

  SoundOnDemand r24

  (c) 2012-2017 http://rezoner.net

  This library may be freely distributed under the MIT license.

*/
/* options */

/* output: output node, default */
/* audioContext: audioContext */

if (!window.AudioContext) {

    window.AudioContext = window.webkitAudioContext;

    if (!window.AudioContext.prototype.createStereoPanner) {

        window.AudioContext.prototype.createStereoPanner = function() {

            var node = this.createGain();

            node.pan = {
                value: 0
            };

            return node;

        }

    }

}

window.SoundOnDemand = function(options) {

    options = options || {};

    var canPlayMp3 = (new Audio).canPlayType("audio/mp3");
    var canPlayOgg = (new Audio).canPlayType('audio/ogg; codecs="vorbis"');

    if (this.preferedAudioFormat === "mp3") {

        if (canPlayMp3)
            this.audioFormat = "mp3";
        else
            this.audioFormat = "ogg";

    } else {

        if (canPlayOgg)
            this.audioFormat = "ogg";
        else
            this.audioFormat = "mp3";

    }

    this.audioContext = options.audioContext || new AudioContext;

    this.gainNode = this.audioContext.createGain()
    this.gainNode.connect(this.audioContext.destination);

    this.input = this.gainNode;

    this.gainNode.gain.value = 1.0;

    this.buffers = {};

    this.channels = {};
    this.aliases = {};

    var lastTick = Date.now();
    var engine = this;

    setInterval(function() {

        var delta = (Date.now() - lastTick) / 1000;

        lastTick = Date.now();

        engine.step(delta);

    }, 1000 / 30);

}
;

SoundOnDemand.moveTo = function(value, target, step) {

    if (value < target) {
        value += step;
        if (value > target)
            value = target;
    }

    if (value > target) {
        value -= step;
        if (value < target)
            value = target;
    }

    return value;

}
;

SoundOnDemand.prototype = {

    constructor: SoundOnDemand,

    path: "sounds/",

    channel: function(name) {

        if (!this.channels[name])
            this.channels[name] = new SoundOnDemand.Channel(this);

        return this.channels[name];

    },

    getAssetEntry: function(path, defaultExtension) {

        /* translate folder according to user provided paths 
       or leave as is */

        let absolute = false;
        let final_path;
        if (path[0] === "<") {

            ext = defaultExtension;
            url = path.substr(1, path.length - 2) + "." + ext;
            key = path;
            final_path = path;

        } else {

            var fileinfo = path.match(/(.*)\..*/);
            var key = fileinfo ? fileinfo[1] : path;

            var temp = path.split(".");
            var basename = path;

            if (temp.length > 1) {
                var ext = temp.pop();
                path = temp.join(".");
            } else {
                var ext = defaultExtension;
                basename += "." + defaultExtension;
            }

            var url;

            if (app && app.rewriteURL) {

                url = app.rewriteURL(this.path + basename);

            } else {

                url = this.path + basename;

            }

            final_path = this.path + path;

        }

        return {
            key: key,
            url: url,
            path: final_path,
            ext: ext
        };

    },

    loaders: {},

    load: function(key) {

        var engine = this;
        var entry = engine.getAssetEntry(key, engine.audioFormat);

        if (!this.loaders[key]) {

            this.loaders[key] = new Promise(function(resolve, reject) {

                if (engine.buffers[entry.key])
                    return resolve(engine.buffers[entry.key]);

                var request = new XMLHttpRequest();

                request.open("GET", entry.url, true);
                request.responseType = "arraybuffer";

                request.onload = function() {

                    engine.audioContext.decodeAudioData(this.response, function(decodedBuffer) {

                        engine.buffers[entry.key] = decodedBuffer;
                        resolve(decodedBuffer);

                    });

                }

                request.send();

            }
            );

        }

        return this.loaders[key];

    },

    step: function(delta) {

        for (var key in this.channels) {

            this.channels[key].step(delta);

        }

    },

    duplicate: function(source, as, volume, rate) {

        var engine = this;

        this.load(source).then(function() {

            engine.buffers[source];

            engine.buffers[as] = engine.buffers[source];

        });

    },

    alias: function(name, source, rate, volume) {

        this.aliases[name] = {
            source: source,
            rate: rate,
            volume: volume
        };

    }

};
SoundOnDemand.Events = function() {

    this.listeners = {};

}
;

SoundOnDemand.Events.prototype = {

    on: function(event, callback) {

        if (typeof event === "object") {
            var result = {};
            for (var key in event) {
                result[key] = this.on(key, event[key])
            }
            return result;
        }

        if (!this.listeners[event])
            this.listeners[event] = [];

        this.listeners[event].push(callback);

        return callback;
    },

    once: function(event, callback) {

        callback.once = true;

        if (!this.listeners[event])
            this.listeners[event] = [];

        this.listeners[event].push(callback);

        return callback;

    },

    off: function(event, callback) {

        for (var i = 0, len = this.listeners[event].length; i < len; i++) {
            if (this.listeners[event][i]._remove) {
                this.listeners[event].splice(i--, 1);
                len--;
            }
        }

    },

    trigger: function(event, data) {

        /* if you prefer events pipe */

        if (this.listeners["event"]) {
            for (var i = 0, len = this.listeners["event"].length; i < len; i++) {
                this.listeners["event"][i](event, data);
            }
        }

        /* or subscribed to single event */

        if (this.listeners[event]) {
            for (var i = 0, len = this.listeners[event].length; i < len; i++) {
                var listener = this.listeners[event][i];
                listener.call(this, data);

                if (listener.once) {
                    this.listeners[event].splice(i--, 1);
                    len--;
                }
            }
        }

    }

};
SoundOnDemand.Channel = function(engine) {

    this.engine = engine;
    this.audioContext = engine.audioContext;

    /* connection order goes from bottom to top */

    /* gain node */

    this.gainNode = this.audioContext.createGain();

    /* convolver */

    this.convolverWetNode = this.audioContext.createGain();
    this.convolverDryNode = this.audioContext.createGain();

    this.convolverEnabled = false;

    this.compressorEnabled = true;

    this.route();

    this.queue = [];

    this.concurentSounds = 0;
    this.soundsThisStep = 0;

}
;

SoundOnDemand.Channel.prototype = {

    constructor: SoundOnDemand.Channel,

    get: function(key) {

        return new SoundOnDemand.Sound(key,this);

    },

    play: function(key) {

        if (this.mutedWith)
            key = this.mutedWith;

        var sound = this.get(key);

        this.add(sound);

        this.soundsThisStep++;

        if (this.concurentSounds && this.soundsThisStep > this.concurentSounds)
            sound.cancel = true;

        return sound;

    },

    remove: function(sound) {

        sound._remove = true;

    },

    add: function(sound) {

        sound._remove = false;

        if (this.queue.indexOf(sound) > -1)
            return;

        this.queue.push(sound);

    },

    step: function(delta) {

        this.soundsThisStep = 0;

        /* process queue */

        for (var i = 0; i < this.queue.length; i++) {

            var sound = this.queue[i];

            if (sound._remove) {

                this.queue.splice(i--, 1);

                continue;

            }

            sound.step(delta);

        }

    },

    muteWith: function(key) {

        this.mutedWith = key;

    },

    volume: function(value) {

        if (arguments.length === 0) {

            return this.gainNode.gain.value;

        } else {

            this.gainNode.gain.value = value;

            return this;

        }

    },

    swapConvolver: function(key) {

        var engine = this.engine;
        var channel = this;

        return new Promise(function(resolve, fail) {

            if (channel.currentConvolverImpulse === key) {

                resolve();

            } else {

                engine.load(key).then(function(buffer) {
                    channel.currentConvolverImpulse = key;
                    channel.convolverNode.buffer = buffer;
                    resolve();
                });

            }

        }
        );

    },

    updateConvovlerState: function(enabled) {

        this.convolverEnabled = enabled;
        this.route();

    },

    subroute: function(nodes) {

        for (var i = 0; i < nodes.length; i++) {

            if (i < nodes.length - 1) {

                var node = nodes[i];
                node.disconnect();
                node.connect(nodes[i + 1]);

            }

        }

        this.input = nodes[0];

    },

    disconnect() {
        this.gainNode.disconnect();

    },

    reconnect() {

        this.route();

    },

    route: function() {

        this.gainNode.disconnect();

        if (this.convolverEnabled && this.audioContext.createConvolver) {

            this.convolverNode = this.audioContext.createConvolver();

            this.gainNode.connect(this.convolverDryNode);

            this.gainNode.connect(this.convolverNode);
            this.convolverNode.connect(this.convolverWetNode);

            this.convolverWetNode.connect(this.engine.input);
            this.convolverDryNode.connect(this.engine.input);
            this.input = this.gainNode;

        } else if (this.compressorEnabled && this.audioContext.createDynamicsCompressor) {

            this.gainNode.connect(this.engine.input);

            if (!this.compressor) {

                this.compressor = this.audioContext.createDynamicsCompressor();

                this.compressor.threshold.value = -50;
                this.compressor.knee.value = 40;
                this.compressor.ratio.value = 12;
                this.compressor.attack.value = 0;
                this.compressor.release.value = 0.25;

            }

            this.compressor.connect(this.gainNode);

            this.input = this.compressor;

        } else {

            this.gainNode.connect(this.engine.input);
            this.input = this.gainNode;

        }

    },

    convolver: function(value, key) {

        var enabled = value > 0;
        var channel = this;

        this.swapConvolver(key).then(function() {

            if (enabled !== channel.convolverEnabled)
                channel.updateConvovlerState(enabled);

        });

        this.convolverWetNode.gain.value = value;
        this.convolverDryNode.gain.value = 1 - value;

        return this;

    }

};
SoundOnDemand.Sound = function(key, channel) {

    this.key = key;
    this.bufferKey = key;
    this.delayTimeout = 0;
    this.paused = false;

    if (channel.engine.aliases[key]) {

        this.alias = channel.engine.aliases[key];

        this.bufferKey = this.alias.source;

    }

    if (!channel.engine.buffers[this.bufferKey])
        channel.engine.load(this.bufferKey);

    this.channel = channel;
    this.audioContext = this.channel.engine.audioContext;

    this.current = {
        volume: 1.0,
        rate: 1.0
    };

    this.fadeMod = 1.0;

    this.createNodes();

}
;

SoundOnDemand.Sound.prototype = {

    constructor: SoundOnDemand.Sound,

    alias: {
        volume: 1.0,
        rate: 1.0
    },

    createNodes: function() {

        var bufferSource = this.audioContext.createBufferSource();
        var gainNode = this.audioContext.createGain();
        var panNode = this.audioContext.createStereoPanner();

        bufferSource.connect(panNode);
        panNode.connect(gainNode);
        gainNode.connect(this.channel.input);

        this.bufferSource = bufferSource;
        this.gainNode = gainNode;
        this.panNode = panNode;

    },

    volume: function(volume) {

        volume *= this.alias.volume;

        this.current.volume = volume;

        this.updateVolume();

        return this;

    },

    volumef: function(volume) {

        return this.volume(this.current.volume * volume);

    },

    delay: function(time) {

        this.delayTimeout = time;

        return this;

    },

    updateVolume: function() {

        this.gainNode.gain.value = this.current.volume * this.fadeMod;

    },

    pan: function(pan) {

        if (pan < -1.0)
            pan = -1.0;
        if (pan > 1.0)
            pan = 1.0;

        this.current.pan = pan;

        this.updatePanning();

        return this;

    },

    updatePanning: function() {

        this.panNode.pan.value = this.current.pan;

    },

    offset: function(offset) {

        this.current.offset = offset;

        return this;

    },

    loop: function(start=0, end=0) {

        this.bufferSource.loop = true;
        this.current.loop = true;

        this.bufferSource.loopStart = start;

        if (end)
            this.bufferSource.loopEnd = end;

        return this;

    },

    rrate: function(range) {

        return this.rate(this.current.rate + (-1 + Math.random() * 2) * range);

    },

    nrate: function(range) {

        return this.rate(this.current.rate - Math.random() * range);

    },

    prate: function(range) {

        return this.rate(this.current.rate + Math.random() * range);

    },

    rate: function(rate) {

        rate *= this.alias.rate;

        this.bufferSource.playbackRate.value = rate;

        this.current.rate = rate;

        return this;

    },

    rateTo: function(target, duration) {

        if (!this.playing && this.ready)
            this.resume();

        duration = duration || 1.0;

        this.rateTime = 0;
        this.rateTarget = target;
        this.rateDuration = duration;

        this.rateSpeed = Math.abs(target - this.current.rate) / duration;

        return this;

    },

    onended: function() {

        if (!this.current.loop)
            this.stop();

    },

    step: function(delta) {

        if (this.cancel && !this.current.loop) {

            this.stop();

            return;

        }

        let updateVolume = false;

        if (this.delayTimeout > 0) {

            this.delayTimeout -= delta;

            return;

        }

        if (this.fadeTarget !== this.fadeMod) {

            updateVolume = true;

            this.fadeMod = SoundOnDemand.moveTo(this.fadeMod, this.fadeTarget, delta * this.fadeSpeed);

        } else if (this.fadeTarget === 0) {

            this.pause();

            return;

        }

        if (!this.ready) {

            if (!this.channel.engine.buffers[this.bufferKey])
                return;

            this.ready = true;
            this.playing = true;

            this.buffer = this.channel.engine.buffers[this.bufferKey];

            this.bufferSource.buffer = this.buffer;

            this.bufferSource.start(0, this.current.offset);
            this.bufferSource.onended = this.onended.bind(this);

            this.currentTime = 0;

            this.currentTime += this.bufferSource.playbackRate.value * delta;

            updateVolume = true;

        }

        if (updateVolume)
            this.updateVolume();

        if (this.rateTarget !== this.current.rate) {

            this.rate(SoundOnDemand.moveTo(this.current.rate, this.rateTarget, delta * this.rateSpeed));

        }

    },

    pause: function() {

        this.channel.remove(this);

        if (this.playing)
            this.bufferSource.stop(0);

        this.playing = false;

    },

    stop: function() {

        this.channel.remove(this);

        if (!this.playing)
            return;

        this.bufferSource.stop(0);

        this.playing = false;

    },

    play: function() {

        if (this.playing)
            return;

        this.createNodes();

        this.channel.add(this);

        this.ready = false;
        this.playing = false;

    },

    resume: function() {

        this.createNodes();

        this.bufferSource.buffer = this.buffer;

        this.currentTime = this.currentTime % this.buffer.duration;
        this.bufferSource.start(0, this.currentTime);

        this.rate(this.current.rate);
        this.volume(this.current.volume);
        this.loop(this.current.loop);

        this.channel.add(this);

        this.playing = true;

    },

    fadeTo: function(target, duration) {

        if (!this.playing && this.ready)
            this.resume();

        duration = duration || 1.0;

        this.fadeTarget = target;
        this.fadeDuration = duration;

        this.fadeSpeed = Math.abs(target - this.fadeMod) / duration;

        return this;

    },

    fadeIn: function(duration) {

        if (!this.playing && this.ready)
            this.resume();

        this.fadeMod = 0;
        this.fadeTo(1.0, duration);

        return this;

    },

    fadeOut: function(duration) {

        this.fadeTo(0, duration || 1.0);

        return this;

    }

};
PLAYGROUND.SoundOnDemand = function(app) {

    app.audio = new SoundOnDemand();

    app.audio.path = app.getPath("sounds");

    app.loadSounds = function() {

        for (var i = 0; i < arguments.length; i++) {

            var key = arguments[i];

            this.loader.add();

            this.audio.load(key).then(this.loader.success.bind(this.loader), this.loader.error.bind(this.loader));

        }

    }
    ;

}
;

PLAYGROUND.SoundOnDemand.plugin = true;

/* file: script/lib/playground.scanlines.js */

PLAYGROUND.Scanlines = {

    lineHeight: 2,

    create: function(app) {

        this.app = app;

        app.on("resize", this.resize.bind(this));
        // app.on("postrender", this.postrender.bind(this));

    },

    resize: function() {

        this.image = cq(this.app.width, this.app.height);

        this.image.globalAlpha(0.1);
        this.image.fillStyle("#008");

        for (var i = 1; i < this.image.canvas.height; i += this.lineHeight * 2) {

            this.image.fillRect(0, i, this.image.canvas.width, this.lineHeight);

        }

        this.image = this.image.cache();

        this.app.toImageBitmap(this, "image");

    },

    render: function() {

        if (this.image) {

            this.app.layer.drawImage(this.image, 0, 0);

        }

    }

};

/* file: script/lib/playground.ambient.js */

PLAYGROUND.Ambient = function(app) {

    let loops = {};
    let sounds = {};

    function step() {

        for (var key in sounds) {

            sounds[key] -= 0.25;

            if (sounds[key] <= 0) {

                delete sounds[key];
                loops[key].fadeOut(0.25);
                loops[key] = null;
            }

        }

    }

    setInterval(step, 250);

    app.ambient = function(sound, volume=1.0, rate=1.0) {

        sounds[sound] = 0.5;

        if (!loops[sound])
            loops[sound] = app.sound.play(sound).loop().rate(rate).fadeIn(0.25);

        loops[sound].volume(volume);
        loops[sound].rate(rate);

        return loops[sound];

    }

}
;

PLAYGROUND.Ambient.plugin = true;

/* file: script/playground/plugins/playground.painter.js */

PLAYGROUND.Painter = function(app) {

    let gl = app.gl;
    this.gl = gl;

    this.defaultSrcBlend = app.gl.SRC_ALPHA;

    this.last = {
        width: 0,
        height: 0
    };

    this.values = {

        color: app.color(),
        rotation: 0.0,
        alpha: 1.0,
        creation: 0.0,
        dissolve: 0.0,
        blend: [],
        blendEquation: app.gl.FUNC_ADD,
        range: [],
        align: {
            x: 0.5,
            y: 0.5
        },
        scale: {
            x: 0.0,
            y: 0.0
        },
        translation: {
            x: 0.0,
            y: 0.0
        },
        offset: {
            x: 0.0,
            y: 0.0
        },

        font: null,
        program: null,
        textAlign: "center"
    };

    this.app = app;
    this.matrix = Matrix3.create();

    app.loadProgram("image", "image_vertex", "image_fragment");

    {
        let canvas = document.createElement("Canvas");
        canvas.width = 128;
        canvas.height = 128;
        this.emptyTexture = this.textureFromCanvas(canvas);
    }

    {

        let vertices = new Float32Array([0.0, 0.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 0.0, 0.0]);

        let meshBuffer = gl.createBuffer();

        gl.bindBuffer(gl.ARRAY_BUFFER, meshBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);

        this.quad = meshBuffer;

    }

}
;

PLAYGROUND.Painter.prototype = {

    _region: [],
    _trim: [],

    white: {
        r: 1.0,
        g: 1.0,
        b: 1.0,
        a: 1.0
    },

    transparent: {
        r: 1.0,
        g: 1.0,
        b: 1.0,
        a: 0.0
    },

    reset() {

        this.values.blendEquation = app.gl.FUNC_ADD;
        this.values.blend.length = 0;
        this.values.alpha = 1.0;
        this.values.translation.x = 0.0;
        this.values.translation.y = 0.0;
        this.values.align.x = 0.5;
        this.values.align.y = 0.5;
        this.values.scale.x = 1.0;
        this.values.scale.y = 1.0;
        this.values.offset.x = 0.0;
        this.values.offset.y = 0.0;
        this.values.rotation = 0.0;
        this.values.dissolve = 0.0;
        this.values.creation = 0.0;
        this.values.palette = -1.0;
        this.values.paletteTexture = null;
        this.values.program = null;
        this.values.nativeProgram = null;
        this.values.dissolveMap = app.textures.noise;
        this.values.repeat = false;
        this.values.end = Math.PI * 2;

        this.values.range.length = 0;

        this.values.color.set(0x000000, 0.0);

        this.values.textAlign = "center";
        this.values.font = this.app.fonts.default;

        this.values.width = 0;
        this.values.height = 0;

    },

    range(a, b) {

        if (arguments.length === 0) {

            this.values.range.length = 0;

        } else {

            this.values.range[0] = a;
            this.values.range[1] = b;

        }

    },

    program(program) {

        this.values.program = program;
        this.values.nativeProgram = program.native;

        app.gl.useProgram(program.native);

        return this;

    },

    textAlign(textAlign) {

        this.values.textAlign = textAlign;

        return this;

    },

    palette(palette) {

        this.values.palette = palette;

        return this;

    },

    paletteTexture(paletteTexture) {

        this.values.paletteTexture = paletteTexture;

        return this;

    },

    blend() {

        this.values.blend.length = Math.max(0, arguments.length - 1);

        this.values.blendEquation = arguments[0];

        for (let i = 1; i < arguments.length; i++)
            this.values.blend[i - 1] = arguments[i];

        return this;

    },

    blending() {

        if (!this.values.blend.length)
            return false;

        if (this.values.blend.length === 2)
            app.gl.blendFunc(this.values.blend[0], this.values.blend[1]);
        else
            app.gl.blendFuncSeparate(this.values.blend[0], this.values.blend[1], this.values.blend[2], this.values.blend[3]);

        app.gl.blendEquation(this.values.blendEquation);

        return true;

    },

    repeat(repeat) {

        this.values.repeat = repeat;

        return this;

    },

    alpha(alpha) {

        this.values.alpha = alpha;

        return this;

    },

    rotate(rotation) {

        this.values.rotation = rotation;

        return this;

    },

    parseColor(color, temp) {

        if (temp.num === color)
            return temp;

        temp.r = (color / 65536 % 256 | 0) / 255.0;
        temp.g = (color / 256 % 256 | 0) / 255.0;
        temp.b = (color % 256) / 255.0;
        temp.a = 1.0;
        temp.num = color;

        return temp;

    },

    font(font) {

        if (typeof font === "string")
            font = app.fonts[font];

        this.values.font = font;

        return this;

    },

    color(color, alpha=1.0) {

        if (typeof color === "object") {

            this.values.color.r = color.r;
            this.values.color.g = color.g;
            this.values.color.b = color.b;
            this.values.color.a = color.a;

        } else {

            if (color < 0)
                alpha = 0.0;

            this.values.color.set(color, alpha);

        }

        return this;

    },

    dissolve(dissolve) {

        this.values.dissolve = dissolve;

        return this;

    },

    dissolveMap(dissolveMap) {

        this.values.dissolveMap = dissolveMap;

        return this;

    },

    creation(creation) {

        this.values.creation = creation;

        return this;

    },

    end(end) {

        this.values.end = end;

        return this;

    },

    align(x, y) {

        this.values.align.x = x;
        this.values.align.y = y;

        return this;

    },

    scale(x, y) {

        this.values.scale.x = x;
        this.values.scale.y = y;

    },

    translate(x, y) {

        this.values.translation.x = x;
        this.values.translation.y = y;

    },

    offset(x, y) {

        this.values.offset.x = x;
        this.values.offset.y = y;

    },

    updateMatrix(x, y, width, height) {

        width = this.values.width || width;
        height = this.values.height || height;

        Matrix3.reset(this.matrix);
        Matrix3.translate(this.matrix, x | 0, y | 0);

        if (this.values.translation.x || this.values.translation.y)
            Matrix3.translate(this.matrix, this.values.translation.x, this.values.translation.y);

        if (this.values.rotation)
            Matrix3.rotate(this.matrix, -this.values.rotation);
        if (this.values.scale.x !== 1.0 || this.values.scale.y !== 1.0)
            Matrix3.scale(this.matrix, this.values.scale.x, this.values.scale.y);

        Matrix3.translate(this.matrix, (-width * this.values.align.x) + this.values.offset.x | 0, (-height * this.values.align.y) + this.values.offset.y | 0);

        this.last.height = height;
        this.last.width = width;

    },

    xupdateMatrix(x, y, width, height) {

        width = this.values.width || width;
        height = this.values.height || height;

        Matrix3.reset(this.matrix);
        Matrix3.translate(this.matrix, x | 0, y | 0);

        if (this.values.translation.x || this.values.translation.y)
            Matrix3.translate(this.matrix, this.values.translation.x, this.values.translation.y);

        if (this.values.rotation)
            Matrix3.rotate(this.matrix, -this.values.rotation);

        Matrix3.translate(this.matrix, (-width * this.values.align.x) * this.values.scale.x + this.values.offset.x | 0, (-height * this.values.align.y) * this.values.scale.y + this.values.offset.y | 0);

        if (this.values.scale.x !== 1.0 || this.values.scale.y !== 1.0)
            Matrix3.scale(this.matrix, this.values.scale.x, this.values.scale.y);

    },

    bindTexture(texture, slot=0) {

        let gl = this.app.gl;

        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, texture);

        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

    },

    drawImage(texture, x, y) {

        if (typeof texture === "string") {

            if (!this.app.textures[texture])
                return app.loadTexture(texture);

            texture = this.app.textures[texture];

        }

        let gl = this.app.gl;
        let program = this.values.program || app.programs.image;

        gl.enable(gl.BLEND);

        this.blending() || (gl.blendEquation(gl.FUNC_ADD),
        gl.blendFunc(this.defaultSrcBlend, gl.ONE_MINUS_SRC_ALPHA));

        gl.useProgram(program.native);

        /* Position */

        gl.enableVertexAttribArray(program.locations.position);
        gl.bindBuffer(gl.ARRAY_BUFFER, this.quad);
        gl.vertexAttribPointer(program.locations.position, 2, gl.FLOAT, false, 0, 0);

        /* Texturing */

        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, texture);

        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

        gl.enableVertexAttribArray(program.locations.uv);
        gl.bindBuffer(gl.ARRAY_BUFFER, this.quad);
        gl.vertexAttribPointer(program.locations.uv, 2, gl.FLOAT, false, 0, 0);

        program.set("width", texture.width);
        program.set("height", texture.height);
        program.set("alpha", this.values.alpha);
        program.set("creation", this.values.creation);

        program.set("tx", 0.0);
        program.set("ty", 0.0);
        program.set("tw", 1.0);
        program.set("th", 1.0);

        program.set("texture", 0);
        program.set("color", this.values.color.r, this.values.color.g, this.values.color.b, this.values.color.a * this.values.alpha);

        gl.activeTexture(gl.TEXTURE1);
        gl.bindTexture(gl.TEXTURE_2D, this.values.paletteTexture || app.textures.palette);

        let palette = this.values.palette;

        if (palette < 0 && texture.paletteReady)
            palette = 0;

        program.set("paletteTexture", 1);
        program.set("palette", palette);

        this.updateMatrix(x, y, texture.originalWidth || texture.width, texture.originalHeight || texture.height);

        program.set("modelMatrix", this.matrix);

        /* Draw */

        gl.drawArrays(gl.TRIANGLES, 0, 6);

    },

    drawImageRegion(texture, srcX, srcY, srcW, srcH, dstX, dstY, dstW=0, dstH=0) {

        dstW = dstW || srcW;
        dstH = dstH || srcH;

        let gl = this.app.gl;
        let program = this.values.program || app.programs.image;

        gl.enable(gl.BLEND);

        this.blending() || (gl.blendEquation(gl.FUNC_ADD),
        gl.blendFunc(this.defaultSrcBlend, gl.ONE_MINUS_SRC_ALPHA));

        gl.useProgram(program.native);

        /* Position */

        gl.enableVertexAttribArray(program.locations.position);
        gl.bindBuffer(gl.ARRAY_BUFFER, this.quad);
        gl.vertexAttribPointer(program.locations.position, 2, gl.FLOAT, false, 0, 0);

        /* Texturing */

        gl.activeTexture(gl.TEXTURE0);
        gl.enableVertexAttribArray(program.locations.uv);
        gl.bindTexture(gl.TEXTURE_2D, texture);

        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

        gl.bindBuffer(gl.ARRAY_BUFFER, this.quad);
        gl.vertexAttribPointer(program.locations.uv, 2, gl.FLOAT, false, 0, 0);

        program.set("width", dstW);
        program.set("height", dstH);
        program.set("alpha", this.values.alpha);
        program.set("color", this.values.color.r, this.values.color.g, this.values.color.b, this.values.color.a);
        program.set("creation", this.values.creation);

        program.set("tx", srcX / texture.width);
        program.set("ty", srcY / texture.height);
        program.set("tw", srcW / texture.width);
        program.set("th", srcH / texture.height);

        program.set("texture", 0);

        gl.activeTexture(gl.TEXTURE1);
        gl.bindTexture(gl.TEXTURE_2D, this.values.paletteTexture || app.textures.palette);

        let palette = this.values.palette;

        if (palette < 0 && texture.paletteReady)
            palette = 0;

        program.set("paletteTexture", 1);
        program.set("palette", palette);

        this.updateMatrix(dstX, dstY, dstW, dstH);

        program.set("modelMatrix", this.matrix);

        /* Draw */

        gl.drawArrays(gl.TRIANGLES, 0, 6);

    },

    drawAtlas(key, x, y) {

        let sprite;

        if (typeof key === "object")
            sprite = key;
        else
            sprite = app.atlas[key];

        this.drawImageRegion(sprite.texture, sprite.region[0], sprite.region[1], sprite.region[2], sprite.region[3], x, y);

        return this;

    },

    drawSprite(sprite, x, y, frame=0, row=0) {

        if (typeof sprite === "string") {

            if (!this.app.sprites[sprite])
                return app.loadSprite(sprite);

            sprite = this.app.sprites[sprite];

        }

        if (this.values.range.length) {

            let frames = this.values.range[1] - this.values.range[0];

            if (frame < 0)
                frame = frames + (frame % frames);

            frame = this.values.range[0] + (frame % frames | 0);

        } else {

            if (frame < 0)
                frame = frames + (frame % frames);

            frame = frame % sprite.frames | 0;
        }

        row = row % sprite.rows | 0;

        let gl = app.gl;
        let program = this.values.program || app.programs.sprite;

        /* Alpha */

        gl.enable(gl.BLEND);

        this.blending() || (gl.blendEquation(gl.FUNC_ADD),
        gl.blendFunc(this.defaultSrcBlend, gl.ONE_MINUS_SRC_ALPHA));

        /* Assign shaders */

        gl.useProgram(program.native);

        /* Position */

        gl.enableVertexAttribArray(program.locations.position);

        gl.bindBuffer(gl.ARRAY_BUFFER, this.quad);
        gl.vertexAttribPointer(program.locations.position, 2, gl.FLOAT, false, 0, 0);

        /* Texturing */

        gl.activeTexture(gl.TEXTURE1);
        gl.bindTexture(gl.TEXTURE_2D, this.values.paletteTexture || app.textures.palette);

        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, sprite.texture);

        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

        gl.enableVertexAttribArray(program.locations.uv);
        gl.bindBuffer(gl.ARRAY_BUFFER, this.quad);
        gl.vertexAttribPointer(program.locations.uv, 2, gl.FLOAT, false, 0, 0);

        let absFrame = row * sprite.frames + frame;

        if (sprite.regions) {
            let regionIndex = absFrame * 4;
            this._region[0] = sprite.regions[regionIndex + 0];
            this._region[1] = sprite.regions[regionIndex + 1];
            this._region[2] = sprite.regions[regionIndex + 2];
            this._region[3] = sprite.regions[regionIndex + 3];
            let trimIndex = absFrame * 2;

            if (sprite.trim) {

                this._trim[0] = sprite.trim[trimIndex + 0];
                this._trim[1] = sprite.trim[trimIndex + 1];

            } else {

                this._trim[0] = 0;
                this._trim[1] = 0;

            }

        } else {

            let fx, fy;
            if (sprite.rows) {
                fx = frame % sprite.frames;
                fy = row + frame / sprite.frames | 0;
            } else {
                let cols = sprite.texture.originalWidth / sprite.width | 0;
                fx = frame % cols;
                fy = frame / cols | 0;
            }

            this._region[0] = fx * sprite.width + (sprite.srcX || 0);
            this._region[1] = fy * sprite.height + (sprite.srcY || 0);
            this._region[2] = sprite.width;
            this._region[3] = sprite.height;
            this._trim[0] = 0;
            this._trim[1] = 0;

        }

        let palette = this.values.palette;

        if (palette < 0 && sprite.texture.paletteReady)
            palette = 0;

        program.set("texture", 0);
        program.set("paletteTexture", 1);

        program.set("palette", palette);
        program.set("creation", this.values.creation);

        program.set("rw", this._region[2]);
        program.set("rh", this._region[3]);

        program.set("alpha", this.values.alpha);
        program.set("tx", this._region[0] / sprite.texture.width);
        program.set("ty", this._region[1] / sprite.texture.height);
        program.set("tw", this._region[2] / sprite.texture.width);
        program.set("th", this._region[3] / sprite.texture.height);
        program.set("color", this.values.color.r, this.values.color.g, this.values.color.b, this.values.color.a);

        this.updateMatrix(x, y, sprite.width, sprite.height);

        Matrix3.translate(this.matrix, this._trim[0], this._trim[1]);

        program.set("modelMatrix", this.matrix);

        /* Draw */

        gl.drawArrays(gl.TRIANGLES, 0, 6);

    },

    textCache: {},

    getTextCache(text, font) {

        let key = font.id + "--" + text;

        if (!this.textCache[key]) {

            let batch = new CLIENT.ImageBatch();

            let x = 0;
            let y = 0;

            for (var i = 0; i < text.length; i++) {

                let letter = text[i];

                if (letter === "\n") {

                    y += font.height + 1;
                    x = 0;

                } else if (letter === " ") {

                    x += font.spaceWidth;

                    continue;

                }

                if (!font.regions[letter])
                    continue;

                let sprite = batch.add();
                let region = font.regions[letter];

                sprite.setSprite(region[0], region[1], region[2], region[3]);
                sprite.setRegion(x, y, region[2], region[3]);

                x += 1 + region[2];

            }

            batch.width = x - 1;
            batch.program = app.programs.text;

            this.textCache[key] = batch;

        }

        return this.textCache[key];

    },

    fillText(text, x, y) {

        let batch = this.getTextCache(text, this.values.font);

        batch.color = this.values.color;
        batch.dissolve = this.values.dissolve;
        batch.alpha = this.values.alpha;

        if (this.values.textAlign === "center")
            batch.x = x - (batch.width * this.values.scale.x) / 2 | 0;
        else if (this.values.textAlign === "right")
            batch.x = x - (batch.width * this.values.scale.x);
        else
            batch.x = x;

        batch.scale.x = this.values.scale.x;
        batch.scale.y = this.values.scale.y;

        batch.y = y | 0;

        batch.rotation = this.values.rotation;

        batch.x += this.values.translation.x;
        batch.y += this.values.translation.y;

        batch.render();

    },

    clear() {

        this.app.gl.clear(gl.COLOR_BUFFER_BIT);

    },

    fillCircle(x, y, radius) {

        let gl = this.app.gl;
        let program = this.values.program || app.programs.circle;

        /* Alpha */

        gl.enable(gl.BLEND);

        this.blending() || (gl.blendEquation(gl.FUNC_ADD),
        gl.blendFunc(this.defaultSrcBlend, gl.ONE_MINUS_SRC_ALPHA));

        /* Assign shaders */

        gl.useProgram(program.native);

        /* Position */

        gl.enableVertexAttribArray(program.locations.position);

        gl.bindBuffer(gl.ARRAY_BUFFER, this.quad);
        gl.vertexAttribPointer(program.locations.position, 2, gl.FLOAT, false, 0, 0);

        /* Texturing */

        if (this.values.texture) {

            gl.activeTexture(gl.TEXTURE0);

            gl.bindTexture(gl.TEXTURE_2D, this.values.texture);

            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

            program.set("texture", 0);

        }

        gl.enableVertexAttribArray(program.locations.uv);
        gl.bindBuffer(gl.ARRAY_BUFFER, this.quad);
        gl.vertexAttribPointer(program.locations.uv, 2, gl.FLOAT, false, 0, 0);

        program.set("radius", radius);
        program.set("inside", 0.0);
        program.set("start", 0.0);
        program.set("length", Math.PI * 2);

        program.set("color", this.values.color.r, this.values.color.g, this.values.color.b, this.values.color.a * this.values.alpha);

        this.updateMatrix(x, y, radius * 2.0, radius * 2.0);

        program.set("modelMatrix", this.matrix);

        /* Draw */

        gl.drawArrays(gl.TRIANGLES, 0, 6);

    },

    arc(x, y, inside, outside, start=0.0, length=Math.PI * 2.0) {

        let gl = this.app.gl;
        let program = this.values.program || app.programs.circle;

        /* Alpha */

        gl.enable(gl.BLEND);

        this.blending() || (gl.blendEquation(gl.FUNC_ADD),
        gl.blendFunc(this.defaultSrcBlend, gl.ONE_MINUS_SRC_ALPHA));

        /* Assign shaders */

        gl.useProgram(program.native);

        /* Position */

        gl.enableVertexAttribArray(program.locations.position);

        gl.bindBuffer(gl.ARRAY_BUFFER, this.quad);
        gl.vertexAttribPointer(program.locations.position, 2, gl.FLOAT, false, 0, 0);

        /* Texturing */

        if (this.values.texture) {

            gl.activeTexture(gl.TEXTURE0);

            gl.bindTexture(gl.TEXTURE_2D, this.values.texture);

            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

            program.set("texture", 0);

        }

        gl.enableVertexAttribArray(program.locations.uv);
        gl.bindBuffer(gl.ARRAY_BUFFER, this.quad);
        gl.vertexAttribPointer(program.locations.uv, 2, gl.FLOAT, false, 0, 0);

        program.set("start", start);
        program.set("radius", outside);
        program.set("inside", inside / outside);
        program.set("length", length);

        // this.rotate(start);

        program.set("color", this.values.color.r, this.values.color.g, this.values.color.b, this.values.color.a * this.values.alpha);

        this.updateMatrix(x, y, outside * 2.0, outside * 2.0);

        program.set("modelMatrix", this.matrix);

        /* Draw */

        gl.drawArrays(gl.TRIANGLES, 0, 6);

    },

    strokeCircle(x, y, radius, lineWidth=2.0) {

        let gl = this.app.gl;
        let program = this.values.program || app.programs.circle;

        /* Alpha */

        gl.enable(gl.BLEND);

        this.blending() || (gl.blendEquation(gl.FUNC_ADD),
        gl.blendFunc(this.defaultSrcBlend, gl.ONE_MINUS_SRC_ALPHA));

        /* Assign shaders */

        gl.useProgram(program.native);

        /* Position */

        gl.enableVertexAttribArray(program.locations.position);

        gl.bindBuffer(gl.ARRAY_BUFFER, this.quad);
        gl.vertexAttribPointer(program.locations.position, 2, gl.FLOAT, false, 0, 0);

        /* Texturing */

        if (this.values.texture) {

            gl.activeTexture(gl.TEXTURE0);

            gl.bindTexture(gl.TEXTURE_2D, this.values.texture);

            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

            program.set("texture", 0);

        }

        gl.enableVertexAttribArray(program.locations.uv);
        gl.bindBuffer(gl.ARRAY_BUFFER, this.quad);
        gl.vertexAttribPointer(program.locations.uv, 2, gl.FLOAT, false, 0, 0);

        program.set("radius", radius);
        program.set("inside", 0.5 - this.vmax * lineWidth * radius);
        program.set("start", 0.0);
        program.set("length", Math.PI * 2);

        program.set("color", this.values.color.r, this.values.color.g, this.values.color.b, this.values.color.a * this.values.alpha);

        this.updateMatrix(x, y, radius * 2.0, radius * 2.0);

        program.set("modelMatrix", this.matrix);

        /* Draw */

        gl.drawArrays(gl.TRIANGLES, 0, 6);

    },

    fillRect(x, y, w, h) {

        let gl = this.app.gl;
        let program = this.values.program || app.programs.rect;

        /* Alpha */

        gl.enable(gl.BLEND);

        this.blending() || (gl.blendEquation(gl.FUNC_ADD),
        gl.blendFunc(this.defaultSrcBlend, gl.ONE_MINUS_SRC_ALPHA));

        /* Assign shaders */

        gl.useProgram(program.native);

        /* Position */

        gl.enableVertexAttribArray(program.locations.position);
        gl.bindBuffer(gl.ARRAY_BUFFER, this.quad);
        gl.vertexAttribPointer(program.locations.position, 2, gl.FLOAT, false, 0, 0);

        gl.activeTexture(gl.TEXTURE0);
        gl.enableVertexAttribArray(program.locations.uv);

        if (this.values.repeat) {

            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);

        } else {
        // gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        // gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

        }

        gl.bindBuffer(gl.ARRAY_BUFFER, this.quad);
        gl.vertexAttribPointer(program.locations.uv, 2, gl.FLOAT, false, 0, 0);

        /* Texturing */

        program.set("width", w);
        program.set("height", h);
        program.set("color", this.values.color.r, this.values.color.g, this.values.color.b, this.values.color.a * this.values.alpha);

        this.updateMatrix(x, y, w, h);

        program.set("modelMatrix", this.matrix);

        /* Draw */

        gl.drawArrays(gl.TRIANGLES, 0, 6);

    },

    drawLine(x1, y1, x2, y2, width) {

        let distance = Utils.distance(x1, y1, x2, y2);

        this.rotate(Utils.lookAt(x1, y1, x2, y2));
        this.align(0.0, 0.5);

        this.fillRect(x1, y1, distance, width);

    },

    createFramebuffer(width, height) {

        let gl = app.gl;

        // create to render to
        let targetTextureWidth = width;
        let targetTextureHeight = height;
        let texture = gl.createTexture();

        texture.width = width;
        texture.height = height;

        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, width, height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);

        // set the filtering so we don't need mips
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

        // Create and bind the framebuffer
        let fb = gl.createFramebuffer();

        gl.bindFramebuffer(gl.FRAMEBUFFER, fb);

        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);

        fb.texture = texture;
        fb.width = width;
        fb.height = height;

        return fb;

    },

    setViewport(width, height) {

        this.width = width;
        this.height = height;

        app.gl.viewport(0, 0, this.width, this.height);

        this.vw = 1 / this.width;
        this.vh = 1 / this.height;
        this.vmax = Math.max(this.vw, this.vh);
        this.vmin = Math.min(this.vw, this.vh);

    },

    setFramebuffer(fb) {

        let gl = app.gl;

        if (!fb) {

            gl.bindFramebuffer(gl.FRAMEBUFFER, null);

            return;

        }

        // render to our targetTexture by binding the framebuffer
        gl.bindFramebuffer(gl.FRAMEBUFFER, fb);

        this.setViewport(fb.texture.width, fb.texture.height);

        // Clear the canvas AND the depth buffer.

        // gl.clearColor(0, 0, 0, 1.0);
        gl.colorMask(1.0, 1.0, 1.0, 1.0);
        // gl.clear(gl.COLOR_BUFFER_BIT);

        // const aspect = targetTextureWidth / targetTextureHeight;
        // drawCube(aspect)

    },

    textureFromCanvas(canvas) {

        let gl = this.app.gl;

        let texture = gl.createTexture();

        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, canvas);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.generateMipmap(gl.TEXTURE_2D);

        gl.bindTexture(gl.TEXTURE_2D, null);

        texture.originalWidth = texture.width = canvas.width;
        texture.originalHeight = texture.height = canvas.height;

        return texture;

    }

};

/* file: script/playground/plugins/playground.ad.js */

PLAYGROUND.Ad = function(options) {

    options = options || {};

    options.threshold = options.threshold || 3;

    this.calls = (localStorage.getItem("ad_calls") | 0) || (Math.random() * (options.threshold + 1) | 0);

}
;

PLAYGROUND.Ad.prototype = {

    threshold: 3,

    start() {

        if (app.adStart)
            app.adStart();

    },

    end() {

        if (app.adEnd)
            app.adEnd();

        if (this.onceEnded) {

            this.onceEnded();

            this.onceEnded = null;

        }

    },

    interstitial(callback) {

        this.onceEnded = callback;

        this.calls++;

        if (this.threshold === 1 || this.calls % this.threshold === 1) {

            this.requestInterstitial();

        } else {

            this.end();

        }

        localStorage.setItem("ad_calls", this.calls);

    },

    requestInterstitial() {

        this.end();

    }

};

/* file: script/lib/playground.color.js */

PLAYGROUND.Color = function(hex=0, alpha=1.0) {

    this.r = 1.0;
    this.g = 1.0;
    this.b = 1.0;
    this.a = 1.0;
    this.num = 0.0;

    this.set(hex, alpha);

}
;

PLAYGROUND.Color.prototype = {

    set(hex=0.0, alpha=1.0) {

        this.a = alpha;

        if (this.num !== hex) {

            this.num = hex;

            this.r = (hex / 65536 % 256 | 0) / 255.0;
            this.g = (hex / 256 % 256 | 0) / 255.0;
            this.b = (hex % 256) / 255.0;

        }

    }

};

PLAYGROUND.Application.prototype.color = function(hex=0, alpha=1.0) {

    return new PLAYGROUND.Color(hex,alpha);

}
;

/* file: script/lib/iog.js */

{

    /* implementation */

    let IOG = function(args) {

        this.initialState = true;

        if (window.ENV) {

            this.host = ENV.iog_host;

        }

        Object.assign(this, args);

        this.userToken = this.initialState ? this.getUserToken() : null;

        setInterval(this.trackChanges.bind(this), 1000);

        setTimeout(this.trackChanges.bind(this), 1);

    };

    IOG.prototype = {

        host: "instantonline.io",

        onLogin() {
        },

        onLogout() {
        },

        onChange() {
        },

        isLoggedIn() {

            return Boolean(this.getUserToken());

        },

        trackChanges() {

            let userToken = this.getUserToken();

            if (this.userToken === userToken)
                return;

            this.onChange();

            if (userToken)
                this.onLogin();
            else
                this.onLogout();

            this.userToken = userToken;
        },

        getCookie: function(a) {
            var b = document.cookie.match('(^|;)\\s*' + a + '\\s*=\\s*([^;]+)');
            return b ? b.pop() : '';
        },

        login(a, b) {

            let options = {};
            let callback;

            if (arguments.length === 1) {

                callback = arguments[0] || function() {}
                ;

            }

            if (arguments.length === 2) {

                Object.assign(options, arguments[0]);

                callback = arguments[1] || function() {}
                ;

            }

            let close = ()=>{

                if (!this.loginWindow)
                    return;

                document.body.removeChild(this.loginWindow);

                this.loginWindow = null;

            }

            if (this.loginWindow)
                close();

            let iframe = document.createElement("iframe");
            let src = "//" + this.host + "/widgets/login/?action=close";
            ;
            // &vurl = Buffer();

            if (options.email_redirect)
                email_redirect = encodeURIComponent()

            iframe.src = src;

            this.loginWindow = iframe;

            Object.assign(iframe.style, {
                left: "0%",
                top: "0%",
                position: "absolute",
                zIndex: 1000,
                width: "100%",
                height: "100%",
                border: "0",
            });

            document.body.appendChild(iframe);

            window.addEventListener("message", (e)=>{

                if (e.data === "LoginCancelled") {

                    close();

                }

                if (e.data === "LoginSuccessful") {

                    close();

                    if (callback)
                        callback(false, this.getUserToken());

                }

            }
            );

        },

        logout() {

            fetch("//" + this.host + "/app/logout", {
                method: "post"
            });

        },

        me() {

            return fetch("//" + this.host + "/app/me", {
                method: "get"
            }).then(function(r) {

                return r.json();

            });

        },

        getUserToken() {

            return this.getCookie("iog_secret");

        },

        promo(callback) {

            let resolve, reject;

            let result = new Promise(function(_resolve, _reject) {

                resolve = _resolve;

            }
            );

            callback = callback || function() {}
            ;

            let close = ()=>{

                if (!this.promoWindow)
                    return;

                document.body.removeChild(this.promoWindow);

                this.promoWindow = null;

            }

            if (this.promoWindow)
                close();

            let iframe = document.createElement("iframe");

            iframe.src = "//" + this.host + "/widgets/more-games/?action=close";

            this.promoWindow = iframe;

            Object.assign(iframe.style, {
                left: "0%",
                top: "0%",
                position: "absolute",
                zIndex: 1000,
                width: "100%",
                height: "100%",
                border: "0",
            });

            document.body.appendChild(iframe);

            window.addEventListener("message", (e)=>{

                close();

                resolve(e.data);

            }
            );

            return result;

        },

        getUserBarWidget(options={}) {

            let iframe = document.createElement("iframe");

            let src = "//" + this.host + "/widgets/user-bar?";

            if (options.theme)
                src += "theme=" + options.theme + "&";

            iframe.src = src;
            iframe.classList.add("iog-userbar-widget")
            Object.assign(iframe.style, {
                border: "0"
            });

            window.addEventListener("message", (e)=>{

                if (e.data === "login") {

                    this.login();

                }

            }
            );

            return iframe;

        }

    };

    window.InstantOnlineGaming = IOG;

}

/* file: script/lib/Motion.js */

/* file: src/Motion.js */

Motion = class {

    constructor(options) {
        this.images = {};
        this.json = {};

        this.lifetime = 0.0;

        options = Object.assign({
            smoothing: true
        }, options);

        this.options = options;

        this.events = new Motion.Events();
        this.elapsed = 0;

        this.spottedMarks = {};
        this.index = 0;
        this.rate = 1.0;
        this.rotation = 0.0;
        this.firstTime = true;
        this.scaleX = 1.0;
        this.scaleY = 1.0;

        this.scheduledItems = [];

        this.entities = [];

        this.canvas = document.createElement("canvas");
        this.ctx = this.canvas.getContext("2d");

        document.body.appendChild(this.canvas);

        this.canvas.width = options.width || window.innerWidth;
        this.canvas.height = options.height || window.innerHeight;

        Object.assign(this.canvas.style, {
            left: "0px",
            top: "0px",
            position: "absolute",
            zIndex: 1000,
            pointerEvents: "none"
        });

        if (options.center) {
            Object.assign(this.canvas.style, {
                left: "50%",
                top: "50%",
                transform: "translate(-50%, -50%)",
                transforOrigin: "50% 50%",
                position: "absolute",
                zIndex: 1000,
                pointerEvents: "none"
            });
        }

        let aspect = this.canvas.width / this.canvas.height;

        this.top = -1.0;
        this.left = -aspect;
        this.right = aspect;
        this.bottom = 1.0;

        this.width = Math.abs(this.left - this.right);
        this.height = Math.abs(this.top - this.bottom);

        this.tweens = new Motion.TweenManager;
        this.tween = this.tweens.tween.bind(this.tweens);

        this.dead = false;
        let prevTime = Date.now();

        let loop = ()=>{

            let dt = (Date.now() - prevTime) / 1000;
            prevTime = Date.now();

            this.step(dt);
            this.render(this.ctx);

            this.events.trigger("step", dt);

            if (!this.dead)
                requestAnimationFrame(loop);

        }

        requestAnimationFrame(loop);

        this.filters = [];

    }

    updateContext() {

        if (this.options.smoothing === false)
            this.ctx.imageSmoothingEnabled = false;

    }

    playSound(file) {

        if (this.skippingTo)
            return;

        return this._playSound(file);

    }

    _playSound(file) {

        return (new Motion.Audio(file)).play();

    }

    loadVideo(src) {

        let promise = Motion.promise();

        let video = document.createElement("video");

        video.addEventListener("canplaythrough", ()=>{

            promise.resolve(video);

        }
        )

        video.src = src;

        return promise;

    }

    loadFont(name, url) {

        if (Motion.fonts[name])
            return Motion.fonts[name];

        let fontFace = new FontFace(name,`url(${url})`);

        Motion.fonts[name] = fontFace.load();

        Motion.fonts[name].then(function(loaded_face) {

            document.fonts.add(loaded_face);

        }).catch(function(error) {

            console.warning("Error loading font", name, url);

        });

        return Motion.fonts[name];

    }

    step(dt) {

        dt *= this.rate;

        this.elapsed = dt;
        this.lifetime += dt;

        this.tweens.step(dt);

        for (let entity of this.entities) {

            if (entity.step)
                entity.step(dt);

            if (entity.lifespan > 0) {

                entity.lifespan -= dt;

                if (entity.lifespan <= 0)
                    this.remove(entity);

            }

        }

        for (let item of this.scheduledItems) {

            item.step(dt);

        }

    }

    render(ctx) {

        if (this.needSort)
            this.sort();

        this.canvas.width += 0;

        this.updateContext();

        let scale = Math.min(this.canvas.width, this.canvas.height);

        // let paddingLeft = (this.canvas.width - this.canvas.width * scale) / 2
        let aspect = this.canvas.width / this.canvas.height;

        let paddingLeft = (this.canvas.width - this.canvas.width / aspect) / 2;

        ctx.save();
        ctx.translate(paddingLeft, 0);

        ctx.scale(scale, scale);
        ctx.translate(0.5, 0.5);
        ctx.scale(0.5, 0.5);
        ctx.scale(this.scaleX, this.scaleY);

        ctx.rotate(this.rotation)
        for (let entity of this.entities) {
            ctx.save();
            ctx.translate(entity.x, entity.y);
            ctx.rotate(entity.rotation);
            ctx.translate(-entity.alignX * entity.width * 0.5 * entity.scaleX * entity.scale, -entity.alignY * entity.height * 0.5 * entity.scaleY * entity.scale);
            ctx.scale(entity.scale, entity.scale);
            ctx.scale(entity.scaleX, entity.scaleY);
            ctx.globalAlpha = entity.alpha;
            if (entity.blend)
                ctx.globalCompositeOperation = entity.blend;

            let filter = "";

            if (entity.blur)
                filter += 'blur(' + entity.blur + 'px) ';
            if (entity.brightness !== 1.0)
                filter += ctx.filter = ' brightness(' + entity.brightness * 100 + '%)';
            if (entity.saturation !== 1.0)
                filter += ctx.filter = ' saturate(' + entity.saturation * 100 + '%)';
            if (entity.hueRotation !== 0.0)
                filter += ctx.filter = ' hue-rotate(' + entity.hueRotation + 'rad)';

            if (filter)
                ctx.filter = filter;

            if (entity.render)
                entity.render(this.ctx);

            ctx.restore();

        }

        ctx.restore();

        for (let filter of this.filters) {

            filter.render(ctx);

        }

    }

    sound(src) {

        return this.schedule(()=>{
            this.playSound(src);
        }
        );

    }

    wait(duration) {

        return this.schedule(Motion.emptyFunction, duration);

    }

    sustain(callback, duration) {

        return this.schedule({
            step: callback
        }, duration);

    }

    schedule(callback, duration=0.0) {

        if (typeof callback === "function")
            callback = {
                start: callback
            };

        let item = new Motion.ScheduledItem(this,callback,duration);

        this.run(item);

        return item;

    }

    sort() {

        this.entities.sort(this.compareZIndex);

    }

    compareZIndex(a, b) {

        var comp = (a.zIndex | 0) - (b.zIndex | 0);

        if (comp === 0)
            return a.index - b.index;
        else
            return comp;

    }

    loadImage(src) {

        if (!this.images[src]) {
            let image = new Image;

            image.addEventListener("load", ()=>{
                image.ready = true
            }
            );
            image.src = src;

            this.images[src] = image;

        }

        return this.images[src];

    }

    loadJSON(src) {

        if (!this.json[src]) {

            let json = {
                ready: false
            };

            fetch(src).then((r)=>{

                return r.json();

            }
            ).then((data)=>{

                Object.assign(json, data);
                json.ready = true;

            }
            );

            this.json[src] = json;

        }

        return this.json[src];

    }

    add(entity, args) {

        if (typeof entity === "string")
            entity = new Motion[entity](args);

        entity.index = this.index++;

        this.needSort = true;

        this.entities.push(entity);

        entity.manager = this;

        return entity;

    }

    remove(entity) {

        Motion.pullOne(this.entities, entity);

    }

    run(item) {

        this.remove(item);

        this.scheduledItems.push(item);

    }

    unschedule(item) {

        Motion.pullOne(this.scheduledItems, item);

    }

    kill() {

        this.dead = true;
        this.entities.length = 0;

        document.body.removeChild(this.canvas);

    }

    skip(to) {

        this.skippingTo = to;

        while (this.skippingTo) {

            this.step(0.1);

            if (this.spottedMarks[to])
                this.skippingTo = false;

        }

    }

    stopSkipping() {

        this.skippingTo = null;

    }

    mark(label) {

        this.spottedMarks[label] = true;

        if (this.skippingTo === label)
            this.stopSkipping();

        this.events.trigger("mark/" + label);

    }

}
;

Motion.ScheduledItem = class {

    constructor(manager, callback, duration) {

        this.delay = 0.0;
        this.elapsed = 0;
        this.progress = 0;
        this.callback = callback;
        this.duration = duration;
        this.queue = [];
        this.finished = false;
        this.manager = manager;
        this.firstTime = true;
    }

    execute() {

        if (this.callback.stop)
            this.callback.stop();

        for (let item of this.queue) {

            item.run();

        }

        this.manager.remove(this);

    }

    step(dt) {

        if (this.delay > 0)
            return this.delay -= dt;

        if (this.finished)
            return;

        if (this.firstTime && this.callback.start) {
            this.firstTime = false;
            this.callback.start(this);

        }

        this.elapsed = Math.min(this.elapsed + dt, this.duration);
        this.progress = this.elapsed / this.duration;

        // console.log(dt, this.elapsed, this.duration)

        if (this.elapsed >= this.duration) {

            this.finished = true;
            this.execute();

        }

        if (this.callback.step)
            this.callback.step(this);

    }

    render(ctx) {

        if (this.callback.render)
            this.callback.render(ctx);

    }

    wait(duration) {

        return this.schedule(Motion.emptyFunction, duration);

    }

    sound(src) {

        return this.schedule(()=>{
            this.manager.playSound(src);
        }
        );

    }

    schedule(callback, duration=0.0) {

        if (typeof callback === "function")
            callback = {
                start: callback
            };

        let item = new Motion.ScheduledItem(this.manager,callback,duration);

        if (this.finished) {

            item.execute();

        } else {

            this.queue.push(item);

        }

        return item;
    }

    run() {

        this.manager.run(this);

    }

}
;

Motion.pullOne = function(array, item) {

    let index = array.indexOf(item);

    if (index < 0)
        return;

    array.splice(index, 1);

}
;

Motion.emptyFunction = function() {}
;

Motion.fonts = {};

/* file: src/Entity.js */

Motion.Entity = class {

    constructor() {

        this.blur = 0;
        this.brightness = 1.0;
        this.saturation = 1.0;
        this.hueRotation = 0.0;
        this.x = 0;
        this.y = 0;
        this.alpha = 1.0;
        this.scale = 1.0;
        this.scaleX = 1.0;
        this.scaleY = 1.0;
        this.rotation = 0.0;
        this.zIndex = 0;
        this.lifespan = 0.0;
        this.alignX = 0.0;
        this.alignY = 0.0;
        this.width = 2.0;
        this.height = 2.0;

    }

    remove() {

        this.manager.remove(this);

    }

    tween(props, duration, easing) {

        return this.manager.tween(this).to(props, duration, easing);

    }

    to(props, duration, easing) {

        return this.manager.tween(this).to(props, duration, easing);

    }

}
;

/* file: src/Audio.js */

Motion.Audio = class {

    constructor(src) {

        let format;

        if (src.indexOf(".mp3") > -1)
            format = "mp3";
        if (src.indexOf(".ogg") > -1)
            format = "ogg";

        if (format) {

            this.audio = new Audio(src);

        } else {

            this.audio = new Audio(src + "." + Motion.Audio.audioFormat);

        }

    }

    play() {

        requestAnimationFrame(()=>{

            this.audio.play();

        }
        );

        return this;

    }

    volume(volume) {

        this.audio.volume = volume;

        return this;

    }

    rate(rate) {

        this.audio.playbackRate = rate;

        return this;

    }

}
;

Motion.Audio.preferedAudioFormat = "ogg";

(function(object) {

    var canPlayMp3 = (new Audio).canPlayType("audio/mp3");
    var canPlayOgg = (new Audio).canPlayType('audio/ogg; codecs="vorbis"');

    if (object.preferedAudioFormat === "mp3") {

        if (canPlayMp3)
            object.audioFormat = "mp3";
        else
            object.audioFormat = "ogg";

    } else {

        if (canPlayOgg)
            object.audioFormat = "ogg";
        else
            object.audioFormat = "mp3";

    }

}
)(Motion.Audio);

/* file: src/Circle.js */

Motion.Circle = class extends Motion.Entity {

    constructor(args) {

        super(args);

        this.color = "#000";

        Object.assign(this, args);

    }

    render(ctx) {

        ctx.fillStyle = this.color;
        ctx.beginPath();
        // ctx.scale(1.25, 1.0);
        ctx.arc(0, 0, 1.0, 0, Math.PI * 2);
        ctx.fill();

    }

}
;

/* file: src/Color.js */

Motion.Color = function(data, type) {

    if (arguments.length)
        this.parse(data, type);

}
;

Motion.Color.prototype = {

    toString: function() {

        return this.toRgb();

    },

    parse: function(args, type) {

        if (args[0]instanceof Motion.Color) {
            this[0] = args[0][0];
            this[1] = args[0][1];
            this[2] = args[0][2];
            this[3] = args[0][3];
            return;
        }

        if (typeof args === "string") {

            var match = null;

            if (args[0] === "#") {
                var rgb = this.hexToRgb(args);
                this[0] = rgb[0];
                this[1] = rgb[1];
                this[2] = rgb[2];
                this[3] = 1.0;
            } else if (match = args.match(/rgb\((.*),(.*),(.*)\)/)) {
                this[0] = match[1] | 0;
                this[1] = match[2] | 0;
                this[2] = match[3] | 0;
                this[3] = 1.0;
            } else if (match = args.match(/rgba\((.*),(.*),(.*)\)/)) {
                this[0] = match[1] | 0;
                this[1] = match[2] | 0;
                this[2] = match[3] | 0;
                this[3] = match[4] | 0;
            } else if (match = args.match(/hsl\((.*),(.*),(.*)\)/)) {
                this.fromHsl(match[1], match[2], match[3]);
            } else if (match = args.match(/hsv\((.*),(.*),(.*)\)/)) {
                this.fromHsv(match[1], match[2], match[3]);
            }
        } else {
            switch (type) {
            case "hsl":
            case "hsla":

                this.fromHsl(args[0], args[1], args[2], args[3]);
                break;

            case "hsv":
            case "hsva":

                this.fromHsv(args[0], args[1], args[2], args[3]);
                break;

            default:
                this[0] = args[0];
                this[1] = args[1];
                this[2] = args[2];
                this[3] = typeof args[3] === "undefined" ? 1.0 : args[3];
                break;
            }
        }
    },

    a: function(a) {

        if (arguments.length === 1) {

            this[3] = a;

        } else {

            return this[3];

        }

        return this;

    },

    alpha: function(a) {

        if (arguments.length === 1) {

            this[3] = a;

        } else {

            return this[3];

        }

        return this;

    },

    fromHsl: function() {
        var components = arguments[0]instanceof Array ? arguments[0] : arguments;

        var color = this.hslToRgb(parseFloat(components[0]), parseFloat(components[1]), parseFloat(components[2]));

        this[0] = color[0];
        this[1] = color[1];
        this[2] = color[2];
        this[3] = typeof arguments[3] === "undefined" ? 1.0 : arguments[3];
    },

    fromHsv: function() {
        var components = arguments[0]instanceof Array ? arguments[0] : arguments;
        var color = this.hsvToRgb(parseFloat(components[0]), parseFloat(components[1]), parseFloat(components[2]));

        this[0] = color[0];
        this[1] = color[1];
        this[2] = color[2];
        this[3] = typeof arguments[3] === "undefined" ? 1.0 : arguments[3];
    },

    toArray: function() {
        return [this[0], this[1], this[2], this[3]];
    },

    toRgb: function() {
        return "rgb(" + this[0] + ", " + this[1] + ", " + this[2] + ")";
    },

    toRgba: function() {
        return "rgba(" + this[0] + ", " + this[1] + ", " + this[2] + ", " + this[3] + ")";
    },

    toHex: function() {
        return this.rgbToHex(this[0], this[1], this[2]);
    },

    toHsl: function() {
        var c = this.rgbToHsl(this[0], this[1], this[2]);
        c[3] = this[3];
        return c;
    },

    toHsv: function() {
        var c = this.rgbToHsv(this[0], this[1], this[2]);
        c[3] = this[3];
        return c;
    },

    shiftHsl: function() {
        var hsl = this.toHsl();

        if (this[0] !== this[1] || this[1] !== this[2]) {
            var h = arguments[0] === false ? hsl[0] : this.wrapValue(hsl[0] + arguments[0], 0, 1);
            var s = arguments[1] === false ? hsl[1] : this.limitValue(hsl[1] + arguments[1], 0, 1);
        } else {
            var h = hsl[0];
            var s = hsl[1];
        }

        var l = arguments[2] === false ? hsl[2] : this.limitValue(hsl[2] + arguments[2], 0, 1);

        this.fromHsl(h, s, l);

        return this;
    },

    setHsl: function() {
        var hsl = this.toHsl();

        var h = arguments[0] === false ? hsl[0] : this.limitValue(arguments[0], 0, 1);
        var s = arguments[1] === false ? hsl[1] : this.limitValue(arguments[1], 0, 1);
        var l = arguments[2] === false ? hsl[2] : this.limitValue(arguments[2], 0, 1);

        this.fromHsl(h, s, l);

        return this;
    },

    mix: function(color, amount) {

        color = Motion.color(color);

        for (var i = 0; i < 4; i++) {

            this[i] = this.mix(this[i], color[i], amount);

        }

        return this;

    },

    wrapValue: function(value, min, max) {
        if (value < min)
            return max + (value % max);
        if (value >= max)
            return value % max;
        return value;
    },

    limitValue: function(value, min, max) {
        return value < min ? min : value > max ? max : value;
    },

    mix: function(a, b, amount) {
        return a + (b - a) * amount;
    },

    hexToRgb: function(hex) {
        if (hex.length === 7)
            return ['0x' + hex[1] + hex[2] | 0, '0x' + hex[3] + hex[4] | 0, '0x' + hex[5] + hex[6] | 0];
        else
            return ['0x' + hex[1] + hex[1] | 0, '0x' + hex[2] + hex[2] | 0, '0x' + hex[3] + hex[3] | 0];
    },

    rgbToHex: function(r, g, b) {
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1, 7);
    },

    /* author: http://mjijackson.com/ */

    rgbToHsl: function(r, g, b) {

        if (r instanceof Array) {
            b = r[2];
            g = r[1];
            r = r[0];
        }

        r /= 255,
        g /= 255,
        b /= 255;
        var max = Math.max(r, g, b)
          , min = Math.min(r, g, b);
        var h, s, l = (max + min) / 2;

        if (max == min) {
            h = s = 0;
            // achromatic
        } else {
            var d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
            case r:
                h = (g - b) / d + (g < b ? 6 : 0);
                break;
            case g:
                h = (b - r) / d + 2;
                break;
            case b:
                h = (r - g) / d + 4;
                break;
            }
            h /= 6;
        }

        return [h, s, l];
    },

    /* author: http://mjijackson.com/ */

    hue2rgb: function(p, q, t) {
        if (t < 0)
            t += 1;
        if (t > 1)
            t -= 1;
        if (t < 1 / 6)
            return p + (q - p) * 6 * t;
        if (t < 1 / 2)
            return q;
        if (t < 2 / 3)
            return p + (q - p) * (2 / 3 - t) * 6;
        return p;
    },

    hslToRgb: function(h, s, l) {
        var r, g, b;

        if (s == 0) {
            r = g = b = l;
            // achromatic
        } else {

            var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            var p = 2 * l - q;
            r = this.hue2rgb(p, q, h + 1 / 3);
            g = this.hue2rgb(p, q, h);
            b = this.hue2rgb(p, q, h - 1 / 3);
        }

        return [r * 255 | 0, g * 255 | 0, b * 255 | 0];
    },

    rgbToHsv: function(r, g, b) {
        if (r instanceof Array) {
            b = r[2];
            g = r[1];
            r = r[0];
        }

        r = r / 255,
        g = g / 255,
        b = b / 255;
        var max = Math.max(r, g, b)
          , min = Math.min(r, g, b);
        var h, s, v = max;

        var d = max - min;
        s = max == 0 ? 0 : d / max;

        if (max == min) {
            h = 0;
            // achromatic
        } else {
            switch (max) {
            case r:
                h = (g - b) / d + (g < b ? 6 : 0);
                break;
            case g:
                h = (b - r) / d + 2;
                break;
            case b:
                h = (r - g) / d + 4;
                break;
            }
            h /= 6;
        }

        return [h, s, v];
    },

    hsvToRgb: function(h, s, v) {
        var r, g, b;

        var i = Math.floor(h * 6);
        var f = h * 6 - i;
        var p = v * (1 - s);
        var q = v * (1 - f * s);
        var t = v * (1 - (1 - f) * s);

        switch (i % 6) {
        case 0:
            r = v,
            g = t,
            b = p;
            break;
        case 1:
            r = q,
            g = v,
            b = p;
            break;
        case 2:
            r = p,
            g = v,
            b = t;
            break;
        case 3:
            r = p,
            g = q,
            b = v;
            break;
        case 4:
            r = t,
            g = p,
            b = v;
            break;
        case 5:
            r = v,
            g = p,
            b = q;
            break;
        }

        return [r * 255, g * 255, b * 255];
    },

};

Motion.color = function() {

    var result = new Motion.Color();

    result.parse(arguments[0], arguments[1]);

    return result;

}
;

/* file: src/Easing.js */

(function() {

    var ease = function(progress, easing) {

        if (typeof ease.cache[easing] === "function") {

            return ease.cache[easing](progress);

        } else {

            return ease.spline(progress, easing || ease.defaultEasing);

        }

    };

    var extend = function() {
        for (var i = 1; i < arguments.length; i++) {
            for (var j in arguments[i]) {
                arguments[0][j] = arguments[i][j];
            }
        }

        return arguments[0];
    };

    extend(ease, {

        defaultEasing: "016",

        cache: {

            linear: function(t) {
                return t
            },

            inQuad: function(t) {
                return t * t
            },
            outQuad: function(t) {
                return t * (2 - t)
            },
            inOutQuad: function(t) {
                return t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t
            },
            inCubic: function(t) {
                return t * t * t
            },
            outCubic: function(t) {
                return (--t) * t * t + 1
            },
            inOutCubic: function(t) {
                return t < .5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1
            },
            inQuart: function(t) {
                return t * t * t * t
            },
            outQuart: function(t) {
                return 1 - (--t) * t * t * t
            },
            inOutQuart: function(t) {
                return t < .5 ? 8 * t * t * t * t : 1 - 8 * (--t) * t * t * t
            },
            inQuint: function(t) {
                return t * t * t * t * t
            },
            outQuint: function(t) {
                return 1 + (--t) * t * t * t * t
            },
            inOutQuint: function(t) {
                return t < .5 ? 16 * t * t * t * t * t : 1 + 16 * (--t) * t * t * t * t
            },
            inSine: function(t) {
                return -1 * Math.cos(t / 1 * (Math.PI * 0.5)) + 1;
            },
            outSine: function(t) {
                return Math.sin(t / 1 * (Math.PI * 0.5));
            },
            inOutSine: function(t) {
                return -1 / 2 * (Math.cos(Math.PI * t) - 1);
            },
            inExpo: function(t) {
                return (t == 0) ? 0 : Math.pow(2, 10 * (t - 1));
            },
            outExpo: function(t) {
                return (t == 1) ? 1 : (-Math.pow(2, -10 * t) + 1);
            },
            inOutExpo: function(t) {
                if (t == 0)
                    return 0;
                if (t == 1)
                    return 1;
                if ((t /= 1 / 2) < 1)
                    return 1 / 2 * Math.pow(2, 10 * (t - 1));
                return 1 / 2 * (-Math.pow(2, -10 * --t) + 2);
            },
            inCirc: function(t) {
                return -1 * (Math.sqrt(1 - t * t) - 1);
            },
            outCirc: function(t) {
                return Math.sqrt(1 - (t = t - 1) * t);
            },
            inOutCirc: function(t) {
                if ((t /= 1 / 2) < 1)
                    return -1 / 2 * (Math.sqrt(1 - t * t) - 1);
                return 1 / 2 * (Math.sqrt(1 - (t -= 2) * t) + 1);
            },
            inElastic: function(t) {
                var s = 1.70158;
                var p = 0;
                var a = 1;
                if (t == 0)
                    return 0;
                if (t == 1)
                    return 1;
                if (!p)
                    p = 0.3;
                if (a < 1) {
                    a = 1;
                    var s = p / 4;
                } else
                    var s = p / (2 * Math.PI) * Math.asin(1 / a);
                return -(a * Math.pow(2, 10 * (t -= 1)) * Math.sin((t - s) * (2 * Math.PI) / p));
            },
            outElastic: function(t) {
                var s = 1.70158;
                var p = 0;
                var a = 1;
                if (t == 0)
                    return 0;
                if (t == 1)
                    return 1;
                if (!p)
                    p = 0.3;
                if (a < 1) {
                    a = 1;
                    var s = p / 4;
                } else
                    var s = p / (2 * Math.PI) * Math.asin(1 / a);
                return a * Math.pow(2, -10 * t) * Math.sin((t - s) * (2 * Math.PI) / p) + 1;
            },
            inOutElastic: function(t) {
                var s = 1.70158;
                var p = 0;
                var a = 1;
                if (t == 0)
                    return 0;
                if ((t /= 1 / 2) == 2)
                    return 1;
                if (!p)
                    p = (0.3 * 1.5);
                if (a < 1) {
                    a = 1;
                    var s = p / 4;
                } else
                    var s = p / (2 * Math.PI) * Math.asin(1 / a);
                if (t < 1)
                    return -.5 * (a * Math.pow(2, 10 * (t -= 1)) * Math.sin((t - s) * (2 * Math.PI) / p));
                return a * Math.pow(2, -10 * (t -= 1)) * Math.sin((t - s) * (2 * Math.PI) / p) * 0.5 + 1;
            },
            inBack: function(t, s) {
                if (s == undefined)
                    s = 1.70158;
                return 1 * t * t * ((s + 1) * t - s);
            },
            outBack: function(t, s) {
                if (s == undefined)
                    s = 1.70158;
                return 1 * ((t = t / 1 - 1) * t * ((s + 1) * t + s) + 1);
            },
            inOutBack: function(t, s) {
                if (s == undefined)
                    s = 1.70158;
                if ((t /= 1 / 2) < 1)
                    return 1 / 2 * (t * t * (((s *= (1.525)) + 1) * t - s));
                return 1 / 2 * ((t -= 2) * t * (((s *= (1.525)) + 1) * t + s) + 2);
            },
            inBounce: function(t) {
                return 1 - this.outBounce(1 - t);
            },
            outBounce: function(t) {
                if ((t /= 1) < (1 / 2.75)) {
                    return (7.5625 * t * t);
                } else if (t < (2 / 2.75)) {
                    return (7.5625 * (t -= (1.5 / 2.75)) * t + .75);
                } else if (t < (2.5 / 2.75)) {
                    return (7.5625 * (t -= (2.25 / 2.75)) * t + .9375);
                } else {
                    return (7.5625 * (t -= (2.625 / 2.75)) * t + .984375);
                }
            },
            inOutBounce: function(t) {
                if (t < 1 / 2)
                    return this.inBounce(t * 2) * 0.5;
                return this.outBounce(t * 2 - 1) * 0.5 + 0.5;
            }
        },

        translateEasing: function(key) {

            if (!this.cache[key]) {
                var array = key.split('');

                var sign = 1;
                var signed = false;
                var trimming = false;

                for (var i = 0; i < array.length; i++) {

                    var char = array[i];

                    if (char === "-") {
                        sign = -1;
                        signed = true;
                        array.splice(i--, 1);
                    } else if (char === "+") {
                        sign = 1;
                        array.splice(i--, 1);
                    } else if (char === "t") {
                        trimming = !trimming;
                        array.splice(i--, 1);
                    } else
                        array[i] = parseInt(array[i], 16) * sign;

                }

                var min = Math.min.apply(null, array);
                var max = Math.max.apply(null, array);
                var diff = max - min;
                var cache = [];
                var normalized = [];

                for (var i = 0; i < array.length; i++) {

                    if (signed) {

                        var diff = Math.max(Math.abs(min), Math.abs(max))
                        var value = array[i] / diff;

                    } else {

                        var diff = max - min;
                        var value = (array[i] - min) / diff;

                    }

                    if (trimming) {

                        if (value < 0)
                            value = 0;
                        if (value > 1.0)
                            value = 1.0;

                    }

                    normalized.push(value);

                }

                this.cache[key] = normalized;

            }

            return this.cache[key]

        },

        splineK: {},
        splineX: {},
        splineY: {},

        insertIntermediateValues: function(a) {
            var result = [];
            for (var i = 0; i < a.length; i++) {
                result.push(a[i]);

                if (i < a.length - 1)
                    result.push(a[i + 1] + (a[i] - a[i + 1]) * 0.6);
            }

            return result;
        },

        spline: function(x, key) {

            if (!this.splineK[key]) {

                var xs = [];
                var ys = this.translateEasing(key);

                // ys = this.insertIntermediateValues(ys);

                if (!ys.length)
                    return 0;

                for (var i = 0; i < ys.length; i++)
                    xs.push(i * (1 / (ys.length - 1)));

                var ks = xs.map(function() {
                    return 0
                });

                ks = this.getNaturalKs(xs, ys, ks);

                this.splineX[key] = xs;
                this.splineY[key] = ys;
                this.splineK[key] = ks;

            }

            if (x > 1)
                return this.splineY[key][this.splineY[key].length - 1];

            var ks = this.splineK[key];
            var xs = this.splineX[key];
            var ys = this.splineY[key];

            var i = 1;

            while (xs[i] < x)
                i++;

            var t = (x - xs[i - 1]) / (xs[i] - xs[i - 1]);
            var a = ks[i - 1] * (xs[i] - xs[i - 1]) - (ys[i] - ys[i - 1]);
            var b = -ks[i] * (xs[i] - xs[i - 1]) + (ys[i] - ys[i - 1]);
            var q = (1 - t) * ys[i - 1] + t * ys[i] + t * (1 - t) * (a * (1 - t) + b * t);

            /*
      var py = ys[i - 2];
      var cy = ys[i - 1];
      var ny = (i < ys.length - 1) ? ys[i] : ys[i - 1];

      if (q > ny) {
        var diff = (q - py);
        //q = py + diff;

      }

    if (cy === ny && cy === py) q = py;
    */

            return q;
        },

        getNaturalKs: function(xs, ys, ks) {
            var n = xs.length - 1;
            var A = this.zerosMat(n + 1, n + 2);

            for (var i = 1; i < n; i++) // rows
            {
                A[i][i - 1] = 1 / (xs[i] - xs[i - 1]);
                A[i][i] = 2 * (1 / (xs[i] - xs[i - 1]) + 1 / (xs[i + 1] - xs[i]));
                A[i][i + 1] = 1 / (xs[i + 1] - xs[i]);
                A[i][n + 1] = 3 * ((ys[i] - ys[i - 1]) / ((xs[i] - xs[i - 1]) * (xs[i] - xs[i - 1])) + (ys[i + 1] - ys[i]) / ((xs[i + 1] - xs[i]) * (xs[i + 1] - xs[i])));
            }

            A[0][0] = 2 / (xs[1] - xs[0]);
            A[0][1] = 1 / (xs[1] - xs[0]);
            A[0][n + 1] = 3 * (ys[1] - ys[0]) / ((xs[1] - xs[0]) * (xs[1] - xs[0]));

            A[n][n - 1] = 1 / (xs[n] - xs[n - 1]);
            A[n][n] = 2 / (xs[n] - xs[n - 1]);
            A[n][n + 1] = 3 * (ys[n] - ys[n - 1]) / ((xs[n] - xs[n - 1]) * (xs[n] - xs[n - 1]));

            return this.solve(A, ks);
        },

        solve: function(A, ks) {
            var m = A.length;
            for (var k = 0; k < m; k++) // column
            {
                // pivot for column
                var i_max = 0;
                var vali = Number.NEGATIVE_INFINITY;
                for (var i = k; i < m; i++)
                    if (A[i][k] > vali) {
                        i_max = i;
                        vali = A[i][k];
                    }
                this.splineSwapRows(A, k, i_max);

                // for all rows below pivot
                for (var i = k + 1; i < m; i++) {
                    for (var j = k + 1; j < m + 1; j++)
                        A[i][j] = A[i][j] - A[k][j] * (A[i][k] / A[k][k]);
                    A[i][k] = 0;
                }
            }
            for (var i = m - 1; i >= 0; i--) // rows = columns
            {
                var v = A[i][m] / A[i][i];
                ks[i] = v;
                for (var j = i - 1; j >= 0; j--) // rows
                {
                    A[j][m] -= A[j][i] * v;
                    A[j][i] = 0;
                }
            }
            return ks;
        },

        zerosMat: function(r, c) {
            var A = [];
            for (var i = 0; i < r; i++) {
                A.push([]);
                for (var j = 0; j < c; j++)
                    A[i].push(0);
            }
            return A;
        },

        splineSwapRows: function(m, k, l) {
            var p = m[k];
            m[k] = m[l];
            m[l] = p;
        }
    });

    Motion.ease = ease;

}
)();

/* file: src/Events.js */

Motion.Events = function() {

    this.listeners = {};

}
;

Motion.Events.prototype = {

    on: function(event, callback) {

        if (typeof event === "object") {

            var result = {};

            for (var key in event) {

                result[key] = this.on(key, event[key])

            }

            return result;

        }

        if (!this.listeners[event])
            this.listeners[event] = [];

        var listener = {
            once: false,
            callback: callback
        };

        this.listeners[event].push(listener);

        return listener;
    },

    once: function(event, callback) {

        if (typeof event === "object") {
            var result = {};
            for (var key in event) {
                result[key] = this.once(key, event[key])
            }
            return result;
        }

        if (!this.listeners[event])
            this.listeners[event] = [];

        var listener = {
            once: true,
            callback: callback
        };

        this.listeners[event].push(listener);

        return listener;
    },

    off: function(event, callback) {

        for (var i = 0, len = this.listeners[event].length; i < len; i++) {

            if (this.listeners[event][i]._remove) {

                this.listeners[event].splice(i--, 1);
                len--;

            }

        }

    },

    emit(event, a, b, c) {

        return this.trigger(event, a, b, c);

    },

    trigger: function(event, a, b, c) {

        if (event.indexOf("/") > -1) {

            let path = event.split("/");

            let listeners = this.listeners[path[0] + "/"];

            if (listeners) {

                for (var i = 0, len = listeners.length; i < len; i++) {

                    var listener = listeners[i];

                    // listener.callback.call(listener.context || this, event, a, b, c);
                    listener.callback(event, a, b, c);

                }

            }

        }

        /* or subscribed to  a single event */

        if (this.listeners[event]) {

            for (var i = 0, len = this.listeners[event].length; i < len; i++) {

                var listener = this.listeners[event][i];

                // listener.callback.call(listener.context || this, a, b, c);
                listener.callback(a, b, c);

                if (listener.once) {

                    this.listeners[event].splice(i--, 1);
                    len--;

                }

            }

        }

    }

};

/* file: src/Image.js */

Motion.Image = class extends Motion.Entity {

    constructor(args) {

        super(args);

        Object.assign(this, args);

        this.image = new Image;
        this.image.addEventListener("load", this.onLoad.bind(this));
        this.image.src = args.src;

    }

    onLoad() {

        this.ready = true;

    }

    render(ctx) {

        if (!this.ready)
            return;

        let ar = this.image.height / this.image.width;
        ctx.scale(1.0, ar);
        ctx.drawImage(this.image, 0, 0, this.image.width, this.image.height, -1.0, -1.0, 2.0, 2.0);

    }

}
;

/* file: src/Rect.js */

Motion.Rect = class extends Motion.Entity {

    constructor(args) {

        super(args);

        this.color = "#000";

        Object.assign(this, args);

    }

    render(ctx) {

        ctx.fillStyle = this.color;
        ctx.fillRect(-1.0, -1.0, 2.0, 2.0);

    }

}
;

/* file: src/SVG.js */

Motion.SVG = class extends Motion.Entity {

    constructor(args) {

        super(args);

        this.ready = false;

        Object.assign(this, args);

        this.svg = new Image;
        this.svg.addEventListener("load", this.onLoad.bind(this));
        this.svg.src = args.src;

    }

    query(callback) {

        fetch(this.src).then((r)=>r.text()).then((txt)=>{

            let div = document.createElement('div');

            div.innerHTML = txt;

            let svg = div.firstChild;

            callback(svg);

            this.svg = new Image;
            this.svg.addEventListener("load", this.onLoad.bind(this));
            this.svg.src = 'data:image/svg+xml;utf8,' + svg.outerHTML;

        }
        );

    }

    onLoad() {

        this.ready = true;

    }

    render(ctx) {

        if (!this.ready)
            return;

        let ar = this.svg.width / this.svg.height;

        ctx.drawImage(this.svg, 0, 0, this.svg.width, this.svg.height, -1.0 * ar, -1.0, ar * 2.0, 2.0);

    }

}
;

/* file: src/Text.js */

Motion.Text = class extends Motion.Entity {

    constructor(args) {

        super(args);

        this.text = "text not set";
        this.color = "#fff";
        this.font = "Arial";
        this.shadow = false;
        this.textAlign = "center";
        this.alpha = 1.0;

        Object.assign(this, args);

    }

    render(ctx) {

        ctx.textAlign = this.textAlign;
        ctx.font = "100px " + this.font;
        ctx.textBaseline = "middle";
        ctx.scale(0.01, 0.01)
        ctx.globalAlpha = this.alpha;

        if (this.shadow) {

            ctx.fillStyle = this.shadow;
            ctx.fillText(this.text, 0.0, 10.0);

        }

        ctx.fillStyle = this.color;

        ctx.fillText(this.text, 0.0, 0.0);

    }

}
;

/* file: src/Tracker.js */

Motion.Tracker = class extends Motion.Entity {

    constructor(src, dst, props) {

        super();

        this.src = src;
        this.dst = dst;
        this.props = props;

    }

    step() {

        for (let key in this.props) {

            let def = this.props[key];

            let val = this.src[key];

            if (def.offset)
                val += def.offset;

            this.dst[key] = val;

        }

    }

}
;

/* file: src/Tween.js */

Motion.TweenManager = function() {

    this.tweens = [];

    this.delta = 0;

}
;

Motion.TweenManager.prototype = {

    defaultEasing: "128",

    /* TBD */

    circ: function(value) {

        return {
            type: "circ",
            value: value
        };

    },

    /* 

      Marks the tween for removing.
     
      The tween is actually removed in `step()` function.
     
      @param object the object associated with the tween
      @param safe if the tween located using `object` is `safe` then it is not removed.

    */

    discard: function(object, safe) {

        for (var i = 0; i < this.tweens.length; i++) {

            var tween = this.tweens[i];

            if (tween.context === object && tween !== safe)
                this.remove(tween);

        }

    },

    tween: function(context, options={}) {

        var tween = new Motion.Tween(this,context,options);

        this.add(tween);

        return tween;

    },

    /* 

      Called each frame to update logic.
     
      The function updates all active tweens and removes the ones
      tagged as such.
     
    */

    step: function(delta) {

        this.delta += delta;

        for (var i = 0; i < this.tweens.length; i++) {

            var tween = this.tweens[i];

            if (!tween.auto)
                continue;

            if (!tween._remove)
                tween.step(delta);

            if (tween._remove)
                this.tweens.splice(i--, 1);

        }

    },

    /* Add a tween to internal list. */

    add: function(tween) {

        tween._remove = false;

        var index = this.tweens.indexOf(tween);

        if (index === -1)
            this.tweens.push(tween);

    },

    /* Marks a tween for removing during next step(). */

    remove: function(tween) {

        if (tween._remove)
            return;

        tween._remove = true;

        tween.onremove();

    }

};

Motion.Tween = function(manager, context, options) {

    Motion.Events.call(this);

    this.manager = manager;
    this.context = context;
    this.auto = true;
    this.threshold = 0.0;
    this.thresholder = 0.0;

    Object.assign(this, {

        prevEasing: "linear",
        prevDuration: 0.5

    }, options);

    this.clear();

}
;

Motion.Tween.prototype = {

    manual: function() {

        this.auto = false;

        return this;

    },

    /* 

      Add an action to the end of the list
       
      @param properties
      @param duration in miliseconds (optional, default is 0.5)
      @param easing (optional, default is linear)
      @returns `this` object so that calls can be chained.

    */

    add: function(properties, duration, easing) {

        if (typeof duration !== "undefined")
            this.prevDuration = duration;
        else
            duration = 0.5;

        if (easing)
            this.prevEasing = easing;
        else
            easing = "linear";

        this.actions.push([properties, duration, easing]);

        return this;

    },

    /* Clear animations */

    clear: function() {

        this.actions = [];
        this.index = -1;
        this.current = false;

        return this;

    },

    /* Discard all other tweens associated with same context as ours */

    discard: function() {

        this.manager.discard(this.context, this);

        return this;

    },

    /* Alias for `add()` */

    to: function(properties, duration, easing) {

        return this.add(properties, duration, easing);

    },

    /* Enqueue a method call */

    call: function(methodName, context) {

        var action = ["call", methodName, context || this.context];

        for (var i = 2; i < arguments.length; i++)
            action.push(arguments[i]);

        this.actions.push(action);

        return this;

    },

    /* Mark the instance as being a repeated tween */

    loop: function() {

        this.looped = true;

        return this;

    },

    /* Add a repeat action for specified number of times */

    repeat: function(times) {

        this.actions.push(["repeat", times]);

        return this;

    },

    /* Add a wait action for specified number of miliseconds */

    wait: function(time) {

        this.actions.push(["wait", time]);

        return this;

    },

    /* Alias for `wait()` */

    delay: function(time) {

        this.actions.push(["wait", time]);

        return this;

    },

    set: function(key, val) {

        if (typeof key === "object") {

            for (let k in key) {
                this.set(k, key[k]);
            }

            return this;

        }

        this.actions.push(["set", key, val]);

        return this;

    },

    then: function(callback) {

        this.actions.push(["then", callback]);

        return this;

    },

    /* Remove this tween from the manager */

    stop: function() {

        this.manager.remove(this);

        return this;

    },

    /* Inserts the tween into the manager if not already inside. */

    play: function() {

        this.manager.add(this);

        this.finished = false;

        return this;

    },

    /* Performs last step in the animation list. */

    end: function() {

        var lastAnimationIndex = 0;

        for (var i = this.index + 1; i < this.actions.length; i++) {
            if (typeof this.actions[i][0] === "object")
                lastAnimationIndex = i;
        }

        this.index = lastAnimationIndex - 1;
        this.next();
        this.delta = this.duration;
        this.step(0);

        return this;

    },

    /* TBD */

    forward: function() {

        this.delta = this.duration;
        this.step(0);

    },

    /* TBD */

    rewind: function() {

        this.delta = 0;
        this.step(0);

    },

    /* 

      Perform one animation step
     
      Advances the index and, if the index reached the end of the
      `actions` array, either restarts it (for looped tweens) or terminates it.
     
      The function will set a string in `currentAction` indicating what it
      should be done next but it does not perform the action itself.

    */

    next: function() {

        this.delta = 0;

        this.index++;

        if (this.index >= this.actions.length) {

            if (this.looped) {

                this.trigger("loop", {
                    tween: this
                });

                this.index = 0;

            } else {

                this.manager.remove(this);

                return;

            }
        }

        this.current = this.actions[this.index];

        if (this.current[0] === "call") {

            var args = this.current.slice(2);

            var methodName = this.current[1];
            var context = this.current[2];
            var method = context[methodName];

            method.apply(context, args);
            this.next();

        } else if (this.current[0] === "set") {

            this.context[this.current[1]] = this.current[2];
            this.next();

        } else if (this.current[0] === "wait") {

            this.duration = this.current[1];
            this.currentAction = "wait";

        } else if (this.current[0] === "then") {

            this.current[1](this.context);
            this.currentAction = "then";
            this.next();

        } else {

            /* calculate changes */

            var properties = this.current[0];

            /* keep keys as array for 0.0001% performance boost */

            this.keys = Object.keys(properties);

            this.change = [];
            this.before = [];
            this.types = [];

            for (var i = 0; i < this.keys.length; i++) {

                var key = this.keys[i];
                var value = this.context[key];

                if (typeof properties[key] === "number") {

                    value = value || 0;

                    this.before.push(value);
                    this.change.push(properties[key] - value);
                    this.types.push(0);

                } else if (typeof properties[key] === "string" && properties[key].indexOf("rad") > -1) {

                    value = value || 0;

                    this.before.push(value);
                    this.change.push(Motion.circWrappedDistance(value, parseFloat(properties[key])));
                    this.types.push(2);

                } else {

                    value = value || "#000";

                    var before = Motion.color(value);

                    this.before.push(before);

                    var after = Motion.color(properties[key]);

                    var temp = [];

                    for (var j = 0; j < 3; j++) {
                        temp.push(after[j] - before[j]);
                    }

                    this.change.push(temp);

                    this.types.push(1);

                }

            }

            this.currentAction = "animate";

            this.duration = this.current[1];
            this.easing = this.current[2];

        }

    },

    /* TBD */

    prev: function() {
    },

    /* Select an action if none is current then perform required steps. */

    step: function(delta) {

        if (this.threshold && this.duration > 0) {

            this.thresholder += delta;

            if (this.thresholder < this.threshold)
                return;

            delta = this.thresholder;
            this.thresholder = 0;

        }

        this.delta += delta;

        if (!this.current)
            this.next();

        switch (this.currentAction) {

        case "animate":
            this.doAnimate(delta);
            break;

        case "wait":
            this.doWait(delta);
            break;

        }

    },

    doAnimate: function(delta) {

        this.progress = this.duration ? Math.min(1, this.delta / this.duration) : 1.0;

        var mod = Motion.ease(this.progress, this.easing);

        for (var i = 0; i < this.keys.length; i++) {

            var key = this.keys[i];

            switch (this.types[i]) {

                /* number */

            case 0:

                this.context[key] = this.before[i] + this.change[i] * mod;

                break;

                /* color */

            case 1:

                var change = this.change[i];
                var before = this.before[i];
                var color = [];

                for (var j = 0; j < 3; j++) {
                    color.push(before[j] + change[j] * mod | 0);
                }

                this.context[key] = "rgb(" + color.join(",") + ")";

                break;

                /* angle */

            case 2:

                this.context[key] = Motion.circWrap(this.before[i] + this.change[i] * mod);

                break;
            }
        }

        if (this.progress >= 1) {

            this.next();

        }

        if (this.listeners["step"]) {

            this.trigger("step", {
                tween: this,
                dt: delta
            });

        }

    },

    /* 

      Advances the animation if enough time has passed
     
      The function is called in response to `step()`; it will advance the
      index to next slot in the animation if

    */

    doWait: function(delta) {

        if (this.delta >= this.duration)
            this.next();

    },

    onremove: function() {

        this.trigger("finished", {
            tween: this
        });

        this.trigger("finish", {
            tween: this
        });

        this.finished = true;

    }

};

Object.assign(Motion.Tween.prototype, Motion.Events.prototype);

/* file: src/Utils.js */

Object.assign(Motion, {

    defaults: function() {

        for (var i = 1; i < arguments.length; i++) {

            for (var j in arguments[i]) {

                if (typeof arguments[0][j] === "undefined")
                    arguments[0][j] = arguments[i][j];

            }

        }

        return arguments[0];

    },

    promise() {

        let resolve, reject;

        let promise = new Promise(function(_resolve, _reject) {

            resolve = _resolve;
            reject = _reject;

        }
        );

        promise.resolve = resolve;
        promise.reject = reject;

        return promise;

    },

    invoke: function(object, methodName) {

        var args = Array.prototype.slice.call(arguments, 2);

        for (var i = 0; i < object.length; i++) {
            var current = object[i];

            if (current[methodName])
                current[methodName].apply(current, args);

        }

    },

    throttle: function(fn, delay) {

        var timeout;
        var last = 0;

        return function() {

            var args = [];

            for (var i = 0; i < arguments.length; i++)
                args.push(arguments[i]);

            var context = this;

            if (Date.now() - last > delay) {

                last = Date.now();

                fn.apply(context, args);

                clearTimeout(timeout);

            } else {

                clearTimeout(timeout);

                timeout = setTimeout(function() {

                    fn.apply(context, args);

                    last = Date.now();

                }, Date.now() - last);

            }

        }
        ;

    },

    wrapTo: function(value, target, max, step) {
        if (value === target)
            return target;

        var result = value;

        var d = this.wrappedDistance(value, target, max);

        if (Math.abs(d) < step)
            return target;

        result += (d < 0 ? -1 : 1) * step;

        if (result > max) {
            result = result - max;
        } else if (result < 0) {
            result = max + result;
        }

        return result;
    },

    wrap: function(value, min, max) {

        if (value < min)
            return max + (value % max);
        if (value >= max)
            return value % max;
        return value;

    },

    circWrap: function(val) {

        return this.wrap(val, 0, Math.PI * 2);

    },

    circWrapTo: function(value, target, step) {

        return this.wrapTo(value, target, Math.PI * 2, step);

    },

    wrappedDistance: function(a, b, max) {

        if (a === b)
            return 0;
        else if (a < b) {
            var l = -a - max + b;
            var r = b - a;
        } else {
            var l = b - a;
            var r = max - a + b;
        }

        if (Math.abs(l) > Math.abs(r))
            return r;
        else
            return l;

    },

    circWrappedDistance: function(a, b) {

        return this.wrappedDistance(a, b, Math.PI * 2)

    },

    ground: function(num, threshold) {

        return (num / threshold | 0) * threshold;

    },

    circDistance: function(a, b) {

        return this.circWrappedDistance(a, b)

    },

    distance: function(x1, y1, x2, y2) {

        if (arguments.length > 2) {

            var dx = x1 - x2;
            var dy = y1 - y2;

            return Math.sqrt(dx * dx + dy * dy);

        } else {

            var dx = x1.x - y1.x;
            var dy = x1.y - y1.y;

            return Math.sqrt(dx * dx + dy * dy);

        }

    },

    sprintf: function(string, replace) {

        for (var key in replace) {

            var find = new RegExp("{" + key + "}","g");

            string = string.replace(find, replace[key]);

        }

        return string;

    },

    classInParents: function(element, className) {

        var parent = element;

        while (parent) {

            if (parent.classList.contains(className)) {

                return true;

            }

            parent = parent.parentElement;

        }

        return false;

    }

});

/* file: script/lib/Matrix3.js */

var Matrix3 = {

    translate: function(matrix, x, y) {

        return this.multiply(matrix, this.translation(x, y));

    },

    scale: function(matrix, x, y) {

        return this.multiply(matrix, this.scaling(x, y));

    },

    rotate: function(matrix, x, y) {

        return this.multiply(matrix, this.rotation(x, y));

    },

    invert: function(matrix) {

        let a00 = matrix[0]
          , a01 = matrix[1]
          , a02 = matrix[2];
        let a10 = matrix[3]
          , a11 = matrix[4]
          , a12 = matrix[5];
        let a20 = matrix[6]
          , a21 = matrix[7]
          , a22 = matrix[8];
        let b01 = a22 * a11 - a12 * a21;
        let b11 = -a22 * a10 + a12 * a20;
        let b21 = a21 * a10 - a11 * a20;

        // Calculate the determinant

        let det = a00 * b01 + a01 * b11 + a02 * b21;

        if (!det) {
            return null;
        }

        det = 1.0 / det;

        matrix[0] = b01 * det;
        matrix[1] = (-a22 * a01 + a02 * a21) * det;
        matrix[2] = (a12 * a01 - a02 * a11) * det;
        matrix[3] = b11 * det;
        matrix[4] = (a22 * a00 - a02 * a20) * det;
        matrix[5] = (-a12 * a00 + a02 * a10) * det;
        matrix[6] = b21 * det;
        matrix[7] = (-a21 * a00 + a01 * a20) * det;
        matrix[8] = (a11 * a00 - a01 * a10) * det;

        return matrix;

    },

    create: function() {

        return ([1, 0, 0, 0, 1, 0, 0, 0, 1]);

    },

    reset: function(matrix) {

        matrix[0] = 1;
        matrix[1] = 0;
        matrix[2] = 0;

        matrix[3] = 0;
        matrix[4] = 1;
        matrix[5] = 0;

        matrix[6] = 0;
        matrix[7] = 0;
        matrix[8] = 1;

        return matrix;

    },

    translation: function(tx, ty) {

        return ([1, 0, 0, 0, 1, 0, tx, ty, 1, ]);

    },

    rotation: function(angleInRadians) {

        var c = Math.cos(angleInRadians);
        var s = Math.sin(angleInRadians);

        return ([c, -s, 0, s, c, 0, 0, 0, 1, ]);

    },

    scaling: function(sx, sy) {

        return ([sx, 0, 0, 0, sy, 0, 0, 0, 1, ]);

    },

    pixelate(matrix, width, height) {

        let pw = (2 / width);
        let ph = (2 / height);

        matrix[6] = Utils.ground(matrix[6], pw);
        matrix[7] = Utils.ground(matrix[7], ph);

    },

    projection: function(width, height) {

        // Note: This matrix flips the Y axis so 0 is at the top.

        return ([2 / width, 0, 0, 0, -2 / height, 0, -1, 1, 1]);

    },

    projection2: function(width, height) {

        // Note: This matrix flips the Y axis so 0 is at the top.
        return ([2 / (width / 1), 0, 0,
        0, -2 / height, 0,
        -1, 1, 1]);

    },

    trs: function(tx, ty, r, sx, sy) {

        return [sx * c, -s]

    },

    multiply: function(a, b) {

        var a00 = a[0 * 3 + 0];
        var a01 = a[0 * 3 + 1];
        var a02 = a[0 * 3 + 2];
        var a10 = a[1 * 3 + 0];
        var a11 = a[1 * 3 + 1];
        var a12 = a[1 * 3 + 2];
        var a20 = a[2 * 3 + 0];
        var a21 = a[2 * 3 + 1];
        var a22 = a[2 * 3 + 2];

        var b00 = b[0 * 3 + 0];
        var b01 = b[0 * 3 + 1];
        var b02 = b[0 * 3 + 2];
        var b10 = b[1 * 3 + 0];
        var b11 = b[1 * 3 + 1];
        var b12 = b[1 * 3 + 2];
        var b20 = b[2 * 3 + 0];
        var b21 = b[2 * 3 + 1];
        var b22 = b[2 * 3 + 2];

        a[0 * 3 + 0] = b00 * a00 + b01 * a10 + b02 * a20;
        a[0 * 3 + 1] = b00 * a01 + b01 * a11 + b02 * a21;
        a[0 * 3 + 2] = b00 * a02 + b01 * a12 + b02 * a22;
        a[1 * 3 + 0] = b10 * a00 + b11 * a10 + b12 * a20;
        a[1 * 3 + 1] = b10 * a01 + b11 * a11 + b12 * a21;
        a[1 * 3 + 2] = b10 * a02 + b11 * a12 + b12 * a22;
        a[2 * 3 + 0] = b20 * a00 + b21 * a10 + b22 * a20;
        a[2 * 3 + 1] = b20 * a01 + b21 * a11 + b22 * a21;
        a[2 * 3 + 2] = b20 * a02 + b21 * a12 + b22 * a22;

        return a;

    }

};

/* file: script/lib/earcut.js */

!function(e) {
    if ("object" == typeof exports && "undefined" != typeof module)
        module.exports = e();
    else if ("function" == typeof define && define.amd)
        define([], e);
    else {
        var n;
        n = "undefined" != typeof window ? window : "undefined" != typeof global ? global : "undefined" != typeof self ? self : this,
        n.earcut = e()
    }
}(function() {
    return function e(n, t, r) {
        function x(u, f) {
            if (!t[u]) {
                if (!n[u]) {
                    var o = "function" == typeof require && require;
                    if (!f && o)
                        return o(u, !0);
                    if (i)
                        return i(u, !0);
                    var v = new Error("Cannot find module '" + u + "'");
                    throw v.code = "MODULE_NOT_FOUND",
                    v
                }
                var l = t[u] = {
                    exports: {}
                };
                n[u][0].call(l.exports, function(e) {
                    var t = n[u][1][e];
                    return x(t ? t : e)
                }, l, l.exports, e, n, t, r)
            }
            return t[u].exports
        }
        for (var i = "function" == typeof require && require, u = 0; u < r.length; u++)
            x(r[u]);
        return x
    }({
        1: [function(e, n, t) {
            "use strict";
            function r(e, n, t) {
                t = t || 2;
                var r = n && n.length
                  , i = r ? n[0] * t : e.length
                  , f = x(e, 0, i, t, !0)
                  , o = [];
                if (!f)
                    return o;
                var v, l, p, a, h, s, c;
                if (r && (f = y(e, n, f, t)),
                e.length > 80 * t) {
                    v = p = e[0],
                    l = a = e[1];
                    for (var d = t; i > d; d += t)
                        h = e[d],
                        s = e[d + 1],
                        v > h && (v = h),
                        l > s && (l = s),
                        h > p && (p = h),
                        s > a && (a = s);
                    c = Math.max(p - v, a - l)
                }
                return u(f, o, t, v, l, c),
                o
            }
            function x(e, n, t, r, x) {
                var i, u;
                if (x === _(e, n, t, r) > 0)
                    for (i = n; t > i; i += r)
                        u = E(i, e[i], e[i + 1], u);
                else
                    for (i = t - r; i >= n; i -= r)
                        u = E(i, e[i], e[i + 1], u);
                return u && z(u, u.next) && (N(u),
                u = u.next),
                u
            }
            function i(e, n) {
                if (!e)
                    return e;
                n || (n = e);
                var t, r = e;
                do
                    if (t = !1,
                    r.steiner || !z(r, r.next) && 0 !== b(r.prev, r, r.next))
                        r = r.next;
                    else {
                        if (N(r),
                        r = n = r.prev,
                        r === r.next)
                            return null;
                        t = !0
                    }
                while (t || r !== n);
                return n
            }
            function u(e, n, t, r, x, y, p) {
                if (e) {
                    !p && y && s(e, r, x, y);
                    for (var a, h, c = e; e.prev !== e.next; )
                        if (a = e.prev,
                        h = e.next,
                        y ? o(e, r, x, y) : f(e))
                            n.push(a.i / t),
                            n.push(e.i / t),
                            n.push(h.i / t),
                            N(e),
                            e = h.next,
                            c = h.next;
                        else if (e = h,
                        e === c) {
                            p ? 1 === p ? (e = v(e, n, t),
                            u(e, n, t, r, x, y, 2)) : 2 === p && l(e, n, t, r, x, y) : u(i(e), n, t, r, x, y, 1);
                            break
                        }
                }
            }
            function f(e) {
                var n = e.prev
                  , t = e
                  , r = e.next;
                if (b(n, t, r) >= 0)
                    return !1;
                for (var x = e.next.next; x !== e.prev; ) {
                    if (g(n.x, n.y, t.x, t.y, r.x, r.y, x.x, x.y) && b(x.prev, x, x.next) >= 0)
                        return !1;
                    x = x.next
                }
                return !0
            }
            function o(e, n, t, r) {
                var x = e.prev
                  , i = e
                  , u = e.next;
                if (b(x, i, u) >= 0)
                    return !1;
                for (var f = x.x < i.x ? x.x < u.x ? x.x : u.x : i.x < u.x ? i.x : u.x, o = x.y < i.y ? x.y < u.y ? x.y : u.y : i.y < u.y ? i.y : u.y, v = x.x > i.x ? x.x > u.x ? x.x : u.x : i.x > u.x ? i.x : u.x, l = x.y > i.y ? x.y > u.y ? x.y : u.y : i.y > u.y ? i.y : u.y, y = d(f, o, n, t, r), p = d(v, l, n, t, r), a = e.nextZ; a && a.z <= p; ) {
                    if (a !== e.prev && a !== e.next && g(x.x, x.y, i.x, i.y, u.x, u.y, a.x, a.y) && b(a.prev, a, a.next) >= 0)
                        return !1;
                    a = a.nextZ
                }
                for (a = e.prevZ; a && a.z >= y; ) {
                    if (a !== e.prev && a !== e.next && g(x.x, x.y, i.x, i.y, u.x, u.y, a.x, a.y) && b(a.prev, a, a.next) >= 0)
                        return !1;
                    a = a.prevZ
                }
                return !0
            }
            function v(e, n, t) {
                var r = e;
                do {
                    var x = r.prev
                      , i = r.next.next;
                    !z(x, i) && M(x, r, r.next, i) && q(x, i) && q(i, x) && (n.push(x.i / t),
                    n.push(r.i / t),
                    n.push(i.i / t),
                    N(r),
                    N(r.next),
                    r = e = i),
                    r = r.next
                } while (r !== e);
                return r
            }
            function l(e, n, t, r, x, f) {
                var o = e;
                do {
                    for (var v = o.next.next; v !== o.prev; ) {
                        if (o.i !== v.i && w(o, v)) {
                            var l = D(o, v);
                            return o = i(o, o.next),
                            l = i(l, l.next),
                            u(o, n, t, r, x, f),
                            void u(l, n, t, r, x, f)
                        }
                        v = v.next
                    }
                    o = o.next
                } while (o !== e)
            }
            function y(e, n, t, r) {
                var u, f, o, v, l, y = [];
                for (u = 0,
                f = n.length; f > u; u++)
                    o = n[u] * r,
                    v = f - 1 > u ? n[u + 1] * r : e.length,
                    l = x(e, o, v, r, !1),
                    l === l.next && (l.steiner = !0),
                    y.push(Z(l));
                for (y.sort(p),
                u = 0; u < y.length; u++)
                    a(y[u], t),
                    t = i(t, t.next);
                return t
            }
            function p(e, n) {
                return e.x - n.x
            }
            function a(e, n) {
                if (n = h(e, n)) {
                    var t = D(n, e);
                    i(t, t.next)
                }
            }
            function h(e, n) {
                var t, r = n, x = e.x, i = e.y, u = -(1 / 0);
                do {
                    if (i <= r.y && i >= r.next.y) {
                        var f = r.x + (i - r.y) * (r.next.x - r.x) / (r.next.y - r.y);
                        if (x >= f && f > u) {
                            if (u = f,
                            f === x) {
                                if (i === r.y)
                                    return r;
                                if (i === r.next.y)
                                    return r.next
                            }
                            t = r.x < r.next.x ? r : r.next
                        }
                    }
                    r = r.next
                } while (r !== n);
                if (!t)
                    return null;
                if (x === u)
                    return t.prev;
                var o, v = t, l = t.x, y = t.y, p = 1 / 0;
                for (r = t.next; r !== v; )
                    x >= r.x && r.x >= l && g(y > i ? x : u, i, l, y, y > i ? u : x, i, r.x, r.y) && (o = Math.abs(i - r.y) / (x - r.x),
                    (p > o || o === p && r.x > t.x) && q(r, e) && (t = r,
                    p = o)),
                    r = r.next;
                return t
            }
            function s(e, n, t, r) {
                var x = e;
                do
                    null === x.z && (x.z = d(x.x, x.y, n, t, r)),
                    x.prevZ = x.prev,
                    x.nextZ = x.next,
                    x = x.next;
                while (x !== e);
                x.prevZ.nextZ = null,
                x.prevZ = null,
                c(x)
            }
            function c(e) {
                var n, t, r, x, i, u, f, o, v = 1;
                do {
                    for (t = e,
                    e = null,
                    i = null,
                    u = 0; t; ) {
                        for (u++,
                        r = t,
                        f = 0,
                        n = 0; v > n && (f++,
                        r = r.nextZ,
                        r); n++)
                            ;
                        for (o = v; f > 0 || o > 0 && r; )
                            0 === f ? (x = r,
                            r = r.nextZ,
                            o--) : 0 !== o && r ? t.z <= r.z ? (x = t,
                            t = t.nextZ,
                            f--) : (x = r,
                            r = r.nextZ,
                            o--) : (x = t,
                            t = t.nextZ,
                            f--),
                            i ? i.nextZ = x : e = x,
                            x.prevZ = i,
                            i = x;
                        t = r
                    }
                    i.nextZ = null,
                    v *= 2
                } while (u > 1);
                return e
            }
            function d(e, n, t, r, x) {
                return e = 32767 * (e - t) / x,
                n = 32767 * (n - r) / x,
                e = 16711935 & (e | e << 8),
                e = 252645135 & (e | e << 4),
                e = 858993459 & (e | e << 2),
                e = 1431655765 & (e | e << 1),
                n = 16711935 & (n | n << 8),
                n = 252645135 & (n | n << 4),
                n = 858993459 & (n | n << 2),
                n = 1431655765 & (n | n << 1),
                e | n << 1
            }
            function Z(e) {
                var n = e
                  , t = e;
                do
                    n.x < t.x && (t = n),
                    n = n.next;
                while (n !== e);
                return t
            }
            function g(e, n, t, r, x, i, u, f) {
                return (x - u) * (n - f) - (e - u) * (i - f) >= 0 && (e - u) * (r - f) - (t - u) * (n - f) >= 0 && (t - u) * (i - f) - (x - u) * (r - f) >= 0
            }
            function w(e, n) {
                return e.next.i !== n.i && e.prev.i !== n.i && !m(e, n) && q(e, n) && q(n, e) && O(e, n)
            }
            function b(e, n, t) {
                return (n.y - e.y) * (t.x - n.x) - (n.x - e.x) * (t.y - n.y)
            }
            function z(e, n) {
                return e.x === n.x && e.y === n.y
            }
            function M(e, n, t, r) {
                return z(e, n) && z(t, r) || z(e, r) && z(t, n) ? !0 : b(e, n, t) > 0 != b(e, n, r) > 0 && b(t, r, e) > 0 != b(t, r, n) > 0
            }
            function m(e, n) {
                var t = e;
                do {
                    if (t.i !== e.i && t.next.i !== e.i && t.i !== n.i && t.next.i !== n.i && M(t, t.next, e, n))
                        return !0;
                    t = t.next
                } while (t !== e);
                return !1
            }
            function q(e, n) {
                return b(e.prev, e, e.next) < 0 ? b(e, n, e.next) >= 0 && b(e, e.prev, n) >= 0 : b(e, n, e.prev) < 0 || b(e, e.next, n) < 0
            }
            function O(e, n) {
                var t = e
                  , r = !1
                  , x = (e.x + n.x) / 2
                  , i = (e.y + n.y) / 2;
                do
                    t.y > i != t.next.y > i && x < (t.next.x - t.x) * (i - t.y) / (t.next.y - t.y) + t.x && (r = !r),
                    t = t.next;
                while (t !== e);
                return r
            }
            function D(e, n) {
                var t = new U(e.i,e.x,e.y)
                  , r = new U(n.i,n.x,n.y)
                  , x = e.next
                  , i = n.prev;
                return e.next = n,
                n.prev = e,
                t.next = x,
                x.prev = t,
                r.next = t,
                t.prev = r,
                i.next = r,
                r.prev = i,
                r
            }
            function E(e, n, t, r) {
                var x = new U(e,n,t);
                return r ? (x.next = r.next,
                x.prev = r,
                r.next.prev = x,
                r.next = x) : (x.prev = x,
                x.next = x),
                x
            }
            function N(e) {
                e.next.prev = e.prev,
                e.prev.next = e.next,
                e.prevZ && (e.prevZ.nextZ = e.nextZ),
                e.nextZ && (e.nextZ.prevZ = e.prevZ)
            }
            function U(e, n, t) {
                this.i = e,
                this.x = n,
                this.y = t,
                this.prev = null,
                this.next = null,
                this.z = null,
                this.prevZ = null,
                this.nextZ = null,
                this.steiner = !1
            }
            function _(e, n, t, r) {
                for (var x = 0, i = n, u = t - r; t > i; i += r)
                    x += (e[u] - e[i]) * (e[i + 1] + e[u + 1]),
                    u = i;
                return x
            }
            n.exports = r,
            r.deviation = function(e, n, t, r) {
                var x = n && n.length
                  , i = x ? n[0] * t : e.length
                  , u = Math.abs(_(e, 0, i, t));
                if (x)
                    for (var f = 0, o = n.length; o > f; f++) {
                        var v = n[f] * t
                          , l = o - 1 > f ? n[f + 1] * t : e.length;
                        u -= Math.abs(_(e, v, l, t))
                    }
                var y = 0;
                for (f = 0; f < r.length; f += 3) {
                    var p = r[f] * t
                      , a = r[f + 1] * t
                      , h = r[f + 2] * t;
                    y += Math.abs((e[p] - e[h]) * (e[a + 1] - e[p + 1]) - (e[p] - e[a]) * (e[h + 1] - e[p + 1]))
                }
                return 0 === u && 0 === y ? 0 : Math.abs((y - u) / u)
            }
            ,
            r.flatten = function(e) {
                for (var n = e[0][0].length, t = {
                    vertices: [],
                    holes: [],
                    dimensions: n
                }, r = 0, x = 0; x < e.length; x++) {
                    for (var i = 0; i < e[x].length; i++)
                        for (var u = 0; n > u; u++)
                            t.vertices.push(e[x][i][u]);
                    x > 0 && (r += e[x - 1].length,
                    t.holes.push(r))
                }
                return t
            }
        }
        , {}]
    }, {}, [1])(1)
});

/* file: script/lib/jquery.js */

/*! jQuery v3.1.1 | (c) jQuery Foundation | jquery.org/license */
!function(a, b) {
    "use strict";
    "object" == typeof module && "object" == typeof module.exports ? module.exports = a.document ? b(a, !0) : function(a) {
        if (!a.document)
            throw new Error("jQuery requires a window with a document");
        return b(a)
    }
    : b(a)
}("undefined" != typeof window ? window : this, function(a, b) {
    "use strict";
    var c = []
      , d = a.document
      , e = Object.getPrototypeOf
      , f = c.slice
      , g = c.concat
      , h = c.push
      , i = c.indexOf
      , j = {}
      , k = j.toString
      , l = j.hasOwnProperty
      , m = l.toString
      , n = m.call(Object)
      , o = {};
    function p(a, b) {
        b = b || d;
        var c = b.createElement("script");
        c.text = a,
        b.head.appendChild(c).parentNode.removeChild(c)
    }
    var q = "3.1.1"
      , r = function(a, b) {
        return new r.fn.init(a,b)
    }
      , s = /^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g
      , t = /^-ms-/
      , u = /-([a-z])/g
      , v = function(a, b) {
        return b.toUpperCase()
    };
    r.fn = r.prototype = {
        jquery: q,
        constructor: r,
        length: 0,
        toArray: function() {
            return f.call(this)
        },
        get: function(a) {
            return null == a ? f.call(this) : a < 0 ? this[a + this.length] : this[a]
        },
        pushStack: function(a) {
            var b = r.merge(this.constructor(), a);
            return b.prevObject = this,
            b
        },
        each: function(a) {
            return r.each(this, a)
        },
        map: function(a) {
            return this.pushStack(r.map(this, function(b, c) {
                return a.call(b, c, b)
            }))
        },
        slice: function() {
            return this.pushStack(f.apply(this, arguments))
        },
        first: function() {
            return this.eq(0)
        },
        last: function() {
            return this.eq(-1)
        },
        eq: function(a) {
            var b = this.length
              , c = +a + (a < 0 ? b : 0);
            return this.pushStack(c >= 0 && c < b ? [this[c]] : [])
        },
        end: function() {
            return this.prevObject || this.constructor()
        },
        push: h,
        sort: c.sort,
        splice: c.splice
    },
    r.extend = r.fn.extend = function() {
        var a, b, c, d, e, f, g = arguments[0] || {}, h = 1, i = arguments.length, j = !1;
        for ("boolean" == typeof g && (j = g,
        g = arguments[h] || {},
        h++),
        "object" == typeof g || r.isFunction(g) || (g = {}),
        h === i && (g = this,
        h--); h < i; h++)
            if (null != (a = arguments[h]))
                for (b in a)
                    c = g[b],
                    d = a[b],
                    g !== d && (j && d && (r.isPlainObject(d) || (e = r.isArray(d))) ? (e ? (e = !1,
                    f = c && r.isArray(c) ? c : []) : f = c && r.isPlainObject(c) ? c : {},
                    g[b] = r.extend(j, f, d)) : void 0 !== d && (g[b] = d));
        return g
    }
    ,
    r.extend({
        expando: "jQuery" + (q + Math.random()).replace(/\D/g, ""),
        isReady: !0,
        error: function(a) {
            throw new Error(a)
        },
        noop: function() {},
        isFunction: function(a) {
            return "function" === r.type(a)
        },
        isArray: Array.isArray,
        isWindow: function(a) {
            return null != a && a === a.window
        },
        isNumeric: function(a) {
            var b = r.type(a);
            return ("number" === b || "string" === b) && !isNaN(a - parseFloat(a))
        },
        isPlainObject: function(a) {
            var b, c;
            return !(!a || "[object Object]" !== k.call(a)) && (!(b = e(a)) || (c = l.call(b, "constructor") && b.constructor,
            "function" == typeof c && m.call(c) === n))
        },
        isEmptyObject: function(a) {
            var b;
            for (b in a)
                return !1;
            return !0
        },
        type: function(a) {
            return null == a ? a + "" : "object" == typeof a || "function" == typeof a ? j[k.call(a)] || "object" : typeof a
        },
        globalEval: function(a) {
            p(a)
        },
        camelCase: function(a) {
            return a.replace(t, "ms-").replace(u, v)
        },
        nodeName: function(a, b) {
            return a.nodeName && a.nodeName.toLowerCase() === b.toLowerCase()
        },
        each: function(a, b) {
            var c, d = 0;
            if (w(a)) {
                for (c = a.length; d < c; d++)
                    if (b.call(a[d], d, a[d]) === !1)
                        break
            } else
                for (d in a)
                    if (b.call(a[d], d, a[d]) === !1)
                        break;
            return a
        },
        trim: function(a) {
            return null == a ? "" : (a + "").replace(s, "")
        },
        makeArray: function(a, b) {
            var c = b || [];
            return null != a && (w(Object(a)) ? r.merge(c, "string" == typeof a ? [a] : a) : h.call(c, a)),
            c
        },
        inArray: function(a, b, c) {
            return null == b ? -1 : i.call(b, a, c)
        },
        merge: function(a, b) {
            for (var c = +b.length, d = 0, e = a.length; d < c; d++)
                a[e++] = b[d];
            return a.length = e,
            a
        },
        grep: function(a, b, c) {
            for (var d, e = [], f = 0, g = a.length, h = !c; f < g; f++)
                d = !b(a[f], f),
                d !== h && e.push(a[f]);
            return e
        },
        map: function(a, b, c) {
            var d, e, f = 0, h = [];
            if (w(a))
                for (d = a.length; f < d; f++)
                    e = b(a[f], f, c),
                    null != e && h.push(e);
            else
                for (f in a)
                    e = b(a[f], f, c),
                    null != e && h.push(e);
            return g.apply([], h)
        },
        guid: 1,
        proxy: function(a, b) {
            var c, d, e;
            if ("string" == typeof b && (c = a[b],
            b = a,
            a = c),
            r.isFunction(a))
                return d = f.call(arguments, 2),
                e = function() {
                    return a.apply(b || this, d.concat(f.call(arguments)))
                }
                ,
                e.guid = a.guid = a.guid || r.guid++,
                e
        },
        now: Date.now,
        support: o
    }),
    "function" == typeof Symbol && (r.fn[Symbol.iterator] = c[Symbol.iterator]),
    r.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "), function(a, b) {
        j["[object " + b + "]"] = b.toLowerCase()
    });
    function w(a) {
        var b = !!a && "length"in a && a.length
          , c = r.type(a);
        return "function" !== c && !r.isWindow(a) && ("array" === c || 0 === b || "number" == typeof b && b > 0 && b - 1 in a)
    }
    var x = function(a) {
        var b, c, d, e, f, g, h, i, j, k, l, m, n, o, p, q, r, s, t, u = "sizzle" + 1 * new Date, v = a.document, w = 0, x = 0, y = ha(), z = ha(), A = ha(), B = function(a, b) {
            return a === b && (l = !0),
            0
        }, C = {}.hasOwnProperty, D = [], E = D.pop, F = D.push, G = D.push, H = D.slice, I = function(a, b) {
            for (var c = 0, d = a.length; c < d; c++)
                if (a[c] === b)
                    return c;
            return -1
        }, J = "checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped", K = "[\\x20\\t\\r\\n\\f]", L = "(?:\\\\.|[\\w-]|[^\0-\\xa0])+", M = "\\[" + K + "*(" + L + ")(?:" + K + "*([*^$|!~]?=)" + K + "*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|(" + L + "))|)" + K + "*\\]", N = ":(" + L + ")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|" + M + ")*)|.*)\\)|)", O = new RegExp(K + "+","g"), P = new RegExp("^" + K + "+|((?:^|[^\\\\])(?:\\\\.)*)" + K + "+$","g"), Q = new RegExp("^" + K + "*," + K + "*"), R = new RegExp("^" + K + "*([>+~]|" + K + ")" + K + "*"), S = new RegExp("=" + K + "*([^\\]'\"]*?)" + K + "*\\]","g"), T = new RegExp(N), U = new RegExp("^" + L + "$"), V = {
            ID: new RegExp("^#(" + L + ")"),
            CLASS: new RegExp("^\\.(" + L + ")"),
            TAG: new RegExp("^(" + L + "|[*])"),
            ATTR: new RegExp("^" + M),
            PSEUDO: new RegExp("^" + N),
            CHILD: new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\(" + K + "*(even|odd|(([+-]|)(\\d*)n|)" + K + "*(?:([+-]|)" + K + "*(\\d+)|))" + K + "*\\)|)","i"),
            bool: new RegExp("^(?:" + J + ")$","i"),
            needsContext: new RegExp("^" + K + "*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\(" + K + "*((?:-\\d)?\\d*)" + K + "*\\)|)(?=[^-]|$)","i")
        }, W = /^(?:input|select|textarea|button)$/i, X = /^h\d$/i, Y = /^[^{]+\{\s*\[native \w/, Z = /^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/, $ = /[+~]/, _ = new RegExp("\\\\([\\da-f]{1,6}" + K + "?|(" + K + ")|.)","ig"), aa = function(a, b, c) {
            var d = "0x" + b - 65536;
            return d !== d || c ? b : d < 0 ? String.fromCharCode(d + 65536) : String.fromCharCode(d >> 10 | 55296, 1023 & d | 56320)
        }, ba = /([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g, ca = function(a, b) {
            return b ? "\0" === a ? "\ufffd" : a.slice(0, -1) + "\\" + a.charCodeAt(a.length - 1).toString(16) + " " : "\\" + a
        }, da = function() {
            m()
        }, ea = ta(function(a) {
            return a.disabled === !0 && ("form"in a || "label"in a)
        }, {
            dir: "parentNode",
            next: "legend"
        });
        try {
            G.apply(D = H.call(v.childNodes), v.childNodes),
            D[v.childNodes.length].nodeType
        } catch (fa) {
            G = {
                apply: D.length ? function(a, b) {
                    F.apply(a, H.call(b))
                }
                : function(a, b) {
                    var c = a.length
                      , d = 0;
                    while (a[c++] = b[d++])
                        ;
                    a.length = c - 1
                }
            }
        }
        function ga(a, b, d, e) {
            var f, h, j, k, l, o, r, s = b && b.ownerDocument, w = b ? b.nodeType : 9;
            if (d = d || [],
            "string" != typeof a || !a || 1 !== w && 9 !== w && 11 !== w)
                return d;
            if (!e && ((b ? b.ownerDocument || b : v) !== n && m(b),
            b = b || n,
            p)) {
                if (11 !== w && (l = Z.exec(a)))
                    if (f = l[1]) {
                        if (9 === w) {
                            if (!(j = b.getElementById(f)))
                                return d;
                            if (j.id === f)
                                return d.push(j),
                                d
                        } else if (s && (j = s.getElementById(f)) && t(b, j) && j.id === f)
                            return d.push(j),
                            d
                    } else {
                        if (l[2])
                            return G.apply(d, b.getElementsByTagName(a)),
                            d;
                        if ((f = l[3]) && c.getElementsByClassName && b.getElementsByClassName)
                            return G.apply(d, b.getElementsByClassName(f)),
                            d
                    }
                if (c.qsa && !A[a + " "] && (!q || !q.test(a))) {
                    if (1 !== w)
                        s = b,
                        r = a;
                    else if ("object" !== b.nodeName.toLowerCase()) {
                        (k = b.getAttribute("id")) ? k = k.replace(ba, ca) : b.setAttribute("id", k = u),
                        o = g(a),
                        h = o.length;
                        while (h--)
                            o[h] = "#" + k + " " + sa(o[h]);
                        r = o.join(","),
                        s = $.test(a) && qa(b.parentNode) || b
                    }
                    if (r)
                        try {
                            return G.apply(d, s.querySelectorAll(r)),
                            d
                        } catch (x) {} finally {
                            k === u && b.removeAttribute("id")
                        }
                }
            }
            return i(a.replace(P, "$1"), b, d, e)
        }
        function ha() {
            var a = [];
            function b(c, e) {
                return a.push(c + " ") > d.cacheLength && delete b[a.shift()],
                b[c + " "] = e
            }
            return b
        }
        function ia(a) {
            return a[u] = !0,
            a
        }
        function ja(a) {
            var b = n.createElement("fieldset");
            try {
                return !!a(b)
            } catch (c) {
                return !1
            } finally {
                b.parentNode && b.parentNode.removeChild(b),
                b = null
            }
        }
        function ka(a, b) {
            var c = a.split("|")
              , e = c.length;
            while (e--)
                d.attrHandle[c[e]] = b
        }
        function la(a, b) {
            var c = b && a
              , d = c && 1 === a.nodeType && 1 === b.nodeType && a.sourceIndex - b.sourceIndex;
            if (d)
                return d;
            if (c)
                while (c = c.nextSibling)
                    if (c === b)
                        return -1;
            return a ? 1 : -1
        }
        function ma(a) {
            return function(b) {
                var c = b.nodeName.toLowerCase();
                return "input" === c && b.type === a
            }
        }
        function na(a) {
            return function(b) {
                var c = b.nodeName.toLowerCase();
                return ("input" === c || "button" === c) && b.type === a
            }
        }
        function oa(a) {
            return function(b) {
                return "form"in b ? b.parentNode && b.disabled === !1 ? "label"in b ? "label"in b.parentNode ? b.parentNode.disabled === a : b.disabled === a : b.isDisabled === a || b.isDisabled !== !a && ea(b) === a : b.disabled === a : "label"in b && b.disabled === a
            }
        }
        function pa(a) {
            return ia(function(b) {
                return b = +b,
                ia(function(c, d) {
                    var e, f = a([], c.length, b), g = f.length;
                    while (g--)
                        c[e = f[g]] && (c[e] = !(d[e] = c[e]))
                })
            })
        }
        function qa(a) {
            return a && "undefined" != typeof a.getElementsByTagName && a
        }
        c = ga.support = {},
        f = ga.isXML = function(a) {
            var b = a && (a.ownerDocument || a).documentElement;
            return !!b && "HTML" !== b.nodeName
        }
        ,
        m = ga.setDocument = function(a) {
            var b, e, g = a ? a.ownerDocument || a : v;
            return g !== n && 9 === g.nodeType && g.documentElement ? (n = g,
            o = n.documentElement,
            p = !f(n),
            v !== n && (e = n.defaultView) && e.top !== e && (e.addEventListener ? e.addEventListener("unload", da, !1) : e.attachEvent && e.attachEvent("onunload", da)),
            c.attributes = ja(function(a) {
                return a.className = "i",
                !a.getAttribute("className")
            }),
            c.getElementsByTagName = ja(function(a) {
                return a.appendChild(n.createComment("")),
                !a.getElementsByTagName("*").length
            }),
            c.getElementsByClassName = Y.test(n.getElementsByClassName),
            c.getById = ja(function(a) {
                return o.appendChild(a).id = u,
                !n.getElementsByName || !n.getElementsByName(u).length
            }),
            c.getById ? (d.filter.ID = function(a) {
                var b = a.replace(_, aa);
                return function(a) {
                    return a.getAttribute("id") === b
                }
            }
            ,
            d.find.ID = function(a, b) {
                if ("undefined" != typeof b.getElementById && p) {
                    var c = b.getElementById(a);
                    return c ? [c] : []
                }
            }
            ) : (d.filter.ID = function(a) {
                var b = a.replace(_, aa);
                return function(a) {
                    var c = "undefined" != typeof a.getAttributeNode && a.getAttributeNode("id");
                    return c && c.value === b
                }
            }
            ,
            d.find.ID = function(a, b) {
                if ("undefined" != typeof b.getElementById && p) {
                    var c, d, e, f = b.getElementById(a);
                    if (f) {
                        if (c = f.getAttributeNode("id"),
                        c && c.value === a)
                            return [f];
                        e = b.getElementsByName(a),
                        d = 0;
                        while (f = e[d++])
                            if (c = f.getAttributeNode("id"),
                            c && c.value === a)
                                return [f]
                    }
                    return []
                }
            }
            ),
            d.find.TAG = c.getElementsByTagName ? function(a, b) {
                return "undefined" != typeof b.getElementsByTagName ? b.getElementsByTagName(a) : c.qsa ? b.querySelectorAll(a) : void 0
            }
            : function(a, b) {
                var c, d = [], e = 0, f = b.getElementsByTagName(a);
                if ("*" === a) {
                    while (c = f[e++])
                        1 === c.nodeType && d.push(c);
                    return d
                }
                return f
            }
            ,
            d.find.CLASS = c.getElementsByClassName && function(a, b) {
                if ("undefined" != typeof b.getElementsByClassName && p)
                    return b.getElementsByClassName(a)
            }
            ,
            r = [],
            q = [],
            (c.qsa = Y.test(n.querySelectorAll)) && (ja(function(a) {
                o.appendChild(a).innerHTML = "<a id='" + u + "'></a><select id='" + u + "-\r\\' msallowcapture=''><option selected=''></option></select>",
                a.querySelectorAll("[msallowcapture^='']").length && q.push("[*^$]=" + K + "*(?:''|\"\")"),
                a.querySelectorAll("[selected]").length || q.push("\\[" + K + "*(?:value|" + J + ")"),
                a.querySelectorAll("[id~=" + u + "-]").length || q.push("~="),
                a.querySelectorAll(":checked").length || q.push(":checked"),
                a.querySelectorAll("a#" + u + "+*").length || q.push(".#.+[+~]")
            }),
            ja(function(a) {
                a.innerHTML = "<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";
                var b = n.createElement("input");
                b.setAttribute("type", "hidden"),
                a.appendChild(b).setAttribute("name", "D"),
                a.querySelectorAll("[name=d]").length && q.push("name" + K + "*[*^$|!~]?="),
                2 !== a.querySelectorAll(":enabled").length && q.push(":enabled", ":disabled"),
                o.appendChild(a).disabled = !0,
                2 !== a.querySelectorAll(":disabled").length && q.push(":enabled", ":disabled"),
                a.querySelectorAll("*,:x"),
                q.push(",.*:")
            })),
            (c.matchesSelector = Y.test(s = o.matches || o.webkitMatchesSelector || o.mozMatchesSelector || o.oMatchesSelector || o.msMatchesSelector)) && ja(function(a) {
                c.disconnectedMatch = s.call(a, "*"),
                s.call(a, "[s!='']:x"),
                r.push("!=", N)
            }),
            q = q.length && new RegExp(q.join("|")),
            r = r.length && new RegExp(r.join("|")),
            b = Y.test(o.compareDocumentPosition),
            t = b || Y.test(o.contains) ? function(a, b) {
                var c = 9 === a.nodeType ? a.documentElement : a
                  , d = b && b.parentNode;
                return a === d || !(!d || 1 !== d.nodeType || !(c.contains ? c.contains(d) : a.compareDocumentPosition && 16 & a.compareDocumentPosition(d)))
            }
            : function(a, b) {
                if (b)
                    while (b = b.parentNode)
                        if (b === a)
                            return !0;
                return !1
            }
            ,
            B = b ? function(a, b) {
                if (a === b)
                    return l = !0,
                    0;
                var d = !a.compareDocumentPosition - !b.compareDocumentPosition;
                return d ? d : (d = (a.ownerDocument || a) === (b.ownerDocument || b) ? a.compareDocumentPosition(b) : 1,
                1 & d || !c.sortDetached && b.compareDocumentPosition(a) === d ? a === n || a.ownerDocument === v && t(v, a) ? -1 : b === n || b.ownerDocument === v && t(v, b) ? 1 : k ? I(k, a) - I(k, b) : 0 : 4 & d ? -1 : 1)
            }
            : function(a, b) {
                if (a === b)
                    return l = !0,
                    0;
                var c, d = 0, e = a.parentNode, f = b.parentNode, g = [a], h = [b];
                if (!e || !f)
                    return a === n ? -1 : b === n ? 1 : e ? -1 : f ? 1 : k ? I(k, a) - I(k, b) : 0;
                if (e === f)
                    return la(a, b);
                c = a;
                while (c = c.parentNode)
                    g.unshift(c);
                c = b;
                while (c = c.parentNode)
                    h.unshift(c);
                while (g[d] === h[d])
                    d++;
                return d ? la(g[d], h[d]) : g[d] === v ? -1 : h[d] === v ? 1 : 0
            }
            ,
            n) : n
        }
        ,
        ga.matches = function(a, b) {
            return ga(a, null, null, b)
        }
        ,
        ga.matchesSelector = function(a, b) {
            if ((a.ownerDocument || a) !== n && m(a),
            b = b.replace(S, "='$1']"),
            c.matchesSelector && p && !A[b + " "] && (!r || !r.test(b)) && (!q || !q.test(b)))
                try {
                    var d = s.call(a, b);
                    if (d || c.disconnectedMatch || a.document && 11 !== a.document.nodeType)
                        return d
                } catch (e) {}
            return ga(b, n, null, [a]).length > 0
        }
        ,
        ga.contains = function(a, b) {
            return (a.ownerDocument || a) !== n && m(a),
            t(a, b)
        }
        ,
        ga.attr = function(a, b) {
            (a.ownerDocument || a) !== n && m(a);
            var e = d.attrHandle[b.toLowerCase()]
              , f = e && C.call(d.attrHandle, b.toLowerCase()) ? e(a, b, !p) : void 0;
            return void 0 !== f ? f : c.attributes || !p ? a.getAttribute(b) : (f = a.getAttributeNode(b)) && f.specified ? f.value : null
        }
        ,
        ga.escape = function(a) {
            return (a + "").replace(ba, ca)
        }
        ,
        ga.error = function(a) {
            throw new Error("Syntax error, unrecognized expression: " + a)
        }
        ,
        ga.uniqueSort = function(a) {
            var b, d = [], e = 0, f = 0;
            if (l = !c.detectDuplicates,
            k = !c.sortStable && a.slice(0),
            a.sort(B),
            l) {
                while (b = a[f++])
                    b === a[f] && (e = d.push(f));
                while (e--)
                    a.splice(d[e], 1)
            }
            return k = null,
            a
        }
        ,
        e = ga.getText = function(a) {
            var b, c = "", d = 0, f = a.nodeType;
            if (f) {
                if (1 === f || 9 === f || 11 === f) {
                    if ("string" == typeof a.textContent)
                        return a.textContent;
                    for (a = a.firstChild; a; a = a.nextSibling)
                        c += e(a)
                } else if (3 === f || 4 === f)
                    return a.nodeValue
            } else
                while (b = a[d++])
                    c += e(b);
            return c
        }
        ,
        d = ga.selectors = {
            cacheLength: 50,
            createPseudo: ia,
            match: V,
            attrHandle: {},
            find: {},
            relative: {
                ">": {
                    dir: "parentNode",
                    first: !0
                },
                " ": {
                    dir: "parentNode"
                },
                "+": {
                    dir: "previousSibling",
                    first: !0
                },
                "~": {
                    dir: "previousSibling"
                }
            },
            preFilter: {
                ATTR: function(a) {
                    return a[1] = a[1].replace(_, aa),
                    a[3] = (a[3] || a[4] || a[5] || "").replace(_, aa),
                    "~=" === a[2] && (a[3] = " " + a[3] + " "),
                    a.slice(0, 4)
                },
                CHILD: function(a) {
                    return a[1] = a[1].toLowerCase(),
                    "nth" === a[1].slice(0, 3) ? (a[3] || ga.error(a[0]),
                    a[4] = +(a[4] ? a[5] + (a[6] || 1) : 2 * ("even" === a[3] || "odd" === a[3])),
                    a[5] = +(a[7] + a[8] || "odd" === a[3])) : a[3] && ga.error(a[0]),
                    a
                },
                PSEUDO: function(a) {
                    var b, c = !a[6] && a[2];
                    return V.CHILD.test(a[0]) ? null : (a[3] ? a[2] = a[4] || a[5] || "" : c && T.test(c) && (b = g(c, !0)) && (b = c.indexOf(")", c.length - b) - c.length) && (a[0] = a[0].slice(0, b),
                    a[2] = c.slice(0, b)),
                    a.slice(0, 3))
                }
            },
            filter: {
                TAG: function(a) {
                    var b = a.replace(_, aa).toLowerCase();
                    return "*" === a ? function() {
                        return !0
                    }
                    : function(a) {
                        return a.nodeName && a.nodeName.toLowerCase() === b
                    }
                },
                CLASS: function(a) {
                    var b = y[a + " "];
                    return b || (b = new RegExp("(^|" + K + ")" + a + "(" + K + "|$)")) && y(a, function(a) {
                        return b.test("string" == typeof a.className && a.className || "undefined" != typeof a.getAttribute && a.getAttribute("class") || "")
                    })
                },
                ATTR: function(a, b, c) {
                    return function(d) {
                        var e = ga.attr(d, a);
                        return null == e ? "!=" === b : !b || (e += "",
                        "=" === b ? e === c : "!=" === b ? e !== c : "^=" === b ? c && 0 === e.indexOf(c) : "*=" === b ? c && e.indexOf(c) > -1 : "$=" === b ? c && e.slice(-c.length) === c : "~=" === b ? (" " + e.replace(O, " ") + " ").indexOf(c) > -1 : "|=" === b && (e === c || e.slice(0, c.length + 1) === c + "-"))
                    }
                },
                CHILD: function(a, b, c, d, e) {
                    var f = "nth" !== a.slice(0, 3)
                      , g = "last" !== a.slice(-4)
                      , h = "of-type" === b;
                    return 1 === d && 0 === e ? function(a) {
                        return !!a.parentNode
                    }
                    : function(b, c, i) {
                        var j, k, l, m, n, o, p = f !== g ? "nextSibling" : "previousSibling", q = b.parentNode, r = h && b.nodeName.toLowerCase(), s = !i && !h, t = !1;
                        if (q) {
                            if (f) {
                                while (p) {
                                    m = b;
                                    while (m = m[p])
                                        if (h ? m.nodeName.toLowerCase() === r : 1 === m.nodeType)
                                            return !1;
                                    o = p = "only" === a && !o && "nextSibling"
                                }
                                return !0
                            }
                            if (o = [g ? q.firstChild : q.lastChild],
                            g && s) {
                                m = q,
                                l = m[u] || (m[u] = {}),
                                k = l[m.uniqueID] || (l[m.uniqueID] = {}),
                                j = k[a] || [],
                                n = j[0] === w && j[1],
                                t = n && j[2],
                                m = n && q.childNodes[n];
                                while (m = ++n && m && m[p] || (t = n = 0) || o.pop())
                                    if (1 === m.nodeType && ++t && m === b) {
                                        k[a] = [w, n, t];
                                        break
                                    }
                            } else if (s && (m = b,
                            l = m[u] || (m[u] = {}),
                            k = l[m.uniqueID] || (l[m.uniqueID] = {}),
                            j = k[a] || [],
                            n = j[0] === w && j[1],
                            t = n),
                            t === !1)
                                while (m = ++n && m && m[p] || (t = n = 0) || o.pop())
                                    if ((h ? m.nodeName.toLowerCase() === r : 1 === m.nodeType) && ++t && (s && (l = m[u] || (m[u] = {}),
                                    k = l[m.uniqueID] || (l[m.uniqueID] = {}),
                                    k[a] = [w, t]),
                                    m === b))
                                        break;
                            return t -= e,
                            t === d || t % d === 0 && t / d >= 0
                        }
                    }
                },
                PSEUDO: function(a, b) {
                    var c, e = d.pseudos[a] || d.setFilters[a.toLowerCase()] || ga.error("unsupported pseudo: " + a);
                    return e[u] ? e(b) : e.length > 1 ? (c = [a, a, "", b],
                    d.setFilters.hasOwnProperty(a.toLowerCase()) ? ia(function(a, c) {
                        var d, f = e(a, b), g = f.length;
                        while (g--)
                            d = I(a, f[g]),
                            a[d] = !(c[d] = f[g])
                    }) : function(a) {
                        return e(a, 0, c)
                    }
                    ) : e
                }
            },
            pseudos: {
                not: ia(function(a) {
                    var b = []
                      , c = []
                      , d = h(a.replace(P, "$1"));
                    return d[u] ? ia(function(a, b, c, e) {
                        var f, g = d(a, null, e, []), h = a.length;
                        while (h--)
                            (f = g[h]) && (a[h] = !(b[h] = f))
                    }) : function(a, e, f) {
                        return b[0] = a,
                        d(b, null, f, c),
                        b[0] = null,
                        !c.pop()
                    }
                }),
                has: ia(function(a) {
                    return function(b) {
                        return ga(a, b).length > 0
                    }
                }),
                contains: ia(function(a) {
                    return a = a.replace(_, aa),
                    function(b) {
                        return (b.textContent || b.innerText || e(b)).indexOf(a) > -1
                    }
                }),
                lang: ia(function(a) {
                    return U.test(a || "") || ga.error("unsupported lang: " + a),
                    a = a.replace(_, aa).toLowerCase(),
                    function(b) {
                        var c;
                        do
                            if (c = p ? b.lang : b.getAttribute("xml:lang") || b.getAttribute("lang"))
                                return c = c.toLowerCase(),
                                c === a || 0 === c.indexOf(a + "-");
                        while ((b = b.parentNode) && 1 === b.nodeType);
                        return !1
                    }
                }),
                target: function(b) {
                    var c = a.location && a.location.hash;
                    return c && c.slice(1) === b.id
                },
                root: function(a) {
                    return a === o
                },
                focus: function(a) {
                    return a === n.activeElement && (!n.hasFocus || n.hasFocus()) && !!(a.type || a.href || ~a.tabIndex)
                },
                enabled: oa(!1),
                disabled: oa(!0),
                checked: function(a) {
                    var b = a.nodeName.toLowerCase();
                    return "input" === b && !!a.checked || "option" === b && !!a.selected
                },
                selected: function(a) {
                    return a.parentNode && a.parentNode.selectedIndex,
                    a.selected === !0
                },
                empty: function(a) {
                    for (a = a.firstChild; a; a = a.nextSibling)
                        if (a.nodeType < 6)
                            return !1;
                    return !0
                },
                parent: function(a) {
                    return !d.pseudos.empty(a)
                },
                header: function(a) {
                    return X.test(a.nodeName)
                },
                input: function(a) {
                    return W.test(a.nodeName)
                },
                button: function(a) {
                    var b = a.nodeName.toLowerCase();
                    return "input" === b && "button" === a.type || "button" === b
                },
                text: function(a) {
                    var b;
                    return "input" === a.nodeName.toLowerCase() && "text" === a.type && (null == (b = a.getAttribute("type")) || "text" === b.toLowerCase())
                },
                first: pa(function() {
                    return [0]
                }),
                last: pa(function(a, b) {
                    return [b - 1]
                }),
                eq: pa(function(a, b, c) {
                    return [c < 0 ? c + b : c]
                }),
                even: pa(function(a, b) {
                    for (var c = 0; c < b; c += 2)
                        a.push(c);
                    return a
                }),
                odd: pa(function(a, b) {
                    for (var c = 1; c < b; c += 2)
                        a.push(c);
                    return a
                }),
                lt: pa(function(a, b, c) {
                    for (var d = c < 0 ? c + b : c; --d >= 0; )
                        a.push(d);
                    return a
                }),
                gt: pa(function(a, b, c) {
                    for (var d = c < 0 ? c + b : c; ++d < b; )
                        a.push(d);
                    return a
                })
            }
        },
        d.pseudos.nth = d.pseudos.eq;
        for (b in {
            radio: !0,
            checkbox: !0,
            file: !0,
            password: !0,
            image: !0
        })
            d.pseudos[b] = ma(b);
        for (b in {
            submit: !0,
            reset: !0
        })
            d.pseudos[b] = na(b);
        function ra() {}
        ra.prototype = d.filters = d.pseudos,
        d.setFilters = new ra,
        g = ga.tokenize = function(a, b) {
            var c, e, f, g, h, i, j, k = z[a + " "];
            if (k)
                return b ? 0 : k.slice(0);
            h = a,
            i = [],
            j = d.preFilter;
            while (h) {
                c && !(e = Q.exec(h)) || (e && (h = h.slice(e[0].length) || h),
                i.push(f = [])),
                c = !1,
                (e = R.exec(h)) && (c = e.shift(),
                f.push({
                    value: c,
                    type: e[0].replace(P, " ")
                }),
                h = h.slice(c.length));
                for (g in d.filter)
                    !(e = V[g].exec(h)) || j[g] && !(e = j[g](e)) || (c = e.shift(),
                    f.push({
                        value: c,
                        type: g,
                        matches: e
                    }),
                    h = h.slice(c.length));
                if (!c)
                    break
            }
            return b ? h.length : h ? ga.error(a) : z(a, i).slice(0)
        }
        ;
        function sa(a) {
            for (var b = 0, c = a.length, d = ""; b < c; b++)
                d += a[b].value;
            return d
        }
        function ta(a, b, c) {
            var d = b.dir
              , e = b.next
              , f = e || d
              , g = c && "parentNode" === f
              , h = x++;
            return b.first ? function(b, c, e) {
                while (b = b[d])
                    if (1 === b.nodeType || g)
                        return a(b, c, e);
                return !1
            }
            : function(b, c, i) {
                var j, k, l, m = [w, h];
                if (i) {
                    while (b = b[d])
                        if ((1 === b.nodeType || g) && a(b, c, i))
                            return !0
                } else
                    while (b = b[d])
                        if (1 === b.nodeType || g)
                            if (l = b[u] || (b[u] = {}),
                            k = l[b.uniqueID] || (l[b.uniqueID] = {}),
                            e && e === b.nodeName.toLowerCase())
                                b = b[d] || b;
                            else {
                                if ((j = k[f]) && j[0] === w && j[1] === h)
                                    return m[2] = j[2];
                                if (k[f] = m,
                                m[2] = a(b, c, i))
                                    return !0
                            }
                return !1
            }
        }
        function ua(a) {
            return a.length > 1 ? function(b, c, d) {
                var e = a.length;
                while (e--)
                    if (!a[e](b, c, d))
                        return !1;
                return !0
            }
            : a[0]
        }
        function va(a, b, c) {
            for (var d = 0, e = b.length; d < e; d++)
                ga(a, b[d], c);
            return c
        }
        function wa(a, b, c, d, e) {
            for (var f, g = [], h = 0, i = a.length, j = null != b; h < i; h++)
                (f = a[h]) && (c && !c(f, d, e) || (g.push(f),
                j && b.push(h)));
            return g
        }
        function xa(a, b, c, d, e, f) {
            return d && !d[u] && (d = xa(d)),
            e && !e[u] && (e = xa(e, f)),
            ia(function(f, g, h, i) {
                var j, k, l, m = [], n = [], o = g.length, p = f || va(b || "*", h.nodeType ? [h] : h, []), q = !a || !f && b ? p : wa(p, m, a, h, i), r = c ? e || (f ? a : o || d) ? [] : g : q;
                if (c && c(q, r, h, i),
                d) {
                    j = wa(r, n),
                    d(j, [], h, i),
                    k = j.length;
                    while (k--)
                        (l = j[k]) && (r[n[k]] = !(q[n[k]] = l))
                }
                if (f) {
                    if (e || a) {
                        if (e) {
                            j = [],
                            k = r.length;
                            while (k--)
                                (l = r[k]) && j.push(q[k] = l);
                            e(null, r = [], j, i)
                        }
                        k = r.length;
                        while (k--)
                            (l = r[k]) && (j = e ? I(f, l) : m[k]) > -1 && (f[j] = !(g[j] = l))
                    }
                } else
                    r = wa(r === g ? r.splice(o, r.length) : r),
                    e ? e(null, g, r, i) : G.apply(g, r)
            })
        }
        function ya(a) {
            for (var b, c, e, f = a.length, g = d.relative[a[0].type], h = g || d.relative[" "], i = g ? 1 : 0, k = ta(function(a) {
                return a === b
            }, h, !0), l = ta(function(a) {
                return I(b, a) > -1
            }, h, !0), m = [function(a, c, d) {
                var e = !g && (d || c !== j) || ((b = c).nodeType ? k(a, c, d) : l(a, c, d));
                return b = null,
                e
            }
            ]; i < f; i++)
                if (c = d.relative[a[i].type])
                    m = [ta(ua(m), c)];
                else {
                    if (c = d.filter[a[i].type].apply(null, a[i].matches),
                    c[u]) {
                        for (e = ++i; e < f; e++)
                            if (d.relative[a[e].type])
                                break;
                        return xa(i > 1 && ua(m), i > 1 && sa(a.slice(0, i - 1).concat({
                            value: " " === a[i - 2].type ? "*" : ""
                        })).replace(P, "$1"), c, i < e && ya(a.slice(i, e)), e < f && ya(a = a.slice(e)), e < f && sa(a))
                    }
                    m.push(c)
                }
            return ua(m)
        }
        function za(a, b) {
            var c = b.length > 0
              , e = a.length > 0
              , f = function(f, g, h, i, k) {
                var l, o, q, r = 0, s = "0", t = f && [], u = [], v = j, x = f || e && d.find.TAG("*", k), y = w += null == v ? 1 : Math.random() || .1, z = x.length;
                for (k && (j = g === n || g || k); s !== z && null != (l = x[s]); s++) {
                    if (e && l) {
                        o = 0,
                        g || l.ownerDocument === n || (m(l),
                        h = !p);
                        while (q = a[o++])
                            if (q(l, g || n, h)) {
                                i.push(l);
                                break
                            }
                        k && (w = y)
                    }
                    c && ((l = !q && l) && r--,
                    f && t.push(l))
                }
                if (r += s,
                c && s !== r) {
                    o = 0;
                    while (q = b[o++])
                        q(t, u, g, h);
                    if (f) {
                        if (r > 0)
                            while (s--)
                                t[s] || u[s] || (u[s] = E.call(i));
                        u = wa(u)
                    }
                    G.apply(i, u),
                    k && !f && u.length > 0 && r + b.length > 1 && ga.uniqueSort(i)
                }
                return k && (w = y,
                j = v),
                t
            };
            return c ? ia(f) : f
        }
        return h = ga.compile = function(a, b) {
            var c, d = [], e = [], f = A[a + " "];
            if (!f) {
                b || (b = g(a)),
                c = b.length;
                while (c--)
                    f = ya(b[c]),
                    f[u] ? d.push(f) : e.push(f);
                f = A(a, za(e, d)),
                f.selector = a
            }
            return f
        }
        ,
        i = ga.select = function(a, b, c, e) {
            var f, i, j, k, l, m = "function" == typeof a && a, n = !e && g(a = m.selector || a);
            if (c = c || [],
            1 === n.length) {
                if (i = n[0] = n[0].slice(0),
                i.length > 2 && "ID" === (j = i[0]).type && 9 === b.nodeType && p && d.relative[i[1].type]) {
                    if (b = (d.find.ID(j.matches[0].replace(_, aa), b) || [])[0],
                    !b)
                        return c;
                    m && (b = b.parentNode),
                    a = a.slice(i.shift().value.length)
                }
                f = V.needsContext.test(a) ? 0 : i.length;
                while (f--) {
                    if (j = i[f],
                    d.relative[k = j.type])
                        break;
                    if ((l = d.find[k]) && (e = l(j.matches[0].replace(_, aa), $.test(i[0].type) && qa(b.parentNode) || b))) {
                        if (i.splice(f, 1),
                        a = e.length && sa(i),
                        !a)
                            return G.apply(c, e),
                            c;
                        break
                    }
                }
            }
            return (m || h(a, n))(e, b, !p, c, !b || $.test(a) && qa(b.parentNode) || b),
            c
        }
        ,
        c.sortStable = u.split("").sort(B).join("") === u,
        c.detectDuplicates = !!l,
        m(),
        c.sortDetached = ja(function(a) {
            return 1 & a.compareDocumentPosition(n.createElement("fieldset"))
        }),
        ja(function(a) {
            return a.innerHTML = "<a href='#'></a>",
            "#" === a.firstChild.getAttribute("href")
        }) || ka("type|href|height|width", function(a, b, c) {
            if (!c)
                return a.getAttribute(b, "type" === b.toLowerCase() ? 1 : 2)
        }),
        c.attributes && ja(function(a) {
            return a.innerHTML = "<input/>",
            a.firstChild.setAttribute("value", ""),
            "" === a.firstChild.getAttribute("value")
        }) || ka("value", function(a, b, c) {
            if (!c && "input" === a.nodeName.toLowerCase())
                return a.defaultValue
        }),
        ja(function(a) {
            return null == a.getAttribute("disabled")
        }) || ka(J, function(a, b, c) {
            var d;
            if (!c)
                return a[b] === !0 ? b.toLowerCase() : (d = a.getAttributeNode(b)) && d.specified ? d.value : null
        }),
        ga
    }(a);
    r.find = x,
    r.expr = x.selectors,
    r.expr[":"] = r.expr.pseudos,
    r.uniqueSort = r.unique = x.uniqueSort,
    r.text = x.getText,
    r.isXMLDoc = x.isXML,
    r.contains = x.contains,
    r.escapeSelector = x.escape;
    var y = function(a, b, c) {
        var d = []
          , e = void 0 !== c;
        while ((a = a[b]) && 9 !== a.nodeType)
            if (1 === a.nodeType) {
                if (e && r(a).is(c))
                    break;
                d.push(a)
            }
        return d
    }
      , z = function(a, b) {
        for (var c = []; a; a = a.nextSibling)
            1 === a.nodeType && a !== b && c.push(a);
        return c
    }
      , A = r.expr.match.needsContext
      , B = /^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i
      , C = /^.[^:#\[\.,]*$/;
    function D(a, b, c) {
        return r.isFunction(b) ? r.grep(a, function(a, d) {
            return !!b.call(a, d, a) !== c
        }) : b.nodeType ? r.grep(a, function(a) {
            return a === b !== c
        }) : "string" != typeof b ? r.grep(a, function(a) {
            return i.call(b, a) > -1 !== c
        }) : C.test(b) ? r.filter(b, a, c) : (b = r.filter(b, a),
        r.grep(a, function(a) {
            return i.call(b, a) > -1 !== c && 1 === a.nodeType
        }))
    }
    r.filter = function(a, b, c) {
        var d = b[0];
        return c && (a = ":not(" + a + ")"),
        1 === b.length && 1 === d.nodeType ? r.find.matchesSelector(d, a) ? [d] : [] : r.find.matches(a, r.grep(b, function(a) {
            return 1 === a.nodeType
        }))
    }
    ,
    r.fn.extend({
        find: function(a) {
            var b, c, d = this.length, e = this;
            if ("string" != typeof a)
                return this.pushStack(r(a).filter(function() {
                    for (b = 0; b < d; b++)
                        if (r.contains(e[b], this))
                            return !0
                }));
            for (c = this.pushStack([]),
            b = 0; b < d; b++)
                r.find(a, e[b], c);
            return d > 1 ? r.uniqueSort(c) : c
        },
        filter: function(a) {
            return this.pushStack(D(this, a || [], !1))
        },
        not: function(a) {
            return this.pushStack(D(this, a || [], !0))
        },
        is: function(a) {
            return !!D(this, "string" == typeof a && A.test(a) ? r(a) : a || [], !1).length
        }
    });
    var E, F = /^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/, G = r.fn.init = function(a, b, c) {
        var e, f;
        if (!a)
            return this;
        if (c = c || E,
        "string" == typeof a) {
            if (e = "<" === a[0] && ">" === a[a.length - 1] && a.length >= 3 ? [null, a, null] : F.exec(a),
            !e || !e[1] && b)
                return !b || b.jquery ? (b || c).find(a) : this.constructor(b).find(a);
            if (e[1]) {
                if (b = b instanceof r ? b[0] : b,
                r.merge(this, r.parseHTML(e[1], b && b.nodeType ? b.ownerDocument || b : d, !0)),
                B.test(e[1]) && r.isPlainObject(b))
                    for (e in b)
                        r.isFunction(this[e]) ? this[e](b[e]) : this.attr(e, b[e]);
                return this
            }
            return f = d.getElementById(e[2]),
            f && (this[0] = f,
            this.length = 1),
            this
        }
        return a.nodeType ? (this[0] = a,
        this.length = 1,
        this) : r.isFunction(a) ? void 0 !== c.ready ? c.ready(a) : a(r) : r.makeArray(a, this)
    }
    ;
    G.prototype = r.fn,
    E = r(d);
    var H = /^(?:parents|prev(?:Until|All))/
      , I = {
        children: !0,
        contents: !0,
        next: !0,
        prev: !0
    };
    r.fn.extend({
        has: function(a) {
            var b = r(a, this)
              , c = b.length;
            return this.filter(function() {
                for (var a = 0; a < c; a++)
                    if (r.contains(this, b[a]))
                        return !0
            })
        },
        closest: function(a, b) {
            var c, d = 0, e = this.length, f = [], g = "string" != typeof a && r(a);
            if (!A.test(a))
                for (; d < e; d++)
                    for (c = this[d]; c && c !== b; c = c.parentNode)
                        if (c.nodeType < 11 && (g ? g.index(c) > -1 : 1 === c.nodeType && r.find.matchesSelector(c, a))) {
                            f.push(c);
                            break
                        }
            return this.pushStack(f.length > 1 ? r.uniqueSort(f) : f)
        },
        index: function(a) {
            return a ? "string" == typeof a ? i.call(r(a), this[0]) : i.call(this, a.jquery ? a[0] : a) : this[0] && this[0].parentNode ? this.first().prevAll().length : -1
        },
        add: function(a, b) {
            return this.pushStack(r.uniqueSort(r.merge(this.get(), r(a, b))))
        },
        addBack: function(a) {
            return this.add(null == a ? this.prevObject : this.prevObject.filter(a))
        }
    });
    function J(a, b) {
        while ((a = a[b]) && 1 !== a.nodeType)
            ;
        return a
    }
    r.each({
        parent: function(a) {
            var b = a.parentNode;
            return b && 11 !== b.nodeType ? b : null
        },
        parents: function(a) {
            return y(a, "parentNode")
        },
        parentsUntil: function(a, b, c) {
            return y(a, "parentNode", c)
        },
        next: function(a) {
            return J(a, "nextSibling")
        },
        prev: function(a) {
            return J(a, "previousSibling")
        },
        nextAll: function(a) {
            return y(a, "nextSibling")
        },
        prevAll: function(a) {
            return y(a, "previousSibling")
        },
        nextUntil: function(a, b, c) {
            return y(a, "nextSibling", c)
        },
        prevUntil: function(a, b, c) {
            return y(a, "previousSibling", c)
        },
        siblings: function(a) {
            return z((a.parentNode || {}).firstChild, a)
        },
        children: function(a) {
            return z(a.firstChild)
        },
        contents: function(a) {
            return a.contentDocument || r.merge([], a.childNodes)
        }
    }, function(a, b) {
        r.fn[a] = function(c, d) {
            var e = r.map(this, b, c);
            return "Until" !== a.slice(-5) && (d = c),
            d && "string" == typeof d && (e = r.filter(d, e)),
            this.length > 1 && (I[a] || r.uniqueSort(e),
            H.test(a) && e.reverse()),
            this.pushStack(e)
        }
    });
    var K = /[^\x20\t\r\n\f]+/g;
    function L(a) {
        var b = {};
        return r.each(a.match(K) || [], function(a, c) {
            b[c] = !0
        }),
        b
    }
    r.Callbacks = function(a) {
        a = "string" == typeof a ? L(a) : r.extend({}, a);
        var b, c, d, e, f = [], g = [], h = -1, i = function() {
            for (e = a.once,
            d = b = !0; g.length; h = -1) {
                c = g.shift();
                while (++h < f.length)
                    f[h].apply(c[0], c[1]) === !1 && a.stopOnFalse && (h = f.length,
                    c = !1)
            }
            a.memory || (c = !1),
            b = !1,
            e && (f = c ? [] : "")
        }, j = {
            add: function() {
                return f && (c && !b && (h = f.length - 1,
                g.push(c)),
                function d(b) {
                    r.each(b, function(b, c) {
                        r.isFunction(c) ? a.unique && j.has(c) || f.push(c) : c && c.length && "string" !== r.type(c) && d(c)
                    })
                }(arguments),
                c && !b && i()),
                this
            },
            remove: function() {
                return r.each(arguments, function(a, b) {
                    var c;
                    while ((c = r.inArray(b, f, c)) > -1)
                        f.splice(c, 1),
                        c <= h && h--
                }),
                this
            },
            has: function(a) {
                return a ? r.inArray(a, f) > -1 : f.length > 0
            },
            empty: function() {
                return f && (f = []),
                this
            },
            disable: function() {
                return e = g = [],
                f = c = "",
                this
            },
            disabled: function() {
                return !f
            },
            lock: function() {
                return e = g = [],
                c || b || (f = c = ""),
                this
            },
            locked: function() {
                return !!e
            },
            fireWith: function(a, c) {
                return e || (c = c || [],
                c = [a, c.slice ? c.slice() : c],
                g.push(c),
                b || i()),
                this
            },
            fire: function() {
                return j.fireWith(this, arguments),
                this
            },
            fired: function() {
                return !!d
            }
        };
        return j
    }
    ;
    function M(a) {
        return a
    }
    function N(a) {
        throw a
    }
    function O(a, b, c) {
        var d;
        try {
            a && r.isFunction(d = a.promise) ? d.call(a).done(b).fail(c) : a && r.isFunction(d = a.then) ? d.call(a, b, c) : b.call(void 0, a)
        } catch (a) {
            c.call(void 0, a)
        }
    }
    r.extend({
        Deferred: function(b) {
            var c = [["notify", "progress", r.Callbacks("memory"), r.Callbacks("memory"), 2], ["resolve", "done", r.Callbacks("once memory"), r.Callbacks("once memory"), 0, "resolved"], ["reject", "fail", r.Callbacks("once memory"), r.Callbacks("once memory"), 1, "rejected"]]
              , d = "pending"
              , e = {
                state: function() {
                    return d
                },
                always: function() {
                    return f.done(arguments).fail(arguments),
                    this
                },
                "catch": function(a) {
                    return e.then(null, a)
                },
                pipe: function() {
                    var a = arguments;
                    return r.Deferred(function(b) {
                        r.each(c, function(c, d) {
                            var e = r.isFunction(a[d[4]]) && a[d[4]];
                            f[d[1]](function() {
                                var a = e && e.apply(this, arguments);
                                a && r.isFunction(a.promise) ? a.promise().progress(b.notify).done(b.resolve).fail(b.reject) : b[d[0] + "With"](this, e ? [a] : arguments)
                            })
                        }),
                        a = null
                    }).promise()
                },
                then: function(b, d, e) {
                    var f = 0;
                    function g(b, c, d, e) {
                        return function() {
                            var h = this
                              , i = arguments
                              , j = function() {
                                var a, j;
                                if (!(b < f)) {
                                    if (a = d.apply(h, i),
                                    a === c.promise())
                                        throw new TypeError("Thenable self-resolution");
                                    j = a && ("object" == typeof a || "function" == typeof a) && a.then,
                                    r.isFunction(j) ? e ? j.call(a, g(f, c, M, e), g(f, c, N, e)) : (f++,
                                    j.call(a, g(f, c, M, e), g(f, c, N, e), g(f, c, M, c.notifyWith))) : (d !== M && (h = void 0,
                                    i = [a]),
                                    (e || c.resolveWith)(h, i))
                                }
                            }
                              , k = e ? j : function() {
                                try {
                                    j()
                                } catch (a) {
                                    r.Deferred.exceptionHook && r.Deferred.exceptionHook(a, k.stackTrace),
                                    b + 1 >= f && (d !== N && (h = void 0,
                                    i = [a]),
                                    c.rejectWith(h, i))
                                }
                            }
                            ;
                            b ? k() : (r.Deferred.getStackHook && (k.stackTrace = r.Deferred.getStackHook()),
                            a.setTimeout(k))
                        }
                    }
                    return r.Deferred(function(a) {
                        c[0][3].add(g(0, a, r.isFunction(e) ? e : M, a.notifyWith)),
                        c[1][3].add(g(0, a, r.isFunction(b) ? b : M)),
                        c[2][3].add(g(0, a, r.isFunction(d) ? d : N))
                    }).promise()
                },
                promise: function(a) {
                    return null != a ? r.extend(a, e) : e
                }
            }
              , f = {};
            return r.each(c, function(a, b) {
                var g = b[2]
                  , h = b[5];
                e[b[1]] = g.add,
                h && g.add(function() {
                    d = h
                }, c[3 - a][2].disable, c[0][2].lock),
                g.add(b[3].fire),
                f[b[0]] = function() {
                    return f[b[0] + "With"](this === f ? void 0 : this, arguments),
                    this
                }
                ,
                f[b[0] + "With"] = g.fireWith
            }),
            e.promise(f),
            b && b.call(f, f),
            f
        },
        when: function(a) {
            var b = arguments.length
              , c = b
              , d = Array(c)
              , e = f.call(arguments)
              , g = r.Deferred()
              , h = function(a) {
                return function(c) {
                    d[a] = this,
                    e[a] = arguments.length > 1 ? f.call(arguments) : c,
                    --b || g.resolveWith(d, e)
                }
            };
            if (b <= 1 && (O(a, g.done(h(c)).resolve, g.reject),
            "pending" === g.state() || r.isFunction(e[c] && e[c].then)))
                return g.then();
            while (c--)
                O(e[c], h(c), g.reject);
            return g.promise()
        }
    });
    var P = /^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;
    r.Deferred.exceptionHook = function(b, c) {
        a.console && a.console.warn && b && P.test(b.name) && a.console.warn("jQuery.Deferred exception: " + b.message, b.stack, c)
    }
    ,
    r.readyException = function(b) {
        a.setTimeout(function() {
            throw b
        })
    }
    ;
    var Q = r.Deferred();
    r.fn.ready = function(a) {
        return Q.then(a)["catch"](function(a) {
            r.readyException(a)
        }),
        this
    }
    ,
    r.extend({
        isReady: !1,
        readyWait: 1,
        holdReady: function(a) {
            a ? r.readyWait++ : r.ready(!0)
        },
        ready: function(a) {
            (a === !0 ? --r.readyWait : r.isReady) || (r.isReady = !0,
            a !== !0 && --r.readyWait > 0 || Q.resolveWith(d, [r]))
        }
    }),
    r.ready.then = Q.then;
    function R() {
        d.removeEventListener("DOMContentLoaded", R),
        a.removeEventListener("load", R),
        r.ready()
    }
    "complete" === d.readyState || "loading" !== d.readyState && !d.documentElement.doScroll ? a.setTimeout(r.ready) : (d.addEventListener("DOMContentLoaded", R),
    a.addEventListener("load", R));
    var S = function(a, b, c, d, e, f, g) {
        var h = 0
          , i = a.length
          , j = null == c;
        if ("object" === r.type(c)) {
            e = !0;
            for (h in c)
                S(a, b, h, c[h], !0, f, g)
        } else if (void 0 !== d && (e = !0,
        r.isFunction(d) || (g = !0),
        j && (g ? (b.call(a, d),
        b = null) : (j = b,
        b = function(a, b, c) {
            return j.call(r(a), c)
        }
        )),
        b))
            for (; h < i; h++)
                b(a[h], c, g ? d : d.call(a[h], h, b(a[h], c)));
        return e ? a : j ? b.call(a) : i ? b(a[0], c) : f
    }
      , T = function(a) {
        return 1 === a.nodeType || 9 === a.nodeType || !+a.nodeType
    };
    function U() {
        this.expando = r.expando + U.uid++
    }
    U.uid = 1,
    U.prototype = {
        cache: function(a) {
            var b = a[this.expando];
            return b || (b = {},
            T(a) && (a.nodeType ? a[this.expando] = b : Object.defineProperty(a, this.expando, {
                value: b,
                configurable: !0
            }))),
            b
        },
        set: function(a, b, c) {
            var d, e = this.cache(a);
            if ("string" == typeof b)
                e[r.camelCase(b)] = c;
            else
                for (d in b)
                    e[r.camelCase(d)] = b[d];
            return e
        },
        get: function(a, b) {
            return void 0 === b ? this.cache(a) : a[this.expando] && a[this.expando][r.camelCase(b)]
        },
        access: function(a, b, c) {
            return void 0 === b || b && "string" == typeof b && void 0 === c ? this.get(a, b) : (this.set(a, b, c),
            void 0 !== c ? c : b)
        },
        remove: function(a, b) {
            var c, d = a[this.expando];
            if (void 0 !== d) {
                if (void 0 !== b) {
                    r.isArray(b) ? b = b.map(r.camelCase) : (b = r.camelCase(b),
                    b = b in d ? [b] : b.match(K) || []),
                    c = b.length;
                    while (c--)
                        delete d[b[c]]
                }
                (void 0 === b || r.isEmptyObject(d)) && (a.nodeType ? a[this.expando] = void 0 : delete a[this.expando])
            }
        },
        hasData: function(a) {
            var b = a[this.expando];
            return void 0 !== b && !r.isEmptyObject(b)
        }
    };
    var V = new U
      , W = new U
      , X = /^(?:\{[\w\W]*\}|\[[\w\W]*\])$/
      , Y = /[A-Z]/g;
    function Z(a) {
        return "true" === a || "false" !== a && ("null" === a ? null : a === +a + "" ? +a : X.test(a) ? JSON.parse(a) : a)
    }
    function $(a, b, c) {
        var d;
        if (void 0 === c && 1 === a.nodeType)
            if (d = "data-" + b.replace(Y, "-$&").toLowerCase(),
            c = a.getAttribute(d),
            "string" == typeof c) {
                try {
                    c = Z(c)
                } catch (e) {}
                W.set(a, b, c)
            } else
                c = void 0;
        return c
    }
    r.extend({
        hasData: function(a) {
            return W.hasData(a) || V.hasData(a)
        },
        data: function(a, b, c) {
            return W.access(a, b, c)
        },
        removeData: function(a, b) {
            W.remove(a, b)
        },
        _data: function(a, b, c) {
            return V.access(a, b, c)
        },
        _removeData: function(a, b) {
            V.remove(a, b)
        }
    }),
    r.fn.extend({
        data: function(a, b) {
            var c, d, e, f = this[0], g = f && f.attributes;
            if (void 0 === a) {
                if (this.length && (e = W.get(f),
                1 === f.nodeType && !V.get(f, "hasDataAttrs"))) {
                    c = g.length;
                    while (c--)
                        g[c] && (d = g[c].name,
                        0 === d.indexOf("data-") && (d = r.camelCase(d.slice(5)),
                        $(f, d, e[d])));
                    V.set(f, "hasDataAttrs", !0)
                }
                return e
            }
            return "object" == typeof a ? this.each(function() {
                W.set(this, a)
            }) : S(this, function(b) {
                var c;
                if (f && void 0 === b) {
                    if (c = W.get(f, a),
                    void 0 !== c)
                        return c;
                    if (c = $(f, a),
                    void 0 !== c)
                        return c
                } else
                    this.each(function() {
                        W.set(this, a, b)
                    })
            }, null, b, arguments.length > 1, null, !0)
        },
        removeData: function(a) {
            return this.each(function() {
                W.remove(this, a)
            })
        }
    }),
    r.extend({
        queue: function(a, b, c) {
            var d;
            if (a)
                return b = (b || "fx") + "queue",
                d = V.get(a, b),
                c && (!d || r.isArray(c) ? d = V.access(a, b, r.makeArray(c)) : d.push(c)),
                d || []
        },
        dequeue: function(a, b) {
            b = b || "fx";
            var c = r.queue(a, b)
              , d = c.length
              , e = c.shift()
              , f = r._queueHooks(a, b)
              , g = function() {
                r.dequeue(a, b)
            };
            "inprogress" === e && (e = c.shift(),
            d--),
            e && ("fx" === b && c.unshift("inprogress"),
            delete f.stop,
            e.call(a, g, f)),
            !d && f && f.empty.fire()
        },
        _queueHooks: function(a, b) {
            var c = b + "queueHooks";
            return V.get(a, c) || V.access(a, c, {
                empty: r.Callbacks("once memory").add(function() {
                    V.remove(a, [b + "queue", c])
                })
            })
        }
    }),
    r.fn.extend({
        queue: function(a, b) {
            var c = 2;
            return "string" != typeof a && (b = a,
            a = "fx",
            c--),
            arguments.length < c ? r.queue(this[0], a) : void 0 === b ? this : this.each(function() {
                var c = r.queue(this, a, b);
                r._queueHooks(this, a),
                "fx" === a && "inprogress" !== c[0] && r.dequeue(this, a)
            })
        },
        dequeue: function(a) {
            return this.each(function() {
                r.dequeue(this, a)
            })
        },
        clearQueue: function(a) {
            return this.queue(a || "fx", [])
        },
        promise: function(a, b) {
            var c, d = 1, e = r.Deferred(), f = this, g = this.length, h = function() {
                --d || e.resolveWith(f, [f])
            };
            "string" != typeof a && (b = a,
            a = void 0),
            a = a || "fx";
            while (g--)
                c = V.get(f[g], a + "queueHooks"),
                c && c.empty && (d++,
                c.empty.add(h));
            return h(),
            e.promise(b)
        }
    });
    var _ = /[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source
      , aa = new RegExp("^(?:([+-])=|)(" + _ + ")([a-z%]*)$","i")
      , ba = ["Top", "Right", "Bottom", "Left"]
      , ca = function(a, b) {
        return a = b || a,
        "none" === a.style.display || "" === a.style.display && r.contains(a.ownerDocument, a) && "none" === r.css(a, "display")
    }
      , da = function(a, b, c, d) {
        var e, f, g = {};
        for (f in b)
            g[f] = a.style[f],
            a.style[f] = b[f];
        e = c.apply(a, d || []);
        for (f in b)
            a.style[f] = g[f];
        return e
    };
    function ea(a, b, c, d) {
        var e, f = 1, g = 20, h = d ? function() {
            return d.cur()
        }
        : function() {
            return r.css(a, b, "")
        }
        , i = h(), j = c && c[3] || (r.cssNumber[b] ? "" : "px"), k = (r.cssNumber[b] || "px" !== j && +i) && aa.exec(r.css(a, b));
        if (k && k[3] !== j) {
            j = j || k[3],
            c = c || [],
            k = +i || 1;
            do
                f = f || ".5",
                k /= f,
                r.style(a, b, k + j);
            while (f !== (f = h() / i) && 1 !== f && --g)
        }
        return c && (k = +k || +i || 0,
        e = c[1] ? k + (c[1] + 1) * c[2] : +c[2],
        d && (d.unit = j,
        d.start = k,
        d.end = e)),
        e
    }
    var fa = {};
    function ga(a) {
        var b, c = a.ownerDocument, d = a.nodeName, e = fa[d];
        return e ? e : (b = c.body.appendChild(c.createElement(d)),
        e = r.css(b, "display"),
        b.parentNode.removeChild(b),
        "none" === e && (e = "block"),
        fa[d] = e,
        e)
    }
    function ha(a, b) {
        for (var c, d, e = [], f = 0, g = a.length; f < g; f++)
            d = a[f],
            d.style && (c = d.style.display,
            b ? ("none" === c && (e[f] = V.get(d, "display") || null,
            e[f] || (d.style.display = "")),
            "" === d.style.display && ca(d) && (e[f] = ga(d))) : "none" !== c && (e[f] = "none",
            V.set(d, "display", c)));
        for (f = 0; f < g; f++)
            null != e[f] && (a[f].style.display = e[f]);
        return a
    }
    r.fn.extend({
        show: function() {
            return ha(this, !0)
        },
        hide: function() {
            return ha(this)
        },
        toggle: function(a) {
            return "boolean" == typeof a ? a ? this.show() : this.hide() : this.each(function() {
                ca(this) ? r(this).show() : r(this).hide()
            })
        }
    });
    var ia = /^(?:checkbox|radio)$/i
      , ja = /<([a-z][^\/\0>\x20\t\r\n\f]+)/i
      , ka = /^$|\/(?:java|ecma)script/i
      , la = {
        option: [1, "<select multiple='multiple'>", "</select>"],
        thead: [1, "<table>", "</table>"],
        col: [2, "<table><colgroup>", "</colgroup></table>"],
        tr: [2, "<table><tbody>", "</tbody></table>"],
        td: [3, "<table><tbody><tr>", "</tr></tbody></table>"],
        _default: [0, "", ""]
    };
    la.optgroup = la.option,
    la.tbody = la.tfoot = la.colgroup = la.caption = la.thead,
    la.th = la.td;
    function ma(a, b) {
        var c;
        return c = "undefined" != typeof a.getElementsByTagName ? a.getElementsByTagName(b || "*") : "undefined" != typeof a.querySelectorAll ? a.querySelectorAll(b || "*") : [],
        void 0 === b || b && r.nodeName(a, b) ? r.merge([a], c) : c
    }
    function na(a, b) {
        for (var c = 0, d = a.length; c < d; c++)
            V.set(a[c], "globalEval", !b || V.get(b[c], "globalEval"))
    }
    var oa = /<|&#?\w+;/;
    function pa(a, b, c, d, e) {
        for (var f, g, h, i, j, k, l = b.createDocumentFragment(), m = [], n = 0, o = a.length; n < o; n++)
            if (f = a[n],
            f || 0 === f)
                if ("object" === r.type(f))
                    r.merge(m, f.nodeType ? [f] : f);
                else if (oa.test(f)) {
                    g = g || l.appendChild(b.createElement("div")),
                    h = (ja.exec(f) || ["", ""])[1].toLowerCase(),
                    i = la[h] || la._default,
                    g.innerHTML = i[1] + r.htmlPrefilter(f) + i[2],
                    k = i[0];
                    while (k--)
                        g = g.lastChild;
                    r.merge(m, g.childNodes),
                    g = l.firstChild,
                    g.textContent = ""
                } else
                    m.push(b.createTextNode(f));
        l.textContent = "",
        n = 0;
        while (f = m[n++])
            if (d && r.inArray(f, d) > -1)
                e && e.push(f);
            else if (j = r.contains(f.ownerDocument, f),
            g = ma(l.appendChild(f), "script"),
            j && na(g),
            c) {
                k = 0;
                while (f = g[k++])
                    ka.test(f.type || "") && c.push(f)
            }
        return l
    }
    !function() {
        var a = d.createDocumentFragment()
          , b = a.appendChild(d.createElement("div"))
          , c = d.createElement("input");
        c.setAttribute("type", "radio"),
        c.setAttribute("checked", "checked"),
        c.setAttribute("name", "t"),
        b.appendChild(c),
        o.checkClone = b.cloneNode(!0).cloneNode(!0).lastChild.checked,
        b.innerHTML = "<textarea>x</textarea>",
        o.noCloneChecked = !!b.cloneNode(!0).lastChild.defaultValue
    }();
    var qa = d.documentElement
      , ra = /^key/
      , sa = /^(?:mouse|pointer|contextmenu|drag|drop)|click/
      , ta = /^([^.]*)(?:\.(.+)|)/;
    function ua() {
        return !0
    }
    function va() {
        return !1
    }
    function wa() {
        try {
            return d.activeElement
        } catch (a) {}
    }
    function xa(a, b, c, d, e, f) {
        var g, h;
        if ("object" == typeof b) {
            "string" != typeof c && (d = d || c,
            c = void 0);
            for (h in b)
                xa(a, h, c, d, b[h], f);
            return a
        }
        if (null == d && null == e ? (e = c,
        d = c = void 0) : null == e && ("string" == typeof c ? (e = d,
        d = void 0) : (e = d,
        d = c,
        c = void 0)),
        e === !1)
            e = va;
        else if (!e)
            return a;
        return 1 === f && (g = e,
        e = function(a) {
            return r().off(a),
            g.apply(this, arguments)
        }
        ,
        e.guid = g.guid || (g.guid = r.guid++)),
        a.each(function() {
            r.event.add(this, b, e, d, c)
        })
    }
    r.event = {
        global: {},
        add: function(a, b, c, d, e) {
            var f, g, h, i, j, k, l, m, n, o, p, q = V.get(a);
            if (q) {
                c.handler && (f = c,
                c = f.handler,
                e = f.selector),
                e && r.find.matchesSelector(qa, e),
                c.guid || (c.guid = r.guid++),
                (i = q.events) || (i = q.events = {}),
                (g = q.handle) || (g = q.handle = function(b) {
                    return "undefined" != typeof r && r.event.triggered !== b.type ? r.event.dispatch.apply(a, arguments) : void 0
                }
                ),
                b = (b || "").match(K) || [""],
                j = b.length;
                while (j--)
                    h = ta.exec(b[j]) || [],
                    n = p = h[1],
                    o = (h[2] || "").split(".").sort(),
                    n && (l = r.event.special[n] || {},
                    n = (e ? l.delegateType : l.bindType) || n,
                    l = r.event.special[n] || {},
                    k = r.extend({
                        type: n,
                        origType: p,
                        data: d,
                        handler: c,
                        guid: c.guid,
                        selector: e,
                        needsContext: e && r.expr.match.needsContext.test(e),
                        namespace: o.join(".")
                    }, f),
                    (m = i[n]) || (m = i[n] = [],
                    m.delegateCount = 0,
                    l.setup && l.setup.call(a, d, o, g) !== !1 || a.addEventListener && a.addEventListener(n, g)),
                    l.add && (l.add.call(a, k),
                    k.handler.guid || (k.handler.guid = c.guid)),
                    e ? m.splice(m.delegateCount++, 0, k) : m.push(k),
                    r.event.global[n] = !0)
            }
        },
        remove: function(a, b, c, d, e) {
            var f, g, h, i, j, k, l, m, n, o, p, q = V.hasData(a) && V.get(a);
            if (q && (i = q.events)) {
                b = (b || "").match(K) || [""],
                j = b.length;
                while (j--)
                    if (h = ta.exec(b[j]) || [],
                    n = p = h[1],
                    o = (h[2] || "").split(".").sort(),
                    n) {
                        l = r.event.special[n] || {},
                        n = (d ? l.delegateType : l.bindType) || n,
                        m = i[n] || [],
                        h = h[2] && new RegExp("(^|\\.)" + o.join("\\.(?:.*\\.|)") + "(\\.|$)"),
                        g = f = m.length;
                        while (f--)
                            k = m[f],
                            !e && p !== k.origType || c && c.guid !== k.guid || h && !h.test(k.namespace) || d && d !== k.selector && ("**" !== d || !k.selector) || (m.splice(f, 1),
                            k.selector && m.delegateCount--,
                            l.remove && l.remove.call(a, k));
                        g && !m.length && (l.teardown && l.teardown.call(a, o, q.handle) !== !1 || r.removeEvent(a, n, q.handle),
                        delete i[n])
                    } else
                        for (n in i)
                            r.event.remove(a, n + b[j], c, d, !0);
                r.isEmptyObject(i) && V.remove(a, "handle events")
            }
        },
        dispatch: function(a) {
            var b = r.event.fix(a), c, d, e, f, g, h, i = new Array(arguments.length), j = (V.get(this, "events") || {})[b.type] || [], k = r.event.special[b.type] || {};
            for (i[0] = b,
            c = 1; c < arguments.length; c++)
                i[c] = arguments[c];
            if (b.delegateTarget = this,
            !k.preDispatch || k.preDispatch.call(this, b) !== !1) {
                h = r.event.handlers.call(this, b, j),
                c = 0;
                while ((f = h[c++]) && !b.isPropagationStopped()) {
                    b.currentTarget = f.elem,
                    d = 0;
                    while ((g = f.handlers[d++]) && !b.isImmediatePropagationStopped())
                        b.rnamespace && !b.rnamespace.test(g.namespace) || (b.handleObj = g,
                        b.data = g.data,
                        e = ((r.event.special[g.origType] || {}).handle || g.handler).apply(f.elem, i),
                        void 0 !== e && (b.result = e) === !1 && (b.preventDefault(),
                        b.stopPropagation()))
                }
                return k.postDispatch && k.postDispatch.call(this, b),
                b.result
            }
        },
        handlers: function(a, b) {
            var c, d, e, f, g, h = [], i = b.delegateCount, j = a.target;
            if (i && j.nodeType && !("click" === a.type && a.button >= 1))
                for (; j !== this; j = j.parentNode || this)
                    if (1 === j.nodeType && ("click" !== a.type || j.disabled !== !0)) {
                        for (f = [],
                        g = {},
                        c = 0; c < i; c++)
                            d = b[c],
                            e = d.selector + " ",
                            void 0 === g[e] && (g[e] = d.needsContext ? r(e, this).index(j) > -1 : r.find(e, this, null, [j]).length),
                            g[e] && f.push(d);
                        f.length && h.push({
                            elem: j,
                            handlers: f
                        })
                    }
            return j = this,
            i < b.length && h.push({
                elem: j,
                handlers: b.slice(i)
            }),
            h
        },
        addProp: function(a, b) {
            Object.defineProperty(r.Event.prototype, a, {
                enumerable: !0,
                configurable: !0,
                get: r.isFunction(b) ? function() {
                    if (this.originalEvent)
                        return b(this.originalEvent)
                }
                : function() {
                    if (this.originalEvent)
                        return this.originalEvent[a]
                }
                ,
                set: function(b) {
                    Object.defineProperty(this, a, {
                        enumerable: !0,
                        configurable: !0,
                        writable: !0,
                        value: b
                    })
                }
            })
        },
        fix: function(a) {
            return a[r.expando] ? a : new r.Event(a)
        },
        special: {
            load: {
                noBubble: !0
            },
            focus: {
                trigger: function() {
                    if (this !== wa() && this.focus)
                        return this.focus(),
                        !1
                },
                delegateType: "focusin"
            },
            blur: {
                trigger: function() {
                    if (this === wa() && this.blur)
                        return this.blur(),
                        !1
                },
                delegateType: "focusout"
            },
            click: {
                trigger: function() {
                    if ("checkbox" === this.type && this.click && r.nodeName(this, "input"))
                        return this.click(),
                        !1
                },
                _default: function(a) {
                    return r.nodeName(a.target, "a")
                }
            },
            beforeunload: {
                postDispatch: function(a) {
                    void 0 !== a.result && a.originalEvent && (a.originalEvent.returnValue = a.result)
                }
            }
        }
    },
    r.removeEvent = function(a, b, c) {
        a.removeEventListener && a.removeEventListener(b, c)
    }
    ,
    r.Event = function(a, b) {
        return this instanceof r.Event ? (a && a.type ? (this.originalEvent = a,
        this.type = a.type,
        this.isDefaultPrevented = a.defaultPrevented || void 0 === a.defaultPrevented && a.returnValue === !1 ? ua : va,
        this.target = a.target && 3 === a.target.nodeType ? a.target.parentNode : a.target,
        this.currentTarget = a.currentTarget,
        this.relatedTarget = a.relatedTarget) : this.type = a,
        b && r.extend(this, b),
        this.timeStamp = a && a.timeStamp || r.now(),
        void (this[r.expando] = !0)) : new r.Event(a,b)
    }
    ,
    r.Event.prototype = {
        constructor: r.Event,
        isDefaultPrevented: va,
        isPropagationStopped: va,
        isImmediatePropagationStopped: va,
        isSimulated: !1,
        preventDefault: function() {
            var a = this.originalEvent;
            this.isDefaultPrevented = ua,
            a && !this.isSimulated && a.preventDefault()
        },
        stopPropagation: function() {
            var a = this.originalEvent;
            this.isPropagationStopped = ua,
            a && !this.isSimulated && a.stopPropagation()
        },
        stopImmediatePropagation: function() {
            var a = this.originalEvent;
            this.isImmediatePropagationStopped = ua,
            a && !this.isSimulated && a.stopImmediatePropagation(),
            this.stopPropagation()
        }
    },
    r.each({
        altKey: !0,
        bubbles: !0,
        cancelable: !0,
        changedTouches: !0,
        ctrlKey: !0,
        detail: !0,
        eventPhase: !0,
        metaKey: !0,
        pageX: !0,
        pageY: !0,
        shiftKey: !0,
        view: !0,
        "char": !0,
        charCode: !0,
        key: !0,
        keyCode: !0,
        button: !0,
        buttons: !0,
        clientX: !0,
        clientY: !0,
        offsetX: !0,
        offsetY: !0,
        pointerId: !0,
        pointerType: !0,
        screenX: !0,
        screenY: !0,
        targetTouches: !0,
        toElement: !0,
        touches: !0,
        which: function(a) {
            var b = a.button;
            return null == a.which && ra.test(a.type) ? null != a.charCode ? a.charCode : a.keyCode : !a.which && void 0 !== b && sa.test(a.type) ? 1 & b ? 1 : 2 & b ? 3 : 4 & b ? 2 : 0 : a.which
        }
    }, r.event.addProp),
    r.each({
        mouseenter: "mouseover",
        mouseleave: "mouseout",
        pointerenter: "pointerover",
        pointerleave: "pointerout"
    }, function(a, b) {
        r.event.special[a] = {
            delegateType: b,
            bindType: b,
            handle: function(a) {
                var c, d = this, e = a.relatedTarget, f = a.handleObj;
                return e && (e === d || r.contains(d, e)) || (a.type = f.origType,
                c = f.handler.apply(this, arguments),
                a.type = b),
                c
            }
        }
    }),
    r.fn.extend({
        on: function(a, b, c, d) {
            return xa(this, a, b, c, d)
        },
        one: function(a, b, c, d) {
            return xa(this, a, b, c, d, 1)
        },
        off: function(a, b, c) {
            var d, e;
            if (a && a.preventDefault && a.handleObj)
                return d = a.handleObj,
                r(a.delegateTarget).off(d.namespace ? d.origType + "." + d.namespace : d.origType, d.selector, d.handler),
                this;
            if ("object" == typeof a) {
                for (e in a)
                    this.off(e, b, a[e]);
                return this
            }
            return b !== !1 && "function" != typeof b || (c = b,
            b = void 0),
            c === !1 && (c = va),
            this.each(function() {
                r.event.remove(this, a, c, b)
            })
        }
    });
    var ya = /<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\/\0>\x20\t\r\n\f]*)[^>]*)\/>/gi
      , za = /<script|<style|<link/i
      , Aa = /checked\s*(?:[^=]|=\s*.checked.)/i
      , Ba = /^true\/(.*)/
      , Ca = /^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;
    function Da(a, b) {
        return r.nodeName(a, "table") && r.nodeName(11 !== b.nodeType ? b : b.firstChild, "tr") ? a.getElementsByTagName("tbody")[0] || a : a
    }
    function Ea(a) {
        return a.type = (null !== a.getAttribute("type")) + "/" + a.type,
        a
    }
    function Fa(a) {
        var b = Ba.exec(a.type);
        return b ? a.type = b[1] : a.removeAttribute("type"),
        a
    }
    function Ga(a, b) {
        var c, d, e, f, g, h, i, j;
        if (1 === b.nodeType) {
            if (V.hasData(a) && (f = V.access(a),
            g = V.set(b, f),
            j = f.events)) {
                delete g.handle,
                g.events = {};
                for (e in j)
                    for (c = 0,
                    d = j[e].length; c < d; c++)
                        r.event.add(b, e, j[e][c])
            }
            W.hasData(a) && (h = W.access(a),
            i = r.extend({}, h),
            W.set(b, i))
        }
    }
    function Ha(a, b) {
        var c = b.nodeName.toLowerCase();
        "input" === c && ia.test(a.type) ? b.checked = a.checked : "input" !== c && "textarea" !== c || (b.defaultValue = a.defaultValue)
    }
    function Ia(a, b, c, d) {
        b = g.apply([], b);
        var e, f, h, i, j, k, l = 0, m = a.length, n = m - 1, q = b[0], s = r.isFunction(q);
        if (s || m > 1 && "string" == typeof q && !o.checkClone && Aa.test(q))
            return a.each(function(e) {
                var f = a.eq(e);
                s && (b[0] = q.call(this, e, f.html())),
                Ia(f, b, c, d)
            });
        if (m && (e = pa(b, a[0].ownerDocument, !1, a, d),
        f = e.firstChild,
        1 === e.childNodes.length && (e = f),
        f || d)) {
            for (h = r.map(ma(e, "script"), Ea),
            i = h.length; l < m; l++)
                j = e,
                l !== n && (j = r.clone(j, !0, !0),
                i && r.merge(h, ma(j, "script"))),
                c.call(a[l], j, l);
            if (i)
                for (k = h[h.length - 1].ownerDocument,
                r.map(h, Fa),
                l = 0; l < i; l++)
                    j = h[l],
                    ka.test(j.type || "") && !V.access(j, "globalEval") && r.contains(k, j) && (j.src ? r._evalUrl && r._evalUrl(j.src) : p(j.textContent.replace(Ca, ""), k))
        }
        return a
    }
    function Ja(a, b, c) {
        for (var d, e = b ? r.filter(b, a) : a, f = 0; null != (d = e[f]); f++)
            c || 1 !== d.nodeType || r.cleanData(ma(d)),
            d.parentNode && (c && r.contains(d.ownerDocument, d) && na(ma(d, "script")),
            d.parentNode.removeChild(d));
        return a
    }
    r.extend({
        htmlPrefilter: function(a) {
            return a.replace(ya, "<$1></$2>")
        },
        clone: function(a, b, c) {
            var d, e, f, g, h = a.cloneNode(!0), i = r.contains(a.ownerDocument, a);
            if (!(o.noCloneChecked || 1 !== a.nodeType && 11 !== a.nodeType || r.isXMLDoc(a)))
                for (g = ma(h),
                f = ma(a),
                d = 0,
                e = f.length; d < e; d++)
                    Ha(f[d], g[d]);
            if (b)
                if (c)
                    for (f = f || ma(a),
                    g = g || ma(h),
                    d = 0,
                    e = f.length; d < e; d++)
                        Ga(f[d], g[d]);
                else
                    Ga(a, h);
            return g = ma(h, "script"),
            g.length > 0 && na(g, !i && ma(a, "script")),
            h
        },
        cleanData: function(a) {
            for (var b, c, d, e = r.event.special, f = 0; void 0 !== (c = a[f]); f++)
                if (T(c)) {
                    if (b = c[V.expando]) {
                        if (b.events)
                            for (d in b.events)
                                e[d] ? r.event.remove(c, d) : r.removeEvent(c, d, b.handle);
                        c[V.expando] = void 0
                    }
                    c[W.expando] && (c[W.expando] = void 0)
                }
        }
    }),
    r.fn.extend({
        detach: function(a) {
            return Ja(this, a, !0)
        },
        remove: function(a) {
            return Ja(this, a)
        },
        text: function(a) {
            return S(this, function(a) {
                return void 0 === a ? r.text(this) : this.empty().each(function() {
                    1 !== this.nodeType && 11 !== this.nodeType && 9 !== this.nodeType || (this.textContent = a)
                })
            }, null, a, arguments.length)
        },
        append: function() {
            return Ia(this, arguments, function(a) {
                if (1 === this.nodeType || 11 === this.nodeType || 9 === this.nodeType) {
                    var b = Da(this, a);
                    b.appendChild(a)
                }
            })
        },
        prepend: function() {
            return Ia(this, arguments, function(a) {
                if (1 === this.nodeType || 11 === this.nodeType || 9 === this.nodeType) {
                    var b = Da(this, a);
                    b.insertBefore(a, b.firstChild)
                }
            })
        },
        before: function() {
            return Ia(this, arguments, function(a) {
                this.parentNode && this.parentNode.insertBefore(a, this)
            })
        },
        after: function() {
            return Ia(this, arguments, function(a) {
                this.parentNode && this.parentNode.insertBefore(a, this.nextSibling)
            })
        },
        empty: function() {
            for (var a, b = 0; null != (a = this[b]); b++)
                1 === a.nodeType && (r.cleanData(ma(a, !1)),
                a.textContent = "");
            return this
        },
        clone: function(a, b) {
            return a = null != a && a,
            b = null == b ? a : b,
            this.map(function() {
                return r.clone(this, a, b)
            })
        },
        html: function(a) {
            return S(this, function(a) {
                var b = this[0] || {}
                  , c = 0
                  , d = this.length;
                if (void 0 === a && 1 === b.nodeType)
                    return b.innerHTML;
                if ("string" == typeof a && !za.test(a) && !la[(ja.exec(a) || ["", ""])[1].toLowerCase()]) {
                    a = r.htmlPrefilter(a);
                    try {
                        for (; c < d; c++)
                            b = this[c] || {},
                            1 === b.nodeType && (r.cleanData(ma(b, !1)),
                            b.innerHTML = a);
                        b = 0
                    } catch (e) {}
                }
                b && this.empty().append(a)
            }, null, a, arguments.length)
        },
        replaceWith: function() {
            var a = [];
            return Ia(this, arguments, function(b) {
                var c = this.parentNode;
                r.inArray(this, a) < 0 && (r.cleanData(ma(this)),
                c && c.replaceChild(b, this))
            }, a)
        }
    }),
    r.each({
        appendTo: "append",
        prependTo: "prepend",
        insertBefore: "before",
        insertAfter: "after",
        replaceAll: "replaceWith"
    }, function(a, b) {
        r.fn[a] = function(a) {
            for (var c, d = [], e = r(a), f = e.length - 1, g = 0; g <= f; g++)
                c = g === f ? this : this.clone(!0),
                r(e[g])[b](c),
                h.apply(d, c.get());
            return this.pushStack(d)
        }
    });
    var Ka = /^margin/
      , La = new RegExp("^(" + _ + ")(?!px)[a-z%]+$","i")
      , Ma = function(b) {
        var c = b.ownerDocument.defaultView;
        return c && c.opener || (c = a),
        c.getComputedStyle(b)
    };
    !function() {
        function b() {
            if (i) {
                i.style.cssText = "box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%",
                i.innerHTML = "",
                qa.appendChild(h);
                var b = a.getComputedStyle(i);
                c = "1%" !== b.top,
                g = "2px" === b.marginLeft,
                e = "4px" === b.width,
                i.style.marginRight = "50%",
                f = "4px" === b.marginRight,
                qa.removeChild(h),
                i = null
            }
        }
        var c, e, f, g, h = d.createElement("div"), i = d.createElement("div");
        i.style && (i.style.backgroundClip = "content-box",
        i.cloneNode(!0).style.backgroundClip = "",
        o.clearCloneStyle = "content-box" === i.style.backgroundClip,
        h.style.cssText = "border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute",
        h.appendChild(i),
        r.extend(o, {
            pixelPosition: function() {
                return b(),
                c
            },
            boxSizingReliable: function() {
                return b(),
                e
            },
            pixelMarginRight: function() {
                return b(),
                f
            },
            reliableMarginLeft: function() {
                return b(),
                g
            }
        }))
    }();
    function Na(a, b, c) {
        var d, e, f, g, h = a.style;
        return c = c || Ma(a),
        c && (g = c.getPropertyValue(b) || c[b],
        "" !== g || r.contains(a.ownerDocument, a) || (g = r.style(a, b)),
        !o.pixelMarginRight() && La.test(g) && Ka.test(b) && (d = h.width,
        e = h.minWidth,
        f = h.maxWidth,
        h.minWidth = h.maxWidth = h.width = g,
        g = c.width,
        h.width = d,
        h.minWidth = e,
        h.maxWidth = f)),
        void 0 !== g ? g + "" : g
    }
    function Oa(a, b) {
        return {
            get: function() {
                return a() ? void delete this.get : (this.get = b).apply(this, arguments)
            }
        }
    }
    var Pa = /^(none|table(?!-c[ea]).+)/
      , Qa = {
        position: "absolute",
        visibility: "hidden",
        display: "block"
    }
      , Ra = {
        letterSpacing: "0",
        fontWeight: "400"
    }
      , Sa = ["Webkit", "Moz", "ms"]
      , Ta = d.createElement("div").style;
    function Ua(a) {
        if (a in Ta)
            return a;
        var b = a[0].toUpperCase() + a.slice(1)
          , c = Sa.length;
        while (c--)
            if (a = Sa[c] + b,
            a in Ta)
                return a
    }
    function Va(a, b, c) {
        var d = aa.exec(b);
        return d ? Math.max(0, d[2] - (c || 0)) + (d[3] || "px") : b
    }
    function Wa(a, b, c, d, e) {
        var f, g = 0;
        for (f = c === (d ? "border" : "content") ? 4 : "width" === b ? 1 : 0; f < 4; f += 2)
            "margin" === c && (g += r.css(a, c + ba[f], !0, e)),
            d ? ("content" === c && (g -= r.css(a, "padding" + ba[f], !0, e)),
            "margin" !== c && (g -= r.css(a, "border" + ba[f] + "Width", !0, e))) : (g += r.css(a, "padding" + ba[f], !0, e),
            "padding" !== c && (g += r.css(a, "border" + ba[f] + "Width", !0, e)));
        return g
    }
    function Xa(a, b, c) {
        var d, e = !0, f = Ma(a), g = "border-box" === r.css(a, "boxSizing", !1, f);
        if (a.getClientRects().length && (d = a.getBoundingClientRect()[b]),
        d <= 0 || null == d) {
            if (d = Na(a, b, f),
            (d < 0 || null == d) && (d = a.style[b]),
            La.test(d))
                return d;
            e = g && (o.boxSizingReliable() || d === a.style[b]),
            d = parseFloat(d) || 0
        }
        return d + Wa(a, b, c || (g ? "border" : "content"), e, f) + "px"
    }
    r.extend({
        cssHooks: {
            opacity: {
                get: function(a, b) {
                    if (b) {
                        var c = Na(a, "opacity");
                        return "" === c ? "1" : c
                    }
                }
            }
        },
        cssNumber: {
            animationIterationCount: !0,
            columnCount: !0,
            fillOpacity: !0,
            flexGrow: !0,
            flexShrink: !0,
            fontWeight: !0,
            lineHeight: !0,
            opacity: !0,
            order: !0,
            orphans: !0,
            widows: !0,
            zIndex: !0,
            zoom: !0
        },
        cssProps: {
            "float": "cssFloat"
        },
        style: function(a, b, c, d) {
            if (a && 3 !== a.nodeType && 8 !== a.nodeType && a.style) {
                var e, f, g, h = r.camelCase(b), i = a.style;
                return b = r.cssProps[h] || (r.cssProps[h] = Ua(h) || h),
                g = r.cssHooks[b] || r.cssHooks[h],
                void 0 === c ? g && "get"in g && void 0 !== (e = g.get(a, !1, d)) ? e : i[b] : (f = typeof c,
                "string" === f && (e = aa.exec(c)) && e[1] && (c = ea(a, b, e),
                f = "number"),
                null != c && c === c && ("number" === f && (c += e && e[3] || (r.cssNumber[h] ? "" : "px")),
                o.clearCloneStyle || "" !== c || 0 !== b.indexOf("background") || (i[b] = "inherit"),
                g && "set"in g && void 0 === (c = g.set(a, c, d)) || (i[b] = c)),
                void 0)
            }
        },
        css: function(a, b, c, d) {
            var e, f, g, h = r.camelCase(b);
            return b = r.cssProps[h] || (r.cssProps[h] = Ua(h) || h),
            g = r.cssHooks[b] || r.cssHooks[h],
            g && "get"in g && (e = g.get(a, !0, c)),
            void 0 === e && (e = Na(a, b, d)),
            "normal" === e && b in Ra && (e = Ra[b]),
            "" === c || c ? (f = parseFloat(e),
            c === !0 || isFinite(f) ? f || 0 : e) : e
        }
    }),
    r.each(["height", "width"], function(a, b) {
        r.cssHooks[b] = {
            get: function(a, c, d) {
                if (c)
                    return !Pa.test(r.css(a, "display")) || a.getClientRects().length && a.getBoundingClientRect().width ? Xa(a, b, d) : da(a, Qa, function() {
                        return Xa(a, b, d)
                    })
            },
            set: function(a, c, d) {
                var e, f = d && Ma(a), g = d && Wa(a, b, d, "border-box" === r.css(a, "boxSizing", !1, f), f);
                return g && (e = aa.exec(c)) && "px" !== (e[3] || "px") && (a.style[b] = c,
                c = r.css(a, b)),
                Va(a, c, g)
            }
        }
    }),
    r.cssHooks.marginLeft = Oa(o.reliableMarginLeft, function(a, b) {
        if (b)
            return (parseFloat(Na(a, "marginLeft")) || a.getBoundingClientRect().left - da(a, {
                marginLeft: 0
            }, function() {
                return a.getBoundingClientRect().left
            })) + "px"
    }),
    r.each({
        margin: "",
        padding: "",
        border: "Width"
    }, function(a, b) {
        r.cssHooks[a + b] = {
            expand: function(c) {
                for (var d = 0, e = {}, f = "string" == typeof c ? c.split(" ") : [c]; d < 4; d++)
                    e[a + ba[d] + b] = f[d] || f[d - 2] || f[0];
                return e
            }
        },
        Ka.test(a) || (r.cssHooks[a + b].set = Va)
    }),
    r.fn.extend({
        css: function(a, b) {
            return S(this, function(a, b, c) {
                var d, e, f = {}, g = 0;
                if (r.isArray(b)) {
                    for (d = Ma(a),
                    e = b.length; g < e; g++)
                        f[b[g]] = r.css(a, b[g], !1, d);
                    return f
                }
                return void 0 !== c ? r.style(a, b, c) : r.css(a, b)
            }, a, b, arguments.length > 1)
        }
    });
    function Ya(a, b, c, d, e) {
        return new Ya.prototype.init(a,b,c,d,e)
    }
    r.Tween = Ya,
    Ya.prototype = {
        constructor: Ya,
        init: function(a, b, c, d, e, f) {
            this.elem = a,
            this.prop = c,
            this.easing = e || r.easing._default,
            this.options = b,
            this.start = this.now = this.cur(),
            this.end = d,
            this.unit = f || (r.cssNumber[c] ? "" : "px")
        },
        cur: function() {
            var a = Ya.propHooks[this.prop];
            return a && a.get ? a.get(this) : Ya.propHooks._default.get(this)
        },
        run: function(a) {
            var b, c = Ya.propHooks[this.prop];
            return this.options.duration ? this.pos = b = r.easing[this.easing](a, this.options.duration * a, 0, 1, this.options.duration) : this.pos = b = a,
            this.now = (this.end - this.start) * b + this.start,
            this.options.step && this.options.step.call(this.elem, this.now, this),
            c && c.set ? c.set(this) : Ya.propHooks._default.set(this),
            this
        }
    },
    Ya.prototype.init.prototype = Ya.prototype,
    Ya.propHooks = {
        _default: {
            get: function(a) {
                var b;
                return 1 !== a.elem.nodeType || null != a.elem[a.prop] && null == a.elem.style[a.prop] ? a.elem[a.prop] : (b = r.css(a.elem, a.prop, ""),
                b && "auto" !== b ? b : 0)
            },
            set: function(a) {
                r.fx.step[a.prop] ? r.fx.step[a.prop](a) : 1 !== a.elem.nodeType || null == a.elem.style[r.cssProps[a.prop]] && !r.cssHooks[a.prop] ? a.elem[a.prop] = a.now : r.style(a.elem, a.prop, a.now + a.unit)
            }
        }
    },
    Ya.propHooks.scrollTop = Ya.propHooks.scrollLeft = {
        set: function(a) {
            a.elem.nodeType && a.elem.parentNode && (a.elem[a.prop] = a.now)
        }
    },
    r.easing = {
        linear: function(a) {
            return a
        },
        swing: function(a) {
            return .5 - Math.cos(a * Math.PI) / 2
        },
        _default: "swing"
    },
    r.fx = Ya.prototype.init,
    r.fx.step = {};
    var Za, $a, _a = /^(?:toggle|show|hide)$/, ab = /queueHooks$/;
    function bb() {
        $a && (a.requestAnimationFrame(bb),
        r.fx.tick())
    }
    function cb() {
        return a.setTimeout(function() {
            Za = void 0
        }),
        Za = r.now()
    }
    function db(a, b) {
        var c, d = 0, e = {
            height: a
        };
        for (b = b ? 1 : 0; d < 4; d += 2 - b)
            c = ba[d],
            e["margin" + c] = e["padding" + c] = a;
        return b && (e.opacity = e.width = a),
        e
    }
    function eb(a, b, c) {
        for (var d, e = (hb.tweeners[b] || []).concat(hb.tweeners["*"]), f = 0, g = e.length; f < g; f++)
            if (d = e[f].call(c, b, a))
                return d
    }
    function fb(a, b, c) {
        var d, e, f, g, h, i, j, k, l = "width"in b || "height"in b, m = this, n = {}, o = a.style, p = a.nodeType && ca(a), q = V.get(a, "fxshow");
        c.queue || (g = r._queueHooks(a, "fx"),
        null == g.unqueued && (g.unqueued = 0,
        h = g.empty.fire,
        g.empty.fire = function() {
            g.unqueued || h()
        }
        ),
        g.unqueued++,
        m.always(function() {
            m.always(function() {
                g.unqueued--,
                r.queue(a, "fx").length || g.empty.fire()
            })
        }));
        for (d in b)
            if (e = b[d],
            _a.test(e)) {
                if (delete b[d],
                f = f || "toggle" === e,
                e === (p ? "hide" : "show")) {
                    if ("show" !== e || !q || void 0 === q[d])
                        continue;
                    p = !0
                }
                n[d] = q && q[d] || r.style(a, d)
            }
        if (i = !r.isEmptyObject(b),
        i || !r.isEmptyObject(n)) {
            l && 1 === a.nodeType && (c.overflow = [o.overflow, o.overflowX, o.overflowY],
            j = q && q.display,
            null == j && (j = V.get(a, "display")),
            k = r.css(a, "display"),
            "none" === k && (j ? k = j : (ha([a], !0),
            j = a.style.display || j,
            k = r.css(a, "display"),
            ha([a]))),
            ("inline" === k || "inline-block" === k && null != j) && "none" === r.css(a, "float") && (i || (m.done(function() {
                o.display = j
            }),
            null == j && (k = o.display,
            j = "none" === k ? "" : k)),
            o.display = "inline-block")),
            c.overflow && (o.overflow = "hidden",
            m.always(function() {
                o.overflow = c.overflow[0],
                o.overflowX = c.overflow[1],
                o.overflowY = c.overflow[2]
            })),
            i = !1;
            for (d in n)
                i || (q ? "hidden"in q && (p = q.hidden) : q = V.access(a, "fxshow", {
                    display: j
                }),
                f && (q.hidden = !p),
                p && ha([a], !0),
                m.done(function() {
                    p || ha([a]),
                    V.remove(a, "fxshow");
                    for (d in n)
                        r.style(a, d, n[d])
                })),
                i = eb(p ? q[d] : 0, d, m),
                d in q || (q[d] = i.start,
                p && (i.end = i.start,
                i.start = 0))
        }
    }
    function gb(a, b) {
        var c, d, e, f, g;
        for (c in a)
            if (d = r.camelCase(c),
            e = b[d],
            f = a[c],
            r.isArray(f) && (e = f[1],
            f = a[c] = f[0]),
            c !== d && (a[d] = f,
            delete a[c]),
            g = r.cssHooks[d],
            g && "expand"in g) {
                f = g.expand(f),
                delete a[d];
                for (c in f)
                    c in a || (a[c] = f[c],
                    b[c] = e)
            } else
                b[d] = e
    }
    function hb(a, b, c) {
        var d, e, f = 0, g = hb.prefilters.length, h = r.Deferred().always(function() {
            delete i.elem
        }), i = function() {
            if (e)
                return !1;
            for (var b = Za || cb(), c = Math.max(0, j.startTime + j.duration - b), d = c / j.duration || 0, f = 1 - d, g = 0, i = j.tweens.length; g < i; g++)
                j.tweens[g].run(f);
            return h.notifyWith(a, [j, f, c]),
            f < 1 && i ? c : (h.resolveWith(a, [j]),
            !1)
        }, j = h.promise({
            elem: a,
            props: r.extend({}, b),
            opts: r.extend(!0, {
                specialEasing: {},
                easing: r.easing._default
            }, c),
            originalProperties: b,
            originalOptions: c,
            startTime: Za || cb(),
            duration: c.duration,
            tweens: [],
            createTween: function(b, c) {
                var d = r.Tween(a, j.opts, b, c, j.opts.specialEasing[b] || j.opts.easing);
                return j.tweens.push(d),
                d
            },
            stop: function(b) {
                var c = 0
                  , d = b ? j.tweens.length : 0;
                if (e)
                    return this;
                for (e = !0; c < d; c++)
                    j.tweens[c].run(1);
                return b ? (h.notifyWith(a, [j, 1, 0]),
                h.resolveWith(a, [j, b])) : h.rejectWith(a, [j, b]),
                this
            }
        }), k = j.props;
        for (gb(k, j.opts.specialEasing); f < g; f++)
            if (d = hb.prefilters[f].call(j, a, k, j.opts))
                return r.isFunction(d.stop) && (r._queueHooks(j.elem, j.opts.queue).stop = r.proxy(d.stop, d)),
                d;
        return r.map(k, eb, j),
        r.isFunction(j.opts.start) && j.opts.start.call(a, j),
        r.fx.timer(r.extend(i, {
            elem: a,
            anim: j,
            queue: j.opts.queue
        })),
        j.progress(j.opts.progress).done(j.opts.done, j.opts.complete).fail(j.opts.fail).always(j.opts.always)
    }
    r.Animation = r.extend(hb, {
        tweeners: {
            "*": [function(a, b) {
                var c = this.createTween(a, b);
                return ea(c.elem, a, aa.exec(b), c),
                c
            }
            ]
        },
        tweener: function(a, b) {
            r.isFunction(a) ? (b = a,
            a = ["*"]) : a = a.match(K);
            for (var c, d = 0, e = a.length; d < e; d++)
                c = a[d],
                hb.tweeners[c] = hb.tweeners[c] || [],
                hb.tweeners[c].unshift(b)
        },
        prefilters: [fb],
        prefilter: function(a, b) {
            b ? hb.prefilters.unshift(a) : hb.prefilters.push(a)
        }
    }),
    r.speed = function(a, b, c) {
        var e = a && "object" == typeof a ? r.extend({}, a) : {
            complete: c || !c && b || r.isFunction(a) && a,
            duration: a,
            easing: c && b || b && !r.isFunction(b) && b
        };
        return r.fx.off || d.hidden ? e.duration = 0 : "number" != typeof e.duration && (e.duration in r.fx.speeds ? e.duration = r.fx.speeds[e.duration] : e.duration = r.fx.speeds._default),
        null != e.queue && e.queue !== !0 || (e.queue = "fx"),
        e.old = e.complete,
        e.complete = function() {
            r.isFunction(e.old) && e.old.call(this),
            e.queue && r.dequeue(this, e.queue)
        }
        ,
        e
    }
    ,
    r.fn.extend({
        fadeTo: function(a, b, c, d) {
            return this.filter(ca).css("opacity", 0).show().end().animate({
                opacity: b
            }, a, c, d)
        },
        animate: function(a, b, c, d) {
            var e = r.isEmptyObject(a)
              , f = r.speed(b, c, d)
              , g = function() {
                var b = hb(this, r.extend({}, a), f);
                (e || V.get(this, "finish")) && b.stop(!0)
            };
            return g.finish = g,
            e || f.queue === !1 ? this.each(g) : this.queue(f.queue, g)
        },
        stop: function(a, b, c) {
            var d = function(a) {
                var b = a.stop;
                delete a.stop,
                b(c)
            };
            return "string" != typeof a && (c = b,
            b = a,
            a = void 0),
            b && a !== !1 && this.queue(a || "fx", []),
            this.each(function() {
                var b = !0
                  , e = null != a && a + "queueHooks"
                  , f = r.timers
                  , g = V.get(this);
                if (e)
                    g[e] && g[e].stop && d(g[e]);
                else
                    for (e in g)
                        g[e] && g[e].stop && ab.test(e) && d(g[e]);
                for (e = f.length; e--; )
                    f[e].elem !== this || null != a && f[e].queue !== a || (f[e].anim.stop(c),
                    b = !1,
                    f.splice(e, 1));
                !b && c || r.dequeue(this, a)
            })
        },
        finish: function(a) {
            return a !== !1 && (a = a || "fx"),
            this.each(function() {
                var b, c = V.get(this), d = c[a + "queue"], e = c[a + "queueHooks"], f = r.timers, g = d ? d.length : 0;
                for (c.finish = !0,
                r.queue(this, a, []),
                e && e.stop && e.stop.call(this, !0),
                b = f.length; b--; )
                    f[b].elem === this && f[b].queue === a && (f[b].anim.stop(!0),
                    f.splice(b, 1));
                for (b = 0; b < g; b++)
                    d[b] && d[b].finish && d[b].finish.call(this);
                delete c.finish
            })
        }
    }),
    r.each(["toggle", "show", "hide"], function(a, b) {
        var c = r.fn[b];
        r.fn[b] = function(a, d, e) {
            return null == a || "boolean" == typeof a ? c.apply(this, arguments) : this.animate(db(b, !0), a, d, e)
        }
    }),
    r.each({
        slideDown: db("show"),
        slideUp: db("hide"),
        slideToggle: db("toggle"),
        fadeIn: {
            opacity: "show"
        },
        fadeOut: {
            opacity: "hide"
        },
        fadeToggle: {
            opacity: "toggle"
        }
    }, function(a, b) {
        r.fn[a] = function(a, c, d) {
            return this.animate(b, a, c, d)
        }
    }),
    r.timers = [],
    r.fx.tick = function() {
        var a, b = 0, c = r.timers;
        for (Za = r.now(); b < c.length; b++)
            a = c[b],
            a() || c[b] !== a || c.splice(b--, 1);
        c.length || r.fx.stop(),
        Za = void 0
    }
    ,
    r.fx.timer = function(a) {
        r.timers.push(a),
        a() ? r.fx.start() : r.timers.pop()
    }
    ,
    r.fx.interval = 13,
    r.fx.start = function() {
        $a || ($a = a.requestAnimationFrame ? a.requestAnimationFrame(bb) : a.setInterval(r.fx.tick, r.fx.interval))
    }
    ,
    r.fx.stop = function() {
        a.cancelAnimationFrame ? a.cancelAnimationFrame($a) : a.clearInterval($a),
        $a = null
    }
    ,
    r.fx.speeds = {
        slow: 600,
        fast: 200,
        _default: 400
    },
    r.fn.delay = function(b, c) {
        return b = r.fx ? r.fx.speeds[b] || b : b,
        c = c || "fx",
        this.queue(c, function(c, d) {
            var e = a.setTimeout(c, b);
            d.stop = function() {
                a.clearTimeout(e)
            }
        })
    }
    ,
    function() {
        var a = d.createElement("input")
          , b = d.createElement("select")
          , c = b.appendChild(d.createElement("option"));
        a.type = "checkbox",
        o.checkOn = "" !== a.value,
        o.optSelected = c.selected,
        a = d.createElement("input"),
        a.value = "t",
        a.type = "radio",
        o.radioValue = "t" === a.value
    }();
    var ib, jb = r.expr.attrHandle;
    r.fn.extend({
        attr: function(a, b) {
            return S(this, r.attr, a, b, arguments.length > 1)
        },
        removeAttr: function(a) {
            return this.each(function() {
                r.removeAttr(this, a)
            })
        }
    }),
    r.extend({
        attr: function(a, b, c) {
            var d, e, f = a.nodeType;
            if (3 !== f && 8 !== f && 2 !== f)
                return "undefined" == typeof a.getAttribute ? r.prop(a, b, c) : (1 === f && r.isXMLDoc(a) || (e = r.attrHooks[b.toLowerCase()] || (r.expr.match.bool.test(b) ? ib : void 0)),
                void 0 !== c ? null === c ? void r.removeAttr(a, b) : e && "set"in e && void 0 !== (d = e.set(a, c, b)) ? d : (a.setAttribute(b, c + ""),
                c) : e && "get"in e && null !== (d = e.get(a, b)) ? d : (d = r.find.attr(a, b),
                null == d ? void 0 : d))
        },
        attrHooks: {
            type: {
                set: function(a, b) {
                    if (!o.radioValue && "radio" === b && r.nodeName(a, "input")) {
                        var c = a.value;
                        return a.setAttribute("type", b),
                        c && (a.value = c),
                        b
                    }
                }
            }
        },
        removeAttr: function(a, b) {
            var c, d = 0, e = b && b.match(K);
            if (e && 1 === a.nodeType)
                while (c = e[d++])
                    a.removeAttribute(c)
        }
    }),
    ib = {
        set: function(a, b, c) {
            return b === !1 ? r.removeAttr(a, c) : a.setAttribute(c, c),
            c
        }
    },
    r.each(r.expr.match.bool.source.match(/\w+/g), function(a, b) {
        var c = jb[b] || r.find.attr;
        jb[b] = function(a, b, d) {
            var e, f, g = b.toLowerCase();
            return d || (f = jb[g],
            jb[g] = e,
            e = null != c(a, b, d) ? g : null,
            jb[g] = f),
            e
        }
    });
    var kb = /^(?:input|select|textarea|button)$/i
      , lb = /^(?:a|area)$/i;
    r.fn.extend({
        prop: function(a, b) {
            return S(this, r.prop, a, b, arguments.length > 1)
        },
        removeProp: function(a) {
            return this.each(function() {
                delete this[r.propFix[a] || a]
            })
        }
    }),
    r.extend({
        prop: function(a, b, c) {
            var d, e, f = a.nodeType;
            if (3 !== f && 8 !== f && 2 !== f)
                return 1 === f && r.isXMLDoc(a) || (b = r.propFix[b] || b,
                e = r.propHooks[b]),
                void 0 !== c ? e && "set"in e && void 0 !== (d = e.set(a, c, b)) ? d : a[b] = c : e && "get"in e && null !== (d = e.get(a, b)) ? d : a[b]
        },
        propHooks: {
            tabIndex: {
                get: function(a) {
                    var b = r.find.attr(a, "tabindex");
                    return b ? parseInt(b, 10) : kb.test(a.nodeName) || lb.test(a.nodeName) && a.href ? 0 : -1
                }
            }
        },
        propFix: {
            "for": "htmlFor",
            "class": "className"
        }
    }),
    o.optSelected || (r.propHooks.selected = {
        get: function(a) {
            var b = a.parentNode;
            return b && b.parentNode && b.parentNode.selectedIndex,
            null
        },
        set: function(a) {
            var b = a.parentNode;
            b && (b.selectedIndex,
            b.parentNode && b.parentNode.selectedIndex)
        }
    }),
    r.each(["tabIndex", "readOnly", "maxLength", "cellSpacing", "cellPadding", "rowSpan", "colSpan", "useMap", "frameBorder", "contentEditable"], function() {
        r.propFix[this.toLowerCase()] = this
    });
    function mb(a) {
        var b = a.match(K) || [];
        return b.join(" ")
    }
    function nb(a) {
        return a.getAttribute && a.getAttribute("class") || ""
    }
    r.fn.extend({
        addClass: function(a) {
            var b, c, d, e, f, g, h, i = 0;
            if (r.isFunction(a))
                return this.each(function(b) {
                    r(this).addClass(a.call(this, b, nb(this)))
                });
            if ("string" == typeof a && a) {
                b = a.match(K) || [];
                while (c = this[i++])
                    if (e = nb(c),
                    d = 1 === c.nodeType && " " + mb(e) + " ") {
                        g = 0;
                        while (f = b[g++])
                            d.indexOf(" " + f + " ") < 0 && (d += f + " ");
                        h = mb(d),
                        e !== h && c.setAttribute("class", h)
                    }
            }
            return this
        },
        removeClass: function(a) {
            var b, c, d, e, f, g, h, i = 0;
            if (r.isFunction(a))
                return this.each(function(b) {
                    r(this).removeClass(a.call(this, b, nb(this)))
                });
            if (!arguments.length)
                return this.attr("class", "");
            if ("string" == typeof a && a) {
                b = a.match(K) || [];
                while (c = this[i++])
                    if (e = nb(c),
                    d = 1 === c.nodeType && " " + mb(e) + " ") {
                        g = 0;
                        while (f = b[g++])
                            while (d.indexOf(" " + f + " ") > -1)
                                d = d.replace(" " + f + " ", " ");
                        h = mb(d),
                        e !== h && c.setAttribute("class", h)
                    }
            }
            return this
        },
        toggleClass: function(a, b) {
            var c = typeof a;
            return "boolean" == typeof b && "string" === c ? b ? this.addClass(a) : this.removeClass(a) : r.isFunction(a) ? this.each(function(c) {
                r(this).toggleClass(a.call(this, c, nb(this), b), b)
            }) : this.each(function() {
                var b, d, e, f;
                if ("string" === c) {
                    d = 0,
                    e = r(this),
                    f = a.match(K) || [];
                    while (b = f[d++])
                        e.hasClass(b) ? e.removeClass(b) : e.addClass(b)
                } else
                    void 0 !== a && "boolean" !== c || (b = nb(this),
                    b && V.set(this, "__className__", b),
                    this.setAttribute && this.setAttribute("class", b || a === !1 ? "" : V.get(this, "__className__") || ""))
            })
        },
        hasClass: function(a) {
            var b, c, d = 0;
            b = " " + a + " ";
            while (c = this[d++])
                if (1 === c.nodeType && (" " + mb(nb(c)) + " ").indexOf(b) > -1)
                    return !0;
            return !1
        }
    });
    var ob = /\r/g;
    r.fn.extend({
        val: function(a) {
            var b, c, d, e = this[0];
            {
                if (arguments.length)
                    return d = r.isFunction(a),
                    this.each(function(c) {
                        var e;
                        1 === this.nodeType && (e = d ? a.call(this, c, r(this).val()) : a,
                        null == e ? e = "" : "number" == typeof e ? e += "" : r.isArray(e) && (e = r.map(e, function(a) {
                            return null == a ? "" : a + ""
                        })),
                        b = r.valHooks[this.type] || r.valHooks[this.nodeName.toLowerCase()],
                        b && "set"in b && void 0 !== b.set(this, e, "value") || (this.value = e))
                    });
                if (e)
                    return b = r.valHooks[e.type] || r.valHooks[e.nodeName.toLowerCase()],
                    b && "get"in b && void 0 !== (c = b.get(e, "value")) ? c : (c = e.value,
                    "string" == typeof c ? c.replace(ob, "") : null == c ? "" : c)
            }
        }
    }),
    r.extend({
        valHooks: {
            option: {
                get: function(a) {
                    var b = r.find.attr(a, "value");
                    return null != b ? b : mb(r.text(a))
                }
            },
            select: {
                get: function(a) {
                    var b, c, d, e = a.options, f = a.selectedIndex, g = "select-one" === a.type, h = g ? null : [], i = g ? f + 1 : e.length;
                    for (d = f < 0 ? i : g ? f : 0; d < i; d++)
                        if (c = e[d],
                        (c.selected || d === f) && !c.disabled && (!c.parentNode.disabled || !r.nodeName(c.parentNode, "optgroup"))) {
                            if (b = r(c).val(),
                            g)
                                return b;
                            h.push(b)
                        }
                    return h
                },
                set: function(a, b) {
                    var c, d, e = a.options, f = r.makeArray(b), g = e.length;
                    while (g--)
                        d = e[g],
                        (d.selected = r.inArray(r.valHooks.option.get(d), f) > -1) && (c = !0);
                    return c || (a.selectedIndex = -1),
                    f
                }
            }
        }
    }),
    r.each(["radio", "checkbox"], function() {
        r.valHooks[this] = {
            set: function(a, b) {
                if (r.isArray(b))
                    return a.checked = r.inArray(r(a).val(), b) > -1
            }
        },
        o.checkOn || (r.valHooks[this].get = function(a) {
            return null === a.getAttribute("value") ? "on" : a.value
        }
        )
    });
    var pb = /^(?:focusinfocus|focusoutblur)$/;
    r.extend(r.event, {
        trigger: function(b, c, e, f) {
            var g, h, i, j, k, m, n, o = [e || d], p = l.call(b, "type") ? b.type : b, q = l.call(b, "namespace") ? b.namespace.split(".") : [];
            if (h = i = e = e || d,
            3 !== e.nodeType && 8 !== e.nodeType && !pb.test(p + r.event.triggered) && (p.indexOf(".") > -1 && (q = p.split("."),
            p = q.shift(),
            q.sort()),
            k = p.indexOf(":") < 0 && "on" + p,
            b = b[r.expando] ? b : new r.Event(p,"object" == typeof b && b),
            b.isTrigger = f ? 2 : 3,
            b.namespace = q.join("."),
            b.rnamespace = b.namespace ? new RegExp("(^|\\.)" + q.join("\\.(?:.*\\.|)") + "(\\.|$)") : null,
            b.result = void 0,
            b.target || (b.target = e),
            c = null == c ? [b] : r.makeArray(c, [b]),
            n = r.event.special[p] || {},
            f || !n.trigger || n.trigger.apply(e, c) !== !1)) {
                if (!f && !n.noBubble && !r.isWindow(e)) {
                    for (j = n.delegateType || p,
                    pb.test(j + p) || (h = h.parentNode); h; h = h.parentNode)
                        o.push(h),
                        i = h;
                    i === (e.ownerDocument || d) && o.push(i.defaultView || i.parentWindow || a)
                }
                g = 0;
                while ((h = o[g++]) && !b.isPropagationStopped())
                    b.type = g > 1 ? j : n.bindType || p,
                    m = (V.get(h, "events") || {})[b.type] && V.get(h, "handle"),
                    m && m.apply(h, c),
                    m = k && h[k],
                    m && m.apply && T(h) && (b.result = m.apply(h, c),
                    b.result === !1 && b.preventDefault());
                return b.type = p,
                f || b.isDefaultPrevented() || n._default && n._default.apply(o.pop(), c) !== !1 || !T(e) || k && r.isFunction(e[p]) && !r.isWindow(e) && (i = e[k],
                i && (e[k] = null),
                r.event.triggered = p,
                e[p](),
                r.event.triggered = void 0,
                i && (e[k] = i)),
                b.result
            }
        },
        simulate: function(a, b, c) {
            var d = r.extend(new r.Event, c, {
                type: a,
                isSimulated: !0
            });
            r.event.trigger(d, null, b)
        }
    }),
    r.fn.extend({
        trigger: function(a, b) {
            return this.each(function() {
                r.event.trigger(a, b, this)
            })
        },
        triggerHandler: function(a, b) {
            var c = this[0];
            if (c)
                return r.event.trigger(a, b, c, !0)
        }
    }),
    r.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "), function(a, b) {
        r.fn[b] = function(a, c) {
            return arguments.length > 0 ? this.on(b, null, a, c) : this.trigger(b)
        }
    }),
    r.fn.extend({
        hover: function(a, b) {
            return this.mouseenter(a).mouseleave(b || a)
        }
    }),
    o.focusin = "onfocusin"in a,
    o.focusin || r.each({
        focus: "focusin",
        blur: "focusout"
    }, function(a, b) {
        var c = function(a) {
            r.event.simulate(b, a.target, r.event.fix(a))
        };
        r.event.special[b] = {
            setup: function() {
                var d = this.ownerDocument || this
                  , e = V.access(d, b);
                e || d.addEventListener(a, c, !0),
                V.access(d, b, (e || 0) + 1)
            },
            teardown: function() {
                var d = this.ownerDocument || this
                  , e = V.access(d, b) - 1;
                e ? V.access(d, b, e) : (d.removeEventListener(a, c, !0),
                V.remove(d, b))
            }
        }
    });
    var qb = a.location
      , rb = r.now()
      , sb = /\?/;
    r.parseXML = function(b) {
        var c;
        if (!b || "string" != typeof b)
            return null;
        try {
            c = (new a.DOMParser).parseFromString(b, "text/xml")
        } catch (d) {
            c = void 0
        }
        return c && !c.getElementsByTagName("parsererror").length || r.error("Invalid XML: " + b),
        c
    }
    ;
    var tb = /\[\]$/
      , ub = /\r?\n/g
      , vb = /^(?:submit|button|image|reset|file)$/i
      , wb = /^(?:input|select|textarea|keygen)/i;
    function xb(a, b, c, d) {
        var e;
        if (r.isArray(b))
            r.each(b, function(b, e) {
                c || tb.test(a) ? d(a, e) : xb(a + "[" + ("object" == typeof e && null != e ? b : "") + "]", e, c, d)
            });
        else if (c || "object" !== r.type(b))
            d(a, b);
        else
            for (e in b)
                xb(a + "[" + e + "]", b[e], c, d)
    }
    r.param = function(a, b) {
        var c, d = [], e = function(a, b) {
            var c = r.isFunction(b) ? b() : b;
            d[d.length] = encodeURIComponent(a) + "=" + encodeURIComponent(null == c ? "" : c)
        };
        if (r.isArray(a) || a.jquery && !r.isPlainObject(a))
            r.each(a, function() {
                e(this.name, this.value)
            });
        else
            for (c in a)
                xb(c, a[c], b, e);
        return d.join("&")
    }
    ,
    r.fn.extend({
        serialize: function() {
            return r.param(this.serializeArray())
        },
        serializeArray: function() {
            return this.map(function() {
                var a = r.prop(this, "elements");
                return a ? r.makeArray(a) : this
            }).filter(function() {
                var a = this.type;
                return this.name && !r(this).is(":disabled") && wb.test(this.nodeName) && !vb.test(a) && (this.checked || !ia.test(a))
            }).map(function(a, b) {
                var c = r(this).val();
                return null == c ? null : r.isArray(c) ? r.map(c, function(a) {
                    return {
                        name: b.name,
                        value: a.replace(ub, "\r\n")
                    }
                }) : {
                    name: b.name,
                    value: c.replace(ub, "\r\n")
                }
            }).get()
        }
    });
    var yb = /%20/g
      , zb = /#.*$/
      , Ab = /([?&])_=[^&]*/
      , Bb = /^(.*?):[ \t]*([^\r\n]*)$/gm
      , Cb = /^(?:about|app|app-storage|.+-extension|file|res|widget):$/
      , Db = /^(?:GET|HEAD)$/
      , Eb = /^\/\//
      , Fb = {}
      , Gb = {}
      , Hb = "*/".concat("*")
      , Ib = d.createElement("a");
    Ib.href = qb.href;
    function Jb(a) {
        return function(b, c) {
            "string" != typeof b && (c = b,
            b = "*");
            var d, e = 0, f = b.toLowerCase().match(K) || [];
            if (r.isFunction(c))
                while (d = f[e++])
                    "+" === d[0] ? (d = d.slice(1) || "*",
                    (a[d] = a[d] || []).unshift(c)) : (a[d] = a[d] || []).push(c)
        }
    }
    function Kb(a, b, c, d) {
        var e = {}
          , f = a === Gb;
        function g(h) {
            var i;
            return e[h] = !0,
            r.each(a[h] || [], function(a, h) {
                var j = h(b, c, d);
                return "string" != typeof j || f || e[j] ? f ? !(i = j) : void 0 : (b.dataTypes.unshift(j),
                g(j),
                !1)
            }),
            i
        }
        return g(b.dataTypes[0]) || !e["*"] && g("*")
    }
    function Lb(a, b) {
        var c, d, e = r.ajaxSettings.flatOptions || {};
        for (c in b)
            void 0 !== b[c] && ((e[c] ? a : d || (d = {}))[c] = b[c]);
        return d && r.extend(!0, a, d),
        a
    }
    function Mb(a, b, c) {
        var d, e, f, g, h = a.contents, i = a.dataTypes;
        while ("*" === i[0])
            i.shift(),
            void 0 === d && (d = a.mimeType || b.getResponseHeader("Content-Type"));
        if (d)
            for (e in h)
                if (h[e] && h[e].test(d)) {
                    i.unshift(e);
                    break
                }
        if (i[0]in c)
            f = i[0];
        else {
            for (e in c) {
                if (!i[0] || a.converters[e + " " + i[0]]) {
                    f = e;
                    break
                }
                g || (g = e)
            }
            f = f || g
        }
        if (f)
            return f !== i[0] && i.unshift(f),
            c[f]
    }
    function Nb(a, b, c, d) {
        var e, f, g, h, i, j = {}, k = a.dataTypes.slice();
        if (k[1])
            for (g in a.converters)
                j[g.toLowerCase()] = a.converters[g];
        f = k.shift();
        while (f)
            if (a.responseFields[f] && (c[a.responseFields[f]] = b),
            !i && d && a.dataFilter && (b = a.dataFilter(b, a.dataType)),
            i = f,
            f = k.shift())
                if ("*" === f)
                    f = i;
                else if ("*" !== i && i !== f) {
                    if (g = j[i + " " + f] || j["* " + f],
                    !g)
                        for (e in j)
                            if (h = e.split(" "),
                            h[1] === f && (g = j[i + " " + h[0]] || j["* " + h[0]])) {
                                g === !0 ? g = j[e] : j[e] !== !0 && (f = h[0],
                                k.unshift(h[1]));
                                break
                            }
                    if (g !== !0)
                        if (g && a["throws"])
                            b = g(b);
                        else
                            try {
                                b = g(b)
                            } catch (l) {
                                return {
                                    state: "parsererror",
                                    error: g ? l : "No conversion from " + i + " to " + f
                                }
                            }
                }
        return {
            state: "success",
            data: b
        }
    }
    r.extend({
        active: 0,
        lastModified: {},
        etag: {},
        ajaxSettings: {
            url: qb.href,
            type: "GET",
            isLocal: Cb.test(qb.protocol),
            global: !0,
            processData: !0,
            async: !0,
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            accepts: {
                "*": Hb,
                text: "text/plain",
                html: "text/html",
                xml: "application/xml, text/xml",
                json: "application/json, text/javascript"
            },
            contents: {
                xml: /\bxml\b/,
                html: /\bhtml/,
                json: /\bjson\b/
            },
            responseFields: {
                xml: "responseXML",
                text: "responseText",
                json: "responseJSON"
            },
            converters: {
                "* text": String,
                "text html": !0,
                "text json": JSON.parse,
                "text xml": r.parseXML
            },
            flatOptions: {
                url: !0,
                context: !0
            }
        },
        ajaxSetup: function(a, b) {
            return b ? Lb(Lb(a, r.ajaxSettings), b) : Lb(r.ajaxSettings, a)
        },
        ajaxPrefilter: Jb(Fb),
        ajaxTransport: Jb(Gb),
        ajax: function(b, c) {
            "object" == typeof b && (c = b,
            b = void 0),
            c = c || {};
            var e, f, g, h, i, j, k, l, m, n, o = r.ajaxSetup({}, c), p = o.context || o, q = o.context && (p.nodeType || p.jquery) ? r(p) : r.event, s = r.Deferred(), t = r.Callbacks("once memory"), u = o.statusCode || {}, v = {}, w = {}, x = "canceled", y = {
                readyState: 0,
                getResponseHeader: function(a) {
                    var b;
                    if (k) {
                        if (!h) {
                            h = {};
                            while (b = Bb.exec(g))
                                h[b[1].toLowerCase()] = b[2]
                        }
                        b = h[a.toLowerCase()]
                    }
                    return null == b ? null : b
                },
                getAllResponseHeaders: function() {
                    return k ? g : null
                },
                setRequestHeader: function(a, b) {
                    return null == k && (a = w[a.toLowerCase()] = w[a.toLowerCase()] || a,
                    v[a] = b),
                    this
                },
                overrideMimeType: function(a) {
                    return null == k && (o.mimeType = a),
                    this
                },
                statusCode: function(a) {
                    var b;
                    if (a)
                        if (k)
                            y.always(a[y.status]);
                        else
                            for (b in a)
                                u[b] = [u[b], a[b]];
                    return this
                },
                abort: function(a) {
                    var b = a || x;
                    return e && e.abort(b),
                    A(0, b),
                    this
                }
            };
            if (s.promise(y),
            o.url = ((b || o.url || qb.href) + "").replace(Eb, qb.protocol + "//"),
            o.type = c.method || c.type || o.method || o.type,
            o.dataTypes = (o.dataType || "*").toLowerCase().match(K) || [""],
            null == o.crossDomain) {
                j = d.createElement("a");
                try {
                    j.href = o.url,
                    j.href = j.href,
                    o.crossDomain = Ib.protocol + "//" + Ib.host != j.protocol + "//" + j.host
                } catch (z) {
                    o.crossDomain = !0
                }
            }
            if (o.data && o.processData && "string" != typeof o.data && (o.data = r.param(o.data, o.traditional)),
            Kb(Fb, o, c, y),
            k)
                return y;
            l = r.event && o.global,
            l && 0 === r.active++ && r.event.trigger("ajaxStart"),
            o.type = o.type.toUpperCase(),
            o.hasContent = !Db.test(o.type),
            f = o.url.replace(zb, ""),
            o.hasContent ? o.data && o.processData && 0 === (o.contentType || "").indexOf("application/x-www-form-urlencoded") && (o.data = o.data.replace(yb, "+")) : (n = o.url.slice(f.length),
            o.data && (f += (sb.test(f) ? "&" : "?") + o.data,
            delete o.data),
            o.cache === !1 && (f = f.replace(Ab, "$1"),
            n = (sb.test(f) ? "&" : "?") + "_=" + rb++ + n),
            o.url = f + n),
            o.ifModified && (r.lastModified[f] && y.setRequestHeader("If-Modified-Since", r.lastModified[f]),
            r.etag[f] && y.setRequestHeader("If-None-Match", r.etag[f])),
            (o.data && o.hasContent && o.contentType !== !1 || c.contentType) && y.setRequestHeader("Content-Type", o.contentType),
            y.setRequestHeader("Accept", o.dataTypes[0] && o.accepts[o.dataTypes[0]] ? o.accepts[o.dataTypes[0]] + ("*" !== o.dataTypes[0] ? ", " + Hb + "; q=0.01" : "") : o.accepts["*"]);
            for (m in o.headers)
                y.setRequestHeader(m, o.headers[m]);
            if (o.beforeSend && (o.beforeSend.call(p, y, o) === !1 || k))
                return y.abort();
            if (x = "abort",
            t.add(o.complete),
            y.done(o.success),
            y.fail(o.error),
            e = Kb(Gb, o, c, y)) {
                if (y.readyState = 1,
                l && q.trigger("ajaxSend", [y, o]),
                k)
                    return y;
                o.async && o.timeout > 0 && (i = a.setTimeout(function() {
                    y.abort("timeout")
                }, o.timeout));
                try {
                    k = !1,
                    e.send(v, A)
                } catch (z) {
                    if (k)
                        throw z;
                    A(-1, z)
                }
            } else
                A(-1, "No Transport");
            function A(b, c, d, h) {
                var j, m, n, v, w, x = c;
                k || (k = !0,
                i && a.clearTimeout(i),
                e = void 0,
                g = h || "",
                y.readyState = b > 0 ? 4 : 0,
                j = b >= 200 && b < 300 || 304 === b,
                d && (v = Mb(o, y, d)),
                v = Nb(o, v, y, j),
                j ? (o.ifModified && (w = y.getResponseHeader("Last-Modified"),
                w && (r.lastModified[f] = w),
                w = y.getResponseHeader("etag"),
                w && (r.etag[f] = w)),
                204 === b || "HEAD" === o.type ? x = "nocontent" : 304 === b ? x = "notmodified" : (x = v.state,
                m = v.data,
                n = v.error,
                j = !n)) : (n = x,
                !b && x || (x = "error",
                b < 0 && (b = 0))),
                y.status = b,
                y.statusText = (c || x) + "",
                j ? s.resolveWith(p, [m, x, y]) : s.rejectWith(p, [y, x, n]),
                y.statusCode(u),
                u = void 0,
                l && q.trigger(j ? "ajaxSuccess" : "ajaxError", [y, o, j ? m : n]),
                t.fireWith(p, [y, x]),
                l && (q.trigger("ajaxComplete", [y, o]),
                --r.active || r.event.trigger("ajaxStop")))
            }
            return y
        },
        getJSON: function(a, b, c) {
            return r.get(a, b, c, "json")
        },
        getScript: function(a, b) {
            return r.get(a, void 0, b, "script")
        }
    }),
    r.each(["get", "post"], function(a, b) {
        r[b] = function(a, c, d, e) {
            return r.isFunction(c) && (e = e || d,
            d = c,
            c = void 0),
            r.ajax(r.extend({
                url: a,
                type: b,
                dataType: e,
                data: c,
                success: d
            }, r.isPlainObject(a) && a))
        }
    }),
    r._evalUrl = function(a) {
        return r.ajax({
            url: a,
            type: "GET",
            dataType: "script",
            cache: !0,
            async: !1,
            global: !1,
            "throws": !0
        })
    }
    ,
    r.fn.extend({
        wrapAll: function(a) {
            var b;
            return this[0] && (r.isFunction(a) && (a = a.call(this[0])),
            b = r(a, this[0].ownerDocument).eq(0).clone(!0),
            this[0].parentNode && b.insertBefore(this[0]),
            b.map(function() {
                var a = this;
                while (a.firstElementChild)
                    a = a.firstElementChild;
                return a
            }).append(this)),
            this
        },
        wrapInner: function(a) {
            return r.isFunction(a) ? this.each(function(b) {
                r(this).wrapInner(a.call(this, b))
            }) : this.each(function() {
                var b = r(this)
                  , c = b.contents();
                c.length ? c.wrapAll(a) : b.append(a)
            })
        },
        wrap: function(a) {
            var b = r.isFunction(a);
            return this.each(function(c) {
                r(this).wrapAll(b ? a.call(this, c) : a)
            })
        },
        unwrap: function(a) {
            return this.parent(a).not("body").each(function() {
                r(this).replaceWith(this.childNodes)
            }),
            this
        }
    }),
    r.expr.pseudos.hidden = function(a) {
        return !r.expr.pseudos.visible(a)
    }
    ,
    r.expr.pseudos.visible = function(a) {
        return !!(a.offsetWidth || a.offsetHeight || a.getClientRects().length)
    }
    ,
    r.ajaxSettings.xhr = function() {
        try {
            return new a.XMLHttpRequest
        } catch (b) {}
    }
    ;
    var Ob = {
        0: 200,
        1223: 204
    }
      , Pb = r.ajaxSettings.xhr();
    o.cors = !!Pb && "withCredentials"in Pb,
    o.ajax = Pb = !!Pb,
    r.ajaxTransport(function(b) {
        var c, d;
        if (o.cors || Pb && !b.crossDomain)
            return {
                send: function(e, f) {
                    var g, h = b.xhr();
                    if (h.open(b.type, b.url, b.async, b.username, b.password),
                    b.xhrFields)
                        for (g in b.xhrFields)
                            h[g] = b.xhrFields[g];
                    b.mimeType && h.overrideMimeType && h.overrideMimeType(b.mimeType),
                    b.crossDomain || e["X-Requested-With"] || (e["X-Requested-With"] = "XMLHttpRequest");
                    for (g in e)
                        h.setRequestHeader(g, e[g]);
                    c = function(a) {
                        return function() {
                            c && (c = d = h.onload = h.onerror = h.onabort = h.onreadystatechange = null,
                            "abort" === a ? h.abort() : "error" === a ? "number" != typeof h.status ? f(0, "error") : f(h.status, h.statusText) : f(Ob[h.status] || h.status, h.statusText, "text" !== (h.responseType || "text") || "string" != typeof h.responseText ? {
                                binary: h.response
                            } : {
                                text: h.responseText
                            }, h.getAllResponseHeaders()))
                        }
                    }
                    ,
                    h.onload = c(),
                    d = h.onerror = c("error"),
                    void 0 !== h.onabort ? h.onabort = d : h.onreadystatechange = function() {
                        4 === h.readyState && a.setTimeout(function() {
                            c && d()
                        })
                    }
                    ,
                    c = c("abort");
                    try {
                        h.send(b.hasContent && b.data || null)
                    } catch (i) {
                        if (c)
                            throw i
                    }
                },
                abort: function() {
                    c && c()
                }
            }
    }),
    r.ajaxPrefilter(function(a) {
        a.crossDomain && (a.contents.script = !1)
    }),
    r.ajaxSetup({
        accepts: {
            script: "text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"
        },
        contents: {
            script: /\b(?:java|ecma)script\b/
        },
        converters: {
            "text script": function(a) {
                return r.globalEval(a),
                a
            }
        }
    }),
    r.ajaxPrefilter("script", function(a) {
        void 0 === a.cache && (a.cache = !1),
        a.crossDomain && (a.type = "GET")
    }),
    r.ajaxTransport("script", function(a) {
        if (a.crossDomain) {
            var b, c;
            return {
                send: function(e, f) {
                    b = r("<script>").prop({
                        charset: a.scriptCharset,
                        src: a.url
                    }).on("load error", c = function(a) {
                        b.remove(),
                        c = null,
                        a && f("error" === a.type ? 404 : 200, a.type)
                    }
                    ),
                    d.head.appendChild(b[0])
                },
                abort: function() {
                    c && c()
                }
            }
        }
    });
    var Qb = []
      , Rb = /(=)\?(?=&|$)|\?\?/;
    r.ajaxSetup({
        jsonp: "callback",
        jsonpCallback: function() {
            var a = Qb.pop() || r.expando + "_" + rb++;
            return this[a] = !0,
            a
        }
    }),
    r.ajaxPrefilter("json jsonp", function(b, c, d) {
        var e, f, g, h = b.jsonp !== !1 && (Rb.test(b.url) ? "url" : "string" == typeof b.data && 0 === (b.contentType || "").indexOf("application/x-www-form-urlencoded") && Rb.test(b.data) && "data");
        if (h || "jsonp" === b.dataTypes[0])
            return e = b.jsonpCallback = r.isFunction(b.jsonpCallback) ? b.jsonpCallback() : b.jsonpCallback,
            h ? b[h] = b[h].replace(Rb, "$1" + e) : b.jsonp !== !1 && (b.url += (sb.test(b.url) ? "&" : "?") + b.jsonp + "=" + e),
            b.converters["script json"] = function() {
                return g || r.error(e + " was not called"),
                g[0]
            }
            ,
            b.dataTypes[0] = "json",
            f = a[e],
            a[e] = function() {
                g = arguments
            }
            ,
            d.always(function() {
                void 0 === f ? r(a).removeProp(e) : a[e] = f,
                b[e] && (b.jsonpCallback = c.jsonpCallback,
                Qb.push(e)),
                g && r.isFunction(f) && f(g[0]),
                g = f = void 0
            }),
            "script"
    }),
    o.createHTMLDocument = function() {
        var a = d.implementation.createHTMLDocument("").body;
        return a.innerHTML = "<form></form><form></form>",
        2 === a.childNodes.length
    }(),
    r.parseHTML = function(a, b, c) {
        if ("string" != typeof a)
            return [];
        "boolean" == typeof b && (c = b,
        b = !1);
        var e, f, g;
        return b || (o.createHTMLDocument ? (b = d.implementation.createHTMLDocument(""),
        e = b.createElement("base"),
        e.href = d.location.href,
        b.head.appendChild(e)) : b = d),
        f = B.exec(a),
        g = !c && [],
        f ? [b.createElement(f[1])] : (f = pa([a], b, g),
        g && g.length && r(g).remove(),
        r.merge([], f.childNodes))
    }
    ,
    r.fn.load = function(a, b, c) {
        var d, e, f, g = this, h = a.indexOf(" ");
        return h > -1 && (d = mb(a.slice(h)),
        a = a.slice(0, h)),
        r.isFunction(b) ? (c = b,
        b = void 0) : b && "object" == typeof b && (e = "POST"),
        g.length > 0 && r.ajax({
            url: a,
            type: e || "GET",
            dataType: "html",
            data: b
        }).done(function(a) {
            f = arguments,
            g.html(d ? r("<div>").append(r.parseHTML(a)).find(d) : a)
        }).always(c && function(a, b) {
            g.each(function() {
                c.apply(this, f || [a.responseText, b, a])
            })
        }
        ),
        this
    }
    ,
    r.each(["ajaxStart", "ajaxStop", "ajaxComplete", "ajaxError", "ajaxSuccess", "ajaxSend"], function(a, b) {
        r.fn[b] = function(a) {
            return this.on(b, a)
        }
    }),
    r.expr.pseudos.animated = function(a) {
        return r.grep(r.timers, function(b) {
            return a === b.elem
        }).length
    }
    ;
    function Sb(a) {
        return r.isWindow(a) ? a : 9 === a.nodeType && a.defaultView
    }
    r.offset = {
        setOffset: function(a, b, c) {
            var d, e, f, g, h, i, j, k = r.css(a, "position"), l = r(a), m = {};
            "static" === k && (a.style.position = "relative"),
            h = l.offset(),
            f = r.css(a, "top"),
            i = r.css(a, "left"),
            j = ("absolute" === k || "fixed" === k) && (f + i).indexOf("auto") > -1,
            j ? (d = l.position(),
            g = d.top,
            e = d.left) : (g = parseFloat(f) || 0,
            e = parseFloat(i) || 0),
            r.isFunction(b) && (b = b.call(a, c, r.extend({}, h))),
            null != b.top && (m.top = b.top - h.top + g),
            null != b.left && (m.left = b.left - h.left + e),
            "using"in b ? b.using.call(a, m) : l.css(m)
        }
    },
    r.fn.extend({
        offset: function(a) {
            if (arguments.length)
                return void 0 === a ? this : this.each(function(b) {
                    r.offset.setOffset(this, a, b)
                });
            var b, c, d, e, f = this[0];
            if (f)
                return f.getClientRects().length ? (d = f.getBoundingClientRect(),
                d.width || d.height ? (e = f.ownerDocument,
                c = Sb(e),
                b = e.documentElement,
                {
                    top: d.top + c.pageYOffset - b.clientTop,
                    left: d.left + c.pageXOffset - b.clientLeft
                }) : d) : {
                    top: 0,
                    left: 0
                }
        },
        position: function() {
            if (this[0]) {
                var a, b, c = this[0], d = {
                    top: 0,
                    left: 0
                };
                return "fixed" === r.css(c, "position") ? b = c.getBoundingClientRect() : (a = this.offsetParent(),
                b = this.offset(),
                r.nodeName(a[0], "html") || (d = a.offset()),
                d = {
                    top: d.top + r.css(a[0], "borderTopWidth", !0),
                    left: d.left + r.css(a[0], "borderLeftWidth", !0)
                }),
                {
                    top: b.top - d.top - r.css(c, "marginTop", !0),
                    left: b.left - d.left - r.css(c, "marginLeft", !0)
                }
            }
        },
        offsetParent: function() {
            return this.map(function() {
                var a = this.offsetParent;
                while (a && "static" === r.css(a, "position"))
                    a = a.offsetParent;
                return a || qa
            })
        }
    }),
    r.each({
        scrollLeft: "pageXOffset",
        scrollTop: "pageYOffset"
    }, function(a, b) {
        var c = "pageYOffset" === b;
        r.fn[a] = function(d) {
            return S(this, function(a, d, e) {
                var f = Sb(a);
                return void 0 === e ? f ? f[b] : a[d] : void (f ? f.scrollTo(c ? f.pageXOffset : e, c ? e : f.pageYOffset) : a[d] = e)
            }, a, d, arguments.length)
        }
    }),
    r.each(["top", "left"], function(a, b) {
        r.cssHooks[b] = Oa(o.pixelPosition, function(a, c) {
            if (c)
                return c = Na(a, b),
                La.test(c) ? r(a).position()[b] + "px" : c
        })
    }),
    r.each({
        Height: "height",
        Width: "width"
    }, function(a, b) {
        r.each({
            padding: "inner" + a,
            content: b,
            "": "outer" + a
        }, function(c, d) {
            r.fn[d] = function(e, f) {
                var g = arguments.length && (c || "boolean" != typeof e)
                  , h = c || (e === !0 || f === !0 ? "margin" : "border");
                return S(this, function(b, c, e) {
                    var f;
                    return r.isWindow(b) ? 0 === d.indexOf("outer") ? b["inner" + a] : b.document.documentElement["client" + a] : 9 === b.nodeType ? (f = b.documentElement,
                    Math.max(b.body["scroll" + a], f["scroll" + a], b.body["offset" + a], f["offset" + a], f["client" + a])) : void 0 === e ? r.css(b, c, h) : r.style(b, c, e, h)
                }, b, g ? e : void 0, g)
            }
        })
    }),
    r.fn.extend({
        bind: function(a, b, c) {
            return this.on(a, null, b, c)
        },
        unbind: function(a, b) {
            return this.off(a, null, b)
        },
        delegate: function(a, b, c, d) {
            return this.on(b, a, c, d)
        },
        undelegate: function(a, b, c) {
            return 1 === arguments.length ? this.off(a, "**") : this.off(b, a || "**", c)
        }
    }),
    r.parseJSON = JSON.parse,
    "function" == typeof define && define.amd && define("jquery", [], function() {
        return r
    });
    var Tb = a.jQuery
      , Ub = a.$;
    return r.noConflict = function(b) {
        return a.$ === r && (a.$ = Ub),
        b && a.jQuery === r && (a.jQuery = Tb),
        r
    }
    ,
    b || (a.jQuery = a.$ = r),
    r
});

/* file: script/lib/jquery.tooltips.js */

(function() {

    var lib = {

        init: function() {

            this.$tooltip = $("<div>").appendTo("body");
            this.$tooltip.addClass("tooltip");

        },

        onmouseenter: function() {

            lib.$tooltip.html($(this).data('tooltip'));
            lib.showTooltip(this);

        },

        onmouseleave: function() {

            lib.$tooltip.hide();

        },

        showTooltip(anchor) {

            let $anchor = $(anchor);

            this.$tooltip.show();

            let o = 16;

            let anchorTop = $anchor.offset().top;
            let tooltipHeight = this.$tooltip.outerHeight();
            let anchorLeft = $anchor.offset().left;
            let anchorWidth = $anchor.outerWidth();
            let tooltipWidth = this.$tooltip.outerWidth();

            let x = $anchor.offset().left + $anchor.outerWidth() / 2 - this.$tooltip.outerWidth() / 2;

            if (x < 0)
                x = 0;
            if (x + tooltipWidth > window.innerWidth)
                x = window.innerWidth - tooltipWidth;

            this.$tooltip.css("left", x);

            if (anchorTop - tooltipHeight - o > 0) {

                this.$tooltip.css("top", anchorTop - tooltipHeight - o);

            } else {

                this.$tooltip.css("top", anchorTop + $anchor.outerHeight() + o);

            }

        }

    };

    $.tooltip = {};

    $.tooltip.hide = function() {

        lib.$tooltip.hide();

    }
    ;

    $.fn.tooltip = function(text) {

        if ($(this).data("tooltip") === undefined) {

            $(this).on("mouseenter", lib.onmouseenter);
            $(this).on("mouseleave", lib.onmouseleave);
            $(this).on("mousedown", lib.onmouseleave);

        }

        $(this).data('tooltip', text)
    }
    ;

    lib.init();

}
)();

/* file: script/lib/jquery.videotip.js */

(function() {

    function onMouseEnter() {

        var $this = $(this);
        var data = $this.data("videotip");

        var $container = $("<div>");

        $container.addClass("videotip");

        var $video = $("<video>");

        $video.attr("src", data.src);

        $video.appendTo($container);

        $container.appendTo(document.body);
        $container.css({
            left: -10000,
            top: -10000
        });

        data.timer = setInterval(function() {

            $video.css("maxHeight", $this.offset().top | 0);

            $container.css({
                left: $this.offset().left + $this.outerWidth() / 2 - $video.outerWidth() / 2 | 0,
                top: $this.offset().top - $video.outerHeight() - 24 | 0,
            });

        }, 50);

        data.$container = $container;

        $video.get(0).play();
        $video.get(0).loop = true;

        $this.data("videotip", data);

    }

    function onMouseLeave() {

        var $this = $(this);

        var data = $this.data("videotip");

        data.$container.remove();

        clearInterval(data.timer);

    }

    $.fn.videotip = function(src) {

        this.data("videotip", {
            src: src
        });

        this.on("mouseenter", onMouseEnter);
        this.on("mouseleave", onMouseLeave);

    }

}
)();

/* file: script/lib/lodash.js */

/**
 * @license
 * lodash lodash.com/license | Underscore.js 1.8.3 underscorejs.org/LICENSE
 */
;(function() {
    function t(t, n) {
        return t.set(n[0], n[1]),
        t
    }
    function n(t, n) {
        return t.add(n),
        t
    }
    function r(t, n, r) {
        switch (r.length) {
        case 0:
            return t.call(n);
        case 1:
            return t.call(n, r[0]);
        case 2:
            return t.call(n, r[0], r[1]);
        case 3:
            return t.call(n, r[0], r[1], r[2])
        }
        return t.apply(n, r)
    }
    function e(t, n, r, e) {
        for (var u = -1, o = t.length; ++u < o; ) {
            var i = t[u];
            n(e, i, r(i), t)
        }
        return e
    }
    function u(t, n) {
        for (var r = -1, e = t.length; ++r < e && false !== n(t[r], r, t); )
            ;
        return t
    }
    function o(t, n) {
        for (var r = t.length; r-- && false !== n(t[r], r, t); )
            ;
        return t
    }
    function i(t, n) {
        for (var r = -1, e = t.length; ++r < e; )
            if (!n(t[r], r, t))
                return false;
        return true
    }
    function f(t, n) {
        for (var r = -1, e = t.length, u = 0, o = []; ++r < e; ) {
            var i = t[r];
            n(i, r, t) && (o[u++] = i)
        }
        return o
    }
    function c(t, n) {
        return !!t.length && -1 < d(t, n, 0)
    }
    function a(t, n, r) {
        for (var e = -1, u = t.length; ++e < u; )
            if (r(n, t[e]))
                return true;
        return false
    }
    function l(t, n) {
        for (var r = -1, e = t.length, u = Array(e); ++r < e; )
            u[r] = n(t[r], r, t);
        return u
    }
    function s(t, n) {
        for (var r = -1, e = n.length, u = t.length; ++r < e; )
            t[u + r] = n[r];
        return t
    }
    function h(t, n, r, e) {
        var u = -1
          , o = t.length;
        for (e && o && (r = t[++u]); ++u < o; )
            r = n(r, t[u], u, t);
        return r
    }
    function p(t, n, r, e) {
        var u = t.length;
        for (e && u && (r = t[--u]); u--; )
            r = n(r, t[u], u, t);
        return r
    }
    function _(t, n) {
        for (var r = -1, e = t.length; ++r < e; )
            if (n(t[r], r, t))
                return true;
        return false
    }
    function v(t, n, r, e) {
        var u;
        return r(t, function(t, r, o) {
            return n(t, r, o) ? (u = e ? r : t,
            false) : void 0
        }),
        u
    }
    function g(t, n, r) {
        for (var e = t.length, u = r ? e : -1; r ? u-- : ++u < e; )
            if (n(t[u], u, t))
                return u;
        return -1
    }
    function d(t, n, r) {
        if (n !== n)
            return M(t, r);
        --r;
        for (var e = t.length; ++r < e; )
            if (t[r] === n)
                return r;
        return -1
    }
    function y(t, n, r, e) {
        --r;
        for (var u = t.length; ++r < u; )
            if (e(t[r], n))
                return r;
        return -1
    }
    function b(t, n) {
        var r = t ? t.length : 0;
        return r ? w(t, n) / r : V
    }
    function x(t, n, r, e, u) {
        return u(t, function(t, u, o) {
            r = e ? (e = false,
            t) : n(r, t, u, o)
        }),
        r
    }
    function j(t, n) {
        var r = t.length;
        for (t.sort(n); r--; )
            t[r] = t[r].c;
        return t
    }
    function w(t, n) {
        for (var r, e = -1, u = t.length; ++e < u; ) {
            var o = n(t[e]);
            o !== T && (r = r === T ? o : r + o)
        }
        return r
    }
    function m(t, n) {
        for (var r = -1, e = Array(t); ++r < t; )
            e[r] = n(r);
        return e
    }
    function A(t, n) {
        return l(n, function(n) {
            return [n, t[n]]
        })
    }
    function O(t) {
        return function(n) {
            return t(n)
        }
    }
    function k(t, n) {
        return l(n, function(n) {
            return t[n]
        })
    }
    function E(t, n) {
        return t.has(n)
    }
    function I(t, n) {
        for (var r = -1, e = t.length; ++r < e && -1 < d(n, t[r], 0); )
            ;
        return r
    }
    function S(t, n) {
        for (var r = t.length; r-- && -1 < d(n, t[r], 0); )
            ;
        return r
    }
    function R(t) {
        return t && t.Object === Object ? t : null
    }
    function W(t) {
        return zt[t]
    }
    function B(t) {
        return Ut[t]
    }
    function L(t) {
        return "\\" + $t[t]
    }
    function M(t, n, r) {
        var e = t.length;
        for (n += r ? 0 : -1; r ? n-- : ++n < e; ) {
            var u = t[n];
            if (u !== u)
                return n
        }
        return -1
    }
    function C(t) {
        var n = false;
        if (null != t && typeof t.toString != "function")
            try {
                n = !!(t + "")
            } catch (r) {}
        return n
    }
    function z(t) {
        for (var n, r = []; !(n = t.next()).done; )
            r.push(n.value);
        return r
    }
    function U(t) {
        var n = -1
          , r = Array(t.size);
        return t.forEach(function(t, e) {
            r[++n] = [e, t]
        }),
        r
    }
    function D(t, n) {
        for (var r = -1, e = t.length, u = 0, o = []; ++r < e; ) {
            var i = t[r];
            i !== n && "__lodash_placeholder__" !== i || (t[r] = "__lodash_placeholder__",
            o[u++] = r)
        }
        return o
    }
    function F(t) {
        var n = -1
          , r = Array(t.size);
        return t.forEach(function(t) {
            r[++n] = t
        }),
        r
    }
    function $(t) {
        var n = -1
          , r = Array(t.size);
        return t.forEach(function(t) {
            r[++n] = [t, t]
        }),
        r
    }
    function N(t) {
        if (!t || !Wt.test(t))
            return t.length;
        for (var n = St.lastIndex = 0; St.test(t); )
            n++;
        return n
    }
    function P(t) {
        return Dt[t]
    }
    function Z(R) {
        function At(t) {
            if (De(t) && !ai(t) && !(t instanceof zt)) {
                if (t instanceof kt)
                    return t;
                if (wu.call(t, "__wrapped__"))
                    return ie(t)
            }
            return new kt(t)
        }
        function Ot() {}
        function kt(t, n) {
            this.__wrapped__ = t,
            this.__actions__ = [],
            this.__chain__ = !!n,
            this.__index__ = 0,
            this.__values__ = T
        }
        function zt(t) {
            this.__wrapped__ = t,
            this.__actions__ = [],
            this.__dir__ = 1,
            this.__filtered__ = false,
            this.__iteratees__ = [],
            this.__takeCount__ = 4294967295,
            this.__views__ = []
        }
        function Ut(t) {
            var n = -1
              , r = t ? t.length : 0;
            for (this.clear(); ++n < r; ) {
                var e = t[n];
                this.set(e[0], e[1])
            }
        }
        function Dt(t) {
            var n = -1
              , r = t ? t.length : 0;
            for (this.clear(); ++n < r; ) {
                var e = t[n];
                this.set(e[0], e[1])
            }
        }
        function Ft(t) {
            var n = -1
              , r = t ? t.length : 0;
            for (this.clear(); ++n < r; ) {
                var e = t[n];
                this.set(e[0], e[1])
            }
        }
        function $t(t) {
            var n = -1
              , r = t ? t.length : 0;
            for (this.__data__ = new Ft; ++n < r; )
                this.add(t[n])
        }
        function Zt(t) {
            this.__data__ = new Dt(t)
        }
        function Tt(t, n, r, e) {
            return t === T || Se(t, bu[r]) && !wu.call(e, r) ? n : t;
        }
        function Vt(t, n, r) {
            (r === T || Se(t[n], r)) && (typeof n != "number" || r !== T || n in t) || (t[n] = r)
        }
        function Kt(t, n, r) {
            var e = t[n];
            wu.call(t, n) && Se(e, r) && (r !== T || n in t) || (t[n] = r)
        }
        function Gt(t, n) {
            for (var r = t.length; r--; )
                if (Se(t[r][0], n))
                    return r;
            return -1
        }
        function Ht(t, n, r, e) {
            return go(t, function(t, u, o) {
                n(e, t, r(t), o)
            }),
            e
        }
        function Qt(t, n) {
            return t && ar(n, nu(n), t)
        }
        function Xt(t, n) {
            for (var r = -1, e = null == t, u = n.length, o = Array(u); ++r < u; )
                o[r] = e ? T : Xe(t, n[r]);
            return o
        }
        function tn(t, n, r) {
            return t === t && (r !== T && (t = r >= t ? t : r),
            n !== T && (t = t >= n ? t : n)),
            t
        }
        function nn(t, n, r, e, o, i, f) {
            var c;
            if (e && (c = i ? e(t, o, i, f) : e(t)),
            c !== T)
                return c;
            if (!Ue(t))
                return t;
            if (o = ai(t)) {
                if (c = Tr(t),
                !n)
                    return cr(t, c)
            } else {
                var a = Pr(t)
                  , l = "[object Function]" == a || "[object GeneratorFunction]" == a;
                if (li(t))
                    return er(t, n);
                if ("[object Object]" == a || "[object Arguments]" == a || l && !i) {
                    if (C(t))
                        return i ? t : {};
                    if (c = qr(l ? {} : t),
                    !n)
                        return lr(t, Qt(c, t))
                } else {
                    if (!Ct[a])
                        return i ? t : {};
                    c = Vr(t, a, nn, n)
                }
            }
            if (f || (f = new Zt),
            i = f.get(t))
                return i;
            if (f.set(t, c),
            !o)
                var s = r ? vn(t, nu, Nr) : nu(t);
            return u(s || t, function(u, o) {
                s && (o = u,
                u = t[o]),
                Kt(c, o, nn(u, n, r, e, o, t, f))
            }),
            c
        }
        function rn(t) {
            var n = nu(t)
              , r = n.length;
            return function(e) {
                if (null == e)
                    return !r;
                for (var u = r; u--; ) {
                    var o = n[u]
                      , i = t[o]
                      , f = e[o];
                    if (f === T && !(o in Object(e)) || !i(f))
                        return false
                }
                return true
            }
        }
        function en(t) {
            return Ue(t) ? zu(t) : {}
        }
        function un(t, n, r) {
            if (typeof t != "function")
                throw new du("Expected a function");
            return Du(function() {
                t.apply(T, r)
            }, n)
        }
        function on(t, n, r, e) {
            var u = -1
              , o = c
              , i = true
              , f = t.length
              , s = []
              , h = n.length;
            if (!f)
                return s;
            r && (n = l(n, O(r))),
            e ? (o = a,
            i = false) : n.length >= 200 && (o = E,
            i = false,
            n = new $t(n));
            t: for (; ++u < f; ) {
                var p = t[u]
                  , _ = r ? r(p) : p
                  , p = e || 0 !== p ? p : 0;
                if (i && _ === _) {
                    for (var v = h; v--; )
                        if (n[v] === _)
                            continue t;
                    s.push(p)
                } else
                    o(n, _, e) || s.push(p)
            }
            return s
        }
        function fn(t, n) {
            var r = true;
            return go(t, function(t, e, u) {
                return r = !!n(t, e, u)
            }),
            r
        }
        function cn(t, n, r) {
            for (var e = -1, u = t.length; ++e < u; ) {
                var o = t[e]
                  , i = n(o);
                if (null != i && (f === T ? i === i && !Te(i) : r(i, f)))
                    var f = i
                      , c = o
            }
            return c
        }
        function an(t, n) {
            var r = [];
            return go(t, function(t, e, u) {
                n(t, e, u) && r.push(t)
            }),
            r
        }
        function ln(t, n, r, e, u) {
            var o = -1
              , i = t.length;
            for (r || (r = Gr),
            u || (u = []); ++o < i; ) {
                var f = t[o];
                n > 0 && r(f) ? n > 1 ? ln(f, n - 1, r, e, u) : s(u, f) : e || (u[u.length] = f)
            }
            return u
        }
        function sn(t, n) {
            return t && bo(t, n, nu)
        }
        function hn(t, n) {
            return t && xo(t, n, nu)
        }
        function pn(t, n) {
            return f(n, function(n) {
                return Me(t[n])
            })
        }
        function _n(t, n) {
            n = Qr(n, t) ? [n] : nr(n);
            for (var r = 0, e = n.length; null != t && e > r; )
                t = t[ue(n[r++])];
            return r && r == e ? t : T
        }
        function vn(t, n, r) {
            return n = n(t),
            ai(t) ? n : s(n, r(t))
        }
        function gn(t, n) {
            return t > n
        }
        function dn(t, n) {
            return wu.call(t, n) || typeof t == "object" && n in t && null === Pu(Object(t));
        }
        function yn(t, n) {
            return n in Object(t)
        }
        function bn(t, n, r) {
            for (var e = r ? a : c, u = t[0].length, o = t.length, i = o, f = Array(o), s = 1 / 0, h = []; i--; ) {
                var p = t[i];
                i && n && (p = l(p, O(n))),
                s = Ku(p.length, s),
                f[i] = !r && (n || u >= 120 && p.length >= 120) ? new $t(i && p) : T
            }
            var p = t[0]
              , _ = -1
              , v = f[0];
            t: for (; ++_ < u && s > h.length; ) {
                var g = p[_]
                  , d = n ? n(g) : g
                  , g = r || 0 !== g ? g : 0;
                if (v ? !E(v, d) : !e(h, d, r)) {
                    for (i = o; --i; ) {
                        var y = f[i];
                        if (y ? !E(y, d) : !e(t[i], d, r))
                            continue t
                    }
                    v && v.push(d),
                    h.push(g)
                }
            }
            return h
        }
        function xn(t, n, r) {
            var e = {};
            return sn(t, function(t, u, o) {
                n(e, r(t), u, o);
            }),
            e
        }
        function jn(t, n, e) {
            return Qr(n, t) || (n = nr(n),
            t = ee(t, n),
            n = le(n)),
            n = null == t ? t : t[ue(n)],
            null == n ? T : r(n, t, e)
        }
        function wn(t, n, r, e, u) {
            if (t === n)
                n = true;
            else if (null == t || null == n || !Ue(t) && !De(n))
                n = t !== t && n !== n;
            else
                t: {
                    var o = ai(t)
                      , i = ai(n)
                      , f = "[object Array]"
                      , c = "[object Array]";
                    o || (f = Pr(t),
                    f = "[object Arguments]" == f ? "[object Object]" : f),
                    i || (c = Pr(n),
                    c = "[object Arguments]" == c ? "[object Object]" : c);
                    var a = "[object Object]" == f && !C(t)
                      , i = "[object Object]" == c && !C(n);
                    if ((c = f == c) && !a)
                        u || (u = new Zt),
                        n = o || qe(t) ? Lr(t, n, wn, r, e, u) : Mr(t, n, f, wn, r, e, u);
                    else {
                        if (!(2 & e) && (o = a && wu.call(t, "__wrapped__"),
                        f = i && wu.call(n, "__wrapped__"),
                        o || f)) {
                            t = o ? t.value() : t,
                            n = f ? n.value() : n,
                            u || (u = new Zt),
                            n = wn(t, n, r, e, u);
                            break t
                        }
                        if (c)
                            n: if (u || (u = new Zt),
                            o = 2 & e,
                            f = nu(t),
                            i = f.length,
                            c = nu(n).length,
                            i == c || o) {
                                for (a = i; a--; ) {
                                    var l = f[a];
                                    if (!(o ? l in n : dn(n, l))) {
                                        n = false;
                                        break n
                                    }
                                }
                                if (c = u.get(t))
                                    n = c == n;
                                else {
                                    c = true,
                                    u.set(t, n);
                                    for (var s = o; ++a < i; ) {
                                        var l = f[a]
                                          , h = t[l]
                                          , p = n[l];
                                        if (r)
                                            var _ = o ? r(p, h, l, n, t, u) : r(h, p, l, t, n, u);
                                        if (_ === T ? h !== p && !wn(h, p, r, e, u) : !_) {
                                            c = false;
                                            break
                                        }
                                        s || (s = "constructor" == l)
                                    }
                                    c && !s && (r = t.constructor,
                                    e = n.constructor,
                                    r != e && "constructor"in t && "constructor"in n && !(typeof r == "function" && r instanceof r && typeof e == "function" && e instanceof e) && (c = false)),
                                    u["delete"](t),
                                    n = c
                                }
                            } else
                                n = false;
                        else
                            n = false
                    }
                }
            return n
        }
        function mn(t, n, r, e) {
            var u = r.length
              , o = u
              , i = !e;
            if (null == t)
                return !o;
            for (t = Object(t); u--; ) {
                var f = r[u];
                if (i && f[2] ? f[1] !== t[f[0]] : !(f[0]in t))
                    return false
            }
            for (; ++u < o; ) {
                var f = r[u]
                  , c = f[0]
                  , a = t[c]
                  , l = f[1];
                if (i && f[2]) {
                    if (a === T && !(c in t))
                        return false
                } else {
                    if (f = new Zt,
                    e)
                        var s = e(a, l, c, t, n, f);
                    if (s === T ? !wn(l, a, e, 3, f) : !s)
                        return false;
                }
            }
            return true
        }
        function An(t) {
            return typeof t == "function" ? t : null == t ? cu : typeof t == "object" ? ai(t) ? Sn(t[0], t[1]) : In(t) : hu(t)
        }
        function On(t) {
            t = null == t ? t : Object(t);
            var n, r = [];
            for (n in t)
                r.push(n);
            return r
        }
        function kn(t, n) {
            return n > t
        }
        function En(t, n) {
            var r = -1
              , e = We(t) ? Array(t.length) : [];
            return go(t, function(t, u, o) {
                e[++r] = n(t, u, o)
            }),
            e
        }
        function In(t) {
            var n = Fr(t);
            return 1 == n.length && n[0][2] ? ne(n[0][0], n[0][1]) : function(r) {
                return r === t || mn(r, t, n)
            }
        }
        function Sn(t, n) {
            return Qr(t) && n === n && !Ue(n) ? ne(ue(t), n) : function(r) {
                var e = Xe(r, t);
                return e === T && e === n ? tu(r, t) : wn(n, e, T, 3)
            }
        }
        function Rn(t, n, r, e, o) {
            if (t !== n) {
                if (!ai(n) && !qe(n))
                    var i = ru(n);
                u(i || n, function(u, f) {
                    if (i && (f = u,
                    u = n[f]),
                    Ue(u)) {
                        o || (o = new Zt);
                        var c = f
                          , a = o
                          , l = t[c]
                          , s = n[c]
                          , h = a.get(s);
                        if (h)
                            Vt(t, c, h);
                        else {
                            var h = e ? e(l, s, c + "", t, n, a) : T
                              , p = h === T;
                            p && (h = s,
                            ai(s) || qe(s) ? ai(l) ? h = l : Be(l) ? h = cr(l) : (p = false,
                            h = nn(s, true)) : Ne(s) || Re(s) ? Re(l) ? h = He(l) : !Ue(l) || r && Me(l) ? (p = false,
                            h = nn(s, true)) : h = l : p = false),
                            a.set(s, h),
                            p && Rn(h, s, r, e, a),
                            a["delete"](s),
                            Vt(t, c, h)
                        }
                    } else
                        c = e ? e(t[f], u, f + "", t, n, o) : T,
                        c === T && (c = u),
                        Vt(t, f, c)
                })
            }
        }
        function Wn(t, n) {
            var r = t.length;
            return r ? (n += 0 > n ? r : 0,
            Yr(n, r) ? t[n] : T) : void 0
        }
        function Bn(t, n, r) {
            var e = -1;
            return n = l(n.length ? n : [cu], O(Ur())),
            t = En(t, function(t) {
                return {
                    a: l(n, function(n) {
                        return n(t)
                    }),
                    b: ++e,
                    c: t
                }
            }),
            j(t, function(t, n) {
                var e;
                t: {
                    e = -1;
                    for (var u = t.a, o = n.a, i = u.length, f = r.length; ++e < i; ) {
                        var c = or(u[e], o[e]);
                        if (c) {
                            e = e >= f ? c : c * ("desc" == r[e] ? -1 : 1);
                            break t
                        }
                    }
                    e = t.b - n.b
                }
                return e
            })
        }
        function Ln(t, n) {
            return t = Object(t),
            h(n, function(n, r) {
                return r in t && (n[r] = t[r]),
                n
            }, {})
        }
        function Mn(t, n) {
            for (var r = -1, e = vn(t, ru, Oo), u = e.length, o = {}; ++r < u; ) {
                var i = e[r]
                  , f = t[i];
                n(f, i) && (o[i] = f)
            }
            return o
        }
        function Cn(t) {
            return function(n) {
                return null == n ? T : n[t]
            }
        }
        function zn(t) {
            return function(n) {
                return _n(n, t)
            }
        }
        function Un(t, n, r, e) {
            var u = e ? y : d
              , o = -1
              , i = n.length
              , f = t;
            for (r && (f = l(t, O(r))); ++o < i; )
                for (var c = 0, a = n[o], a = r ? r(a) : a; -1 < (c = u(f, a, c, e)); )
                    f !== t && Fu.call(f, c, 1),
                    Fu.call(t, c, 1);
            return t
        }
        function Dn(t, n) {
            for (var r = t ? n.length : 0, e = r - 1; r--; ) {
                var u = n[r];
                if (r == e || u !== o) {
                    var o = u;
                    if (Yr(u))
                        Fu.call(t, u, 1);
                    else if (Qr(u, t))
                        delete t[ue(u)];
                    else {
                        var u = nr(u)
                          , i = ee(t, u);
                        null != i && delete i[ue(le(u))];
                    }
                }
            }
        }
        function Fn(t, n) {
            return t + Nu(Ju() * (n - t + 1))
        }
        function $n(t, n) {
            var r = "";
            if (!t || 1 > n || n > 9007199254740991)
                return r;
            do
                n % 2 && (r += t),
                (n = Nu(n / 2)) && (t += t);
            while (n);
            return r
        }
        function Nn(t, n, r, e) {
            n = Qr(n, t) ? [n] : nr(n);
            for (var u = -1, o = n.length, i = o - 1, f = t; null != f && ++u < o; ) {
                var c = ue(n[u]);
                if (Ue(f)) {
                    var a = r;
                    if (u != i) {
                        var l = f[c]
                          , a = e ? e(l, c, f) : T;
                        a === T && (a = null == l ? Yr(n[u + 1]) ? [] : {} : l)
                    }
                    Kt(f, c, a)
                }
                f = f[c]
            }
            return t
        }
        function Pn(t, n, r) {
            var e = -1
              , u = t.length;
            for (0 > n && (n = -n > u ? 0 : u + n),
            r = r > u ? u : r,
            0 > r && (r += u),
            u = n > r ? 0 : r - n >>> 0,
            n >>>= 0,
            r = Array(u); ++e < u; )
                r[e] = t[e + n];
            return r
        }
        function Zn(t, n) {
            var r;
            return go(t, function(t, e, u) {
                return r = n(t, e, u),
                !r
            }),
            !!r
        }
        function Tn(t, n, r) {
            var e = 0
              , u = t ? t.length : e;
            if (typeof n == "number" && n === n && 2147483647 >= u) {
                for (; u > e; ) {
                    var o = e + u >>> 1
                      , i = t[o];
                    null !== i && !Te(i) && (r ? n >= i : n > i) ? e = o + 1 : u = o
                }
                return u
            }
            return qn(t, n, cu, r)
        }
        function qn(t, n, r, e) {
            n = r(n);
            for (var u = 0, o = t ? t.length : 0, i = n !== n, f = null === n, c = Te(n), a = n === T; o > u; ) {
                var l = Nu((u + o) / 2)
                  , s = r(t[l])
                  , h = s !== T
                  , p = null === s
                  , _ = s === s
                  , v = Te(s);
                (i ? e || _ : a ? _ && (e || h) : f ? _ && h && (e || !p) : c ? _ && h && !p && (e || !v) : p || v ? 0 : e ? n >= s : n > s) ? u = l + 1 : o = l;
            }
            return Ku(o, 4294967294)
        }
        function Vn(t, n) {
            for (var r = -1, e = t.length, u = 0, o = []; ++r < e; ) {
                var i = t[r]
                  , f = n ? n(i) : i;
                if (!r || !Se(f, c)) {
                    var c = f;
                    o[u++] = 0 === i ? 0 : i
                }
            }
            return o
        }
        function Kn(t) {
            return typeof t == "number" ? t : Te(t) ? V : +t
        }
        function Gn(t) {
            if (typeof t == "string")
                return t;
            if (Te(t))
                return vo ? vo.call(t) : "";
            var n = t + "";
            return "0" == n && 1 / t == -q ? "-0" : n
        }
        function Jn(t, n, r) {
            var e = -1
              , u = c
              , o = t.length
              , i = true
              , f = []
              , l = f;
            if (r)
                i = false,
                u = a;
            else if (o >= 200) {
                if (u = n ? null : wo(t))
                    return F(u);
                i = false,
                u = E,
                l = new $t
            } else
                l = n ? [] : f;
            t: for (; ++e < o; ) {
                var s = t[e]
                  , h = n ? n(s) : s
                  , s = r || 0 !== s ? s : 0;
                if (i && h === h) {
                    for (var p = l.length; p--; )
                        if (l[p] === h)
                            continue t;
                    n && l.push(h),
                    f.push(s)
                } else
                    u(l, h, r) || (l !== f && l.push(h),
                    f.push(s))
            }
            return f
        }
        function Yn(t, n, r, e) {
            for (var u = t.length, o = e ? u : -1; (e ? o-- : ++o < u) && n(t[o], o, t); )
                ;
            return r ? Pn(t, e ? 0 : o, e ? o + 1 : u) : Pn(t, e ? o + 1 : 0, e ? u : o)
        }
        function Hn(t, n) {
            var r = t;
            return r instanceof zt && (r = r.value()),
            h(n, function(t, n) {
                return n.func.apply(n.thisArg, s([t], n.args))
            }, r)
        }
        function Qn(t, n, r) {
            for (var e = -1, u = t.length; ++e < u; )
                var o = o ? s(on(o, t[e], n, r), on(t[e], o, n, r)) : t[e];
            return o && o.length ? Jn(o, n, r) : [];
        }
        function Xn(t, n, r) {
            for (var e = -1, u = t.length, o = n.length, i = {}; ++e < u; )
                r(i, t[e], o > e ? n[e] : T);
            return i
        }
        function tr(t) {
            return Be(t) ? t : []
        }
        function nr(t) {
            return ai(t) ? t : Eo(t)
        }
        function rr(t, n, r) {
            var e = t.length;
            return r = r === T ? e : r,
            !n && r >= e ? t : Pn(t, n, r)
        }
        function er(t, n) {
            if (n)
                return t.slice();
            var r = new t.constructor(t.length);
            return t.copy(r),
            r
        }
        function ur(t) {
            var n = new t.constructor(t.byteLength);
            return new Wu(n).set(new Wu(t)),
            n
        }
        function or(t, n) {
            if (t !== n) {
                var r = t !== T
                  , e = null === t
                  , u = t === t
                  , o = Te(t)
                  , i = n !== T
                  , f = null === n
                  , c = n === n
                  , a = Te(n);
                if (!f && !a && !o && t > n || o && i && c && !f && !a || e && i && c || !r && c || !u)
                    return 1;
                if (!e && !o && !a && n > t || a && r && u && !e && !o || f && r && u || !i && u || !c)
                    return -1
            }
            return 0
        }
        function ir(t, n, r, e) {
            var u = -1
              , o = t.length
              , i = r.length
              , f = -1
              , c = n.length
              , a = Vu(o - i, 0)
              , l = Array(c + a);
            for (e = !e; ++f < c; )
                l[f] = n[f];
            for (; ++u < i; )
                (e || o > u) && (l[r[u]] = t[u]);
            for (; a--; )
                l[f++] = t[u++];
            return l
        }
        function fr(t, n, r, e) {
            var u = -1
              , o = t.length
              , i = -1
              , f = r.length
              , c = -1
              , a = n.length
              , l = Vu(o - f, 0)
              , s = Array(l + a);
            for (e = !e; ++u < l; )
                s[u] = t[u];
            for (l = u; ++c < a; )
                s[l + c] = n[c];
            for (; ++i < f; )
                (e || o > u) && (s[l + r[i]] = t[u++]);
            return s
        }
        function cr(t, n) {
            var r = -1
              , e = t.length;
            for (n || (n = Array(e)); ++r < e; )
                n[r] = t[r];
            return n
        }
        function ar(t, n, r, e) {
            r || (r = {});
            for (var u = -1, o = n.length; ++u < o; ) {
                var i = n[u]
                  , f = e ? e(r[i], t[i], i, r, t) : t[i];
                Kt(r, i, f)
            }
            return r
        }
        function lr(t, n) {
            return ar(t, Nr(t), n)
        }
        function sr(t, n) {
            return function(r, u) {
                var o = ai(r) ? e : Ht
                  , i = n ? n() : {};
                return o(r, t, Ur(u), i)
            }
        }
        function hr(t) {
            return Ie(function(n, r) {
                var e = -1
                  , u = r.length
                  , o = u > 1 ? r[u - 1] : T
                  , i = u > 2 ? r[2] : T
                  , o = t.length > 3 && typeof o == "function" ? (u--,
                o) : T;
                for (i && Hr(r[0], r[1], i) && (o = 3 > u ? T : o,
                u = 1),
                n = Object(n); ++e < u; )
                    (i = r[e]) && t(n, i, e, o);
                return n
            })
        }
        function pr(t, n) {
            return function(r, e) {
                if (null == r)
                    return r;
                if (!We(r))
                    return t(r, e);
                for (var u = r.length, o = n ? u : -1, i = Object(r); (n ? o-- : ++o < u) && false !== e(i[o], o, i); )
                    ;
                return r
            }
        }
        function _r(t) {
            return function(n, r, e) {
                var u = -1
                  , o = Object(n);
                e = e(n);
                for (var i = e.length; i--; ) {
                    var f = e[t ? i : ++u];
                    if (false === r(o[f], f, o))
                        break
                }
                return n
            }
        }
        function vr(t, n, r) {
            function e() {
                return (this && this !== Jt && this instanceof e ? o : t).apply(u ? r : this, arguments)
            }
            var u = 1 & n
              , o = yr(t);
            return e
        }
        function gr(t) {
            return function(n) {
                n = Qe(n);
                var r = Wt.test(n) ? n.match(St) : T
                  , e = r ? r[0] : n.charAt(0);
                return n = r ? rr(r, 1).join("") : n.slice(1),
                e[t]() + n
            }
        }
        function dr(t) {
            return function(n) {
                return h(iu(ou(n).replace(Et, "")), t, "")
            }
        }
        function yr(t) {
            return function() {
                var n = arguments;
                switch (n.length) {
                case 0:
                    return new t;
                case 1:
                    return new t(n[0]);
                case 2:
                    return new t(n[0],n[1]);
                case 3:
                    return new t(n[0],n[1],n[2]);
                case 4:
                    return new t(n[0],n[1],n[2],n[3]);
                case 5:
                    return new t(n[0],n[1],n[2],n[3],n[4]);
                case 6:
                    return new t(n[0],n[1],n[2],n[3],n[4],n[5]);
                case 7:
                    return new t(n[0],n[1],n[2],n[3],n[4],n[5],n[6])
                }
                var r = en(t.prototype)
                  , n = t.apply(r, n);
                return Ue(n) ? n : r
            }
        }
        function br(t, n, e) {
            function u() {
                for (var i = arguments.length, f = Array(i), c = i, a = zr(u); c--; )
                    f[c] = arguments[c];
                return c = 3 > i && f[0] !== a && f[i - 1] !== a ? [] : D(f, a),
                i -= c.length,
                e > i ? Sr(t, n, jr, u.placeholder, T, f, c, T, T, e - i) : r(this && this !== Jt && this instanceof u ? o : t, this, f)
            }
            var o = yr(t);
            return u
        }
        function xr(t) {
            return Ie(function(n) {
                n = ln(n, 1);
                var r = n.length
                  , e = r
                  , u = kt.prototype.thru;
                for (t && n.reverse(); e--; ) {
                    var o = n[e];
                    if (typeof o != "function")
                        throw new du("Expected a function");
                    if (u && !i && "wrapper" == Cr(o))
                        var i = new kt([],true)
                }
                for (e = i ? e : r; ++e < r; )
                    var o = n[e]
                      , u = Cr(o)
                      , f = "wrapper" == u ? mo(o) : T
                      , i = f && Xr(f[0]) && 424 == f[1] && !f[4].length && 1 == f[9] ? i[Cr(f[0])].apply(i, f[3]) : 1 == o.length && Xr(o) ? i[u]() : i.thru(o);
                return function() {
                    var t = arguments
                      , e = t[0];
                    if (i && 1 == t.length && ai(e) && e.length >= 200)
                        return i.plant(e).value();
                    for (var u = 0, t = r ? n[u].apply(this, t) : e; ++u < r; )
                        t = n[u].call(this, t);
                    return t
                }
            })
        }
        function jr(t, n, r, e, u, o, i, f, c, a) {
            function l() {
                for (var d = arguments.length, y = Array(d), b = d; b--; )
                    y[b] = arguments[b];
                if (_) {
                    var x, j = zr(l), b = y.length;
                    for (x = 0; b--; )
                        y[b] === j && x++
                }
                if (e && (y = ir(y, e, u, _)),
                o && (y = fr(y, o, i, _)),
                d -= x,
                _ && a > d)
                    return j = D(y, j),
                    Sr(t, n, jr, l.placeholder, r, y, j, f, c, a - d);
                if (j = h ? r : this,
                b = p ? j[t] : t,
                d = y.length,
                f) {
                    x = y.length;
                    for (var w = Ku(f.length, x), m = cr(y); w--; ) {
                        var A = f[w];
                        y[w] = Yr(A, x) ? m[A] : T
                    }
                } else
                    v && d > 1 && y.reverse();
                return s && d > c && (y.length = c),
                this && this !== Jt && this instanceof l && (b = g || yr(b)),
                b.apply(j, y)
            }
            var s = 128 & n
              , h = 1 & n
              , p = 2 & n
              , _ = 24 & n
              , v = 512 & n
              , g = p ? T : yr(t);
            return l
        }
        function wr(t, n) {
            return function(r, e) {
                return xn(r, t, n(e))
            }
        }
        function mr(t) {
            return function(n, r) {
                var e;
                if (n === T && r === T)
                    return 0;
                if (n !== T && (e = n),
                r !== T) {
                    if (e === T)
                        return r;
                    typeof n == "string" || typeof r == "string" ? (n = Gn(n),
                    r = Gn(r)) : (n = Kn(n),
                    r = Kn(r)),
                    e = t(n, r)
                }
                return e
            }
        }
        function Ar(t) {
            return Ie(function(n) {
                return n = 1 == n.length && ai(n[0]) ? l(n[0], O(Ur())) : l(ln(n, 1, Jr), O(Ur())),
                Ie(function(e) {
                    var u = this;
                    return t(n, function(t) {
                        return r(t, u, e)
                    })
                })
            })
        }
        function Or(t, n) {
            n = n === T ? " " : Gn(n);
            var r = n.length;
            return 2 > r ? r ? $n(n, t) : n : (r = $n(n, $u(t / N(n))),
            Wt.test(n) ? rr(r.match(St), 0, t).join("") : r.slice(0, t))
        }
        function kr(t, n, e, u) {
            function o() {
                for (var n = -1, c = arguments.length, a = -1, l = u.length, s = Array(l + c), h = this && this !== Jt && this instanceof o ? f : t; ++a < l; )
                    s[a] = u[a];
                for (; c--; )
                    s[a++] = arguments[++n];
                return r(h, i ? e : this, s)
            }
            var i = 1 & n
              , f = yr(t);
            return o
        }
        function Er(t) {
            return function(n, r, e) {
                e && typeof e != "number" && Hr(n, r, e) && (r = e = T),
                n = Ye(n),
                n = n === n ? n : 0,
                r === T ? (r = n,
                n = 0) : r = Ye(r) || 0,
                e = e === T ? r > n ? 1 : -1 : Ye(e) || 0;
                var u = -1;
                r = Vu($u((r - n) / (e || 1)), 0);
                for (var o = Array(r); r--; )
                    o[t ? r : ++u] = n,
                    n += e;
                return o
            }
        }
        function Ir(t) {
            return function(n, r) {
                return typeof n == "string" && typeof r == "string" || (n = Ye(n),
                r = Ye(r)),
                t(n, r)
            }
        }
        function Sr(t, n, r, e, u, o, i, f, c, a) {
            var l = 8 & n
              , s = l ? i : T;
            i = l ? T : i;
            var h = l ? o : T;
            return o = l ? T : o,
            n = (n | (l ? 32 : 64)) & ~(l ? 64 : 32),
            4 & n || (n &= -4),
            n = [t, n, u, h, s, o, i, f, c, a],
            r = r.apply(T, n),
            Xr(t) && ko(r, n),
            r.placeholder = e,
            r
        }
        function Rr(t) {
            var n = vu[t];
            return function(t, r) {
                if (t = Ye(t),
                r = Ge(r)) {
                    var e = (Qe(t) + "e").split("e")
                      , e = n(e[0] + "e" + (+e[1] + r))
                      , e = (Qe(e) + "e").split("e");
                    return +(e[0] + "e" + (+e[1] - r))
                }
                return n(t);
            }
        }
        function Wr(t) {
            return function(n) {
                var r = Pr(n);
                return "[object Map]" == r ? U(n) : "[object Set]" == r ? $(n) : A(n, t(n))
            }
        }
        function Br(t, n, r, e, u, o, i, f) {
            var c = 2 & n;
            if (!c && typeof t != "function")
                throw new du("Expected a function");
            var a = e ? e.length : 0;
            if (a || (n &= -97,
            e = u = T),
            i = i === T ? i : Vu(Ge(i), 0),
            f = f === T ? f : Ge(f),
            a -= u ? u.length : 0,
            64 & n) {
                var l = e
                  , s = u;
                e = u = T
            }
            var h = c ? T : mo(t);
            return o = [t, n, r, e, u, l, s, o, i, f],
            h && (r = o[1],
            t = h[1],
            n = r | t,
            e = 128 == t && 8 == r || 128 == t && 256 == r && h[8] >= o[7].length || 384 == t && h[8] >= h[7].length && 8 == r,
            131 > n || e) && (1 & t && (o[2] = h[2],
            n |= 1 & r ? 0 : 4),
            (r = h[3]) && (e = o[3],
            o[3] = e ? ir(e, r, h[4]) : r,
            o[4] = e ? D(o[3], "__lodash_placeholder__") : h[4]),
            (r = h[5]) && (e = o[5],
            o[5] = e ? fr(e, r, h[6]) : r,
            o[6] = e ? D(o[5], "__lodash_placeholder__") : h[6]),
            (r = h[7]) && (o[7] = r),
            128 & t && (o[8] = null == o[8] ? h[8] : Ku(o[8], h[8])),
            null == o[9] && (o[9] = h[9]),
            o[0] = h[0],
            o[1] = n),
            t = o[0],
            n = o[1],
            r = o[2],
            e = o[3],
            u = o[4],
            f = o[9] = null == o[9] ? c ? 0 : t.length : Vu(o[9] - a, 0),
            !f && 24 & n && (n &= -25),
            (h ? jo : ko)(n && 1 != n ? 8 == n || 16 == n ? br(t, n, f) : 32 != n && 33 != n || u.length ? jr.apply(T, o) : kr(t, n, r, e) : vr(t, n, r), o)
        }
        function Lr(t, n, r, e, u, o) {
            var i = 2 & u
              , f = t.length
              , c = n.length;
            if (f != c && !(i && c > f))
                return false;
            if (c = o.get(t))
                return c == n;
            var c = -1
              , a = true
              , l = 1 & u ? new $t : T;
            for (o.set(t, n); ++c < f; ) {
                var s = t[c]
                  , h = n[c];
                if (e)
                    var p = i ? e(h, s, c, n, t, o) : e(s, h, c, t, n, o);
                if (p !== T) {
                    if (p)
                        continue;
                    a = false;
                    break
                }
                if (l) {
                    if (!_(n, function(t, n) {
                        return l.has(n) || s !== t && !r(s, t, e, u, o) ? void 0 : l.add(n)
                    })) {
                        a = false;
                        break
                    }
                } else if (s !== h && !r(s, h, e, u, o)) {
                    a = false;
                    break
                }
            }
            return o["delete"](t),
            a
        }
        function Mr(t, n, r, e, u, o, i) {
            switch (r) {
            case "[object DataView]":
                if (t.byteLength != n.byteLength || t.byteOffset != n.byteOffset)
                    break;
                t = t.buffer,
                n = n.buffer;
            case "[object ArrayBuffer]":
                if (t.byteLength != n.byteLength || !e(new Wu(t), new Wu(n)))
                    break;
                return true;
            case "[object Boolean]":
            case "[object Date]":
                return +t == +n;
            case "[object Error]":
                return t.name == n.name && t.message == n.message;
            case "[object Number]":
                return t != +t ? n != +n : t == +n;
            case "[object RegExp]":
            case "[object String]":
                return t == n + "";
            case "[object Map]":
                var f = U;
            case "[object Set]":
                if (f || (f = F),
                t.size != n.size && !(2 & o))
                    break;
                return (r = i.get(t)) ? r == n : (o |= 1,
                i.set(t, n),
                Lr(f(t), f(n), e, u, o, i));
            case "[object Symbol]":
                if (_o)
                    return _o.call(t) == _o.call(n)
            }
            return false
        }
        function Cr(t) {
            for (var n = t.name + "", r = fo[n], e = wu.call(fo, n) ? r.length : 0; e--; ) {
                var u = r[e]
                  , o = u.func;
                if (null == o || o == t)
                    return u.name
            }
            return n
        }
        function zr(t) {
            return (wu.call(At, "placeholder") ? At : t).placeholder
        }
        function Ur() {
            var t = At.iteratee || au
              , t = t === au ? An : t;
            return arguments.length ? t(arguments[0], arguments[1]) : t
        }
        function Dr(t, n) {
            var r = t.__data__
              , e = typeof n;
            return ("string" == e || "number" == e || "symbol" == e || "boolean" == e ? "__proto__" !== n : null === n) ? r[typeof n == "string" ? "string" : "hash"] : r.map;
        }
        function Fr(t) {
            t = Ei(t);
            for (var n = t.length; n--; ) {
                var r = t[n][1];
                t[n][2] = r === r && !Ue(r)
            }
            return t
        }
        function $r(t, n) {
            var r = t[n];
            return Fe(r) ? r : T
        }
        function Nr(t) {
            return Mu(Object(t))
        }
        function Pr(t) {
            return Ou.call(t)
        }
        function Zr(t, n, r) {
            n = Qr(n, t) ? [n] : nr(n);
            for (var e, u = -1, o = n.length; ++u < o; ) {
                var i = ue(n[u]);
                if (!(e = null != t && r(t, i)))
                    break;
                t = t[i]
            }
            return e ? e : (o = t ? t.length : 0,
            !!o && ze(o) && Yr(i, o) && (ai(t) || Ze(t) || Re(t)))
        }
        function Tr(t) {
            var n = t.length
              , r = t.constructor(n);
            return n && "string" == typeof t[0] && wu.call(t, "index") && (r.index = t.index,
            r.input = t.input),
            r
        }
        function qr(t) {
            return typeof t.constructor != "function" || te(t) ? {} : en(Pu(Object(t)))
        }
        function Vr(r, e, u, o) {
            var i = r.constructor;
            switch (e) {
            case "[object ArrayBuffer]":
                return ur(r);
            case "[object Boolean]":
            case "[object Date]":
                return new i(+r);
            case "[object DataView]":
                return e = o ? ur(r.buffer) : r.buffer,
                new r.constructor(e,r.byteOffset,r.byteLength);
            case "[object Float32Array]":
            case "[object Float64Array]":
            case "[object Int8Array]":
            case "[object Int16Array]":
            case "[object Int32Array]":
            case "[object Uint8Array]":
            case "[object Uint8ClampedArray]":
            case "[object Uint16Array]":
            case "[object Uint32Array]":
                return e = o ? ur(r.buffer) : r.buffer,
                new r.constructor(e,r.byteOffset,r.length);
            case "[object Map]":
                return e = o ? u(U(r), true) : U(r),
                h(e, t, new r.constructor);
            case "[object Number]":
            case "[object String]":
                return new i(r);
            case "[object RegExp]":
                return e = new r.constructor(r.source,_t.exec(r)),
                e.lastIndex = r.lastIndex,
                e;
            case "[object Set]":
                return e = o ? u(F(r), true) : F(r),
                h(e, n, new r.constructor);
            case "[object Symbol]":
                return _o ? Object(_o.call(r)) : {};
            }
        }
        function Kr(t) {
            var n = t ? t.length : T;
            return ze(n) && (ai(t) || Ze(t) || Re(t)) ? m(n, String) : null
        }
        function Gr(t) {
            return ai(t) || Re(t)
        }
        function Jr(t) {
            return ai(t) && !(2 == t.length && !Me(t[0]))
        }
        function Yr(t, n) {
            return n = null == n ? 9007199254740991 : n,
            !!n && (typeof t == "number" || xt.test(t)) && t > -1 && 0 == t % 1 && n > t
        }
        function Hr(t, n, r) {
            if (!Ue(r))
                return false;
            var e = typeof n;
            return ("number" == e ? We(r) && Yr(n, r.length) : "string" == e && n in r) ? Se(r[n], t) : false
        }
        function Qr(t, n) {
            if (ai(t))
                return false;
            var r = typeof t;
            return "number" == r || "symbol" == r || "boolean" == r || null == t || Te(t) ? true : ut.test(t) || !et.test(t) || null != n && t in Object(n);
        }
        function Xr(t) {
            var n = Cr(t)
              , r = At[n];
            return typeof r == "function" && n in zt.prototype ? t === r ? true : (n = mo(r),
            !!n && t === n[0]) : false
        }
        function te(t) {
            var n = t && t.constructor;
            return t === (typeof n == "function" && n.prototype || bu)
        }
        function ne(t, n) {
            return function(r) {
                return null == r ? false : r[t] === n && (n !== T || t in Object(r))
            }
        }
        function re(t, n, r, e, u, o) {
            return Ue(t) && Ue(n) && Rn(t, n, T, re, o.set(n, t)),
            t
        }
        function ee(t, n) {
            return 1 == n.length ? t : _n(t, Pn(n, 0, -1))
        }
        function ue(t) {
            if (typeof t == "string" || Te(t))
                return t;
            var n = t + "";
            return "0" == n && 1 / t == -q ? "-0" : n;
        }
        function oe(t) {
            if (null != t) {
                try {
                    return ju.call(t)
                } catch (n) {}
                return t + ""
            }
            return ""
        }
        function ie(t) {
            if (t instanceof zt)
                return t.clone();
            var n = new kt(t.__wrapped__,t.__chain__);
            return n.__actions__ = cr(t.__actions__),
            n.__index__ = t.__index__,
            n.__values__ = t.__values__,
            n
        }
        function fe(t, n, r) {
            var e = t ? t.length : 0;
            return e ? (n = r || n === T ? 1 : Ge(n),
            Pn(t, 0 > n ? 0 : n, e)) : []
        }
        function ce(t, n, r) {
            var e = t ? t.length : 0;
            return e ? (n = r || n === T ? 1 : Ge(n),
            n = e - n,
            Pn(t, 0, 0 > n ? 0 : n)) : []
        }
        function ae(t) {
            return t && t.length ? t[0] : T
        }
        function le(t) {
            var n = t ? t.length : 0;
            return n ? t[n - 1] : T
        }
        function se(t, n) {
            return t && t.length && n && n.length ? Un(t, n) : t
        }
        function he(t) {
            return t ? Hu.call(t) : t
        }
        function pe(t) {
            if (!t || !t.length)
                return [];
            var n = 0;
            return t = f(t, function(t) {
                return Be(t) ? (n = Vu(t.length, n),
                true) : void 0
            }),
            m(n, function(n) {
                return l(t, Cn(n))
            })
        }
        function _e(t, n) {
            if (!t || !t.length)
                return [];
            var e = pe(t);
            return null == n ? e : l(e, function(t) {
                return r(n, T, t)
            })
        }
        function ve(t) {
            return t = At(t),
            t.__chain__ = true,
            t
        }
        function ge(t, n) {
            return n(t)
        }
        function de() {
            return this
        }
        function ye(t, n) {
            return (ai(t) ? u : go)(t, Ur(n, 3));
        }
        function be(t, n) {
            return (ai(t) ? o : yo)(t, Ur(n, 3))
        }
        function xe(t, n) {
            return (ai(t) ? l : En)(t, Ur(n, 3))
        }
        function je(t, n, r) {
            var e = -1
              , u = Ve(t)
              , o = u.length
              , i = o - 1;
            for (n = (r ? Hr(t, n, r) : n === T) ? 1 : tn(Ge(n), 0, o); ++e < n; )
                t = Fn(e, i),
                r = u[t],
                u[t] = u[e],
                u[e] = r;
            return u.length = n,
            u
        }
        function we(t, n, r) {
            return n = r ? T : n,
            n = t && null == n ? t.length : n,
            Br(t, 128, T, T, T, T, n)
        }
        function me(t, n) {
            var r;
            if (typeof n != "function")
                throw new du("Expected a function");
            return t = Ge(t),
            function() {
                return 0 < --t && (r = n.apply(this, arguments)),
                1 >= t && (n = T),
                r
            }
        }
        function Ae(t, n, r) {
            return n = r ? T : n,
            t = Br(t, 8, T, T, T, T, T, n),
            t.placeholder = Ae.placeholder,
            t
        }
        function Oe(t, n, r) {
            return n = r ? T : n,
            t = Br(t, 16, T, T, T, T, T, n),
            t.placeholder = Oe.placeholder,
            t
        }
        function ke(t, n, r) {
            function e(n) {
                var r = c
                  , e = a;
                return c = a = T,
                _ = n,
                s = t.apply(e, r)
            }
            function u(t) {
                var r = t - p;
                return t -= _,
                !p || r >= n || 0 > r || g && t >= l
            }
            function o() {
                var t = Qo();
                if (u(t))
                    return i(t);
                var r;
                r = t - _,
                t = n - (t - p),
                r = g ? Ku(t, l - r) : t,
                h = Du(o, r)
            }
            function i(t) {
                return Bu(h),
                h = T,
                d && c ? e(t) : (c = a = T,
                s)
            }
            function f() {
                var t = Qo()
                  , r = u(t);
                if (c = arguments,
                a = this,
                p = t,
                r) {
                    if (h === T)
                        return _ = t = p,
                        h = Du(o, n),
                        v ? e(t) : s;
                    if (g)
                        return Bu(h),
                        h = Du(o, n),
                        e(p)
                }
                return h === T && (h = Du(o, n)),
                s
            }
            var c, a, l, s, h, p = 0, _ = 0, v = false, g = false, d = true;
            if (typeof t != "function")
                throw new du("Expected a function");
            return n = Ye(n) || 0,
            Ue(r) && (v = !!r.leading,
            l = (g = "maxWait"in r) ? Vu(Ye(r.maxWait) || 0, n) : l,
            d = "trailing"in r ? !!r.trailing : d),
            f.cancel = function() {
                h !== T && Bu(h),
                p = _ = 0,
                c = a = h = T
            }
            ,
            f.flush = function() {
                return h === T ? s : i(Qo())
            }
            ,
            f
        }
        function Ee(t, n) {
            function r() {
                var e = arguments
                  , u = n ? n.apply(this, e) : e[0]
                  , o = r.cache;
                return o.has(u) ? o.get(u) : (e = t.apply(this, e),
                r.cache = o.set(u, e),
                e)
            }
            if (typeof t != "function" || n && typeof n != "function")
                throw new du("Expected a function");
            return r.cache = new (Ee.Cache || Ft),
            r
        }
        function Ie(t, n) {
            if (typeof t != "function")
                throw new du("Expected a function");
            return n = Vu(n === T ? t.length - 1 : Ge(n), 0),
            function() {
                for (var e = arguments, u = -1, o = Vu(e.length - n, 0), i = Array(o); ++u < o; )
                    i[u] = e[n + u];
                switch (n) {
                case 0:
                    return t.call(this, i);
                case 1:
                    return t.call(this, e[0], i);
                case 2:
                    return t.call(this, e[0], e[1], i)
                }
                for (o = Array(n + 1),
                u = -1; ++u < n; )
                    o[u] = e[u];
                return o[n] = i,
                r(t, this, o)
            }
        }
        function Se(t, n) {
            return t === n || t !== t && n !== n
        }
        function Re(t) {
            return Be(t) && wu.call(t, "callee") && (!Uu.call(t, "callee") || "[object Arguments]" == Ou.call(t))
        }
        function We(t) {
            return null != t && ze(Ao(t)) && !Me(t)
        }
        function Be(t) {
            return De(t) && We(t)
        }
        function Le(t) {
            return De(t) ? "[object Error]" == Ou.call(t) || typeof t.message == "string" && typeof t.name == "string" : false
        }
        function Me(t) {
            return t = Ue(t) ? Ou.call(t) : "",
            "[object Function]" == t || "[object GeneratorFunction]" == t
        }
        function Ce(t) {
            return typeof t == "number" && t == Ge(t);
        }
        function ze(t) {
            return typeof t == "number" && t > -1 && 0 == t % 1 && 9007199254740991 >= t
        }
        function Ue(t) {
            var n = typeof t;
            return !!t && ("object" == n || "function" == n)
        }
        function De(t) {
            return !!t && typeof t == "object"
        }
        function Fe(t) {
            return Ue(t) ? (Me(t) || C(t) ? Eu : yt).test(oe(t)) : false
        }
        function $e(t) {
            return typeof t == "number" || De(t) && "[object Number]" == Ou.call(t)
        }
        function Ne(t) {
            return !De(t) || "[object Object]" != Ou.call(t) || C(t) ? false : (t = Pu(Object(t)),
            null === t ? true : (t = wu.call(t, "constructor") && t.constructor,
            typeof t == "function" && t instanceof t && ju.call(t) == Au));
        }
        function Pe(t) {
            return Ue(t) && "[object RegExp]" == Ou.call(t)
        }
        function Ze(t) {
            return typeof t == "string" || !ai(t) && De(t) && "[object String]" == Ou.call(t)
        }
        function Te(t) {
            return typeof t == "symbol" || De(t) && "[object Symbol]" == Ou.call(t)
        }
        function qe(t) {
            return De(t) && ze(t.length) && !!Mt[Ou.call(t)]
        }
        function Ve(t) {
            if (!t)
                return [];
            if (We(t))
                return Ze(t) ? t.match(St) : cr(t);
            if (Cu && t[Cu])
                return z(t[Cu]());
            var n = Pr(t);
            return ("[object Map]" == n ? U : "[object Set]" == n ? F : eu)(t)
        }
        function Ke(t) {
            return t ? (t = Ye(t),
            t === q || t === -q ? 1.7976931348623157e308 * (0 > t ? -1 : 1) : t === t ? t : 0) : 0 === t ? t : 0;
        }
        function Ge(t) {
            t = Ke(t);
            var n = t % 1;
            return t === t ? n ? t - n : t : 0
        }
        function Je(t) {
            return t ? tn(Ge(t), 0, 4294967295) : 0
        }
        function Ye(t) {
            if (typeof t == "number")
                return t;
            if (Te(t))
                return V;
            if (Ue(t) && (t = Me(t.valueOf) ? t.valueOf() : t,
            t = Ue(t) ? t + "" : t),
            typeof t != "string")
                return 0 === t ? t : +t;
            t = t.replace(ct, "");
            var n = dt.test(t);
            return n || bt.test(t) ? Pt(t.slice(2), n ? 2 : 8) : gt.test(t) ? V : +t
        }
        function He(t) {
            return ar(t, ru(t))
        }
        function Qe(t) {
            return null == t ? "" : Gn(t)
        }
        function Xe(t, n, r) {
            return t = null == t ? T : _n(t, n),
            t === T ? r : t
        }
        function tu(t, n) {
            return null != t && Zr(t, n, yn)
        }
        function nu(t) {
            var n = te(t);
            if (!n && !We(t))
                return qu(Object(t));
            var r, e = Kr(t), u = !!e, e = e || [], o = e.length;
            for (r in t)
                !dn(t, r) || u && ("length" == r || Yr(r, o)) || n && "constructor" == r || e.push(r);
            return e
        }
        function ru(t) {
            for (var n = -1, r = te(t), e = On(t), u = e.length, o = Kr(t), i = !!o, o = o || [], f = o.length; ++n < u; ) {
                var c = e[n];
                i && ("length" == c || Yr(c, f)) || "constructor" == c && (r || !wu.call(t, c)) || o.push(c)
            }
            return o
        }
        function eu(t) {
            return t ? k(t, nu(t)) : []
        }
        function uu(t) {
            return zi(Qe(t).toLowerCase())
        }
        function ou(t) {
            return (t = Qe(t)) && t.replace(jt, W).replace(It, "")
        }
        function iu(t, n, r) {
            return t = Qe(t),
            n = r ? T : n,
            n === T && (n = Bt.test(t) ? Rt : st),
            t.match(n) || []
        }
        function fu(t) {
            return function() {
                return t
            }
        }
        function cu(t) {
            return t
        }
        function au(t) {
            return An(typeof t == "function" ? t : nn(t, true))
        }
        function lu(t, n, r) {
            var e = nu(n)
              , o = pn(n, e);
            null != r || Ue(n) && (o.length || !e.length) || (r = n,
            n = t,
            t = this,
            o = pn(n, nu(n)));
            var i = !(Ue(r) && "chain"in r && !r.chain)
              , f = Me(t);
            return u(o, function(r) {
                var e = n[r];
                t[r] = e,
                f && (t.prototype[r] = function() {
                    var n = this.__chain__;
                    if (i || n) {
                        var r = t(this.__wrapped__);
                        return (r.__actions__ = cr(this.__actions__)).push({
                            func: e,
                            args: arguments,
                            thisArg: t
                        }),
                        r.__chain__ = n,
                        r
                    }
                    return e.apply(t, s([this.value()], arguments))
                }
                )
            }),
            t
        }
        function su() {}
        function hu(t) {
            return Qr(t) ? Cn(ue(t)) : zn(t)
        }
        R = R ? Yt.defaults({}, R, Yt.pick(Jt, Lt)) : Jt;
        var pu = R.Date
          , _u = R.Error
          , vu = R.Math
          , gu = R.RegExp
          , du = R.TypeError
          , yu = R.Array.prototype
          , bu = R.Object.prototype
          , xu = R.String.prototype
          , ju = R.Function.prototype.toString
          , wu = bu.hasOwnProperty
          , mu = 0
          , Au = ju.call(Object)
          , Ou = bu.toString
          , ku = Jt._
          , Eu = gu("^" + ju.call(wu).replace(it, "\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g, "$1.*?") + "$")
          , Iu = qt ? R.Buffer : T
          , Su = R.Reflect
          , Ru = R.Symbol
          , Wu = R.Uint8Array
          , Bu = R.clearTimeout
          , Lu = Su ? Su.f : T
          , Mu = Object.getOwnPropertySymbols
          , Cu = typeof (Cu = Ru && Ru.iterator) == "symbol" ? Cu : T
          , zu = Object.create
          , Uu = bu.propertyIsEnumerable
          , Du = R.setTimeout
          , Fu = yu.splice
          , $u = vu.ceil
          , Nu = vu.floor
          , Pu = Object.getPrototypeOf
          , Zu = R.isFinite
          , Tu = yu.join
          , qu = Object.keys
          , Vu = vu.max
          , Ku = vu.min
          , Gu = R.parseInt
          , Ju = vu.random
          , Yu = xu.replace
          , Hu = yu.reverse
          , Qu = xu.split
          , Xu = $r(R, "DataView")
          , to = $r(R, "Map")
          , no = $r(R, "Promise")
          , ro = $r(R, "Set")
          , eo = $r(R, "WeakMap")
          , uo = $r(Object, "create")
          , oo = eo && new eo
          , io = !Uu.call({
            valueOf: 1
        }, "valueOf")
          , fo = {}
          , co = oe(Xu)
          , ao = oe(to)
          , lo = oe(no)
          , so = oe(ro)
          , ho = oe(eo)
          , po = Ru ? Ru.prototype : T
          , _o = po ? po.valueOf : T
          , vo = po ? po.toString : T;
        At.templateSettings = {
            escape: tt,
            evaluate: nt,
            interpolate: rt,
            variable: "",
            imports: {
                _: At
            }
        },
        At.prototype = Ot.prototype,
        At.prototype.constructor = At,
        kt.prototype = en(Ot.prototype),
        kt.prototype.constructor = kt,
        zt.prototype = en(Ot.prototype),
        zt.prototype.constructor = zt,
        Ut.prototype.clear = function() {
            this.__data__ = uo ? uo(null) : {}
        }
        ,
        Ut.prototype["delete"] = function(t) {
            return this.has(t) && delete this.__data__[t];
        }
        ,
        Ut.prototype.get = function(t) {
            var n = this.__data__;
            return uo ? (t = n[t],
            "__lodash_hash_undefined__" === t ? T : t) : wu.call(n, t) ? n[t] : T
        }
        ,
        Ut.prototype.has = function(t) {
            var n = this.__data__;
            return uo ? n[t] !== T : wu.call(n, t)
        }
        ,
        Ut.prototype.set = function(t, n) {
            return this.__data__[t] = uo && n === T ? "__lodash_hash_undefined__" : n,
            this
        }
        ,
        Dt.prototype.clear = function() {
            this.__data__ = []
        }
        ,
        Dt.prototype["delete"] = function(t) {
            var n = this.__data__;
            return t = Gt(n, t),
            0 > t ? false : (t == n.length - 1 ? n.pop() : Fu.call(n, t, 1),
            true)
        }
        ,
        Dt.prototype.get = function(t) {
            var n = this.__data__;
            return t = Gt(n, t),
            0 > t ? T : n[t][1]
        }
        ,
        Dt.prototype.has = function(t) {
            return -1 < Gt(this.__data__, t)
        }
        ,
        Dt.prototype.set = function(t, n) {
            var r = this.__data__
              , e = Gt(r, t);
            return 0 > e ? r.push([t, n]) : r[e][1] = n,
            this
        }
        ,
        Ft.prototype.clear = function() {
            this.__data__ = {
                hash: new Ut,
                map: new (to || Dt),
                string: new Ut
            }
        }
        ,
        Ft.prototype["delete"] = function(t) {
            return Dr(this, t)["delete"](t)
        }
        ,
        Ft.prototype.get = function(t) {
            return Dr(this, t).get(t)
        }
        ,
        Ft.prototype.has = function(t) {
            return Dr(this, t).has(t)
        }
        ,
        Ft.prototype.set = function(t, n) {
            return Dr(this, t).set(t, n),
            this
        }
        ,
        $t.prototype.add = $t.prototype.push = function(t) {
            return this.__data__.set(t, "__lodash_hash_undefined__"),
            this
        }
        ,
        $t.prototype.has = function(t) {
            return this.__data__.has(t)
        }
        ,
        Zt.prototype.clear = function() {
            this.__data__ = new Dt
        }
        ,
        Zt.prototype["delete"] = function(t) {
            return this.__data__["delete"](t)
        }
        ,
        Zt.prototype.get = function(t) {
            return this.__data__.get(t)
        }
        ,
        Zt.prototype.has = function(t) {
            return this.__data__.has(t)
        }
        ,
        Zt.prototype.set = function(t, n) {
            var r = this.__data__;
            return r instanceof Dt && 200 == r.__data__.length && (r = this.__data__ = new Ft(r.__data__)),
            r.set(t, n),
            this
        }
        ;
        var go = pr(sn)
          , yo = pr(hn, true)
          , bo = _r()
          , xo = _r(true);
        Lu && !Uu.call({
            valueOf: 1
        }, "valueOf") && (On = function(t) {
            return z(Lu(t))
        }
        );
        var jo = oo ? function(t, n) {
            return oo.set(t, n),
            t
        }
        : cu
          , wo = ro && 1 / F(new ro([, -0]))[1] == q ? function(t) {
            return new ro(t)
        }
        : su
          , mo = oo ? function(t) {
            return oo.get(t)
        }
        : su
          , Ao = Cn("length");
        Mu || (Nr = function() {
            return []
        }
        );
        var Oo = Mu ? function(t) {
            for (var n = []; t; )
                s(n, Nr(t)),
                t = Pu(Object(t));
            return n
        }
        : Nr;
        (Xu && "[object DataView]" != Pr(new Xu(new ArrayBuffer(1))) || to && "[object Map]" != Pr(new to) || no && "[object Promise]" != Pr(no.resolve()) || ro && "[object Set]" != Pr(new ro) || eo && "[object WeakMap]" != Pr(new eo)) && (Pr = function(t) {
            var n = Ou.call(t);
            if (t = (t = "[object Object]" == n ? t.constructor : T) ? oe(t) : T)
                switch (t) {
                case co:
                    return "[object DataView]";
                case ao:
                    return "[object Map]";
                case lo:
                    return "[object Promise]";
                case so:
                    return "[object Set]";
                case ho:
                    return "[object WeakMap]"
                }
            return n
        }
        );
        var ko = function() {
            var t = 0
              , n = 0;
            return function(r, e) {
                var u = Qo()
                  , o = 16 - (u - n);
                if (n = u,
                o > 0) {
                    if (150 <= ++t)
                        return r
                } else
                    t = 0;
                return jo(r, e)
            }
        }()
          , Eo = Ee(function(t) {
            var n = [];
            return Qe(t).replace(ot, function(t, r, e, u) {
                n.push(e ? u.replace(ht, "$1") : r || t)
            }),
            n
        })
          , Io = Ie(function(t, n) {
            return Be(t) ? on(t, ln(n, 1, Be, true)) : []
        })
          , So = Ie(function(t, n) {
            var r = le(n);
            return Be(r) && (r = T),
            Be(t) ? on(t, ln(n, 1, Be, true), Ur(r)) : []
        })
          , Ro = Ie(function(t, n) {
            var r = le(n);
            return Be(r) && (r = T),
            Be(t) ? on(t, ln(n, 1, Be, true), T, r) : []
        })
          , Wo = Ie(function(t) {
            var n = l(t, tr);
            return n.length && n[0] === t[0] ? bn(n) : []
        })
          , Bo = Ie(function(t) {
            var n = le(t)
              , r = l(t, tr);
            return n === le(r) ? n = T : r.pop(),
            r.length && r[0] === t[0] ? bn(r, Ur(n)) : []
        })
          , Lo = Ie(function(t) {
            var n = le(t)
              , r = l(t, tr);
            return n === le(r) ? n = T : r.pop(),
            r.length && r[0] === t[0] ? bn(r, T, n) : []
        })
          , Mo = Ie(se)
          , Co = Ie(function(t, n) {
            n = ln(n, 1);
            var r = t ? t.length : 0
              , e = Xt(t, n);
            return Dn(t, l(n, function(t) {
                return Yr(t, r) ? +t : t
            }).sort(or)),
            e
        })
          , zo = Ie(function(t) {
            return Jn(ln(t, 1, Be, true))
        })
          , Uo = Ie(function(t) {
            var n = le(t);
            return Be(n) && (n = T),
            Jn(ln(t, 1, Be, true), Ur(n))
        })
          , Do = Ie(function(t) {
            var n = le(t);
            return Be(n) && (n = T),
            Jn(ln(t, 1, Be, true), T, n)
        })
          , Fo = Ie(function(t, n) {
            return Be(t) ? on(t, n) : []
        })
          , $o = Ie(function(t) {
            return Qn(f(t, Be))
        })
          , No = Ie(function(t) {
            var n = le(t);
            return Be(n) && (n = T),
            Qn(f(t, Be), Ur(n))
        })
          , Po = Ie(function(t) {
            var n = le(t);
            return Be(n) && (n = T),
            Qn(f(t, Be), T, n)
        })
          , Zo = Ie(pe)
          , To = Ie(function(t) {
            var n = t.length
              , n = n > 1 ? t[n - 1] : T
              , n = typeof n == "function" ? (t.pop(),
            n) : T;
            return _e(t, n)
        })
          , qo = Ie(function(t) {
            function n(n) {
                return Xt(n, t)
            }
            t = ln(t, 1);
            var r = t.length
              , e = r ? t[0] : 0
              , u = this.__wrapped__;
            return !(r > 1 || this.__actions__.length) && u instanceof zt && Yr(e) ? (u = u.slice(e, +e + (r ? 1 : 0)),
            u.__actions__.push({
                func: ge,
                args: [n],
                thisArg: T
            }),
            new kt(u,this.__chain__).thru(function(t) {
                return r && !t.length && t.push(T),
                t
            })) : this.thru(n)
        })
          , Vo = sr(function(t, n, r) {
            wu.call(t, r) ? ++t[r] : t[r] = 1;
        })
          , Ko = sr(function(t, n, r) {
            wu.call(t, r) ? t[r].push(n) : t[r] = [n]
        })
          , Go = Ie(function(t, n, e) {
            var u = -1
              , o = typeof n == "function"
              , i = Qr(n)
              , f = We(t) ? Array(t.length) : [];
            return go(t, function(t) {
                var c = o ? n : i && null != t ? t[n] : T;
                f[++u] = c ? r(c, t, e) : jn(t, n, e)
            }),
            f
        })
          , Jo = sr(function(t, n, r) {
            t[r] = n
        })
          , Yo = sr(function(t, n, r) {
            t[r ? 0 : 1].push(n)
        }, function() {
            return [[], []]
        })
          , Ho = Ie(function(t, n) {
            if (null == t)
                return [];
            var r = n.length;
            return r > 1 && Hr(t, n[0], n[1]) ? n = [] : r > 2 && Hr(n[0], n[1], n[2]) && (n = [n[0]]),
            n = 1 == n.length && ai(n[0]) ? n[0] : ln(n, 1, Jr),
            Bn(t, n, []);
        })
          , Qo = pu.now
          , Xo = Ie(function(t, n, r) {
            var e = 1;
            if (r.length)
                var u = D(r, zr(Xo))
                  , e = 32 | e;
            return Br(t, e, n, r, u)
        })
          , ti = Ie(function(t, n, r) {
            var e = 3;
            if (r.length)
                var u = D(r, zr(ti))
                  , e = 32 | e;
            return Br(n, e, t, r, u)
        })
          , ni = Ie(function(t, n) {
            return un(t, 1, n)
        })
          , ri = Ie(function(t, n, r) {
            return un(t, Ye(n) || 0, r)
        });
        Ee.Cache = Ft;
        var ei = Ie(function(t, n) {
            n = 1 == n.length && ai(n[0]) ? l(n[0], O(Ur())) : l(ln(n, 1, Jr), O(Ur()));
            var e = n.length;
            return Ie(function(u) {
                for (var o = -1, i = Ku(u.length, e); ++o < i; )
                    u[o] = n[o].call(this, u[o]);
                return r(t, this, u)
            })
        })
          , ui = Ie(function(t, n) {
            var r = D(n, zr(ui));
            return Br(t, 32, T, n, r)
        })
          , oi = Ie(function(t, n) {
            var r = D(n, zr(oi));
            return Br(t, 64, T, n, r)
        })
          , ii = Ie(function(t, n) {
            return Br(t, 256, T, T, T, ln(n, 1))
        })
          , fi = Ir(gn)
          , ci = Ir(function(t, n) {
            return t >= n
        })
          , ai = Array.isArray
          , li = Iu ? function(t) {
            return t instanceof Iu
        }
        : fu(false)
          , si = Ir(kn)
          , hi = Ir(function(t, n) {
            return n >= t
        })
          , pi = hr(function(t, n) {
            if (io || te(n) || We(n))
                ar(n, nu(n), t);
            else
                for (var r in n)
                    wu.call(n, r) && Kt(t, r, n[r])
        })
          , _i = hr(function(t, n) {
            if (io || te(n) || We(n))
                ar(n, ru(n), t);
            else
                for (var r in n)
                    Kt(t, r, n[r])
        })
          , vi = hr(function(t, n, r, e) {
            ar(n, ru(n), t, e)
        })
          , gi = hr(function(t, n, r, e) {
            ar(n, nu(n), t, e)
        })
          , di = Ie(function(t, n) {
            return Xt(t, ln(n, 1))
        })
          , yi = Ie(function(t) {
            return t.push(T, Tt),
            r(vi, T, t)
        })
          , bi = Ie(function(t) {
            return t.push(T, re),
            r(Ai, T, t)
        })
          , xi = wr(function(t, n, r) {
            t[n] = r
        }, fu(cu))
          , ji = wr(function(t, n, r) {
            wu.call(t, n) ? t[n].push(r) : t[n] = [r]
        }, Ur)
          , wi = Ie(jn)
          , mi = hr(function(t, n, r) {
            Rn(t, n, r)
        })
          , Ai = hr(function(t, n, r, e) {
            Rn(t, n, r, e)
        })
          , Oi = Ie(function(t, n) {
            return null == t ? {} : (n = l(ln(n, 1), ue),
            Ln(t, on(vn(t, ru, Oo), n)))
        })
          , ki = Ie(function(t, n) {
            return null == t ? {} : Ln(t, l(ln(n, 1), ue));
        })
          , Ei = Wr(nu)
          , Ii = Wr(ru)
          , Si = dr(function(t, n, r) {
            return n = n.toLowerCase(),
            t + (r ? uu(n) : n)
        })
          , Ri = dr(function(t, n, r) {
            return t + (r ? "-" : "") + n.toLowerCase()
        })
          , Wi = dr(function(t, n, r) {
            return t + (r ? " " : "") + n.toLowerCase()
        })
          , Bi = gr("toLowerCase")
          , Li = dr(function(t, n, r) {
            return t + (r ? "_" : "") + n.toLowerCase()
        })
          , Mi = dr(function(t, n, r) {
            return t + (r ? " " : "") + zi(n)
        })
          , Ci = dr(function(t, n, r) {
            return t + (r ? " " : "") + n.toUpperCase()
        })
          , zi = gr("toUpperCase")
          , Ui = Ie(function(t, n) {
            try {
                return r(t, T, n)
            } catch (e) {
                return Le(e) ? e : new _u(e)
            }
        })
          , Di = Ie(function(t, n) {
            return u(ln(n, 1), function(n) {
                n = ue(n),
                t[n] = Xo(t[n], t)
            }),
            t
        })
          , Fi = xr()
          , $i = xr(true)
          , Ni = Ie(function(t, n) {
            return function(r) {
                return jn(r, t, n)
            }
        })
          , Pi = Ie(function(t, n) {
            return function(r) {
                return jn(t, r, n)
            }
        })
          , Zi = Ar(l)
          , Ti = Ar(i)
          , qi = Ar(_)
          , Vi = Er()
          , Ki = Er(true)
          , Gi = mr(function(t, n) {
            return t + n
        })
          , Ji = Rr("ceil")
          , Yi = mr(function(t, n) {
            return t / n
        })
          , Hi = Rr("floor")
          , Qi = mr(function(t, n) {
            return t * n
        })
          , Xi = Rr("round")
          , tf = mr(function(t, n) {
            return t - n
        });
        return At.after = function(t, n) {
            if (typeof n != "function")
                throw new du("Expected a function");
            return t = Ge(t),
            function() {
                return 1 > --t ? n.apply(this, arguments) : void 0
            }
        }
        ,
        At.ary = we,
        At.assign = pi,
        At.assignIn = _i,
        At.assignInWith = vi,
        At.assignWith = gi,
        At.at = di,
        At.before = me,
        At.bind = Xo,
        At.bindAll = Di,
        At.bindKey = ti,
        At.castArray = function() {
            if (!arguments.length)
                return [];
            var t = arguments[0];
            return ai(t) ? t : [t]
        }
        ,
        At.chain = ve,
        At.chunk = function(t, n, r) {
            if (n = (r ? Hr(t, n, r) : n === T) ? 1 : Vu(Ge(n), 0),
            r = t ? t.length : 0,
            !r || 1 > n)
                return [];
            for (var e = 0, u = 0, o = Array($u(r / n)); r > e; )
                o[u++] = Pn(t, e, e += n);
            return o
        }
        ,
        At.compact = function(t) {
            for (var n = -1, r = t ? t.length : 0, e = 0, u = []; ++n < r; ) {
                var o = t[n];
                o && (u[e++] = o)
            }
            return u
        }
        ,
        At.concat = function() {
            for (var t = arguments.length, n = Array(t ? t - 1 : 0), r = arguments[0], e = t; e--; )
                n[e - 1] = arguments[e];
            return t ? s(ai(r) ? cr(r) : [r], ln(n, 1)) : []
        }
        ,
        At.cond = function(t) {
            var n = t ? t.length : 0
              , e = Ur();
            return t = n ? l(t, function(t) {
                if ("function" != typeof t[1])
                    throw new du("Expected a function");
                return [e(t[0]), t[1]]
            }) : [],
            Ie(function(e) {
                for (var u = -1; ++u < n; ) {
                    var o = t[u];
                    if (r(o[0], this, e))
                        return r(o[1], this, e)
                }
            })
        }
        ,
        At.conforms = function(t) {
            return rn(nn(t, true))
        }
        ,
        At.constant = fu,
        At.countBy = Vo,
        At.create = function(t, n) {
            var r = en(t);
            return n ? Qt(r, n) : r
        }
        ,
        At.curry = Ae,
        At.curryRight = Oe,
        At.debounce = ke,
        At.defaults = yi,
        At.defaultsDeep = bi,
        At.defer = ni,
        At.delay = ri,
        At.difference = Io,
        At.differenceBy = So,
        At.differenceWith = Ro,
        At.drop = fe,
        At.dropRight = ce,
        At.dropRightWhile = function(t, n) {
            return t && t.length ? Yn(t, Ur(n, 3), true, true) : []
        }
        ,
        At.dropWhile = function(t, n) {
            return t && t.length ? Yn(t, Ur(n, 3), true) : []
        }
        ,
        At.fill = function(t, n, r, e) {
            var u = t ? t.length : 0;
            if (!u)
                return [];
            for (r && typeof r != "number" && Hr(t, n, r) && (r = 0,
            e = u),
            u = t.length,
            r = Ge(r),
            0 > r && (r = -r > u ? 0 : u + r),
            e = e === T || e > u ? u : Ge(e),
            0 > e && (e += u),
            e = r > e ? 0 : Je(e); e > r; )
                t[r++] = n;
            return t
        }
        ,
        At.filter = function(t, n) {
            return (ai(t) ? f : an)(t, Ur(n, 3))
        }
        ,
        At.flatMap = function(t, n) {
            return ln(xe(t, n), 1)
        }
        ,
        At.flatMapDeep = function(t, n) {
            return ln(xe(t, n), q)
        }
        ,
        At.flatMapDepth = function(t, n, r) {
            return r = r === T ? 1 : Ge(r),
            ln(xe(t, n), r)
        }
        ,
        At.flatten = function(t) {
            return t && t.length ? ln(t, 1) : []
        }
        ,
        At.flattenDeep = function(t) {
            return t && t.length ? ln(t, q) : []
        }
        ,
        At.flattenDepth = function(t, n) {
            return t && t.length ? (n = n === T ? 1 : Ge(n),
            ln(t, n)) : [];
        }
        ,
        At.flip = function(t) {
            return Br(t, 512)
        }
        ,
        At.flow = Fi,
        At.flowRight = $i,
        At.fromPairs = function(t) {
            for (var n = -1, r = t ? t.length : 0, e = {}; ++n < r; ) {
                var u = t[n];
                e[u[0]] = u[1]
            }
            return e
        }
        ,
        At.functions = function(t) {
            return null == t ? [] : pn(t, nu(t))
        }
        ,
        At.functionsIn = function(t) {
            return null == t ? [] : pn(t, ru(t))
        }
        ,
        At.groupBy = Ko,
        At.initial = function(t) {
            return ce(t, 1)
        }
        ,
        At.intersection = Wo,
        At.intersectionBy = Bo,
        At.intersectionWith = Lo,
        At.invert = xi,
        At.invertBy = ji,
        At.invokeMap = Go,
        At.iteratee = au,
        At.keyBy = Jo,
        At.keys = nu,
        At.keysIn = ru,
        At.map = xe,
        At.mapKeys = function(t, n) {
            var r = {};
            return n = Ur(n, 3),
            sn(t, function(t, e, u) {
                r[n(t, e, u)] = t
            }),
            r
        }
        ,
        At.mapValues = function(t, n) {
            var r = {};
            return n = Ur(n, 3),
            sn(t, function(t, e, u) {
                r[e] = n(t, e, u)
            }),
            r
        }
        ,
        At.matches = function(t) {
            return In(nn(t, true))
        }
        ,
        At.matchesProperty = function(t, n) {
            return Sn(t, nn(n, true))
        }
        ,
        At.memoize = Ee,
        At.merge = mi,
        At.mergeWith = Ai,
        At.method = Ni,
        At.methodOf = Pi,
        At.mixin = lu,
        At.negate = function(t) {
            if (typeof t != "function")
                throw new du("Expected a function");
            return function() {
                return !t.apply(this, arguments)
            }
        }
        ,
        At.nthArg = function(t) {
            return t = Ge(t),
            Ie(function(n) {
                return Wn(n, t)
            })
        }
        ,
        At.omit = Oi,
        At.omitBy = function(t, n) {
            return n = Ur(n),
            Mn(t, function(t, r) {
                return !n(t, r)
            })
        }
        ,
        At.once = function(t) {
            return me(2, t)
        }
        ,
        At.orderBy = function(t, n, r, e) {
            return null == t ? [] : (ai(n) || (n = null == n ? [] : [n]),
            r = e ? T : r,
            ai(r) || (r = null == r ? [] : [r]),
            Bn(t, n, r))
        }
        ,
        At.over = Zi,
        At.overArgs = ei,
        At.overEvery = Ti,
        At.overSome = qi,
        At.partial = ui,
        At.partialRight = oi,
        At.partition = Yo,
        At.pick = ki,
        At.pickBy = function(t, n) {
            return null == t ? {} : Mn(t, Ur(n))
        }
        ,
        At.property = hu,
        At.propertyOf = function(t) {
            return function(n) {
                return null == t ? T : _n(t, n)
            }
        }
        ,
        At.pull = Mo,
        At.pullAll = se,
        At.pullAllBy = function(t, n, r) {
            return t && t.length && n && n.length ? Un(t, n, Ur(r)) : t
        }
        ,
        At.pullAllWith = function(t, n, r) {
            return t && t.length && n && n.length ? Un(t, n, T, r) : t
        }
        ,
        At.pullAt = Co,
        At.range = Vi,
        At.rangeRight = Ki,
        At.rearg = ii,
        At.reject = function(t, n) {
            var r = ai(t) ? f : an;
            return n = Ur(n, 3),
            r(t, function(t, r, e) {
                return !n(t, r, e)
            })
        }
        ,
        At.remove = function(t, n) {
            var r = [];
            if (!t || !t.length)
                return r;
            var e = -1
              , u = []
              , o = t.length;
            for (n = Ur(n, 3); ++e < o; ) {
                var i = t[e];
                n(i, e, t) && (r.push(i),
                u.push(e))
            }
            return Dn(t, u),
            r
        }
        ,
        At.rest = Ie,
        At.reverse = he,
        At.sampleSize = je,
        At.set = function(t, n, r) {
            return null == t ? t : Nn(t, n, r)
        }
        ,
        At.setWith = function(t, n, r, e) {
            return e = typeof e == "function" ? e : T,
            null == t ? t : Nn(t, n, r, e)
        }
        ,
        At.shuffle = function(t) {
            return je(t, 4294967295)
        }
        ,
        At.slice = function(t, n, r) {
            var e = t ? t.length : 0;
            return e ? (r && typeof r != "number" && Hr(t, n, r) ? (n = 0,
            r = e) : (n = null == n ? 0 : Ge(n),
            r = r === T ? e : Ge(r)),
            Pn(t, n, r)) : []
        }
        ,
        At.sortBy = Ho,
        At.sortedUniq = function(t) {
            return t && t.length ? Vn(t) : []
        }
        ,
        At.sortedUniqBy = function(t, n) {
            return t && t.length ? Vn(t, Ur(n)) : []
        }
        ,
        At.split = function(t, n, r) {
            return r && typeof r != "number" && Hr(t, n, r) && (n = r = T),
            r = r === T ? 4294967295 : r >>> 0,
            r ? (t = Qe(t)) && (typeof n == "string" || null != n && !Pe(n)) && (n = Gn(n),
            "" == n && Wt.test(t)) ? rr(t.match(St), 0, r) : Qu.call(t, n, r) : []
        }
        ,
        At.spread = function(t, n) {
            if (typeof t != "function")
                throw new du("Expected a function");
            return n = n === T ? 0 : Vu(Ge(n), 0),
            Ie(function(e) {
                var u = e[n];
                return e = rr(e, 0, n),
                u && s(e, u),
                r(t, this, e)
            })
        }
        ,
        At.tail = function(t) {
            return fe(t, 1)
        }
        ,
        At.take = function(t, n, r) {
            return t && t.length ? (n = r || n === T ? 1 : Ge(n),
            Pn(t, 0, 0 > n ? 0 : n)) : []
        }
        ,
        At.takeRight = function(t, n, r) {
            var e = t ? t.length : 0;
            return e ? (n = r || n === T ? 1 : Ge(n),
            n = e - n,
            Pn(t, 0 > n ? 0 : n, e)) : []
        }
        ,
        At.takeRightWhile = function(t, n) {
            return t && t.length ? Yn(t, Ur(n, 3), false, true) : []
        }
        ,
        At.takeWhile = function(t, n) {
            return t && t.length ? Yn(t, Ur(n, 3)) : []
        }
        ,
        At.tap = function(t, n) {
            return n(t),
            t
        }
        ,
        At.throttle = function(t, n, r) {
            var e = true
              , u = true;
            if (typeof t != "function")
                throw new du("Expected a function");
            return Ue(r) && (e = "leading"in r ? !!r.leading : e,
            u = "trailing"in r ? !!r.trailing : u),
            ke(t, n, {
                leading: e,
                maxWait: n,
                trailing: u
            })
        }
        ,
        At.thru = ge,
        At.toArray = Ve,
        At.toPairs = Ei,
        At.toPairsIn = Ii,
        At.toPath = function(t) {
            return ai(t) ? l(t, ue) : Te(t) ? [t] : cr(Eo(t))
        }
        ,
        At.toPlainObject = He,
        At.transform = function(t, n, r) {
            var e = ai(t) || qe(t);
            if (n = Ur(n, 4),
            null == r)
                if (e || Ue(t)) {
                    var o = t.constructor;
                    r = e ? ai(t) ? new o : [] : Me(o) ? en(Pu(Object(t))) : {}
                } else
                    r = {};
            return (e ? u : sn)(t, function(t, e, u) {
                return n(r, t, e, u)
            }),
            r
        }
        ,
        At.unary = function(t) {
            return we(t, 1)
        }
        ,
        At.union = zo,
        At.unionBy = Uo,
        At.unionWith = Do,
        At.uniq = function(t) {
            return t && t.length ? Jn(t) : []
        }
        ,
        At.uniqBy = function(t, n) {
            return t && t.length ? Jn(t, Ur(n)) : []
        }
        ,
        At.uniqWith = function(t, n) {
            return t && t.length ? Jn(t, T, n) : []
        }
        ,
        At.unset = function(t, n) {
            var r;
            if (null == t)
                r = true;
            else {
                r = t;
                var e = n
                  , e = Qr(e, r) ? [e] : nr(e);
                r = ee(r, e),
                e = ue(le(e)),
                r = !(null != r && dn(r, e)) || delete r[e]
            }
            return r
        }
        ,
        At.unzip = pe,
        At.unzipWith = _e,
        At.update = function(t, n, r) {
            return null == t ? t : Nn(t, n, (typeof r == "function" ? r : cu)(_n(t, n)), void 0)
        }
        ,
        At.updateWith = function(t, n, r, e) {
            return e = typeof e == "function" ? e : T,
            null != t && (t = Nn(t, n, (typeof r == "function" ? r : cu)(_n(t, n)), e)),
            t
        }
        ,
        At.values = eu,
        At.valuesIn = function(t) {
            return null == t ? [] : k(t, ru(t))
        }
        ,
        At.without = Fo,
        At.words = iu,
        At.wrap = function(t, n) {
            return n = null == n ? cu : n,
            ui(n, t)
        }
        ,
        At.xor = $o,
        At.xorBy = No,
        At.xorWith = Po,
        At.zip = Zo,
        At.zipObject = function(t, n) {
            return Xn(t || [], n || [], Kt)
        }
        ,
        At.zipObjectDeep = function(t, n) {
            return Xn(t || [], n || [], Nn)
        }
        ,
        At.zipWith = To,
        At.entries = Ei,
        At.entriesIn = Ii,
        At.extend = _i,
        At.extendWith = vi,
        lu(At, At),
        At.add = Gi,
        At.attempt = Ui,
        At.camelCase = Si,
        At.capitalize = uu,
        At.ceil = Ji,
        At.clamp = function(t, n, r) {
            return r === T && (r = n,
            n = T),
            r !== T && (r = Ye(r),
            r = r === r ? r : 0),
            n !== T && (n = Ye(n),
            n = n === n ? n : 0),
            tn(Ye(t), n, r)
        }
        ,
        At.clone = function(t) {
            return nn(t, false, true)
        }
        ,
        At.cloneDeep = function(t) {
            return nn(t, true, true)
        }
        ,
        At.cloneDeepWith = function(t, n) {
            return nn(t, true, true, n)
        }
        ,
        At.cloneWith = function(t, n) {
            return nn(t, false, true, n)
        }
        ,
        At.deburr = ou,
        At.divide = Yi,
        At.endsWith = function(t, n, r) {
            t = Qe(t),
            n = Gn(n);
            var e = t.length;
            return r = r === T ? e : tn(Ge(r), 0, e),
            r -= n.length,
            r >= 0 && t.indexOf(n, r) == r
        }
        ,
        At.eq = Se,
        At.escape = function(t) {
            return (t = Qe(t)) && X.test(t) ? t.replace(H, B) : t
        }
        ,
        At.escapeRegExp = function(t) {
            return (t = Qe(t)) && ft.test(t) ? t.replace(it, "\\$&") : t
        }
        ,
        At.every = function(t, n, r) {
            var e = ai(t) ? i : fn;
            return r && Hr(t, n, r) && (n = T),
            e(t, Ur(n, 3))
        }
        ,
        At.find = function(t, n) {
            if (n = Ur(n, 3),
            ai(t)) {
                var r = g(t, n);
                return r > -1 ? t[r] : T
            }
            return v(t, n, go)
        }
        ,
        At.findIndex = function(t, n) {
            return t && t.length ? g(t, Ur(n, 3)) : -1
        }
        ,
        At.findKey = function(t, n) {
            return v(t, Ur(n, 3), sn, true)
        }
        ,
        At.findLast = function(t, n) {
            if (n = Ur(n, 3),
            ai(t)) {
                var r = g(t, n, true);
                return r > -1 ? t[r] : T
            }
            return v(t, n, yo)
        }
        ,
        At.findLastIndex = function(t, n) {
            return t && t.length ? g(t, Ur(n, 3), true) : -1;
        }
        ,
        At.findLastKey = function(t, n) {
            return v(t, Ur(n, 3), hn, true)
        }
        ,
        At.floor = Hi,
        At.forEach = ye,
        At.forEachRight = be,
        At.forIn = function(t, n) {
            return null == t ? t : bo(t, Ur(n, 3), ru)
        }
        ,
        At.forInRight = function(t, n) {
            return null == t ? t : xo(t, Ur(n, 3), ru)
        }
        ,
        At.forOwn = function(t, n) {
            return t && sn(t, Ur(n, 3))
        }
        ,
        At.forOwnRight = function(t, n) {
            return t && hn(t, Ur(n, 3))
        }
        ,
        At.get = Xe,
        At.gt = fi,
        At.gte = ci,
        At.has = function(t, n) {
            return null != t && Zr(t, n, dn)
        }
        ,
        At.hasIn = tu,
        At.head = ae,
        At.identity = cu,
        At.includes = function(t, n, r, e) {
            return t = We(t) ? t : eu(t),
            r = r && !e ? Ge(r) : 0,
            e = t.length,
            0 > r && (r = Vu(e + r, 0)),
            Ze(t) ? e >= r && -1 < t.indexOf(n, r) : !!e && -1 < d(t, n, r)
        }
        ,
        At.indexOf = function(t, n, r) {
            var e = t ? t.length : 0;
            return e ? (r = Ge(r),
            0 > r && (r = Vu(e + r, 0)),
            d(t, n, r)) : -1
        }
        ,
        At.inRange = function(t, n, r) {
            return n = Ye(n) || 0,
            r === T ? (r = n,
            n = 0) : r = Ye(r) || 0,
            t = Ye(t),
            t >= Ku(n, r) && t < Vu(n, r)
        }
        ,
        At.invoke = wi,
        At.isArguments = Re,
        At.isArray = ai,
        At.isArrayBuffer = function(t) {
            return De(t) && "[object ArrayBuffer]" == Ou.call(t)
        }
        ,
        At.isArrayLike = We,
        At.isArrayLikeObject = Be,
        At.isBoolean = function(t) {
            return true === t || false === t || De(t) && "[object Boolean]" == Ou.call(t);
        }
        ,
        At.isBuffer = li,
        At.isDate = function(t) {
            return De(t) && "[object Date]" == Ou.call(t)
        }
        ,
        At.isElement = function(t) {
            return !!t && 1 === t.nodeType && De(t) && !Ne(t)
        }
        ,
        At.isEmpty = function(t) {
            if (We(t) && (ai(t) || Ze(t) || Me(t.splice) || Re(t) || li(t)))
                return !t.length;
            if (De(t)) {
                var n = Pr(t);
                if ("[object Map]" == n || "[object Set]" == n)
                    return !t.size
            }
            for (var r in t)
                if (wu.call(t, r))
                    return false;
            return !(io && nu(t).length)
        }
        ,
        At.isEqual = function(t, n) {
            return wn(t, n)
        }
        ,
        At.isEqualWith = function(t, n, r) {
            var e = (r = typeof r == "function" ? r : T) ? r(t, n) : T;
            return e === T ? wn(t, n, r) : !!e;
        }
        ,
        At.isError = Le,
        At.isFinite = function(t) {
            return typeof t == "number" && Zu(t)
        }
        ,
        At.isFunction = Me,
        At.isInteger = Ce,
        At.isLength = ze,
        At.isMap = function(t) {
            return De(t) && "[object Map]" == Pr(t)
        }
        ,
        At.isMatch = function(t, n) {
            return t === n || mn(t, n, Fr(n))
        }
        ,
        At.isMatchWith = function(t, n, r) {
            return r = typeof r == "function" ? r : T,
            mn(t, n, Fr(n), r)
        }
        ,
        At.isNaN = function(t) {
            return $e(t) && t != +t
        }
        ,
        At.isNative = Fe,
        At.isNil = function(t) {
            return null == t
        }
        ,
        At.isNull = function(t) {
            return null === t
        }
        ,
        At.isNumber = $e,
        At.isObject = Ue,
        At.isObjectLike = De,
        At.isPlainObject = Ne,
        At.isRegExp = Pe,
        At.isSafeInteger = function(t) {
            return Ce(t) && t >= -9007199254740991 && 9007199254740991 >= t
        }
        ,
        At.isSet = function(t) {
            return De(t) && "[object Set]" == Pr(t)
        }
        ,
        At.isString = Ze,
        At.isSymbol = Te,
        At.isTypedArray = qe,
        At.isUndefined = function(t) {
            return t === T
        }
        ,
        At.isWeakMap = function(t) {
            return De(t) && "[object WeakMap]" == Pr(t)
        }
        ,
        At.isWeakSet = function(t) {
            return De(t) && "[object WeakSet]" == Ou.call(t)
        }
        ,
        At.join = function(t, n) {
            return t ? Tu.call(t, n) : ""
        }
        ,
        At.kebabCase = Ri,
        At.last = le,
        At.lastIndexOf = function(t, n, r) {
            var e = t ? t.length : 0;
            if (!e)
                return -1;
            var u = e;
            if (r !== T && (u = Ge(r),
            u = (0 > u ? Vu(e + u, 0) : Ku(u, e - 1)) + 1),
            n !== n)
                return M(t, u, true);
            for (; u--; )
                if (t[u] === n)
                    return u;
            return -1
        }
        ,
        At.lowerCase = Wi,
        At.lowerFirst = Bi,
        At.lt = si,
        At.lte = hi,
        At.max = function(t) {
            return t && t.length ? cn(t, cu, gn) : T
        }
        ,
        At.maxBy = function(t, n) {
            return t && t.length ? cn(t, Ur(n), gn) : T
        }
        ,
        At.mean = function(t) {
            return b(t, cu)
        }
        ,
        At.meanBy = function(t, n) {
            return b(t, Ur(n))
        }
        ,
        At.min = function(t) {
            return t && t.length ? cn(t, cu, kn) : T
        }
        ,
        At.minBy = function(t, n) {
            return t && t.length ? cn(t, Ur(n), kn) : T
        }
        ,
        At.multiply = Qi,
        At.nth = function(t, n) {
            return t && t.length ? Wn(t, Ge(n)) : T
        }
        ,
        At.noConflict = function() {
            return Jt._ === this && (Jt._ = ku),
            this
        }
        ,
        At.noop = su,
        At.now = Qo,
        At.pad = function(t, n, r) {
            t = Qe(t);
            var e = (n = Ge(n)) ? N(t) : 0;
            return !n || e >= n ? t : (n = (n - e) / 2,
            Or(Nu(n), r) + t + Or($u(n), r))
        }
        ,
        At.padEnd = function(t, n, r) {
            t = Qe(t);
            var e = (n = Ge(n)) ? N(t) : 0;
            return n && n > e ? t + Or(n - e, r) : t
        }
        ,
        At.padStart = function(t, n, r) {
            t = Qe(t);
            var e = (n = Ge(n)) ? N(t) : 0;
            return n && n > e ? Or(n - e, r) + t : t
        }
        ,
        At.parseInt = function(t, n, r) {
            return r || null == n ? n = 0 : n && (n = +n),
            t = Qe(t).replace(ct, ""),
            Gu(t, n || (vt.test(t) ? 16 : 10))
        }
        ,
        At.random = function(t, n, r) {
            if (r && typeof r != "boolean" && Hr(t, n, r) && (n = r = T),
            r === T && (typeof n == "boolean" ? (r = n,
            n = T) : typeof t == "boolean" && (r = t,
            t = T)),
            t === T && n === T ? (t = 0,
            n = 1) : (t = Ye(t) || 0,
            n === T ? (n = t,
            t = 0) : n = Ye(n) || 0),
            t > n) {
                var e = t;
                t = n,
                n = e
            }
            return r || t % 1 || n % 1 ? (r = Ju(),
            Ku(t + r * (n - t + Nt("1e-" + ((r + "").length - 1))), n)) : Fn(t, n)
        }
        ,
        At.reduce = function(t, n, r) {
            var e = ai(t) ? h : x
              , u = 3 > arguments.length;
            return e(t, Ur(n, 4), r, u, go)
        }
        ,
        At.reduceRight = function(t, n, r) {
            var e = ai(t) ? p : x
              , u = 3 > arguments.length;
            return e(t, Ur(n, 4), r, u, yo);
        }
        ,
        At.repeat = function(t, n, r) {
            return n = (r ? Hr(t, n, r) : n === T) ? 1 : Ge(n),
            $n(Qe(t), n)
        }
        ,
        At.replace = function() {
            var t = arguments
              , n = Qe(t[0]);
            return 3 > t.length ? n : Yu.call(n, t[1], t[2])
        }
        ,
        At.result = function(t, n, r) {
            n = Qr(n, t) ? [n] : nr(n);
            var e = -1
              , u = n.length;
            for (u || (t = T,
            u = 1); ++e < u; ) {
                var o = null == t ? T : t[ue(n[e])];
                o === T && (e = u,
                o = r),
                t = Me(o) ? o.call(t) : o
            }
            return t
        }
        ,
        At.round = Xi,
        At.runInContext = Z,
        At.sample = function(t) {
            t = We(t) ? t : eu(t);
            var n = t.length;
            return n > 0 ? t[Fn(0, n - 1)] : T
        }
        ,
        At.size = function(t) {
            if (null == t)
                return 0;
            if (We(t)) {
                var n = t.length;
                return n && Ze(t) ? N(t) : n
            }
            return De(t) && (n = Pr(t),
            "[object Map]" == n || "[object Set]" == n) ? t.size : nu(t).length
        }
        ,
        At.snakeCase = Li,
        At.some = function(t, n, r) {
            var e = ai(t) ? _ : Zn;
            return r && Hr(t, n, r) && (n = T),
            e(t, Ur(n, 3))
        }
        ,
        At.sortedIndex = function(t, n) {
            return Tn(t, n)
        }
        ,
        At.sortedIndexBy = function(t, n, r) {
            return qn(t, n, Ur(r))
        }
        ,
        At.sortedIndexOf = function(t, n) {
            var r = t ? t.length : 0;
            if (r) {
                var e = Tn(t, n);
                if (r > e && Se(t[e], n))
                    return e
            }
            return -1
        }
        ,
        At.sortedLastIndex = function(t, n) {
            return Tn(t, n, true)
        }
        ,
        At.sortedLastIndexBy = function(t, n, r) {
            return qn(t, n, Ur(r), true);
        }
        ,
        At.sortedLastIndexOf = function(t, n) {
            if (t && t.length) {
                var r = Tn(t, n, true) - 1;
                if (Se(t[r], n))
                    return r
            }
            return -1
        }
        ,
        At.startCase = Mi,
        At.startsWith = function(t, n, r) {
            return t = Qe(t),
            r = tn(Ge(r), 0, t.length),
            t.lastIndexOf(Gn(n), r) == r
        }
        ,
        At.subtract = tf,
        At.sum = function(t) {
            return t && t.length ? w(t, cu) : 0
        }
        ,
        At.sumBy = function(t, n) {
            return t && t.length ? w(t, Ur(n)) : 0
        }
        ,
        At.template = function(t, n, r) {
            var e = At.templateSettings;
            r && Hr(t, n, r) && (n = T),
            t = Qe(t),
            n = vi({}, n, e, Tt),
            r = vi({}, n.imports, e.imports, Tt);
            var u, o, i = nu(r), f = k(r, i), c = 0;
            r = n.interpolate || wt;
            var a = "__p+='";
            r = gu((n.escape || wt).source + "|" + r.source + "|" + (r === rt ? pt : wt).source + "|" + (n.evaluate || wt).source + "|$", "g");
            var l = "sourceURL"in n ? "//# sourceURL=" + n.sourceURL + "\n" : "";
            if (t.replace(r, function(n, r, e, i, f, l) {
                return e || (e = i),
                a += t.slice(c, l).replace(mt, L),
                r && (u = true,
                a += "'+__e(" + r + ")+'"),
                f && (o = true,
                a += "';" + f + ";\n__p+='"),
                e && (a += "'+((__t=(" + e + "))==null?'':__t)+'"),
                c = l + n.length,
                n
            }),
            a += "';",
            (n = n.variable) || (a = "with(obj){" + a + "}"),
            a = (o ? a.replace(K, "") : a).replace(G, "$1").replace(J, "$1;"),
            a = "function(" + (n || "obj") + "){" + (n ? "" : "obj||(obj={});") + "var __t,__p=''" + (u ? ",__e=_.escape" : "") + (o ? ",__j=Array.prototype.join;function print(){__p+=__j.call(arguments,'')}" : ";") + a + "return __p}",
            n = Ui(function() {
                return Function(i, l + "return " + a).apply(T, f)
            }),
            n.source = a,
            Le(n))
                throw n;
            return n
        }
        ,
        At.times = function(t, n) {
            if (t = Ge(t),
            1 > t || t > 9007199254740991)
                return [];
            var r = 4294967295
              , e = Ku(t, 4294967295);
            for (n = Ur(n),
            t -= 4294967295,
            e = m(e, n); ++r < t; )
                n(r);
            return e
        }
        ,
        At.toFinite = Ke,
        At.toInteger = Ge,
        At.toLength = Je,
        At.toLower = function(t) {
            return Qe(t).toLowerCase()
        }
        ,
        At.toNumber = Ye,
        At.toSafeInteger = function(t) {
            return tn(Ge(t), -9007199254740991, 9007199254740991)
        }
        ,
        At.toString = Qe,
        At.toUpper = function(t) {
            return Qe(t).toUpperCase();
        }
        ,
        At.trim = function(t, n, r) {
            return (t = Qe(t)) && (r || n === T) ? t.replace(ct, "") : t && (n = Gn(n)) ? (t = t.match(St),
            n = n.match(St),
            rr(t, I(t, n), S(t, n) + 1).join("")) : t
        }
        ,
        At.trimEnd = function(t, n, r) {
            return (t = Qe(t)) && (r || n === T) ? t.replace(lt, "") : t && (n = Gn(n)) ? (t = t.match(St),
            n = S(t, n.match(St)) + 1,
            rr(t, 0, n).join("")) : t
        }
        ,
        At.trimStart = function(t, n, r) {
            return (t = Qe(t)) && (r || n === T) ? t.replace(at, "") : t && (n = Gn(n)) ? (t = t.match(St),
            n = I(t, n.match(St)),
            rr(t, n).join("")) : t
        }
        ,
        At.truncate = function(t, n) {
            var r = 30
              , e = "...";
            if (Ue(n))
                var u = "separator"in n ? n.separator : u
                  , r = "length"in n ? Ge(n.length) : r
                  , e = "omission"in n ? Gn(n.omission) : e;
            t = Qe(t);
            var o = t.length;
            if (Wt.test(t))
                var i = t.match(St)
                  , o = i.length;
            if (r >= o)
                return t;
            if (o = r - N(e),
            1 > o)
                return e;
            if (r = i ? rr(i, 0, o).join("") : t.slice(0, o),
            u === T)
                return r + e;
            if (i && (o += r.length - o),
            Pe(u)) {
                if (t.slice(o).search(u)) {
                    var f = r;
                    for (u.global || (u = gu(u.source, Qe(_t.exec(u)) + "g")),
                    u.lastIndex = 0; i = u.exec(f); )
                        var c = i.index;
                    r = r.slice(0, c === T ? o : c)
                }
            } else
                t.indexOf(Gn(u), o) != o && (u = r.lastIndexOf(u),
                u > -1 && (r = r.slice(0, u)));
            return r + e
        }
        ,
        At.unescape = function(t) {
            return (t = Qe(t)) && Q.test(t) ? t.replace(Y, P) : t
        }
        ,
        At.uniqueId = function(t) {
            var n = ++mu;
            return Qe(t) + n
        }
        ,
        At.upperCase = Ci,
        At.upperFirst = zi,
        At.each = ye,
        At.eachRight = be,
        At.first = ae,
        lu(At, function() {
            var t = {};
            return sn(At, function(n, r) {
                wu.call(At.prototype, r) || (t[r] = n)
            }),
            t
        }(), {
            chain: false
        }),
        At.VERSION = "4.12.0",
        u("bind bindKey curry curryRight partial partialRight".split(" "), function(t) {
            At[t].placeholder = At
        }),
        u(["drop", "take"], function(t, n) {
            zt.prototype[t] = function(r) {
                var e = this.__filtered__;
                if (e && !n)
                    return new zt(this);
                r = r === T ? 1 : Vu(Ge(r), 0);
                var u = this.clone();
                return e ? u.__takeCount__ = Ku(r, u.__takeCount__) : u.__views__.push({
                    size: Ku(r, 4294967295),
                    type: t + (0 > u.__dir__ ? "Right" : "")
                }),
                u
            }
            ,
            zt.prototype[t + "Right"] = function(n) {
                return this.reverse()[t](n).reverse()
            }
        }),
        u(["filter", "map", "takeWhile"], function(t, n) {
            var r = n + 1
              , e = 1 == r || 3 == r;
            zt.prototype[t] = function(t) {
                var n = this.clone();
                return n.__iteratees__.push({
                    iteratee: Ur(t, 3),
                    type: r
                }),
                n.__filtered__ = n.__filtered__ || e,
                n
            }
        }),
        u(["head", "last"], function(t, n) {
            var r = "take" + (n ? "Right" : "");
            zt.prototype[t] = function() {
                return this[r](1).value()[0]
            }
        }),
        u(["initial", "tail"], function(t, n) {
            var r = "drop" + (n ? "" : "Right");
            zt.prototype[t] = function() {
                return this.__filtered__ ? new zt(this) : this[r](1)
            }
        }),
        zt.prototype.compact = function() {
            return this.filter(cu)
        }
        ,
        zt.prototype.find = function(t) {
            return this.filter(t).head()
        }
        ,
        zt.prototype.findLast = function(t) {
            return this.reverse().find(t)
        }
        ,
        zt.prototype.invokeMap = Ie(function(t, n) {
            return typeof t == "function" ? new zt(this) : this.map(function(r) {
                return jn(r, t, n)
            })
        }),
        zt.prototype.reject = function(t) {
            return t = Ur(t, 3),
            this.filter(function(n) {
                return !t(n)
            })
        }
        ,
        zt.prototype.slice = function(t, n) {
            t = Ge(t);
            var r = this;
            return r.__filtered__ && (t > 0 || 0 > n) ? new zt(r) : (0 > t ? r = r.takeRight(-t) : t && (r = r.drop(t)),
            n !== T && (n = Ge(n),
            r = 0 > n ? r.dropRight(-n) : r.take(n - t)),
            r)
        }
        ,
        zt.prototype.takeRightWhile = function(t) {
            return this.reverse().takeWhile(t).reverse()
        }
        ,
        zt.prototype.toArray = function() {
            return this.take(4294967295)
        }
        ,
        sn(zt.prototype, function(t, n) {
            var r = /^(?:filter|find|map|reject)|While$/.test(n)
              , e = /^(?:head|last)$/.test(n)
              , u = At[e ? "take" + ("last" == n ? "Right" : "") : n]
              , o = e || /^find/.test(n);
            u && (At.prototype[n] = function() {
                function n(t) {
                    return t = u.apply(At, s([t], f)),
                    e && h ? t[0] : t
                }
                var i = this.__wrapped__
                  , f = e ? [1] : arguments
                  , c = i instanceof zt
                  , a = f[0]
                  , l = c || ai(i);
                l && r && typeof a == "function" && 1 != a.length && (c = l = false);
                var h = this.__chain__
                  , p = !!this.__actions__.length
                  , a = o && !h
                  , c = c && !p;
                return !o && l ? (i = c ? i : new zt(this),
                i = t.apply(i, f),
                i.__actions__.push({
                    func: ge,
                    args: [n],
                    thisArg: T
                }),
                new kt(i,h)) : a && c ? t.apply(this, f) : (i = this.thru(n),
                a ? e ? i.value()[0] : i.value() : i)
            }
            )
        }),
        u("pop push shift sort splice unshift".split(" "), function(t) {
            var n = yu[t]
              , r = /^(?:push|sort|unshift)$/.test(t) ? "tap" : "thru"
              , e = /^(?:pop|shift)$/.test(t);
            At.prototype[t] = function() {
                var t = arguments;
                if (e && !this.__chain__) {
                    var u = this.value();
                    return n.apply(ai(u) ? u : [], t)
                }
                return this[r](function(r) {
                    return n.apply(ai(r) ? r : [], t)
                })
            }
        }),
        sn(zt.prototype, function(t, n) {
            var r = At[n];
            if (r) {
                var e = r.name + "";
                (fo[e] || (fo[e] = [])).push({
                    name: n,
                    func: r
                })
            }
        }),
        fo[jr(T, 2).name] = [{
            name: "wrapper",
            func: T
        }],
        zt.prototype.clone = function() {
            var t = new zt(this.__wrapped__);
            return t.__actions__ = cr(this.__actions__),
            t.__dir__ = this.__dir__,
            t.__filtered__ = this.__filtered__,
            t.__iteratees__ = cr(this.__iteratees__),
            t.__takeCount__ = this.__takeCount__,
            t.__views__ = cr(this.__views__),
            t
        }
        ,
        zt.prototype.reverse = function() {
            if (this.__filtered__) {
                var t = new zt(this);
                t.__dir__ = -1,
                t.__filtered__ = true
            } else
                t = this.clone(),
                t.__dir__ *= -1;
            return t
        }
        ,
        zt.prototype.value = function() {
            var t, n = this.__wrapped__.value(), r = this.__dir__, e = ai(n), u = 0 > r, o = e ? n.length : 0;
            t = o;
            for (var i = this.__views__, f = 0, c = -1, a = i.length; ++c < a; ) {
                var l = i[c]
                  , s = l.size;
                switch (l.type) {
                case "drop":
                    f += s;
                    break;
                case "dropRight":
                    t -= s;
                    break;
                case "take":
                    t = Ku(t, f + s);
                    break;
                case "takeRight":
                    f = Vu(f, t - s)
                }
            }
            if (t = {
                start: f,
                end: t
            },
            i = t.start,
            f = t.end,
            t = f - i,
            u = u ? f : i - 1,
            i = this.__iteratees__,
            f = i.length,
            c = 0,
            a = Ku(t, this.__takeCount__),
            !e || 200 > o || o == t && a == t)
                return Hn(n, this.__actions__);
            e = [];
            t: for (; t-- && a > c; ) {
                for (u += r,
                o = -1,
                l = n[u]; ++o < f; ) {
                    var h = i[o]
                      , s = h.type
                      , h = (0,
                    h.iteratee)(l);
                    if (2 == s)
                        l = h;
                    else if (!h) {
                        if (1 == s)
                            continue t;
                        break t
                    }
                }
                e[c++] = l
            }
            return e
        }
        ,
        At.prototype.at = qo,
        At.prototype.chain = function() {
            return ve(this)
        }
        ,
        At.prototype.commit = function() {
            return new kt(this.value(),this.__chain__)
        }
        ,
        At.prototype.next = function() {
            this.__values__ === T && (this.__values__ = Ve(this.value()));
            var t = this.__index__ >= this.__values__.length
              , n = t ? T : this.__values__[this.__index__++];
            return {
                done: t,
                value: n
            }
        }
        ,
        At.prototype.plant = function(t) {
            for (var n, r = this; r instanceof Ot; ) {
                var e = ie(r);
                e.__index__ = 0,
                e.__values__ = T,
                n ? u.__wrapped__ = e : n = e;
                var u = e
                  , r = r.__wrapped__
            }
            return u.__wrapped__ = t,
            n
        }
        ,
        At.prototype.reverse = function() {
            var t = this.__wrapped__;
            return t instanceof zt ? (this.__actions__.length && (t = new zt(this)),
            t = t.reverse(),
            t.__actions__.push({
                func: ge,
                args: [he],
                thisArg: T
            }),
            new kt(t,this.__chain__)) : this.thru(he)
        }
        ,
        At.prototype.toJSON = At.prototype.valueOf = At.prototype.value = function() {
            return Hn(this.__wrapped__, this.__actions__)
        }
        ,
        Cu && (At.prototype[Cu] = de),
        At
    }
    var T, q = 1 / 0, V = NaN, K = /\b__p\+='';/g, G = /\b(__p\+=)''\+/g, J = /(__e\(.*?\)|\b__t\))\+'';/g, Y = /&(?:amp|lt|gt|quot|#39|#96);/g, H = /[&<>"'`]/g, Q = RegExp(Y.source), X = RegExp(H.source), tt = /<%-([\s\S]+?)%>/g, nt = /<%([\s\S]+?)%>/g, rt = /<%=([\s\S]+?)%>/g, et = /\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/, ut = /^\w*$/, ot = /[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]/g, it = /[\\^$.*+?()[\]{}|]/g, ft = RegExp(it.source), ct = /^\s+|\s+$/g, at = /^\s+/, lt = /\s+$/, st = /[a-zA-Z0-9]+/g, ht = /\\(\\)?/g, pt = /\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g, _t = /\w*$/, vt = /^0x/i, gt = /^[-+]0x[0-9a-f]+$/i, dt = /^0b[01]+$/i, yt = /^\[object .+?Constructor\]$/, bt = /^0o[0-7]+$/i, xt = /^(?:0|[1-9]\d*)$/, jt = /[\xc0-\xd6\xd8-\xde\xdf-\xf6\xf8-\xff]/g, wt = /($^)/, mt = /['\n\r\u2028\u2029\\]/g, At = "[\\ufe0e\\ufe0f]?(?:[\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0]|\\ud83c[\\udffb-\\udfff])?(?:\\u200d(?:[^\\ud800-\\udfff]|(?:\\ud83c[\\udde6-\\uddff]){2}|[\\ud800-\\udbff][\\udc00-\\udfff])[\\ufe0e\\ufe0f]?(?:[\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0]|\\ud83c[\\udffb-\\udfff])?)*", Ot = "(?:[\\u2700-\\u27bf]|(?:\\ud83c[\\udde6-\\uddff]){2}|[\\ud800-\\udbff][\\udc00-\\udfff])" + At, kt = "(?:[^\\ud800-\\udfff][\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0]?|[\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0]|(?:\\ud83c[\\udde6-\\uddff]){2}|[\\ud800-\\udbff][\\udc00-\\udfff]|[\\ud800-\\udfff])", Et = RegExp("['\u2019]", "g"), It = RegExp("[\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0]", "g"), St = RegExp("\\ud83c[\\udffb-\\udfff](?=\\ud83c[\\udffb-\\udfff])|" + kt + At, "g"), Rt = RegExp(["[A-Z\\xc0-\\xd6\\xd8-\\xde]?[a-z\\xdf-\\xf6\\xf8-\\xff]+(?:['\u2019](?:d|ll|m|re|s|t|ve))?(?=[\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000]|[A-Z\\xc0-\\xd6\\xd8-\\xde]|$)|(?:[A-Z\\xc0-\\xd6\\xd8-\\xde]|[^\\ud800-\\udfff\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000\\d+\\u2700-\\u27bfa-z\\xdf-\\xf6\\xf8-\\xffA-Z\\xc0-\\xd6\\xd8-\\xde])+(?:['\u2019](?:D|LL|M|RE|S|T|VE))?(?=[\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000]|[A-Z\\xc0-\\xd6\\xd8-\\xde](?:[a-z\\xdf-\\xf6\\xf8-\\xff]|[^\\ud800-\\udfff\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000\\d+\\u2700-\\u27bfa-z\\xdf-\\xf6\\xf8-\\xffA-Z\\xc0-\\xd6\\xd8-\\xde])|$)|[A-Z\\xc0-\\xd6\\xd8-\\xde]?(?:[a-z\\xdf-\\xf6\\xf8-\\xff]|[^\\ud800-\\udfff\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000\\d+\\u2700-\\u27bfa-z\\xdf-\\xf6\\xf8-\\xffA-Z\\xc0-\\xd6\\xd8-\\xde])+(?:['\u2019](?:d|ll|m|re|s|t|ve))?|[A-Z\\xc0-\\xd6\\xd8-\\xde]+(?:['\u2019](?:D|LL|M|RE|S|T|VE))?|\\d+", Ot].join("|"), "g"), Wt = RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0\\ufe0e\\ufe0f]"), Bt = /[a-z][A-Z]|[A-Z]{2,}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/, Lt = "Array Buffer DataView Date Error Float32Array Float64Array Function Int8Array Int16Array Int32Array Map Math Object Promise Reflect RegExp Set String Symbol TypeError Uint8Array Uint8ClampedArray Uint16Array Uint32Array WeakMap _ clearTimeout isFinite parseInt setTimeout".split(" "), Mt = {};
    Mt["[object Float32Array]"] = Mt["[object Float64Array]"] = Mt["[object Int8Array]"] = Mt["[object Int16Array]"] = Mt["[object Int32Array]"] = Mt["[object Uint8Array]"] = Mt["[object Uint8ClampedArray]"] = Mt["[object Uint16Array]"] = Mt["[object Uint32Array]"] = true,
    Mt["[object Arguments]"] = Mt["[object Array]"] = Mt["[object ArrayBuffer]"] = Mt["[object Boolean]"] = Mt["[object DataView]"] = Mt["[object Date]"] = Mt["[object Error]"] = Mt["[object Function]"] = Mt["[object Map]"] = Mt["[object Number]"] = Mt["[object Object]"] = Mt["[object RegExp]"] = Mt["[object Set]"] = Mt["[object String]"] = Mt["[object WeakMap]"] = false;
    var Ct = {};
    Ct["[object Arguments]"] = Ct["[object Array]"] = Ct["[object ArrayBuffer]"] = Ct["[object DataView]"] = Ct["[object Boolean]"] = Ct["[object Date]"] = Ct["[object Float32Array]"] = Ct["[object Float64Array]"] = Ct["[object Int8Array]"] = Ct["[object Int16Array]"] = Ct["[object Int32Array]"] = Ct["[object Map]"] = Ct["[object Number]"] = Ct["[object Object]"] = Ct["[object RegExp]"] = Ct["[object Set]"] = Ct["[object String]"] = Ct["[object Symbol]"] = Ct["[object Uint8Array]"] = Ct["[object Uint8ClampedArray]"] = Ct["[object Uint16Array]"] = Ct["[object Uint32Array]"] = true,
    Ct["[object Error]"] = Ct["[object Function]"] = Ct["[object WeakMap]"] = false;
    var zt = {
        "\xc0": "A",
        "\xc1": "A",
        "\xc2": "A",
        "\xc3": "A",
        "\xc4": "A",
        "\xc5": "A",
        "\xe0": "a",
        "\xe1": "a",
        "\xe2": "a",
        "\xe3": "a",
        "\xe4": "a",
        "\xe5": "a",
        "\xc7": "C",
        "\xe7": "c",
        "\xd0": "D",
        "\xf0": "d",
        "\xc8": "E",
        "\xc9": "E",
        "\xca": "E",
        "\xcb": "E",
        "\xe8": "e",
        "\xe9": "e",
        "\xea": "e",
        "\xeb": "e",
        "\xcc": "I",
        "\xcd": "I",
        "\xce": "I",
        "\xcf": "I",
        "\xec": "i",
        "\xed": "i",
        "\xee": "i",
        "\xef": "i",
        "\xd1": "N",
        "\xf1": "n",
        "\xd2": "O",
        "\xd3": "O",
        "\xd4": "O",
        "\xd5": "O",
        "\xd6": "O",
        "\xd8": "O",
        "\xf2": "o",
        "\xf3": "o",
        "\xf4": "o",
        "\xf5": "o",
        "\xf6": "o",
        "\xf8": "o",
        "\xd9": "U",
        "\xda": "U",
        "\xdb": "U",
        "\xdc": "U",
        "\xf9": "u",
        "\xfa": "u",
        "\xfb": "u",
        "\xfc": "u",
        "\xdd": "Y",
        "\xfd": "y",
        "\xff": "y",
        "\xc6": "Ae",
        "\xe6": "ae",
        "\xde": "Th",
        "\xfe": "th",
        "\xdf": "ss"
    }
      , Ut = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
        "`": "&#96;"
    }
      , Dt = {
        "&amp;": "&",
        "&lt;": "<",
        "&gt;": ">",
        "&quot;": '"',
        "&#39;": "'",
        "&#96;": "`"
    }
      , Ft = {
        "function": true,
        object: true
    }
      , $t = {
        "\\": "\\",
        "'": "'",
        "\n": "n",
        "\r": "r",
        "\u2028": "u2028",
        "\u2029": "u2029"
    }
      , Nt = parseFloat
      , Pt = parseInt
      , Zt = Ft[typeof exports] && exports && !exports.nodeType ? exports : T
      , Tt = Ft[typeof module] && module && !module.nodeType ? module : T
      , qt = Tt && Tt.exports === Zt ? Zt : T
      , Vt = R(Ft[typeof self] && self)
      , Kt = R(Ft[typeof window] && window)
      , Gt = R(Ft[typeof this] && this)
      , Jt = R(Zt && Tt && typeof global == "object" && global) || Kt !== (Gt && Gt.window) && Kt || Vt || Gt || Function("return this")()
      , Yt = Z();
    (Kt || Vt || {})._ = Yt,
    typeof define == "function" && typeof define.amd == "object" && define.amd ? define(function() {
        return Yt
    }) : Zt && Tt ? (qt && ((Tt.exports = Yt)._ = Yt),
    Zt._ = Yt) : Jt._ = Yt
}
).call(this);

/* file: script/lib/opentip.js */

// Opentip v2.4.6
// Copyright (c) 2009-2012
// www.opentip.org
// MIT Licensed
var Opentip, firstAdapter, i, mouseMoved, mousePosition, mousePositionObservers, position, vendors, _i, _len, _ref, __slice = [].slice, __indexOf = [].indexOf || function(t) {
    for (var e = 0, i = this.length; i > e; e++)
        if (e in this && this[e] === t)
            return e;
    return -1
}
, __hasProp = {}.hasOwnProperty;
for (Opentip = function() {
    function t(e, i, o, s) {
        var n, r, a, h, p, d, l, u, c, g, f, m, v, b, w = this;
        if (this.id = ++t.lastId,
        this.debug("Creating Opentip."),
        t.tips.push(this),
        this.adapter = t.adapter,
        n = this.adapter.data(e, "opentips") || [],
        n.push(this),
        this.adapter.data(e, "opentips", n),
        this.triggerElement = this.adapter.wrap(e),
        this.triggerElement.length > 1)
            throw Error("You can't call Opentip on multiple elements.");
        if (1 > this.triggerElement.length)
            throw Error("Invalid element.");
        this.loaded = !1,
        this.loading = !1,
        this.visible = !1,
        this.waitingToShow = !1,
        this.waitingToHide = !1,
        this.currentPosition = {
            left: 0,
            top: 0
        },
        this.dimensions = {
            width: 100,
            height: 50
        },
        this.content = "",
        this.redraw = !0,
        this.currentObservers = {
            showing: !1,
            visible: !1,
            hiding: !1,
            hidden: !1
        },
        s = this.adapter.clone(s),
        typeof i == "object" ? (s = i,
        i = o = void 0) : typeof o == "object" && (s = o,
        o = void 0),
        o != null && (s.title = o),
        i != null && this.setContent(i),
        s["extends"] == null && (s["extends"] = s.style != null ? s.style : t.defaultStyle),
        h = [s],
        b = s;
        while (b["extends"]) {
            if (d = b["extends"],
            b = t.styles[d],
            b == null)
                throw Error("Invalid style: " + d);
            h.unshift(b),
            b["extends"] == null && d !== "standard" && (b["extends"] = "standard")
        }
        for (s = (f = this.adapter).extend.apply(f, [{}].concat(__slice.call(h))),
        s.hideTriggers = function() {
            var t, e, i, o;
            for (i = s.hideTriggers,
            o = [],
            t = 0,
            e = i.length; e > t; t++)
                r = i[t],
                o.push(r);
            return o
        }(),
        s.hideTrigger && s.hideTriggers.length === 0 && s.hideTriggers.push(s.hideTrigger),
        m = ["tipJoint", "targetJoint", "stem"],
        l = 0,
        c = m.length; c > l; l++)
            p = m[l],
            s[p] && typeof s[p] == "string" && (s[p] = new t.Joint(s[p]));
        for (!s.ajax || s.ajax !== !0 && s.ajax || (s.ajax = this.adapter.tagName(this.triggerElement) === "A" ? this.adapter.attr(this.triggerElement, "href") : !1),
        s.showOn === "click" && this.adapter.tagName(this.triggerElement) === "A" && this.adapter.observe(this.triggerElement, "click", function(t) {
            return t.preventDefault(),
            t.stopPropagation(),
            t.stopped = !0
        }),
        s.target && (s.fixed = !0),
        s.stem === !0 && (s.stem = new t.Joint(s.tipJoint)),
        s.target === !0 ? s.target = this.triggerElement : s.target && (s.target = this.adapter.wrap(s.target)),
        this.currentStem = s.stem,
        s.delay == null && (s.delay = s.showOn === "mouseover" ? .2 : 0),
        s.targetJoint == null && (s.targetJoint = new t.Joint(s.tipJoint).flip()),
        this.showTriggers = [],
        this.showTriggersWhenVisible = [],
        this.hideTriggers = [],
        s.showOn && s.showOn !== "creation" && this.showTriggers.push({
            element: this.triggerElement,
            event: s.showOn
        }),
        s.ajaxCache != null && (s.cache = s.ajaxCache,
        delete s.ajaxCache),
        this.options = s,
        this.bound = {},
        v = ["prepareToShow", "prepareToHide", "show", "hide", "reposition"],
        u = 0,
        g = v.length; g > u; u++)
            a = v[u],
            this.bound[a] = function(t) {
                return function() {
                    return w[t].apply(w, arguments)
                }
            }(a);
        this.adapter.domReady(function() {
            return w.activate(),
            w.options.showOn === "creation" ? w.prepareToShow() : void 0
        })
    }
    return t.prototype.STICKS_OUT_TOP = 1,
    t.prototype.STICKS_OUT_BOTTOM = 2,
    t.prototype.STICKS_OUT_LEFT = 1,
    t.prototype.STICKS_OUT_RIGHT = 2,
    t.prototype["class"] = {
        container: "opentip-container",
        opentip: "opentip",
        header: "ot-header",
        content: "ot-content",
        loadingIndicator: "ot-loading-indicator",
        close: "ot-close",
        goingToHide: "ot-going-to-hide",
        hidden: "ot-hidden",
        hiding: "ot-hiding",
        goingToShow: "ot-going-to-show",
        showing: "ot-showing",
        visible: "ot-visible",
        loading: "ot-loading",
        ajaxError: "ot-ajax-error",
        fixed: "ot-fixed",
        showEffectPrefix: "ot-show-effect-",
        hideEffectPrefix: "ot-hide-effect-",
        stylePrefix: "style-"
    },
    t.prototype._setup = function() {
        var t, e, i, o, s, n, r, a, h, p, d;
        for (this.debug("Setting up the tooltip."),
        this._buildContainer(),
        this.hideTriggers = [],
        h = this.options.hideTriggers,
        o = s = 0,
        r = h.length; r > s; o = ++s) {
            if (e = h[o],
            i = null,
            t = this.options.hideOn instanceof Array ? this.options.hideOn[o] : this.options.hideOn,
            typeof e == "string")
                switch (e) {
                case "trigger":
                    t = t || "mouseout",
                    i = this.triggerElement;
                    break;
                case "tip":
                    t = t || "mouseover",
                    i = this.container;
                    break;
                case "target":
                    t = t || "mouseover",
                    i = this.options.target;
                    break;
                case "closeButton":
                    break;
                default:
                    throw Error("Unknown hide trigger: " + e + ".")
                }
            else
                t = t || "mouseover",
                i = this.adapter.wrap(e);
            i && this.hideTriggers.push({
                element: i,
                event: t,
                original: e
            })
        }
        for (p = this.hideTriggers,
        d = [],
        n = 0,
        a = p.length; a > n; n++)
            e = p[n],
            d.push(this.showTriggersWhenVisible.push({
                element: e.element,
                event: "mouseover"
            }));
        return d
    }
    ,
    t.prototype._buildContainer = function() {
        return this.container = this.adapter.create('<div id="opentip-' + this.id + '" class="' + this["class"].container + " " + this["class"].hidden + " " + this["class"].stylePrefix + this.options.className + '"></div>'),
        this.adapter.css(this.container, {
            position: "absolute"
        }),
        this.options.ajax && this.adapter.addClass(this.container, this["class"].loading),
        this.options.fixed && this.adapter.addClass(this.container, this["class"].fixed),
        this.options.showEffect && this.adapter.addClass(this.container, "" + this["class"].showEffectPrefix + this.options.showEffect),
        this.options.hideEffect ? this.adapter.addClass(this.container, "" + this["class"].hideEffectPrefix + this.options.hideEffect) : void 0
    }
    ,
    t.prototype._buildElements = function() {
        var t, e;
        return this.tooltipElement = this.adapter.create('<div class="' + this["class"].opentip + '"><div class="' + this["class"].header + '"></div><div class="' + this["class"].content + '"></div></div>'),
        this.backgroundCanvas = this.adapter.wrap(document.createElement("canvas")),
        this.adapter.css(this.backgroundCanvas, {
            position: "absolute"
        }),
        typeof G_vmlCanvasManager != "undefined" && G_vmlCanvasManager !== null && G_vmlCanvasManager.initElement(this.adapter.unwrap(this.backgroundCanvas)),
        t = this.adapter.find(this.tooltipElement, "." + this["class"].header),
        this.options.title && (e = this.adapter.create("<h1></h1>"),
        this.adapter.update(e, this.options.title, this.options.escapeTitle),
        this.adapter.append(t, e)),
        this.options.ajax && !this.loaded && this.adapter.append(this.tooltipElement, this.adapter.create('<div class="' + this["class"].loadingIndicator + '"><span>↻</span></div>')),
        __indexOf.call(this.options.hideTriggers, "closeButton") >= 0 && (this.closeButtonElement = this.adapter.create('<a href="javascript:undefined;" class="' + this["class"].close + '"><span>Close</span></a>'),
        this.adapter.append(t, this.closeButtonElement)),
        this.adapter.append(this.container, this.backgroundCanvas),
        this.adapter.append(this.container, this.tooltipElement),
        this.adapter.append(document.body, this.container),
        this._newContent = !0,
        this.redraw = !0
    }
    ,
    t.prototype.setContent = function(t) {
        return this.content = t,
        this._newContent = !0,
        typeof this.content == "function" ? (this._contentFunction = this.content,
        this.content = "") : this._contentFunction = null,
        this.visible ? this._updateElementContent() : void 0
    }
    ,
    t.prototype._updateElementContent = function() {
        var t;
        return (this._newContent || !this.options.cache && this._contentFunction) && (t = this.adapter.find(this.container, "." + this["class"].content),
        t != null && (this._contentFunction && (this.debug("Executing content function."),
        this.content = this._contentFunction(this)),
        this.adapter.update(t, this.content, this.options.escapeContent)),
        this._newContent = !1),
        this._storeAndLockDimensions(),
        this.reposition()
    }
    ,
    t.prototype._storeAndLockDimensions = function() {
        var t;
        if (this.container)
            return t = this.dimensions,
            this.adapter.css(this.container, {
                width: "auto",
                left: "0px",
                top: "0px"
            }),
            this.dimensions = this.adapter.dimensions(this.container),
            this.dimensions.width += 1,
            this.adapter.css(this.container, {
                width: "" + this.dimensions.width + "px",
                top: "" + this.currentPosition.top + "px",
                left: "" + this.currentPosition.left + "px"
            }),
            this._dimensionsEqual(this.dimensions, t) ? void 0 : (this.redraw = !0,
            this._draw())
    }
    ,
    t.prototype.activate = function() {
        return this._setupObservers("hidden", "hiding")
    }
    ,
    t.prototype.deactivate = function() {
        return this.debug("Deactivating tooltip."),
        this.hide(),
        this._setupObservers("-showing", "-visible", "-hidden", "-hiding")
    }
    ,
    t.prototype._setupObservers = function() {
        var t, e, i, o, s, n, r, a, h, p, d, l, u, c, g, f, m = this;
        for (o = arguments.length >= 1 ? __slice.call(arguments, 0) : [],
        n = 0,
        p = o.length; p > n; n++)
            if (i = o[n],
            e = !1,
            i.charAt(0) === "-" && (e = !0,
            i = i.substr(1)),
            this.currentObservers[i] !== !e)
                switch (this.currentObservers[i] = !e,
                t = function() {
                    var t, i, o;
                    return t = arguments.length >= 1 ? __slice.call(arguments, 0) : [],
                    e ? (i = m.adapter).stopObserving.apply(i, t) : (o = m.adapter).observe.apply(o, t)
                }
                ,
                i) {
                case "showing":
                    for (c = this.hideTriggers,
                    r = 0,
                    d = c.length; d > r; r++)
                        s = c[r],
                        t(s.element, s.event, this.bound.prepareToHide);
                    t(document.onresize != null ? document : window, "resize", this.bound.reposition),
                    t(window, "scroll", this.bound.reposition);
                    break;
                case "visible":
                    for (g = this.showTriggersWhenVisible,
                    a = 0,
                    l = g.length; l > a; a++)
                        s = g[a],
                        t(s.element, s.event, this.bound.prepareToShow);
                    break;
                case "hiding":
                    for (f = this.showTriggers,
                    h = 0,
                    u = f.length; u > h; h++)
                        s = f[h],
                        t(s.element, s.event, this.bound.prepareToShow);
                    break;
                case "hidden":
                    break;
                default:
                    throw Error("Unknown state: " + i)
                }
        return null
    }
    ,
    t.prototype.prepareToShow = function() {
        return this._abortHiding(),
        this._abortShowing(),
        this.visible ? void 0 : (this.debug("Showing in " + this.options.delay + "s."),
        this.container == null && this._setup(),
        this.options.group && t._abortShowingGroup(this.options.group, this),
        this.preparingToShow = !0,
        this._setupObservers("-hidden", "-hiding", "showing"),
        this._followMousePosition(),
        this.options.fixed && !this.options.target && (this.initialMousePosition = mousePosition),
        this.reposition(),
        this._showTimeoutId = this.setTimeout(this.bound.show, this.options.delay || 0))
    }
    ,
    t.prototype.show = function() {
        var e = this;
        return this._abortHiding(),
        this.visible ? void 0 : (this._clearTimeouts(),
        this._triggerElementExists() ? (this.debug("Showing now."),
        this.container == null && this._setup(),
        this.options.group && t._hideGroup(this.options.group, this),
        this.visible = !0,
        this.preparingToShow = !1,
        this.tooltipElement == null && this._buildElements(),
        this._updateElementContent(),
        !this.options.ajax || this.loaded && this.options.cache || this._loadAjax(),
        this._searchAndActivateCloseButtons(),
        this._startEnsureTriggerElement(),
        this.adapter.css(this.container, {
            zIndex: t.lastZIndex++
        }),
        this._setupObservers("-hidden", "-hiding", "-showing", "-visible", "showing", "visible"),
        this.options.fixed && !this.options.target && (this.initialMousePosition = mousePosition),
        this.reposition(),
        this.adapter.removeClass(this.container, this["class"].hiding),
        this.adapter.removeClass(this.container, this["class"].hidden),
        this.adapter.addClass(this.container, this["class"].goingToShow),
        this.setCss3Style(this.container, {
            transitionDuration: "0s"
        }),
        this.defer(function() {
            var t;
            if (e.visible && !e.preparingToHide)
                return e.adapter.removeClass(e.container, e["class"].goingToShow),
                e.adapter.addClass(e.container, e["class"].showing),
                t = 0,
                e.options.showEffect && e.options.showEffectDuration && (t = e.options.showEffectDuration),
                e.setCss3Style(e.container, {
                    transitionDuration: "" + t + "s"
                }),
                e._visibilityStateTimeoutId = e.setTimeout(function() {
                    return e.adapter.removeClass(e.container, e["class"].showing),
                    e.adapter.addClass(e.container, e["class"].visible)
                }, t),
                e._activateFirstInput()
        }),
        this._draw()) : this.deactivate())
    }
    ,
    t.prototype._abortShowing = function() {
        return this.preparingToShow ? (this.debug("Aborting showing."),
        this._clearTimeouts(),
        this._stopFollowingMousePosition(),
        this.preparingToShow = !1,
        this._setupObservers("-showing", "-visible", "hiding", "hidden")) : void 0
    }
    ,
    t.prototype.prepareToHide = function() {
        return this._abortShowing(),
        this._abortHiding(),
        this.visible ? (this.debug("Hiding in " + this.options.hideDelay + "s"),
        this.preparingToHide = !0,
        this._setupObservers("-showing", "visible", "-hidden", "hiding"),
        this._hideTimeoutId = this.setTimeout(this.bound.hide, this.options.hideDelay)) : void 0
    }
    ,
    t.prototype.hide = function() {
        var t = this;
        return this._abortShowing(),
        this.visible && (this._clearTimeouts(),
        this.debug("Hiding!"),
        this.visible = !1,
        this.preparingToHide = !1,
        this._stopEnsureTriggerElement(),
        this._setupObservers("-showing", "-visible", "-hiding", "-hidden", "hiding", "hidden"),
        this.options.fixed || this._stopFollowingMousePosition(),
        this.container) ? (this.adapter.removeClass(this.container, this["class"].visible),
        this.adapter.removeClass(this.container, this["class"].showing),
        this.adapter.addClass(this.container, this["class"].goingToHide),
        this.setCss3Style(this.container, {
            transitionDuration: "0s"
        }),
        this.defer(function() {
            var e;
            return t.adapter.removeClass(t.container, t["class"].goingToHide),
            t.adapter.addClass(t.container, t["class"].hiding),
            e = 0,
            t.options.hideEffect && t.options.hideEffectDuration && (e = t.options.hideEffectDuration),
            t.setCss3Style(t.container, {
                transitionDuration: "" + e + "s"
            }),
            t._visibilityStateTimeoutId = t.setTimeout(function() {
                return t.adapter.removeClass(t.container, t["class"].hiding),
                t.adapter.addClass(t.container, t["class"].hidden),
                t.setCss3Style(t.container, {
                    transitionDuration: "0s"
                }),
                t.options.removeElementsOnHide ? (t.debug("Removing HTML elements."),
                t.adapter.remove(t.container),
                delete t.container,
                delete t.tooltipElement) : void 0
            }, e)
        })) : void 0
    }
    ,
    t.prototype._abortHiding = function() {
        return this.preparingToHide ? (this.debug("Aborting hiding."),
        this._clearTimeouts(),
        this.preparingToHide = !1,
        this._setupObservers("-hiding", "showing", "visible")) : void 0
    }
    ,
    t.prototype.reposition = function() {
        var t, e, i, o = this;
        return t = this.getPosition(),
        t == null || (e = this.options.stem,
        this.options.containInViewport && (i = this._ensureViewportContainment(t),
        t = i.position,
        e = i.stem),
        this._positionsEqual(t, this.currentPosition)) ? void 0 : (this.options.stem && !e.eql(this.currentStem) && (this.redraw = !0),
        this.currentPosition = t,
        this.currentStem = e,
        this._draw(),
        this.adapter.css(this.container, {
            left: "" + t.left + "px",
            top: "" + t.top + "px"
        }),
        this.defer(function() {
            var t, e;
            return t = o.adapter.unwrap(o.container),
            t.style.visibility = "hidden",
            e = t.offsetHeight,
            t.style.visibility = "visible"
        }))
    }
    ,
    t.prototype.getPosition = function(t, e, i) {
        var o, s, n, r, a, h, p, d, l;
        if (this.container)
            return t == null && (t = this.options.tipJoint),
            e == null && (e = this.options.targetJoint),
            r = {},
            this.options.target ? (p = this.adapter.offset(this.options.target),
            h = this.adapter.dimensions(this.options.target),
            r = p,
            e.right ? (d = this.adapter.unwrap(this.options.target),
            d.getBoundingClientRect != null ? r.left = d.getBoundingClientRect().right + ((l = window.pageXOffset) != null ? l : document.body.scrollLeft) : r.left += h.width) : e.center && (r.left += Math.round(h.width / 2)),
            e.bottom ? r.top += h.height : e.middle && (r.top += Math.round(h.height / 2)),
            this.options.borderWidth && (this.options.tipJoint.left && (r.left += this.options.borderWidth),
            this.options.tipJoint.right && (r.left -= this.options.borderWidth),
            this.options.tipJoint.top ? r.top += this.options.borderWidth : this.options.tipJoint.bottom && (r.top -= this.options.borderWidth))) : r = this.initialMousePosition ? {
                top: this.initialMousePosition.y,
                left: this.initialMousePosition.x
            } : {
                top: mousePosition.y,
                left: mousePosition.x
            },
            this.options.autoOffset && (a = this.options.stem ? this.options.stemLength : 0,
            n = a && this.options.fixed ? 2 : 10,
            o = t.middle && !this.options.fixed ? 15 : 0,
            s = t.center && !this.options.fixed ? 15 : 0,
            t.right ? r.left -= n + o : t.left && (r.left += n + o),
            t.bottom ? r.top -= n + s : t.top && (r.top += n + s),
            a && (i == null && (i = this.options.stem),
            i.right ? r.left -= a : i.left && (r.left += a),
            i.bottom ? r.top -= a : i.top && (r.top += a))),
            r.left += this.options.offset[0],
            r.top += this.options.offset[1],
            t.right ? r.left -= this.dimensions.width : t.center && (r.left -= Math.round(this.dimensions.width / 2)),
            t.bottom ? r.top -= this.dimensions.height : t.middle && (r.top -= Math.round(this.dimensions.height / 2)),
            r
    }
    ,
    t.prototype._ensureViewportContainment = function(e) {
        var i, o, s, n, r, a, h, p, d, l, u, c;
        if (h = this.options.stem,
        s = {
            position: e,
            stem: h
        },
        !this.visible || !e)
            return s;
        if (p = this._sticksOut(e),
        !p[0] && !p[1])
            return s;
        if (l = new t.Joint(this.options.tipJoint),
        this.options.targetJoint && (d = new t.Joint(this.options.targetJoint)),
        a = this.adapter.scrollOffset(),
        u = this.adapter.viewportDimensions(),
        c = [e.left - a[0], e.top - a[1]],
        i = !1,
        u.width >= this.dimensions.width && p[0])
            switch (i = !0,
            p[0]) {
            case this.STICKS_OUT_LEFT:
                l.setHorizontal("left"),
                this.options.targetJoint && d.setHorizontal("right");
                break;
            case this.STICKS_OUT_RIGHT:
                l.setHorizontal("right"),
                this.options.targetJoint && d.setHorizontal("left")
            }
        if (u.height >= this.dimensions.height && p[1])
            switch (i = !0,
            p[1]) {
            case this.STICKS_OUT_TOP:
                l.setVertical("top"),
                this.options.targetJoint && d.setVertical("bottom");
                break;
            case this.STICKS_OUT_BOTTOM:
                l.setVertical("bottom"),
                this.options.targetJoint && d.setVertical("top")
            }
        return i ? (this.options.stem && (h = l),
        e = this.getPosition(l, d, h),
        o = this._sticksOut(e),
        n = !1,
        r = !1,
        o[0] && o[0] !== p[0] && (n = !0,
        l.setHorizontal(this.options.tipJoint.horizontal),
        this.options.targetJoint && d.setHorizontal(this.options.targetJoint.horizontal)),
        o[1] && o[1] !== p[1] && (r = !0,
        l.setVertical(this.options.tipJoint.vertical),
        this.options.targetJoint && d.setVertical(this.options.targetJoint.vertical)),
        n && r ? s : ((n || r) && (this.options.stem && (h = l),
        e = this.getPosition(l, d, h)),
        {
            position: e,
            stem: h
        })) : s
    }
    ,
    t.prototype._sticksOut = function(t) {
        var e, i, o, s;
        return i = this.adapter.scrollOffset(),
        s = this.adapter.viewportDimensions(),
        e = [t.left - i[0], t.top - i[1]],
        o = [!1, !1],
        0 > e[0] ? o[0] = this.STICKS_OUT_LEFT : e[0] + this.dimensions.width > s.width && (o[0] = this.STICKS_OUT_RIGHT),
        0 > e[1] ? o[1] = this.STICKS_OUT_TOP : e[1] + this.dimensions.height > s.height && (o[1] = this.STICKS_OUT_BOTTOM),
        o
    }
    ,
    t.prototype._draw = function() {
        var e, i, o, s, n, r, a, h, p, d, l, u, c, g, f, m, v, b, w, _ = this;
        if (this.backgroundCanvas && this.redraw) {
            if (this.debug("Drawing background."),
            this.redraw = !1,
            this.currentStem) {
                for (v = ["top", "right", "bottom", "left"],
                f = 0,
                m = v.length; m > f; f++)
                    u = v[f],
                    this.adapter.removeClass(this.container, "stem-" + u);
                this.adapter.addClass(this.container, "stem-" + this.currentStem.horizontal),
                this.adapter.addClass(this.container, "stem-" + this.currentStem.vertical)
            }
            return r = [0, 0],
            a = [0, 0],
            __indexOf.call(this.options.hideTriggers, "closeButton") >= 0 && (n = new t.Joint(((b = this.currentStem) != null ? b + "" : void 0) === "top right" ? "top left" : "top right"),
            r = [this.options.closeButtonRadius + this.options.closeButtonOffset[0], this.options.closeButtonRadius + this.options.closeButtonOffset[1]],
            a = [this.options.closeButtonRadius - this.options.closeButtonOffset[0], this.options.closeButtonRadius - this.options.closeButtonOffset[1]]),
            o = this.adapter.clone(this.dimensions),
            s = [0, 0],
            this.options.borderWidth && (o.width += this.options.borderWidth * 2,
            o.height += this.options.borderWidth * 2,
            s[0] -= this.options.borderWidth,
            s[1] -= this.options.borderWidth),
            this.options.shadow && (o.width += this.options.shadowBlur * 2,
            o.width += Math.max(0, this.options.shadowOffset[0] - this.options.shadowBlur * 2),
            o.height += this.options.shadowBlur * 2,
            o.height += Math.max(0, this.options.shadowOffset[1] - this.options.shadowBlur * 2),
            s[0] -= Math.max(0, this.options.shadowBlur - this.options.shadowOffset[0]),
            s[1] -= Math.max(0, this.options.shadowBlur - this.options.shadowOffset[1])),
            i = {
                left: 0,
                right: 0,
                top: 0,
                bottom: 0
            },
            this.currentStem && (this.currentStem.left ? i.left = this.options.stemLength : this.currentStem.right && (i.right = this.options.stemLength),
            this.currentStem.top ? i.top = this.options.stemLength : this.currentStem.bottom && (i.bottom = this.options.stemLength)),
            n && (n.left ? i.left = Math.max(i.left, a[0]) : n.right && (i.right = Math.max(i.right, a[0])),
            n.top ? i.top = Math.max(i.top, a[1]) : n.bottom && (i.bottom = Math.max(i.bottom, a[1]))),
            o.width += i.left + i.right,
            o.height += i.top + i.bottom,
            s[0] -= i.left,
            s[1] -= i.top,
            this.currentStem && this.options.borderWidth && (w = this._getPathStemMeasures(this.options.stemBase, this.options.stemLength, this.options.borderWidth),
            g = w.stemLength,
            c = w.stemBase),
            e = this.adapter.unwrap(this.backgroundCanvas),
            e.width = o.width,
            e.height = o.height,
            this.adapter.css(this.backgroundCanvas, {
                width: "" + e.width + "px",
                height: "" + e.height + "px",
                left: "" + s[0] + "px",
                top: "" + s[1] + "px"
            }),
            h = e.getContext("2d"),
            h.setTransform(1, 0, 0, 1, 0, 0),
            h.clearRect(0, 0, e.width, e.height),
            h.beginPath(),
            h.fillStyle = this._getColor(h, this.dimensions, this.options.background, this.options.backgroundGradientHorizontal),
            h.lineJoin = "miter",
            h.miterLimit = 500,
            l = this.options.borderWidth / 2,
            this.options.borderWidth ? (h.strokeStyle = this.options.borderColor,
            h.lineWidth = this.options.borderWidth) : (g = this.options.stemLength,
            c = this.options.stemBase),
            c == null && (c = 0),
            d = function(t, e, i) {
                return i && h.moveTo(Math.max(c, _.options.borderRadius, r[0]) + 1 - l, -l),
                e ? (h.lineTo(t / 2 - c / 2, -l),
                h.lineTo(t / 2, -g - l),
                h.lineTo(t / 2 + c / 2, -l)) : void 0
            }
            ,
            p = function(t, e, i) {
                var o, s, n, a;
                return t ? (h.lineTo(-c + l, 0 - l),
                h.lineTo(g + l, -g - l),
                h.lineTo(l, c - l)) : e ? (a = _.options.closeButtonOffset,
                n = r[0],
                i % 2 !== 0 && (a = [a[1], a[0]],
                n = r[1]),
                o = Math.acos(a[1] / _.options.closeButtonRadius),
                s = Math.acos(a[0] / _.options.closeButtonRadius),
                h.lineTo(-n + l, -l),
                h.arc(l - a[0], -l + a[1], _.options.closeButtonRadius, -(Math.PI / 2 + o), s, !1)) : (h.lineTo(-_.options.borderRadius + l, -l),
                h.quadraticCurveTo(l, -l, l, _.options.borderRadius - l))
            }
            ,
            h.translate(-s[0], -s[1]),
            h.save(),
            function() {
                var e, i, o, s, r, a, l, u, c, g, f;
                for (f = [],
                i = c = 0,
                g = t.positions.length / 2; g >= 0 ? g > c : c > g; i = g >= 0 ? ++c : --c)
                    r = i * 2,
                    a = i === 0 || i === 3 ? 0 : _.dimensions.width,
                    l = 2 > i ? 0 : _.dimensions.height,
                    u = Math.PI / 2 * i,
                    o = i % 2 === 0 ? _.dimensions.width : _.dimensions.height,
                    s = new t.Joint(t.positions[r]),
                    e = new t.Joint(t.positions[r + 1]),
                    h.save(),
                    h.translate(a, l),
                    h.rotate(u),
                    d(o, s.eql(_.currentStem), i === 0),
                    h.translate(o, 0),
                    p(e.eql(_.currentStem), e.eql(n), i),
                    f.push(h.restore());
                return f
            }(),
            h.closePath(),
            h.save(),
            this.options.shadow && (h.shadowColor = this.options.shadowColor,
            h.shadowBlur = this.options.shadowBlur,
            h.shadowOffsetX = this.options.shadowOffset[0],
            h.shadowOffsetY = this.options.shadowOffset[1]),
            h.fill(),
            h.restore(),
            this.options.borderWidth && h.stroke(),
            h.restore(),
            n ? function() {
                var t, e, i, o, s;
                return i = e = _.options.closeButtonRadius * 2,
                n + "" == "top right" ? (s = [_.dimensions.width - _.options.closeButtonOffset[0], _.options.closeButtonOffset[1]],
                t = [s[0] + l, s[1] - l]) : (s = [_.options.closeButtonOffset[0], _.options.closeButtonOffset[1]],
                t = [s[0] - l, s[1] - l]),
                h.translate(t[0], t[1]),
                o = _.options.closeButtonCrossSize / 2,
                h.save(),
                h.beginPath(),
                h.strokeStyle = _.options.closeButtonCrossColor,
                h.lineWidth = _.options.closeButtonCrossLineWidth,
                h.lineCap = "round",
                h.moveTo(-o, -o),
                h.lineTo(o, o),
                h.stroke(),
                h.beginPath(),
                h.moveTo(o, -o),
                h.lineTo(-o, o),
                h.stroke(),
                h.restore(),
                _.adapter.css(_.closeButtonElement, {
                    left: "" + (s[0] - o - _.options.closeButtonLinkOverscan) + "px",
                    top: "" + (s[1] - o - _.options.closeButtonLinkOverscan) + "px",
                    width: "" + (_.options.closeButtonCrossSize + _.options.closeButtonLinkOverscan * 2) + "px",
                    height: "" + (_.options.closeButtonCrossSize + _.options.closeButtonLinkOverscan * 2) + "px"
                })
            }() : void 0
        }
    }
    ,
    t.prototype._getPathStemMeasures = function(t, e, i) {
        var o, s, n, r, a, h, p;
        if (r = i / 2,
        n = Math.atan(t / 2 / e),
        o = n * 2,
        a = r / Math.sin(o),
        s = 2 * a * Math.cos(n),
        p = r + e - s,
        0 > p)
            throw Error("Sorry but your stemLength / stemBase ratio is strange.");
        return h = Math.tan(n) * p * 2,
        {
            stemLength: p,
            stemBase: h
        }
    }
    ,
    t.prototype._getColor = function(t, e, i, o) {
        var s, n, r, a, h;
        if (o == null && (o = !1),
        typeof i == "string")
            return i;
        for (n = o ? t.createLinearGradient(0, 0, e.width, 0) : t.createLinearGradient(0, 0, 0, e.height),
        r = a = 0,
        h = i.length; h > a; r = ++a)
            s = i[r],
            n.addColorStop(s[0], s[1]);
        return n
    }
    ,
    t.prototype._searchAndActivateCloseButtons = function() {
        var t, e, i, o;
        for (o = this.adapter.findAll(this.container, "." + this["class"].close),
        e = 0,
        i = o.length; i > e; e++)
            t = o[e],
            this.hideTriggers.push({
                element: this.adapter.wrap(t),
                event: "click"
            });
        return this.currentObservers.showing && this._setupObservers("-showing", "showing"),
        this.currentObservers.visible ? this._setupObservers("-visible", "visible") : void 0
    }
    ,
    t.prototype._activateFirstInput = function() {
        var t;
        return t = this.adapter.unwrap(this.adapter.find(this.container, "input, textarea")),
        t != null ? typeof t.focus == "function" ? t.focus() : void 0 : void 0
    }
    ,
    t.prototype._followMousePosition = function() {
        return this.options.fixed ? void 0 : t._observeMousePosition(this.bound.reposition)
    }
    ,
    t.prototype._stopFollowingMousePosition = function() {
        return this.options.fixed ? void 0 : t._stopObservingMousePosition(this.bound.reposition)
    }
    ,
    t.prototype._clearShowTimeout = function() {
        return clearTimeout(this._showTimeoutId)
    }
    ,
    t.prototype._clearHideTimeout = function() {
        return clearTimeout(this._hideTimeoutId)
    }
    ,
    t.prototype._clearTimeouts = function() {
        return clearTimeout(this._visibilityStateTimeoutId),
        this._clearShowTimeout(),
        this._clearHideTimeout()
    }
    ,
    t.prototype._triggerElementExists = function() {
        var t;
        t = this.adapter.unwrap(this.triggerElement);
        while (t.parentNode) {
            if (t.parentNode.tagName === "BODY")
                return !0;
            t = t.parentNode
        }
        return !1
    }
    ,
    t.prototype._loadAjax = function() {
        var t = this;
        if (!this.loading)
            return this.loaded = !1,
            this.loading = !0,
            this.adapter.addClass(this.container, this["class"].loading),
            this.setContent(""),
            this.debug("Loading content from " + this.options.ajax),
            this.adapter.ajax({
                url: this.options.ajax,
                method: this.options.ajaxMethod,
                onSuccess: function(e) {
                    return t.debug("Loading successful."),
                    t.adapter.removeClass(t.container, t["class"].loading),
                    t.setContent(e)
                },
                onError: function(e) {
                    var i;
                    return i = t.options.ajaxErrorMessage,
                    t.debug(i, e),
                    t.setContent(i),
                    t.adapter.addClass(t.container, t["class"].ajaxError)
                },
                onComplete: function() {
                    return t.adapter.removeClass(t.container, t["class"].loading),
                    t.loading = !1,
                    t.loaded = !0,
                    t._searchAndActivateCloseButtons(),
                    t._activateFirstInput(),
                    t.reposition()
                }
            })
    }
    ,
    t.prototype._ensureTriggerElement = function() {
        return this._triggerElementExists() ? void 0 : (this.deactivate(),
        this._stopEnsureTriggerElement())
    }
    ,
    t.prototype._ensureTriggerElementInterval = 1e3,
    t.prototype._startEnsureTriggerElement = function() {
        var t = this;
        return this._ensureTriggerElementTimeoutId = setInterval(function() {
            return t._ensureTriggerElement()
        }, this._ensureTriggerElementInterval)
    }
    ,
    t.prototype._stopEnsureTriggerElement = function() {
        return clearInterval(this._ensureTriggerElementTimeoutId)
    }
    ,
    t
}(),
vendors = ["khtml", "ms", "o", "moz", "webkit"],
Opentip.prototype.setCss3Style = function(t, e) {
    var i, o, s, n, r;
    t = this.adapter.unwrap(t),
    r = [];
    for (i in e)
        __hasProp.call(e, i) && (o = e[i],
        t.style[i] != null ? r.push(t.style[i] = o) : r.push(function() {
            var e, r, a;
            for (a = [],
            e = 0,
            r = vendors.length; r > e; e++)
                s = vendors[e],
                n = "" + this.ucfirst(s) + this.ucfirst(i),
                t.style[n] != null ? a.push(t.style[n] = o) : a.push(void 0);
            return a
        }
        .call(this)));
    return r
}
,
Opentip.prototype.defer = function(t) {
    return setTimeout(t, 0)
}
,
Opentip.prototype.setTimeout = function(t, e) {
    return setTimeout(t, e ? e * 1e3 : 0)
}
,
Opentip.prototype.ucfirst = function(t) {
    return t == null ? "" : t.charAt(0).toUpperCase() + t.slice(1)
}
,
Opentip.prototype.dasherize = function(t) {
    return t.replace(/([A-Z])/g, function(t, e) {
        return "-" + e.toLowerCase()
    })
}
,
mousePositionObservers = [],
mousePosition = {
    x: 0,
    y: 0
},
mouseMoved = function(t) {
    var e, i, o, s;
    for (mousePosition = Opentip.adapter.mousePosition(t),
    s = [],
    i = 0,
    o = mousePositionObservers.length; o > i; i++)
        e = mousePositionObservers[i],
        s.push(e());
    return s
}
,
Opentip.followMousePosition = function() {
    return Opentip.adapter.observe(document.body, "mousemove", mouseMoved)
}
,
Opentip._observeMousePosition = function(t) {
    return mousePositionObservers.push(t)
}
,
Opentip._stopObservingMousePosition = function(t) {
    var e;
    return mousePositionObservers = function() {
        var i, o, s;
        for (s = [],
        i = 0,
        o = mousePositionObservers.length; o > i; i++)
            e = mousePositionObservers[i],
            e !== t && s.push(e);
        return s
    }()
}
,
Opentip.Joint = function() {
    function t(t) {
        t != null && (t instanceof Opentip.Joint && (t += ""),
        this.set(t))
    }
    return t.prototype.set = function(t) {
        return t = t.toLowerCase(),
        this.setHorizontal(t),
        this.setVertical(t),
        this
    }
    ,
    t.prototype.setHorizontal = function(t) {
        var e, i, o, s, n, r, a;
        for (i = ["left", "center", "right"],
        o = 0,
        n = i.length; n > o; o++)
            e = i[o],
            ~t.indexOf(e) && (this.horizontal = e.toLowerCase());
        for (this.horizontal == null && (this.horizontal = "center"),
        a = [],
        s = 0,
        r = i.length; r > s; s++)
            e = i[s],
            a.push(this[e] = this.horizontal === e ? e : void 0);
        return a
    }
    ,
    t.prototype.setVertical = function(t) {
        var e, i, o, s, n, r, a;
        for (i = ["top", "middle", "bottom"],
        o = 0,
        n = i.length; n > o; o++)
            e = i[o],
            ~t.indexOf(e) && (this.vertical = e.toLowerCase());
        for (this.vertical == null && (this.vertical = "middle"),
        a = [],
        s = 0,
        r = i.length; r > s; s++)
            e = i[s],
            a.push(this[e] = this.vertical === e ? e : void 0);
        return a
    }
    ,
    t.prototype.eql = function(t) {
        return t != null && this.horizontal === t.horizontal && this.vertical === t.vertical
    }
    ,
    t.prototype.flip = function() {
        var t, e;
        return e = Opentip.position[this.toString(!0)],
        t = (e + 4) % 8,
        this.set(Opentip.positions[t]),
        this
    }
    ,
    t.prototype.toString = function(t) {
        var e, i;
        return t == null && (t = !1),
        i = this.vertical === "middle" ? "" : this.vertical,
        e = this.horizontal === "center" ? "" : this.horizontal,
        i && e && (e = t ? Opentip.prototype.ucfirst(e) : " " + e),
        "" + i + e
    }
    ,
    t
}(),
Opentip.prototype._positionsEqual = function(t, e) {
    return t != null && e != null && t.left === e.left && t.top === e.top
}
,
Opentip.prototype._dimensionsEqual = function(t, e) {
    return t != null && e != null && t.width === e.width && t.height === e.height
}
,
Opentip.prototype.debug = function() {
    var t;
    return t = arguments.length >= 1 ? __slice.call(arguments, 0) : [],
    Opentip.debug && (typeof console != "undefined" && console !== null ? console.debug : void 0) != null ? (t.unshift("#" + this.id + " |"),
    console.debug.apply(console, t)) : void 0
}
,
Opentip.findElements = function() {
    var t, e, i, o, s, n, r, a, h, p;
    for (t = Opentip.adapter,
    h = t.findAll(document.body, "[data-ot]"),
    p = [],
    r = 0,
    a = h.length; a > r; r++) {
        i = h[r],
        n = {},
        e = t.data(i, "ot"),
        (e === "" || e === "true" || e === "yes") && (e = t.attr(i, "title"),
        t.attr(i, "title", "")),
        e = e || "";
        for (o in Opentip.styles.standard)
            s = t.data(i, "ot" + Opentip.prototype.ucfirst(o)),
            s != null && (s === "yes" || s === "true" || s === "on" ? s = !0 : (s === "no" || s === "false" || s === "off") && (s = !1),
            n[o] = s);
        p.push(new Opentip(i,e,n))
    }
    return p
}
,
Opentip.version = "2.4.6",
Opentip.debug = !1,
Opentip.lastId = 0,
Opentip.lastZIndex = 10000,
Opentip.tips = [],
Opentip._abortShowingGroup = function(t, e) {
    var i, o, s, n, r;
    for (n = Opentip.tips,
    r = [],
    o = 0,
    s = n.length; s > o; o++)
        i = n[o],
        i !== e && i.options.group === t ? r.push(i._abortShowing()) : r.push(void 0);
    return r
}
,
Opentip._hideGroup = function(t, e) {
    var i, o, s, n, r;
    for (n = Opentip.tips,
    r = [],
    o = 0,
    s = n.length; s > o; o++)
        i = n[o],
        i !== e && i.options.group === t ? r.push(i.hide()) : r.push(void 0);
    return r
}
,
Opentip.adapters = {},
Opentip.adapter = null,
firstAdapter = !0,
Opentip.addAdapter = function(t) {
    return Opentip.adapters[t.name] = t,
    firstAdapter ? (Opentip.adapter = t,
    t.domReady(Opentip.findElements),
    t.domReady(Opentip.followMousePosition),
    firstAdapter = !1) : void 0
}
,
Opentip.positions = ["top", "topRight", "right", "bottomRight", "bottom", "bottomLeft", "left", "topLeft"],
Opentip.position = {},
_ref = Opentip.positions,
i = _i = 0,
_len = _ref.length; _len > _i; i = ++_i)
    position = _ref[i],
    Opentip.position[position] = i;
Opentip.styles = {
    standard: {
        "extends": null,
        title: void 0,
        escapeTitle: !0,
        escapeContent: !1,
        className: "standard",
        stem: !0,
        delay: null,
        hideDelay: .1,
        fixed: !1,
        showOn: "mouseover",
        hideTrigger: "trigger",
        hideTriggers: [],
        hideOn: null,
        removeElementsOnHide: !1,
        offset: [0, 0],
        containInViewport: !0,
        autoOffset: !0,
        showEffect: "appear",
        hideEffect: "fade",
        showEffectDuration: .3,
        hideEffectDuration: .2,
        stemLength: 5,
        stemBase: 8,
        tipJoint: "top left",
        target: null,
        targetJoint: null,
        cache: !0,
        ajax: !1,
        ajaxMethod: "GET",
        ajaxErrorMessage: "There was a problem downloading the content.",
        group: null,
        style: null,
        background: "#fff18f",
        backgroundGradientHorizontal: !1,
        closeButtonOffset: [5, 5],
        closeButtonRadius: 7,
        closeButtonCrossSize: 4,
        closeButtonCrossColor: "#d2c35b",
        closeButtonCrossLineWidth: 1.5,
        closeButtonLinkOverscan: 6,
        borderRadius: 5,
        borderWidth: 1,
        borderColor: "#f2e37b",
        shadow: !0,
        shadowBlur: 10,
        shadowOffset: [3, 3],
        shadowColor: "rgba(0, 0, 0, 0.1)"
    },
    glass: {
        "extends": "standard",
        className: "glass",
        background: [[0, "rgba(252, 252, 252, 0.8)"], [.5, "rgba(255, 255, 255, 0.8)"], [.5, "rgba(250, 250, 250, 0.9)"], [1, "rgba(245, 245, 245, 0.9)"]],
        borderColor: "#eee",
        closeButtonCrossColor: "rgba(0, 0, 0, 0.2)",
        borderRadius: 15,
        closeButtonRadius: 10,
        closeButtonOffset: [8, 8]
    },
    dark: {
        "extends": "standard",
        className: "dark",
        borderRadius: 13,
        borderColor: "#444",
        closeButtonCrossColor: "rgba(240, 240, 240, 1)",
        shadowColor: "rgba(0, 0, 0, 0.3)",
        shadowOffset: [2, 2],
        background: [[0, "rgba(30, 30, 30, 0.7)"], [.5, "rgba(30, 30, 30, 0.8)"], [.5, "rgba(10, 10, 10, 0.8)"], [1, "rgba(10, 10, 10, 0.9)"]]
    },
    alert: {
        "extends": "standard",
        className: "alert",
        borderRadius: 1,
        borderColor: "#AE0D11",
        closeButtonCrossColor: "rgba(255, 255, 255, 1)",
        shadowColor: "rgba(0, 0, 0, 0.3)",
        shadowOffset: [2, 2],
        background: [[0, "rgba(203, 15, 19, 0.7)"], [.5, "rgba(203, 15, 19, 0.8)"], [.5, "rgba(189, 14, 18, 0.8)"], [1, "rgba(179, 14, 17, 0.9)"]]
    }
},
Opentip.defaultStyle = "standard",
typeof module != "undefined" && module !== null ? module.exports = Opentip : window.Opentip = Opentip;
var __slice = [].slice;
(function(t) {
    var e;
    return t.fn.opentip = function(t, e, i) {
        return new Opentip(this,t,e,i)
    }
    ,
    e = function() {
        function e() {}
        return e.prototype.name = "jquery",
        e.prototype.domReady = function(e) {
            return t(e)
        }
        ,
        e.prototype.create = function(e) {
            return t(e)
        }
        ,
        e.prototype.wrap = function(e) {
            if (e = t(e),
            e.length > 1)
                throw Error("Multiple elements provided.");
            return e
        }
        ,
        e.prototype.unwrap = function(e) {
            return t(e)[0]
        }
        ,
        e.prototype.tagName = function(t) {
            return this.unwrap(t).tagName
        }
        ,
        e.prototype.attr = function() {
            var e, i, o;
            return i = arguments[0],
            e = arguments.length >= 2 ? __slice.call(arguments, 1) : [],
            (o = t(i)).attr.apply(o, e)
        }
        ,
        e.prototype.data = function() {
            var e, i, o;
            return i = arguments[0],
            e = arguments.length >= 2 ? __slice.call(arguments, 1) : [],
            (o = t(i)).data.apply(o, e)
        }
        ,
        e.prototype.find = function(e, i) {
            return t(e).find(i).get(0)
        }
        ,
        e.prototype.findAll = function(e, i) {
            return t(e).find(i)
        }
        ,
        e.prototype.update = function(e, i, o) {
            return e = t(e),
            o ? e.text(i) : e.html(i)
        }
        ,
        e.prototype.append = function(e, i) {
            return t(e).append(i)
        }
        ,
        e.prototype.remove = function(e) {
            return t(e).remove()
        }
        ,
        e.prototype.addClass = function(e, i) {
            return t(e).addClass(i)
        }
        ,
        e.prototype.removeClass = function(e, i) {
            return t(e).removeClass(i)
        }
        ,
        e.prototype.css = function(e, i) {
            return t(e).css(i)
        }
        ,
        e.prototype.dimensions = function(e) {
            return {
                width: t(e).outerWidth(),
                height: t(e).outerHeight()
            }
        }
        ,
        e.prototype.scrollOffset = function() {
            return [window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft, window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop]
        }
        ,
        e.prototype.viewportDimensions = function() {
            return {
                width: document.documentElement.clientWidth,
                height: document.documentElement.clientHeight
            }
        }
        ,
        e.prototype.mousePosition = function(t) {
            return t == null ? null : {
                x: t.pageX,
                y: t.pageY
            }
        }
        ,
        e.prototype.offset = function(e) {
            var i;
            return i = t(e).offset(),
            {
                left: i.left,
                top: i.top
            }
        }
        ,
        e.prototype.observe = function(e, i, o) {
            return t(e).bind(i, o)
        }
        ,
        e.prototype.stopObserving = function(e, i, o) {
            return t(e).unbind(i, o)
        }
        ,
        e.prototype.ajax = function(e) {
            var i, o;
            if (e.url == null)
                throw Error("No url provided");
            return t.ajax({
                url: e.url,
                type: (i = (o = e.method) != null ? o.toUpperCase() : void 0) != null ? i : "GET"
            }).done(function(t) {
                return typeof e.onSuccess == "function" ? e.onSuccess(t) : void 0
            }).fail(function(t) {
                return typeof e.onError == "function" ? e.onError("Server responded with status " + t.status) : void 0
            }).always(function() {
                return typeof e.onComplete == "function" ? e.onComplete() : void 0
            })
        }
        ,
        e.prototype.clone = function(e) {
            return t.extend({}, e)
        }
        ,
        e.prototype.extend = function() {
            var e, i;
            return i = arguments[0],
            e = arguments.length >= 2 ? __slice.call(arguments, 1) : [],
            t.extend.apply(t, [i].concat(__slice.call(e)))
        }
        ,
        e
    }(),
    Opentip.addAdapter(new e)
}
)(jQuery)

/* file: script/lib/clipboard.js */

/*!
 * clipboard.js v1.6.0
 * https://zenorocha.github.io/clipboard.js
 *
 * Licensed MIT © Zeno Rocha
 */
!function(e) {
    if ("object" == typeof exports && "undefined" != typeof module)
        module.exports = e();
    else if ("function" == typeof define && define.amd)
        define([], e);
    else {
        var t;
        t = "undefined" != typeof window ? window : "undefined" != typeof global ? global : "undefined" != typeof self ? self : this,
        t.Clipboard = e()
    }
}(function() {
    var e, t, n;
    return function e(t, n, o) {
        function i(a, c) {
            if (!n[a]) {
                if (!t[a]) {
                    var l = "function" == typeof require && require;
                    if (!c && l)
                        return l(a, !0);
                    if (r)
                        return r(a, !0);
                    var u = new Error("Cannot find module '" + a + "'");
                    throw u.code = "MODULE_NOT_FOUND",
                    u
                }
                var s = n[a] = {
                    exports: {}
                };
                t[a][0].call(s.exports, function(e) {
                    var n = t[a][1][e];
                    return i(n ? n : e)
                }, s, s.exports, e, t, n, o)
            }
            return n[a].exports
        }
        for (var r = "function" == typeof require && require, a = 0; a < o.length; a++)
            i(o[a]);
        return i
    }({
        1: [function(e, t, n) {
            function o(e, t) {
                for (; e && e.nodeType !== i; ) {
                    if (e.matches(t))
                        return e;
                    e = e.parentNode
                }
            }
            var i = 9;
            if (Element && !Element.prototype.matches) {
                var r = Element.prototype;
                r.matches = r.matchesSelector || r.mozMatchesSelector || r.msMatchesSelector || r.oMatchesSelector || r.webkitMatchesSelector
            }
            t.exports = o
        }
        , {}],
        2: [function(e, t, n) {
            function o(e, t, n, o, r) {
                var a = i.apply(this, arguments);
                return e.addEventListener(n, a, r),
                {
                    destroy: function() {
                        e.removeEventListener(n, a, r)
                    }
                }
            }
            function i(e, t, n, o) {
                return function(n) {
                    n.delegateTarget = r(n.target, t),
                    n.delegateTarget && o.call(e, n)
                }
            }
            var r = e("./closest");
            t.exports = o
        }
        , {
            "./closest": 1
        }],
        3: [function(e, t, n) {
            n.node = function(e) {
                return void 0 !== e && e instanceof HTMLElement && 1 === e.nodeType
            }
            ,
            n.nodeList = function(e) {
                var t = Object.prototype.toString.call(e);
                return void 0 !== e && ("[object NodeList]" === t || "[object HTMLCollection]" === t) && "length"in e && (0 === e.length || n.node(e[0]))
            }
            ,
            n.string = function(e) {
                return "string" == typeof e || e instanceof String
            }
            ,
            n.fn = function(e) {
                var t = Object.prototype.toString.call(e);
                return "[object Function]" === t
            }
        }
        , {}],
        4: [function(e, t, n) {
            function o(e, t, n) {
                if (!e && !t && !n)
                    throw new Error("Missing required arguments");
                if (!c.string(t))
                    throw new TypeError("Second argument must be a String");
                if (!c.fn(n))
                    throw new TypeError("Third argument must be a Function");
                if (c.node(e))
                    return i(e, t, n);
                if (c.nodeList(e))
                    return r(e, t, n);
                if (c.string(e))
                    return a(e, t, n);
                throw new TypeError("First argument must be a String, HTMLElement, HTMLCollection, or NodeList")
            }
            function i(e, t, n) {
                return e.addEventListener(t, n),
                {
                    destroy: function() {
                        e.removeEventListener(t, n)
                    }
                }
            }
            function r(e, t, n) {
                return Array.prototype.forEach.call(e, function(e) {
                    e.addEventListener(t, n)
                }),
                {
                    destroy: function() {
                        Array.prototype.forEach.call(e, function(e) {
                            e.removeEventListener(t, n)
                        })
                    }
                }
            }
            function a(e, t, n) {
                return l(document.body, e, t, n)
            }
            var c = e("./is")
              , l = e("delegate");
            t.exports = o
        }
        , {
            "./is": 3,
            delegate: 2
        }],
        5: [function(e, t, n) {
            function o(e) {
                var t;
                if ("SELECT" === e.nodeName)
                    e.focus(),
                    t = e.value;
                else if ("INPUT" === e.nodeName || "TEXTAREA" === e.nodeName) {
                    var n = e.hasAttribute("readonly");
                    n || e.setAttribute("readonly", ""),
                    e.select(),
                    e.setSelectionRange(0, e.value.length),
                    n || e.removeAttribute("readonly"),
                    t = e.value
                } else {
                    e.hasAttribute("contenteditable") && e.focus();
                    var o = window.getSelection()
                      , i = document.createRange();
                    i.selectNodeContents(e),
                    o.removeAllRanges(),
                    o.addRange(i),
                    t = o.toString()
                }
                return t
            }
            t.exports = o
        }
        , {}],
        6: [function(e, t, n) {
            function o() {}
            o.prototype = {
                on: function(e, t, n) {
                    var o = this.e || (this.e = {});
                    return (o[e] || (o[e] = [])).push({
                        fn: t,
                        ctx: n
                    }),
                    this
                },
                once: function(e, t, n) {
                    function o() {
                        i.off(e, o),
                        t.apply(n, arguments)
                    }
                    var i = this;
                    return o._ = t,
                    this.on(e, o, n)
                },
                emit: function(e) {
                    var t = [].slice.call(arguments, 1)
                      , n = ((this.e || (this.e = {}))[e] || []).slice()
                      , o = 0
                      , i = n.length;
                    for (o; o < i; o++)
                        n[o].fn.apply(n[o].ctx, t);
                    return this
                },
                off: function(e, t) {
                    var n = this.e || (this.e = {})
                      , o = n[e]
                      , i = [];
                    if (o && t)
                        for (var r = 0, a = o.length; r < a; r++)
                            o[r].fn !== t && o[r].fn._ !== t && i.push(o[r]);
                    return i.length ? n[e] = i : delete n[e],
                    this
                }
            },
            t.exports = o
        }
        , {}],
        7: [function(t, n, o) {
            !function(i, r) {
                if ("function" == typeof e && e.amd)
                    e(["module", "select"], r);
                else if ("undefined" != typeof o)
                    r(n, t("select"));
                else {
                    var a = {
                        exports: {}
                    };
                    r(a, i.select),
                    i.clipboardAction = a.exports
                }
            }(this, function(e, t) {
                "use strict";
                function n(e) {
                    return e && e.__esModule ? e : {
                        default: e
                    }
                }
                function o(e, t) {
                    if (!(e instanceof t))
                        throw new TypeError("Cannot call a class as a function")
                }
                var i = n(t)
                  , r = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function(e) {
                    return typeof e
                }
                : function(e) {
                    return e && "function" == typeof Symbol && e.constructor === Symbol && e !== Symbol.prototype ? "symbol" : typeof e
                }
                  , a = function() {
                    function e(e, t) {
                        for (var n = 0; n < t.length; n++) {
                            var o = t[n];
                            o.enumerable = o.enumerable || !1,
                            o.configurable = !0,
                            "value"in o && (o.writable = !0),
                            Object.defineProperty(e, o.key, o)
                        }
                    }
                    return function(t, n, o) {
                        return n && e(t.prototype, n),
                        o && e(t, o),
                        t
                    }
                }()
                  , c = function() {
                    function e(t) {
                        o(this, e),
                        this.resolveOptions(t),
                        this.initSelection()
                    }
                    return a(e, [{
                        key: "resolveOptions",
                        value: function e() {
                            var t = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : {};
                            this.action = t.action,
                            this.emitter = t.emitter,
                            this.target = t.target,
                            this.text = t.text,
                            this.trigger = t.trigger,
                            this.selectedText = ""
                        }
                    }, {
                        key: "initSelection",
                        value: function e() {
                            this.text ? this.selectFake() : this.target && this.selectTarget()
                        }
                    }, {
                        key: "selectFake",
                        value: function e() {
                            var t = this
                              , n = "rtl" == document.documentElement.getAttribute("dir");
                            this.removeFake(),
                            this.fakeHandlerCallback = function() {
                                return t.removeFake()
                            }
                            ,
                            this.fakeHandler = document.body.addEventListener("click", this.fakeHandlerCallback) || !0,
                            this.fakeElem = document.createElement("textarea"),
                            this.fakeElem.style.fontSize = "12pt",
                            this.fakeElem.style.border = "0",
                            this.fakeElem.style.padding = "0",
                            this.fakeElem.style.margin = "0",
                            this.fakeElem.style.position = "absolute",
                            this.fakeElem.style[n ? "right" : "left"] = "-9999px";
                            var o = window.pageYOffset || document.documentElement.scrollTop;
                            this.fakeElem.style.top = o + "px",
                            this.fakeElem.setAttribute("readonly", ""),
                            this.fakeElem.value = this.text,
                            document.body.appendChild(this.fakeElem),
                            this.selectedText = (0,
                            i.default)(this.fakeElem),
                            this.copyText()
                        }
                    }, {
                        key: "removeFake",
                        value: function e() {
                            this.fakeHandler && (document.body.removeEventListener("click", this.fakeHandlerCallback),
                            this.fakeHandler = null,
                            this.fakeHandlerCallback = null),
                            this.fakeElem && (document.body.removeChild(this.fakeElem),
                            this.fakeElem = null)
                        }
                    }, {
                        key: "selectTarget",
                        value: function e() {
                            this.selectedText = (0,
                            i.default)(this.target),
                            this.copyText()
                        }
                    }, {
                        key: "copyText",
                        value: function e() {
                            var t = void 0;
                            try {
                                t = document.execCommand(this.action)
                            } catch (e) {
                                t = !1
                            }
                            this.handleResult(t)
                        }
                    }, {
                        key: "handleResult",
                        value: function e(t) {
                            this.emitter.emit(t ? "success" : "error", {
                                action: this.action,
                                text: this.selectedText,
                                trigger: this.trigger,
                                clearSelection: this.clearSelection.bind(this)
                            })
                        }
                    }, {
                        key: "clearSelection",
                        value: function e() {
                            this.target && this.target.blur(),
                            window.getSelection().removeAllRanges()
                        }
                    }, {
                        key: "destroy",
                        value: function e() {
                            this.removeFake()
                        }
                    }, {
                        key: "action",
                        set: function e() {
                            var t = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : "copy";
                            if (this._action = t,
                            "copy" !== this._action && "cut" !== this._action)
                                throw new Error('Invalid "action" value, use either "copy" or "cut"')
                        },
                        get: function e() {
                            return this._action
                        }
                    }, {
                        key: "target",
                        set: function e(t) {
                            if (void 0 !== t) {
                                if (!t || "object" !== ("undefined" == typeof t ? "undefined" : r(t)) || 1 !== t.nodeType)
                                    throw new Error('Invalid "target" value, use a valid Element');
                                if ("copy" === this.action && t.hasAttribute("disabled"))
                                    throw new Error('Invalid "target" attribute. Please use "readonly" instead of "disabled" attribute');
                                if ("cut" === this.action && (t.hasAttribute("readonly") || t.hasAttribute("disabled")))
                                    throw new Error('Invalid "target" attribute. You can\'t cut text from elements with "readonly" or "disabled" attributes');
                                this._target = t
                            }
                        },
                        get: function e() {
                            return this._target
                        }
                    }]),
                    e
                }();
                e.exports = c
            })
        }
        , {
            select: 5
        }],
        8: [function(t, n, o) {
            !function(i, r) {
                if ("function" == typeof e && e.amd)
                    e(["module", "./clipboard-action", "tiny-emitter", "good-listener"], r);
                else if ("undefined" != typeof o)
                    r(n, t("./clipboard-action"), t("tiny-emitter"), t("good-listener"));
                else {
                    var a = {
                        exports: {}
                    };
                    r(a, i.clipboardAction, i.tinyEmitter, i.goodListener),
                    i.clipboard = a.exports
                }
            }(this, function(e, t, n, o) {
                "use strict";
                function i(e) {
                    return e && e.__esModule ? e : {
                        default: e
                    }
                }
                function r(e, t) {
                    if (!(e instanceof t))
                        throw new TypeError("Cannot call a class as a function")
                }
                function a(e, t) {
                    if (!e)
                        throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
                    return !t || "object" != typeof t && "function" != typeof t ? e : t
                }
                function c(e, t) {
                    if ("function" != typeof t && null !== t)
                        throw new TypeError("Super expression must either be null or a function, not " + typeof t);
                    e.prototype = Object.create(t && t.prototype, {
                        constructor: {
                            value: e,
                            enumerable: !1,
                            writable: !0,
                            configurable: !0
                        }
                    }),
                    t && (Object.setPrototypeOf ? Object.setPrototypeOf(e, t) : e.__proto__ = t)
                }
                function l(e, t) {
                    var n = "data-clipboard-" + e;
                    if (t.hasAttribute(n))
                        return t.getAttribute(n)
                }
                var u = i(t)
                  , s = i(n)
                  , f = i(o)
                  , d = function() {
                    function e(e, t) {
                        for (var n = 0; n < t.length; n++) {
                            var o = t[n];
                            o.enumerable = o.enumerable || !1,
                            o.configurable = !0,
                            "value"in o && (o.writable = !0),
                            Object.defineProperty(e, o.key, o)
                        }
                    }
                    return function(t, n, o) {
                        return n && e(t.prototype, n),
                        o && e(t, o),
                        t
                    }
                }()
                  , h = function(e) {
                    function t(e, n) {
                        r(this, t);
                        var o = a(this, (t.__proto__ || Object.getPrototypeOf(t)).call(this));
                        return o.resolveOptions(n),
                        o.listenClick(e),
                        o
                    }
                    return c(t, e),
                    d(t, [{
                        key: "resolveOptions",
                        value: function e() {
                            var t = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : {};
                            this.action = "function" == typeof t.action ? t.action : this.defaultAction,
                            this.target = "function" == typeof t.target ? t.target : this.defaultTarget,
                            this.text = "function" == typeof t.text ? t.text : this.defaultText
                        }
                    }, {
                        key: "listenClick",
                        value: function e(t) {
                            var n = this;
                            this.listener = (0,
                            f.default)(t, "click", function(e) {
                                return n.onClick(e)
                            })
                        }
                    }, {
                        key: "onClick",
                        value: function e(t) {
                            var n = t.delegateTarget || t.currentTarget;
                            this.clipboardAction && (this.clipboardAction = null),
                            this.clipboardAction = new u.default({
                                action: this.action(n),
                                target: this.target(n),
                                text: this.text(n),
                                trigger: n,
                                emitter: this
                            })
                        }
                    }, {
                        key: "defaultAction",
                        value: function e(t) {
                            return l("action", t)
                        }
                    }, {
                        key: "defaultTarget",
                        value: function e(t) {
                            var n = l("target", t);
                            if (n)
                                return document.querySelector(n)
                        }
                    }, {
                        key: "defaultText",
                        value: function e(t) {
                            return l("text", t)
                        }
                    }, {
                        key: "destroy",
                        value: function e() {
                            this.listener.destroy(),
                            this.clipboardAction && (this.clipboardAction.destroy(),
                            this.clipboardAction = null)
                        }
                    }], [{
                        key: "isSupported",
                        value: function e() {
                            var t = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : ["copy", "cut"]
                              , n = "string" == typeof t ? [t] : t
                              , o = !!document.queryCommandSupported;
                            return n.forEach(function(e) {
                                o = o && !!document.queryCommandSupported(e)
                            }),
                            o
                        }
                    }]),
                    t
                }(s.default);
                e.exports = h
            })
        }
        , {
            "./clipboard-action": 7,
            "good-listener": 4,
            "tiny-emitter": 6
        }]
    }, {}, [8])(8)
});

/* file: script/lib/msgpacklite.js */

!function(t) {
    if ("object" == typeof exports && "undefined" != typeof module)
        module.exports = t();
    else if ("function" == typeof define && define.amd)
        define([], t);
    else {
        var r;
        r = "undefined" != typeof window ? window : "undefined" != typeof global ? global : "undefined" != typeof self ? self : this,
        r.msgpack = t()
    }
}(function() {
    return function t(r, e, n) {
        function i(f, u) {
            if (!e[f]) {
                if (!r[f]) {
                    var a = "function" == typeof require && require;
                    if (!u && a)
                        return a(f, !0);
                    if (o)
                        return o(f, !0);
                    var s = new Error("Cannot find module '" + f + "'");
                    throw s.code = "MODULE_NOT_FOUND",
                    s
                }
                var c = e[f] = {
                    exports: {}
                };
                r[f][0].call(c.exports, function(t) {
                    var e = r[f][1][t];
                    return i(e ? e : t)
                }, c, c.exports, t, r, e, n)
            }
            return e[f].exports
        }
        for (var o = "function" == typeof require && require, f = 0; f < n.length; f++)
            i(n[f]);
        return i
    }({
        1: [function(t, r, e) {
            e.encode = t("./encode").encode,
            e.decode = t("./decode").decode,
            e.Encoder = t("./encoder").Encoder,
            e.Decoder = t("./decoder").Decoder,
            e.createCodec = t("./ext").createCodec,
            e.codec = t("./codec").codec
        }
        , {
            "./codec": 4,
            "./decode": 6,
            "./decoder": 7,
            "./encode": 9,
            "./encoder": 10,
            "./ext": 14
        }],
        2: [function(t, r, e) {
            function n(t, r) {
                for (var e = this, n = r || 0, i = t.length, o = 0; i > o; o++) {
                    var f = t.charCodeAt(o);
                    128 > f ? e[n++] = f : 2048 > f ? (e[n++] = 192 | f >> 6,
                    e[n++] = 128 | 63 & f) : (e[n++] = 224 | f >> 12,
                    e[n++] = 128 | f >> 6 & 63,
                    e[n++] = 128 | 63 & f)
                }
                return n - r
            }
            function i(t, r) {
                var e = this
                  , n = t - 0 || 0;
                r || (r = e.length);
                var i = r - t;
                i > h && (i = h);
                for (var o = []; r > n; ) {
                    for (var f = new Array(i), u = 0; i > u && r > n; ) {
                        var a = e[n++];
                        a = 128 > a ? a : 224 > a ? (63 & a) << 6 | 63 & e[n++] : (63 & a) << 12 | (63 & e[n++]) << 6 | 63 & e[n++],
                        f[u++] = a
                    }
                    i > u && (f = f.slice(0, u)),
                    o.push(String.fromCharCode.apply("", f))
                }
                return o.length > 1 ? o.join("") : o.length ? o.shift() : ""
            }
            function o(t, r, e, n) {
                var i;
                e || (e = 0),
                n || 0 === n || (n = this.length),
                r || (r = 0);
                var o = n - e;
                if (t === this && r > e && n > r)
                    for (i = o - 1; i >= 0; i--)
                        t[i + r] = this[i + e];
                else
                    for (i = 0; o > i; i++)
                        t[i + r] = this[i + e];
                return o
            }
            function f(t, r) {
                new s(this,r,t)
            }
            function u(t, r) {
                new c(this,r,t)
            }
            var a = t("int64-buffer")
              , s = a.Uint64BE
              , c = a.Int64BE
              , h = 8192;
            e.writeString = n,
            e.readString = i,
            e.copy = o,
            e.writeUint64BE = f,
            e.writeInt64BE = u
        }
        , {
            "int64-buffer": 28
        }],
        3: [function(t, r, e) {
            function n(t) {
                return this instanceof n ? (this.options = t,
                void this.init()) : new n(t)
            }
            function i(t) {
                for (var r in t)
                    n.prototype[r] = o(n.prototype[r], t[r])
            }
            function o(t, r) {
                function e() {
                    return t.apply(this, arguments),
                    r.apply(this, arguments)
                }
                return t && r ? e : t || r
            }
            function f(t) {
                function r(t, r) {
                    return r(t)
                }
                return t = t.slice(),
                function(e) {
                    return t.reduce(r, e)
                }
            }
            function u(t) {
                return s(t) ? f(t) : t
            }
            function a(t) {
                return new n(t)
            }
            var s = t("isarray");
            e.createCodec = a,
            e.install = i,
            e.filter = u,
            n.prototype.init = function() {
                return this
            }
            ,
            e.preset = a({
                preset: !0
            })
        }
        , {
            isarray: 29
        }],
        4: [function(t, r, e) {
            t("./read-core"),
            t("./write-core"),
            e.codec = {
                preset: t("./codec-base").preset
            }
        }
        , {
            "./codec-base": 3,
            "./read-core": 16,
            "./write-core": 19
        }],
        5: [function(t, r, e) {
            function n(t) {
                return this instanceof n ? void (t && (this.options = t,
                t.codec && (this.codec = t.codec))) : new n(t)
            }
            e.DecodeBuffer = n;
            var i = t("./read-core").preset
              , o = t("./flex-buffer").FlexDecoder;
            o.mixin(n.prototype),
            n.prototype.codec = i,
            n.prototype.fetch = function() {
                return this.codec.decode(this)
            }
        }
        , {
            "./flex-buffer": 15,
            "./read-core": 16
        }],
        6: [function(t, r, e) {
            function n(t, r) {
                var e = new i(r);
                return e.write(t),
                e.read()
            }
            e.decode = n;
            var i = t("./decode-buffer").DecodeBuffer
        }
        , {
            "./decode-buffer": 5
        }],
        7: [function(t, r, e) {
            function n(t) {
                return this instanceof n ? void o.call(this, t) : new n(t)
            }
            e.Decoder = n;
            var i = t("event-lite")
              , o = t("./decode-buffer").DecodeBuffer;
            n.prototype = new o,
            i.mixin(n.prototype),
            n.prototype.decode = function(t) {
                arguments.length && this.write(t),
                this.flush()
            }
            ,
            n.prototype.push = function(t) {
                this.emit("data", t)
            }
            ,
            n.prototype.end = function(t) {
                this.decode(t),
                this.emit("end")
            }
        }
        , {
            "./decode-buffer": 5,
            "event-lite": 26
        }],
        8: [function(t, r, e) {
            function n(t) {
                return this instanceof n ? void (t && (this.options = t,
                t.codec && (this.codec = t.codec))) : new n(t)
            }
            e.EncodeBuffer = n;
            var i = t("./write-core").preset
              , o = t("./flex-buffer").FlexEncoder;
            o.mixin(n.prototype),
            n.prototype.codec = i,
            n.prototype.write = function(t) {
                this.codec.encode(this, t)
            }
        }
        , {
            "./flex-buffer": 15,
            "./write-core": 19
        }],
        9: [function(t, r, e) {
            function n(t, r) {
                var e = new i(r);
                return e.write(t),
                e.read()
            }
            e.encode = n;
            var i = t("./encode-buffer").EncodeBuffer
        }
        , {
            "./encode-buffer": 8
        }],
        10: [function(t, r, e) {
            function n(t) {
                return this instanceof n ? void o.call(this, t) : new n(t)
            }
            e.Encoder = n;
            var i = t("event-lite")
              , o = t("./encode-buffer").EncodeBuffer;
            n.prototype = new o,
            i.mixin(n.prototype),
            n.prototype.encode = function(t) {
                this.write(t),
                this.emit("data", this.read())
            }
            ,
            n.prototype.end = function(t) {
                arguments.length && this.encode(t),
                this.flush(),
                this.emit("end")
            }
        }
        , {
            "./encode-buffer": 8,
            "event-lite": 26
        }],
        11: [function(t, r, e) {
            function n(t, r) {
                return this instanceof n ? (this.buffer = t,
                void (this.type = r)) : new n(t,r)
            }
            e.ExtBuffer = n
        }
        , {}],
        12: [function(t, r, e) {
            (function(r) {
                function n(t) {
                    t.addExtPacker(14, Error, [a, i]),
                    t.addExtPacker(1, EvalError, [a, i]),
                    t.addExtPacker(2, RangeError, [a, i]),
                    t.addExtPacker(3, ReferenceError, [a, i]),
                    t.addExtPacker(4, SyntaxError, [a, i]),
                    t.addExtPacker(5, TypeError, [a, i]),
                    t.addExtPacker(6, URIError, [a, i]),
                    t.addExtPacker(10, RegExp, [u, i]),
                    t.addExtPacker(11, Boolean, [f, i]),
                    t.addExtPacker(12, String, [f, i]),
                    t.addExtPacker(13, Date, [Number, i]),
                    t.addExtPacker(15, Number, [f, i]),
                    "undefined" != typeof Uint8Array && (t.addExtPacker(17, Int8Array, o),
                    t.addExtPacker(18, Uint8Array, o),
                    t.addExtPacker(19, Int16Array, s),
                    t.addExtPacker(20, Uint16Array, s),
                    t.addExtPacker(21, Int32Array, s),
                    t.addExtPacker(22, Uint32Array, s),
                    t.addExtPacker(23, Float32Array, s),
                    "undefined" != typeof Float64Array && t.addExtPacker(24, Float64Array, s),
                    "undefined" != typeof Uint8ClampedArray && t.addExtPacker(25, Uint8ClampedArray, o),
                    t.addExtPacker(26, ArrayBuffer, c),
                    t.addExtPacker(29, DataView, s))
                }
                function i(r) {
                    return h || (h = t("./encode").encode),
                    h(r)
                }
                function o(t) {
                    return new r(t)
                }
                function f(t) {
                    return t.valueOf()
                }
                function u(t) {
                    t = RegExp.prototype.toString.call(t).split("/"),
                    t.shift();
                    var r = [t.pop()];
                    return r.unshift(t.join("/")),
                    r
                }
                function a(t) {
                    var r = {};
                    for (var e in p)
                        r[e] = t[e];
                    return r
                }
                function s(t) {
                    return new r(new Uint8Array(t.buffer))
                }
                function c(t) {
                    return new r(new Uint8Array(t))
                }
                e.setExtPackers = n;
                var h, p = {
                    name: 1,
                    message: 1,
                    stack: 1,
                    columnNumber: 1,
                    fileName: 1,
                    lineNumber: 1
                }
            }
            ).call(this, t("buffer").Buffer)
        }
        , {
            "./encode": 9,
            buffer: 23
        }],
        13: [function(t, r, e) {
            function n(t) {
                t.addExtUnpacker(14, [i, f(Error)]),
                t.addExtUnpacker(1, [i, f(EvalError)]),
                t.addExtUnpacker(2, [i, f(RangeError)]),
                t.addExtUnpacker(3, [i, f(ReferenceError)]),
                t.addExtUnpacker(4, [i, f(SyntaxError)]),
                t.addExtUnpacker(5, [i, f(TypeError)]),
                t.addExtUnpacker(6, [i, f(URIError)]),
                t.addExtUnpacker(10, [i, o]),
                t.addExtUnpacker(11, [i, u(Boolean)]),
                t.addExtUnpacker(12, [i, u(String)]),
                t.addExtUnpacker(13, [i, u(Date)]),
                t.addExtUnpacker(15, [i, u(Number)]),
                "undefined" != typeof Uint8Array && (t.addExtUnpacker(17, u(Int8Array)),
                t.addExtUnpacker(18, u(Uint8Array)),
                t.addExtUnpacker(19, [a, u(Int16Array)]),
                t.addExtUnpacker(20, [a, u(Uint16Array)]),
                t.addExtUnpacker(21, [a, u(Int32Array)]),
                t.addExtUnpacker(22, [a, u(Uint32Array)]),
                t.addExtUnpacker(23, [a, u(Float32Array)]),
                "undefined" != typeof Float64Array && t.addExtUnpacker(24, [a, u(Float64Array)]),
                "undefined" != typeof Uint8ClampedArray && t.addExtUnpacker(25, u(Uint8ClampedArray)),
                t.addExtUnpacker(26, a),
                t.addExtUnpacker(29, [a, u(DataView)]))
            }
            function i(r) {
                return s || (s = t("./decode").decode),
                s(r)
            }
            function o(t) {
                return RegExp.apply(null, t)
            }
            function f(t) {
                return function(r) {
                    var e = new t;
                    for (var n in c)
                        e[n] = r[n];
                    return e
                }
            }
            function u(t) {
                return function(r) {
                    return new t(r)
                }
            }
            function a(t) {
                return new Uint8Array(t).buffer
            }
            e.setExtUnpackers = n;
            var s, c = {
                name: 1,
                message: 1,
                stack: 1,
                columnNumber: 1,
                fileName: 1,
                lineNumber: 1
            }
        }
        , {
            "./decode": 6
        }],
        14: [function(t, r, e) {
            t("./read-core"),
            t("./write-core"),
            e.createCodec = t("./codec-base").createCodec
        }
        , {
            "./codec-base": 3,
            "./read-core": 16,
            "./write-core": 19
        }],
        15: [function(t, r, e) {
            (function(t) {
                function r() {
                    return this instanceof r ? void 0 : new r
                }
                function n() {
                    return this instanceof n ? void 0 : new n
                }
                function i() {
                    function r(r) {
                        var e = this.offset ? this.buffer.slice(this.offset) : this.buffer;
                        this.buffer = e ? r ? t.concat([e, r]) : e : r,
                        this.offset = 0
                    }
                    function e() {
                        for (; this.offset < this.buffer.length; ) {
                            var t, r = this.offset;
                            try {
                                t = this.fetch()
                            } catch (e) {
                                if (e !== d)
                                    throw e;
                                this.offset = r;
                                break
                            }
                            this.push(t)
                        }
                    }
                    function n(t) {
                        var r = this.offset
                          , e = r + t;
                        if (e > this.buffer.length)
                            throw d;
                        return this.offset = e,
                        r
                    }
                    return {
                        write: r,
                        fetch: u,
                        flush: e,
                        push: s,
                        pull: c,
                        read: a,
                        reserve: n,
                        offset: 0
                    }
                }
                function o() {
                    function r() {
                        var t = this.start;
                        if (t < this.offset) {
                            var r = this.start = this.offset;
                            return this.buffer.slice(t, r)
                        }
                    }
                    function e() {
                        for (; this.start < this.offset; ) {
                            var t = this.fetch();
                            t && this.push(t)
                        }
                    }
                    function n() {
                        var r = this.buffers || (this.buffers = [])
                          , e = r.length > 1 ? t.concat(r) : r[0];
                        return r.length = 0,
                        e
                    }
                    function i(r) {
                        var e = 0 | r;
                        if (this.buffer) {
                            var n = this.buffer.length
                              , i = 0 | this.offset
                              , o = i + e;
                            if (n > o)
                                return this.offset = o,
                                i;
                            this.flush(),
                            r = Math.max(r, Math.min(2 * n, this.maxBufferSize))
                        }
                        return r = Math.max(r, this.minBufferSize),
                        this.buffer = new t(r),
                        this.start = 0,
                        this.offset = e,
                        0
                    }
                    function o(t) {
                        var r = this.offset + t.length;
                        this.buffer && r < this.buffer.length ? (t.copy(this.buffer, this.offset),
                        this.offset = r) : (this.flush(),
                        this.push(t))
                    }
                    return {
                        write: f,
                        fetch: r,
                        flush: e,
                        push: s,
                        pull: n,
                        read: a,
                        reserve: i,
                        send: o,
                        maxBufferSize: l,
                        minBufferSize: p,
                        offset: 0,
                        start: 0
                    }
                }
                function f() {
                    throw new Error("method not implemented: write()")
                }
                function u() {
                    throw new Error("method not implemented: fetch()")
                }
                function a() {
                    var t = this.buffers && this.buffers.length;
                    return t ? (this.flush(),
                    this.pull()) : this.fetch()
                }
                function s(t) {
                    var r = this.buffers || (this.buffers = []);
                    r.push(t)
                }
                function c() {
                    var t = this.buffers || (this.buffers = []);
                    return t.shift()
                }
                function h(t) {
                    function r(r) {
                        for (var e in t)
                            r[e] = t[e];
                        return r
                    }
                    return r
                }
                e.FlexDecoder = r,
                e.FlexEncoder = n;
                var p = 2048
                  , l = 65536
                  , d = new Error("BUFFER_SHORTAGE");
                r.mixin = h(i()),
                r.mixin(r.prototype),
                n.mixin = h(o()),
                n.mixin(n.prototype)
            }
            ).call(this, t("buffer").Buffer)
        }
        , {
            buffer: 23
        }],
        16: [function(t, r, e) {
            function n(t) {
                function r(t) {
                    var r = s(t)
                      , n = e[r];
                    if (!n)
                        throw new Error("Invalid type: " + (r ? "0x" + r.toString(16) : r));
                    return n(t)
                }
                var e = c.getReadToken(t);
                return r
            }
            function i() {
                var t = this.options;
                return this.decode = n(t),
                t && t.preset && a.setExtUnpackers(this),
                this
            }
            function o(t, r) {
                var e = this.extUnpackers || (this.extUnpackers = []);
                e[t] = h.filter(r)
            }
            function f(t) {
                function r(r) {
                    return new u(r,t)
                }
                var e = this.extUnpackers || (this.extUnpackers = []);
                return e[t] || r
            }
            var u = t("./ext-buffer").ExtBuffer
              , a = t("./ext-unpacker")
              , s = t("./read-format").readUint8
              , c = t("./read-token")
              , h = t("./codec-base");
            h.install({
                addExtUnpacker: o,
                getExtUnpacker: f,
                init: i
            }),
            e.preset = i.call(h.preset)
        }
        , {
            "./codec-base": 3,
            "./ext-buffer": 11,
            "./ext-unpacker": 13,
            "./read-format": 17,
            "./read-token": 18
        }],
        17: [function(t, r, e) {
            (function(r) {
                function n(t) {
                    var e = {
                        map: i,
                        array: o,
                        str: f,
                        bin: u,
                        ext: a,
                        uint8: s,
                        uint16: c,
                        uint32: h(4, r.prototype.readUInt32BE),
                        uint64: h(8, p),
                        int8: h(1, r.prototype.readInt8),
                        int16: h(2, r.prototype.readInt16BE),
                        int32: h(4, r.prototype.readInt32BE),
                        int64: h(8, l),
                        float32: h(4, g),
                        float64: h(8, v)
                    };
                    return t && t.int64 && (e.uint64 = h(8, d),
                    e.int64 = h(8, y)),
                    e
                }
                function i(t, r) {
                    var e, n = {}, i = new Array(r), o = new Array(r), f = t.codec.decode;
                    for (e = 0; r > e; e++)
                        i[e] = f(t),
                        o[e] = f(t);
                    for (e = 0; r > e; e++)
                        n[i[e]] = o[e];
                    return n
                }
                function o(t, r) {
                    for (var e = new Array(r), n = t.codec.decode, i = 0; r > i; i++)
                        e[i] = n(t);
                    return e
                }
                function f(t, e) {
                    var n = t.reserve(e)
                      , i = n + e
                      , o = t.buffer;
                    return B || !r.isBuffer(o) ? x.readString.call(o, n, i) : o.toString("utf-8", n, i)
                }
                function u(t, r) {
                    var e = t.reserve(r)
                      , n = e + r;
                    return w.call(t.buffer, e, n)
                }
                function a(t, r) {
                    var e = t.reserve(r)
                      , n = t.buffer[e++]
                      , i = e + r
                      , o = t.codec.getExtUnpacker(n);
                    if (!o)
                        throw new Error("Invalid ext type: " + (n ? "0x" + n.toString(16) : n));
                    var f = w.call(t.buffer, e, i);
                    return o(f)
                }
                function s(t) {
                    var r = t.reserve(1);
                    return t.buffer[r]
                }
                function c(t) {
                    var r = t.reserve(2)
                      , e = t.buffer;
                    return e[r++] << 8 | e[r]
                }
                function h(t, r) {
                    return function(e) {
                        var n = e.reserve(t);
                        return r.call(e.buffer, n, U)
                    }
                }
                function p(t) {
                    return new A(this,t).toNumber()
                }
                function l(t) {
                    return new m(this,t).toNumber()
                }
                function d(t) {
                    return new A(this,t)
                }
                function y(t) {
                    return new m(this,t)
                }
                function g(t) {
                    return this.readFloatBE ? this.readFloatBE(t) : E.read(this, t, !1, 23, 4)
                }
                function v(t) {
                    return this.readDoubleBE ? this.readDoubleBE(t) : E.read(this, t, !1, 52, 8)
                }
                function w(t, e) {
                    var n = this.slice || Array.prototype.slice
                      , i = n.call(this, t, e);
                    return r.isBuffer(i) || (i = r(i)),
                    i
                }
                var E = t("ieee754")
                  , b = t("int64-buffer")
                  , A = b.Uint64BE
                  , m = b.Int64BE;
                e.getReadFormat = n,
                e.readUint8 = s;
                var x = t("./buffer-lite")
                  , B = "TYPED_ARRAY_SUPPORT"in r
                  , U = !0
            }
            ).call(this, t("buffer").Buffer)
        }
        , {
            "./buffer-lite": 2,
            buffer: 23,
            ieee754: 27,
            "int64-buffer": 28
        }],
        18: [function(t, r, e) {
            function n(t) {
                var r = s.getReadFormat(t);
                return t && t.useraw ? o(r) : i(r)
            }
            function i(t) {
                var r, e = new Array(256);
                for (r = 0; 127 >= r; r++)
                    e[r] = f(r);
                for (r = 128; 143 >= r; r++)
                    e[r] = a(r - 128, t.map);
                for (r = 144; 159 >= r; r++)
                    e[r] = a(r - 144, t.array);
                for (r = 160; 191 >= r; r++)
                    e[r] = a(r - 160, t.str);
                for (e[192] = f(null),
                e[193] = null,
                e[194] = f(!1),
                e[195] = f(!0),
                e[196] = u(t.uint8, t.bin),
                e[197] = u(t.uint16, t.bin),
                e[198] = u(t.uint32, t.bin),
                e[199] = u(t.uint8, t.ext),
                e[200] = u(t.uint16, t.ext),
                e[201] = u(t.uint32, t.ext),
                e[202] = t.float32,
                e[203] = t.float64,
                e[204] = t.uint8,
                e[205] = t.uint16,
                e[206] = t.uint32,
                e[207] = t.uint64,
                e[208] = t.int8,
                e[209] = t.int16,
                e[210] = t.int32,
                e[211] = t.int64,
                e[212] = a(1, t.ext),
                e[213] = a(2, t.ext),
                e[214] = a(4, t.ext),
                e[215] = a(8, t.ext),
                e[216] = a(16, t.ext),
                e[217] = u(t.uint8, t.str),
                e[218] = u(t.uint16, t.str),
                e[219] = u(t.uint32, t.str),
                e[220] = u(t.uint16, t.array),
                e[221] = u(t.uint32, t.array),
                e[222] = u(t.uint16, t.map),
                e[223] = u(t.uint32, t.map),
                r = 224; 255 >= r; r++)
                    e[r] = f(r - 256);
                return e
            }
            function o(t) {
                var r, e = n(t).slice();
                for (e[217] = e[196],
                e[218] = e[197],
                e[219] = e[198],
                r = 160; 191 >= r; r++)
                    e[r] = a(r - 160, t.bin);
                return e
            }
            function f(t) {
                return function() {
                    return t
                }
            }
            function u(t, r) {
                return function(e) {
                    var n = t(e);
                    return r(e, n)
                }
            }
            function a(t, r) {
                return function(e) {
                    return r(e, t)
                }
            }
            var s = t("./read-format");
            e.getReadToken = n
        }
        , {
            "./read-format": 17
        }],
        19: [function(t, r, e) {
            function n(t) {
                function r(t, r) {
                    var n = e[typeof r];
                    if (!n)
                        throw new Error('Unsupported type "' + typeof r + '": ' + r);
                    n(t, r)
                }
                var e = s.getWriteType(t);
                return r
            }
            function i() {
                var t = this.options;
                return this.encode = n(t),
                t && t.preset && a.setExtPackers(this),
                this
            }
            function o(t, r, e) {
                function n(r) {
                    var n = e(r);
                    return new u(n,t)
                }
                e = c.filter(e);
                var i = r.name;
                if (i && "Object" !== i) {
                    var o = this.extPackers || (this.extPackers = {});
                    o[i] = n
                } else {
                    var f = this.extEncoderList || (this.extEncoderList = []);
                    f.unshift([r, n])
                }
            }
            function f(t) {
                var r = this.extPackers || (this.extPackers = {})
                  , e = t.constructor
                  , n = e && e.name && r[e.name];
                if (n)
                    return n;
                for (var i = this.extEncoderList || (this.extEncoderList = []), o = i.length, f = 0; o > f; f++) {
                    var u = i[f];
                    if (e === u[0])
                        return u[1]
                }
            }
            var u = t("./ext-buffer").ExtBuffer
              , a = t("./ext-packer")
              , s = t("./write-type")
              , c = t("./codec-base");
            c.install({
                addExtPacker: o,
                getExtPacker: f,
                init: i
            }),
            e.preset = i.call(c.preset)
        }
        , {
            "./codec-base": 3,
            "./ext-buffer": 11,
            "./ext-packer": 12,
            "./write-type": 21
        }],
        20: [function(t, r, e) {
            (function(r) {
                function n(t) {
                    return l || t && t.safe ? o() : i()
                }
                function i() {
                    var t = h.slice();
                    return t[196] = f(196),
                    t[197] = u(197),
                    t[198] = a(198),
                    t[199] = f(199),
                    t[200] = u(200),
                    t[201] = a(201),
                    t[202] = s(202, 4, r.prototype.writeFloatBE, !0),
                    t[203] = s(203, 8, r.prototype.writeDoubleBE, !0),
                    t[204] = f(204),
                    t[205] = u(205),
                    t[206] = a(206),
                    t[207] = s(207, 8, c.writeUint64BE),
                    t[208] = f(208),
                    t[209] = u(209),
                    t[210] = a(210),
                    t[211] = s(211, 8, c.writeUint64BE),
                    t[217] = f(217),
                    t[218] = u(218),
                    t[219] = a(219),
                    t[220] = u(220),
                    t[221] = a(221),
                    t[222] = u(222),
                    t[223] = a(223),
                    t
                }
                function o() {
                    var t = h.slice();
                    return t[196] = s(196, 1, r.prototype.writeUInt8),
                    t[197] = s(197, 2, r.prototype.writeUInt16BE),
                    t[198] = s(198, 4, r.prototype.writeUInt32BE),
                    t[199] = s(199, 1, r.prototype.writeUInt8),
                    t[200] = s(200, 2, r.prototype.writeUInt16BE),
                    t[201] = s(201, 4, r.prototype.writeUInt32BE),
                    t[202] = s(202, 4, r.prototype.writeFloatBE),
                    t[203] = s(203, 8, r.prototype.writeDoubleBE),
                    t[204] = s(204, 1, r.prototype.writeUInt8),
                    t[205] = s(205, 2, r.prototype.writeUInt16BE),
                    t[206] = s(206, 4, r.prototype.writeUInt32BE),
                    t[207] = s(207, 8, c.writeUint64BE),
                    t[208] = s(208, 1, r.prototype.writeInt8),
                    t[209] = s(209, 2, r.prototype.writeInt16BE),
                    t[210] = s(210, 4, r.prototype.writeInt32BE),
                    t[211] = s(211, 8, c.writeUint64BE),
                    t[217] = s(217, 1, r.prototype.writeUInt8),
                    t[218] = s(218, 2, r.prototype.writeUInt16BE),
                    t[219] = s(219, 4, r.prototype.writeUInt32BE),
                    t[220] = s(220, 2, r.prototype.writeUInt16BE),
                    t[221] = s(221, 4, r.prototype.writeUInt32BE),
                    t[222] = s(222, 2, r.prototype.writeUInt16BE),
                    t[223] = s(223, 4, r.prototype.writeUInt32BE),
                    t
                }
                function f(t) {
                    return function(r, e) {
                        var n = r.reserve(2)
                          , i = r.buffer;
                        i[n++] = t,
                        i[n] = e
                    }
                }
                function u(t) {
                    return function(r, e) {
                        var n = r.reserve(3)
                          , i = r.buffer;
                        i[n++] = t,
                        i[n++] = e >>> 8,
                        i[n] = e
                    }
                }
                function a(t) {
                    return function(r, e) {
                        var n = r.reserve(5)
                          , i = r.buffer;
                        i[n++] = t,
                        i[n++] = e >>> 24,
                        i[n++] = e >>> 16,
                        i[n++] = e >>> 8,
                        i[n] = e
                    }
                }
                function s(t, r, e, n) {
                    return function(i, o) {
                        var f = i.reserve(r + 1);
                        i.buffer[f++] = t,
                        e.call(i.buffer, o, f, n)
                    }
                }
                var c = t("./buffer-lite")
                  , h = t("./write-uint8").uint8
                  , p = "TYPED_ARRAY_SUPPORT"in r
                  , l = p && !r.TYPED_ARRAY_SUPPORT;
                e.getWriteToken = n
            }
            ).call(this, t("buffer").Buffer)
        }
        , {
            "./buffer-lite": 2,
            "./write-uint8": 22,
            buffer: 23
        }],
        21: [function(t, r, e) {
            (function(r) {
                function n(t) {
                    function e(t, r) {
                        var e = r ? 195 : 194;
                        P[e](t, r)
                    }
                    function n(t, r) {
                        var e, n = 0 | r;
                        return r !== n ? (e = 203,
                        void P[e](t, r)) : (e = n >= -32 && 127 >= n ? 255 & n : n >= 0 ? 255 >= n ? 204 : 65535 >= n ? 205 : 206 : n >= -128 ? 208 : n >= -32768 ? 209 : 210,
                        void P[e](t, n))
                    }
                    function o(t, r) {
                        var e = 207;
                        P[e](t, r.toArray())
                    }
                    function d(t, r) {
                        var e = 211;
                        P[e](t, r.toArray())
                    }
                    function y(t) {
                        return 32 > t ? 1 : 255 >= t ? 2 : 65535 >= t ? 3 : 5
                    }
                    function g(t) {
                        return 32 > t ? 1 : 65535 >= t ? 3 : 5
                    }
                    function v(t) {
                        function e(e, n) {
                            var i = n.length
                              , o = 5 + 3 * i;
                            e.offset = e.reserve(o);
                            var f = e.buffer
                              , u = t(i)
                              , s = e.offset + u;
                            i = a.writeString.call(f, n, s);
                            var c = t(i);
                            if (u !== c) {
                                var h = s + c - u
                                  , l = s + i;
                                !p && r.isBuffer(f) ? f.copy(f, h, s, l) : a.copy.call(f, f, h, s, l)
                            }
                            var d = 1 === c ? 160 + i : 3 >= c ? 215 + c : 219;
                            P[d](e, i),
                            e.offset += i
                        }
                        return e
                    }
                    function w(t, e) {
                        if (null === e)
                            return b(t, e);
                        if (r.isBuffer(e))
                            return m(t, e);
                        if (i(e))
                            return A(t, e);
                        if (f.isUint64BE(e))
                            return o(t, e);
                        if (u.isInt64BE(e))
                            return d(t, e);
                        var n = t.codec.getExtPacker(e);
                        return n && (e = n(e)),
                        e instanceof h ? x(t, e) : void B(t, e)
                    }
                    function E(t, e) {
                        return r.isBuffer(e) ? U(t, e) : void w(t, e)
                    }
                    function b(t, r) {
                        var e = 192;
                        P[e](t, r)
                    }
                    function A(t, r) {
                        var e = r.length
                          , n = 16 > e ? 144 + e : 65535 >= e ? 220 : 221;
                        P[n](t, e);
                        for (var i = t.codec.encode, o = 0; e > o; o++)
                            i(t, r[o])
                    }
                    function m(t, r) {
                        var e = r.length
                          , n = 255 > e ? 196 : 65535 >= e ? 197 : 198;
                        P[n](t, e),
                        t.send(r)
                    }
                    function x(t, r) {
                        var e = r.buffer
                          , n = e.length
                          , i = l[n] || (255 > n ? 199 : 65535 >= n ? 200 : 201);
                        P[i](t, n),
                        c[r.type](t),
                        t.send(e)
                    }
                    function B(t, r) {
                        var e = Object.keys(r)
                          , n = e.length
                          , i = 16 > n ? 128 + n : 65535 >= n ? 222 : 223;
                        P[i](t, n);
                        var o = t.codec.encode;
                        e.forEach(function(e) {
                            o(t, e),
                            o(t, r[e])
                        })
                    }
                    function U(t, r) {
                        var e = r.length
                          , n = 32 > e ? 160 + e : 65535 >= e ? 218 : 219;
                        P[n](t, e),
                        t.send(r)
                    }
                    var P = s.getWriteToken(t)
                      , R = t && t.useraw
                      , k = {
                        "boolean": e,
                        "function": b,
                        number: n,
                        object: R ? E : w,
                        string: v(R ? g : y),
                        symbol: b,
                        undefined: b
                    };
                    return k
                }
                var i = t("isarray")
                  , o = t("int64-buffer")
                  , f = o.Uint64BE
                  , u = o.Int64BE
                  , a = t("./buffer-lite")
                  , s = t("./write-token")
                  , c = t("./write-uint8").uint8
                  , h = t("./ext-buffer").ExtBuffer
                  , p = "TYPED_ARRAY_SUPPORT"in r
                  , l = [];
                l[1] = 212,
                l[2] = 213,
                l[4] = 214,
                l[8] = 215,
                l[16] = 216,
                e.getWriteType = n
            }
            ).call(this, t("buffer").Buffer)
        }
        , {
            "./buffer-lite": 2,
            "./ext-buffer": 11,
            "./write-token": 20,
            "./write-uint8": 22,
            buffer: 23,
            "int64-buffer": 28,
            isarray: 29
        }],
        22: [function(t, r, e) {
            function n(t) {
                return function(r) {
                    var e = r.reserve(1);
                    r.buffer[e] = t
                }
            }
            for (var i = e.uint8 = new Array(256), o = 0; 255 >= o; o++)
                i[o] = n(o)
        }
        , {}],
        23: [function(t, r, e) {
            (function(r) {
                "use strict";
                function n() {
                    try {
                        var t = new Uint8Array(1);
                        return t.foo = function() {
                            return 42
                        }
                        ,
                        42 === t.foo() && "function" == typeof t.subarray && 0 === t.subarray(1, 1).byteLength
                    } catch (r) {
                        return !1
                    }
                }
                function i() {
                    return f.TYPED_ARRAY_SUPPORT ? 2147483647 : 1073741823
                }
                function o(t, r) {
                    if (i() < r)
                        throw new RangeError("Invalid typed array length");
                    return f.TYPED_ARRAY_SUPPORT ? (t = new Uint8Array(r),
                    t.__proto__ = f.prototype) : (null === t && (t = new f(r)),
                    t.length = r),
                    t
                }
                function f(t, r, e) {
                    if (!(f.TYPED_ARRAY_SUPPORT || this instanceof f))
                        return new f(t,r,e);
                    if ("number" == typeof t) {
                        if ("string" == typeof r)
                            throw new Error("If encoding is specified then the first argument must be a string");
                        return c(this, t)
                    }
                    return u(this, t, r, e)
                }
                function u(t, r, e, n) {
                    if ("number" == typeof r)
                        throw new TypeError('"value" argument must not be a number');
                    return "undefined" != typeof ArrayBuffer && r instanceof ArrayBuffer ? l(t, r, e, n) : "string" == typeof r ? h(t, r, e) : d(t, r)
                }
                function a(t) {
                    if ("number" != typeof t)
                        throw new TypeError('"size" argument must be a number')
                }
                function s(t, r, e, n) {
                    return a(r),
                    0 >= r ? o(t, r) : void 0 !== e ? "string" == typeof n ? o(t, r).fill(e, n) : o(t, r).fill(e) : o(t, r)
                }
                function c(t, r) {
                    if (a(r),
                    t = o(t, 0 > r ? 0 : 0 | y(r)),
                    !f.TYPED_ARRAY_SUPPORT)
                        for (var e = 0; r > e; e++)
                            t[e] = 0;
                    return t
                }
                function h(t, r, e) {
                    if ("string" == typeof e && "" !== e || (e = "utf8"),
                    !f.isEncoding(e))
                        throw new TypeError('"encoding" must be a valid string encoding');
                    var n = 0 | v(r, e);
                    return t = o(t, n),
                    t.write(r, e),
                    t
                }
                function p(t, r) {
                    var e = 0 | y(r.length);
                    t = o(t, e);
                    for (var n = 0; e > n; n += 1)
                        t[n] = 255 & r[n];
                    return t
                }
                function l(t, r, e, n) {
                    if (r.byteLength,
                    0 > e || r.byteLength < e)
                        throw new RangeError("'offset' is out of bounds");
                    if (r.byteLength < e + (n || 0))
                        throw new RangeError("'length' is out of bounds");
                    return r = void 0 === n ? new Uint8Array(r,e) : new Uint8Array(r,e,n),
                    f.TYPED_ARRAY_SUPPORT ? (t = r,
                    t.__proto__ = f.prototype) : t = p(t, r),
                    t
                }
                function d(t, r) {
                    if (f.isBuffer(r)) {
                        var e = 0 | y(r.length);
                        return t = o(t, e),
                        0 === t.length ? t : (r.copy(t, 0, 0, e),
                        t)
                    }
                    if (r) {
                        if ("undefined" != typeof ArrayBuffer && r.buffer instanceof ArrayBuffer || "length"in r)
                            return "number" != typeof r.length || H(r.length) ? o(t, 0) : p(t, r);
                        if ("Buffer" === r.type && Q(r.data))
                            return p(t, r.data)
                    }
                    throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")
                }
                function y(t) {
                    if (t >= i())
                        throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x" + i().toString(16) + " bytes");
                    return 0 | t
                }
                function g(t) {
                    return +t != t && (t = 0),
                    f.alloc(+t)
                }
                function v(t, r) {
                    if (f.isBuffer(t))
                        return t.length;
                    if ("undefined" != typeof ArrayBuffer && "function" == typeof ArrayBuffer.isView && (ArrayBuffer.isView(t) || t instanceof ArrayBuffer))
                        return t.byteLength;
                    "string" != typeof t && (t = "" + t);
                    var e = t.length;
                    if (0 === e)
                        return 0;
                    for (var n = !1; ; )
                        switch (r) {
                        case "ascii":
                        case "binary":
                        case "raw":
                        case "raws":
                            return e;
                        case "utf8":
                        case "utf-8":
                        case void 0:
                            return V(t).length;
                        case "ucs2":
                        case "ucs-2":
                        case "utf16le":
                        case "utf-16le":
                            return 2 * e;
                        case "hex":
                            return e >>> 1;
                        case "base64":
                            return X(t).length;
                        default:
                            if (n)
                                return V(t).length;
                            r = ("" + r).toLowerCase(),
                            n = !0
                        }
                }
                function w(t, r, e) {
                    var n = !1;
                    if ((void 0 === r || 0 > r) && (r = 0),
                    r > this.length)
                        return "";
                    if ((void 0 === e || e > this.length) && (e = this.length),
                    0 >= e)
                        return "";
                    if (e >>>= 0,
                    r >>>= 0,
                    r >= e)
                        return "";
                    for (t || (t = "utf8"); ; )
                        switch (t) {
                        case "hex":
                            return S(this, r, e);
                        case "utf8":
                        case "utf-8":
                            return k(this, r, e);
                        case "ascii":
                            return I(this, r, e);
                        case "binary":
                            return T(this, r, e);
                        case "base64":
                            return R(this, r, e);
                        case "ucs2":
                        case "ucs-2":
                        case "utf16le":
                        case "utf-16le":
                            return Y(this, r, e);
                        default:
                            if (n)
                                throw new TypeError("Unknown encoding: " + t);
                            t = (t + "").toLowerCase(),
                            n = !0
                        }
                }
                function E(t, r, e) {
                    var n = t[r];
                    t[r] = t[e],
                    t[e] = n
                }
                function b(t, r, e, n) {
                    function i(t, r) {
                        return 1 === o ? t[r] : t.readUInt16BE(r * o)
                    }
                    var o = 1
                      , f = t.length
                      , u = r.length;
                    if (void 0 !== n && (n = String(n).toLowerCase(),
                    "ucs2" === n || "ucs-2" === n || "utf16le" === n || "utf-16le" === n)) {
                        if (t.length < 2 || r.length < 2)
                            return -1;
                        o = 2,
                        f /= 2,
                        u /= 2,
                        e /= 2
                    }
                    for (var a = -1, s = 0; f > e + s; s++)
                        if (i(t, e + s) === i(r, -1 === a ? 0 : s - a)) {
                            if (-1 === a && (a = s),
                            s - a + 1 === u)
                                return (e + a) * o
                        } else
                            -1 !== a && (s -= s - a),
                            a = -1;
                    return -1
                }
                function A(t, r, e, n) {
                    e = Number(e) || 0;
                    var i = t.length - e;
                    n ? (n = Number(n),
                    n > i && (n = i)) : n = i;
                    var o = r.length;
                    if (o % 2 !== 0)
                        throw new Error("Invalid hex string");
                    n > o / 2 && (n = o / 2);
                    for (var f = 0; n > f; f++) {
                        var u = parseInt(r.substr(2 * f, 2), 16);
                        if (isNaN(u))
                            return f;
                        t[e + f] = u
                    }
                    return f
                }
                function m(t, r, e, n) {
                    return G(V(r, t.length - e), t, e, n)
                }
                function x(t, r, e, n) {
                    return G(W(r), t, e, n)
                }
                function B(t, r, e, n) {
                    return x(t, r, e, n)
                }
                function U(t, r, e, n) {
                    return G(X(r), t, e, n)
                }
                function P(t, r, e, n) {
                    return G(J(r, t.length - e), t, e, n)
                }
                function R(t, r, e) {
                    return 0 === r && e === t.length ? Z.fromByteArray(t) : Z.fromByteArray(t.slice(r, e))
                }
                function k(t, r, e) {
                    e = Math.min(t.length, e);
                    for (var n = [], i = r; e > i; ) {
                        var o = t[i]
                          , f = null
                          , u = o > 239 ? 4 : o > 223 ? 3 : o > 191 ? 2 : 1;
                        if (e >= i + u) {
                            var a, s, c, h;
                            switch (u) {
                            case 1:
                                128 > o && (f = o);
                                break;
                            case 2:
                                a = t[i + 1],
                                128 === (192 & a) && (h = (31 & o) << 6 | 63 & a,
                                h > 127 && (f = h));
                                break;
                            case 3:
                                a = t[i + 1],
                                s = t[i + 2],
                                128 === (192 & a) && 128 === (192 & s) && (h = (15 & o) << 12 | (63 & a) << 6 | 63 & s,
                                h > 2047 && (55296 > h || h > 57343) && (f = h));
                                break;
                            case 4:
                                a = t[i + 1],
                                s = t[i + 2],
                                c = t[i + 3],
                                128 === (192 & a) && 128 === (192 & s) && 128 === (192 & c) && (h = (15 & o) << 18 | (63 & a) << 12 | (63 & s) << 6 | 63 & c,
                                h > 65535 && 1114112 > h && (f = h))
                            }
                        }
                        null === f ? (f = 65533,
                        u = 1) : f > 65535 && (f -= 65536,
                        n.push(f >>> 10 & 1023 | 55296),
                        f = 56320 | 1023 & f),
                        n.push(f),
                        i += u
                    }
                    return _(n)
                }
                function _(t) {
                    var r = t.length;
                    if ($ >= r)
                        return String.fromCharCode.apply(String, t);
                    for (var e = "", n = 0; r > n; )
                        e += String.fromCharCode.apply(String, t.slice(n, n += $));
                    return e
                }
                function I(t, r, e) {
                    var n = "";
                    e = Math.min(t.length, e);
                    for (var i = r; e > i; i++)
                        n += String.fromCharCode(127 & t[i]);
                    return n
                }
                function T(t, r, e) {
                    var n = "";
                    e = Math.min(t.length, e);
                    for (var i = r; e > i; i++)
                        n += String.fromCharCode(t[i]);
                    return n
                }
                function S(t, r, e) {
                    var n = t.length;
                    (!r || 0 > r) && (r = 0),
                    (!e || 0 > e || e > n) && (e = n);
                    for (var i = "", o = r; e > o; o++)
                        i += q(t[o]);
                    return i
                }
                function Y(t, r, e) {
                    for (var n = t.slice(r, e), i = "", o = 0; o < n.length; o += 2)
                        i += String.fromCharCode(n[o] + 256 * n[o + 1]);
                    return i
                }
                function D(t, r, e) {
                    if (t % 1 !== 0 || 0 > t)
                        throw new RangeError("offset is not uint");
                    if (t + r > e)
                        throw new RangeError("Trying to access beyond buffer length")
                }
                function C(t, r, e, n, i, o) {
                    if (!f.isBuffer(t))
                        throw new TypeError('"buffer" argument must be a Buffer instance');
                    if (r > i || o > r)
                        throw new RangeError('"value" argument is out of bounds');
                    if (e + n > t.length)
                        throw new RangeError("Index out of range")
                }
                function O(t, r, e, n) {
                    0 > r && (r = 65535 + r + 1);
                    for (var i = 0, o = Math.min(t.length - e, 2); o > i; i++)
                        t[e + i] = (r & 255 << 8 * (n ? i : 1 - i)) >>> 8 * (n ? i : 1 - i)
                }
                function M(t, r, e, n) {
                    0 > r && (r = 4294967295 + r + 1);
                    for (var i = 0, o = Math.min(t.length - e, 4); o > i; i++)
                        t[e + i] = r >>> 8 * (n ? i : 3 - i) & 255
                }
                function L(t, r, e, n, i, o) {
                    if (e + n > t.length)
                        throw new RangeError("Index out of range");
                    if (0 > e)
                        throw new RangeError("Index out of range")
                }
                function N(t, r, e, n, i) {
                    return i || L(t, r, e, 4, 3.4028234663852886e38, -3.4028234663852886e38),
                    K.write(t, r, e, n, 23, 4),
                    e + 4
                }
                function F(t, r, e, n, i) {
                    return i || L(t, r, e, 8, 1.7976931348623157e308, -1.7976931348623157e308),
                    K.write(t, r, e, n, 52, 8),
                    e + 8
                }
                function j(t) {
                    if (t = z(t).replace(tt, ""),
                    t.length < 2)
                        return "";
                    for (; t.length % 4 !== 0; )
                        t += "=";
                    return t
                }
                function z(t) {
                    return t.trim ? t.trim() : t.replace(/^\s+|\s+$/g, "")
                }
                function q(t) {
                    return 16 > t ? "0" + t.toString(16) : t.toString(16)
                }
                function V(t, r) {
                    r = r || 1 / 0;
                    for (var e, n = t.length, i = null, o = [], f = 0; n > f; f++) {
                        if (e = t.charCodeAt(f),
                        e > 55295 && 57344 > e) {
                            if (!i) {
                                if (e > 56319) {
                                    (r -= 3) > -1 && o.push(239, 191, 189);
                                    continue
                                }
                                if (f + 1 === n) {
                                    (r -= 3) > -1 && o.push(239, 191, 189);
                                    continue
                                }
                                i = e;
                                continue
                            }
                            if (56320 > e) {
                                (r -= 3) > -1 && o.push(239, 191, 189),
                                i = e;
                                continue
                            }
                            e = (i - 55296 << 10 | e - 56320) + 65536
                        } else
                            i && (r -= 3) > -1 && o.push(239, 191, 189);
                        if (i = null,
                        128 > e) {
                            if ((r -= 1) < 0)
                                break;
                            o.push(e)
                        } else if (2048 > e) {
                            if ((r -= 2) < 0)
                                break;
                            o.push(e >> 6 | 192, 63 & e | 128)
                        } else if (65536 > e) {
                            if ((r -= 3) < 0)
                                break;
                            o.push(e >> 12 | 224, e >> 6 & 63 | 128, 63 & e | 128)
                        } else {
                            if (!(1114112 > e))
                                throw new Error("Invalid code point");
                            if ((r -= 4) < 0)
                                break;
                            o.push(e >> 18 | 240, e >> 12 & 63 | 128, e >> 6 & 63 | 128, 63 & e | 128)
                        }
                    }
                    return o
                }
                function W(t) {
                    for (var r = [], e = 0; e < t.length; e++)
                        r.push(255 & t.charCodeAt(e));
                    return r
                }
                function J(t, r) {
                    for (var e, n, i, o = [], f = 0; f < t.length && !((r -= 2) < 0); f++)
                        e = t.charCodeAt(f),
                        n = e >> 8,
                        i = e % 256,
                        o.push(i),
                        o.push(n);
                    return o
                }
                function X(t) {
                    return Z.toByteArray(j(t))
                }
                function G(t, r, e, n) {
                    for (var i = 0; n > i && !(i + e >= r.length || i >= t.length); i++)
                        r[i + e] = t[i];
                    return i
                }
                function H(t) {
                    return t !== t
                }
                var Z = t("base64-js")
                  , K = t("ieee754")
                  , Q = t("isarray");
                e.Buffer = f,
                e.SlowBuffer = g,
                e.INSPECT_MAX_BYTES = 50,
                f.TYPED_ARRAY_SUPPORT = void 0 !== r.TYPED_ARRAY_SUPPORT ? r.TYPED_ARRAY_SUPPORT : n(),
                e.kMaxLength = i(),
                f.poolSize = 8192,
                f._augment = function(t) {
                    return t.__proto__ = f.prototype,
                    t
                }
                ,
                f.from = function(t, r, e) {
                    return u(null, t, r, e)
                }
                ,
                f.TYPED_ARRAY_SUPPORT && (f.prototype.__proto__ = Uint8Array.prototype,
                f.__proto__ = Uint8Array,
                "undefined" != typeof Symbol && Symbol.species && f[Symbol.species] === f && Object.defineProperty(f, Symbol.species, {
                    value: null,
                    configurable: !0
                })),
                f.alloc = function(t, r, e) {
                    return s(null, t, r, e)
                }
                ,
                f.allocUnsafe = function(t) {
                    return c(null, t)
                }
                ,
                f.allocUnsafeSlow = function(t) {
                    return c(null, t)
                }
                ,
                f.isBuffer = function(t) {
                    return !(null == t || !t._isBuffer)
                }
                ,
                f.compare = function(t, r) {
                    if (!f.isBuffer(t) || !f.isBuffer(r))
                        throw new TypeError("Arguments must be Buffers");
                    if (t === r)
                        return 0;
                    for (var e = t.length, n = r.length, i = 0, o = Math.min(e, n); o > i; ++i)
                        if (t[i] !== r[i]) {
                            e = t[i],
                            n = r[i];
                            break
                        }
                    return n > e ? -1 : e > n ? 1 : 0
                }
                ,
                f.isEncoding = function(t) {
                    switch (String(t).toLowerCase()) {
                    case "hex":
                    case "utf8":
                    case "utf-8":
                    case "ascii":
                    case "binary":
                    case "base64":
                    case "raw":
                    case "ucs2":
                    case "ucs-2":
                    case "utf16le":
                    case "utf-16le":
                        return !0;
                    default:
                        return !1
                    }
                }
                ,
                f.concat = function(t, r) {
                    if (!Q(t))
                        throw new TypeError('"list" argument must be an Array of Buffers');
                    if (0 === t.length)
                        return f.alloc(0);
                    var e;
                    if (void 0 === r)
                        for (r = 0,
                        e = 0; e < t.length; e++)
                            r += t[e].length;
                    var n = f.allocUnsafe(r)
                      , i = 0;
                    for (e = 0; e < t.length; e++) {
                        var o = t[e];
                        if (!f.isBuffer(o))
                            throw new TypeError('"list" argument must be an Array of Buffers');
                        o.copy(n, i),
                        i += o.length
                    }
                    return n
                }
                ,
                f.byteLength = v,
                f.prototype._isBuffer = !0,
                f.prototype.swap16 = function() {
                    var t = this.length;
                    if (t % 2 !== 0)
                        throw new RangeError("Buffer size must be a multiple of 16-bits");
                    for (var r = 0; t > r; r += 2)
                        E(this, r, r + 1);
                    return this
                }
                ,
                f.prototype.swap32 = function() {
                    var t = this.length;
                    if (t % 4 !== 0)
                        throw new RangeError("Buffer size must be a multiple of 32-bits");
                    for (var r = 0; t > r; r += 4)
                        E(this, r, r + 3),
                        E(this, r + 1, r + 2);
                    return this
                }
                ,
                f.prototype.toString = function() {
                    var t = 0 | this.length;
                    return 0 === t ? "" : 0 === arguments.length ? k(this, 0, t) : w.apply(this, arguments)
                }
                ,
                f.prototype.equals = function(t) {
                    if (!f.isBuffer(t))
                        throw new TypeError("Argument must be a Buffer");
                    return this === t ? !0 : 0 === f.compare(this, t)
                }
                ,
                f.prototype.inspect = function() {
                    var t = ""
                      , r = e.INSPECT_MAX_BYTES;
                    return this.length > 0 && (t = this.toString("hex", 0, r).match(/.{2}/g).join(" "),
                    this.length > r && (t += " ... ")),
                    "<Buffer " + t + ">"
                }
                ,
                f.prototype.compare = function(t, r, e, n, i) {
                    if (!f.isBuffer(t))
                        throw new TypeError("Argument must be a Buffer");
                    if (void 0 === r && (r = 0),
                    void 0 === e && (e = t ? t.length : 0),
                    void 0 === n && (n = 0),
                    void 0 === i && (i = this.length),
                    0 > r || e > t.length || 0 > n || i > this.length)
                        throw new RangeError("out of range index");
                    if (n >= i && r >= e)
                        return 0;
                    if (n >= i)
                        return -1;
                    if (r >= e)
                        return 1;
                    if (r >>>= 0,
                    e >>>= 0,
                    n >>>= 0,
                    i >>>= 0,
                    this === t)
                        return 0;
                    for (var o = i - n, u = e - r, a = Math.min(o, u), s = this.slice(n, i), c = t.slice(r, e), h = 0; a > h; ++h)
                        if (s[h] !== c[h]) {
                            o = s[h],
                            u = c[h];
                            break
                        }
                    return u > o ? -1 : o > u ? 1 : 0
                }
                ,
                f.prototype.indexOf = function(t, r, e) {
                    if ("string" == typeof r ? (e = r,
                    r = 0) : r > 2147483647 ? r = 2147483647 : -2147483648 > r && (r = -2147483648),
                    r >>= 0,
                    0 === this.length)
                        return -1;
                    if (r >= this.length)
                        return -1;
                    if (0 > r && (r = Math.max(this.length + r, 0)),
                    "string" == typeof t && (t = f.from(t, e)),
                    f.isBuffer(t))
                        return 0 === t.length ? -1 : b(this, t, r, e);
                    if ("number" == typeof t)
                        return f.TYPED_ARRAY_SUPPORT && "function" === Uint8Array.prototype.indexOf ? Uint8Array.prototype.indexOf.call(this, t, r) : b(this, [t], r, e);
                    throw new TypeError("val must be string, number or Buffer")
                }
                ,
                f.prototype.includes = function(t, r, e) {
                    return -1 !== this.indexOf(t, r, e)
                }
                ,
                f.prototype.write = function(t, r, e, n) {
                    if (void 0 === r)
                        n = "utf8",
                        e = this.length,
                        r = 0;
                    else if (void 0 === e && "string" == typeof r)
                        n = r,
                        e = this.length,
                        r = 0;
                    else {
                        if (!isFinite(r))
                            throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");
                        r = 0 | r,
                        isFinite(e) ? (e = 0 | e,
                        void 0 === n && (n = "utf8")) : (n = e,
                        e = void 0)
                    }
                    var i = this.length - r;
                    if ((void 0 === e || e > i) && (e = i),
                    t.length > 0 && (0 > e || 0 > r) || r > this.length)
                        throw new RangeError("Attempt to write outside buffer bounds");
                    n || (n = "utf8");
                    for (var o = !1; ; )
                        switch (n) {
                        case "hex":
                            return A(this, t, r, e);
                        case "utf8":
                        case "utf-8":
                            return m(this, t, r, e);
                        case "ascii":
                            return x(this, t, r, e);
                        case "binary":
                            return B(this, t, r, e);
                        case "base64":
                            return U(this, t, r, e);
                        case "ucs2":
                        case "ucs-2":
                        case "utf16le":
                        case "utf-16le":
                            return P(this, t, r, e);
                        default:
                            if (o)
                                throw new TypeError("Unknown encoding: " + n);
                            n = ("" + n).toLowerCase(),
                            o = !0
                        }
                }
                ,
                f.prototype.toJSON = function() {
                    return {
                        type: "Buffer",
                        data: Array.prototype.slice.call(this._arr || this, 0)
                    }
                }
                ;
                var $ = 4096;
                f.prototype.slice = function(t, r) {
                    var e = this.length;
                    t = ~~t,
                    r = void 0 === r ? e : ~~r,
                    0 > t ? (t += e,
                    0 > t && (t = 0)) : t > e && (t = e),
                    0 > r ? (r += e,
                    0 > r && (r = 0)) : r > e && (r = e),
                    t > r && (r = t);
                    var n;
                    if (f.TYPED_ARRAY_SUPPORT)
                        n = this.subarray(t, r),
                        n.__proto__ = f.prototype;
                    else {
                        var i = r - t;
                        n = new f(i,void 0);
                        for (var o = 0; i > o; o++)
                            n[o] = this[o + t]
                    }
                    return n
                }
                ,
                f.prototype.readUIntLE = function(t, r, e) {
                    t = 0 | t,
                    r = 0 | r,
                    e || D(t, r, this.length);
                    for (var n = this[t], i = 1, o = 0; ++o < r && (i *= 256); )
                        n += this[t + o] * i;
                    return n
                }
                ,
                f.prototype.readUIntBE = function(t, r, e) {
                    t = 0 | t,
                    r = 0 | r,
                    e || D(t, r, this.length);
                    for (var n = this[t + --r], i = 1; r > 0 && (i *= 256); )
                        n += this[t + --r] * i;
                    return n
                }
                ,
                f.prototype.readUInt8 = function(t, r) {
                    return r || D(t, 1, this.length),
                    this[t]
                }
                ,
                f.prototype.readUInt16LE = function(t, r) {
                    return r || D(t, 2, this.length),
                    this[t] | this[t + 1] << 8
                }
                ,
                f.prototype.readUInt16BE = function(t, r) {
                    return r || D(t, 2, this.length),
                    this[t] << 8 | this[t + 1]
                }
                ,
                f.prototype.readUInt32LE = function(t, r) {
                    return r || D(t, 4, this.length),
                    (this[t] | this[t + 1] << 8 | this[t + 2] << 16) + 16777216 * this[t + 3]
                }
                ,
                f.prototype.readUInt32BE = function(t, r) {
                    return r || D(t, 4, this.length),
                    16777216 * this[t] + (this[t + 1] << 16 | this[t + 2] << 8 | this[t + 3])
                }
                ,
                f.prototype.readIntLE = function(t, r, e) {
                    t = 0 | t,
                    r = 0 | r,
                    e || D(t, r, this.length);
                    for (var n = this[t], i = 1, o = 0; ++o < r && (i *= 256); )
                        n += this[t + o] * i;
                    return i *= 128,
                    n >= i && (n -= Math.pow(2, 8 * r)),
                    n
                }
                ,
                f.prototype.readIntBE = function(t, r, e) {
                    t = 0 | t,
                    r = 0 | r,
                    e || D(t, r, this.length);
                    for (var n = r, i = 1, o = this[t + --n]; n > 0 && (i *= 256); )
                        o += this[t + --n] * i;
                    return i *= 128,
                    o >= i && (o -= Math.pow(2, 8 * r)),
                    o
                }
                ,
                f.prototype.readInt8 = function(t, r) {
                    return r || D(t, 1, this.length),
                    128 & this[t] ? -1 * (255 - this[t] + 1) : this[t]
                }
                ,
                f.prototype.readInt16LE = function(t, r) {
                    r || D(t, 2, this.length);
                    var e = this[t] | this[t + 1] << 8;
                    return 32768 & e ? 4294901760 | e : e
                }
                ,
                f.prototype.readInt16BE = function(t, r) {
                    r || D(t, 2, this.length);
                    var e = this[t + 1] | this[t] << 8;
                    return 32768 & e ? 4294901760 | e : e
                }
                ,
                f.prototype.readInt32LE = function(t, r) {
                    return r || D(t, 4, this.length),
                    this[t] | this[t + 1] << 8 | this[t + 2] << 16 | this[t + 3] << 24
                }
                ,
                f.prototype.readInt32BE = function(t, r) {
                    return r || D(t, 4, this.length),
                    this[t] << 24 | this[t + 1] << 16 | this[t + 2] << 8 | this[t + 3]
                }
                ,
                f.prototype.readFloatLE = function(t, r) {
                    return r || D(t, 4, this.length),
                    K.read(this, t, !0, 23, 4)
                }
                ,
                f.prototype.readFloatBE = function(t, r) {
                    return r || D(t, 4, this.length),
                    K.read(this, t, !1, 23, 4)
                }
                ,
                f.prototype.readDoubleLE = function(t, r) {
                    return r || D(t, 8, this.length),
                    K.read(this, t, !0, 52, 8)
                }
                ,
                f.prototype.readDoubleBE = function(t, r) {
                    return r || D(t, 8, this.length),
                    K.read(this, t, !1, 52, 8)
                }
                ,
                f.prototype.writeUIntLE = function(t, r, e, n) {
                    if (t = +t,
                    r = 0 | r,
                    e = 0 | e,
                    !n) {
                        var i = Math.pow(2, 8 * e) - 1;
                        C(this, t, r, e, i, 0)
                    }
                    var o = 1
                      , f = 0;
                    for (this[r] = 255 & t; ++f < e && (o *= 256); )
                        this[r + f] = t / o & 255;
                    return r + e
                }
                ,
                f.prototype.writeUIntBE = function(t, r, e, n) {
                    if (t = +t,
                    r = 0 | r,
                    e = 0 | e,
                    !n) {
                        var i = Math.pow(2, 8 * e) - 1;
                        C(this, t, r, e, i, 0)
                    }
                    var o = e - 1
                      , f = 1;
                    for (this[r + o] = 255 & t; --o >= 0 && (f *= 256); )
                        this[r + o] = t / f & 255;
                    return r + e
                }
                ,
                f.prototype.writeUInt8 = function(t, r, e) {
                    return t = +t,
                    r = 0 | r,
                    e || C(this, t, r, 1, 255, 0),
                    f.TYPED_ARRAY_SUPPORT || (t = Math.floor(t)),
                    this[r] = 255 & t,
                    r + 1
                }
                ,
                f.prototype.writeUInt16LE = function(t, r, e) {
                    return t = +t,
                    r = 0 | r,
                    e || C(this, t, r, 2, 65535, 0),
                    f.TYPED_ARRAY_SUPPORT ? (this[r] = 255 & t,
                    this[r + 1] = t >>> 8) : O(this, t, r, !0),
                    r + 2
                }
                ,
                f.prototype.writeUInt16BE = function(t, r, e) {
                    return t = +t,
                    r = 0 | r,
                    e || C(this, t, r, 2, 65535, 0),
                    f.TYPED_ARRAY_SUPPORT ? (this[r] = t >>> 8,
                    this[r + 1] = 255 & t) : O(this, t, r, !1),
                    r + 2
                }
                ,
                f.prototype.writeUInt32LE = function(t, r, e) {
                    return t = +t,
                    r = 0 | r,
                    e || C(this, t, r, 4, 4294967295, 0),
                    f.TYPED_ARRAY_SUPPORT ? (this[r + 3] = t >>> 24,
                    this[r + 2] = t >>> 16,
                    this[r + 1] = t >>> 8,
                    this[r] = 255 & t) : M(this, t, r, !0),
                    r + 4
                }
                ,
                f.prototype.writeUInt32BE = function(t, r, e) {
                    return t = +t,
                    r = 0 | r,
                    e || C(this, t, r, 4, 4294967295, 0),
                    f.TYPED_ARRAY_SUPPORT ? (this[r] = t >>> 24,
                    this[r + 1] = t >>> 16,
                    this[r + 2] = t >>> 8,
                    this[r + 3] = 255 & t) : M(this, t, r, !1),
                    r + 4
                }
                ,
                f.prototype.writeIntLE = function(t, r, e, n) {
                    if (t = +t,
                    r = 0 | r,
                    !n) {
                        var i = Math.pow(2, 8 * e - 1);
                        C(this, t, r, e, i - 1, -i)
                    }
                    var o = 0
                      , f = 1
                      , u = 0;
                    for (this[r] = 255 & t; ++o < e && (f *= 256); )
                        0 > t && 0 === u && 0 !== this[r + o - 1] && (u = 1),
                        this[r + o] = (t / f >> 0) - u & 255;
                    return r + e
                }
                ,
                f.prototype.writeIntBE = function(t, r, e, n) {
                    if (t = +t,
                    r = 0 | r,
                    !n) {
                        var i = Math.pow(2, 8 * e - 1);
                        C(this, t, r, e, i - 1, -i)
                    }
                    var o = e - 1
                      , f = 1
                      , u = 0;
                    for (this[r + o] = 255 & t; --o >= 0 && (f *= 256); )
                        0 > t && 0 === u && 0 !== this[r + o + 1] && (u = 1),
                        this[r + o] = (t / f >> 0) - u & 255;
                    return r + e
                }
                ,
                f.prototype.writeInt8 = function(t, r, e) {
                    return t = +t,
                    r = 0 | r,
                    e || C(this, t, r, 1, 127, -128),
                    f.TYPED_ARRAY_SUPPORT || (t = Math.floor(t)),
                    0 > t && (t = 255 + t + 1),
                    this[r] = 255 & t,
                    r + 1
                }
                ,
                f.prototype.writeInt16LE = function(t, r, e) {
                    return t = +t,
                    r = 0 | r,
                    e || C(this, t, r, 2, 32767, -32768),
                    f.TYPED_ARRAY_SUPPORT ? (this[r] = 255 & t,
                    this[r + 1] = t >>> 8) : O(this, t, r, !0),
                    r + 2
                }
                ,
                f.prototype.writeInt16BE = function(t, r, e) {
                    return t = +t,
                    r = 0 | r,
                    e || C(this, t, r, 2, 32767, -32768),
                    f.TYPED_ARRAY_SUPPORT ? (this[r] = t >>> 8,
                    this[r + 1] = 255 & t) : O(this, t, r, !1),
                    r + 2
                }
                ,
                f.prototype.writeInt32LE = function(t, r, e) {
                    return t = +t,
                    r = 0 | r,
                    e || C(this, t, r, 4, 2147483647, -2147483648),
                    f.TYPED_ARRAY_SUPPORT ? (this[r] = 255 & t,
                    this[r + 1] = t >>> 8,
                    this[r + 2] = t >>> 16,
                    this[r + 3] = t >>> 24) : M(this, t, r, !0),
                    r + 4
                }
                ,
                f.prototype.writeInt32BE = function(t, r, e) {
                    return t = +t,
                    r = 0 | r,
                    e || C(this, t, r, 4, 2147483647, -2147483648),
                    0 > t && (t = 4294967295 + t + 1),
                    f.TYPED_ARRAY_SUPPORT ? (this[r] = t >>> 24,
                    this[r + 1] = t >>> 16,
                    this[r + 2] = t >>> 8,
                    this[r + 3] = 255 & t) : M(this, t, r, !1),
                    r + 4
                }
                ,
                f.prototype.writeFloatLE = function(t, r, e) {
                    return N(this, t, r, !0, e)
                }
                ,
                f.prototype.writeFloatBE = function(t, r, e) {
                    return N(this, t, r, !1, e)
                }
                ,
                f.prototype.writeDoubleLE = function(t, r, e) {
                    return F(this, t, r, !0, e)
                }
                ,
                f.prototype.writeDoubleBE = function(t, r, e) {
                    return F(this, t, r, !1, e)
                }
                ,
                f.prototype.copy = function(t, r, e, n) {
                    if (e || (e = 0),
                    n || 0 === n || (n = this.length),
                    r >= t.length && (r = t.length),
                    r || (r = 0),
                    n > 0 && e > n && (n = e),
                    n === e)
                        return 0;
                    if (0 === t.length || 0 === this.length)
                        return 0;
                    if (0 > r)
                        throw new RangeError("targetStart out of bounds");
                    if (0 > e || e >= this.length)
                        throw new RangeError("sourceStart out of bounds");
                    if (0 > n)
                        throw new RangeError("sourceEnd out of bounds");
                    n > this.length && (n = this.length),
                    t.length - r < n - e && (n = t.length - r + e);
                    var i, o = n - e;
                    if (this === t && r > e && n > r)
                        for (i = o - 1; i >= 0; i--)
                            t[i + r] = this[i + e];
                    else if (1e3 > o || !f.TYPED_ARRAY_SUPPORT)
                        for (i = 0; o > i; i++)
                            t[i + r] = this[i + e];
                    else
                        Uint8Array.prototype.set.call(t, this.subarray(e, e + o), r);
                    return o
                }
                ,
                f.prototype.fill = function(t, r, e, n) {
                    if ("string" == typeof t) {
                        if ("string" == typeof r ? (n = r,
                        r = 0,
                        e = this.length) : "string" == typeof e && (n = e,
                        e = this.length),
                        1 === t.length) {
                            var i = t.charCodeAt(0);
                            256 > i && (t = i)
                        }
                        if (void 0 !== n && "string" != typeof n)
                            throw new TypeError("encoding must be a string");
                        if ("string" == typeof n && !f.isEncoding(n))
                            throw new TypeError("Unknown encoding: " + n)
                    } else
                        "number" == typeof t && (t = 255 & t);
                    if (0 > r || this.length < r || this.length < e)
                        throw new RangeError("Out of range index");
                    if (r >= e)
                        return this;
                    r >>>= 0,
                    e = void 0 === e ? this.length : e >>> 0,
                    t || (t = 0);
                    var o;
                    if ("number" == typeof t)
                        for (o = r; e > o; o++)
                            this[o] = t;
                    else {
                        var u = f.isBuffer(t) ? t : V(new f(t,n).toString())
                          , a = u.length;
                        for (o = 0; e - r > o; o++)
                            this[o + r] = u[o % a]
                    }
                    return this
                }
                ;
                var tt = /[^+\/0-9A-Za-z-_]/g
            }
            ).call(this, "undefined" != typeof global ? global : "undefined" != typeof self ? self : "undefined" != typeof window ? window : {})
        }
        , {
            "base64-js": 24,
            ieee754: 27,
            isarray: 25
        }],
        24: [function(t, r, e) {
            "use strict";
            function n() {
                for (var t = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/", r = 0, e = t.length; e > r; ++r)
                    a[r] = t[r],
                    s[t.charCodeAt(r)] = r;
                s["-".charCodeAt(0)] = 62,
                s["_".charCodeAt(0)] = 63
            }
            function i(t) {
                var r, e, n, i, o, f, u = t.length;
                if (u % 4 > 0)
                    throw new Error("Invalid string. Length must be a multiple of 4");
                o = "=" === t[u - 2] ? 2 : "=" === t[u - 1] ? 1 : 0,
                f = new c(3 * u / 4 - o),
                n = o > 0 ? u - 4 : u;
                var a = 0;
                for (r = 0,
                e = 0; n > r; r += 4,
                e += 3)
                    i = s[t.charCodeAt(r)] << 18 | s[t.charCodeAt(r + 1)] << 12 | s[t.charCodeAt(r + 2)] << 6 | s[t.charCodeAt(r + 3)],
                    f[a++] = i >> 16 & 255,
                    f[a++] = i >> 8 & 255,
                    f[a++] = 255 & i;
                return 2 === o ? (i = s[t.charCodeAt(r)] << 2 | s[t.charCodeAt(r + 1)] >> 4,
                f[a++] = 255 & i) : 1 === o && (i = s[t.charCodeAt(r)] << 10 | s[t.charCodeAt(r + 1)] << 4 | s[t.charCodeAt(r + 2)] >> 2,
                f[a++] = i >> 8 & 255,
                f[a++] = 255 & i),
                f
            }
            function o(t) {
                return a[t >> 18 & 63] + a[t >> 12 & 63] + a[t >> 6 & 63] + a[63 & t]
            }
            function f(t, r, e) {
                for (var n, i = [], f = r; e > f; f += 3)
                    n = (t[f] << 16) + (t[f + 1] << 8) + t[f + 2],
                    i.push(o(n));
                return i.join("")
            }
            function u(t) {
                for (var r, e = t.length, n = e % 3, i = "", o = [], u = 16383, s = 0, c = e - n; c > s; s += u)
                    o.push(f(t, s, s + u > c ? c : s + u));
                return 1 === n ? (r = t[e - 1],
                i += a[r >> 2],
                i += a[r << 4 & 63],
                i += "==") : 2 === n && (r = (t[e - 2] << 8) + t[e - 1],
                i += a[r >> 10],
                i += a[r >> 4 & 63],
                i += a[r << 2 & 63],
                i += "="),
                o.push(i),
                o.join("")
            }
            e.toByteArray = i,
            e.fromByteArray = u;
            var a = []
              , s = []
              , c = "undefined" != typeof Uint8Array ? Uint8Array : Array;
            n()
        }
        , {}],
        25: [function(t, r, e) {
            var n = {}.toString;
            r.exports = Array.isArray || function(t) {
                return "[object Array]" == n.call(t)
            }
        }
        , {}],
        26: [function(t, r, e) {
            function n() {
                return this instanceof n ? void 0 : new n
            }
            !function(t) {
                function e(t) {
                    for (var r in s)
                        t[r] = s[r];
                    return t
                }
                function n(t, r) {
                    return u(this, t).push(r),
                    this
                }
                function i(t, r) {
                    function e() {
                        o.call(n, t, e),
                        r.apply(this, arguments)
                    }
                    var n = this;
                    return e.originalListener = r,
                    u(n, t).push(e),
                    n
                }
                function o(t, r) {
                    function e(t) {
                        return t !== r && t.originalListener !== r
                    }
                    var n, i = this;
                    if (arguments.length) {
                        if (r) {
                            if (n = u(i, t, !0)) {
                                if (n = n.filter(e),
                                !n.length)
                                    return o.call(i, t);
                                i[a][t] = n
                            }
                        } else if (n = i[a],
                        n && (delete n[t],
                        !Object.keys(n).length))
                            return o.call(i)
                    } else
                        delete i[a];
                    return i
                }
                function f(t, r) {
                    function e(t) {
                        t.call(o)
                    }
                    function n(t) {
                        t.call(o, r)
                    }
                    function i(t) {
                        t.apply(o, s)
                    }
                    var o = this
                      , f = u(o, t, !0);
                    if (!f)
                        return !1;
                    var a = arguments.length;
                    if (1 === a)
                        f.forEach(e);
                    else if (2 === a)
                        f.forEach(n);
                    else {
                        var s = Array.prototype.slice.call(arguments, 1);
                        f.forEach(i)
                    }
                    return !!f.length
                }
                function u(t, r, e) {
                    if (!e || t[a]) {
                        var n = t[a] || (t[a] = {});
                        return n[r] || (n[r] = [])
                    }
                }
                "undefined" != typeof r && (r.exports = t);
                var a = "listeners"
                  , s = {
                    on: n,
                    once: i,
                    off: o,
                    emit: f
                };
                e(t.prototype),
                t.mixin = e
            }(n)
        }
        , {}],
        27: [function(t, r, e) {
            e.read = function(t, r, e, n, i) {
                var o, f, u = 8 * i - n - 1, a = (1 << u) - 1, s = a >> 1, c = -7, h = e ? i - 1 : 0, p = e ? -1 : 1, l = t[r + h];
                for (h += p,
                o = l & (1 << -c) - 1,
                l >>= -c,
                c += u; c > 0; o = 256 * o + t[r + h],
                h += p,
                c -= 8)
                    ;
                for (f = o & (1 << -c) - 1,
                o >>= -c,
                c += n; c > 0; f = 256 * f + t[r + h],
                h += p,
                c -= 8)
                    ;
                if (0 === o)
                    o = 1 - s;
                else {
                    if (o === a)
                        return f ? NaN : (l ? -1 : 1) * (1 / 0);
                    f += Math.pow(2, n),
                    o -= s
                }
                return (l ? -1 : 1) * f * Math.pow(2, o - n)
            }
            ,
            e.write = function(t, r, e, n, i, o) {
                var f, u, a, s = 8 * o - i - 1, c = (1 << s) - 1, h = c >> 1, p = 23 === i ? Math.pow(2, -24) - Math.pow(2, -77) : 0, l = n ? 0 : o - 1, d = n ? 1 : -1, y = 0 > r || 0 === r && 0 > 1 / r ? 1 : 0;
                for (r = Math.abs(r),
                isNaN(r) || r === 1 / 0 ? (u = isNaN(r) ? 1 : 0,
                f = c) : (f = Math.floor(Math.log(r) / Math.LN2),
                r * (a = Math.pow(2, -f)) < 1 && (f--,
                a *= 2),
                r += f + h >= 1 ? p / a : p * Math.pow(2, 1 - h),
                r * a >= 2 && (f++,
                a /= 2),
                f + h >= c ? (u = 0,
                f = c) : f + h >= 1 ? (u = (r * a - 1) * Math.pow(2, i),
                f += h) : (u = r * Math.pow(2, h - 1) * Math.pow(2, i),
                f = 0)); i >= 8; t[e + l] = 255 & u,
                l += d,
                u /= 256,
                i -= 8)
                    ;
                for (f = f << i | u,
                s += i; s > 0; t[e + l] = 255 & f,
                l += d,
                f /= 256,
                s -= 8)
                    ;
                t[e + l - d] |= 128 * y
            }
        }
        , {}],
        28: [function(t, r, e) {
            (function(t) {
                var r, n;
                !function(e) {
                    function i(t, r, e, n, i) {
                        if (m && x && (r instanceof x && (r = new m(r)),
                        n instanceof x && (n = new m(n))),
                        !(r || e || n || y))
                            return void (t.buffer = s(B, 0));
                        if (!o(r, e)) {
                            var a = y || Array;
                            i = e,
                            n = r,
                            e = 0,
                            r = new a(8)
                        }
                        t.buffer = r,
                        t.offset = e |= 0,
                        "undefined" != typeof n && ("string" == typeof n ? u(r, e, n, i || 10) : o(n, i) ? f(r, e, n, i) : "number" == typeof i ? (h(r, e, n),
                        h(r, e + 4, i)) : n > 0 ? p(r, e, n) : 0 > n ? l(r, e, n) : f(r, e, B, 0))
                    }
                    function o(t, r) {
                        var e = t && t.length;
                        return r |= 0,
                        e && e >= r + 8 && "string" != typeof t[r]
                    }
                    function f(t, r, e, n) {
                        r |= 0,
                        n |= 0;
                        for (var i = 0; 8 > i; i++)
                            t[r++] = 255 & e[n++]
                    }
                    function u(t, r, e, n) {
                        var i = 0
                          , o = e.length
                          , f = 0
                          , u = 0;
                        "-" === e[0] && i++;
                        for (var a = i; o > i; ) {
                            var s = parseInt(e[i++], n);
                            if (!(s >= 0))
                                break;
                            u = u * n + s,
                            f = f * n + Math.floor(u / P),
                            u %= P
                        }
                        a && (f = ~f,
                        u ? u = P - u : f++),
                        h(t, r, f),
                        h(t, r + 4, u)
                    }
                    function a(t, r, e, n) {
                        var i = ""
                          , o = c(t, r)
                          , f = c(t, r + 4)
                          , u = n && 2147483648 & o;
                        for (u && (o = ~o,
                        f = P - f),
                        e = e || 10; ; ) {
                            var a = o % e * P + f;
                            if (o = Math.floor(o / e),
                            f = Math.floor(a / e),
                            i = (a % e).toString(e) + i,
                            !o && !f)
                                break
                        }
                        return u && (i = "-" + i),
                        i
                    }
                    function s(t, r) {
                        return Array.prototype.slice.call(t, r, r + 8)
                    }
                    function c(t, r) {
                        return t[r++] * R + (t[r++] << 16) + (t[r++] << 8) + t[r]
                    }
                    function h(t, r, e) {
                        t[r + 3] = 255 & e,
                        e >>= 8,
                        t[r + 2] = 255 & e,
                        e >>= 8,
                        t[r + 1] = 255 & e,
                        e >>= 8,
                        t[r] = 255 & e
                    }
                    function p(t, r, e) {
                        for (var n = r + 7; n >= r; n--)
                            t[n] = 255 & e,
                            e /= 256
                    }
                    function l(t, r, e) {
                        e++;
                        for (var n = r + 7; n >= r; n--)
                            t[n] = 255 & -e ^ 255,
                            e /= 256
                    }
                    function d(t) {
                        return !!t && "[object Array]" == Object.prototype.toString.call(t)
                    }
                    var y, g = e.Uint64BE = r = function(t, e, n, o) {
                        return this instanceof r ? i(this, t, e, n, o) : new r(t,e,n,o)
                    }
                    , v = e.Int64BE = n = function(t, r, e, o) {
                        return this instanceof n ? i(this, t, r, e, o) : new n(t,r,e,o)
                    }
                    , w = g.prototype, E = v.prototype, b = "undefined", A = b !== typeof t && t, m = b !== typeof Uint8Array && Uint8Array, x = b !== typeof ArrayBuffer && ArrayBuffer, B = [0, 0, 0, 0, 0, 0, 0, 0], U = Array.isArray || d, P = 4294967296, R = 16777216;
                    w.buffer = E.buffer = void 0,
                    w.offset = E.offset = 0,
                    w._isUint64BE = E._isInt64BE = !0,
                    g.isUint64BE = function(t) {
                        return !(!t || !t._isUint64BE)
                    }
                    ,
                    v.isInt64BE = function(t) {
                        return !(!t || !t._isInt64BE)
                    }
                    ,
                    w.toNumber = function() {
                        var t = this.buffer
                          , r = this.offset
                          , e = c(t, r)
                          , n = c(t, r + 4);
                        return e ? e * P + n : n
                    }
                    ,
                    E.toNumber = function() {
                        var t = this.buffer
                          , r = this.offset
                          , e = 0 | c(t, r)
                          , n = c(t, r + 4);
                        return e ? e * P + n : n
                    }
                    ,
                    w.toArray = E.toArray = function(t) {
                        var r = this.buffer
                          , e = this.offset;
                        return y = null,
                        t !== !1 && 0 === e && 8 === r.length && U(r) ? r : s(r, e)
                    }
                    ,
                    A && (w.toBuffer = E.toBuffer = function(r) {
                        var e = this.buffer
                          , n = this.offset;
                        if (y = A,
                        r !== !1 && 0 === n && 8 === e.length && t.isBuffer(e))
                            return e;
                        var i = new A(8);
                        return f(i, 0, e, n),
                        i
                    }
                    ),
                    m && (w.toArrayBuffer = E.toArrayBuffer = function(t) {
                        var r = this.buffer
                          , e = this.offset
                          , n = r.buffer;
                        if (y = m,
                        t !== !1 && 0 === e && n instanceof x && 8 === n.byteLength)
                            return n;
                        var i = new m(8);
                        return f(i, 0, r, e),
                        i.buffer
                    }
                    ),
                    E.toString = function(t) {
                        return a(this.buffer, this.offset, t, !0)
                    }
                    ,
                    w.toString = function(t) {
                        return a(this.buffer, this.offset, t, !1)
                    }
                    ,
                    w.toJSON = w.toNumber,
                    E.toJSON = E.toNumber
                }("object" == typeof e && "string" != typeof e.nodeName ? e : this || {})
            }
            ).call(this, t("buffer").Buffer)
        }
        , {
            buffer: 23
        }],
        29: [function(t, r, e) {
            arguments[4][25][0].apply(e, arguments)
        }
        , {
            dup: 25
        }]
    }, {}, [1])(1)
});

/* file: script/shim.js */

/* file: script/Utils.js */

Math.TAU = Math.PI * 2;
Math.HPI = Math.PI / 2;
Math.QPI = Math.PI / 4;

Utils = {

    hash: function(string) {

        var hash = 0, i, chr;

        if (string.length === 0)
            return hash;

        for (i = 0; i < string.length; i++) {
            chr = string.charCodeAt(i);
            hash = ((hash << 5) - hash) + chr;
            hash |= 0;
            // Convert to 32bit integer
        }

        return hash;

    },

    promise() {

        let resolve, reject;

        let promise = new Promise(function(_resolve, _reject) {

            resolve = _resolve;
            reject = _reject;

        }
        );

        promise.resolve = resolve;
        promise.reject = reject;

        return promise;

    },

    fix2(f) {

        return Math.floor(f * 100) / 100;

    },

    dcopy: function(o) {

        return JSON.parse(JSON.stringify(o));

    },

    escapeHTML: function(s) {
        return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    },

    unescapeHTML: function(s) {
        return s.replace('&amp;', '&').replace('&quot;', '"').replace('&lt;', "<").replace('&gt;', ">");
    },

    captureTrace: function() {

        try {

            throw new Error();

        } catch (e) {

            return JSON.stringify(e.stack, null, 2);

        }

    },

    ucfirst: function(str) {

        return str[0].toUpperCase() + str.slice(1);

    },

    dirrow: function(direction, angles) {

        angles = angles || 16;

        var fo = -0.5 * Math.TAU / angles;

        return (Utils.circWrap(direction - fo) / Math.TAU) * angles | 0;

    },

    tryParseJSON: function(json) {

        try {

            return JSON.parse(json);

        } catch (e) {

            return null;

        }

    },

    repeatInterval: function(callback, times, interval) {

        callback();

        var counter = 1;

        if (counter >= times)
            return;

        var timer = setInterval(function() {

            callback(counter++);

            if (counter >= times) {

                clearInterval(timer);

            }
            ;

        }, interval * 1000);

    },

    create: function(prototype, args) {

        var object = Object.create(prototype);

        return this.extend(object, args);

    },

    strTemplate: function(str, obj) {

        return str.replace(/{(\w+)}/g, function(_, k) {
            return obj[k];
        });

    },

    urlTemplate: function(template, data) {

        for (var key in data) {

            var value = encodeURIComponent(data[key]);

            template = template.replace("{" + key + "}", value);

        }

        return template;

    },

    /* extend existing properties */

    existend: function() {

        var result = Object.assign({}, arguments[0]);

        for (var key in result) {

            for (var i = 1; i < arguments.length; i++) {

                if (!arguments[i])
                    continue;

                var value = arguments[i][key];

                if (value !== undefined)
                    result[key] = value;

            }

        }

        return result;

    },

    cycle: function(array) {

        array.push(array.shift());

        return array[0];

    },

    distance: function(x1, y1, x2, y2) {

        if (arguments.length > 2) {

            var dx = x1 - x2;
            var dy = y1 - y2;

            return Math.sqrt(dx * dx + dy * dy);

        } else {

            var dx = x1.x - y1.x;
            var dy = x1.y - y1.y;

            return Math.sqrt(dx * dx + dy * dy);

        }

    },

    distance2: function(x1, y1, x2, y2) {

        if (arguments.length > 2) {

            var dx = x1 - x2;
            var dy = y1 - y2;

            return dx * dx + dy * dy;

        } else {

            var dx = x1.x - y1.x;
            var dy = x1.y - y1.y;

            return dx * dx + dy * dy;

        }

    },

    limit: function(value, min, max) {

        return value < min ? min : value > max ? max : value;

    },

    nearest: function(from, entities) {

        var min = -1;
        var result = null;

        for (var i = 0; i < entities.length; i++) {

            var to = entities[i];

            if (from === to)
                continue;

            var distance = this.distance(from, to);

            if (distance < min || min < 0) {
                min = distance;
                result = to;
            }

        }

        return result;
    },

    sign: function(value) {

        return value == 0 ? 0 : value / Math.abs(value);

    },

    sincos: function(angle, radius) {

        if (arguments.length === 1) {
            var a = Math.random() * 6.28;

            return {
                x: Math.cos(a) * angle,
                y: Math.sin(a) * angle
            };

        } else {

            return {
                x: Math.cos(angle) * radius,
                y: Math.sin(angle) * radius
            };

        }

    },

    ground: function(num, threshold) {

        return (num / threshold | 0) * threshold;

    },

    groundAngle: function(direction, angles) {

        angles = angles || 8;

        var fo = -0.5 * Math.TAU / angles;

        return Utils.ground(direction - fo, Math.TAU / angles);

    },

    rotate: function(pointX, pointY, originX, originY, angle) {

        return [originX + (pointX - originX) * Math.cos(angle) - (pointY - originY) * Math.sin(angle), originY + (pointX - originX) * Math.sin(angle) + (pointY - originY) * Math.cos(angle)];

    },

    pointInRect: function(x, y, rx, ry, rw, rh) {

        return !(x < rx || y < ry || x >= rx + rw || y >= ry + rh);

    },

    pointInEllipse: function(test, center, width, height) {

        dx = test.x - center.x
        dy = test.y - center.y

        return (dx * dx) / (width * width) + (dy * dy) / (height * height) <= 1;

    },

    rectInRect: function(r1x, r1y, r1w, r1h, r2x, r2y, r2w, r2h) {

        return !(r2x > r1x + r1w || r2x + r2w < r1x || r2y > r1y + r1h || r2y + r2h < r1y);

    },

    pointInRotatedRect: function(pointX, pointY, rectX, rectY, rectWidth, rectHeight, rotation) {

        var x = rectX + (pointX - rectX) * Math.cos(-rotation) - (pointY - rectY) * Math.sin(-rotation);
        var y = rectY + (pointX - rectX) * Math.sin(-rotation) + (pointY - rectY) * Math.cos(-rotation);

        return this.pointInRect(x, y, rectX - rectWidth / 2, rectY - rectHeight / 2, rectWidth, rectHeight);

    },

    quickPointInRange: function(ax, ay, bx, by, range) {

        if (Math.abs(ax - bx) > range)
            return false;
        if (Math.abs(ay - by) > range)
            return false;

        return true;

    },

    inRange: function(a, b, c, d, e=1) {

        if (arguments.length > 3) {

            var dx = a - c;
            var dy = b - d;

            return dx * dx + dy * dy < e * e;

        } else {

            var dx = a.x - b.x;
            var dy = a.y - b.y;

            return dx * dx + dy * dy < c * c;

        }

    },

    quickDistance: function(ax, ay, bx, by) {

        if (arguments.length === 2) {

            return Math.max(Math.abs(ax.x - ay.x), Math.abs(ax.y - ay.y));

        } else {

            return Math.max(Math.abs(ax - bx), Math.abs(ay - by));

        }

    },

    /* https://github.com/substack/point-in-polygon */

    pointInPolygon: function(x, y, vertices) {

        var inside = false;

        for (var i = 0, j = vertices.length - 1; i < vertices.length; j = i++) {
            var xi = vertices[i][0]
              , yi = vertices[i][1];
            var xj = vertices[j][0]
              , yj = vertices[j][1];

            var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect)
                inside = !inside;
        }

        return inside;

    },

    atan2: function(y, x) {

        if (y === 0 && x === 0)
            return 0;

        var r;

        var ax = Math.abs(x);
        var ay = Math.abs(y);

        var a = Math.min(ax, ay) / Math.max(ax, ay);
        var s = a * a;

        r = ((-0.0464964749 * s + 0.15931422) * s - 0.327622764) * s * a + a

        if (ay > ax)
            r = 1.57079637 - r;
        if (x < 0)
            r = 3.14159274 - r;
        if (y < 0)
            r = -r;

        return r;

    },

    lookAt: function(a, b, c, d) {

        if (arguments.length > 2) {

            var angle = this.atan2(d - b, c - a);
            if (angle < 0)
                angle = Math.PI * 2 + angle;

        } else {

            var angle = this.atan2(b.y - a.y, b.x - a.x);
            if (angle < 0)
                angle = Math.PI * 2 + angle;

        }

        return angle;

    },

    atanxy: function(x, y) {

        var angle = Math.atan2(y, x);
        if (angle < 0)
            angle = Math.PI * 2 + angle;

        return angle;

    },

    moveTo: function(value, target, step) {

        if (value < target) {
            value += step;
            if (value > target)
                value = target;
        }

        if (value > target) {
            value -= step;
            if (value < target)
                value = target;
        }

        return value;

    },

    circWrap: function(val) {

        if (val >= Math.PI * 2)
            val -= Math.PI * 2;
        else if (val < 0)
            val += Math.PI * 2;

        return val;

    },

    wrap: function(value, min, max) {

        if (value < min) {

            return max + (value - min);

        }

        if (value >= max) {

            return min + (value - max);

        }

        return value;

    },

    wrapTo: function(value, target, max, step) {

        if (value === target)
            return target;

        var result = value;

        var d = this.wrappedDistance(value, target, max);

        if (Math.abs(d) < step)
            return target;

        result += (d < 0 ? -1 : 1) * step;

        if (result > max) {

            result = result - max;

        } else if (result < 0) {

            result = max + result;

        }

        return result;

    },

    circWrapTo: function(value, target, step) {

        return this.wrapTo(value, target, Math.PI * 2, step);

    },

    circDistance: function(a, b) {

        return this.wrappedDistance(a, b, Math.PI * 2);

    },

    circDistanceAbs: function(a, b) {

        return Math.abs(this.wrappedDistance(a, b, Math.PI * 2));

    },

    circDistanceFactor: function(a, b) {

        return Math.abs(this.wrappedDistance(a, b, Math.PI * 2)) / Math.PI;

    },

    wrappedDistance: function(a, b, max) {

        if (a === b)
            return 0;
        else if (a < b) {
            var l = -a - max + b;
            var r = b - a;
        } else {
            var l = b - a;
            var r = max - a + b;
        }

        if (Math.abs(l) > Math.abs(r))
            return r;
        else
            return l;

    },

    randomPolygon: function(vertices, scale) {

        var angleStep = Math.PI * 2 / vertices;

        var polygon = [];

        var angleOffset = Math.PI * 2 * Math.random();

        for (var i = 0; i < vertices; i++) {

            var angle = angleOffset + i * angleStep - Math.random() * angleStep * 0.5;
            var r = 0.5 + Math.random() * 0.5;
            var x = Math.cos(angle) * r;
            var y = Math.sin(angle) * r;

            polygon.push([x * scale, y * scale]);

        }

        return polygon;

    },

    seed: function(value) {

        var seed = value;

        for (var i = 0; i < (value % 1000); i++)
            seed = (seed * 9301 + 49297) % 233280;

        return seed / 233280;

    },

    randomf: function(a, b) {

        return a + (b - a) * Math.random();

    },

    random: function(a, b) {

        if (a === undefined) {
            return Math.random();
        } else if (b !== undefined) {
            return Math.floor(a + Math.random() * Math.abs(b - a + 1));
        } else {
            if (a instanceof Array)
                return a[(a.length + 1) * Math.random() - 1 | 0];
            else {
                return a[this.random(Object.keys(a))];
            }
        }

    },

    randomSign: function() {

        return Math.random() > 0.5 ? -1 : 1;

    },

    signedRandom: function(max) {

        return Math.random() * max * (Math.random() > 0.5 ? -1 : 1);

    },

    /* http://keith-hair.net/blog/2008/08/05/line-to-circle-intersection-data/ */

    interpolatePoints: function(ax, ay, bx, by, f) {

        return [f * ax + (1 - f) * bx, f * ay + (1 - f) * by];
    },

    lineCircleIntersection: function(ax, ay, bx, by, cx, cy, r) {

        var result = {
            inside: false,
            tangent: false,
            intersects: false,
            enter: null,
            exit: null
        };

        var a = (bx - ax) * (bx - ax) + (by - ay) * (by - ay);
        var b = 2 * ((bx - ax) * (ax - cx) + (by - ay) * (ay - cy));
        var cc = cx * cx + cy * cy + ax * ax + ay * ay - 2 * (cx * ax + cy * ay) - r * r;
        var deter = b * b - 4 * a * cc;

        result.distance = Math.sqrt(a);

        if (deter <= 0) {
            result.inside = false;
        } else {
            var e = Math.sqrt(deter);
            var u1 = (-b + e) / (2 * a);
            var u2 = (-b - e) / (2 * a);
            if ((u1 < 0 || u1 > 1) && (u2 < 0 || u2 > 1)) {
                if ((u1 < 0 && u2 < 0) || (u1 > 1 && u2 > 1)) {
                    result.inside = false;
                } else {
                    result.inside = true;
                }
            } else {

                if (0 <= u2 && u2 <= 1) {
                    result.enter = this.interpolatePoints(ax, ay, bx, by, 1 - u2);
                }
                if (0 <= u1 && u1 <= 1) {
                    result.exit = this.interpolatePoints(ax, ay, bx, by, 1 - u1);
                }
                result.intersects = true;
                if (result.exit != null && result.enter != null && result.exit[0] == result.enter[0] && result.exit[1] == result.enter[1]) {
                    result.tangent = true;
                }
            }
        }

        return result.intersects ? result : false;

    },

    lineCircleCollision: function(ax, ay, bx, by, cx, cy, r) {

        var result = false;

        var a = (bx - ax) * (bx - ax) + (by - ay) * (by - ay);
        var b = 2 * ((bx - ax) * (ax - cx) + (by - ay) * (ay - cy));
        var cc = cx * cx + cy * cy + ax * ax + ay * ay - 2 * (cx * ax + cy * ay) - r * r;
        var deter = b * b - 4 * a * cc;

        if (deter <= 0) {
        } else {
            var e = Math.sqrt(deter);
            var u1 = (-b + e) / (2 * a);
            var u2 = (-b - e) / (2 * a);

            if ((u1 < 0 || u1 > 1) && (u2 < 0 || u2 > 1)) {
            } else {
                result = true;
            }
        }

        return result;

    },

    repulse: function(a, b, radius) {

        var angle = this.lookAt(b, a);

        a.x = b.x + Math.cos(angle) * radius;
        a.y = b.y + Math.sin(angle) * radius;

    },

    interval: function(object, key, interval) {

        if (!object.throttles)
            object.throttles = {};
        if (!object.throttles[key])
            object.throttles[key] = -interval;

        if (object.lifetime - object.throttles[key] >= interval) {

            object.throttles[key] = object.lifetime;

            return true;

        } else
            return false;

    },

    intervalRange: function(object, key, min, max) {

        if (!object.throttles)
            object.throttles = {};
        if (!object.throttles[key])
            object.throttles[key] = object.lifetime - max;

        if (object.throttles[key] - object.lifetime <= 0) {

            object.throttles[key] = object.lifetime + Utils.randomf(min, max);

            return true;

        } else
            return false;

    },

    onceAfter: function(key, wait, object) {

        if (!object.onceAfters)
            object.onceAfters = {};
        if (!object.onceAfters[key])
            object.onceAfters[key] = object.lifetime - wait;

        if (object.lifetime - object.onceAfters[key] >= wait) {
            object.onceAfters[key] = object.lifetime;
            return true;
        } else {
            object.onceAfters[key] = object.lifetime;
            return false;
        }

    },

    /* game specific */

    updateBox: function(e, radius) {

        if (!e.box)
            e.box = [];

        e.box[0] = e.x - radius;
        e.box[1] = e.y - radius;
        e.box[2] = radius * 2;
        e.box[3] = radius * 2;
    },

    saw: function(t) {

        if (t < 0.5) {
            return t / 0.5;
        } else {
            return 1 - (t - 0.5) / 0.5;
        }

    },

    vecNormalize: function(v) {

        var d = Math.sqrt(v[0] * v[0] + v[1] * v[1]);

        return [v[0] / d, v[1] / d];

    },

    vecDot: function(a, b) {

        return a[0] * b[0] + a[1] * b[1];

    },

    vecSub: function(a, b) {

        return [a[0] - b[0], a[1] - b[1]];

    },

    getDirectionKey: function(direction) {

        if (direction === 0)
            return "right";
        else if (direction === Math.PI * 0.5)
            return "down";
        else if (direction === Math.PI * 1.0)
            return "left";
        else if (direction === Math.PI * 1.5)
            return "up";

    },

    offsetToDirectionKey: function(ox, oy) {

        if (ox < 0)
            return "left";
        if (ox > 0)
            return "right";
        if (oy < 0)
            return "up";
        if (oy > 0)
            return "down";

    },

    minValue: function(collection, test) {

        var min = false;

        if (collection instanceof Array) {

            for (var i = 0; i < collection.length; i++) {

                var value = test(collection[i]);

                if (min === false || value < min)
                    min = value;

            }

        } else {

            for (var key in collection) {

                var value = test(collection[key]);

                if (min === false || value < min)
                    min = value;

            }

        }

        return min;

    },

    maxValue: function(collection, test) {

        var max = false;

        if (collection instanceof Array) {

            for (var i = 0; i < collection.length; i++) {

                var value = test(collection[i]);

                if (max === false || value > max)
                    max = value;

            }

        } else {

            for (var key in collection) {

                var value = test(collection[key]);

                if (max === false || value > max)
                    max = value;

            }

        }

        return max;

    },

    darkerCache: {},

    darker: function(color) {

        if (!this.darkerCache[color]) {

            this.darkerCache[color] = cq.color(color).shiftHsl(-0.05, -0.1, -0.2).toHex();

        }

        return this.darkerCache[color];

    },

    /* grid functions */

    gnearest: function(from, entities) {

        var min = -1;
        var result = null;

        for (var i = 0; i < entities.length; i++) {

            var to = entities[i];

            if (from === to)
                continue;

            var distance = this.distance(from, to);

            if (distance < min || min < 0) {
                min = distance;
                result = to;
            }

        }

        return result;
    },

    gdistance: function(x1, y1, x2, y2) {

        if (arguments.length > 2) {

            var dx = x1 - x2;
            var dy = y1 - y2;

            return Math.sqrt(dx * dx + dy * dy);

        } else {

            var dx = x1.gx - y1.gx;
            var dy = x1.gy - y1.gy;

            return Math.sqrt(dx * dx + dy * dy);

        }

    },

    smhd: function(s=0, m=0, h=0, d=0) {

        return s * 1000 + m * 60 * 1000 + h * 60 * 60 * 1000 + d * 24 * 60 * 60 * 1000;

    },

    xget: function(url, object, callback) {

        callback = callback || function() {}
        ;

        return new Promise(function(resolve, reject) {

            var request = new XMLHttpRequest();

            request.open("GET", url, true);

            request.onreadystatechange = function() {

                if (request.readyState != 4 || request.status != 200)
                    return;

                callback(false, request.responseText);

                resolve(request.responseText);

            }
            ;

            request.onerror = function() {
                callback(true);
                reject();
            }
            ;

            request.timeout = 5000;

            request.ontimeout = function() {

                callback(true);
                reject();

            }

            request.send();

        }
        );

    },

    xpost: function(url, object, callback) {

        callback = callback || function() {}
        ;

        return new Promise(function(resolve, reject) {

            var request = new XMLHttpRequest();

            request.open("POST", url, true);

            request.onreadystatechange = function() {

                if (request.readyState != 4 || request.status != 200)
                    return;

                if (callback)
                    callback(false, request.responseText);

                resolve(request.responseText);

            }
            ;

            request.onerror = function() {

                if (callback)
                    callback(true);

                reject();

            }
            ;

            request.timeout = 2000;

            request.ontimeout = function() {

                if (callback)
                    callback(true);

                reject();

            }

            /*      

                  var form_data = new FormData();

                  for (var key in object) {

                    form_data.append(key, object[key]);

                  }

            */

            request.send(JSON.stringify(object));

        }
        );

    },

    timer: function(callback, interval) {

        var lastTick = Date.now();

        var timer = setInterval(function() {

            var dt = (Date.now() - lastTick) / 1000;

            lastTick = Date.now();

            callback(dt);

        }, interval);

        return timer;

    },

    lzwEncode: function(s) {
        var dict = {};
        var data = (s + "").split("");
        var out = [];
        var currChar;
        var phrase = data[0];
        var code = 256;
        for (var i = 1; i < data.length; i++) {
            currChar = data[i];
            if (dict[phrase + currChar] != null) {
                phrase += currChar;
            } else {
                out.push(phrase.length > 1 ? dict[phrase] : phrase.charCodeAt(0));
                dict[phrase + currChar] = code;
                code++;
                phrase = currChar;
            }
        }
        out.push(phrase.length > 1 ? dict[phrase] : phrase.charCodeAt(0));
        for (var i = 0; i < out.length; i++) {
            out[i] = String.fromCharCode(out[i]);
        }
        return out.join("");
    },

    // Decompress an LZW-encoded string
    lzwDecode: function(s) {
        var dict = {};
        var data = (s + "").split("");
        var currChar = data[0];
        var oldPhrase = currChar;
        var out = [currChar];
        var code = 256;
        var phrase;
        for (var i = 1; i < data.length; i++) {
            var currCode = data[i].charCodeAt(0);
            if (currCode < 256) {
                phrase = data[i];
            } else {
                phrase = dict[currCode] ? dict[currCode] : (oldPhrase + currChar);
            }
            out.push(phrase);
            currChar = phrase.charAt(0);
            dict[code] = oldPhrase + currChar;
            code++;
            oldPhrase = phrase;
        }
        return out.join("");

    }

};

_.defaults(Utils, _);

Utils.filterKeys = function(object, filter) {

    var result = [];

    for (var key in object) {

        if (filter(object[key]))
            result.push(key);

    }

    return result;

}
;

Utils.filterObject = function(object, filter) {

    var result = {};

    for (var key in object) {

        if (filter(object[key]))
            result[key] = object[key];

    }

    return result;

}
;

Utils.filters = {

    hasTags: function() {

        var tags = Array.from(arguments);

        return function(object) {

            if (!object.tags)
                return false;

            for (var i = 0; i < tags.length; i++) {

                if (object.tags.indexOf(tags[i]) === -1)
                    return false;

            }

            return true;

        }

    }

};

/* file: common/common.js */

if (typeof window !== "undefined") {

    window.COMMON = {};

} else {

    global.COMMON = {};

}

COMMON.TEAM_COLORS = {

    0: {
        light: 0x8f563b,
        dark: 0x663931
    },
    1: {
        light: 0x9badb7,
        dark: 0x847e87
    },
    2: {
        light: 0x696a6a,
        dark: 0x595652
    },
    3: {
        light: 0xeec39a,
        dark: 0xd9a066
    },
    4: {
        light: 0xac3232,
        dark: 0x663931
    }

}

COMMON.MINER_MIN = 0.8;
COMMON.MINER_MAX = 0.5;

COMMON.INTERACTION_DISTANCE = 80;
COMMON.CITIZEN_SCALE = 0;

COMMON.FRIEND_COLOR = 0x37946e;
COMMON.ENEMY_COLOR = 0xaa0000;

COMMON.GOLD_CAP = 12000;

COMMON.SHARE_INTERVAL = 1 / 20;
COMMON.TWEEN_DURATION = COMMON.SHARE_INTERVAL * 1.5;
COMMON.MMR_PER_LEVEL = 30;

COMMON.OPERATE_TIMEOUT = 1.0;

COMMON.FALL_THRESHOLD = 0.3;
COMMON.FALLEN_PROTECTION = 0.0;

COMMON.TILE_WIDTH = 64;
COMMON.TILE_HEIGHT = 44;
COMMON.SUBTILE_WIDTH = COMMON.TILE_WIDTH / 4;
COMMON.SUBTILE_HEIGHT = COMMON.TILE_HEIGHT / 4;

COMMON.TILE_OFFSET_Y = 4;
COMMON.TILE_SOURCE_HEIGHT = 132;

COMMON.TORSO_LIMIT = Math.HPI - 0.1;
COMMON.TORSO_LIMIT = Math.PI;

COMMON.PLAYERS_PER_TEAM = 3;
COMMON.GAME_TIME = 10 * 60;

COMMON.innerBorder = 1400;
COMMON.outerBorder = 2000;

COMMON.FLAG_RIGHT = 1;
COMMON.FLAG_DOWN = 2;
COMMON.FLAG_LEFT = 4;
COMMON.FLAG_UP = 8;

COMMON.CAN_MOVE = 1;
COMMON.CAN_ROTATE = 2;
COMMON.CAN_ROLL = 4;
COMMON.CAN_USE_ITEMS = 8;

COMMON.RESPAWN_TIME = 1;

COMMON.COUNTRIES = ["ad", "ae", "af", "ag", "ai", "al", "am", "an", "ao", "ar", "as", "at", "au", "aw", "ax", "az", "ba", "bb", "bd", "be", "bf", "bg", "bh", "bi", "bj", "bm", "bn", "bo", "br", "bs", "bt", "bv", "bw", "by", "bz", "ca", "catalonia", "cc", "cd", "cf", "cg", "ch", "ci", "ck", "cl", "cm", "cn", "co", "cr", "cs", "cu", "cv", "cx", "cy", "cz", "de", "dj", "dk", "dm", "do", "dz", "ec", "ee", "eg", "eh", "england", "er", "es", "et", "europeanunion", "fam", "fi", "fj", "fk", "fm", "fo", "fr", "ga", "gb", "gd", "ge", "gf", "gh", "gi", "gl", "gm", "gn", "gp", "gq", "gr", "gs", "gt", "gu", "gw", "gy", "hk", "hm", "hn", "hr", "ht", "hu", "id", "ie", "il", "in", "io", "iq", "ir", "is", "it", "jm", "jo", "jp", "ke", "kg", "kh", "ki", "km", "kn", "kp", "kr", "kw", "ky", "kz", "la", "lb", "lc", "li", "lk", "lr", "ls", "lt", "lu", "lv", "ly", "ma", "mc", "md", "me", "mg", "mh", "mk", "ml", "mm", "mn", "mo", "mp", "mq", "mr", "ms", "mt", "mu", "mv", "mw", "mx", "my", "mz", "na", "nc", "ne", "nf", "ng", "ni", "nl", "no", "np", "nr", "nu", "nz", "om", "pa", "pe", "pf", "pg", "ph", "pk", "pl", "pm", "pn", "pr", "ps", "pt", "pw", "py", "qa", "re", "ro", "rs", "ru", "rw", "sa", "sb", "sc", "scotland", "sd", "se", "sg", "sh", "si", "sj", "sk", "sl", "sm", "sn", "so", "sr", "st", "sv", "sy", "sz", "tc", "td", "tf", "tg", "th", "tj", "tk", "tl", "tm", "tn", "to", "tr", "tt", "tv", "tw", "tz", "ua", "ug", "um", "us", "uy", "uz", "va", "vc", "ve", "vg", "vi", "vn", "vu", "wales", "wf", "ws", "ye", "yt", "za", "zm", "zw", "xx"];
COMMON.SHOP_COUNTRIES = ["US", "CA", "AT", "BE", "BG", "HR", "CY", "CZ", "DK", "EE", "FI", "FR", "DE", "GR", "HU", "IE", "IT", "LV", "LT", "LU", "MT", "NL", "PL", "PT", "RO", "SK", "SI", "ES", "SE", "GB", "TR", "JP", "KR", "RU", "BR"];

COMMON.ATTACK_NORMAL = 1;
COMMON.ATTACK_KICK = 3;
COMMON.ATTACK_ROLL = 4;

COMMON.facingOffset = [[1, 0], [1, 1], [0, 1], [-1, 1], [-1, 0], [-1, -1], [0, -1], [1, -1]];

COMMON.CW4 = [[-1, 0], [0, -1], [1, 0], [0, 1]];

COMMON.P2 = [1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096, 8192, 16384, 32768, 65536];

COMMON.SPECIAL_VERIFIED = 1;
COMMON.SPECIAL_ADMIN = 2;
COMMON.SPECIAL_BUILDER = 4;
COMMON.SPECIAL_PATRON = 8;

COMMON.MAX_LINKED_PLAYERS = 10;
COMMON.MAX_ARMOR = 6;

COMMON.RANKED_DAILY_REWARD = 100;
COMMON.RANKED_MAX_REWARD = 100;

COMMON.expTable = [0];

for (let i = 1; i < 100; i++) {

    COMMON.expTable.push(COMMON.expTable[i - 1] + i * (5 + i * 0.25) | 0);
}

COMMON.levelToExp = function(level) {

    return COMMON.expTable[level]

}
;

COMMON.expToLevel = function(exp) {

    for (let i = 0; i < 100; i++) {

        if (this.expTable[i] > exp)
            return i - 1;

    }

}
;

COMMON.modes = {};

COMMON.legsZ = [0, 0, 0.12697569202151154, 0.5555609039391696, 0.9148130001424937, 0.9759662767057457, 0.9759662767057457, 0.8774320490518326, 0.6621635047624876, 0.3537538161691129, 0.04154450834523172, 0, 0, 0.29563636715257974, 0.8015852396513293, 1, 1, 0.839389527701953, 0.4204586086644027, 0, 0];

COMMON.coinValue = {
    "gold_coin": 3,
    "silver_coin": 2,
    "bronze_coin": 1
};

COMMON.boneValue = {
    "bone_1": 1,
    "bone_2": 2,
    "bone_3": 3,
    "bone_4": 4
};

COMMON.modes.winter = {
    gameOverOnDeath: true,
    dropWeapons: true,
    houseMusic: "house_music",
    respawnNPC: true,
    countBones: true,
    removeDeadHeroBots: true,
    weather: ["snowing", "default"],
    temperature: true,
    king: true,
    background: "tile_snow",
    scoreKey: "bones",
    allowTeamChange: 2,
    allowGameLinks: true,
    bonesToScore: true,
    speed: 1.0,
    addKills: true,
    name: "Winter Sandbox",
    description: "It's a TEAM ARENA server. Folks of the same color are your team.",
    // map: "small_fort",
    allowRespawn: true,
    fun: true,
    showRespawnWindow: true,
    pedestals: false,
    quicksands: false,
    sandworms: 0,
    list: true,
    maxPlayers: 30,
    grow: true,
    resetScoreOnRespawn: true,
    controller: "Survival",
    eclipse: true,
    mapGenerator: true,
    mapGeneratorConfig: {
        padding: 3,
        width: 5400 / COMMON.TILE_WIDTH | 0,
        height: 5400 / COMMON.TILE_HEIGHT | 0,
        mainMap: "small_fort.json",
        max: 2,
        prefixToQuantity: {
            "_respawn": 8,
            "random_barbarian_settlement": 1,

        },
        fixedLocations: {
            "small_fort": {
                x: 0.5,
                y: 0.5,
                alignX: 0.5,
                alignY: 0.5
            },
            "dm_respawn_0": {
                x: 0.1,
                y: 0.1
            },
            "dm_respawn_1": {
                x: 0.9,
                y: 0.9,
                alignX: 1.0,
                alignY: 1.0
            },
            "barbarian_quary_1": {
                quantity: 1
            },
            "mini_marketplace": {
                quantity: 1
            }// "ogre": { quantity: 1 }

        }
    }

};

COMMON.modes.battle_royale = {
    showRespawnWindow: true,
    secrets: true,
    fun: false,

    // secrets: false,
    // fun: true,

    fifo: true,
    maxPlayers: 30,
    minPlayers: 10,
    houseMusic: "desert_house",
    removeDeadHeroBots: true,
    enemyMode: "ffa",
    weather: ["desert"],
    eclipse: true,
    temperature: false,
    background: "tile_desert",
    scoreKey: "bones",
    allowTeamChange: 2,
    bonesToScore: false,
    speed: 1.0,
    addKills: true,
    name: "Desert Royale",
    description: "It's a TEAM ARENA server. Folks of the same color are your team.",

    // map: "arctic_village",
    mapGenerator: true,
    mapGeneratorConfig: {
        padding: 6,
        width: 5000 / COMMON.TILE_WIDTH | 0,
        height: 5000 / COMMON.TILE_HEIGHT | 0,
        prefix: "br_",
        prefixToQuantity: {
            "_respawn": 8,
            "_weapon": 24
        }
    },
    dropWeapons: true,
    pedestals: false,
    quicksands: false,
    sandworms: 0,
    list: true,
    grow: true,
    resetScoreOnRespawn: true,
    controller: "BattleRoyale",
    expMultiplier: 2,
    ffa: true,
    spawnNearFriends: true,
    fixedRespawnTeam: 2,
    respawnWindow: "playAgain",
    replacePickups: {
        "key": "potion_health"
    }
};

COMMON.modes.soccer = {
    teamScore: true,
    duration: 10 * 60,
    weather: ["raining", "default", "desert"],
    clock: true,
    crowdLoop: true,
    stompLoop: true,
    addKills: false,
    scoreKey: "goals",
    respawnTime: 9,
    autoRespawn: true,
    name: "football",
    background: "tile_desert",
    map: false,
    playersPerTeam: 4,
    fun: false,
    innerWidth: 400,
    innerHeight: 600,
    soccer: true,
    scoreToWin: 3,
    goblins: 0,
    bots: 0,
    sandworms: 0,
    kills: true,
    secrets: true,
    list: true,
    rankedGold: true,
    controller: "Soccer"

};

COMMON.modes.graveyard = {
    background: "tile_pavement",
    speed: 1.0,
    controller: "Graveyard",
    scoreKey: "graveyard_score",
    name: "GRAVEYARD",
    map: "graveyard",
    visibility: 1,
    fun: true,
    kills: true,
    list: true,
    maxPlayers: 30 // autoRespawn: true,
    // respawnTime: 9999999
};

COMMON.modes.fun = {
    houseMusic: "house_music",
    respawnNPC: true,
    countBones: true,
    removeDeadHeroBots: true,
    weather: ["default", "desert"],
    temperature: false,
    king: true,
    background: "tile_desert",
    scoreKey: "bones",
    allowTeamChange: 2,
    allowGameLinks: true,
    bonesToScore: true,
    speed: 1.0,
    addKills: true,
    name: "Desert Fort",
    description: "It's a TEAM ARENA server. Folks of the same color are your team.",
    // map: "small_fort",
    allowRespawn: true,
    fun: true,
    pedestals: false,
    quicksands: false,
    sandworms: 0,
    list: true,
    maxPlayers: 30,
    grow: true,
    resetScoreOnRespawn: true,
    controller: "Survival",
    eclipse: true,
    mapGenerator: true,
    mapGeneratorConfig: {
        prefix: ["dm_"],
        padding: 3,
        max: 1,
        width: 4000 / COMMON.TILE_WIDTH | 0,
        height: 3000 / COMMON.TILE_HEIGHT | 0,
        prefixToQuantity: {
            "dm_respawn_2": 4,
            "dm_barbarians_1": 1,
            "dm_barbarians_2": 1,
            "dm_orc_sentry": 2,
            "dm_woods_1": 1,
            "dm_woods_2": 1
        },
        fixedLocations: {
            "mini_fort": {
                x: 0.5,
                y: 0.5,
                alignX: 0.5,
                alignY: 0.5
            },
            "dm_respawn_0": {
                x: 0.1,
                y: 0.1,
                quart: 0,
                alignX: 0.5,
                alignY: 0.5
            },
            "dm_respawn_1": {
                x: 0.9,
                y: 0.9,
                quart: 2,
                alignX: 0.5,
                alignY: 0.5
            },
            "barbarian_quary_1": {
                quantity: 1
            },
            "dm_barbarians_1": {
                quantity: 1
            },
            "dm_barbarians_2": {
                quantity: 1
            },
            "dm_barbarians_3": {
                quantity: 1
            },
            "mini_marketplace": {
                quantity: 1,
                x: 0.9,
                y: 0.1,
                alignX: 1.0,
                alignY: 0.0
            }
            // "ogre": { quantity: 1 }
        }

    }

};

COMMON.modes.fort = {
    houseMusic: "desert_house",
    respawnNPC: true,
    countBones: true,
    removeDeadHeroBots: true,
    weather: ["desert"],
    king: true,
    background: "tile_desert",
    scoreKey: "bones",
    allowTeamChange: 2,
    allowGameLinks: true,
    bonesToScore: true,
    speed: 1.0,
    addKills: true,
    name: "Fort",
    description: "It's a TEAM ARENA server. Folks of the same color are your team.",
    // map: "small_fort",
    allowRespawn: true,
    fun: true,
    pedestals: false,
    quicksands: false,
    sandworms: 0,
    list: true,
    maxPlayers: 30,
    grow: true,
    resetScoreOnRespawn: true,
    eclipse: true,
    map: "fort",
    replacePickups: {
        "key": "potion_health",
        "wood": "potion_health"
    }

};

COMMON.modes.hell = {
    meleeOnly: true,
    background: "tile_hell",
    autoRespawn: true,
    respawnTime: 0.5,
    pvm: true,
    scoreKey: "bones",
    meleeOnly: true,
    allowTeamChange: 0,
    speed: 1.25,
    name: "HELL",
    description: "KILL HUMAN TO BECOME A HUMAN. ONLY HUMAN CAN SCORE",
    fun: true,
    innerWidth: 800,
    innerHeight: 800,
    pedestals: 4,
    quicksands: 0,
    sandworms: 0,
    yeti: 0,
    bots: 3,
    shadows: 12,
    goblins: 0,
    list: true,
    stones: 0,
    impacts: true,
    maxPlayers: 20
};

COMMON.modes.ctf = {
    scoreKey: "flags",
    allowTeamChange: 1,
    addKills: true,
    maxPlayers: 14,
    visibility: 1,
    name: "CTF",
    list: true,
    description: "Capture the flag.",
    randomShit: true,
    map: "ctf",
    fun: true,
    bots: 14
};

COMMON.modes.practice = {
    removeDeadHeroBots: true,
    name: "Practice",
    weather: ["default", "raining"],
    background: "tile_desert",
    ffa: true,
    private: true,
    map: false,
    fun: true,
    practice: true,
    allowGameLinks: true,

    innerWidth: 400,
    innerHeight: 400,
    pedestals: 2,
    quicksands: false,
    bots: 2,
    yeti: false,
    sandworms: 0,
    goblins: false,
    list: true
};

COMMON.modes.arena1 = {
    weather: ["raining", "default", "desert"],
    teamScore: true,
    duration: 5 * 60,
    // music: "music/battle_1",
    removeDeadHeroBots: false,
    background: "tile_desert",
    weather: ["snowing"],
    clock: true,
    scoreKey: "arena_mmr",
    speed: 1.0,
    addKills: true,
    respawnTime: 10,
    hideNames: false,
    hideScore: true,
    name: "arena",
    map: ["arena_1", "arena_2", "arena_3", "arena_4"],
    eclipse: false,
    playersPerTeam: 1,
    fun: false,
    scoreToWin: 3,
    goblins: 0,
    bots: 0,
    sandworms: 0,
    kills: true,
    secrets: true,
    list: true,
    rankedGold: true,
    controller: "Arena"
};

COMMON.modes.arena2 = {
    weather: ["raining", "default", "desert"],
    teamScore: true,
    duration: 5 * 60,
    stompLoop: true,
    crowdLoop: true,
    // music: "music/battle_1",
    removeDeadHeroBots: false,
    clock: true,
    background: "tile_desert",
    scoreKey: "arena_mmr",
    speed: 1.0,
    clock: true,
    addKills: true,
    respawnTime: 99999,
    autoRespawn: 99999,
    hideNames: false,
    hideScore: true,
    name: "Browars",
    map: ["arena_1", "arena_2", "arena_3", "arena_4"],
    playersPerTeam: 2,
    fun: false,
    scoreToWin: 3,
    goblins: 0,
    bots: 0,
    sandworms: 0,
    kills: true,
    secrets: true,
    list: true,
    rankedGold: true,
    controller: "Arena2"
};

COMMON.modes.tutorial = {
    background: "tile_desert",

    autoRespawn: true,
    respawnTime: 3,
    name: "tutorial",
    ffa: true,
    private: true,
    fun: true,
    practice: true,
    innerWidth: 400,
    innerHeight: 400,
    pedestals: 2,
    hideScore: true,
};

COMMON.slashRotation = {
    "fx/slash_horizontal": 0.5,
    "fx/slash_vertical": 0,
    "fx/slash_claws": 0,
    "fx/slash_claws2": 0,
    "fx/slash_punch": 0,
    "fx/slash_punch2": 0,
    "fx/slash_dual_left": 0,
    "fx/slash_dual_right": 0,
    "fx/vertical_slash": 0
};

COMMON.emptyObject = {};

COMMON.weaponData = {

    attackDuration: 0.4,
    meleeDamage: 1.0,
    meleeRange: 40,
    meleeForce: 220,
    meleeArc: Math.PI,
    speed: 0,
    slashColor: "#fff" || "#c1defb",
    attackAnimations: ["attack_horizontal", "attack_vertical", "dual_wield_attack_1"],
    meleeSlash: ["fx/slash_horizontal", "fx/slash_vertical", "fx/slash_dual_right"]

};

COMMON.armory = {

    "default_voice": {
        price: 0,
        type: "voice",
        rate: 1.3,
        rateRange: 0.5
    },

    "angrybrai_voice": {
        price: 8000,
        type: "voice",
        rate: 1.0,
        rateRange: 0.0
    },

    "jacqueline_voice": {
        price: 8000,
        type: "voice",
        rate: 1.0,
        rateRange: 0.0
    },

    "bow": {
        price: 2400,
        type: "weapon",
        subtype: "bow",
        material: "wood",
        spell_one: "piercingArrow",
        onDischarge: "launchArrow",
        video: "videos/bow.mp4",
        ranged: true,
        attack: "bow",
        chargeTime: 0.65,
        chargeStaminaUsage: 0.35,
        meleeDamage: 1,
        meleeRange: 40,
        meleeArc: Math.PI,
        attackDuration: 0.6
    },

    "club": {
        price: 0,
        type: "weapon",
        material: "wood",
        // spell_one: "iceBlast",
        onCharged: "spin",
        spell_one: "stun",
        video: "videos/axe.mp4",
        chargeTime: 0.6,
        meleeDamage: 1,
        subtype: "melee",
        chargeStaminaUsage: 0.5,
        attackDuration: 0.5,
        meleeRange: 40,
        meleeArc: Math.PI,
        slashColor: "#8f563b",
        stunChance: 0.1
        // attack: "spell"
    },

    "axe": {
        cut: 1,
        price: 0,
        type: "weapon",
        material: "metal",
        // spell_one: "iceBlast",
        onCharged: "spin",
        spell_one: "gust",
        video: "videos/axe.mp4",
        chargeTime: 0.6,
        meleeDamage: 2,
        subtype: "melee",
        chargeStaminaUsage: 0.5,
        attackDuration: 0.5,
        meleeRange: 40,
        meleeArc: Math.PI // attack: "spell"
    },

    "golden_axe": {
        golden: true,
        fixedPalette: 25,
        cut: 1,
        price: 999990,
        type: "weapon",
        material: "metal",
        // spell_one: "iceBlast",
        onCharged: "spin",
        spell_one: "gust",
        video: "videos/axe.mp4",
        chargeTime: 0.6,
        meleeDamage: 3,
        subtype: "melee",
        chargeStaminaUsage: 0.5,
        attackDuration: 0.45,
        meleeRange: 50,
        meleeArc: Math.PI,
        sprite: "axe",
        slashColor: "#fbf236"// attack: "spell"
    },

    "scythe": {
        cut: 1,
        price: 999999999,
        type: "weapon",
        material: "metal",
        // spell_one: "iceBlast",
        spell_one: "massPull",
        onCharged: "spin",
        video: "videos/axe.mp4",
        chargeTime: 0.75,
        meleeDamage: 5,
        subtype: "melee",
        chargeStaminaUsage: 0.5,
        attackDuration: 0.5,
        meleeRange: 60,
        meleeArc: Math.PI,
        soundRate: 1.0,
        sound: "weapons/scythe_swing",
        attackAnimations: ["attack_horizontal"],
        meleeSlash: ["fx/slash_horizontal"],
        cooldowns: {
            gust: 0.6
        }
        // attack: "spell"
    },

    "spear": {
        price: 2400,
        type: "weapon",
        material: "metal",
        spell_one: "poleVault",
        onCharged: "lunge",
        video: "videos/spear.mp4",
        chargeTime: 0.6,
        meleeDamage: 1.25,
        subtype: "melee",
        attackAnimations: ["spear_attack"],
        meleeSlash: ["fx/slash_vertical"],
        chargeStaminaUsage: 0.6,
        attackDuration: 0.4,
        meleeRange: 60,
        meleeArc: Math.PI * 0.3,
        throwAnimation: {
            sprite: "spear_throw",
            duration: 0.5,
            timeout: 0.25,
            sound: "weapons/throw_spear"
        }
        // attack: "spell"
    },

    "no_weapon": {
        price: 3000,
        type: "weapon",
        material: "metal",
        onCharged: "spin",
        chargeTime: 0.6,
        meleeDamage: 0.5,
        subtype: "melee",
        attackAnimations: ["punch1", "punch2"],
        meleeSlash: ["fx/slash_punch", "fx/slash_punch2"],
        sound: "martial/punch",
        chargeStaminaUsage: 0.5,
        attackDuration: 0.25,
        speed: 10,
        meleeRange: 30,
        meleeForce: 100,
        meleeArc: Math.PI * 0.5
    },

    "claws": {
        price: 3000,
        type: "weapon",
        material: "metal",
        spell_one: "tear",
        onCharged: "spin",
        video: "videos/claws.mp4",
        chargeTime: 0.6,
        meleeDamage: 1.25,
        subtype: "melee",
        attackAnimations: ["punch1", "punch2"],
        meleeSlash: ["fx/slash_claws", "fx/slash_claws2"],
        chargeStaminaUsage: 0.5,
        attackDuration: 0.35,
        speed: 10,
        meleeRange: 30,
        meleeForce: 100,
        meleeArc: Math.PI * 0.5
    },

    "double_axe": {
        cut: 1,
        price: 300000,
        type: "weapon",
        material: "metal",
        spell_one: "focus",
        onCharged: "spin",
        video: "videos/claws.mp4",
        chargeTime: 0.6,
        meleeDamage: 1.25,
        subtype: "melee",
        attackAnimations: ["dual_wield_attack_1", "dual_wield_attack_2"],
        meleeSlash: ["fx/slash_dual_right", "fx/slash_dual_left"],
        chargeStaminaUsage: 0.5,
        attackDuration: 0.4,
        slashDelay: 0.25,
        speed: 10,
        meleeRange: 30,
        meleeForce: 100,
        meleeArc: Math.PI * 0.5
    },

    "hammer": {
        demolish: 1,
        price: 1000,
        type: "weapon",
        material: "metal",
        spell_one: "powerHit",
        onCharged: "spin",
        video: "videos/hammer.mp4",
        chargeTime: 0.6,
        meleeDamage: 2,
        subtype: "melee",
        chargeStaminaUsage: 0.5,
        attackDuration: 0.5,
        meleeRange: 40,
        meleeArc: Math.PI,
        stunChance: 0.15
    },

    "sword": {
        price: 2400,
        type: "weapon",
        material: "metal",
        spell_one: "swirl",
        onCharged: "spin",
        video: "videos/sword.mp4",
        chargeTime: 0.6,
        meleeDamage: 1.5,
        attackDuration: 0.4,
        subtype: "melee",
        chargeStaminaUsage: 0.5,
        meleeRange: 40,
        meleeArc: Math.PI,
        sound: "weapons/sword_swing"
    },

    "ice_staff": {
        price: 2400,
        type: "weapon",
        subtype: "staff",
        material: "wood",
        spell_one: "iceBolt",
        onCharged: "launchBolts",
        video: "videos/ice_staff.mp4",
        ranged: true,
        chargeTime: 0.3,
        chargeStaminaUsage: 0.4,
        meleeDamage: 1,
        attackDuration: 0.6,
        meleeRange: 40,
        meleeArc: Math.PI,

    },

    "no_helmet": {
        price: 0,
        type: "helmet",
        material: "metal"
    },

    "mohawk_hair": {
        price: 0,
        type: "cape",
        material: "wood"
    },

    "no_shield": {
        price: 0,
        type: "shield",
        material: "metal"
    },

    "hood": {
        price: 100,
        type: "helmet",
        material: "wood"
    },

    "pumpkin_head": {
        fixedPalette: 0,
        price: 20000,
        type: "helmet",
        material: "wood"
    },

    "elf_ears": {
        price: 1000,
        type: "helmet",
        material: "wood"
    },

    "demon_horns": {
        price: 1000,
        type: "helmet",
        material: "wood"
    },

    "crusader_helmet": {
        price: 5000,
        type: "helmet",
        material: "wood",
        palettes: {

            0: false,
            1: false,
            2: false
        }
    },

    "santa_hat": {
        fixedPalette: 0,
        price: 500,
        type: "helmet",
        material: "wood",
        palettes: {

            0: false,
            1: {
                "#ac3232": "#480"
            },
            2: {
                "#ac3232": "#595652"
            },
        }

    },

    "viking_helmet": {
        price: 1000,
        type: "helmet",
        material: "wood"

    },

    "observer_eye": {
        fixedPalette: 0,
        price: 10000000,
        type: "helmet",
        material: "wood"
    },

    "wizard_hat": {
        price: 5000,
        type: "helmet",
        material: "wood"
    },

    "fox_head": {
        price: 2000,
        type: "helmet",
        material: "wood",
        kind: "fox"
    },

    "legion_helmet": {
        price: 2400,
        type: "helmet",
        material: "metal"
    },

    "crown": {
        fixedPalette: 0,
        price: 50000,
        type: "helmet",
        material: "metal",
        palettes: {

            0: false,
            1: false,
            2: {
                "#fbf236": "#222034"
            }
        }
    },

    "no_cape": {
        price: 0,
        type: "cape",
        material: "cloth"
    },

    "noble_cape": {
        fixedPalette: 0,
        price: 8000,
        type: "cape",
        material: "cloth"
    },

    "backpack": {
        fixedPalette: 0,
        price: 800000,
        type: "cape",
        material: "cloth"
    },

    "barbarian_cape": {
        fixedPalette: 0,
        price: 8000,
        type: "cape",
        material: "cloth"
    },

    "white_cape": {
        fixedPalette: 0,
        price: 12000,
        type: "cape",
        material: "cloth"
    },

    "angel_wings": {
        fixedPalette: 0,
        price: 20000,
        type: "cape",
        material: "cloth"
    },

    "demon_wings": {
        fixedPalette: 0,
        price: 14000,
        type: "cape",
        material: "cloth"
    },

    "fedora": {
        price: 3000,
        type: "helmet",
        material: "wood"
    },

    "skull": {
        price: 10000,
        type: "helmet",
        material: "bone"

    },

    "shield_wooden": {
        price: 0,
        type: "shield",
        material: "wood"

    },

    "shield_usa": {
        price: 5000,
        type: "shield",
        material: "metal"
    },

    "shield_heavy": {
        price: 5000,
        type: "shield",
        material: "metal"
    }

};

for (var key in COMMON.armory) {

    let item = COMMON.armory[key];

    if (item.type !== "weapon")
        continue;

    COMMON.armory[key] = Object.assign({}, COMMON.weaponData, COMMON.armory[key]);

}

COMMON.ARENA_RANKS = [[7, 124, 9, 4], [18, 124, 9, 7], [29, 124, 9, 10], [7, 136, 9, 7], [18, 136, 9, 11], [29, 136, 9, 15], [8, 153, 7, 7], [19, 153, 7, 13], [27, 153, 13, 11], [8, 169, 7, 11], [19, 169, 7, 11], [30, 169, 9, 11], [41, 169, 12, 11]];

COMMON.KILL_RANKS = [[13, 10, 6, 7], [24, 10, 10, 7], [37, 10, 14, 7], [11, 24, 10, 10], [25, 24, 11, 12], [39, 24, 15, 12], [7, 42, 14, 11], [23, 43, 15, 13], [40, 43, 19, 13], [6, 59, 18, 12], [27, 60, 19, 14], [48, 61, 23, 14], [9, 77, 10, 10], [23, 77, 13, 13], [39, 77, 15, 15], [5, 96, 15, 15], [24, 96, 15, 19], [42, 96, 15, 19]];

COMMON.CTF_RANKS = [[4, 186, 11, 10], [16, 186, 11, 10], [28, 186, 11, 10], [40, 186, 11, 10], [52, 186, 11, 10], [64, 186, 11, 10], [4, 197, 12, 10], [17, 197, 12, 10], [30, 197, 12, 10], [4, 208, 13, 11], [18, 208, 13, 11], [32, 208, 13, 11]]

COMMON.SOCCER_RANKS = [[4, 221, 14, 11], [1, 233, 17, 10], [2, 245, 13, 13], [3, 260, 12, 15], [19, 221, 14, 11], [19, 233, 17, 10], [16, 245, 13, 13], [17, 260, 12, 15], [34, 221, 14, 11], [37, 233, 17, 10], [30, 245, 13, 13], [30, 260, 12, 15]];

COMMON.RANK_ICONS = [];

COMMON.RANK_ICONS["bones"] = COMMON.KILL_RANKS;
COMMON.RANK_ICONS["arena_mmr"] = COMMON.ARENA_RANKS;
COMMON.RANK_ICONS["flags"] = COMMON.CTF_RANKS;
COMMON.RANK_ICONS["goals"] = COMMON.SOCCER_RANKS;
COMMON.RANK_ICONS["graveyard_score"] = [
[68, 121, 9, 11], [79, 121, 9, 11], [90, 121, 9, 11],
[68, 133, 9, 14], [79, 133, 9, 14], [90, 133, 9, 14],
[68, 148, 9, 14], [79, 148, 9, 14], [90, 148, 9, 14],
[68, 163, 9, 14], [79, 163, 9, 14], [90, 163, 9, 14]
];

COMMON.SPECTATE_EMOTE_COOLDOWN = 8;

COMMON.SPECTATE_EMOTE_COOLDOWNS = {
    default: 5.0,
    clap: 1.0
}

COMMON.SPECTATE_EMOTE_MAX = {
    angry: 2,
    happy: 2,
    haha: 2,
    clap: 6
}

COMMON.edges = {

    11: {
        offset: [-1, 0],
        direction: Math.PI
    },

    12: {
        offset: [1, 0],
        direction: 0
    },

    13: {
        offset: [0, -1],
        direction: Math.PI * 1.5
    },

    14: {
        offset: [0, 1],
        direction: Math.PI * 0.5
    }

};

COMMON.quests = {

    "kill_orcs_easy": {
        "text": "Kill 10 orcs",
        "trigger": "kill",
        "minion_prefix": "orc_",
        "count": 10,
        "reward": 100,
        "icon": [243, 3, 33, 30],
        "playMode": "fun"
    },

    "kill_orcs_medium": {
        "text": "Kill 3 orc commanders",
        "trigger": "kill",
        "minion": "orc_commander",
        "count": 3,
        "reward": 150,
        "icon": [243, 3, 33, 30],
        "playMode": "fun"
    },

    "win_soccer_easy": {
        "text": "Win a football match",
        "trigger": "win_soccer",
        "count": 1,
        "reward": 100,
        "icon": [73, 2, 28, 28],
        "playMode": "soccer"
    },

    "soccer_score_goal": {
        "text": "Score a goal in football match",
        "trigger": "soccer_score_goal",
        "count": 1,
        "reward": 100,
        "icon": [73, 2, 28, 28],
        "playMode": "soccer"
    },

    "soccer_score_goal_hard": {
        "text": "Score two goals in one football match",
        "trigger": "soccer_score_goal",
        "count": 2,
        "reward": 150,
        "icon": [73, 2, 28, 28],
        "playMode": "soccer"
    },

    "heal_someone": {
        "text": "Heal another person (throw healing potion at them)",
        "count": 1,
        "trigger": "pass_pickup",
        "pickup": "potion_health",
        "reward": 75,
        "playMode": 0,
        "icon": [106, 0, 28, 32]
    },

    "win_arena_easy": {
        "text": "Win any arena match",
        "maxDeaths": 2,
        "trigger": "win_arena",
        "reward": 50,
        "playMode": 4,
        "icon": [137, 6, 20, 24]
    },

    "win_arena_medium": {
        "text": "Win arena match - you can die once",
        "maxDeaths": 1,
        "trigger": "win_arena",
        "reward": 100,
        "playMode": 4,
        "icon": [137, 6, 20, 24]
    },

    "win_arena_hard": {
        "text": "Win arena match without losing",
        "maxDeaths": 0,
        "trigger": "win_arena",
        "reward": 200,
        "playMode": 4,
        "icon": [137, 6, 20, 24]
    },

    "kill_easy": {
        "text": "Kill 10 enemies",
        "count": 10,
        "trigger": "kill",
        "reward": 50,
        "playMode": 0,
        "icon": [162, 3, 30, 30]
    },

    "kill_medium": {
        "text": "Kill 3 enemies without dying",
        "count": 3,
        "trigger": "kill",
        "reward": 100,
        "playMode": 0,
        "resetOnDeath": true,
        "icon": [162, 3, 30, 30]

    },

    "kill_hard": {
        "text": "Kill 6 enemies without dying",
        "count": 6,
        "trigger": "kill",
        "reward": 200,
        "playMode": 0,
        "resetOnDeath": true,
        "icon": [162, 3, 30, 30]

    },

    "block_easy": {
        "text": "Successfully block 3 times",
        "count": 3,
        "trigger": "block",
        "reward": 75,
        "playMode": 0,
        "icon": [195, 4, 30, 30]
    },

    "block_medium": {
        "text": "Successfully block 6 times without dying",
        "count": 6,
        "trigger": "block",
        "reward": 100,
        "playMode": 0,
        "resetOnDeath": true,
        "icon": [195, 4, 30, 30]
    },

    "block_hard": {
        "text": "Successfully block 10 times without dying",
        "count": 10,
        "trigger": "block",
        "reward": 200,
        "playMode": 0,
        "resetOnDeath": true,
        "icon": [195, 4, 30, 30]
    },

    "fuel_campfire_easy": {
        "text": "Throw 4 pieces of wood into campfire",
        "count": 4,
        "trigger": "fuel_campfire",
        "reward": 50,
        "playMode": 0,
        "icon": [30, 0, 36, 32]
    },

    "rebuild_gate_easy": {
        "text": "Repair fort gate using 4 pieces of wood",
        "count": 4,
        "trigger": "rebuild_gate",
        "reward": 100,
        "playMode": 0,
        "icon": [30, 0, 36, 32]
    },

    "rebuild_gate_medium": {
        "text": "Repair fort gate using 16 pieces of wood",
        "count": 16,
        "trigger": "rebuild_gate",
        "reward": 150,
        "playMode": 0,
        "icon": [30, 0, 36, 32]
    },

    "rebuild_gate_hard": {
        "text": "Repair fort gate using 16 pieces of wood without dying",
        "count": 16,
        "trigger": "rebuild_gate",
        "reward": 200,
        "playMode": 0,
        "resetOnDeath": true,
        "icon": [30, 0, 36, 32]
    },

    "cut_down_trees": {
        "text": "Cut down 10 trees",
        "count": 10,
        "trigger": "cut_down_tree",
        "reward": 50,
        "playMode": 0,
        "icon": [30, 0, 36, 32]
    },

    "cut_down_trees_medium": {
        "text": "Cut down 20 trees",
        "count": 20,
        "trigger": "cut_down_tree",
        "reward": 100,
        "playMode": 0,
        "icon": [30, 0, 36, 32]
    },

    "destroy_gate": {
        "text": "Destroy the fort gate",
        "count": 1,
        "trigger": "destroy_gate",
        "reward": 100,
        "playMode": 0,
        "icon": [0, 0, 30, 30]
    },

    "kill_with_mine": {
        "text": "Kill anyone with a mine",
        "count": 1,
        "trigger": "kill_with_mine",
        "reward": 100,
        "playMode": 0,
        "icon": [0, 0, 30, 30]
    },

    "kill_with_mine_hard": {
        "text": "Kill 3 enemies with a mine",
        "count": 3,
        "trigger": "kill_with_mine",
        "reward": 250,
        "playMode": 0,
        "icon": [0, 0, 30, 30]
    },

    "kill_with_thrown_weapon_easy": {
        "text": "Kill someone throwing your weapon",
        "count": 1,
        "trigger": "kill_with_thrown_weapon",
        "reward": 100,
        "playMode": 0,
        "icon": [231, 3, 9, 29]
    },

    "kill_with_throwing_knife": {
        "text": "Kill someone with a throwing knife",
        "count": 1,
        "trigger": "kill_with_throwing_knife",
        "reward": 100,
        "playMode": 0,
        "icon": [231, 3, 9, 29]
    }

};

COMMON.countryNames = {
    "ad": "Andorra | Andorra",
    "ae": "دولة الإمارات العربية المتحدة | United Arab Emirates",
    "af": "افغانستان | Afghanistan",
    "ag": "Antigua and Barbuda | Antigua and Barbuda",
    "ai": "Anguilla | Anguilla",
    "al": "Shqipëria | Albania",
    "am": "Հայաստան | Armenia",
    "ao": "Angola | Angola",
    "aq": "Antarctica | Antarctica",
    "ar": "Argentina | Argentina",
    "as": "American Samoa | American Samoa",
    "at": "Österreich | Austria",
    "au": "Australia | Australia",
    "aw": "Aruba | Aruba",
    "ax": "Åland | Åland",
    "az": "Azərbaycan | Azerbaijan",
    "ba": "Bosna i Hercegovina | Bosnia and Herzegovina",
    "bb": "Barbados | Barbados",
    "bd": "Bangladesh | Bangladesh",
    "be": "België | Belgium",
    "bf": "Burkina Faso | Burkina Faso",
    "bg": "България | Bulgaria",
    "bh": "‏البحرين | Bahrain",
    "bi": "Burundi | Burundi",
    "bj": "Bénin | Benin",
    "bl": "Saint-Barthélemy | Saint Barthélemy",
    "bm": "Bermuda | Bermuda",
    "bn": "Negara Brunei Darussalam | Brunei",
    "bo": "Bolivia | Bolivia",
    "bq": "Bonaire | Bonaire",
    "br": "Brasil | Brazil",
    "bs": "Bahamas | Bahamas",
    "bt": "ʼbrug-yul | Bhutan",
    "bv": "Bouvetøya | Bouvet Island",
    "bw": "Botswana | Botswana",
    "by": "Белару́сь | Belarus",
    "bz": "Belize | Belize",
    "ca": "Canada | Canada",
    "cc": "Cocos (Keeling) Islands | Cocos [Keeling] Islands",
    "cd": "République démocratique du Congo | Democratic Republic of the Congo",
    "cf": "Ködörösêse tî Bêafrîka | Central African Republic",
    "cg": "République du Congo | Republic of the Congo",
    "ch": "Schweiz | Switzerland",
    "ci": "Côte d'Ivoire | Ivory Coast",
    "ck": "Cook Islands | Cook Islands",
    "cl": "Chile | Chile",
    "cm": "Cameroon | Cameroon",
    "cn": "中国 | China",
    "co": "Colombia | Colombia",
    "cr": "Costa Rica | Costa Rica",
    "cu": "Cuba | Cuba",
    "cv": "Cabo Verde | Cape Verde",
    "cw": "Curaçao | Curacao",
    "cx": "Christmas Island | Christmas Island",
    "cy": "Κύπρος | Cyprus",
    "cz": "Česká republika | Czech Republic",
    "de": "Deutschland | Germany",
    "dj": "Djibouti | Djibouti",
    "dk": "Danmark | Denmark",
    "dm": "Dominica | Dominica",
    "do": "República Dominicana | Dominican Republic",
    "dz": "الجزائر | Algeria",
    "ec": "Ecuador | Ecuador",
    "ee": "Eesti | Estonia",
    "eg": "مصر‎ | Egypt",
    "eh": "الصحراء الغربية | Western Sahara",
    "er": "ኤርትራ | Eritrea",
    "es": "España | Spain",
    "et": "ኢትዮጵያ | Ethiopia",
    "fi": "Suomi | Finland",
    "fj": "Fiji | Fiji",
    "fk": "Falkland Islands | Falkland Islands",
    "fm": "Micronesia | Micronesia",
    "fo": "Føroyar | Faroe Islands",
    "fr": "France | France",
    "ga": "Gabon | Gabon",
    "gb": "United Kingdom | United Kingdom",
    "gd": "Grenada | Grenada",
    "ge": "საქართველო | Georgia",
    "gf": "Guyane française | French Guiana",
    "gg": "Guernsey | Guernsey",
    "gh": "Ghana | Ghana",
    "gi": "Gibraltar | Gibraltar",
    "gl": "Kalaallit Nunaat | Greenland",
    "gm": "Gambia | Gambia",
    "gn": "Guinée | Guinea",
    "gp": "Guadeloupe | Guadeloupe",
    "gq": "Guinea Ecuatorial | Equatorial Guinea",
    "gr": "Ελλάδα | Greece",
    "gs": "South Georgia | South Georgia and the South Sandwich Islands",
    "gt": "Guatemala | Guatemala",
    "gu": "Guam | Guam",
    "gw": "Guiné-Bissau | Guinea-Bissau",
    "gy": "Guyana | Guyana",
    "hk": "香港 | Hong Kong",
    "hm": "Heard Island and McDonald Islands | Heard Island and McDonald Islands",
    "hn": "Honduras | Honduras",
    "hr": "Hrvatska | Croatia",
    "ht": "Haïti | Haiti",
    "hu": "Magyarország | Hungary",
    "id": "Indonesia | Indonesia",
    "ie": "Éire | Ireland",
    "il": "יִשְׂרָאֵל | Israel",
    "im": "Isle of Man | Isle of Man",
    "in": "भारत | India",
    "io": "British Indian Ocean Territory | British Indian Ocean Territory",
    "iq": "العراق | Iraq",
    "ir": "ایران | Iran",
    "is": "Ísland | Iceland",
    "it": "Italia | Italy",
    "je": "Jersey | Jersey",
    "jm": "Jamaica | Jamaica",
    "jo": "الأردن | Jordan",
    "jp": "日本 | Japan",
    "ke": "Kenya | Kenya",
    "kg": "Кыргызстан | Kyrgyzstan",
    "kh": "Kâmpŭchéa | Cambodia",
    "ki": "Kiribati | Kiribati",
    "km": "Komori | Comoros",
    "kn": "Saint Kitts and Nevis | Saint Kitts and Nevis",
    "kp": "북한 | North Korea",
    "kr": "대한민국 | South Korea",
    "kw": "الكويت | Kuwait",
    "ky": "Cayman Islands | Cayman Islands",
    "kz": "Қазақстан | Kazakhstan",
    "la": "ສປປລາວ | Laos",
    "lb": "لبنان | Lebanon",
    "lc": "Saint Lucia | Saint Lucia",
    "li": "Liechtenstein | Liechtenstein",
    "lk": "śrī laṃkāva | Sri Lanka",
    "lr": "Liberia | Liberia",
    "ls": "Lesotho | Lesotho",
    "lt": "Lietuva | Lithuania",
    "lu": "Luxembourg | Luxembourg",
    "lv": "Latvija | Latvia",
    "ly": "‏ليبيا | Libya",
    "ma": "المغرب | Morocco",
    "mc": "Monaco | Monaco",
    "md": "Moldova | Moldova",
    "me": "Црна Гора | Montenegro",
    "mf": "Saint-Martin | Saint Martin",
    "mg": "Madagasikara | Madagascar",
    "mh": "M̧ajeļ | Marshall Islands",
    "mk": "Македонија | Macedonia",
    "ml": "Mali | Mali",
    "mm": "Myanma | Myanmar [Burma]",
    "mn": "Монгол улс | Mongolia",
    "mo": "澳門 | Macao",
    "mp": "Northern Mariana Islands | Northern Mariana Islands",
    "mq": "Martinique | Martinique",
    "mr": "موريتانيا | Mauritania",
    "ms": "Montserrat | Montserrat",
    "mt": "Malta | Malta",
    "mu": "Maurice | Mauritius",
    "mv": "Maldives | Maldives",
    "mw": "Malawi | Malawi",
    "mx": "México | Mexico",
    "my": "Malaysia | Malaysia",
    "mz": "Moçambique | Mozambique",
    "na": "Namibia | Namibia",
    "nc": "Nouvelle-Calédonie | New Caledonia",
    "ne": "Niger | Niger",
    "nf": "Norfolk Island | Norfolk Island",
    "ng": "Nigeria | Nigeria",
    "ni": "Nicaragua | Nicaragua",
    "nl": "Nederland | Netherlands",
    "no": "Norge | Norway",
    "np": "नपल | Nepal",
    "nr": "Nauru | Nauru",
    "nu": "Niuē | Niue",
    "nz": "New Zealand | New Zealand",
    "om": "عمان | Oman",
    "pa": "Panamá | Panama",
    "pe": "Perú | Peru",
    "pf": "Polynésie française | French Polynesia",
    "pg": "Papua Niugini | Papua New Guinea",
    "ph": "Pilipinas | Philippines",
    "pk": "Pakistan | Pakistan",
    "pl": "Polska | Poland",
    "pm": "Saint-Pierre-et-Miquelon | Saint Pierre and Miquelon",
    "pn": "Pitcairn Islands | Pitcairn Islands",
    "pr": "Puerto Rico | Puerto Rico",
    "ps": "فلسطين | Palestine",
    "pt": "Portugal | Portugal",
    "pw": "Palau | Palau",
    "py": "Paraguay | Paraguay",
    "qa": "قطر | Qatar",
    "re": "La Réunion | Réunion",
    "ro": "România | Romania",
    "rs": "Србија | Serbia",
    "ru": "Россия | Russia",
    "rw": "Rwanda | Rwanda",
    "sa": "العربية السعودية | Saudi Arabia",
    "sb": "Solomon Islands | Solomon Islands",
    "sc": "Seychelles | Seychelles",
    "sd": "السودان | Sudan",
    "se": "Sverige | Sweden",
    "sg": "Singapore | Singapore",
    "sh": "Saint Helena | Saint Helena",
    "si": "Slovenija | Slovenia",
    "sj": "Svalbard og Jan Mayen | Svalbard and Jan Mayen",
    "sk": "Slovensko | Slovakia",
    "sl": "Sierra Leone | Sierra Leone",
    "sm": "San Marino | San Marino",
    "sn": "Sénégal | Senegal",
    "so": "Soomaaliya | Somalia",
    "sr": "Suriname | Suriname",
    "ss": "South Sudan | South Sudan",
    "st": "São Tomé e Príncipe | São Tomé and Príncipe",
    "sv": "El Salvador | El Salvador",
    "sx": "Sint Maarten | Sint Maarten",
    "sy": "سوريا | Syria",
    "sz": "Swaziland | Swaziland",
    "tc": "Turks and Caicos Islands | Turks and Caicos Islands",
    "td": "Tchad | Chad",
    "tf": "Territoire des Terres australes et antarctiques fr | French Southern Territories",
    "tg": "Togo | Togo",
    "th": "ประเทศไทย | Thailand",
    "tj": "Тоҷикистон | Tajikistan",
    "tk": "Tokelau | Tokelau",
    "tl": "Timor-Leste | East Timor",
    "tm": "Türkmenistan | Turkmenistan",
    "tn": "تونس | Tunisia",
    "to": "Tonga | Tonga",
    "tr": "Türkiye | Turkey",
    "tt": "Trinidad and Tobago | Trinidad and Tobago",
    "tv": "Tuvalu | Tuvalu",
    "tw": "臺灣 | Taiwan",
    "tz": "Tanzania | Tanzania",
    "ua": "Україна | Ukraine",
    "ug": "Uganda | Uganda",
    "um": "United States Minor Outlying Islands | U.S. Minor Outlying Islands",
    "us": "United States | United States",
    "uy": "Uruguay | Uruguay",
    "uz": "O‘zbekiston | Uzbekistan",
    "va": "Vaticano | Vatican City",
    "vc": "Saint Vincent and the Grenadines | Saint Vincent and the Grenadines",
    "ve": "Venezuela | Venezuela",
    "vg": "British Virgin Islands | British Virgin Islands",
    "vi": "United States Virgin Islands | U.S. Virgin Islands",
    "vn": "Việt Nam | Vietnam",
    "vu": "Vanuatu | Vanuatu",
    "wf": "Wallis et Futuna | Wallis and Futuna",
    "ws": "Samoa | Samoa",
    // "xk": "Republika e Kosovës | Kosovo",
    "ye": "اليَمَن | Yemen",
    "yt": "Mayotte | Mayotte",
    "za": "South Africa | South Africa",
    "zm": "Zambia | Zambia",
    "zw": "Zimbabwe | Zimbabwe",
    "xx": "Unknown"
};

/* file: script/Grid.js */

Grid = {

    size: 16,
    hsize: 8,

    center: function(pos) {

        return Math.floor(pos / this.size) * this.size + this.hsize;

    },

    /* position to grid */

    pg: function(pos) {

        return Math.floor(pos / this.size);

    },

    gp: function(g) {

        return g * this.size;

    },

    /* grid (center) to position */

    gpc: function(pos) {

        return (pos + 0.5) * this.size | 0;

    }

}

/* file: script/Namespace.js */

CLIENT = {};
CLIENT.MotionGraphics = {};

CLIENT.WS_PROTOCOL = window.location.protocol === "https:" ? "wss://" : "ws://";
CLIENT.LOBBY_URL = window.location.protocol === "https:" ? "ws://51.254.213.59:80" : "ws://51.254.213.59:80";
// CLIENT.LOBBY_URL = window.location.protocol === "https:" ? "wss://localhost:443" : "ws://localhost:1338";

CLIENT.LOBBY_URL = localStorage.getItem("lobby_url");

if (!CLIENT.LOBBY_URL) {

    CLIENT.LOBBY_URL = "ws://188.166.167.60:80";
    CLIENT.LOBBY_URL = "ws://localhost:80";

}

CLIENT.POINT = 1;
CLIENT.CIRCLE = 2;
CLIENT.RECT = 4;

CLIENT.TWEEN_DURATION = CLIENT.UPDATE_INTERVAL * 1;

CLIENT.SHADOW_COLOR = "#aaa";
CLIENT.SHADOW_COLOR = "#b8b5a4";

CLIENT.LEFT = 0;
CLIENT.UP = 1;
CLIENT.RIGHT = 2;
CLIENT.DOWN = 3;

CLIENT.DUST_COLORS = ["#f1e9d7", "#d3be8f", "#ac9b75"];
CLIENT.DUST_CLOUD_COLORS = ["#c5b89e"];

NAMESPACE = CLIENT;

/* file: script/BitmapFont.js */

CLIENT.BitmapFont = function(image, ...defs) {

    this.id = ++CLIENT.BitmapFont.id;

    this.regions = Object.create(null);

    let canvas = document.createElement("canvas");
    let ctx = canvas.getContext("2d");

    canvas.width = image.width;
    canvas.height = image.height;

    ctx.drawImage(image, 0, 0);

    for (def of defs) {

        let srcX = def[0];
        let srcY = def[1];
        let srcW = def[2];
        let srcH = def[3];
        let letters = def[4];

        this.height = srcH - 1;
        this.spaceWidth = srcH * 0.5 | 0;

        let pixels = ctx.getImageData(srcX, srcY, srcW, 1).data;
        let letterIndex = 0;
        let letterWidth = 0;
        let letterX = 0;

        for (let x = 0; x < srcW; x++) {

            let separated = true;

            for (let y = 0; y < 1; y++) {

                let pixelIndex = (x + y * srcW) * 4;

                let a = pixels[pixelIndex + 3];

                if (a) {
                    separated = false;
                    break;
                }

            }

            if (!separated && x === srcW - 1) {
                separated = true;
                letterWidth++;
            }

            if (separated) {

                let letter = letters[letterIndex];

                this.regions[letter] = [srcX + letterX, srcY + 1, letterWidth, srcH - 1];

                letterIndex++;
                letterWidth = 0;
                letterX = x + 1;

            } else {

                letterWidth++;

            }

        }

    }

}
;

CLIENT.BitmapFont.id = 0;

CLIENT.BitmapFont.prototype = {

    constructor: CLIENT.BitmapFont,

    getSize(text) {

        let x = 0;
        let y = 0;
        let width = 0;

        for (var i = 0; i < text.length; i++) {

            let letter = text[i];

            if (letter === "\n") {

                y += this.height + 1;
                x = 0;

            } else if (letter === " ") {

                x += this.spaceWidth;

            } else if (this.regions[letter]) {

                x += 1 + this.regions[letter][2];

            }

            if (width < x)
                width = x;

        }

        return {
            width: width,
            height: y + this.height + 1
        };

    },

    getRegions(text) {

        let key = font.id + "--" + text;

        let result = [];

        let x = 0;
        let y = 0;

        for (var i = 0; i < text.length; i++) {

            let letter = text[i];

            if (letter === "\n") {

                y += font.height + 1;
                x = 0;

            } else if (letter === " ") {

                x += font.spaceWidth;

                continue;

            }

            if (!font.regions[letter])
                continue;

            let sprite = batch.add();
            let region = font.regions[letter];

            result.push({
                src: region,
                dst: [x, y, region[2], region[3]]
            });

            x += 1 + region[2];

        }

        return result;

    }

};

/* file: script/ImageBatch.js */

CLIENT.ImageBatch = function() {

    this.x = 0;
    this.y = 0;

    this.width = -1;
    this.height = -1;

    this.scale = {
        x: 1.0,
        y: 1.0
    };

    this.color = app.color(0x000000, 0.0);
    this.alpha = 1.0;
    this.dissolve = 0.0;

    this.index_counter = 0;

    this.elements = [];
    this.uv = null;
    this.mesh = null;

    this.meshBuffer = app.gl.createBuffer();
    this.uvBuffer = app.gl.createBuffer();

    this.needRebuild = false;

    this.texture = app.textures.spritesheet;
    this.matrix = Matrix3.create();
    this.program = app.programs.gui;

}
;

CLIENT.ImageBatch.prototype = {

    constructor: CLIENT.ImageBatch,

    add(sprite=null, region=null) {

        return this.create(sprite, region);

    },

    create(sprite=null, region=null) {

        this.needRebuild = true;

        let element = new CLIENT.ImageBatchElement(this);

        this.elements.push(element);

        if (sprite)
            element.setSprite(...sprite);
        if (region)
            element.setRegion(...region);

        return element;

    },

    clear() {

        this.elements.length = 0;

        this.needRebuild = true;

    },

    remove(element) {

        Utils.pull(this.elements, element);

        this.needRebuild = true;

    },

    removeArray(elements) {

        for (let element of elements)
            this.remove(element);

    },

    rebuild() {

        let gl = app.gl;

        let mesh = [];
        let uv = [];

        for (var i = 0; i < this.elements.length; i++) {

            let element = this.elements[i];

            let x = element.x;
            let y = element.y;
            let w = element.width;
            let h = element.height;

            mesh.push(x + 0, y + 0, x + w, y + 0, x + w, y + h, x + w, y + h, x + 0, y + h, x + 0, y + 0);

            x = element.sprite[0] / this.texture.width;
            y = element.sprite[1] / this.texture.height;
            w = element.sprite[2] / this.texture.width;
            h = element.sprite[3] / this.texture.height;

            uv.push(x + 0, y + 0, x + w, y + 0, x + w, y + h, x + w, y + h, x + 0, y + h, x + 0, y + 0);

        }

        gl.bindBuffer(gl.ARRAY_BUFFER, this.meshBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(mesh), gl.STATIC_DRAW);

        gl.bindBuffer(gl.ARRAY_BUFFER, this.uvBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(uv), gl.STATIC_DRAW);

        this.needRebuild = false;

    },

    render() {

        if (this.dissolve >= 1.0)
            return;

        if (!this.elements.length)
            return;

        let gl = app.gl;
        let program = this.program;

        if (this.needRebuild)
            this.rebuild();

        /* Alpha */

        gl.enable(gl.BLEND);
        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

        /* Assign shaders */

        gl.useProgram(program.native);

        /* Position */

        gl.enableVertexAttribArray(program.locations.position);

        gl.bindBuffer(gl.ARRAY_BUFFER, this.meshBuffer);
        gl.vertexAttribPointer(program.locations.position, 2, gl.FLOAT, false, 0, 0);

        /* Texturing */

        gl.activeTexture(gl.TEXTURE1);
        gl.bindTexture(gl.TEXTURE_2D, app.textures.palette);

        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, this.texture);

        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

        gl.enableVertexAttribArray(program.locations.uv);
        gl.bindBuffer(gl.ARRAY_BUFFER, this.uvBuffer);
        gl.vertexAttribPointer(program.locations.uv, 2, gl.FLOAT, false, 0, 0);

        program.set("texture", 0);
        program.set("color", this.color.r, this.color.g, this.color.b, this.color.a * this.alpha);
        program.set("alpha", this.alpha);
        // program.set("translation", this.x / app.width, this.y / app.height);
        program.set("paletteTexture", 1);
        program.set("palette", 0);
        program.set("dissolve", this.dissolve);

        Matrix3.reset(this.matrix);
        Matrix3.translate(this.matrix, this.x | 0, this.y | 0);
        Matrix3.scale(this.matrix, this.scale.x, this.scale.y);

        // Matrix3.scale(this.matrix, 1 / app.game.camera.scale, 1 / app.game.camera.scale);

        program.set("modelMatrix", this.matrix);

        /* Draw */

        gl.drawArrays(gl.TRIANGLES, 0, this.elements.length * 6);

    }

};

CLIENT.ImageBatchElement = function(batch) {

    this.batch = batch;

    this.x = 0;
    this.y = 0;
    this.width = 1;
    this.height = 1;
    this.sprite = [0, 0, 1, 1];

}
;

CLIENT.ImageBatchElement.prototype = {

    constructor: CLIENT.ImageBatchElement,

    remove() {

        this.batch.remove(this);

        return this;

    },

    setSprite(x, y, w, h) {

        this.sprite[0] = x;
        this.sprite[1] = y;
        this.sprite[2] = w;
        this.sprite[3] = h;

        this.batch.needRebuild = true;

        return this;

    },

    setRegion(x, y, w=0, h=0) {

        if (!w)
            w = this.sprite[2];
        if (!h)
            h = this.sprite[3];

        this.x = x;
        this.y = y;
        this.width = w;
        this.height = h;

        this.batch.needRebuild = true;

        return this;

    },

    setPosition(x, y) {

        this.x = x;
        this.y = y;

        this.batch.needRebuild = true;

        return this;

    }

};

/* file: script/Game.js */

CLIENT.Game = {

    staminaMeter: 0,

    debug: {},

    temp: {
        pickup_pitch: 1.0
    },

    interactionTriangle: [237, 20, 15, 9],

    requests: new Map,

    latency: 0,
    latencies: [],

    getLink: function() {

        this.send("game_link");

    },

    set hideHelp(value) {

        this._hideHelp = value;

        app.tween(this).to({
            helpY: value ? 756 : 0
        }, 0.5, "outQuad");

    },

    get hideHelp() {

        return this._hideHelp;

    },

    create: function() {

        this.weather = new CLIENT.Weather(this);

        this.events = new CLIENT.Events;
        this.hideUI = false;
        this.showNames = true;
        this.helpY = 0;
        this.hideHelp = Boolean(JSON.parse(localStorage.getItem("hideHelp")));

        this.nameFont = new CLIENT.TextAtlas("8px 'ingame'");
        this.chatFont = new CLIENT.TextAtlas("10px 'generic'");

        this.viewMatrix = Matrix3.create();

        this.pointerX = 0;
        this.pointerY = 0;

        this.sharer = new CLIENT.Sharer(app.data.shared);

        this.steps = 0;
        this.speed = 1.0;

        this.stainsBuffer = app.painter.createFramebuffer(2048, 2048);

    },

    fpsColors: {
        "good": 0x6abe30,
        "medium": 0xebbc15,
        "bad": 0xd43535
    },

    renderFPS() {

        if (this.hideUI)
            return;

        let bg = this.fpsColors.good;

        if (app.fps < 40)
            bg = this.fpsColors.medium;
        if (app.fps < 30)
            bg = this.fpsColors.bad;

        app.painter.reset();
        app.painter.color(bg);
        app.painter.align(1.0, 0.0);
        app.painter.fillRect(app.width, 0, 24, 16);

        this.nameFont.color = 0xffffff;
        this.nameFont.fillText(String(app.fps), app.width - 12, 6);
        this.nameFont.fillText("FPS", app.width - 12, 18);

        if (this.latency > 50)
            bg = this.fpsColors.medium;
        if (this.latency > 100)
            bg = this.fpsColors.bad;

        app.painter.color(bg);
        app.painter.align(1.0, 0.0);
        app.painter.fillRect(app.width - 24, 0, 32, 16);

        this.nameFont.color = 0xffffff;
        this.nameFont.fillText(String(this.latency), app.width - 24 - 16, 6);
        this.nameFont.fillText("PING", app.width - 24 - 16, 18);

        if (app.loader.count > 0) {

            app.painter.color(0);
            app.painter.fillRect(app.width - 64, 0, 18, 16);
            app.painter.align(0.5, 0.5);
            app.painter.color(-1);
            app.painter.rotate(app.lifetime);
            app.painter.drawAtlas("ui/loader16x", app.width - 64, 8);
            this.nameFont.fillText("LOAD", app.width - 64, 18);

        }

    },

    renderVisibility() {

        if (this.spectate)
            return;
        if (this.hideRoofs)
            return;

        if (!this.player || (!this.player.tile || !this.player.tile.groundDef || !this.player.tile.groundDef.roof))
            return false;

        var camera = this.camera;

        var tilesX = camera.ww / COMMON.TILE_WIDTH | 0;
        var tilesY = camera.wh / COMMON.TILE_HEIGHT | 0;

        var startX = Math.floor(camera.wx / COMMON.TILE_WIDTH);
        var startY = Math.floor(camera.wy / COMMON.TILE_HEIGHT);
        app.painter.reset();
        app.painter.align(0.0, 0.0);
        app.painter.color(0x111111);

        for (var x = -1; x <= tilesX + 1; x++) {
            for (var y = -1; y <= tilesY + 2; y++) {

                var tx = startX + x;
                var ty = startY + y;
                var tile = this.map.get(tx, ty);
                var down = this.map.get(tx, ty + 1);
                var up = this.map.get(tx, ty - 1);

                if (tile.groundDef && tile.groundDef.roof)
                    continue;
                if (down.groundDef && down.groundDef.roof)
                    continue;
                if (up.groundDef && up.groundDef.roof)
                    continue;

                app.painter.fillRect(tx * COMMON.TILE_WIDTH, ty * COMMON.TILE_HEIGHT, COMMON.TILE_WIDTH, COMMON.TILE_HEIGHT);
            }

        }

    },

    render: function(dt) {

        let layer = null;

        if (!this.ready) {

            return;

        }

        this.camera.step(app.elapsed);

        /* Translated */

        this.pointerRealX = (this.pointerX / this.camera.scale + this.camera.x);
        this.pointerRealY = (this.pointerY / this.camera.scale + this.camera.y);

        this.pointerGX = Grid.pg(this.pointerRealX);
        this.pointerGY = Grid.pg(this.pointerRealY);

        let gl = app.gl;

        /* Render stains */

        app.painter.setFramebuffer(this.stainsBuffer);

        Matrix3.reset(this.viewMatrix);
        Matrix3.multiply(this.viewMatrix, Matrix3.projection2(this.stainsBuffer.width, this.stainsBuffer.height));

        for (var key in app.programs) {

            let program = app.programs[key];

            gl.useProgram(program.native);

            program.set("viewMatrix", this.viewMatrix);

        }

        if (Utils.interval(this, "remove_stains", 0.5)) {

            app.painter.reset();
            app.painter.align(0, 0);
            app.painter.color(0xffffff, 0.02);
            app.painter.blend(gl.FUNC_REVERSE_SUBTRACT, gl.ZERO, gl.ONE, gl.ONE, gl.ONE);
            app.painter.fillRect(0, 0, this.stainsBuffer.width, this.stainsBuffer.height);

        }

        for (let entity of this.entities.children) {

            if (entity.renderStains && entity.inView)
                entity.renderStains();

        }

        /* Render eclipse */

        if (this.eclipse)
            this.eclipse.render();

        app.painter.setFramebuffer(null);

        gl.viewport(0, 0, app.canvas.width, app.canvas.height);
        Matrix3.reset(this.viewMatrix);
        Matrix3.multiply(this.viewMatrix, this.projectionMatrix);

        for (var key in app.programs) {

            let program = app.programs[key];

            gl.useProgram(program.native);

            program.set("viewMatrix", this.viewMatrix);

        }

        /* Normal render */

        gl.clearColor(0.6, 0.5, 0.45, 1.0);
        gl.colorMask(1.0, 1.0, 1.0, 1.0);
        gl.clear(gl.COLOR_BUFFER_BIT);

        this.renderBackground();

        Matrix3.reset(this.viewMatrix);
        Matrix3.reset(this.camera.matrix);
        Matrix3.scale(this.camera.matrix, this.camera.scale, this.camera.scale);
        Matrix3.translate(this.camera.matrix, Math.ceil(-this.camera.x), Math.ceil(-this.camera.y));
        Matrix3.multiply(this.viewMatrix, this.projectionMatrix);
        Matrix3.multiply(this.viewMatrix, this.camera.matrix);

        for (var key in app.programs) {

            let program = app.programs[key];

            gl.useProgram(program.native);

            program.set("viewMatrix", this.viewMatrix);

        }

        app.painter.reset();
        app.painter.align(0, 1.0);
        app.painter.scale(1 / this.stainsBuffer.scaleX, -1 / this.stainsBuffer.scaleY);
        app.painter.drawImage(this.stainsBuffer.texture, -this.innerWidth, -this.innerHeight);

        this.renderBorder();
        this.renderedEntities = 0;

        for (let entity of this.entities.children) {

            if (entity.render && entity.inView) {

                this.renderedEntities++;

                entity.render(app.layer);

            }

        }

        // this.renderVisibility();

        if (ENV.DEBUG) {

            for (let entity of this.entities.children) {

                if (entity.renderDebug && entity.inView) {

                    entity.renderDebug(app.layer);

                }
            }

        }

        // app.painter.reset()
        // app.painter.color(0xffffff);
        // app.painter.fillCircle(this.player.x, this.player.y, 50);

        /* Reset */

        Matrix3.reset(this.viewMatrix);
        Matrix3.multiply(this.viewMatrix, this.projectionMatrix);

        for (var key in app.programs) {

            let program = app.programs[key];

            gl.useProgram(program.native);

            program.set("viewMatrix", this.viewMatrix);

        }

        if (!this.hideNames && !this.hideUI) {

            let s = Math.min(1.0, Math.max(256, app.width * 0.25) / 600);

            app.painter.reset();
            app.painter.alpha(0.8);
            app.painter.align(1.0, 1.0);
            app.painter.scale(s, s);
            app.painter.drawImage("hotkeys", app.width - 106 / app.scale, app.height - 16 + this.helpY * s);

            this.renderRadar();
            this.renderGUI();

        }

        this.weather.render();

        this.renderTooltip();
        // this.renderEclipse();

        /* Blit eclipse */

        if (this.eclipse) {

            app.painter.reset();
            app.painter.align(0, 1.0);
            app.painter.scale(1, -1);
            app.painter.alpha(0.75);
            app.painter.drawImage(this.eclipseBuffer.texture, 0, 0);

        }

        if (this.modeData.clock)
            this.renderClock(app.width / 2, 40, Math.min(1.0, this.serverLifetime / this.modeData.duration), this.kills[0], this.kills[1]);

        if (this.modeController && this.modeController.onRender)
            this.modeController.onRender();

        this.controllers.call("render");

        this.renderFPS();
    },

    freeCamera: function() {

        $("body").children().not("canvas").hide();

        this.freecam = true;

        this.camera.follow = false;

    },

    keypress: function(e) {

        if (e.key === "tab") {

            e.original.preventDefault();
            e.original.stopPropagation();

        }

    },

    keydown: function(e) {

        if (this.window) {

            if (e.key === "b" || e.key === "escape" || e.key === "space") {

                this.window.close();

                this.inputLocked = false;

                this.window = null;

                app.sound.play("gameplay/close_chest");

            }

            return;

        }

        if (this.inputLocked)
            return;

        if (!this.ready)
            return;

        if (e.key === "xtab") {

            e.original.preventDefault();
            /*
            if (this.chatChannel === "default") this.selectChatChannel(this.player.shared.flag);
            else this.selectChatChannel("default");

            localStorage.setItem("chat_channel", this.chatChannel);
            */

        } else if (e.key === "f2" || e.key === "tab") {

            e.original.preventDefault();

            this.scoreboard.show();

        }

        if (this.keymode === this.KEYMODE_TEXTINPUT) {

            switch (e.key) {

            case "escape":

                this.keymode = this.KEYMODE_GAME;

                this.$textinput.hide();
                app.console.fold();

                break;

            case "enter":

                this.keymode = this.KEYMODE_GAME;

                this.$textinput.hide();
                app.console.fold();

                this.send("message", {

                    text: this.$textinput.val(),
                    channel: this.chatChannel

                });

                break;
            }

            return;

        } else {

            this.input.press(e.key);

            if (e.key === "space" && (!this.player || this.player.dead)) {

                this.followNext();

            } else if (e.key === "space" && this.interactor) {

                this.send("interact");
                /*
                                if (this.interactiveObject) {

                                    this.send("interact", this.interactiveObject.sid);
                                    this.openContainer(this.interactiveObject);

                                }
                                */

            } else if (e.key === "enter") {

                this.keymode = this.KEYMODE_TEXTINPUT;

                app.console.unfold();
                this.$textinput.show();
                this.$textinput.focus();
                this.$textinput.val("");

            } else if (e.key === "shift") {
            } else if (e.key === "f8") {

                ENV.DEBUG = !ENV.DEBUG;

            } else if (e.key === "f7") {

                this.freecam = true;
                this.hideUI = !this.hideUI;

                $("body").children().not("canvas").hide();

            } else if (e.key === "f6") {

                this.showNames = !this.showNames;

            } else if (e.key === "f1") {

                app.showHelp();

            } else if (e.key === "f9") {

                this.toggleSpectate();

            } else if (e.key === "m") {

                this.showMap();

            }

        }

    },

    playerInRange(e) {

        return this.player && Utils.quickPointInRange(e.center.x, e.center.y, this.player.x, this.player.y, COMMON.INTERACTION_DISTANCE);

    },

    followNext() {

        if (this.player && !this.player.dead)
            this.camera.follow = this.player;
        else if (this.mode === "soccer" && this.ball) {

            this.camera.setFollow(this.ball);

        } else if (!this.ended)
            this.camera.setFollow(Utils.random(this.entities.groups.citizens));

    },

    setHouseMusic(state) {

        if (this.houseMusicState === state)
            return;

        this.houseMusicState = state;

        if (state) {
            this.houseMusic.fadeTo(1.0, 2.0);
            this.weather.enterHouse();
        } else {
            this.houseMusic.fadeTo(0.001, 2.0);
            this.weather.leaveHouse();

        }

    },

    setTooltip(text) {

        if (this.tooltipLifespan <= 0) {

            this.tooltipZ = -40;

            app.tween(this).to({
                tooltipZ: 100
            }, 0.2, "outQuad");

        }

        this.tooltip = text;
        this.tooltipLifespan = 0.5;

    },

    alertForeground: {
        "default": 0xffffff,
    },

    alertBackground: {
        "default": 0x888888,
        "success": 0x88bb00,
        "error": 0x880000,
        "warning": 0xbb8800
    },

    setAlert(data) {

        if (this.hideUI)
            return;

        let text = data.text || "???";

        if (data.sound)
            app.sound.play(data.sound);

        data.type = data.type || "default";

        data.foreground = this.alertForeground[data.type] || this.alertForeground.default;
        data.background = this.alertBackground[data.type] || this.alertBackground.default;

        if (this.alertLifespan <= 0) {

            this.alertZ = -40;

            app.tween(this).to({
                alertZ: 130
            }, 0.2, "outQuad");

        }

        this.alert = data;
        this.alertLifespan = 10;

        app.sound.play("ui/error");

    },

    keyup: function(e) {

        if (this.window) {

            return;

        }

        if (this.inputLocked)
            return;

        if (this.keymode === this.KEYMODE_TEXTINPUT) {
        } else {

            this.input.release(e.key);

            if (e.key === "shift") {
            } else if (e.key === "f2" || e.key === "tab") {

                this.scoreboard.hide();

            } else if (e.key === "m") {

                this.hideMap();

            }

        }

    },

    itemCommands: {
        "item1": 1,
        "item2": 2,
        "item3": 3,
        "item4": 4
    },

    toggleSpectate() {

        this.spectate = !(this.spectate | 0);

        if (this.spectate) {

            this.camera.follow = this.spectator = {
                x: this.camera.center.x,
                y: this.camera.center.y
            };

        } else {

            this.camera.follow = this.player;

        }

        this.send("spectate");

    },

    openContainer(entity) {

        if (this.window) {

            this.window.close();
            this.window = null;

        }

        let panel = new UI.ContainerPanel(entity);

        panel.$widget.addClass("absolute-center layer-1");
        panel.$widget.appendTo("body");

        this.window = panel;

        this.inputLocked = true;

        this.containerPanel = panel;

        panel.onClose = ()=>{
            this.containerPanel = null;
        }

        app.sound.play("gameplay/open_chest");

    },

    press: function(e) {

        if (this.inputLocked)
            return;

        let command = e.command;

        if (this.moveKeys[command]) {

            this.setMoving(this.moveKeys[command], true);

            if (e.double)
                this.send("dash", this.moveKeys[command]);

        } else if (this.itemCommands[command])
            this.itemOn(this.itemCommands[command] - 1);

        switch (command) {

        case "emote":

            this.openEmoteWindow();

            break;

        case "run":

            if (this.interactiveObject) {
            // this.send("interact", this.interactiveObject.sid);
            // this.openContainer(this.interactiveObject);

            } else {
                this.send("growl_start");

            }

            break;

        case "kick":

            // this.send("useSkill", "kick");

            break;

        case "roll":

            this.send("useSkill", "roll");

            break;

        case "block":

            this.send("useSkill", "block");

            break;

        case "jump":

            this.send("useSkill", "jump");

            break;

        case "attack":

            this.send("press");

            break;

        case "throw_weapon":

            this.send("throw_weapon");

            break;

        case "spell1":

            this.send("useSkill", "spell1");

            break;

        case "help":

            this.hideHelp = !this.hideHelp;

            localStorage.setItem("hideHelp", JSON.stringify(this.hideHelp));

            break;

        }

    },

    release: function(e) {

        if (this.inputLocked)
            return;

        let command = e.command;

        if (this.moveKeys[command])
            this.setMoving(this.moveKeys[command], false);
        else if (this.itemCommands[command])
            this.itemOff(this.itemCommands[command] - 1);

        switch (command) {

        case "emote":

            this.closeEmoteWindow();

            break;

        case "run":

            this.send("growl_stop");

            if (e.duration < 0.15)
                this.send("useSkill", "kick");

            break;

        case "attack":

            this.send("release");

            break;

        }

    },

    showAcks: function() {

        var $gui = app.parseUI("html/acks");

        $gui.appendTo("body");

        setTimeout(function() {

            $gui.remove();

        }, 3000);

    },

    connect: function(data) {

        this.ready = false;

        this.kill();

        if (this.socket)
            this.socket.close();

        // data.url = "localhost:1337";

        // if (window.analytics) analytics('send', 'event', 'game', 'keyboard_layout_' + localStorage.getItem("keyboardLayout"));

        if ($_GET['server'])
            data.url = $_GET['server'];

        this.socket = new WebSocket(app.wsURL(data.url, ENV.wsPort, ENV.wssPort));

        this.socket.binaryType = "arraybuffer";

        this.socket.addEventListener("open", this.onconnect.bind(this));
        this.socket.addEventListener("message", this.onmessage.bind(this));
        this.socket.addEventListener("close", this.ondisconnect.bind(this));

        this.connectionData = data;

    },

    preloadSprite: function(key) {

        if (!app.sprites[key]) {

            var sprite = new CLIENT.Sprite();

            sprite.swap(key);

        }

    },

    preloadHero: function() {

        var sprites = ["run", "cast", "kick", "roll", "spin", "block", "growl", "throw", "punch1", "punch2", "stunned", "fall_back", "fall_front", "charge_meele", "charge_spell", "attack_vertical", "attack_horizontal"];

        var citizen = this.player;

        if (citizen.weapon === "spear") {

            sprites.push("spear_jump");
            sprites.push("spear_attack");

        }

        for (var i = 0; i < sprites.length; i++) {

            let sprite = sprites[i];

            this.preloadSprite("grunt/" + citizen.body + "/" + sprite);

            if (citizen.weapon)
                this.preloadSprite("grunt/" + (citizen.weaponData.sprite || citizen.weapon) + "_" + sprite);
            if (citizen.shield && citizen.shield !== "no_shield")
                this.preloadSprite("grunt/" + citizen.shield + "_" + sprite);
            if (citizen.helmet && citizen.helmet !== "no_helmet")
                this.preloadSprite("grunt/" + citizen.helmet + "_" + sprite);
            if (citizen.cape && citizen.cape !== "no_cape")
                this.preloadSprite("grunt/" + citizen.shared.cape + "_" + sprite);

        }

    },

    leave: function() {

        if (this.music) {
            this.music.fadeOut(2.0);
            this.music = false;
        }

        if (this.windLoop) {
            this.windLoop.stop();
            this.windLoop = null;
        }

        this.scoreboard.destroy();
        this.scoreboard = false;

        this.kill();

        if (this.stompLoop) {

            this.stompLoop.stop();
            this.stompLoop = false;

        }

        if (this.crowdLoop) {

            this.crowdLoop.stop();
            this.crowdLoop = false;

        }

        this.$gold.remove();

        if (this.connectionData.spectate)
            CLIENT.Audience.closePanel();
        if (this.containerPanel)
            this.containerPanel.close();

        this.weather.kill();

        if (this.$tempGameCounter) {

            this.$tempGameCounter.remove();
            this.$tempGameCounter = null;

        }

        this.eclipse = null;
    },

    kill: function() {

        if (this.entities) {

            for (var i = 0; i < this.entities.groups.citizens.length; i++) {

                var citizen = this.entities.groups.citizens[i];

                citizen.state.set("idle");
                citizen.step(1);

            }

            for (var i = 0; i < this.entities.children.length; i++) {

                var e = this.entities.children[i];

                this.entities.remove(e);

            }

            this.entities.step(1);

            this.entities = false;

        }

        if (this.ready) {

            this.ready = false;

        }

        if (this.socket) {
            this.socket.close();
            this.socket = false;
        }

        if (this.$textinput)
            this.$textinput.remove();

        this.hideRespawn();

    },

    initControls: function() {

        this.input = new CLIENT.Input({

            onPress: this.press.bind(this),
            onRelease: this.release.bind(this)

        });

        for (var command in app.controls) {

            let keys = app.controls[command];

            for (let key of keys)
                this.input.set(command, key);

        }

    },

    enter: function() {

        app.console.fold();

        $(app.canvas).show();

        // $("#zoomIn").show();
        // $("#zoomOut").show();

        // app.frameskip = app.options.fps_60 ? 0 : 2;

        this.initControls();

        this.announcer = new CLIENT.Announcer();

        this.timeCompression = 1.0;

        if (window.analytics && !localStorage.getItem("resolution_reported")) {
            var res = Utils.ground(window.innerWidth, 128) + "x" + Utils.ground(window.innerHeight, 128);
            localStorage.setItem("resolution_reported", res);
            analytics('send', 'event', 'resolution', res);

        }

        // this.windLoop = app.sound.play("background/rain").volume(0.25).loop();

        this.steps = 0;

        this.player = this.playersCitizen = false;

        this.kills = [0, 0];

        this.itemsTimers = {};

        this.moving = 0;

        this.desiredDirection = 0;

        this.ui = PLAYGROUND.MOBILE ? CLIENT.Game.Mobile : CLIENT.Game.Desktop;

        this.ready = false;

        this.throttles = null;

        this.keymode = this.KEYMODE_GAME;

        this.$gold = $(`<span class="gui-gold-counter game-gold-counter">
      <span class="count">0</span>
      <img src="images/coin.gif" class="coin">
      <div class="game-gold-progress"></div>
    </span>`);

        this.$gold.appendTo(document.body);
        this.$gold.css("zIndex", 100);
        this.$goldCapProgress = this.$gold.children(".game-gold-progress");

        if (app.live) {

            $("body").children().not("canvas").hide();
            app.console.$container.show();

        }

        if (app.lobby.tempGame)
            this.showTempGameCounter();

        app.eventGameplayStart();

    },

    KEYMODE_GAME: 0,
    KEYMODE_TEXTINPUT: 1,

    showTempGameCounter() {

        let $popup = UI.parse(`
        <div class="popup window absolute-center-top gui-cols spacing-md ui no-max-width">
            <p ui-id="text"></p>
        </div>`);

        $popup.appendTo(document.body);

        this.$tempGameCounter = $popup;

        return $popup;

    },

    add: function() {

        var args = Array.from(arguments);

        return this.entities.add.apply(this.entities, args);

    },

    send: function(message, data) {

        if (app.data.shared[message]) {

            data = this.sharer.encode(message, data);
            message = this.sharer.getKeyIndex(message);

        }

        var packet = msgpack.encode([message, data]);

        this.socket.send(packet);

        return;

        var packet = [message, data];

        this.socket.send(JSON.stringify(packet));

    },

    onconnect: function() {

        if (window.analytics && app.altport)
            analytics('send', 'event', 'menu', 'altport_game');

        this.connectionData.gender = app.user.gender;

        this.send("hello", this.connectionData);

    },

    ondisconnect: function() {

        if (app.live) {

            setTimeout(function() {

                window.location = window.location;
            }, 1000);

        }

    },

    isMate: function(citizen) {

        if (!this.player)
            return;
        if (citizen === this.player)
            return;

        return this.player.shared.gameLink && citizen.shared.gameLink == this.player.shared.gameLink;

    },

    getGameLink: function() {
        // for (var i = 0; i < ip_array.length; i++) link += Utils.padStart(parseInt(ip_array[i]).toString(16), 2, 0);

        let link = this.connectionData.url + "__" + this.player.shared.gameLink;

        return link;

    },

    onmessage: function(event) {

        // var packet = BISON.decode(event.data);
        var packet = msgpack.decode(new Uint8Array(event.data));

        var message = packet[0];
        var data = packet[1];

        this.handleMessage(message, data);

    },

    addGold: function(gold) {

        if (gold > 5) {

            UI.animateCount(this.$gold, {
                from: app.user.gold,
                to: app.user.gold + gold,
                duration: 1.0,
                counter: ".count"
            });

        } else {

            this.$gold.children(".count").html(app.user.gold + gold);

        }

        app.setGold(app.user.gold + gold);

    },

    handlePrivateData: function(data) {

        var changes = this.sharer.decode("PlayerPrivateData", data, true);

        Object.assign(this.privateData, changes);

        if (changes.items)
            this.privateData.itemsUpdates = 1 + (this.privateData.itemsUpdates | 0);

        if (changes.exp !== undefined) {

            this.privateData.level = COMMON.expToLevel(this.privateData.exp);
            this.privateData.currentLevelExp = COMMON.levelToExp(this.privateData.level);
            this.privateData.nextLevelExp = COMMON.levelToExp(this.privateData.level + 1);

        }

        if (changes.interactor_sid !== undefined) {

            if (changes.interactor_sid) {

                this.interactor = this.entities.sid(changes.interactor_sid);

            } else {

                this.interactor = null;

            }

        }

        // GOLDBACK REMOVE NEXT
        /*
        if (changes.gold_inc !== undefined) {
          
          if(!this.lastgoldinc) this.lastgoldinc = 0;

          this.addGold(changes.gold_inc - this.lastgoldinc);

          this.lastgoldinc = changes.gold_inc;
          
        }
        */

        if (changes.gold_cap !== undefined) {

            this.addGold(app.user.gold_cap - changes.gold_cap);

            app.user.gold_cap = changes.gold_cap;

            let progress = 1.0 - app.user.gold_cap / COMMON.GOLD_CAP;

            this.$goldCapProgress.css("width", (progress * 100) + "%");

        }

        this.handleStats(changes);

    },

    handleGameData(changes) {

        if (changes.weather)
            this.weather.set(changes.weather);

    },

    handleStats: function(data) {

        if (data.bones !== undefined) {

            app.user.bonesEarned = (app.user.bonesEarned | 0) + (data.bones - (app.user.bones | 0));

            app.user.bones = data.bones;

        }

        if (data.kills !== undefined) {

            app.user.killsEarned = (app.user.killsEarned | 0) + (data.kills - (app.user.kills | 0));

            app.user.kills = data.kills;

        }

        if (data.goals !== undefined) {

            app.user.goalsEarned = (app.user.goalsEarned | 0) + (data.goals - (app.user.goals | 0));

            app.user.goals = data.goals;

        }

        if (data.flags !== undefined) {

            app.user.flagsEarned = (app.user.flagsEarned | 0) + (data.flags - (app.user.flags | 0));

            app.user.flags = data.flags;

        }

        if (data.graveyard_score !== undefined) {

            app.user.graveyard_scoreEarned = (app.user.graveyard_scoreEarned | 0) + (data.graveyard_score - (app.user.graveyard_score | 0));

            app.user.graveyard_score = data.graveyard_score;

        }

    },

    handleMessage(message, data) {
        if (typeof message === "number")
            message = this.sharer.getKey(message);

        if (app.data.shared[message])
            data = this.sharer.decode(message, data, true);

        if (CLIENT.Game.MessageHandler[message])
            CLIENT.Game.MessageHandler[message](this, data);

        if (this.modeController && this.modeController.onMessage)
            this.modeController.onMessage(message, data);

    },

    clash(a, b) {

        if (a.inView) {

            var sprite = this.entities.add("Sprite");

            sprite.x = a.x + (b.x - a.x) / 2;
            sprite.y = a.y + (b.y - a.y) / 2;
            sprite.set("fx/impact_spark_radial", false);
            sprite.setDuration(0.6);
            sprite.scale = 1.0;
            sprite.color = "#ffffff";

            app.sound.play("axe/blocked").rrate(0.1).gpan(this);

        }

    },

    ask: function(message, data) {

        data = data || {};

        data.question = message;

        data.request_id = this.request_id++;

        this.send("ask", data);

        return new Promise((resolve,reject)=>{

            this.requests.set(data.request_id, resolve);

            setTimeout(reject, 10000);

        }
        );

    },

    parseQueue: function(queue) {

        while (queue.length) {

            var packet = queue.shift();

            var message = packet[0];
            var data = packet[1];

            this.handleMessage(message, data);

        }

    },

    areEnemies(a, b) {

        if (a.sid === a.shared.partner_sid || b.sid === a.shared.partner_sid)
            return false;
        if (a === b)
            return false;

        if (this.modeData.enemyMode === "ffa")
            return true;

        if (a.team === 2 || b.team === 2)
            return true;

        return a.team !== b.team;
    },

    updateSharedEntity: function(data) {

        if (!this.entities)
            return;

        var sid = data[1];

        var entity = this.entities.sid(sid);

        if (!entity) {

            var cname = this.sharer.getKey(data[2]);

            var changes = this.sharer.decode(cname, data, true);

            entity = this.entities.add(cname, {
                shared: changes
            });

        } else {

            var changes = this.sharer.decode(entity.constructorName, data, true);

            entity.update(changes);

        }

    },

    canDoodle: function(count=1) {

        return this.doodlesCount + count <= 300;

    },

    gameOver(score, maxScore, victory) {

        app.eventGameplayStop();

        let progress = Math.min(1.0, score / maxScore);

        if (this.modeData.fun) {

            if (score >= 10) {
                progress = 0.2
            }
            if (score >= 50) {
                progress = 0.4
            }
            if (score >= 100) {
                progress = 0.6
            }
            if (score >= 200) {
                progress = 0.8
            }
            if (score >= 300) {
                progress = 1.0
            }

        }

        if (progress > 0.5)
            app.happyTime(progress);

        let motion = NAMESPACE.MotionGraphics.game_over({
            path: "motiongraphics/game_over/",
            progress: progress,
            maxScore: Math.max(score, maxScore),
            victory
        });

        setTimeout(()=>{

            let respawnWindow = this.showRespawn();

            app.tween(motion).to({
                scaleY: 0.0,
                scaleX: 0.0
            }, 0.25).then(function() {
                motion.kill();
            });

            if (app.game.mode === "arena1" || app.game.mode === "arena2") {

                var change = victory ? 10 : -10;

                let scoreKey = COMMON.modes["arena1"].scoreKey;

                var counter = respawnWindow.addCounter({
                    title: "ARENA",
                    max: app.lobby.maxMMR[scoreKey],
                    value: app.user[scoreKey],
                    icons: COMMON.ARENA_RANKS,
                    color: "#f51"
                });

                counter.val(Math.max(0, app.user.arena_mmr + change));

            }

            if (app.game.mode === "soccer") {

                let scoreKey = COMMON.modes["arena1"].scoreKey;

                var change = victory ? 1 : -1;

                var counter = respawnWindow.addCounter({
                    title: "GOALS",
                    max: app.lobby.maxMMR[scoreKey],
                    value: app.user[scoreKey] - app.user.goalsEarned,
                    icons: COMMON.SOCCER_RANKS,
                    color: "#f51"
                });

                counter.val(app.user.goals);

            }

        }
        , 5000);

        if (this.modeData.fun)
            return;

        if (victory) {

            app.sound.play("victory");

        } else {

            app.sound.play("loose");

        }

        if (this.mode === "soccer") {

            app.sound.play("audience/whistle").rate(1.4);
            app.sound.play("audience/whistle").rate(1.4).delay(0.6);
            app.sound.play("audience/whistle").rate(1.4).delay(1.2);

        }

    },

    start: function(data) {

        this.houseMusicState = false;

        this.tooltipLifespan = 0;
        this.alertLifespan = 0;

        this.request_id = 1;

        this.hideNames = false;

        this.doodlesCount = 0;

        this.window = null;

        this.interactiveObject = null;

        this.privateData = {
            stamina: 0
        };
        this.stamina = 0.0;

        this.chatChannel = "default";

        this.showRespawnTimeout = 0;

        this.cameraDistanceX = 0;
        this.cameraDistanceY = 0;

        this.pattern = false;

        this.navmarks = [];

        this.speed = data.speed;

        this.sharer.setKeys(data.sharedKeys);

        this.mode = data.mode;

        this.modeData = COMMON.modes[this.mode];

        if (this.modeData.shadows) {

            this.hellHighscore = localStorage.getItem("hell_highscore") | 0;

        }

        if (window.analytics)
            analytics('send', 'event', 'experiments', 'mode_' + this.mode);

        if (this.modeData.music)
            this.music = app.sound.play(this.modeData.music).loop().volume(0.5).fadeIn(0.5);

        this.fun = this.modeData.fun;

        this.width = this.innerWidth = data.innerWidth;
        this.height = this.innerHeight = data.innerHeight;

        this.stainsBuffer.scaleX = this.stainsBuffer.width / (this.innerWidth * 2);
        this.stainsBuffer.scaleY = this.stainsBuffer.height / (this.innerHeight * 2);

        if (!this.fun) {

            this.frags = [0, 0];

        }

        this.lifetime = 0;

        this.entities = new CLIENT.Entities(this);

        this.entities.createGroup("citizens");
        this.entities.createGroup("interactive");

        this.camera = new CLIENT.Camera();

        this.map = new CLIENT.InfiniteMap();
        this.map.tileset = app.data.tileset;

        if (data.mapData) {

            this.map.unserialize(data.mapData);

        }

        this.camera.limit = {
            left: -this.innerWidth - 200,
            top: -this.innerHeight - 200,
            right: this.innerWidth + 200,
            bottom: this.innerHeight + 200
        }

        /*
            for (var entity_data of app.data.map.entities) {

              let entity_constructor = entity_data.entity;

              this.entities.add(entity_constructor, entity_data);

            }

            */

        this.scoreboard = new CLIENT.Scoreboard(this);
        this.scoreboard.hide();

        if (!this.modeData.fun) {

            this.scoreboard.$right.hide();

        }

        if (this.modeData.hideScore)
            this.scoreboard.hide();

        /* Parse snapshot */

        // this.map = new CLIENT.Map(this, data.map);

        /*


        for (var i = 0; i < 10; i++) {
          this.entities.add("TilesetLayer", {
            index: i,
            z: i * 32
          });
        }
        */

        for (var i = 0; i < data.entities.length; i++) {

            var encoded = data.entities[i];
            //console.log(encoded)
            //console.log(encoded)

            if (!encoded)
                continue;

            //console.log(this.sharer.getKey(encoded[1]));
            var constructorName = this.sharer.getKey(encoded[1]);
            //console.log(constructorName)
            //console.log(data.entities)
            //console.log(constructorName)
            var decoded = this.sharer.decode(constructorName, encoded);
            //console.log(decoded)

            if (!constructorName)
                continue;

            var entity = this.entities.add(constructorName, {
                shared: decoded
            });

        }

        if (this.modeData.crowdLoop)
            this.crowdLoop = app.sound.play("background/match").loop().volume(1.0);
        if (this.modeData.stompLoop)
            this.stompLoop = app.sound.play("audience/stomp").loop().volume(0.2).rate(0.8);

        this.$textinput = $("<input>").addClass("gui-input chat-input").appendTo("body");
        this.$textinput.hide();

        this.resize();

        if (this.modeData.practice) {

            this.trainingWindow = new CLIENT.TrainingWindow;

            if (this.mode === COMMON.MODE_TUTORIAL) {

                this.trainingWindow.$gui.$desc.html("When you are done with tutorial go back to the menu and explore RUINS or fight on the ARENA (1 vs 1)");
                this.trainingWindow.$gui.$social.hide();

            }

        }

        if ($_HASH['game_link']) {

            if (window.analytics)
                analytics('send', 'event', 'game', 'game_link_start');

        }

        this.modeController = null;

        if (this.modeData.controller && CLIENT.Game[this.modeData.controller])
            this.modeController = new CLIENT.Game[this.modeData.controller](this);

        if (!app.options.ingame_chat) {

            this.$textinput.hide();

        }

        this.addGold(0);

        this.controllers = new CLIENT.Controllers;

        if (this.modeData.shadows) {

            CLIENT.Announcer2.run("shadow");
        }

        if (!app.user.guest) {

            this.questWidgets = [new UI.QuestCounter(0), new UI.QuestCounter(1)];

            this.questWidgets[0].$element.appendTo(document.body);
            this.questWidgets[1].$element.appendTo(document.body);

        }

        this.followNext();

        CLIENT.Audience.init();

        if (this.connectionData.spectate)
            CLIENT.Audience.showPanel();

        if (this.modeData.eclipse)
            this.eclipse = new CLIENT.Eclipse();

        // this.entities.add("Marker", { x: 0, y: 0, marker: "center", globalMarker: true })

        this.entities.add("VisibilityLayer");

        this.houseMusic = app.sound.play("background/" + (this.modeData.houseMusic || "house_music")).loop();
        this.houseMusic.fadeTo(0.001, 0.1);

        this.kingMarker = this.entities.add("Marker", {
            globalMarker: true,
            marker: "king"
        });

    },

    renderClock(x, y, time=0.0, left=0, right=0) {

        app.painter.reset();
        app.painter.drawAtlas("ui/clock", x, y);
        app.painter.align(0.0, 1.0);
        app.painter.rotate(time * Math.PI * 2 - Math.QPI);
        app.painter.drawAtlas("ui/clock_hand", x, y - 8)

        this.nameFont.color = 0xffffff;
        this.nameFont.fillText(String(left), x - 21, y + 2);
        this.nameFont.fillText(String(right), x + 21, y + 2);

    },

    generateMinimap() {
    },

    selectChatChannel: function(channel) {

        if (!app.options.ingame_chat)
            return;

        this.chatChannel = channel;

        this.send("chatHistory", channel);

        if (channel === "default") {

            app.console.setTitle("Press TAB to see SCOREBOARD")

        } else {

            var title = $("<div>").append(UI.getFlag(channel)).append(channel.toUpperCase() + " ").append(" CHAT - Press TAB to change");

            app.console.setTitle(title);

        }

        app.console.clear();

    },

    step: function(dt) {

        if (this.delay > 0)
            return this.delay -= dt;

        if (!this.ready)
            return;

        if (this.eclipse)
            this.eclipse.step(dt);

        this.stamina = Utils.moveTo(this.stamina, this.privateData.stamina, Math.abs(this.stamina - this.privateData.stamina) * dt * 2.0);

        if (this.temp.pickup_pitch > 1.0)
            this.temp.pickup_pitch -= dt;

        dt *= this.speed * this.timeCompression;

        this.steps++;
        this.lifetime += dt;

        this.entities.step(dt);

        this.ui.step(this, dt);

        if (this.playersCitizen) {

            if (!this.window && Utils.interval(this, "direction", 0.05)) {

                var direction = this.desiredDirection;

                var dirDistance = Utils.circDistance(direction, this.playersCitizen.bearing);

                if (Math.abs(dirDistance) > COMMON.TORSO_LIMIT) {

                    direction = this.playersCitizen.bearing - COMMON.TORSO_LIMIT * Utils.sign(dirDistance);

                }

                if (this.playersCitizen.state.current.can & COMMON.CAN_ROTATE) {

                    this.playersCitizen.desiredDirection = direction;

                }

                // let direciton = Utils.round(direction, 1);
                let sentDirection = Utils.ground(direction, 0.1);

                if (sentDirection !== this.lastDirection) {

                    this.send("direction", sentDirection);

                    this.lastDirection = sentDirection;

                }

                this.send("pointer", [this.pointerRealX, this.pointerRealY]);

            }

            for (var index in this.itemsTimers) {

                var timestamp = this.itemsTimers[index];

                if (this.lifetime - timestamp > 0.6) {

                    this.send("throwItem", {
                        index: index
                    });

                    delete this.itemsTimers[index];

                }

            }

        }

        if (Utils.interval(this, "tick", 0.1)) {

            this.announcer.step(0.1);

        }
        ;
        if (Utils.interval(this, "tock", 0.5)) {

            for (var i = 0; i < this.entities.children.length; i++) {

                let e = this.entities.children[i];

                if (typeof e.tock !== "undefined")
                    e.tock(0.5);

            }

            this.tock(0.5);

        }
        ;
        if (Utils.interval(this, "ping", 1.0)) {

            this.send("ping");
            this.lastPing = Date.now();

        }

        if (Utils.interval(this, "scoreboard", 2.0)) {

            var playerPrevRank = this.player.rank;

            var best = Utils.chain(this.entities.groups.citizens).set("rank", 0).sortBy("score").takeRight(10).reverse().value();

            for (var i = 0; i < best.length; i++) {

                var citizen = best[i];

                if (citizen.shared.score < 10) {

                    citizen.rank = 0;

                } else {

                    citizen.rank = 10 - i;

                }

            }

            // if (playerPrevRank === 10 && this.player.rank !== 10) this.announcer.enqueue("king_lost");
            // if (playerPrevRank !== 10 && this.player.rank === 10) this.announcer.enqueue("king");

            this.scoreboard.step();

        }

        if (this.pointerGrowling && !this.growling && (this.lifetime - this.pointerGrowlingTimestamp) > 0.2) {

            this.send("growl");

            this.growling = true;

        }

        if (this.moving !== this.sentMoving) {

            this.sentMoving = this.moving;

            this.send("move", {
                key: this.moving,
            });

        }

        var ctx = this.camera.x / COMMON.TILE_WIDTH;
        var cty = this.camera.y / COMMON.TILE_HEIGHT;

        this.ics = 1 / this.camera.scale;

        if (this.ctx !== ctx || this.cty !== cty) {

            if (ctx !== this.ctx)
                this.ctx = ctx;
            if (cty !== this.cty)
                this.cty = cty;

            this.refreshTiles();

        }

        if (this.respawnWindow) {

            if (window.arapi && app.ads) {

                arapi.update();
                arapi.x = this.respawnWindow.$gui.$right.offset().left;
                arapi.y = this.respawnWindow.$gui.$right.offset().top;
                arapi.height = this.respawnWindow.$gui.outerHeight();
                arapi.width = this.respawnWindow.$gui.outerWidth();

            }

            if (this.player) {

                var timeLeft = Math.max(0, this.respawnTime - this.playersCitizen.state.elapsed);

                this.respawnWindow.setTimeLeft(timeLeft);

            }

        }

        if (this.showRespawnTimeout > 0) {

            this.showRespawnTimeout -= dt;

            if (this.showRespawnTimeout <= 0)
                this.showRespawn();

        }

        this.controllers.call("step", dt);

        if (this.camera.follow && !this.camera.follow.dead)
            this.camera.followTimeout = 3.0;

        if (!this.camera.follow)
            this.followNext();

        if (this.camera.follow && this.camera.follow.dead) {

            if ((this.camera.followTimeout -= dt) <= 0) {
                this.followNext();
            }

        }

        CLIENT.Audience.step(dt);

        if (this.modeData.visibility)
            this.updateVisibility();

        for (let key in this.itemsSprites)
            this.itemsSprites[key].step(dt);

        if (this.spectate && this.spectator) {
            if (app.keyboard.keys.a)
                this.spectator.x -= 300 * dt;
            if (app.keyboard.keys.d)
                this.spectator.x += 300 * dt;
            if (app.keyboard.keys.w)
                this.spectator.y -= 300 * dt;
            if (app.keyboard.keys.s)
                this.spectator.y += 300 * dt;
        }

        if (this.king) {
            this.kingMarker.x = this.king.x;
            this.kingMarker.y = this.king.y;
            this.kingMarker.hidden = false;
        } else {
            this.kingMarker.hidden = true;
        }
    },

    setKing(king) {

        if (this.king === this.player && king !== this.player)
            this.announcer.enqueue("king_lost");
        if (this.king === this.player)
            this.announcer.enqueue("king");

        this.king = king;

    },

    tock(dt) {
        /*
                let interactiveObject = this.interactiveObject;

                this.interactiveObject = this.getInteractiveObjectInRange();

                if (this.interactiveObject && interactiveObject !== this.interactiveObject) {

                    app.sound.play("ui/cycle_interaction");

                }

                */

        if (this.modeController && this.modeController.tock)
            this.modeController.tock(dt);

        if (this.$tempGameCounter) {

            let queueModeData = COMMON.modes[app.lobby.Play.mode];

            let queue = app.lobby.queue[app.lobby.Play.mode];

            let capacity = "";

            if (queueModeData.minPlayers)
                capacity = " / " + queueModeData.minPlayers;
            if (queueModeData.playersPerTeam > 1)
                capacity = " / " + queueModeData.playersPerTeam * 2;

            this.$tempGameCounter.$text.html(`Players in queue for ${app.lobby.Play.modeData.name} <span class="count">${queue}</span>` + capacity);

        }

    },

    getInteractiveObjectInRange() {

        let entities = this.entities.groups.interactive;
        let minDistance = COMMON.INTERACTION_DISTANCE * COMMON.INTERACTION_DISTANCE;
        let result = null;

        for (var i = 0; i < entities.length; i++) {

            let entity = entities[i];
            let distance = Utils.distance2(this.player.x, this.player.y, entity.box[0] + entity.box[2] / 2, entity.box[1] + entity.box[3] / 2);

            if (distance > minDistance)
                continue;

            minDistance = distance;

            result = entity;

        }

        return result;

    },

    set respawnTime(val) {
    },

    get respawnTime() {

        this.modeData.respawnTime || 1;

    },

    raytraceResult: {
        x: 0,
        y: 0,
        mask: 0
    },

    raytrace: function(sx, sy, ex, ey, l) {

        l = l || 11;

        let length = Utils.distance(sx, sy, ex, ey);

        let steps = Math.ceil(length / l);

        let stepX = (ex - sx) / steps;
        let stepY = (ey - sy) / steps;

        for (var i = 0; i < steps; i++) {

            let x = sx + i * stepX;
            let y = sy + i * stepY;

            let mask = this.map.getSubAbs(x, y);

            if (mask === 1) {

                this.raytraceResult.x = x;
                this.raytraceResult.y = y;
                this.raytraceResult.mask = mask;

                return this.raytraceResult;
            }

        }

        return null;

    },

    raytraceVisibility: function(sx, sy, ex, ey, l) {

        l = l || 11;

        let length = Utils.distance(sx, sy, ex, ey);

        let steps = Math.ceil(length / l);

        let stepX = (ex - sx) / steps;
        let stepY = (ey - sy) / steps;

        for (var i = 0; i < steps; i++) {

            let x = sx + i * stepX;
            let y = sy + i * stepY;

            let mask = this.map.getSubAbs(x, y);

            if (mask === 1)
                return true;

        }

        return false;

    },

    tiles: new Map,

    replaceTile: function(x, y, layer, key) {

        let tile = this.map.get(x, y) || {};

        tile[layer] = key;

        var index = x + "," + y + "," + layer;

        let entity = this.tiles.get(index);

        if (entity)
            entity.collection.remove(entity);

    },

    refreshTiles: function() {

        var camera = this.camera;

        var tilesX = camera.ww / COMMON.TILE_WIDTH | 0;
        var tilesY = camera.wh / COMMON.TILE_HEIGHT | 0;

        var startX = Math.floor(camera.wx / COMMON.TILE_WIDTH);
        var startY = Math.floor(camera.wy / COMMON.TILE_HEIGHT);

        for (var x = -1; x <= tilesX + 1; x++) {
            for (var y = -1; y <= tilesY + 2; y++) {

                var tx = startX + x;
                var ty = startY + y;
                var tile = this.map.get(tx, ty);

                if (!tile)
                    continue;

                if (tile.ground)
                    this.addTile(tx, ty, tile.ground);
                if (tile.semi)
                    this.addTile(tx, ty, tile.semi);
                if (tile.wall)
                    this.addTile(tx, ty, tile.wall);

            }

        }

    },

    finish() {
    },

    addTile: function(tx, ty, key, isLinked=false) {

        var def = app.data.tileset.tiles[key];

        if (!def)
            return;

        def.layer = def.layer || "ground";

        var index = tx + "," + ty + "," + def.layer;

        if (!isLinked && this.tiles.has(index))
            return;

        var x = tx * COMMON.TILE_WIDTH;
        var y = ty * COMMON.TILE_HEIGHT;

        let zIndex = def.layer !== "ground" ? 2 : 0;

        var entity = this.add("Tile", {
            tx: tx,
            ty: ty,
            key: def.key,
            type: def.layer,
            zIndex: zIndex,
            isLinked
        });

        if (!isLinked)
            this.tiles.set(index, entity);

        if (def.linked) {

            for (let linkedKey of def.linked) {

                let linkedTile = this.addTile(tx, ty, linkedKey, true);

                if (linkedTile)
                    entity.children.push(linkedTile);

            }

        }

        if (def.roof) {

            let roof = this.add("Tile", {
                tx: tx,
                ty: ty,
                key: def.roof || 262,
                type: "roof",
                zIndex: 5,
                isLinked: true,
                z: 44
            });

            entity.children.push(roof);

        }

        return entity;

    },

    renderForeground: function() {
    },

    renderTooltip() {

        if (this.tooltipLifespan > 0 && !this.hideUI) {

            let width = this.nameFont.getWidth(this.tooltip);

            let x = app.width / 2;
            let y = app.height - this.tooltipZ;

            app.painter.reset();
            app.painter.color(0x000000);
            app.painter.align(0.5, 0.0);
            app.painter.fillRect(x - 2, y - 2, width + 4, 16 + 4);
            this.nameFont.color = 0xffffff;
            this.nameFont.fillText(this.tooltip, x, y);
            this.tooltipLifespan -= app.elapsed;
        }

        if (this.alertLifespan > 0 && !this.hideUI) {

            let width = this.nameFont.getWidth(this.alert.text);

            let x = app.width / 2;
            let y = app.height - this.alertZ;

            app.painter.reset();
            app.painter.color(this.alert.background);
            app.painter.align(0.5, 0.0);
            app.painter.fillRect(x - 2, y - 2, width + 4, 16 + 4);
            this.nameFont.color = this.alert.foreground;
            this.nameFont.fillText(this.alert.text, x, y);
            this.alertLifespan -= app.elapsed;
        }

    },

    renderBorder() {

        app.painter.reset();
        app.painter.align(0, 0);
        app.painter.color(0x600400, 0.25);
        app.painter.fillRect(-this.width, -this.height, this.width * 2, 4);
        app.painter.fillRect(-this.width, -this.height, 4, this.height * 2);
        app.painter.fillRect(-this.width, this.height - 4, this.width * 2, 4);
        app.painter.fillRect(this.width, -this.height, 4, this.height * 2);

    },

    renderBackground() {

        app.painter.reset();

        let tile = app.textures[this.modeData.background];
        let program = app.programs.tiling_image;
        let is = this.camera.scale;

        app.painter.program(program);

        program.set("texture", 0);
        program.set("alpha", 1.0);
        program.set("repeatX", app.width / tile.width);
        program.set("repeatY", app.height / tile.height);
        program.set("repeatOffsetX", Math.floor(this.camera.x * is) / tile.width);
        program.set("repeatOffsetY", Math.floor(this.camera.y * is) / tile.height);

        app.painter.bindTexture(tile);
        // app.painter.bindTexture(app.textures[this.modeData.background || "tile"]);
        app.painter.repeat(true);
        app.painter.align(0.0, 0.0);
        app.painter.fillRect(0, 0, app.width, app.height);

    },

    eclipseRadius: 500,

    radar: true,

    openEmoteWindow() {

        if (!this.controllers)
            return;

        this.controllers.add(CLIENT.EmoteWindow);

    },

    closeEmoteWindow() {

        if (!this.controllers)
            return;

        this.controllers.remove(CLIENT.EmoteWindow);

        CLIENT.EmoteWindow.close();

    },

    itemsSprites: {},

    renderGUIItems: function(x, y) {

        /* items */

        let items = this.privateData.items;

        if (!items)
            return;

        for (var i = 0; i < items.length; i++) {

            let item = items[i];
            let itemDef = app.data.items[item.key];

            if (!item.count)
                continue;

            if (!this.itemsSprites[item.key]) {

                var sprite = new CLIENT.Sprite();

                sprite.set(itemDef.sprite || ("pickups/" + item.key), true);

                if (itemDef.spin)
                    sprite.spin = itemDef.spin;
                if (itemDef.palette !== undefined)
                    sprite.palette = itemDef.palette;

                this.itemsSprites[item.key] = sprite;

            }

            let itemx = 40 + i * 35 + x;
            let itemy = 34 + y;

            if (item.count) {

                // var data = app.data.items[key];

                var sprite = this.itemsSprites[item.key];

                sprite.render(null, itemx, itemy);

                app.painter.reset();
                app.painter.font(app.fonts.default);
                app.painter.color(0xffffff);
            }

            app.painter.fillText(app.controls["item" + (i + 1)][0][0].toUpperCase(), itemx, itemy - 20);

        }

    },

    renderGUI: function(layer) {

        if (this.hideUI)
            return;

        if (this.player && this.privateData) {

            let x = app.width * 0.5 - app.textures.hud.slots.width * 0.5 | 0;
            let y = app.height - 10 - app.textures.hud.slots.height;

            this.nameFont.color = 0xffffff;
            this.nameFont.fillText("LVL " + this.privateData.level, x + 206, y + 4, 0.0);

            app.painter.reset();
            app.painter.align(0, 0);
            app.painter.translate(x, y);

            app.painter.drawImage(app.textures.hud.slots, 0, 0);

            /* temperature */

            if (this.modeData.temperature) {

                app.painter.drawAtlas("ui/thermometer_off", 8, 24);

                let progress = this.privateData.temperature;
                let sprite = app.atlas.ui.thermometer_on;
                app.painter.drawImageRegion(sprite.texture, sprite.region[0], sprite.region[1] + sprite.region[3] * (1.0 - progress) | 0, sprite.region[2], sprite.region[3] * progress, 10, 24 + sprite.region[3] * (1.0 - progress) | 0);

            }

            /* exp */

            var mod = Math.min(1.0, (this.privateData.exp - this.privateData.currentLevelExp) / (this.privateData.nextLevelExp - this.privateData.currentLevelExp));

            app.painter.color(0xffffff)
            app.painter.fillRect(26, 5, 133 * mod, 6);

            /* skills */

            var skillKey = this.player.spell_one;
            var skillData = app.data.skills[skillKey];

            app.painter.drawImageRegion(app.textures.skills, skillData.icon * 28, 0, 28, 28, 168, 17, 28, 28);

            if (this.pointerSkillMode) {
            // layer.strokeStyle("#fbf236").lineWidth(2).strokeRect(169, 18, 27, 27);

            }

            var mod = this.privateData.cooldowns[skillKey] / skillData.cooldown;

            if (mod > 0) {

                app.painter.color(0x000000, 0.25);
                app.painter.fillRect(168, 18, 29, 27);

                app.painter.color(0xffff00, 0.3);

                app.painter.fillRect(169, 18, 27, 27 * mod);

            } else {
            }

            this.renderGUIItems(x, y);

        }

        return;

        /* SCORE */

        var belt_width = 0;

        if (!this.fun)
            belt_width += app.images.time_belt.width;

        layer.save();

        layer.translate(app.width - belt_width | 0, 2);

        if (!this.fun) {

            layer.drawImage(app.images.time_belt, 0, 0);

            layer.font("700 10px 'Exo 2'").textAlign("center");

            this.timeLeft = COMMON.GAME_TIME - this.serverLifetime;

            var timeLeft = (this.timeLeft / 60 | 0) + ":" + Utils.padStart((this.timeLeft | 0) % 60, 2, 0);

            layer.fillStyle("#d9a066").pixelText(String(this.kills[0]), 25, 5);
            layer.fillStyle("#d9a066").pixelText(timeLeft, 66, 5);
            layer.fillStyle("#cbdbfc").pixelText(String(this.kills[1]), 110, 5);

            layer.translate(app.images.time_belt.width, 0);

        }

        layer.restore();

    },

    markers: {
        mate: [20, 10, 11, 11],
        friend: [21, 0, 9, 9],
        enemy: [11, 0, 9, 9],
        pedestal: [0, 0, 10, 10],
        ball: [30, 0, 10, 10],
        // king: [41, 0, 9, 9]
        king: [34, 12, 15, 12],
        flag0: [0, 13, 10, 14],
        flag1: [10, 13, 10, 14],
        treasure: [2, 45, 15, 12],
        easter_egg: [33, 50, 11, 12],
        pumpkin: [45, 35, 17, 17]
    },

    renderRadar: function(layer) {

        if (this.hideUI)
            return;

        if (!this.player)
            return;

        var radius = app.height * 0.5 - 30 | 0;
        let range = 1000;

        app.painter.reset();

        let entities = [].concat(this.entities.groups.radar);

        for (var i = 0; i < entities.length; i++) {
            app.painter.color(-1);

            var c = this.entities.groups.radar[i];

            if (c === this.player)
                continue;

            if (c.inView)
                continue;
            if (c.hidden)
                continue;

            if (!c.globalMarker && !Utils.quickPointInRange(this.player.x, this.player.y, c.x, c.y, range))
                continue;

            let marker;

            if (c.marker) {

                marker = c.marker;

            } else if (c instanceof CLIENT.Citizen) {

                if (this.modeData.visibility && !c.temp.inSight)
                    continue;
                if (c.state.currentKey === "dead")
                    continue;

                if (c.key.indexOf("orc_") > -1)
                    marker = "orc";
                else if (c.key.indexOf("barbarian_") > -1)
                    marker = "barbarian";
                else if (this.player.team === 2)
                    marker = "enemy";
                else
                    marker = this.areEnemies(c, this.player) ? "enemy" : "friend";

                if (this.player.shared.gameLink && this.player.shared.gameLink === c.shared.gameLink)
                    marker = "mate";

            }

            if (!marker)
                continue;

            let icon = app.atlas.markers[marker];

            if (!icon)
                continue;

            var angle = Utils.lookAt(this.player.x, this.player.y, c.x, c.y);

            let r = -(1.0 - Utils.quickDistance(this.player, c) / range) * (radius * 0.25);

            var x = app.width * 0.5 + Math.cos(angle) * (radius + r);
            var y = app.height * 0.5 + Math.sin(angle) * (radius + r);

            app.painter.drawAtlas(icon, x, y);

            if (c.markerText) {
                this.nameFont.color = 0x222034;
                this.nameFont.fillText(c.markerText, x, y + app.painter.last.height / 2 + 6);

            }

        }

    },

    pointerdown: function(event) {

        if (this.showRespawnTimeout > 0)
            this.showRespawnTimeout = 1.0;

        if (!this.ready)
            return;

        if (this.player && this.player.state.currentKey === "dead") {

            // if (!this.fun || !this.respawnWindow) this.send("respawn", true);

            return;

        }

        this.ui.pointerdown(this, event);

    },

    pointerup: function(event) {

        if (!this.ready)
            return;

        this.ui.pointerup(this, event);

    },

    pointermove: function(event) {

        if (!this.ready)
            return;

        this.ui.pointermove(this, event);

    },

    pointerwheel: function(event) {

        if (!this.ready)
            return;

        this.ui.pointerwheel(this, event);

    },

    gamepadmove: function(event) {

        if (!this.ready)
            return;

        this.ui.gamepadmove(this, event);

    },

    gamepaddown: function(event) {

        if (!this.ready)
            return;

        this.ui.gamepaddown(this, event);

    },

    gamepadup: function(event) {

        if (!this.ready)
            return;

        this.ui.gamepadup(this, event);

    },

    moveKeys: {
        "a": COMMON.FLAG_LEFT,
        "d": COMMON.FLAG_RIGHT,
        "w": COMMON.FLAG_UP,
        "s": COMMON.FLAG_DOWN,

        "left": COMMON.FLAG_LEFT,
        "right": COMMON.FLAG_RIGHT,
        "up": COMMON.FLAG_UP,
        "down": COMMON.FLAG_DOWN

    },

    itemOn: function(index) {

        let key = this.privateData.items[index].key;

        if (!key)
            return;

        this.itemsTimers[index] = this.lifetime;

    },

    itemOff: function(index) {

        var timestamp = this.itemsTimers[index];

        if (this.lifetime - timestamp < 0.3)
            this.send("useItem", {
                x: this.pointerRealX,
                y: this.pointerRealY,
                index: index
            });

        delete this.itemsTimers[index];

    },

    dash: function(key) {

        this.send("dash", key);

    },

    setMoving: function(key, value) {

        if (value)
            this.moving |= key;
        else if (this.moving & key)
            this.moving &= ~(key);

    },

    stopMoving: function() {

        this.moving = 0;

    },

    /* Utils */

    renderSimpleBar(x, y, w, h, foreground, background, progress) {

        app.painter.reset();
        app.painter.color(background);
        app.painter.fillRect(x | 0, y | 0, w | 0, h | 0);
        app.painter.color(foreground);
        app.painter.fillRect(x | 0, y | 0, w * progress | 0, h | 0);

    },

    renderArcBar(x, y, inside, outside, progress, prev, foreground) {
        app.painter.reset();
        app.painter.scale(1.0, 0.6);

        app.painter.color(foreground);
        app.painter.alpha(0.25);
        app.painter.arc(x, y, inside, outside, 0.0, Math.PI);
        app.painter.alpha(1.0);

        if (prev) {
            app.painter.color(0xffffff);
            // app.painter.arc(x, y, inside, outside, Math.PI * 0.5 - prev * Math.PI * 0.5, prev * Math.PI);
            app.painter.color(foreground);
        }

        // app.painter.arc(x, y, inside, outside, Math.PI * 0.5 - progress * Math.PI * 0.5, progress * Math.PI);
        app.painter.arc(x, y, inside, outside, Math.PI * 0.5 - progress * Math.PI * 0.5, progress * Math.PI);
    },

    renderBar: function(onSprite, offSprite, x, y, progress) {

        if (offSprite) {

            let off = app.atlas[offSprite];

            app.painter.drawImageRegion(off.texture, ...off.region, Math.floor(x), Math.floor(y));

        }

        if (onSprite && progress) {

            let on = app.atlas[onSprite];

            app.painter.drawImageRegion(on.texture, on.region[0], on.region[1], on.region[2] * progress, on.region[3], Math.floor(x), Math.floor(y));

        }

    },

    renderDamageArc: function(o, x, y, radius, progress, color, loss) {

        app.painter.reset();
        app.painter.scale(0.5, 0.35);
        app.painter.drawSprite("pie", x, y, 48 * (1.0 - progress), 0);

    },

    resize: function(event) {

        this.eclipseBuffer = app.painter.createFramebuffer(app.width, app.height);

        if (this.camera) {

            this.camera.set(0, 0, app.width, app.height);
            this.camera.skip();
            this.vignette = false;

        }

        if (this.ui) {

            if (this.ui.resize)
                this.ui.resize(this, event)

        }

        this.projectionMatrix = Matrix3.projection(app.canvas.width, app.canvas.height);
        ;
        if (window.innerWidth < 1000) {
            app.options.ingame_chat = false;
            this.$textinput.hide();

            app.console.clear();
        }
    },

    ping: function(entity, color) {

        var blast = this.entities.add("Blast");

        blast.follow = entity;
        blast.blendMode = "hard-light";
        blast.color = color || "#f00";

    },

    showSummary: function(data) {

        this.timeCompression = 0.25;

        setTimeout(function() {

            app.game.timeCompression = 1.0;

        }, 3000);

        if (this.mode === "soccer") {

            app.sound.play("audience/whistle").rate(1.4);
            app.sound.play("audience/whistle").rate(1.4).delay(0.6);
            app.sound.play("audience/whistle").rate(1.4).delay(1.2);

        }

        if (!this.player || this.player.team === data.winner) {

            app.happyTime(1.0);

            NAMESPACE.MotionGraphics.victory({
                path: "motiongraphics/victory/"
            });

            app.sound.play("victory");

        } else {

            app.sound.play("loose");

        }

        setTimeout(function() {

            if (app.state !== app.game)
                return

            var respawnWindow = app.game.showRespawn();

            if (app.game.player) {

                if (app.game.modeData.rankedGold) {

                    let reward = app.getGoldReward(app.game.mode);

                    if (app.game.player.team === data.winner)
                        app.game.addGold(reward);
                    if (app.game.player.team !== data.winner)
                        app.game.addGold(-reward);

                }

                if (app.game.mode === "arena1" || app.game.mode === "arena2") {

                    var change = (app.game.player.team === data.winner) ? 10 : -10;

                    let scoreKey = COMMON.modes["arena1"].scoreKey;

                    var counter = respawnWindow.addCounter({
                        title: "ARENA",
                        max: app.lobby.maxMMR[scoreKey],
                        value: app.user[scoreKey],
                        icons: COMMON.ARENA_RANKS,
                        color: "#f51"
                    });

                    counter.val(Math.max(0, app.user.arena_mmr + change));

                }

                if (app.game.mode === "soccer") {

                    let scoreKey = COMMON.modes["arena1"].scoreKey;

                    var change = (app.game.player.team === data.winner) ? 1 : -1;

                    var counter = respawnWindow.addCounter({
                        title: "GOALS",
                        max: app.lobby.maxMMR[scoreKey],
                        value: app.user[scoreKey] - app.user.goalsEarned,
                        icons: COMMON.SOCCER_RANKS,
                        color: "#f51"
                    });

                    counter.val(app.user.goals);

                }

            }

        }, 3000);

    },

    respawned: 0,

    updateVisibility() {

        let citizens = this.entities.groups.citizens;
        let team = app.game.player.team;

        for (let citizen of citizens) {

            citizen.temp.inSight = false;

        }

        for (let i = 0; i < citizens.length; i++) {

            let a = citizens[i];

            if (a.team !== team)
                continue;

            if (a.player) {

                a.temp.inSight = true;

            }

            if (a.team === team) {

                a.temp.inSight = true;

            }

            for (let j = 0; j < citizens.length; j++) {

                if (i === j)
                    continue;

                let b = citizens[j];

                if (b.temp.inSight)
                    continue;
                if (a.team === b.team)
                    continue;

                if (!Utils.quickPointInRange(a.x, a.y, b.x, b.y, 500))
                    continue;

                let obstacle = a.game.raytraceVisibility(a.x, a.y, b.x, b.y);

                if (obstacle)
                    continue;

                b.temp.inSight = true;

            }

        }

    },

    coinsFX(x, y, follow, amount) {

        for (var i = 0; i < amount; i++) {

            let coin = this.entities.add("Coin");

            coin.x = x;
            coin.y = y;
            coin.follow = follow;

            coin.create();

        }

    },

    showRespawn: function() {

        if (this.respawnWindow) {

            this.hideRespawn();

        }

        this.respawnWindow = new CLIENT.Respawn;

        this.respawned++;

        if (window.arapi && app.ads) {

            app.adstate = "respawn";

            arapi.show(this.player ? (this.player.shared.flag || "xx") : "xx");

        }

        return this.respawnWindow;

    },

    hideRespawn: function() {

        if (window.arapi && app.ads)
            arapi.hide();

        if (!this.respawnWindow)
            return;

        this.respawnWindow.close();

        this.respawnWindow = false;

    },

    refreshTeams: function() {

        for (var citizen of this.entities.groups.citizens) {

            citizen.setTeam(citizen.shared.team);

        }

    },

    mapScreenshot() {

        // app.mouse.preventContextMenu = false;

        // this.hideRoofs = true;

        let layer = cq(this.width * 2, this.height * 2);

        let cols = Math.ceil(this.width * 2 / app.width);
        let rows = Math.ceil(this.height * 2 / app.height);

        for (let x = 0; x < cols; x++) {
            for (let y = 0; y < rows; y++) {
                this.camera.follow = null;
                this.camera.centerView = false;
                this.camera.jump(-this.width + x * app.width, -this.height + y * app.height);
                this.camera.instant = true;

                this.refreshTiles();
                this.step(0)

                app.loop.render(1);
                layer.drawImage(app.canvas, x * app.width, y * app.height);

            }
        }

        // $("body").empty();
        // layer.appendTo("body");

        return layer;

    },

    ejectaTween(o, radius, duration=1.0) {

        let angle = Math.random() * 6.28;

        return app.tween(o).to({
            x: o.x + Math.cos(angle) * radius,
            y: o.y + Math.sin(angle) * radius
        }, duration, "outQuad");

    },

    showMap() {

        let showNames = this.showNames;
        let hideUI = this.hideUI;
        let spectate = this.spectate;
        let follow = this.camera.follow;

        this.hideUI = true;
        this.showNames = false;
        this.spectate = true;

        let layer = this.mapScreenshot();

        layer.appendTo("body");

        Object.assign(layer.canvas.style, {
            position: "absolute",
            left: 0,
            top: 0,
            background: "#000000aa",
            zIndex: 10,
            objectFit: "contain",
            width: "100vw",
            height: "100vh"
        });

        this.hideUI = hideUI;
        this.showNames = showNames;
        this.spectate = spectate;
        this.mapPreview = layer;
        this.camera.follow = follow;
        this.camera.centerView = true;
        this.camera.instant = false;

    },

    hideMap() {

        $(this.mapPreview.canvas).remove();

        this.mapPreview = null;

    }

};

CanvasQuery.Layer.prototype.charWidth = function(char) {

    if (!cq.charWidthCache)
        cq.charWidthCache = new Map();

    if (!cq.charWidthCache.has(this.context.font + char)) {

        var width = this.measureText(char).width;

        cq.charWidthCache.set(this.context.font + char, width);

    }

    return cq.charWidthCache.get(this.context.font + char);

}
;

CanvasQuery.Layer.prototype.pixelText = function(text, x, y) {

    var prevTextAlign = this.context.textAlign;

    this.context.textAlign = "left";

    var textWidth = 0;

    if (prevTextAlign === "center") {

        for (var i = 0; i < text.length; i++) {

            var w = this.charWidth(text[i]);

            var o = w - (w | 0);

            textWidth += w + (o > 0.5 ? 1 : 0) | 0;

        }

        x -= textWidth / 2 | 0;

    }

    for (var i = 0; i < text.length; i++) {

        var c = text[i];

        var w = this.charWidth(c);

        var o = w - (w | 0);

        this.context.fillText(c, x, y);

        x += w + (o > 0.5 ? 1 : 0) | 0;

    }

    this.context.textAlign = prevTextAlign;

    return this;

}

document.addEventListener("keydown", function(e) {
    if (e.which === 9) {
        e.preventDefault();
    }
})

/* file: script/Game.MessageHandler.js */

CLIENT.Game.MessageHandler = {

    Game(game, data) {

        game.handleGameData(data);

    },

    arena1(game, data) {

        if (game.eclipse)
            app.tween(game.eclipse).to({
                radius: data.eclipseRadius
            }, 0.25);

    },
    battle_royale(game, data) {

        if (game.eclipse)
            app.tween(game.eclipse).to({
                radius: data.eclipseRadius
            }, 0.25);

    },

    fun(game, data) {

        if (game.eclipse)
            app.tween(game.eclipse).to({
                radius: data.eclipseRadius
            }, 0.25);

    },

    spectate_emote(game, data) {

        CLIENT.Audience.emote(data);

    },

    coins(game, data) {

        var follow = game.entities.sid(data.follow);

        if (!follow || !follow.inView)
            return

        game.coinsFX(data.x, data.y, follow, data.amount);

    },

    inspect(game, data) {
    },

    quest_update(game, data) {

        var quest = game.sharer.unserialize(data.quest);

        game.questWidgets[data.index].update(quest);

    },

    pong(game, data) {

        game.latencies.push((Date.now() - game.lastPing) / 2 | 0);

        if (game.latencies.length > 10)
            game.latencies.shift();

        game.latency = Utils.sum(game.latencies) / game.latencies.length | 0;

    },

    response(game, data) {

        let resolve = game.requests.get(data.request_id);

        if (resolve)
            resolve(data.response);

    },

    respawn(game, data) {

        var entity = game.entities.sid(data.entity_sid);

        if (entity)
            entity.respawn();

    },

    delay(game, data) {

        var entity = game.entities.sid(data.entity_sid);

        if (entity === app.game.player) {

            setTimeout(()=>{
                game.delay = data.delay;
            }
            , 100);

        }

    },

    sound(game, data) {

        if ((data.x || data.y) && !game.camera.inView(data.x, data.y))
            return;

        var sound = app.sound.play(data.sound);

        if (data.position) {

            sound.gpan({
                x: data.position[0],
                y: data.position[1]
            });

        }

    },

    moveCamera(game, data) {

        game.camera.follow = false;
        game.camera.center.x = data.x;
        game.camera.center.y = data.y;
        game.freecam = true;

    },

    chatHistory(game, data) {

        if (app.options.ingame_chat) {

            for (var i = 0; i < data.length; i++) {

                app.console.say(data[i]);

            }

        }

    },

    event(game, data) {

        if (data.sid) {

            let entity = game.entities.sid(data.sid);

            if (!entity || !entity.onevent)
                return;

            entity.onevent(data.event, data);

        }

    },

    fx(game, data) {

        if (game.camera.inView(data.x, data.y, 1, 1)) {

            game.fx(data.fx, data);

        }

    },

    fall(game, data) {
    // var entity = game.entities.sid(data);

    // if (entity) entity.fall();

    },

    path(game, data) {

        game.path = data;

    },

    iceBlast(game, data) {

        var entity = game.entities.sid(data.entity_sid);

        if (entity && entity.inView) {

            var blast = game.entities.add("Sprite");
            blast.setDuration(1.25);
            blast.scale = 100 / 64;
            blast.set("fx/frost_nova");
            blast.follow = entity;
            blast.color = "#000";
            blast.alpha = 0.15;
            blast.zIndex = 0;

            var blast = game.entities.add("Sprite");
            blast.setDuration(1.25);
            blast.scale = 100 / 64;
            blast.set("fx/frost_nova");
            blast.follow = entity;
            blast.followOffsetY = -16;
            blast.blendMode = "hard-light";
            blast.alpha = 1.0;
            blast.zIndex = 2;

            app.sound.play("spells/ice_blast").rrate(0.1).gpan(entity);

        }

    },

    error(game, data) {

        app.console.error(data);

    },

    game_link(game, data) {
    },

    snapshot(game, data) {

        if (window.gdApi)
            gdApi.play();

        game.debug.snapshot = data;

        game.start(data);

        // game.selectChatChannel(localStorage.getItem("chat_channel") || "default");
        game.selectChatChannel("default");

        game.ready = true;

        if (data.ended) {

            window.location = window.location;

        }

    },

    game_over(game, data) {

        game.gameOver(data.score, data.maxScore, data.victory);

    },

    game_finished(game, data) {
    },

    game_end(game, data) {

        game.ended = true;

        if (app.live) {

            setTimeout(function(game, data) {

                window.location = window.location;

            }, 15000);

        }

        app.game.showSummary(data);

    },

    stats(game, data) {

        if (!game.player)
            return;

        game.handleStats(data);

    },

    openContainer(game, data) {

        let container = game.entities.sid(data.container_sid);

        if (!container)
            return;

        game.openContainer(container);

    },

    private(game, data) {

        if (!game.player)
            return;

        game.handlePrivateData(data);

    },

    reconnect(game, data) {

        app.console.say("The server was almost empty. Found a better one for you.");

        Object.assign(game.connectionData, data);

        game.connect(game.connectionData);

    },

    key(game, data) {

        game.sharer.setKeys(data);

    },

    updatePlayer(game, data) {

        if (data.changes)
            game.updateSharedEntity(data.changes);

    },

    update(game, data) {

        if (data.sharedKeys) {

            game.sharer.setKeys(data.sharedKeys);

        }

        if (data.clients) {

            app.console.setTop("Online: " + data.clients);

        }

        // console.count(game.steps)

        game.serverLifetime = data.lifetime;

        if (game.modeData.teamScore) {

            var kills = game.kills;

            game.kills = data.kills;

            if (game.kills[game.player.team] > kills[game.player.team]) {

                app.sound.play("ui/score");

            }

            var max = Math.max(game.kills[0], game.kills[1]);

            var mod = Math.min(1.0, max / 2);

            if (game.stompLoop) {

                var rate = 0.7 + 0.3 * mod;

                if (game.ball) {// var dmod = Utils.distance(game.ball.x, game.ball.y, 0, 0) / game.innerHeight;

                // rate += dmod * 0.5;
                }

                game.stompLoop.rate(rate);
                game.stompLoop.volume(0.2 + 0.3 * mod);

            }

        }
        //data.entities.forEach(console.log);
        data.entities.forEach(game.updateSharedEntity, game);

        game.parseQueue(data.queue);

    },

    setPlayersCitizen(game, data) {

        game.debug.player = data;

        game.playersCitizen = game.entities.sid(data.sid);
        game.player = game.playersCitizen;

        game.playersCitizen.setAsPlayer();

        game.camera.setFollow(game.playersCitizen);

        game.refreshTeams();

        if (window.analytics)
            analytics('send', 'event', 'experiments', 'hero_gender', game.player.shared.kind === "female" ? "female" : "male");

        if (window.analytics && app.user.firstTime)
            analytics('send', 'event', 'experiments', 'first_time_play');

        let country = localStorage.getItem("user-country");

        setTimeout(()=>{
        // game.send("message", { text: `/flag ${country}` })

        }
        , 1000);

        app.game.goldBefore = app.user.gold;

    },

    nextRound(game, data) {

        game.announcer.enqueue("get_ready");

        NAMESPACE.MotionGraphics.get_ready_quick({
            path: "motiongraphics/get_ready_quick/"
        });

        if (game.player)
            game.camera.setFollow(game.player);

    },

    ball(game, data) {

        if (game.modeData.rankMode === "arena1") {

            game.announcer.enqueue("fight");

        } else {

            game.announcer.enqueue("go");

        }

        game.camera.setFollow(game.player);

        app.sound.play("audience/whistle").rate(1.5);

    },

    mapReplaceTile(game, data) {

        game.replaceTile(data.x, data.y, data.layer, data.key);

    },

    goal(game, data) {

        app.sound.play("audience/whistle");

        game.announcer.enqueue(data.team ? "score_gray" : "score_brown");

        if (data.team === game.player.team) {

            app.sound.play("audience/ooh");

        } else {

            app.sound.play("audience/boo");

        }

        var goal = game.entities.one(function(e) {

            return (e instanceof CLIENT.SoccerGoalLine) && e.shared.team !== data.team;

        });

        game.camera.setFollow(goal);

        let attacker = game.entities.sid(data.attacker_sid);

        if (attacker === app.game.player)
            app.happyTime(1.0);

        NAMESPACE.MotionGraphics.goal1({
            path: "motiongraphics/goal/",
            playerText: (attacker ? attacker.shared.name : ""),
            rate: 1.5
        });

    },

    playerWonRound(game, data) {

        var winner = game.entities.sid(data.winner_sid);

        if (winner) {

            game.camera.setFollow(winner);

            if (winner.shared.team === game.player.shared.team) {

                app.sound.play("audience/ooh");

            } else {

                app.sound.play("audience/boo");

            }
        }

    },

    alert(game, data) {

        game.setAlert(data);

    },

    impact(game, data) {

        if (game.camera.inView(data.x, data.y, 1, 1)) {

            app.sound.play("martial/hit").gpan(data);
            app.sound.play("impact/ground_heavy").rate(2.0).gpan(data);

            game.fx("pickup", {
                x: data.x,
                y: data.y
            });

        }

    },

    setKing(game, data) {

        var entity = game.entities.sid(data.entity_sid);

        game.setKing(entity);

    },
    pickup(game, data) {

        var pickup = game.entities.sid(data.pickup_sid);
        var entity = game.entities.sid(data.entity_sid);

        if (pickup && pickup.inView) {

            pickup.oncollect(entity);

        }

    },

    spell(game, data) {

        var target = game.entities.sid(data.target_sid);
        var caster = game.entities.sid(data.caster_sid);

        if (target.inView) {

            if (data.key === "heal") {

                game.fx("heal", {
                    entity: target
                });

            } else if (data.key === "stamina") {

                game.fx("heal", {
                    entity: target,
                    color: "#fff"
                });

            }

            // if (entity === game.playersCitizen) app.sound.play("voice/haste");

        }

    },

    buff(game, data) {

        var entity = game.entities.sid(data.entity_sid);

        if (entity.inView) {

            app.sound.play("spells/haste").gpan(entity);

            // if (entity === game.playersCitizen) app.sound.play("voice/haste");

        }

        entity.onbuff(data);

    },

    buffEnd(game, data) {

        var entity = game.entities.sid(data.entity_sid);

        entity.onbuffend();

    },

    god(game, data) {

        game.godText = data.text;

    },

    disarm(game, data) {

        var entity = game.entities.sid(data.entity_sid);

        if (entity)
            entity.disarm(data.weapon);

    },

    ack(game, data) {

        var entity = game.entities.sid(data.entity_sid);

        if (entity && entity.inView) {

            entity.ack(data.key);

        }

    },

    say(game, data) {

        if (data.system) {

            app.console.say(data.text, "system");

        } else if (!data.entity_sid) {

            app.console.say(data.text, "player");

        } else {

            let same = data.channel === game.chatChannel;

            var entity = game.entities.sid(data.entity_sid);

            if (!entity)
                return;

            if (entity) {

                entity.tooltip(Utils.unescapeHTML(data.text));

            }

            if (same) {

                var messageClass = "default";

                if (game.isMate(entity)) {

                    messageClass = "friend";

                    app.sound.play("ui/friend_speak");

                }

                if (entity === game.player)
                    messageClass = "player";
                if (entity.shared.special & COMMON.SPECIAL_FLAG_ADMIN)
                    messageClass = "admin";

                var extra = {};

                if (entity) {
                    extra.direction = Utils.lookAt(game.player, entity);
                    extra.flag = entity.shared.flag;
                }

                if (app.options.ingame_chat) {

                    app.console.say(entity.shared.name.substr(0, 16) + ": " + data.text, messageClass, extra);

                }

            }

        }

    },

    dash(game, data) {

        var entity = game.entities.sid(data.entity_sid);

        if (!entity)
            return;

        entity.dash(data.direction);

    },

    Hit(game, data) {

        var entity = game.entities.sid(data.entity_sid);
        var attacker = game.entities.sid(data.attacker_sid);

        if (entity && entity.onhit)
            entity.onhit(data);

        if (entity && attacker && attacker.inView) {

            if (data.fatal && entity && !data.kick && attacker) {

                if (!attacker || !attacker.setSprite || (attacker !== game.player))
                    return;

                if (entity === game.player)
                    return;

                entity.killedByPlayer();

            }
        }

        if (entity && data.missile && entity.inView) {

            app.sound.play("impact/missile").gpan(entity);

        }

    },

    throw(game, data) {

        var entity = game.entities.sid(data.entity_sid);

        if (entity)
            entity.throw(data.gx, data.gy);

    },

    wallHit(game, data) {

        app.sound.play("axe/blocked").rrate(0.1).gpan(data);

        var sprite = game.entities.add("Sprite");

        sprite.zIndex = 4;
        sprite.x = data.x;
        sprite.y = data.y;
        sprite.set("collect", false);
        sprite.setDuration(0.4);
        sprite.scale = 2;

    },

    block(game, data) {

        var entity = game.entities.sid(data.entity_sid);

        if (entity)
            entity.block();

    },

    clash(game, data) {

        var a = game.entities.sid(data.a_sid);

        if (a)
            a.clash();

        var b = game.entities.sid(data.b_sid);

        if (b)
            b.clash();

        if (a && b)
            game.clash(a, b);

    },

    death(game, data) {
    },

    mapSet(game, data) {
    // game.map.set(data[0], data[1], data[2], data[3]);

    },

    bestPlayers(game, data) {

        game.scoreboard.setBestPlayers(data);

    }

};

/* file: script/Game.Desktop.js */

CLIENT.Game.Desktop = {

    gamepad: false,

    stick: {
        x: 0,
        y: 0
    },

    gamepaddown: function(game, event) {

        this.gamepad = true;

    },

    gamepadup: function(game, event) {
    },

    gamepadmove: function(game, event) {

        if (!event.a)
            return;

        this.stick = event.a;

    },

    pointermove: function(game, event) {

        game.pointerX = event.x;
        game.pointerY = event.y;

    },

    pointerdown: function(game, event) {
    },

    pointerup: function(game, event) {
    },

    pointerwheel: function(game, event) {

        if (app.mouse.right && event.delta > 0)
            game.send("useSkill", "spell1");

    },

    step: function(game, dt) {

        if (game.player && this.gamepad) {

            game.desiredDirection = Utils.lookAt(game.player.x, game.player.y - 24, game.pointerRealX, game.pointerRealY - 24);

            var angle = Utils.lookAt(0, 0, this.stick.x, this.stick.y);
            var dist = Utils.distance(0, 0, this.stick.x, this.stick.y) / 1.42;

            var ox = Math.cos(angle);
            var oy = Math.sin(angle);

            game.pointerX = game.player.x - game.camera.x + ox * 64 * dist;
            game.pointerY = game.player.y - game.camera.y + oy * 64 * dist;

            var x = this.stick.x;
            var y = this.stick.y;

            var moving = (Math.abs(x) > 0.5 ? (x < 0 ? COMMON.FLAG_LEFT : COMMON.FLAG_RIGHT) : 0) | (Math.abs(y) > 0.5 ? (y < 0 ? COMMON.FLAG_UP : COMMON.FLAG_DOWN) : 0);

            game.moving = moving;

        } else if (game.player) {

            game.desiredDirection = Utils.lookAt(game.player.x, game.player.y - 24, game.pointerRealX, game.pointerRealY - 24);

        }

    }

};

/* file: script/Game.BattleRoyale.js */

CLIENT.Game.BattleRoyale = function(game) {

    new CLIENT.AliveCounter();

}
;

CLIENT.Game.BattleRoyale.prototype = {

    onRespawnWindow(respawnWindow) {

        let $gui = respawnWindow.$gui;

        $gui.$custom.html(`<h2>Final Score ${app.game.player.score}</h2>`)

    },

    onRender() {
    },

    tock() {
    }

};

/* file: script/Game.Mobile.js */

CLIENT.Game.Mobile = {

    resize: function() {

        this.moveCircleOuterRadius = app.height / 7;
        this.moveCircleInnerRadius = this.moveCircleOuterRadius * 0.6 | 0;

    },

    pointerdown: function(game, event) {

        if (!this.moveCircle && event.x < app.width * 0.5) {

            this.moveCircle = {
                x: event.x,
                y: event.y,
                identifier: event.identifier
            };

            this.run = false;

        } else if (event.x >= app.width * 0.5) {

            game.send("press");

            this.pointerDown = {
                x: event.x,
                y: event.y,
                identifier: event.identifier
            };

        }

    },

    pointerup: function(game, event) {

        if (this.moveCircle && this.moveCircle.identifier === event.identifier) {

            this.moveCircle = false;

            game.stopMoving();

            this.stopRunning();

        } else if (this.pointerDown && this.pointerDown.identifier === event.identifier) {

            this.pointerDown = false;

        }

        if (event.x >= app.width * 0.5) {

            game.send("release");

        }

    },

    pointermove: function(game, event) {

        if (this.moveCircle && event.identifier === this.moveCircle.identifier) {

            var distance = Utils.distance(this.moveCircle, event);
            var direction = Utils.lookAt(this.moveCircle, event);

            game.desiredDirection = direction;

            if (distance > this.moveCircleInnerRadius) {

                this.moveCircle.inner = false;

                var x = Math.cos(direction);
                var y = Math.sin(direction);

                var moving = (Math.abs(x) > 0.5 ? (x < 0 ? COMMON.FLAG_LEFT : COMMON.FLAG_RIGHT) : 0) | (Math.abs(y) > 0.5 ? (y < 0 ? COMMON.FLAG_UP : COMMON.FLAG_DOWN) : 0);

                game.moving = 0;

                game.setMoving(moving, true);

            } else {

                this.moveCircle.inner = true;

                game.stopMoving();

            }

            if (distance > this.moveCircleOuterRadius) {

                this.startRunning(game);

            } else {

                this.stopRunning(game);

            }

        }

        if (this.pointerDown && this.pointerDown.identifier === event.identifier) {

            var yDelta = this.pointerDown.y - event.y;
            var xDelta = this.pointerDown.x - event.x;

            if (yDelta > 10) {

                game.send("useSkill", "roll");

                this.pointerDown = false;

            }

            if (yDelta < -20) {

                game.send("useSkill", "block");

                this.pointerDown = false;

            }

            if (xDelta > 20) {

                game.send("throw_weapon");

                this.pointerDown = false;

            }

            if (xDelta < -20) {

                game.send("useSkill", "kick");

                this.pointerDown = false;

            }

        }

    },

    startRunning: function(game) {

        if (this.run)
            return;

        this.run = true;

        game.send("growl_start");

    },

    stopRunning: function(game) {

        if (!this.run)
            return;

        this.run = false;

        game.send("growl_stop");

    },

    pointerwheel: function(game, event) {
    },

    step: function(game, dt) {

        if (game.player) {
        // game.desiredDirection = Utils.lookAt(game.player.x, game.player.y - 24, game.pointerRealX, game.pointerRealY - 24);

        }

    },

    render: function(game, layer) {

        if (this.moveCircle) {
            layer.save();

            layer.fillStyle("#fff");

            layer.a(this.moveCircle.inner ? 0.25 : 0.5);
            layer.fillCircle(this.moveCircle.x, this.moveCircle.y, this.moveCircleOuterRadius);
            layer.a(this.moveCircle.inner ? 0.5 : 0.25);
            layer.fillCircle(this.moveCircle.x, this.moveCircle.y, this.moveCircleInnerRadius);

            layer.restore();

        }

    }

}

/* file: script/modules/Game.Graveyard.js */

CLIENT.Game.Graveyard = function() {

    this.status = {
        text: "This is example text",
        alive: 1
    };

}
;

CLIENT.Game.Graveyard.prototype = {

    counterSprite: [125, 184, 57, 34],

    postrender(layer) {

        let x = app.width / 2;
        let y = 16;

        layer.align(0.5, 0.0);
        layer.drawRegion(app.images.gui, this.counterSprite, x, y);
        layer.realign();

        layer.fillStyle("#99e550");
        // layer.font("generic 12px");
        layer.font("700 12px 'Exo 2'")
        layer.textAlign("center");
        layer.fillText(this.status.alive, x + 14, y + 10);

        // layer.font("generic 10px");
        layer.font("700 12px 'Exo 2'")

        layer.fillStyle("#000");
        layer.fillText(this.status.text, x, y + 36)

    },

    setStatus(data) {

        this.status = data;

    }

};

CLIENT.Game.MessageHandler.graveyard_status = function(game, data) {

    game.modeController.setStatus(data);

}
;

/* file: script/modules/Game.Tutorial.js */

CLIENT.Game.Tutorial = function() {
// this.state = new CLIENT.StateManager(this, this.states)

}
;

CLIENT.Game.Tutorial.prototype = {

    order: ["attack", "vsBlock", "vsRoll", "vsThrow", "end"],

    texts: {

        "attack": "Use {input,attack} to attack with a weapon. Hold attack button to launch more powerful strike. Hold {input,run} to run",
        "vsBlock": "Use {input,block} to defend against enemy attacks. You can break the block using roll {input,roll} ",
        "vsRoll": "Tap {input,run} to kick and knock down enemy while he is rolling. You can also jump over rolling opponent using {input,jump}",
        "vsThrow": "You can block a knife using {input,block} - OR - you can kick it back with {input,run}.",
        "end": "Thats it. You can find more rules in HELP. For example double tap WSAD to dash, or hold right mouse button and do a wheel up to use your special attack",

    },

    createTextElement: function(text, index) {

        this.textElement = $("<div>").addClass("tutorial-text").html("<p>" + text + "</p>");

        this.textElement.appendTo(document.body);

        if (index > -1) {
            var pc = ((index / (this.order.length - 1)) * 100 | 0) + "%";
            var $progressBar = $("<div>").addClass("gui-progressbar size-sm").appendTo(this.textElement);
            var $progress = $("<div>").appendTo($progressBar);
            $progress.css("width", pc);
        }

        app.sound.play("tutorial/next");

        if (index === this.order.length - 1)
            app.sound.play("audience/cheers_3");

        $("<a>").addClass("gui-button primary size-sm").html("Take me to the real game!").appendTo(this.textElement).on("click", function() {

            window.location.hash = "#play_ruins=1";
            window.location.reload();

        });

    },

    removeTextElement: function() {

        this.textElement.remove();
        this.textElement = null;

    },

    onMessage: function(message, data) {

        switch (message) {

        case "tutorialState":

            analytics('turbo.send', 'event', 'tutorial', "next_" + data);

            var bb = this.texts[data];

            if (bb) {

                var text = UI.bb(bb);

                if (text) {

                    if (this.textElement)
                        this.removeTextElement();

                    this.createTextElement(text, this.order.indexOf(data));

                }

            }

            break;

        }

    }

};

CLIENT.Game.Tutorial.prototype.states = {
};

/* file: script/modules/Eclipse.js */

NAMESPACE.Eclipse = function() {

    this.radius = 20000;

    this.entities = new CLIENT.Entities(app.game);

}
;

NAMESPACE.Eclipse.prototype = {

    tentacleSounds: ["shadow/pain2"],

    render() {
        let gl = app.gl;

        app.painter.setFramebuffer(app.game.eclipseBuffer);

        Matrix3.reset(app.game.viewMatrix);
        Matrix3.multiply(app.game.viewMatrix, Matrix3.projection2(app.game.eclipseBuffer.width, app.game.eclipseBuffer.height));

        for (var key in app.programs) {

            let program = app.programs[key];

            gl.useProgram(program.native);

            program.set("viewMatrix", app.game.viewMatrix);

        }

        gl.clearColor(0.0, 0.0, 0.0, 0.0);
        gl.colorMask(1.0, 1.0, 1.0, 1.0);
        gl.clear(gl.COLOR_BUFFER_BIT);

        Matrix3.reset(app.game.viewMatrix);
        Matrix3.reset(app.game.camera.matrix);
        Matrix3.scale(app.game.camera.matrix, app.game.camera.scale, app.game.camera.scale);
        Matrix3.translate(app.game.camera.matrix, Math.ceil(-app.game.camera.x), Math.ceil(-app.game.camera.y));
        Matrix3.multiply(app.game.viewMatrix, Matrix3.projection2(app.game.eclipseBuffer.width, app.game.eclipseBuffer.height));
        Matrix3.multiply(app.game.viewMatrix, app.game.camera.matrix);

        for (var key in app.programs) {

            let program = app.programs[key];

            gl.useProgram(program.native);

            program.set("viewMatrix", app.game.viewMatrix);

        }

        let player = app.game.player;

        this.playerDistance = this.radius - Utils.distance(0, 0, player.x, player.y);

        app.painter.reset();
        app.painter.align(0, 0);

        if (!this.entities)
            this.entities = new CLIENT.Entities(this);

        this.entities.step(app.elapsed);

        for (let entity of this.entities.children) {

            if (entity.render && entity.inView) {

                entity.render(app.layer);

            }

        }

        let radius = this.radius;

        if (this.playerDistance > 0 && Utils.interval(app.game, "eclipse_tentacle", this.rrr || 0)) {

            this.rrr = 0.25 + Math.random();

            let ac = Utils.lookAt(0, 0, app.game.player.x, app.game.player.y);
            let al = 200 / (2 * Math.PI * this.radius);
            let as = ac - al / 2;

            let r = Math.random();

            let a = Utils.randomf(as, as + al);

            let x = 0 + Math.cos(a) * (radius + 10);
            let y = 0 + Math.sin(a) * (radius + 10);

            let d = Math.max(0.0, 1.0 - Utils.distance(x, y, app.game.player.x, app.game.player.y) / 250) * 2.0;
            let duration = 1.0 + Math.random();
            // app.ambient("background/eclipse_edge", 0.5 * d, 0.85);
            // app.ambient("background/eclipse_edge_vocal", 0.25 * d, 1.5);

            if (d > 0.1) {

                app.sound.play("item").delay(duration * 0.5).rate(0.35).rrate(0.1).volume(d);
                app.sound.play(Utils.random(this.tentacleSounds)).delay(duration * 0.25).rrate(0.2).volume(d * 0.35).fadeOut(0.35);

                let rotation = Utils.lookAt(x, y, app.game.player.x, app.game.player.y);
                ;var sprite = this.entities.add("Sprite");

                sprite.x = x;
                sprite.y = y;
                sprite.set(r > 0.5 ? "fx/eclipse_tentacle2" : "fx/eclipse_tentacle");
                sprite.lifespan = 2.0;
                sprite.rotation = rotation;
                sprite.duration = duration;
                sprite.scaleX = (1.0 + r * 1.0) * d;
                sprite.scaleY = 1.0 * d;
                sprite.alignX = 0.1;
                // app.painter.reset();
                // app.painter.scale(, (1.0) * d);
                // app.painter.align(0.2, 0.5);
                // app.painter.drawSprite(, x, y, (app.lifetime + r * 10) * 10);

                var sprite = this.entities.add("Sprite");

                sprite.zIndex = 2;
                // sprite.color = this.color;
                sprite.x = x + Math.cos(a - Math.PI) * 30;
                sprite.y = y + Math.sin(a - Math.PI) * 30;
                sprite.color = "#000"
                sprite.scale = 2.0 * d;
                sprite.set("debris", false);
                sprite.rotation = rotation + Math.HPI + Math.PI;
                sprite.setDuration(duration);

            }

        }
        app.painter.reset();
        app.painter.align(0, 0);
        app.painter.color(0x000001, 1.0);
        app.painter.program(app.programs.eclipse);
        app.programs.eclipse.set("alpha", 1.0);
        app.programs.eclipse.set("t", 0);
        app.programs.eclipse.set("radius", (radius / app.width) * 2.0);
        app.programs.eclipse.set("aspect", app.height / app.width);
        app.programs.eclipse.set("offsetX", (app.game.camera.x + app.width / 2) / app.width);
        app.programs.eclipse.set("offsetY", (app.game.camera.y + app.height / 2) / app.height);
        app.painter.fillRect(app.game.camera.x, app.game.camera.y, app.width, app.height);

    },

    step(dt) {

        this.entities.step(dt);

        if (app.game.player && !app.game.player.dead && !Utils.inRange(0, 0, app.game.player.x, app.game.player.y, this.radius)) {

            app.ambient("human/growl", 0.75, 0.3);
            // app.ambient("background/eclipse_edge_vocal", 1.0, 1.1);

            app.game.camera.shake(5.0, 1.0);
            this.inside = true;

        } else {
            this.inside = false;
        }
    }

};

/* file: script/modules/TextAtlas.js */

CLIENT.TextAtlas = function(font="32px Ubuntu") {

    this.color = 0xffffff;

    this.font = font;
    this.scale = 1.0;
    this.canvas = document.createElement("canvas");
    this.canvas.width = 1024;
    this.canvas.height = 1024;
    this.rotation = 0.0;

    this.ctx = this.canvas.getContext("2d");

    this.lineHeight = parseInt(this.font);
    this.padding = 4;

    this.reset();

}
;

CLIENT.TextAtlas.prototype = {

    reset() {

        this.lastReset = 0;

        this.regions = [];
        this.plotterX = 0;
        this.plotterY = 32;

    },

    add(text) {

        let lineHeight = this.lineHeight * 1.5 | 0;

        this.ctx.font = this.font;
        this.ctx.textAlign = "left";
        this.ctx.textBaseline = "top";

        let width = this.ctx.measureText(text).width

        if (this.plotterX + width > this.canvas.width) {
            this.plotterX = 0;
            this.plotterY += lineHeight + this.padding;
        }

        if (this.plotterY + lineHeight + this.padding > this.canvas.height) {

            this.canvas.width += 0;
            this.plotterY = 0;

        }

        this.ctx.fillStyle = "#fff";
        var grd = this.ctx.createLinearGradient(0, this.plotterY, 0, this.plotterY + lineHeight);
        grd.addColorStop(0, "#fff");
        grd.addColorStop(1, "#f88");
        this.ctx.fillStyle = grd;

        app.cq.font(this.font);
        let ft = app.cq.fontTop();

        this.ctx.fillText(text, this.plotterX, this.plotterY - ft);

        this.regions[text] = [this.plotterX, this.plotterY, width, lineHeight];

        this.plotterX += width + this.padding;
        this.plotterX = Math.ceil(this.plotterX);
        this.plotterY = Math.ceil(this.plotterY);
        /*
                let imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                let pixels = imageData.data;

                for (let i = 0; i < imageData.width * imageData.height * 4; i += 4) {

                    if (pixels[i + 3] < 255) {
                        
                        pixels[i + 0] = 255;
                        pixels[i + 1] = 255;
                        pixels[i + 2] = 255;
                        pixels[i + 3] = 255;

                    }

                }

                this.ctx.putImageData(imageData, 0, 0);
        */

        app.gl.deleteTexture(this.texture);

        this.texture = app.textureFromCanvas(this.canvas);

    },

    getWidth(text) {

        if (!this.regions[text])
            this.add(text);

        let region = this.regions[text];

        return region[2];

    },

    fillText(text, x, y, align=0.5) {

        if (!this.regions[text])
            this.add(text);
        let region = this.regions[text];

        app.painter.reset();

        if (this.scale !== 1.0)
            app.painter.scale(this.scale, this.scale);

        app.painter.align(align, 0.0);
        app.painter.rotate(this.rotation);
        app.painter.color(this.color);
        app.painter.drawImageRegion(this.texture, region[0] | 0, region[1] | 0, region[2] | 0, region[3] | 0, x, y, region[2] | 0, region[3] | 0);

    },

    fillTextManual(text, x, y, align=0.5) {

        if (!this.regions[text])
            this.add(text);
        let region = this.regions[text];

        app.painter.drawImageRegion(this.texture, region[0] | 0, region[1] | 0, region[2] | 0, region[3] | 0, x, y, region[2] | 0, region[3] | 0);

    }

};

/* file: script/modules/Controllers.js */

CLIENT.Controllers = function() {

    this.items = [];

}
;

Object.assign(CLIENT.Controllers.prototype, {

    add(controller) {

        if (this.items.indexOf(controller) > -1)
            return;

        this.items.push(controller);

    },

    remove(controller) {

        Utils.pull(this.items, controller);

    },

    call(method, a, b, c, d) {

        if (!this.items.length)
            return;

        for (var i = 0; i < this.items.length; i++) {

            if (!this.items[i][method])
                continue;

            this.items[i][method](a, b, c, d);

        }

    }

});

/* file: script/modules/Audience.js */

CLIENT.Audience = {

    duration: 3,

    iconSize: 16,

    template: `<div class="UIAudience">

    <div class="emotes gui-cols" ui-id="emotes">
      <span class="gui-clickable" key="happy"><img src="images/emoji/happy.png"></span>
      <span class="gui-clickable" key="clap"><img src="images/emoji/clap.png"></span>
      <span class="gui-clickable" key="angry"><img src="images/emoji/angry.png"></span>
      <span class="gui-clickable" key="haha"><img src="images/emoji/haha.png"></span>
    </div>

  </div>`,

    init() {

        this.entities = [];

    },

    closePanel() {

        this.$element.remove();

    },

    showPanel() {

        this.$element = UI.parse(this.template, this);

        this.$element.find(".emotes > *").each((k,el)=>{

            let key = $(el).attr("key");

            $(el).on("click touchstart", this.onEmoteClick.bind(this, key));

            this.$emotes["$" + key] = $(el);

        }
        );

        this.$element.appendTo(document.body);

        this.lifetime = 0;

    },

    onEmoteClick(key) {

        app.game.ask("spectate_emote", {
            emote: key
        }).then((result)=>{

            this.refreshEmotes(result);

        }
        );

    },

    touchEmotes() {

        app.game.ask("touch_spectate_emotes", {}).then((result)=>{

            this.refreshEmotes(result);

        }
        );

    },

    refreshEmotes(result) {

        if (!result)
            return;

        for (var key in result) {

            this.$emotes["$" + key].toggleClass("disabled", result[key] === 0);

        }
    },

    emote(key) {

        let entity = {
            key: key,
            lifetime: 0,
            x: Utils.random(-200, 200)
        };

        this.entities.push(entity);

        app.tween(entity).to({
            y: 10 + Utils.random(0, 40)
        }, this.duration * 0.4, "outElastic").to({
            y: -50
        }, this.duration * 0.4, "inQuad");

        if (key === "clap") {

            app.sound.play("audience/emotes/" + key + Utils.random(1, 3)).rate(1.0).rrate(0.2).pan(-1.0 + Math.random() * 2).volume(0.5);

        } else {

            app.sound.play("audience/emotes/" + key + Utils.random(1, 3)).rate(1.5).rrate(0.2).pan(-1.0 + Math.random() * 2).volume(0.5);

        }

    },

    render(layer, x, y) {

        return;

        for (var i = 0; i < this.entities.length; i++) {

            let entity = this.entities[i];

            let image = app.images["emoji/" + entity.key];

            if (!image) {

                app.loadImage("emoji/" + entity.key)

                continue;

            }

            layer.drawImage(image, 0, 0, image.width, image.height, x + entity.x, y + entity.y, this.iconSize, this.iconSize);

        }

    },

    step(dt) {

        this.lifetime += dt;

        for (var i = 0; i < this.entities.length; i++) {

            let entity = this.entities[i];

            entity.lifetime += dt;

            if (entity.lifetime > this.duration)
                this.entities.splice(i--, 1);

        }

        if (Utils.interval(this, "refresh", 2)) {

            this.touchEmotes();

        }

    }

}

/* file: script/modules/EmoteWindow.js */

CLIENT.EmoteWindow = {

    acks: ["bue", "follow", "help", "no", "ok", "attack", "defend", "vrngh", "good"],

    ir: 50,

    index: -1,

    render(layer) {

        let angle_step = Math.TAU / this.acks.length;

        // layer.strokeStyle("#fff").lineWidth(2).strokeCircle(app.center.x, app.center.y, this.ir);
        app.painter.reset();
        app.painter.color(0xffffff, 0.25)
        app.painter.arc(app.center.x, app.center.y, 32, 80);

        for (var i = 0; i < this.acks.length; i++) {

            let angle = angle_step * i;
            let selected = this.index === i;
            let r = this.ir;

            app.painter.reset();

            let x = app.center.x + Math.cos(angle) * (r + 10);
            let y = app.center.y + Math.sin(angle) * (r + 10);

            if (selected) {

                app.painter.color(0xffffff);
                // app.painter.rotate(angle - angle_step / 2);
                // app.painter.fillCircle(app.center.x, app.center.y, 100);
                app.painter.arc(app.center.x, app.center.y, 32, 80, angle - angle_step / 2, angle_step);
                app.painter.rotate(angle);

            }

            // if (this.index === i) layer.fillStyle("#fff").a(0.5).fillRect(0, -8, 160, 32).ra();

            // layer.fillStyle("#000");

            app.painter.reset();
            app.painter.color(0x444444);
            app.painter.align(0.5, 0.0);
            app.painter.offset(0.0, -6.0)
            app.game.nameFont.fillTextManual(this.acks[i], x, y);

        }

    },

    step() {

        if (Utils.distance(app.mouse.x, app.mouse.y, app.center.x, app.center.y) < this.ir) {

            this.index = -1;

        } else {

            let angle_step = Math.TAU / this.acks.length;

            let angle = Utils.circWrap((Utils.lookAt(app.center.x, app.center.y, app.mouse.x, app.mouse.y) + angle_step / 2));

            this.index = angle / angle_step | 0;

        }

    },

    close() {

        if (this.index > -1) {

            app.game.send("ack", this.acks[this.index]);

        }

    }

}

/* file: script/modules/Emitter.js */

var Emitter = function() {

    this.map = new Map;

};

Emitter.prototype = {

    trigger(name) {

        let args = Array.from(arguments);

        args.shift();

        name = name.toLowerCase();

        let callbacks = this.map.get(name);

        if (!callbacks)
            return;

        for (let i = 0; i < callbacks.length; i++) {

            let callback = callbacks[i];

            callback(...args);

            if (callback.once)
                callbacks.splice(i--, 1);

        }

    },

    has(name) {

        let callbacks = this.map.get(name);

        return callbacks && callbacks.length > 0;

    },

    on(name, callback) {

        name = name.toLowerCase();

        if (!this.map.has(name))
            this.map.set(name, []);

        this.map.get(name).push(callback);

        return callback;

    },

    once(name, callback) {

        name = name.toLowerCase();

        if (!this.map.has(name))
            this.map.set(name, []);

        callback.once = true;

        this.map.get(name).push(callback);

        return callback;

    },

    off(name, callback) {

        let callbacks = this.map.get(name);

        if (!callbacks)
            return;

        let index = callbacks.indexOf(callback);

        if (index > -1)
            callbacks.splice(index, 1);

    },

    listen(name, callback, object) {

        if (!object.listeners)
            object.listeners = [];

        object.listeners.push([name, callback]);

        this.on(name, callback);

    },

    kill(object) {

        if (!object)
            return;
        if (!object.listeners)
            return;

        for (var i = 0; i < object.listeners.length; i++) {

            let listener = object.listeners[i];

            this.off(listener[0], listener[1]);

        }

    }

};

/* file: script/modules/Weather.js */

CLIENT.Weather = function(game) {

    this.game = game;

    this.key = "xxx";

    this.raining = 0.0;
    this.snowing = 0.0;
    this.currentOverlay = 0;

    this.overlays = [{
        color: 0x000000,
        alpha: 0.0
    }, {
        color: 0x000000,
        alpha: 0.0
    }];

}
;

CLIENT.Weather.prototype = {

    kill() {

        if (this[this.key + "_leave"])
            this[this.key + "_leave"]();

    },

    set(key) {

        if (this.key === key)
            return;

        if (this[this.key + "_leave"])
            this[this.key + "_leave"]();

        this.key = key;

        if (this[key + "_enter"])
            this[key + "_enter"]();

    },

    enterHouse() {

        if (this[this.key + "_enter_house"])
            this[this.key + "_enter_house"]();

        this.inHouse = true;

    },

    leaveHouse() {

        if (this[this.key + "_leave_house"])
            this[this.key + "_leave_house"]();

        this.inHouse = false;

    },

    renderOverlay(i) {

        let overlay = this.overlays[i];

        if (!overlay.alpha)
            return;

        app.painter.reset();
        app.painter.align(0, 0);
        app.painter.color(overlay.color, 1.0);
        app.painter.alpha(overlay.alpha);
        app.painter.fillRect(0, 0, app.width, app.height);

    },

    render() {

        this.renderOverlay(0);
        this.renderOverlay(1);

        if (this.raining) {

            for (let i = 0; i < this.raining * 5 | 0; i++)
                this.raindrop();

        }

        if (this.snowing) {

            for (let i = 0; i < this.snowing * 5 | 0; i++)
                this.snowflake();

        }

    },

    snowflakeColors: [0xeeeeff, 0xbbbbcc],

    snowflake() {

        if (this.game.entities.groups.snowflakes && this.game.entities.groups.snowflakes.length > 200)
            return;

        let x = Utils.random(this.game.camera.x - 100, this.game.camera.x + this.game.camera.box[2] + 200);
        let y = Utils.random(this.game.camera.y, this.game.camera.y + this.game.camera.box[3] + 300);
        let tile = this.game.map.get(x / COMMON.TILE_WIDTH | 0, y / COMMON.TILE_HEIGHT | 0);
        if (tile && tile.ground)
            return;

        let duration = 0.5 + Math.random();

        let raindrop = this.game.entities.add("Snowflake");
        raindrop.color = Utils.random(this.snowflakeColors);
        raindrop.alpha = 1.0;
        raindrop.x = x;
        raindrop.y = y;
        raindrop.zIndex = 5;
        raindrop.scale = 0.0;

    },

    raindropColors: ["#639bff", "#cbdbfc"],

    raindrop() {

        let x = Utils.random(this.game.camera.x, this.game.camera.x + this.game.camera.box[2]);
        let y = Utils.random(this.game.camera.y, this.game.camera.y + this.game.camera.box[3] + 300);
        let toX = x - Utils.random(50, 200);
        let tile = this.game.map.get(toX / COMMON.TILE_WIDTH | 0, y / COMMON.TILE_HEIGHT | 0);
        if (tile && tile.ground)
            return;

        let raindrop = this.game.entities.add("Sprite");
        raindrop.set("fx/raindrop");
        raindrop.duration = 0.5;
        raindrop.blendDst = app.gl.ONE;
        raindrop.tempColor = Utils.random(this.raindropColors);
        raindrop.alpha = 0.6;
        raindrop.z = 200;
        raindrop.x = x;
        raindrop.y = y;
        raindrop.zIndex = 5;
        raindrop.scale = Utils.randomf(1.0, 2.0);

        raindrop.rotation = 0.5;
        app.tween(raindrop).to({
            z: 0,
            x: toX
        }, 0.1 + Math.random() * 0.1);

    },

    setOverlay(color, alpha, time=4.0) {

        let prev = this.overlays[this.currentOverlay];

        this.currentOverlay = !this.currentOverlay | 0;

        let next = this.overlays[this.currentOverlay];

        app.tween(prev).to({
            alpha: 0
        }, time);
        app.tween(next).to({
            alpha: alpha
        }, time);

        next.color = color;

    },

    /* STATES */

    default_enter() {

        app.tween(this).to({}, 4.0);

        // this.ambientLoop = app.sound.play("background/spiritual").volume(0.3).fadeIn(4.0).loop();

        // this.setOverlay(0xffaa00, 0.0, 4.0)
        app.game.weather.setOverlay(0x0055ff, 0.12);

    },

    default_leave() {

        // this.ambientLoop.fadeOut(4.0);

        app.tween(this).to({
            raining: 0.0
        }, 4.0);

    },

    desert_enter() {

        app.tween(this).to({}, 4.0);

        this.ambientLoop = app.sound.play("background/wind").volume(0.3).fadeIn(4.0).loop();

        // this.setOverlay(0xffaa00, 0.0, 4.0)
        app.game.weather.setOverlay(0x0055ff, 0.0);

    },

    desert_leave() {

        this.ambientLoop.fadeOut(4.0);

        app.tween(this).to({
            raining: 0.0
        }, 4.0);

    },

    desert_enter_house() {

        this.ambientLoop.fadeTo(0.3, 1.0);

    },

    desert_leave_house() {

        this.ambientLoop.fadeTo(1.0, 1.0);

    },

    raining_enter() {

        this.rainLoop = app.sound.play("background/rain").volume(0.15).fadeIn(4.0).loop();

        app.tween(this).to({
            raining: 1.0
        }, 4.0);

        this.setOverlay(0x0000ff, 0.15, 4.0)

    },

    raining_leave() {

        this.rainLoop.fadeOut(4.0);

        app.tween(this).to({
            raining: 0.0
        }, 4.0);

    },

    snowing_enter() {

        app.game.setAlert({
            text: "The weather is very bad - you should find a shelter",
            type: "warning"
        });

        this.snowLoop = app.sound.play("background/wind").volume(0.3).fadeIn(4.0).loop();

        app.tween(this).to({
            snowing: 1.0
        }, 4.0);

        app.game.weather.setOverlay(0x8888ff, 0.4, 4.0);
    },

    snowing_leave() {

        this.snowLoop.fadeOut(4.0);

        app.tween(this).to({
            snowing: 0.0
        }, 4.0);

    }

};

/* file: script/Lobby.js */

CLIENT.Lobby = {

    queue: {},

    maxMMR: {},

    setState: function(state) {

        if (this.state && this.state.leave)
            this.state.leave();

        this.state = state;

        this.state.parent = this;

        if (this.state && this.state.enter)
            this.state.enter();

    },

    leave: function() {

        if (!this.tempGame) {

            this.close();

        }

        if (this.video) {

            this.video.pause();

            delete this.video;

        }

    },

    close: function() {

        if (this.socket) {

            this.setState({});
            this.socket.close();
            this.socket = false;

        }

    },

    call: function(method, a, b, c, d) {

        if (this.state && this.state[method])
            return this.state[method](a, b, c, d);

    },

    keydown: function(key) {

        this.call("keydown", key);

    },

    enter: function() {

        if (this.socket) {

            this.socket.close();

            this.socket = false;

        }

        var self = this;

        this.videoready = false;

        if (false && !PLAYGROUND.MOBILE) {

            this.video = document.createElement("video");
            this.video.loop = true;
            this.video.src = "trailer.webm";
            this.video.load();
            this.video.addEventListener('loadeddata', function() {

                if (self.video) {
                    self.videoready = true;
                    self.video.play();
                }

            });

        }

        this.socket = new WebSocket(app.wsURL(ENV.LOBBY_URL, ENV.lobbyWsPort, ENV.lobbyWssPort));

        this.socket.addEventListener("open", this.onconnect.bind(this));

        this.socket.addEventListener("error", function() {

            if (app.altport) {

                app.lobby.setState({});

                var $gui = app.parseUI("html/lobby_play");

                $gui.appendTo("#gui .mid .center");

                $gui.html("SORRY. Could not connect to the server. Maybe I am updating something. Try connecting again within a minute. Otherwise it is your connection. Maybe you are behind firewall.");
                // $gui.html("SORRY. My database provider is fixing something... they said it will take a few moments - but I can't really tell how long will it take.");

                setTimeout(function() {

                    $gui.remove();
                    app.setState(app.lobby);

                }, 2000);

            } else {

                app.altport = true;

                self.enter();

            }

        });

        this.socket.addEventListener("close", this.ondisconnect.bind(this));

    },

    onconnect: function() {

        this.socket.addEventListener("message", this.onmessage.bind(this));

        this.setState(CLIENT.Lobby.Play);

    },

    ondisconnect: function() {

        this.call("ondisconnect");

    },

    onmessage: function(event) {

        var raw = event.data;

        var packet = JSON.parse(raw);

        var message = packet[0];
        var data = packet[1];

        switch (message) {

        case "response":

            let resolve = this.requests.get(data.request_id);

            if (resolve)
                resolve(data.response);

            break;

        case "game_ready":

            if (this.inRankedGame)
                return;

            var modeData = COMMON.modes[data.mode];

            app.sound.play("game_ready");

            if (!modeData.fun) {

                this.tempGame = false;
                this.inRankedGame = true;
            }

            if (!this.tempGame) {

                this.close();

            } else {

                app.console.say("Explore the ruins while waiting for the ranked game.", "system");

                this.state.minimize();

            }

            if (app.keyboard.keys.shift) {
            // data.spectate = true;
            // data.game_id = 0;
            }

            var timeout = modeData.fun ? 100 : 2000;

            if (app.options.wait_in_lobby)
                timeout = 100;
            if ($_GET['live'])
                timeout = 100;

            setTimeout(function() {

                app.loadGameSprites().then(function() {

                    app.setState(app.game);

                    app.game.connect(data);

                });

            }, timeout);

            break;

        }

        this.call("onmessage", message, data);

    },

    send: function(message, data) {

        data = data || {};

        var packet = JSON.stringify([message, data]);

        this.socket.send(packet);

    },

    request_id: 1,

    requests: new Map,

    ask: function(message, data) {

        data = data || {};

        data.question = message;

        data.request_id = this.request_id++;

        this.send("ask", data);

        return new Promise((resolve,reject)=>{

            this.requests.set(data.request_id, resolve);

            setTimeout(reject, 10000);

        }
        );

    },

    /* buttons */

    render: function() {

        return;

        app.layer.clear("#45283c");

        if (!this.videoready)
            return;

        var s = Math.max(app.width / this.video.videoWidth, app.height / this.video.videoHeight);

        app.layer.save();

        app.layer.scale(s, s);
        app.layer.drawImage(this.video, 0, 0);
        app.layer.restore();

        app.layer.a(0.5).clear("#002").ra();

    },

    visibilitychange: function(event) {

        this.call("visibilitychange", event);

    },

    localstorage: function(event) {

        this.call("localstorage", event);

    },

    step: function(dt) {

        this.call("step", dt);

    },

    resize() {
        this.call("resize");

    }

};

/* file: script/Lobby.Login.js */

CLIENT.Lobby.Login = {

    enter: function() {

        this.$gui = app.gui.add({
            width: "100%",
            height: "100%"
        });

        var panel = this.$gui.add(".welcome", {
            layout: "vertical",
            x: "50%",
            y: "50%",
            anchor: [0.5, 0.5]
        });

        this.$output = panel.add({
            scale: 0,
            text: "OUTPUT",
            background: "#fafafa",
            color: "#000",
            padding: 4,
            width: "100%",
            marginBottom: 4
        });

        /* Email input */

        var wrapper = panel.add(".horizontal");

        wrapper.add(".input-icon.email");

        this.$email = wrapper.add("TextInput.email");

        /* Password input */

        var wrapper = panel.add(".horizontal");

        wrapper.add(".input-icon.password");

        this.$password = wrapper.add("TextInput.password");

        /* Buttons */

        var wrapper = panel.add(".horizontal");

        wrapper.add(".button.green", {
            text: "Login",
            marginRight: 3,
            width: 60,
        }).on("click", this.onloginclick.bind(this));

        wrapper.add(".button.red", {
            text: "Register",
            width: 60
        }).on("click", this.onregisterclick.bind(this));

        panel.add(".button.gray", {
            text: "Play as a guest",
            width: "100%"
        });

        /*
        this.parent.send("login", {
          email: 'asd@o2.pl',
          password: "123"
        });
        */

    },

    leave: function() {

        this.$gui.remove();

    },

    onmessage: function(message, data) {

        switch (message) {

        case "error":

            this.$output.set("text", data.error);

            break;

        case "register_successful":

            break;

        case "login_successful":

            this.parent.setState(CLIENT.Lobby.Play);

            break;

        }

    },

    onpatreonclick: function() {

        this.parent.send("expect_patreon");

    },

    onregisterclick: function() {

        this.parent.send("register", {
            email: this.$email.value,
            password: this.$password.value
        });

    },

    onloginclick: function() {

        this.parent.send("login", {
            email: this.$email.value,
            password: this.$password.value
        });

    }

};

/* file: script/Lobby.Play.js */

CLIENT.Lobby.Play = {

    locations: {
        EU: {},
        US: {},
        AS: {}
    },

    facebookURI: "https://www.facebook.com/dialog/oauth?client_id={app_id}&redirect_uri={redirect_url}",
    patreonURI: "https://www.patreon.com/oauth2/authorize?response_type=code&client_id=wQ-sNpVEdIdgrNr4SuJ17SEr_aZF1vzObb-xLA2Tsffno7tIkVe0Tg74HgXd_dRO&redirect_uri={redirect_url}",
    googleURI: "https://accounts.google.com/o/oauth2/v2/auth?scope=email%20profile&redirect_uri={redirect_url}&response_type=code&client_id=74417074777-l9141b73533tp6fttd5dtt6uqd57nhq9.apps.googleusercontent.com",

    facebook_redirect_uri: (window.location.origin + window.location.pathname) + "api/facebook_login",
    patreon_redirect_uri: (window.location.origin + window.location.pathname) + "api/patreon_code",
    google_redirect_uri: (window.location.origin + window.location.pathname) + "api/google_login",

    autologin: false,

    minimize: function() {

        this.$gui.hide();
        // this.chat.$messages.prev().hide();
        // this.chat.$messages.hide();
        // this.chat.$textinput.hide();
        this.chat.close();

    },

    promptLogin(message) {

        if (this.loginPrompt) {

            this.loginPrompt.close();

        }

        let widget = new UI.LoginPrompt();

        widget.$element.appendTo(document.body);
        widget.$element.addClass("center-window");

        this.loginPrompt = widget;

        if (message)
            widget.$element.$message.html(message).show();

    },

    promptNewsletter(message) {

        let widget = new UI.NewsletterPrompt();

        widget.$element.appendTo(document.body);
        widget.$element.addClass("center-window");

        this.NewsletterPrompt = widget;

    },

    enter: function() {

        document.body.classList.toggle("loading", false);

        $("body").toggleClass("lobby", true);

        $(app.canvas).hide();

        if (window != window.top)
            $("#SuperGroup").hide();
        if (window != window.top)
            $("#gamezoo").hide();
        if (window != window.top)
            $("#IOG_CP").hide();

        if ($_GET['recruiter'])
            localStorage.setItem("recruiter", $_GET["recruiter"]);

        $("#zoomIn").hide();
        $("#zoomOut").hide();

        var self = this;

        this.resetUser();

        this.$gui = UI.parse(app.data.html.lobby_play, this);

        var $gui = this.$gui;

        $gui.appendTo("#gui");

        /* select location */

        if (!localStorage.getItem("location")) {

            app.probeBestLocation().then(function(l) {

                UI.select.val($gui.$locations, l);

            });

        }

        UI.select($gui.$locations, localStorage.getItem("location") || "EU", this.selectLocation.bind(this));

        /* select mode */

        var mode = localStorage.getItem("mode");

        if (mode === null)
            mode = Utils.random(["fun"]);
        // if (mode === null) mode = "soccer";

        /* Auto login */

        if ($_HASH['autologin']) {

            localStorage.setItem("autologin", "true");
            localStorage.setItem("secret", $_HASH["autologin"]);

        }

        app.lobby.send("date", Date.now());

        var autologin = localStorage.getItem("autologin");

        if (autologin === null)
            autologin = true;

        if (autologin) {

            var secret = localStorage.getItem("secret");

            if (secret) {

                this.loginPlatform = "secret";

                this.parent.send("auto_login", {
                    secret: secret
                });

            } else {

                if (ENV.useTempLogin) {

                    app.lobby.ask("temp_login");

                }
            }

            this.toggleAutoLogin(true);

        } else {

            this.toggleAutoLogin(false);

        }

        /* Hero sprite */

        this.heroSprite = new UI.Hero({
            parent: this.$gui.$heroSprite,
            observe: app.user
        });

        var sprite = new UI.Sprite({
            scale: 1.0,
            parent: this.$gui.$itemPromo,
            sprite: "equipment/noble_cape_turntable",
            offsetY: -15
        });

        // this.$gui.$itemPromo.hide();

        /* Discord */

        UI.showFirst(this.$gui.$loginPanel, this.$gui.$logoutPanel);

        if (window.arapi && app.ads) {

            app.adstate = "home";

            arapi.show("xx");

        }

        /* Facebook share */

        this.$gui.$waiting.hide();
        this.$gui.$mapsTable.removeClass("gui-disabled");

        this.chat = new UI.Chat();
        this.chat.appendTo(this.$gui);
        this.chat.events.on("foldChange", function(state) {
            state ? arapi.show() : arapi.hide();
        });
        this.chat.fold();

        let forumFrame = UI.html(`<iframe class="forum-iframe"></iframe>`);
        forumFrame.src = `//${ENV.forum_host}/widgets/frontpage/3`;

        this.$gui.append(forumFrame);
        this.forumFrame = forumFrame;

        if (PLAYGROUND.IFRAME || window.innerWidth < 1165 || !ENV.forum) {

            this.chat.$gui.remove();
            $(this.forumFrame).remove();

            this.$gui.css("justify-content", "center");

        }

        if (PLAYGROUND.IFRAME || !app.ads || window.innerWidth < 1000) {

            this.$gui.$left.css("width", 1);

        }

        // this.$gui.$mainWindow.toggleClass("top", true);

        if ($_HASH['game_link']) {

            this.$gui.$playInvitationLink.show();
            this.$gui.$playtab.toggleClass("green", false);
            this.$gui.$playtab.toggleClass("primary", true);
            this.$gui.$playtab.html("NEW GAME");

            // this.$gui.$modes.hide();
            // this.$gui.$locations.hide();

            // this.selectMode(0);

        } else {

            this.$gui.$playInvitationLink.hide();

        }

        if (!localStorage.getItem("advancedLayout")) {
        // this.showSimpleLayout();

        }

        this.$gui.$mmtag.val(localStorage.getItem("mmtag"));

        this.$gui.$settings.on("click", this.openSettings.bind(this));

        let pickGender = (gender)=>{

            localStorage.setItem("gender", gender);

            app.user.gender = gender | 0;

        }
        ;

        UI.cycle(this.$gui.$gender, localStorage.getItem("gender") | 0, pickGender);

        pickGender(localStorage.getItem("gender") | 0);

        if ($_HASH.verify) {

            localStorage.setItem("verify", $_HASH.verify);

        }

        /* Setup reminders */

        this.$gui.$loginReminder.hide();

        if ($_HASH.join_tribe_public || $_HASH.join_tribe_private) {

            this.$gui.$loginReminder.html("Do you want to join the tribe? You have to login using one of the options below.").show();

        }

        /* Quick news */

        //        this.quickNews = new UI.QuickNews();
        //      this.quickNews.$widget.appendTo(this.$gui.$mainWindow);

        this.prepareMapsTable();

        this.$gui.$name.on("keydown", this.onClaimNameChange.bind(this));

        var options = {
            clickable: true
        };

        this.questWidgets = [new UI.Quest(0,options), new UI.Quest(1,options)];

        this.questWidgets[0].$element.appendTo(this.$gui.$quests);
        this.questWidgets[1].$element.appendTo(this.$gui.$quests);

        this.$gui.find(".side-menu > *").toggleClass("gui-clickable", true);

        if (window.fbq)
            fbq('track', 'ViewContent', {
                value: 0.0005,
                currency: 'USD'
            });

        if ($_HASH['verify_email']) {

            app.lobby.ask("verify_email", {
                key: $_HASH['verify_email']
            }).then((result)=>{
                if (typeof result === "string")
                    app.console.error(result);
            }
            );

        }

        if ($_GET['live']) {

            app.live = true;

            app.lobby.send("spectate", {
                mode: "arena2"
            });

        }

        // this.$gui.$left.hide();

        if (!app.iaps)
            this.$gui.find(".iap").hide();

        if ($_HASH['reset_password'])
            this.passwordRecoveryPrompt();

        {
            let fontLoader = UI.html("<div class='ingame-font'>Ingamefont</div>");

            document.body.append(fontLoader);

            setTimeout(()=>{

                $(fontLoader).remove();

            }
            , 1000);

        }

        if (ENV.useTempLogin) {

            this.$gui.$logoutSection.hide();

        }

        // this.mode = "battle_royale";
        // this.onPlayClick();

        if (ENV.siteLocked) {

            this.$gui.$moreGames.hide();

        }

        if (!ENV.showFullscreen)
            $("#fullscreen").hide();

        if (ENV.siteLocked)
            $(".outgoing-link").hide();

        this.$gui.enhance();

        this.initCountryPicker();

        this.resize();

        app.lobby.send("set_flag", localStorage.getItem("user-country"));

        this.patreonBox = new UI.PatreonBox;

        // $(this.patreonBox.element).appendTo(this.$gui.$logoutPanel);

        if (!app.ads) {
        }

    },

    initCountryPicker() {

        this.countryPicker = new UI.CountryPicker();

        this.$gui.$countryPlaceholder.append(this.countryPicker.element);

        if (!localStorage.getItem("user-country"))
            localStorage.setItem("user-country", "xx");

        this.countryPicker.set(localStorage.getItem("user-country") || "xx");

        this.countryPicker.events.on("change", function(e) {

            localStorage.setItem("user-country", e.country);

            app.lobby.send("set_flag", localStorage.getItem("user-country"));

        });

    },

    passwordRecoveryPrompt() {

        let widget = new UI.ChangePasswordPrompt();

        widget.$element.appendTo(document.body);
        widget.$element.addClass("center-window");

        this.changePasswordPrompt = widget;

    },

    showSimpleLayout: function() {

        this.$gui.$advanced.hide();
        this.$gui.$armory.hide();
        this.$gui.$rankingFlag.hide();
        this.chat.$gui.hide();
        this.$gui.$showAdvancedLayout.show();

    },

    showAdvancedLayoutClick: function() {

        this.showAdvancedLayout();

    },

    showAdvancedLayout: function() {

        localStorage.setItem("advancedLayout", "yes");

        this.$gui.$showAdvancedLayout.hide();
        this.$gui.$advanced.show();
        this.$gui.$armory.show();
        this.$gui.$rankingFlag.show();
        this.chat.$gui.show();

    },

    onTribeClick() {

        let tribe = new UI.Tribe();

        tribe.$widget.appendTo("body");

    },

    lock: function() {

        if (this.overlay)
            this.overlay.remove();

        this.overlay = $("<div>").css({
            position: "absolute",
            width: window.innerWidth,
            height: window.innerHeight,
            left: 0,
            top: 0,
            zIndex: 100000,
            background: "#000",
            opacity: 0.5
        }).appendTo("body");

    },

    unlock: function() {

        if (this.overlay) {
            this.overlay.remove();
            this.overlay = false;
        }

    },

    countryToLocation: {
        "PL": "EU",
        "AR": "US",
        "BR": "US",
        "US": "US",
        "CA": "US",
        "AU": "AS",
        "HK": "AS",
        "CN": "AS",
        "KR": "AS",
        "TW": "AS",
        "SG": "AS",
        "JP": "AS"
    },

    locations: {
        EU: {
            name: "Europe",
            city: "Amsterdam"
        },
        US: {
            name: "America",
            city: "New York"
        },
        AS: {
            name: "Asia",
            city: "Singapore"
        }
    },

    first_click: 0,

    initFirstTime: function() {

        // this.$gui.$armoryPromo.hide();
        // this.$gui.$playFootball.hide();

        app.user.firstTime = true;

        // if (window.analytics) analytics('send', 'event', 'experiments', 'first_time_visit');

        var self = this;

        this.$gui.find("[ui-id]").on("click", function() {

            if (self.first_click_timestamp === app.lifetime)
                return true;

            self.first_click_timestamp = app.lifetime;

            if (self.first_click > 2)
                return true;

            var id = $(this).attr("ui-id");

            var click_name = ["first", "second", "third"][self.first_click];

            // if (window.analytics) analytics('send', 'event', click_name + '_click', id);

            self.first_click++;

        });

        if (this.location === "EU") {

            this.selectMode(Utils.random(["fun"]));
            // this.selectMode("fun");

        }

        if (localStorage.getItem("verify"))
            analytics('send', 'event', 'experiments', 'verify_visit');

        // this.quickNews.$widget.hide();

        // if ($_GET['ref'] !== "gamedistribution") this.onPlayClick();
    },

    onHelpClick: function() {

        return;

        var $help = UI.parse(UI.bb(app.data.html.help));

        $help.appendTo("body");

        $help.on("click", function() {

            $help.remove();

        });

    },

    prepareMapsTable() {

        let order = ["fun", "separator", "arena1", "arena2", "soccer"];
        if ($_GET['partner'])
            order = ["fun", "separator", "arena1", "soccer"];
        let $rowTemplate = this.$gui.$mapsTableRow;
        let $separatorTemplate = this.$gui.$mapsTableSeparator;

        for (let i = 0; i < order.length; i++) {

            let key = order[i];

            if (key === "separator") {

                let $row = $separatorTemplate.clone();

                this.$gui.$mapsTable.append($row);

            } else {

                let modeData = COMMON.modes[key];
                if (!modeData.list)
                    continue;

                let $row = $rowTemplate.clone();

                $row.find(".play").html(modeData.name);
                if (i === 0)
                    $row.find(".play").addClass("primary");
                else
                    $row.find(".play").addClass("");
                $row.addClass('mode-' + key);

                $row.find(".play").on("click", ()=>{

                    this.mode = key;

                    this.onPlayClick();

                }
                );

                $row.children().on("mouseenter", this.showModeDescription.bind(this, key));
                $row.children().on("mouseleave", this.hideModeDescription.bind(this));

                this.$gui.$mapsTable.append($row);

            }

        }

        $rowTemplate.remove();
        $separatorTemplate.remove();

    },

    showModeDescription(mode) {

        if (window.innerWidth < 1000)
            return;

        this.hideModeDescription();

        let html = app.data.html["mode_" + mode];

        if (!html)
            return;

        this.$modeDescription = $("<div>");
        this.$modeDescription.addClass("gui-side-tooltip");
        this.$modeDescription.html(html)
        this.$modeDescription.appendTo(document.body);
        this.$modeDescription.css("max-width", this.$gui.$mainWindow.offset().left - 64);

    },

    hideModeDescription() {

        if (!this.$modeDescription)
            return;

        this.$modeDescription.remove();

        this.$modeDescription = null;

    },

    updatePlayCount(count) {

        for (var key in count) {

            let $row = this.$gui.$mapsTable.find(".mode-" + key);

            $row.find(".playing").html(count[key]);

        }

    },

    updateQueueCount(count) {

        app.lobby.queue = count;

        for (var key in count) {

            let $row = this.$gui.$mapsTable.find(".mode-" + key);

            $row.find(".waiting").html(count[key]);

        }
    },

    onLogoutClick: function() {

        this.parent.send("logout", {});

    },

    onAutoLoginClick: function() {

        this.toggleAutoLogin();

    },

    onLoginClick: function() {

        this.promptLogin();

    },

    toggleAutoLogin: function(state) {

        if (state === undefined)
            state = !this.autologin;

        this.autologin = Boolean(state);

        if (state) {

            this.$gui.$autoLogin.toggleClass("checked", true);

            if (app.user.secret)
                localStorage.setItem("secret", app.user.secret);

        } else {

            this.$gui.$autoLogin.toggleClass("checked", false);

            localStorage.setItem("secret", "");

        }

        localStorage.setItem("autologin", Number(state));

    },

    updateDiscord: function() {

        var self = this;

        Utils.xget("https://discordapp.com/api/servers/195113767875379200/widget.json?" + Date.now(), {}, function(error, response) {

            if (error)
                return;

            var json = Utils.tryParseJSON(response);

            if (!json)
                return;

            self.$gui.$discordCounter.html(String(json.members.length));

        });

    },

    leave: function() {

        $("body").toggleClass("lobby", false);

        $("#IOG_CP").hide();
        $("#SuperGroup").hide();
        $("#mechario").hide();
        $("#gamezoo").hide();

        this.hideModeDescription();

        this.$gui.remove();

        clearInterval(this.discordTimer);

        if (window.arapi && app.ads)
            arapi.hide();

        this.chat.close();

        if (this.gamesList)
            this.gamesList.close();

        $.tooltip.hide();

    },

    step: function(dt) {

        arapi.x = this.$gui.$mainWindow.offset().left;
        arapi.y = this.$gui.$mainWindow.offset().top;
        arapi.width = this.$gui.innerWidth();
        arapi.height = this.$gui.$mainWindow.innerHeight();

        arapi.update();

        this.chat.step();

        /* Hack for node-webkit */

        // if (Utils.interval(app, "visibilitychange", 1.0)) this.visibilitychange();

    },

    updateMMR: function(data) {

        for (var key in COMMON.modes) {

            let modeData = COMMON.modes[key];

            let $row = this.$gui.$mapsTable.find(".mode-" + key);

            if (modeData.rankedGold) {

                let reward = app.getGoldReward(key);

                let $span = $("<span>");
                let $gold = $("<span>").addClass("gold");

                $gold.html(reward + "&nbsp;");

                $span.append($gold);
                $span.append("<img src='images/patreon_icon_old.png'>");

                $row.find(".special").empty().append($span);

            }

            if (false && modeData.scoreKey) {

                let rankIcons = COMMON.RANK_ICONS[modeData.scoreKey];

                var rank = CLIENT.Ranks.pointsToRank(app.user[modeData.scoreKey], app.lobby.maxMMR[modeData.scoreKey], rankIcons.length);

                $row.children(".rank").empty().prepend(UI.icon("images/rank_icons.png?2", rankIcons[rank]).addClass("icon"));

            }

        }

    },

    updateUserData: function(data) {

        Object.assign(app.user, data);

        app.user.org_helmet = app.user.helmet;
        app.user.org_weapon = app.user.weapon;
        app.user.org_shield = app.user.shield;
        app.user.org_cape = app.user.cape;
        app.user.org_voice = app.user.voice;

        /*
        if (app.iaps && Date.now() - app.user.shared_on_facebook > Utils.smhd(0, 0, 0, 14)) {

            this.$gui.$facebookShare.show();

        }
        */

        if (data.id) {

            localStorage.setItem("user_id", data.id);

        }

        if (data.quests) {

            this.questWidgets[0].update(data.quests[0]);
            this.questWidgets[1].update(data.quests[1]);

        }

        if (data.secret && this.autologin) {

            localStorage.setItem("secret", data.secret);

        }

        if (data.arena_mmr !== undefined) {

            this.updateMMR();

        }

        if (data.recruits !== undefined) {

            this.$gui.$recruits.html(data.recruits);

        }

        if (data.gold !== undefined) {

            this.$gui.$gold.html(data.gold)
            /*
                   UI.animateCount(this.$gui.$gold.parent(), {
                     from: data.gold,
                     to: data.gold + 100,
                     duration: 2.5,
                     counter: "[ui-id=gold]"
                   });
                   */

        }

        if (data.name) {

            this.$gui.$name.val(data.name);

        }

        if (this.armory)
            this.armory.updateUserData(data);

        app.emitter.trigger("update_user_data", data);

    },

    openSettings: function() {

        let settings = new UI.Settings();

        settings.$widget.appendTo("body");

    },

    openArmory: function() {

        // if (window.analytics) analytics('send', 'event', 'menu', 'armory_open');

        var self = this;

        this.armory = new CLIENT.Armory({

            onceClose: function() {

                self.$gui.show();
                self.armory = false;

            }

        });

        this.$gui.hide();

    },

    onFacebookShareClick: function() {

        this.parent.send("facebook_share");

        // if (window.analytics) analytics('send', 'event', 'menu', 'facebook_share');

        this.$gui.$facebookShare.hide();

    },

    onmessage: function(message, data) {

        switch (message) {

        case "newsletter_prompt":

            this.promptNewsletter();

            break;

        case "chat":

            this.chat.onmessage(data);

            break;

        case "leaderboards":

            this.showLeaderboards(data);

            break;

        case "status":

            if (data.counts) {

                this.updatePlayCount(data.counts);

            }

            if (data.mmcounts) {

                this.updateQueueCount(data.mmcounts);

            }

            if (data.maxMMR) {

                app.lobby.maxMMR = data.maxMMR;

                this.updateMMR();

            }

            break;

        case "notice":

            app.notifier.notify(data.text, data.type);

            break;

        case "text":

            app.console.say(data.text);

            break;

        case "error":

            this.unlock();

            if (this.loginPrompt) {
                this.loginPrompt.close();
                this.loginPrompt = null;
            }

            app.console.say("error: " + data.error);

            break;

        case "update_user":

            this.updateUserData(data);

            break;

        case "logout_successful":

            UI.showFirst(this.$gui.$loginPanel, this.$gui.$logoutPanel);

            localStorage.setItem("secret", "");
            localStorage.setItem("autologin", "0");

            app.user.guest = true;

            this.resetUser();

            break;

        case "login_successful":

            app.lobby.send("set_flag", localStorage.getItem("user-country"));

            app.sound.play("ui/login");

            if (this.loginPrompt) {

                this.loginPrompt.close();
                this.loginPrompt = null;

            }

            this.unlock();

            // analytics('send', 'event', 'menu', 'login_success_' + this.loginPlatform);

            UI.showFirst(this.$gui.$logoutPanel, this.$gui.$loginPanel);

            this.resetUser();

            app.user.guest = false;

            if (localStorage.getItem("verify")) {

                this.parent.send("verify", localStorage.getItem("verify"));

                localStorage.removeItem("verify");

            }

            if ($_HASH.join_tribe_public || $_HASH.join_tribe_private) {

                app.lobby.ask("join_tribe", {
                    public: $_HASH.join_tribe_public,
                    private: $_HASH.join_tribe_private
                }).then((response)=>{

                    if (typeof response === "object") {

                        app.notifier.notify(`Welcome to ${response.name} tribe`);

                    } else {

                        app.console.error(response);

                    }

                }
                );

            }

            if (!localStorage.getItem("recruiters_news")) {
            // this.onRecruitsCounterClick();

            // localStorage.setItem("recruiters_news", "true");

            }

            if (this.armory) {

                this.armory.close();

                this.openArmory();

            }

            break;

        case "twitter_token":

            window.open("https://api.twitter.com/oauth/authenticate?oauth_token=" + data.token);

            break;

        }

    },

    resize() {

        this.heroSprite.scale = window.innerHeight / 400;
        this.heroSprite.resize();

    },

    resetUser: function() {

        app.user.id = 0;
        app.user.guest = true;
        app.user.secret = false;
        app.user.patron = 0;
        app.user.patreon_id = 0;
        app.user.org_weapon = app.user.weapon = "axe";
        app.user.org_helmet = app.user.helmet = "no_helmet";
        app.user.org_shield = app.user.shield = "shield_wooden";
        app.user.org_cape = app.user.cape = "no_cape";
        app.user.org_voice = app.user.voice = "no_voice";
        app.user.items = ["no_helmet", "axe", "shield_wooden", "no_cape", "default_voice"];

        app.user.bones = 0;
        app.user.kills = 0;
        app.user.gold_cap = COMMON.GOLD_CAP;
        app.user.arena_mmr = 0;
        app.user.graveyard_score = 0;
        app.user.flags = 0;
        app.user.goals = 0;
        app.user.gold = 0;
        app.user.recruits = 0;

        if (this.questWidgets) {
            this.questWidgets[0].update(0);
            this.questWidgets[1].update(0);
        }

    },

    showLeaderboards: function(data) {

        var self = this;

        var $leaderboards = app.parseUI("html/leaderboards");

        $leaderboards.appendTo("body");

        $leaderboards.$rowTemplate.remove();

        var $table = $leaderboards.find("table tbody");

        let rankIcons = COMMON.RANK_ICONS[data.key];

        if (data.key === "bones")
            $leaderboards.$loose.hide();
        else
            $leaderboards.$loose.show();

        for (var i = 0; i < data.results.length; i++) {

            var entry = data.results[i];

            var $row = $leaderboards.$rowTemplate.clone();

            $row.children(".name").html(entry.name);
            $row.children(".score").html(entry.mmr);

            var rank = CLIENT.Ranks.pointsToRank(entry.mmr, app.lobby.maxMMR[data.key], rankIcons.length);

            $row.children(".score").prepend(UI.icon("images/rank_icons.png?2", rankIcons[rank]).addClass("icon"));

            $row.appendTo($table);

        }

        let close = ()=>{

            $leaderboards.remove();

        }
        ;

        UI.titleBar($leaderboards, "Leaderboards", {
            close
        });

        let first = true;

        UI.toggles($leaderboards.$mode, data.key, function(value) {

            if (first)
                return first = false;

            self.parent.send("leaderboards", {
                key: value
            });

            $leaderboards.remove();

        });

        // if (window.analytics) analytics('send', 'event', 'game', 'leaderboards');

    },

    selectMode: function(mode) {

        localStorage.setItem("mode", mode);

        this.mode = mode;

        for (var i = 0; i < 5; i++) {

            var $elements = this.$gui.find(".display-mode-" + i);

            if (i == mode)
                $elements.show();
            else
                $elements.hide();

        }

    },

    selectLocation: function(location) {

        if (location === "BR")
            location = "US";

        localStorage.setItem("location", location);

        this.location = location;

        this.parent.send("set_location", location);

    },

    onArmoryClick: function() {

        this.openArmory();

    },

    onShopClick() {

        this.openArmory();

    },

    onRecruitsCounterClick: function() {

        let widget = new UI.Recruits();

        widget.$element.appendTo(document.body);
        widget.$element.addClass("center-window");

        // if (window.analytics) analytics('send', 'event', 'experiments', 'recruits_click');

    },

    onGoldCounterClick: function() {

        this.openArmory();

    },

    onClaimNameChange: Utils.debounce(function() {

        this.parent.send("claim_name", {

            name: this.$gui.$name.val()

        });

    }, 1000),

    onCancelMatchmakingClick: function() {

        this.$gui.$waiting.hide();
        this.$gui.$mapsTable.removeClass("gui-disabled");

        this.parent.send("cancel_matchmaking");

    },

    onLeaderboardsClick: function() {

        this.parent.send("leaderboards", {
            key: "bones"
        });

    },

    onPlayInvitationLinkClick() {

        this.onPlayClick();

    },

    onMoreGamesClick() {

        app.iog.promo().then(function(result) {

            path = result.split("/");

            console.log(path)

            if (path[0] === "Close") {

                if (window.analytics)
                    analytics('send', 'event', 'more-games', "None");

            }

            if (path[0] === "Game") {

                if (window.analytics)
                    analytics('send', 'event', 'more-games', path[1]);

            }

        });

        if (window.analytics)
            analytics('send', 'event', 'more-games', "Show");

    },

    onWatchtabClick() {

        this.hideTabs();

        this.$gui.$tabWatch.show();

        var gamesList = new UI.GamesList();

        gamesList.$element.appendTo(this.$tabWatch.find(".list"));

        this.gamesList = gamesList;

    },

    hideTabs() {

        this.$gui.$tabPlay.hide();
        this.$gui.$tabHome.hide();
        this.$gui.$tabWatch.hide();

    },

    onPlaytabCloseClick() {

        this.hideTabs();

        this.$gui.$tabHome.show();

    },

    onWatchtabCloseClick() {

        this.hideTabs();

        this.$gui.$tabHome.show();

        if (this.gamesList) {

            this.gamesList.close();
            this.gamesList = null;

        }

    },

    onPlaytabClick() {

        this.hideTabs();

        this.$gui.$tabPlay.show();

    },

    onPlayClick: async function() {

        app.notifier.clear();

        await app.captcha();

        app.ad.interstitial(()=>{

            let wait = app.options.wait_in_lobby;

            var self = this;

            this.modeData = COMMON.modes[this.mode];

            if (!this.modeData) {

                this.mode = "fun";

                return this.onPlayClick();

            }

            if (!this.modeData.fun) {

                this.$gui.$waiting.show();
                // this.$gui.$mainWindow.hide();

                this.$gui.$mapsTable.addClass("gui-disabled");

                if (!wait) {

                    UI.popup("Waiting for players", "Please play survival mode while  match for you");

                    this.parent.tempGame = true;
                    this.chat.detach();

                    this.parent.send("play", {
                        mode: "fun",
                        location: this.location
                    });

                }

            }

            this.parent.send("play", {
                noob: this.isNoob(),
                game_link: $_HASH['game_link'],
                mode: this.mode,
                mmtag: this.$gui.$mmtag.val(),
                location: this.location
            });

            localStorage.setItem("mmtag", this.$gui.$mmtag.val());

        }
        );

    },

    isNoob: function() {

        var score = localStorage.getItem("highscore") | 0;

        if (score > 1000)
            return false;

        if (app.user.kills > 100)
            return false;

        return true;

    },

    visibilitychange: function(args) {

        if (args.hidden)
            return;

        var twitter_token = localStorage.getItem("twitter_token");

        if (twitter_token) {

            this.loginPlatform = "twitter";

            localStorage.setItem("twitter_token", "");

            this.parent.send("login_with_twitter", {
                recruiter: localStorage.getItem("recruiter"),
                token: twitter_token,
                verifier: localStorage.getItem("twitter_verifier")
            });

            this.lock();

        }

        var google_code = localStorage.getItem("google_code");

        if (google_code) {

            this.loginPlatform = "google";

            localStorage.setItem("google_code", "");

            this.parent.send("login_with_google", {
                recruiter: localStorage.getItem("recruiter"),
                code: google_code,
                url: this.google_redirect_uri
            });

            this.lock();

        }

        var facebook_code = localStorage.getItem("facebook_code");

        if (facebook_code) {

            this.loginPlatform = "facebook";

            localStorage.setItem("facebook_code", "");

            this.parent.send("login_with_facebook", {
                recruiter: localStorage.getItem("recruiter"),
                code: facebook_code,
                url: this.facebook_redirect_uri
            });

            this.lock();

        }

        var patreon_code = localStorage.getItem("patreon_code");

        if (patreon_code) {

            if (app.emitter.has("patreon_code")) {

                app.emitter.trigger("patreon_code", patreon_code);

            } else {

                this.loginPlatform = "patreon";

                this.parent.send("login_with_patreon", {
                    code: patreon_code,
                    url: this.patreon_redirect_uri
                });

                this.lock();

            }

            localStorage.setItem("patreon_code", "");

        }

        app.emitter.trigger("visibilitychange", args);

    },

    keydown: function(e) {
    },

    localstorage(e) {
    },

    ondisconnect: function() {

        this.$gui.html("SORRY. Could not connect to the server. Maybe I am updating something. Try connecting again within a minute. Otherwise there is something wrong with your connection. Maybe you are behind firewall.");

        setTimeout(function() {

            app.setState(app.lobby);

        }, 2000);

    }

};

/* file: script/Lobby.Dead.js */

CLIENT.Lobby.Dead = {

    $unlockables: [],
    $softUnlockables: [],

    enter: function() {

        this.$gui = app.gui.add({
            width: "100%",
            height: "100%",
            tooltipHandler: this.tooltipHandler.bind(this)
        });

        var panel = this.$gui.add(".welcome.panel", {
            layout: "vertical",
            x: "50%",
            y: "50%",
            anchor: [0.5, 0.5],
            padding: 14
        });

        this.$output = panel.add({
            scale: 0,
            text: "DEBUG",
            background: "#fafafa",
            color: "#000",
            padding: 4,
            width: "100%",
            marginBottom: 4,
            image: {
                region: [144, 98, 37, 10],
                src: "images/gui/png"
            }
        });

        panel.add({
            image: "images/logo.png",
            marginBottom: 16,
            alignX: "center",
            anchor: [0.5, 0.0]
        });

        panel.add({
            text: "Sorry but the server is dead at the moment. \n Also it can mean that the game is blocked by firewall or adblock \n This happens often at school or work."
        });

    },

    tooltipHandler: function(key, element) {

        if (element.tags.has("soft-locked")) {
            return "You have to be logged in to use that option.";
        }

        switch (key) {

        case "patreon":

            if (this.patreonState === "no-patreon") {

                return "Patreon is a platform that helps funding independent developers on a monthly basis. \n No worries - you don't have to pay anything to login.";

            } else if (this.patreonState == "zero") {

                return "Do you like the game? Would you like to see it growing? \n Support me for whatever you feel like and I in return \n will unlock all the heroes for you.";

            } else {

                return "Thank you for truly supporting the game";

            }

            break;

        }

    },

    leave: function() {

        this.$gui.remove();

    }

};

/* file: script/Armory.js */

CLIENT.Armory = function(args) {

    Object.assign(this, args);

    this.objectsToKill = [];

    this.items = {};

    this.opened = true;

    this.$gui = app.parseUI("html/armory");

    UI.titleBar(this.$gui, "Armory", this);

    this.$gui.appendTo(this.container || "body");

    this.$gui.$helmets.empty();
    this.$gui.$weapons.empty();
    this.$gui.$shields.empty();
    this.$gui.$capes.empty();

    this.fillItems("helmets", this.helmets);
    this.fillItems("weapons", this.weapons);
    this.fillItems("shields", this.shields);
    this.fillItems("capes", this.capes);
    this.fillItems("voice", this.voice);

    this.updateUserData(app.user);

    this.heroSprite = new UI.Hero({
        scale: window.innerHeight / 400,
        parent: this.$gui.$heroSprite,
        observe: app.user
    });

    this.objectsToKill.push(this.heroSprite);

    this.$gui.$shop.on("click", this.preventNotLoggedIn);

    // this.enableCoinsShop();

    this.$gui.$miniShop.hide();
    // this.$gui.$miniShop.show();

    this.$gui.$tabContent.children().hide();

    UI.toggles(this.$gui.$tabs, "weapons", this.selectTab.bind(this));

    UI.fitWindow(this.$gui);

    if (!app.iaps)
        this.$gui.find(".iap").hide();

}
;

CLIENT.Armory.prototype = {

    helmets: ["no_helmet", "hood", "viking_helmet", "elf_ears", "demon_horns", "fox_head", "legion_helmet", "wizard_hat", "fedora", "crusader_helmet", "skull", "santa_hat"],

    weapons: ["axe", "hammer", "sword", "bow", "ice_staff", "claws", "spear"],

    shields: ["no_shield", "shield_wooden", "shield_usa", "shield_heavy"],

    capes: ["no_cape", "barbarian_cape", "noble_cape", "white_cape", "demon_wings", "angel_wings"],

    voice: ["default_voice", "angrybrai_voice", "jacqueline_voice"],

    selectTab(key) {

        this.$gui.$tabContent.children().hide();
        this.$gui["$" + key].show();

    },

    fillItems: function(category, items) {

        var $container = this.$gui["$" + category];

        for (var i = 0; i < items.length; i++) {

            var key = items[i];
            var def = COMMON.armory[key];

            var $item = this.$gui.$item.clone();

            $item.appendTo($container);

            if (def.promo)
                $item.addClass("promo");
            if (def.promo)
                $item.prepend($("<span>").addClass("gui-suplabel").html("NEW SKILL"));

            if (def.video) {

                $item.videotip(def.video);

            }

            $item.attr("item", key);
            $item.find(".price").html(def.price);

            if (category !== "voice") {

                if (key !== "no_helmet" && key !== "no_cape" && key !== "no_shield") {

                    var sprite = new UI.Sprite({
                        palette: 0,
                        scale: 1.5,
                        parent: $item.find(".sprite"),
                        sprite: "equipment/" + key + "_turntable"
                    });

                    sprite.paused = true;

                    this.objectsToKill.push(sprite);

                    $item.data("sprite", sprite);

                }

            } else {

                $item.css("background", `url(images/shop/${key}.png)`);
                $item.css("background-size", "cover")
                $item.css("background-position", "center center")

            }

            $item.on("click", this.onItemClick.bind(this));
            $item.find(".buy").on("click", this.onBuyClick.bind(this));
            $item.on("mouseenter", this.onItemMouseEnter.bind(this));
            $item.on("mouseleave", this.onItemMouseLeave.bind(this));

            this.items[key] = $item;

        }

    },

    /*
      onEquipClick: function(event) {

        var $element = $(event.target);

        var $parent = $element.closest(".item");

        var key = $parent.attr("item");

        CLIENT.Lobby.send("equip", {
          item: key
        });

      },
    */

    preventNotLoggedIn: function(event) {

        if (app.user.guest) {

            app.console.error("error/not_logged_in");

            event.preventDefault();

        }

    },

    onItemMouseEnter: function(event) {

        var $element = $(event.currentTarget);

        var key = $element.attr("item");

        var item = COMMON.armory[key];

        app.user[item.type] = key;

        app.sound.play("shop/cycle").rrate(0.1);

        if (item.type === "voice") {

            let ack = Utils.random(["attack", "defend", "good", "follow", "help", "vrngh"])

            app.sound.play("acks/" + key + "/" + ack).rate(item.rate + item.rateRange * Math.random());

        }

        let sprite = $element.data("sprite");

        if (sprite)
            sprite.paused = false;

    },

    onItemMouseLeave: function(event) {

        var $element = $(event.currentTarget);

        var key = $element.attr("item");

        var item = COMMON.armory[key];

        app.user[item.type] = app.user["org_" + item.type];

        let sprite = $element.data("sprite");

        if (sprite)
            sprite.paused = true;

    },

    onItemClick: function(event) {

        if (app.user.guest)
            return this.promptLogin();

        var $element = $(event.currentTarget);

        var key = $element.attr("item");

        if (window.analytics && !$element.data("item_clicked")) {

            $element.data("item_clicked", true);

            // analytics('send', 'event', 'armory', 'click_item_' + key);

        }

        if (app.user.guest)
            return app.console.error("error/not_logged_in");

        if ($element.data("locked"))
            return false;

        CLIENT.Lobby.send("equip", {
            item: key
        });

        app.sound.play("shop/equip");

    },

    onBuyClick: function(event) {

        if (app.user.guest)
            return this.promptLogin();

        var $element = $(event.currentTarget);

        var $parent = $element.closest(".item");

        var key = $parent.attr("item");

        if (window.analytics && !$element.data("item_buy_clicked")) {
            $element.data("item_buy_clicked", true);
            // analytics('send', 'event', 'armory', 'click_item_buy_' + key);
        }

        // if (app.user.guest) return app.console.error("You have to be logged in to use armory. <br> Go back to menu and login.");

        var item = COMMON.armory[key];

        if (app.user.gold < item.price)
            return app.console.error("You don't have enough gold");

        CLIENT.Lobby.send("buy", {
            item: key
        });

        app.sound.play("purchase").rrate(0.25);

        if (window.fbq)
            fbq('trackCustom', 'ArmoryPurchase');

        // if (window.analytics) analytics('send', 'event', 'armory', 'buy', key);

    },

    updateUserData: function(data) {

        if (data.gold !== undefined) {

            this.$gui.$gold.html(data.gold);

        }

        if (data.weapon !== undefined) {

            this.selectItem("weapons", data.weapon);

        }

        if (data.shield !== undefined) {

            this.selectItem("shields", data.shield);

        }

        if (data.helmet !== undefined) {

            this.selectItem("helmets", data.helmet);

        }

        if (data.cape !== undefined) {

            this.selectItem("capes", data.cape);

        }

        if (data.voice !== undefined) {

            this.selectItem("voice", data.voice);

        }

        if (data.items) {

            this.updateItems(data.items);

        }

    },

    updateItems: function(userItems) {

        for (var key in this.items) {

            var $item = this.items[key];

            var item = $item.attr("item");

            if (userItems.indexOf(item) === -1) {

                this.lockItem(item);

            } else {

                this.unlockItem(item);

            }

        }

    },

    lockItem: function(item) {

        var $item = this.items[item];

        $item.data("locked", true);
        $item.find(".equip").hide();
        $item.find(".buy").show();
        $item.find(".price").show();

    },

    unlockItem: function(item) {

        var $item = this.items[item];

        $item.data("locked", false);
        $item.find(".equip").hide();
        $item.find(".buy").hide();
        $item.find(".price-box").hide();

    },

    selectItem: function(category, item) {

        var def = COMMON.armory[item];

        if (!def)
            return;

        var $container = this.$gui["$" + category];

        $container.children().removeClass("selected");

        $container.children("[item=" + item + "]").addClass("selected");

    },

    close: function() {

        this.opened = false;

        for (let o of this.objectsToKill) {
            o.kill();
        }

        this.$gui.remove();

        if (this.onceClose) {

            this.onceClose();
            this.onceClose = false;

        }

    },

    promptLogin() {

        app.lobby.state.promptLogin("You have to be logged in to use that option.");

    },

    enableCoinsShop: function() {

        var self = this;

        var user_id = app.user.id;

        var desc = JSON.stringify({

            description: user_id

        });

        var meta = JSON.stringify({

            show_eu_vat_number: false

        });

        var $buttons = $("[taxamo-product]").each(function() {

            let $this = $(this);

            this.setAttribute("taxamo-checkout-transaction", desc);
            this.setAttribute("taxamo-checkout-meta", meta);

            $(this).on("click", function() {

                if (app.user.guest)
                    return self.promptLogin();

                // if (window.analytics) analytics('send', 'event', 'shop', 'click_buy_product_' + this.getAttribute("taxamo-product"));

            });

            $(this).on("mouseenter", function() {

                $this._sound = app.sound.play("shop/treasure").volume(0.75).fadeIn(0.5).nrate(0.2);

            });

            $(this).on("mouseleave", function() {

                $this._sound.fadeOut(0.25);

            });

        });

        if (app.user.guest || !user_id) {

            var $buttons = $("[taxamo-product]").on("click", function() {

                app.console.error("error/not_logged_in");

                // if (window.analytics) analytics('send', 'event', 'shop', 'click_buy_product_' + this.getAttribute("taxamo-product"));

            });

            return;

        } else {

            // Taxamo.initialize('public_test_giKCiAlTeQ0wtYBByJdb-F7EEXSc2w5nqZ-Gk2i_aL4');
            Taxamo.initialize('public_kzrdJ8SMgkWuk4oPzrjY8LtDn8dTYBfSYCDQlaqalNc');
            Taxamo.detectButtons();

        }

    }

};

/* file: script/Respawn.js */

CLIENT.Respawn = function(args) {

    Object.assign(this, args);

    this.countersWorking = 0;
    this.items = {};

    this.opened = true;

    this.$gui = app.parseUI("html/respawn");

    this.$gui.appendTo("body");

    this.$gui.$exit.on("click", this.onExitClick.bind(this));
    this.$gui.$playAgain.on("click", this.onExitClick.bind(this));
    this.$gui.$help.on("click", this.onHelpClick.bind(this));
    this.$gui.$settings.on("click", this.onSettingsClick.bind(this));
    this.$gui.$moreGames.on("click", this.onMoreGamesClick.bind(this));
    this.$gui.$voteonio.on("mousedown", this.onVoteonioClick.bind(this));
    // this.$gui.$inviteLink.on("click", this.onInviteLink.bind(this));
    // this.$gui.$inviteFacebook.on("click", this.onInviteFacebook.bind(this));

    this.$gui.$exitPanel.hide();

    if (app.game.modeData.fun) {

        this.$gui.$gameLinks.show();

        var link = app.game.getGameLink();

        let url = "https://" + location.hostname + "/game_link/?ref=url&game_link=" + link;

        this.$gui.$inviteURL.val(url);

    } else {

        this.$gui.$gameLinks.hide();

    }

    let goldCounter = this.addCounter({
        max: app.user.gold,
        value: app.game.goldBefore,
        title: "GOLD",
        sprite: "pickups/gold_coin"
    });

    goldCounter.val(app.user.gold);

    if (app.game.player && app.game.modeData.countBones) {

        let killCounter = this.addCounter({
            max: app.lobby.maxMMR.bones,
            icons: COMMON.KILL_RANKS,
            value: app.user.bones - app.user.bonesEarned,
            title: "BONES",
            color: "#bbe"

        });

        killCounter.val(app.user.bones);

        killCounter.$widget.appendTo(this.$gui.$counters);

    }

    /* Respawn buttons */

    if (!app.game.modeData.allowTeamChange) {

        this.$gui.$respawn0.hide();
        this.$gui.$respawn1.hide();
        this.$gui.$respawn2.hide();

    } else {

        if (app.game.modeData.allowTeamChange < 2)
            this.$gui.$respawn2.hide();

    }

    this.$gui.$respawn.on("click", this.onRespawnClick.bind(this, -1));
    this.$gui.$respawn0.on("click", this.onRespawnClick.bind(this, 0));
    this.$gui.$respawn1.on("click", this.onRespawnClick.bind(this, 1));
    this.$gui.$respawn2.on("click", this.onRespawnClick.bind(this, 2));

    this.clipboard = new Clipboard(this.$gui.$copyURL[0],{

        target: ()=>{

            return this.$gui.$inviteURL[0]

        }

    });

    this.clipboard.on("success", ()=>{

        let tooltip = new Opentip(this.$gui.$inviteURL,"Link coppied to clipboard");

        tooltip.show();

        setTimeout(function() {

            tooltip.deactivate();

        }, 2000)

    }
    );

    if (!app.game.modeData.allowRespawn)
        this.$gui.$respawnPanel.hide();
    if (!app.game.modeData.allowGameLinks)
        this.$gui.$gameLinks.hide();

    if (!app.user.guest)
        this.$gui.$guestWarning.hide();

    /* Surveys */

    var surveys = JSON.parse(localStorage.getItem("surveys") || "{}");

    /*

  this.survey("new_mode", "What new mode would you like the most?", {
    "ctf": "Capture the flag",
    "survival": "Survival vs monsters",
    "1vs1": "1 VS 1 Arena",
    "none": "Just improve this mode!"
  });

  this.survey("paypal", "Do you have paypal account?", {
    "idc": "I don't read the anwsers",
    "no": "No",
    "yes": "Yes"
  });

  this.survey("next_step_1", "What should I add next?", {
    "idc": "I don't read the anwsers",
    "monsters": "More monsters",
    "traps": "More traps on map (spikes, guillotine)",
    "skills": "More skills / special moves",
    "items": "More items to pick up",
    "guilds": "Guilds",
    "graphics": "Better graphics",
    "else": "None of these"
  });

  if (app.user.guest) {

    this.survey("why_guest", "Why are you not logged in?", {
      "dont_read": "I don't read questions. I just click first thing.",
      "dont_know_how": "I don't know how to",
      "dont_care_money": "I don't care about gold coins and skins",
      "dont_like_methods": "I don't like login with facebook",
      "will_login_later": "I will login later"
    });

  }

  if (surveys['why_guest'] === "dont_like_methods") {

    this.survey("what_login_method", "So what login methods would you like?", {
      "else": "None of these...",
      "google": "Google",
      "email": "Email / Password",
      "twitch": "Twitch"
    });

  }

*/

    if (app.game.mode === "soccer" && !app.user.guest) {

        this.survey("football_players", "What should be the size of football team?", {
            "dont_care": "I don't care. ",
            "5vs5": "5 vs 5",
            "4vs4": "4 vs 4",
            "3vs3": "3 vs 3",
        });

    }

    app.user.killsEarned = 0;
    app.user.bonesEarned = 0;

    this.$gui.enhance();

    app.emitter.trigger("show_respawn_window");

    if (!app.ads) {

        this.$gui.$left.hide();

    }

    if (ENV.siteLocked)
        $(".outgoing-link").hide();

    if (app.game.modeData.respawnWindow === "playAgain") {
        this.$gui.$exit.hide();

    } else {
        this.$gui.$playAgain.hide();

    }

    if (app.game.modeController && app.game.modeController.onRespawnWindow)
        app.game.modeController.onRespawnWindow(this);

    if (ENV.siteLocked)
        $(".outgoing-link").hide();

    if (window.innerWidth >= 1170) {

        this.scoreboard = new CLIENT.Scoreboard(app.game);
        this.scoreboard.$container.appendTo(this.$gui);
        this.scoreboard.$container.addClass("embedded");
        this.scoreboard.step();
        this.scoreboard.$right.hide();

    }

}
;

CLIENT.Respawn.prototype = {

    onCounterFinished() {

        this.countersWorking--;

        if (this.countersWorking <= 0) {
        }

    },

    surveyShown: false,

    survey: function(key, title, options) {

        if (!app.game.modeData.fun)
            return;

        if (this.surveyShown)
            return;

        var surveys = localStorage.getItem("surveys") || "{}";

        surveys = JSON.parse(surveys);

        if (surveys[key])
            return;

        this.surveyShown = true;

        var $survey = $("<div>").addClass("gui-rows spacing-sm");

        $("<div>").addClass("gui-form-divide").html("Survey").appendTo($survey);

        $survey.append("<p class=shout>" + title + "</p>");

        for (var option_key in options) {

            var $option = $("<button>").addClass("gui-button primary size-md").html(options[option_key]);

            $option.on("click", this.onSurveyOptionClick);
            $option.data("survey", {
                key: key,
                option: option_key,
                respawnWindow: this
            });

            $survey.append($option);

        }

        this.$gui.append($survey);

    },

    onVoteonioClick: function() {

        if (window.analytics)
            analytics('send', 'event', 'spritestackiorespawn', 'click');

    },

    onSurveyOptionClick: function() {

        var data = $(this).data("survey");

        data.respawnWindow.surveyShown = false;

        if (window.analytics)
            analytics('send', 'event', 'survey', data.key + "/" + data.option);

        var surveys = localStorage.getItem("surveys") || "{}";

        surveys = JSON.parse(surveys);

        surveys[data.key] = data.option;

        localStorage.setItem("surveys", JSON.stringify(surveys));

        $(this).parent().html("Thank you! Your vote will help making the game better.")

    },

    open: function() {
    },

    close: function() {

        this.$gui.remove();

    },

    onMoreGamesClick() {

        app.iog.promo().then(function(result) {

            path = result.split("/");

            if (path[0] === "Close") {

                if (window.analytics)
                    analytics('send', 'event', 'more-games', "None");

            }

            if (path[0] === "Game") {

                if (window.analytics)
                    analytics('send', 'event', 'more-games', path[1]);

            }

        });

        if (window.analytics)
            analytics('send', 'event', 'more-games', "Show");

    },

    onSettingsClick: function() {

        let settings = new UI.Settings();

        settings.$widget.appendTo("body");

        settings.events.on("close", function() {

            app.game.initControls();

        })

    },

    onRespawnClick: function(team) {

        app.ad.interstitial(()=>{

            let packet = {};

            if (team >= 0)
                packet.team = team;

            app.game.send("respawn", packet);

            if (window.analytics) {

                analytics('send', 'event', 'game', "respawn_click");

            }

            if (window.fbq)
                fbq('trackCustom', 'Respawn');

        }
        );

    },

    onExitClick: function() {

        if (window.analytics)
            analytics('send', 'event', 'game', "respawn_exit_click");

        // app.setState(app.lobby);

        if (ENV.moreAds) {

            app.ad.interstitial(()=>{

                window.location.reload();

            }
            );

        } else {

            window.location.reload();

        }

    },

    onHelpClick: function() {

        app.showHelp();

        if (window.analytics)
            analytics('send', 'event', 'game', 'help');

        return

        var $help = UI.parse(UI.bb(app.data.html.help));

        $help.appendTo("body");

        $help.on("click", function() {

            $help.hide();

        });

    },

    setTimeLeft: function(time) {

        if (this.respawnTime === time)
            return;

        this.respawnTime = time;

        this.$gui.$respawnTimer.html("You can respawn in " + time.toFixed(1));

        if (time) {

            this.$gui.$respawnTimer.show();
            this.$gui.$respawn.hide();

        } else {

            this.$gui.$respawnTimer.hide();
            this.$gui.$respawn.show();

        }

    },

    updateGoldCap: function() {

        if (app.adblock) {

            this.$gui.$goldCollected.html("Disable adblock if you want to collect gold that you can use to buy skins.").addClass("warning");

        } else if (app.user.guest) {

            this.$gui.$goldCollected.html("You are not logged in. Your stats will not be saved. Go back to menu and login using Facebook, Patreon or Twitter").addClass("warning");

        } else {
        }

    },

    onInviteLink: function() {

        var link = app.game.getGameLink();

        prompt("Copy the link and give it to your friend.", "http://" + location.hostname + "/game_link/?ref=url&game_link=" + link)

        if (window.analytics)
            analytics('send', 'event', 'game', 'game_link_click_url');

    },

    onInviteFacebook: function() {

        var link = app.game.getGameLink();

        window.open("https://www.facebook.com/sharer/sharer.php?u=http%3A//" + location.hostname + "/game_link/?ref=facebook%26game_link=" + link);

        if (window.analytics)
            analytics('send', 'event', 'game', 'game_link_click_facebook');

    },

    addCounter: function(data) {

        let counter = new UI.RankMeter(data);

        counter.$widget.appendTo(this.$gui.$counters);

        if (this.prevCounter)
            counter.await = this.prevCounter;

        this.prevCounter = counter;
        this.countersWorking++;
        counter.events.on("finish", this.onCounterFinished.bind(this));

        return counter;

    }

};

/* file: script/Menu.js */

CLIENT.Menu = {

    leave: function() {

        this.stage.parent.removeChild(this.stage);

        app.tween(this.$pane).to({

            x: -100
        }, 2.0)

        // this.$pane.tags.add("hide");

        // this.$pane.remove();

    },

    create: function() {

        this.stage = new PIXI.Container();

        this.paralax = new PIXI.extras.TilingSprite(app.textures.stars,app.renderer.width,app.renderer.height);
        this.paralax.alpha = 0.5;

        this.stage.addChild(this.paralax);

        this.paralaxB = new PIXI.extras.TilingSprite(app.textures.stars,app.renderer.width,app.renderer.height);
        this.paralaxB.alpha = 0.5;

        this.stage.addChild(this.paralaxB);

        app.stage.addChild(this.stage);

        this.$pane = app.gui.add({
            tags: ["mainmenu"],
            layout: "vertical",
            stretchWidth: true,
            stretchHeight: true,
            x: "50%",
            y: "50%",
            anchor: [0.5, 0.5]
        });

        this.$logo = this.$pane.add({
            // 121, 0, 141, 59 < logo
            width: 141,
            height: 59,
            anchor: [0.5, 0.0],
            marginBottom: 16,
            x: "50%",
            image: {
                src: "gui",
                region: [121, 0, 141, 59]
            }
        });

        this.$menu = this.$pane.add({
            tags: ["menu"],
            borderImage: "$border-menu",
            stretchHeight: true,
            stretchWidth: true,
            layout: "vertical",
            x: "50%",
            padding: 3,
            anchor: [0.5, 0.0]
        });

        this.$play = this.$menu.add({
            tags: ["button", "border-teal"],
            text: "Play"
        });

        this.$play.on("click", function() {
            app.setState(app.game);
        })

        this.$settings = this.$menu.add({
            tags: ["button", "border-yellow"],
            text: "Settings"
        });

        this.$more = this.$menu.add({
            tags: ["button", "border-green"],
            text: "More Games"
        });

    },

    step: function(dt) {

        var x = app.lifetime * 6;

        this.paralax.tilePosition.x = x;
        this.paralaxB.tilePosition.x = x * 0.6;
        this.paralaxB.tilePosition.y = 64;

    }

};

/* file: script/modules/TrainingWindow.js */

CLIENT.TrainingWindow = function(args) {

    Object.assign(this, args);

    this.items = {};

    this.opened = true;

    this.$gui = app.parseUI("html/training");

    UI.titleBar(this.$gui, "Training", this);

    this.$gui.appendTo("body");

    this.$gui.$exit.on("click", this.onExitClick.bind(this));
    this.$gui.$help.on("click", this.onHelpClick.bind(this));
    this.$gui.$inviteLink.on("click", this.onInviteLink.bind(this));

}
;

CLIENT.TrainingWindow.prototype = {

    open: function() {
    },

    close: function() {

        this.$gui.remove();

    },

    onExitClick: function() {

        if (app.game.mode === 6)
            analytics('turbo.send', 'event', 'tutorial', "exit_click");

        app.reload();

    },

    onHelpClick: function() {

        var $help = app.parseUI("html/help");
        $help.appendTo("body");

        $help.on("click", function() {

            $help.hide();

        });

        if (window.analytics)
            analytics('send', 'event', 'game', 'help');

    },

    onInviteLink: function() {

        var link = app.game.getGameLink();

        prompt("Copy the link and give it to your friend.", "http://" + location.hostname + "/game_link/?ref=url&game_link=" + link)

        if (window.analytics)
            analytics('send', 'event', 'game', 'game_link_click_url');

    },

    onInviteFacebook: function() {

        var link = app.game.getGameLink();

        window.open("https://www.facebook.com/sharer/sharer.php?u=http%3A//" + location.hostname + "/game_link/?ref=facebook%26game_link=" + link);

        if (window.analytics)
            analytics('send', 'event', 'game', 'game_link_click_facebook');

    }

};

/* file: script/modules/Input.js */

CLIENT.Input = function(args) {

    Object.assign(this, args);

    this.map = {};
    this.timestamps = {};

}

CLIENT.Input.prototype = {

    pull(array, key) {

        while (true) {

            var index = array.indexOf(key);

            if (index < 0)
                break;

            array.splice(index, 1);

        }

    },

    unsetk(key) {

        this.map[key] = [];

    },

    unsetc(command) {

        for (var key in this.map) {

            this.pull(this.map[key], command);

        }

    },

    unset(command, key) {

        this.pull(this.map[key], command);

    },

    getKeys(command) {

        var result = [];

        for (var key in this.map) {

            if (this.map[key].indexOf(command) > -1)
                result.push(key);

        }

        return result;

    },

    set(command, key) {

        if (!this.map[key])
            this.map[key] = [];

        this.unset(command, key);

        this.map[key].push(command);

    },

    press(key) {

        var commands = this.map[key];

        if (!commands)
            return;

        for (var i = 0; i < commands.length; i++) {

            let command = commands[i];

            var double = app.lifetime - (this.timestamps[command] || 0) < 0.25;

            this.timestamps[command] = double ? 0 : app.lifetime;

            this.onPress({
                double: double,
                command: command
            });

        }

    },

    release(key) {

        var commands = this.map[key];

        if (!commands)
            return;

        for (var i = 0; i < commands.length; i++) {

            let command = commands[i];

            this.onRelease({
                duration: app.lifetime - this.timestamps[command],
                command: commands[i]
            });

        }

    }

};

/* file: script/modules/Ranks.js */

CLIENT.Ranks = {

    curve: "inQuad",

    tables: {},
    /*
      pointsToRank(points, max, ranks) {

        if (max < 100) max = 100;

        if (points >= max) return ranks - 1;

        return points / (max / ranks) | 0;


      },

      rankToPoints(rank, max, ranks) {

        if (max < 100) max = 100;

        if (rank >= ranks) rank = ranks - 1;

        return rank * (max / ranks) | 0;

      },

      */

    pointsToRank(points, max, ranks) {

        if (max < 100)
            max = 100;

        if (points >= max)
            return ranks - 1;

        let table = this.getTable(max, ranks);

        for (var i = table.length - 1; i >= 0; i--) {

            if (points >= table[i])
                return i;

        }

    },

    getTable(max, ranks) {

        let key = max + "/" + ranks;

        if (!this.tables[key]) {

            let step = max / ranks;
            let table = [];

            for (var i = 0; i < ranks; i++) {

                let mod = app.ease(step * i / max, this.curve);
                let points = Math.floor(mod * max);

                if (i > 0)
                    points += 1;

                table.push(points);

            }

            this.tables[key] = table;

        }

        return this.tables[key];

    },

    rankToPoints(rank, max, ranks) {

        if (rank >= ranks)
            return max;

        var table = this.getTable(max, ranks);

        return table[rank];

    }

};

/* file: script/modules/Entities.js */

CLIENT.Entities = function(game) {

    this.game = game;

    this.children = [];
    this.groups = {};
    this.index = 0;
    this.dirtyGroups = {};

    this.sidMap = new Map();

}
;

CLIENT.Entities.prototype = {

    sid: function(sid) {

        return this.sidMap.get(sid);

    },

    all: function(filter, group) {

        var entities = group ? this.groups[group] : this.children;

        return Utils.filter(entities, filter);

    },

    one: function(filter, group) {

        var entities = group ? this.groups[group] : this.children;

        return Utils.find(entities, filter);

    },

    create: function(constructorName, args) {

        var constructor = CLIENT[constructorName];

        if (!constructor.prototype.constructorName)
            constructor.prototype.constructorName = constructorName;

        args.collection = this;
        args.game = this.game;

        if (constructor.prototype.reset) {

            var entity = app.pool(constructor, args);

            entity._fromPool = true;

        } else {

            var entity = new constructor(args);

            entity._fromPool = false;

        }

        entity.inView = false;

        if (entity.shared) {

            entity.sid = entity.shared.sid;
            this.sidMap.set(entity.shared.sid, entity);

        }

        return entity;

    },

    add: function(constructorName) {

        var args = {};

        args.box = [0, 0, 0, 0];
        args.center = {
            x: 0,
            y: 0
        };

        args._remove = false;

        for (var i = 1; i < arguments.length; i++) {

            Object.assign(args, arguments[i]);

        }

        /* create new object */

        args.index = ++this.index;

        // var entity = this.create(constructorName, args)

        if (typeof constructorName === "object") {

            var entity = constructorName;

            Object.assign(entity, args)

        } else {

            var entity = this.create(constructorName, args)

        }

        this.children.push(entity);

        this.dirty = true;

        this.last = entity;

        if (entity.groups) {

            for (var i = 0; i < entity.groups.length; i++)
                this.addToGroup(entity, entity.groups[i]);

        }

        this.updateBox(entity);

        return entity;

    },

    createGroup: function(group) {

        if (this.groups[group])
            return;

        this.groups[group] = [];
        this.groups[group].entitiesToRemove = [];

    },

    addToGroup: function(entity, group) {

        this.createGroup(group);

        this.groups[group].push(entity);

    },

    removeFromGroup: function(entity, group) {

        this.dirtyGroups[group] = true;
        this.groups[group].entitiesToRemove.push(entity);

        this.dirty = true;

    },

    cleanup: function() {

        this.dirty = false;

        for (var i = 0, len = this.children.length; i < len; i++) {

            var entity = this.children[i];

            if (entity._remove) {

                if (entity.groups) {

                    for (var j = 0; j < entity.groups.length; j++) {

                        this.dirtyGroups[entity.groups[j]] = true;

                    }

                }

                if (entity.leaveview)
                    entity.leaveview();

                if (entity._destruct)
                    entity._destruct();

                if (entity.sid) {

                    this.sidMap.delete(entity.sid);

                }

                this.children.splice(i--, 1);

                len--;

            }

        }

        /* cleanup groups */

        for (var key in this.dirtyGroups) {

            var group = this.groups[key];

            for (var i = 0, len = group.length; i < len; i++) {

                var entity = group[i];

                if (entity._remove || group.entitiesToRemove.indexOf(entity) > -1) {

                    group.splice(i--, 1);
                    len--;

                }

            }

            group.entitiesToRemove = [];

        }

        this.dirtyGroups = {};

    },

    sortMethod: function(a, b) {

        if (a.zIndex !== b.zIndex) {

            return (a.zIndex | 0) - (b.zIndex | 0);

        }

        var ay = a.sortY || (a.box[1] + a.box[3]);
        //+ a.z;
        var by = b.sortY || (b.box[1] + b.box[3]);
        //+ b.z;

        if (ay !== by) {

            return ay - by;

        }

        if (a.x !== b.x) {

            return a.x - b.x;

        }

        return a.index - b.index;

    },

    sort: function() {

        this.children.sort(this.sortMethod);

    },

    remove: function(entity) {

        entity._remove = true;

        this.dirty = true;

    },

    getGround: function(entity) {

        for (var i = entity.tz; i >= 0; i--) {

            let tile = entity.column[i];

            if (!tile)
                continue;

            if (tile.data.solid)
                return (i + 1) * COMMON.TILE_SIZE;

        }

        return 0;

    },

    updateEntity: function(entity, dt) {

        entity.prevX = entity.x;
        entity.prevY = entity.y;

        if (entity.lifespan && !(entity.delay > 0)) {

            entity.lifespan -= dt;

            if (entity.lifespan <= 0) {

                entity.lifespan = 0;
                this.remove(entity);

            }

        }

    },

    updateBox: function(entity) {

        if (entity.shape === CLIENT.RECT) {

            entity.box[0] = entity.x - entity.width * (entity.alignX || 0);
            entity.box[1] = entity.y - entity.height * (entity.alignY || 0);
            entity.box[2] = entity.width;
            entity.box[3] = entity.height;

        } else {

            entity.box[0] = entity.x - entity.radius;
            entity.box[1] = entity.y - entity.radius;
            entity.box[2] = entity.radius * 2;
            entity.box[3] = entity.radius * 2;

        }

        entity.center.x = entity.box[0] + entity.box[2] / 2;
        entity.center.y = entity.box[1] + entity.box[3] / 2;

        // entity.box[1] -= entity.z | 0;

    },

    step: function(dt) {

        this.game.doodlesCount = 0;

        var camera = app.game.camera;

        for (var i = 0; i < this.children.length; i++) {

            var entity = this.children[i];

            var prevInView = entity.inView;

            // if (entity._remove) continue;

            if (entity.viewRadius) {

                entity.inView = Utils.rectInRect(entity.center.x - entity.viewRadius, entity.center.y - entity.viewRadius, entity.viewRadius * 2, entity.viewRadius * 2, camera.box[0], camera.box[1], camera.box[2], camera.box[3]);

            } else if (entity.box) {

                entity.inView = Utils.rectInRect(entity.box[0], entity.box[1], entity.box[2], entity.box[3], camera.box[0], camera.box[1], camera.box[2], camera.box[3]);

            } else {

                entity.inView = true;

            }

            if ((entity instanceof CLIENT.Citizen) && !entity.temp.inSight)
                entity.inView = false;

            if (!prevInView && entity.inView && entity.enterview)
                entity.enterview();
            if (prevInView && !entity.inView && entity.leaveview)
                entity.leaveview();

            this.updateEntity(this.children[i], dt);

            if (this.children[i].step)
                this.children[i].step(dt);

            this.updateBox(this.children[i]);

            if (entity.doodle)
                app.game.doodlesCount++;

        }

        if (this.dirty)
            this.cleanup();

        this.sort();

    },

    render: function(layer, dt) {

        for (var i = 0; i < this.children.length; i++) {

            this.children[i].render(layer, dt);

        }

    }

};

/* file: common/modules/Share.js */

NAMESPACE.Sharer = function(descriptors) {

    this.listeners = {};

    this.descriptors = descriptors;
    this.keyToIndex = new Map;
    this.indexToKey = new Map;
    this.keys = [];
    this.keysQueue = [];

    // this.getKeyIndex(this.emptyKey);

    this.symbol_last_update = Symbol.for("last_update");
    this.symbol_last_share = Symbol.for("last_share");

    this.getKeyIndex("snapshot");

}
;

NAMESPACE.Sharer.prototype = {

    keyIndex: 0,

    emptyKey: "the_key_was_empty",

    DONT_ENCODE: 1,

    setKey: function(index, key) {

        this.keyToIndex.set(key, index);
        this.indexToKey.set(index, key);
        this.keys.push(index, key);
        this.keysQueue.push(index, key);

        this.trigger("addkey", index, key);

    },

    setKeys: function(array) {

        if (!array)
            return;

        for (var i = 0; i < array.length; i += 2) {

            this.setKey(array[i], array[i + 1]);

        }

    },

    getKey: function(index) {

        return this.indexToKey.get(index);

    },

    getKeyIndex: function(key) {

        if (!this.keyToIndex.has(key)) {

            this.setKey(++this.keyIndex, key);

        }

        return this.keyToIndex.get(key);

    },

    serialize: function(object) {

        var result = [];

        for (var key in object) {

            result.push(this.getKeyIndex(key), object[key]);

        }

        return result;

    },

    unserialize: function(array) {

        var object = {};

        for (var i = 0; i < array.length; i += 2) {

            var key = this.getKey(array[i]);

            object[key] = array[i + 1];

        }

        return object;

    },

    encode: function(code, source, full, partial, ignoreUndefined=false) {

        var symbol_last_update = Symbol.for("last_update");
        var symbol_last_share = Symbol.for("last_share");

        if (!full)
            full = [];

        var changes = 0;
        var changesCount = 0;

        var desc = this.descriptors[code];

        if (!desc)
            console.log("No such shared descriptor as", code);

        if (partial)
            partial.length = desc.length + 1;

        for (var i = 0; i < desc.length; i++) {

            var property = desc[i][0];

            var type = desc[i][1];
            var val = desc[i][2] ? source[desc[i][2]] : source[property];

            var skip = false;
            var force = false;

            if (ignoreUndefined && typeof val === "undefined")
                skip = true;

            if (!skip)
                switch (type) {

                case "key":

                    val = this.getKeyIndex(val);

                    // || this.emptyKey

                    break;

                case "queue":

                    if (val.length) {

                        val = [].concat(val);

                        source[property].length = 0;

                    } else {

                        skip = true;

                    }

                    break;

                case "boolean":
                case "bool":

                    val = Boolean(val);

                    break;

                case "int":

                    val = val | 0;

                    break;

                case "float":

                    val = val * 100 | 0;

                    break;

                case "sfloat":

                    val = val * 10 | 0;

                    break;

                case "object":

                    if (!partial || (val[symbol_last_update] | 0) !== val[symbol_last_share]) {

                        val[symbol_last_update] = val[symbol_last_update] | 0;
                        val[symbol_last_share] = val[symbol_last_update];

                        force = true;

                    } else {

                        skip = true;

                    }

                    break;

                default:

                    break;

                }

            if (!skip && (force || (full[i] !== val || type === "always"))) {

                full[i] = val;

                if (partial)
                    partial[changesCount + 1] = val;

                changes = changes | Math.pow(2, i);

                changesCount++;

            }

        }

        if (partial) {

            partial[0] = changes;

            partial.length = changesCount + 1;

        }

        return partial || full;

    },

    decode: function(code, data, partial) {
        //console.log(code)

        //console.log(this.descriptors)

        var properties = this.descriptors[code];

        var result = {};

        if (partial) {

            var changes = data[0];
            var index = 1;

            for (var i = 0; i < properties.length; i++) {

                if (changes >= 0 && !(changes & Math.pow(2, i))) {
                    continue;
                };

                var property = properties[i][0];
                var type = properties[i][1];
                var value = data[index];

                switch (type) {

                case "key":

                    value = this.getKey(value);

                    break;

                case "float":

                    value /= 100;

                    break;

                case "sfloat":

                    value /= 10;

                    break;

                }

                result[property] = value;

                index++;

                if (index >= data.length)
                    break;

            }

        } else {

            //console.log(properties)
            //console.log(data)
            for (var i = 0; i < data.length; i++) {

                //console.log(data)
                //console.log(i)
                //console.log(properties)
                var property = properties[i][0];
                var type = properties[i][1];
                var value = data[i];

                switch (type) {

                case "key":

                    value = this.getKey(value);

                    break;

                case "float":

                    value /= 100;

                    break;

                case "sfloat":

                    value /= 10;

                    break;

                }

                result[property] = value;

            }

        }
        //console.log(code, result)
        
        return result;

    },

    defaultValues: {
        "float": 0,
        "sfloat": 0,
        "int": 0,
        "string": "",
        "key": "",
        "always": 0,
        "bool": false,
        "boolean": false
    },

    defaults: function(key) {

        var result = {};

        var properties = this.descriptors[key];

        for (var i = 0; i < properties.length; i++) {

            var name = properties[i][0];
            var type = properties[i][1];

            result[name] = this.defaultValues[type];

        }

        return result;

    },

    markUpdate(object) {

        object[this.symbol_last_update] = object[this.symbol_last_update] + 1 | 0;

    },

    poke(object) {

        object[this.symbol_last_update] = object[this.symbol_last_update] + 1 | 0;

    },

    getUpdateMark(object) {

        return object[this.symbol_last_update] | 0;

    },

    on: function(event, callback, context) {

        if (typeof event === "object") {

            var result = {};

            for (var key in event) {

                result[key] = this.on(key, event[key], context)

            }

            return result;

        }

        if (!this.listeners[event])
            this.listeners[event] = [];

        var listener = {
            once: false,
            callback: callback,
            context: context
        };

        this.listeners[event].push(listener);

        return listener;
    },

    once: function(event, callback, context) {

        if (typeof event === "object") {
            var result = {};
            for (var key in event) {
                result[key] = this.once(key, event[key], context)
            }
            return result;
        }

        if (!this.listeners[event])
            this.listeners[event] = [];

        var listener = {
            once: true,
            callback: callback,
            context: context
        };

        this.listeners[event].push(listener);

        return listener;
    },

    off: function(event, callback) {

        for (var i = 0, len = this.listeners[event].length; i < len; i++) {

            if (this.listeners[event][i]._remove) {

                this.listeners[event].splice(i--, 1);
                len--;

            }

        }

    },

    trigger: function(event, a, b, c) {

        if (this.listeners.event) {

            for (var i = 0, len = this.listeners.event.length; i < len; i++) {

                var listener = this.listeners.event[i];

                listener.callback.call(listener.context, event, a, b, c);

            }

        }

        /* or subscribed to  a single event */

        if (this.listeners[event]) {

            for (var i = 0, len = this.listeners[event].length; i < len; i++) {

                var listener = this.listeners[event][i];

                listener.callback.call(listener.context || this, a, b, c);

                if (listener.once) {

                    this.listeners[event].splice(i--, 1);
                    len--;

                }

            }

        }

    }

};

/* file: script/modules/Events.js */

CLIENT.Events = function() {

    this.listeners = {};

}
;

CLIENT.Events.prototype = {

    on: function(event, callback, context) {

        if (typeof event === "object") {

            var result = {};

            for (var key in event) {

                result[key] = this.on(key, event[key], context)

            }

            return result;

        }

        if (!this.listeners[event])
            this.listeners[event] = [];

        var listener = {
            once: false,
            callback: callback,
            context: context
        };

        this.listeners[event].push(listener);

        return listener;
    },

    once: function(event, callback, context) {

        if (typeof event === "object") {
            var result = {};
            for (var key in event) {
                result[key] = this.once(key, event[key], context)
            }
            return result;
        }

        if (!this.listeners[event])
            this.listeners[event] = [];

        var listener = {
            once: true,
            callback: callback,
            context: context
        };

        this.listeners[event].push(listener);

        return listener;
    },

    off: function(event, callback) {

        for (var i = 0, len = this.listeners[event].length; i < len; i++) {

            if (this.listeners[event][i]._remove) {

                this.listeners[event].splice(i--, 1);
                len--;

            }

        }

    },

    trigger: function(event, data) {

        if (typeof data === "undefined")
            data = {};

        data.emitter = this;

        if (this.listeners.event) {

            for (var i = 0, len = this.listeners.event.length; i < len; i++) {

                var listener = this.listeners.event[i];

                listener.callback.call(listener.context, event, data);

            }

        }

        /* or subscribed to  a single event */

        if (this.listeners[event]) {

            for (var i = 0, len = this.listeners[event].length; i < len; i++) {

                var listener = this.listeners[event][i];

                listener.callback.call(listener.context || this, data);

                if (listener.once) {

                    this.listeners[event].splice(i--, 1);
                    len--;

                }

            }

        }

    }

};

/* file: script/modules/Renderer.js */

CLIENT.Renderer = function(game) {

    this.game = game;

}
;

CLIENT.Renderer.prototype = {

    render: function(x, y, entities, camera, layer) {
    }

};

/* file: script/modules/Camera.js */

CLIENT.Camera = function() {

    this.box = [0, 0, 0, 0];

    this.scale = 1.0;

    this.x = 0;
    this.y = 0;
    this.offsetX = 0;
    this.offsetY = 0;
    this.followX = 0;
    this.followY = 0;

    this.center = {
        x: 0,
        y: 0
    };

    this.instant = false;

    this.set(0, 0, 32, 32);

    this.shaking = 0;
    this.shakingPower = 0;

    this.matrix = Matrix3.create();

    this.centerView = true;

    this.orgSensor = this.sensor = 0;
    Math.min(app.width, app.height) / 4;

    this.limit = null;

}
;

CLIENT.Camera.prototype = {

    shake: function(power, duration) {

        power = power || 12;

        if (power > this.shakingPower || this.shaking <= 0) {

            this.shakingPower = power;

        }

        this.shaking = Math.max(this.shaking, duration || 1.0);

    },

    set: function(x, y, w, h) {

        this.x = x;
        this.y = y;

        this.center.x = x;
        this.center.y = y;

        this.width = w;
        this.height = h;

    },

    jump: function(x, y) {

        if (arguments.length === 0) {

            this.center.x = this.follow.x;
            this.center.y = this.follow.y;

        } else if (arguments.length === 1) {

            this.center.x = x.x;
            this.center.y = x.y;

        } else {

            this.center.x = x;
            this.center.y = y;

        }

        if (this.centerView) {
            this.x = this.center.x - this.width / 2 / this.scale;
            this.y = this.center.y - this.height / 2 / this.scale;
        } else {
            this.x = x;
            this.y = y;
        }

        this.updateWorldCoords();

    },

    skip: function() {

        this.skipped = true;

    },

    sensor: 100,

    step: function(dt) {

        this.updateWorldCoords();

        var offsetX = 0;
        var offsetY = 0;

        if (this.follow) {

            var followX = this.follow.x;
            var followY = this.follow.y;

            if (this.follow.box) {

                followX = this.follow.box[0] + this.follow.box[2] / 2;
                followY = this.follow.box[1] + this.follow.box[3] / 2;

            }

            if (this.limit) {
                if (followX - this.width / this.scale / 2 < this.limit.left)
                    followX = this.limit.left + this.width / this.scale / 2;
                if (followX + this.width / this.scale / 2 > this.limit.right)
                    followX = this.limit.right - this.width / this.scale / 2;
                if (followX - this.width / this.scale / 2 < this.limit.left)
                    followX = this.limit.left + Math.abs(this.limit.left - this.limit.right) * 0.5;
                if (followY - this.height / this.scale / 2 < this.limit.top)
                    followY = this.limit.top + this.height / this.scale / 2;
                if (followY + this.height / this.scale / 2 > this.limit.bottom)
                    followY = this.limit.bottom - this.height / this.scale / 2;
                if (followY - this.height / this.scale / 2 < this.limit.top)
                    followY = this.limit.top + Math.abs(this.limit.top - this.limit.bottom) * 0.5;
            }

            var distance = Utils.distance(this.center.x, this.center.y, followX, followY);

            var speed = Math.max(this.sensor === 0 ? 32 : 0, (distance - this.orgSensor) * 4);

            if (distance > this.sensor) {

                this.sensor = 0;

            }

            if (this.sensor === 0 && distance < 10) {

                this.sensor = this.orgSensor;

            }

            var angle = Utils.lookAt(this.center.x, this.center.y, followX, followY);

            if (this.skipped || this.instant || distance <= speed * dt) {

                this.skipped = false;

                this.center.x = followX;
                this.center.y = followY;

            } else {

                this.center.x += Math.cos(angle) * speed * dt;
                this.center.y += Math.sin(angle) * speed * dt;

            }

        }

        if (this.centerView) {

            this.x = this.offsetX + this.center.x - (this.width / this.scale) / 2 + offsetX;
            this.y = this.offsetY + this.center.y - (this.height / this.scale) / 2 + offsetY;

        }

        if (this.shaking > 0) {

            this.shaking -= dt;

            var a = Utils.saw(this.shaking / 1.0) * this.shakingPower;

            this.x += Utils.random(-a, a);
            this.y += Utils.random(-a, a);

        }

        this.updateWorldCoords();

    },

    updateWorldCoords: function() {

        if (this.fit) {
        // this.scale = Math.min(this.width / this.follow.box[2], this.height / this.follow.box[3]);

        }

        this.wx = this.x;
        this.wy = this.y;
        this.ww = this.width / this.scale;
        this.wh = this.height / this.scale;

        this.box[0] = this.x;
        this.box[1] = this.y;
        this.box[2] = this.ww;
        this.box[3] = this.wh;

    },

    setFollow: function(follow) {

        this.follow = follow;

    },

    inView: function(x, y, w=1, h=1) {

        return Utils.rectInRect(x, y, w, h, this.box[0], this.box[1], this.box[2], this.box[3]);

    }

};

/* file: script/modules/StateManager.js */

CLIENT.StateManager = function(parent, states) {

    this.parent = parent;

    this.current = {};
    this.states = states;

    this.data = {};
    this.runs = new Set;

}
;

CLIENT.StateManager.prototype = {

    runOnce: function(key, timeout) {

        if (!this.runs.has(key) && this.elapsed > timeout) {

            this.runs.add(key);

            return true;

        }

        return false;

    },

    set: function(state, a, b, c) {

        if (typeof state === "string") {

            this.currentKey = state;

            state = this.states[state];

        }

        // if (state === this.current) return;

        this.nextKey = this.currentKey;

        if (this.current && this.current.leave)
            this.current.leave(this.parent, this, a, b, c);

        if (typeof state === "function")
            state = new state;

        this.lifetime = 0;
        this.elapsed = 0;

        this.current = state;

        this.runs.clear();

        if (this.current && this.current.enter)
            this.current.enter(this.parent, this, a, b, c);

    },

    step: function(dt) {

        this.lifetime += dt;
        this.elapsed += dt;

        if (this.current && this.current.step)
            this.current.step(this.parent, this, dt);

    },

    call: function(methodName, a, b, c) {

        if (this.current && this.current[methodName])
            this.current[methodName](this.parent, this, a, b, c);

    },

    once: function() {
    }

};

/* file: script/modules/Map.js */

CLIENT.Map = function(game, data) {

    this.game = game;

    this.data = new Map;

    for (var id in data) {

        var pos = id.split(",");
        var tile = data[id];

        for (var key in tile) {

            this.set(pos[0] | 0, pos[1] | 0, key, tile[key]);

        }

        // this.data.set(key, data[key]);

    }
    /*
    for (var key in data) {

      var pos = key.split(",");

      this.refreshTile(pos[0] | 0, pos[1] | 0);

    }*/

}
;

CLIENT.Map.prototype = {

    isError: function(o) {

        return typeof o === "string";

    },

    error: function(msg) {

        return msg;

    },

    get: function(x, y, prop) {

        var key = x + "," + y;

        if (!this.data.has(key))
            return false;

        var tile = this.data.get(key);

        return prop ? tile[prop] : tile;

    },

    create: function(x, y) {

        var key = x + "," + y;

        this.data.set(key, {
            x: x,
            y: y
        });

    },

    id: function(x, y) {

        return x + ',' + y;

    },

    set: function(x, y, key, val) {

        var id = this.id(x, y);

        var tile = this.fget(x, y);
        var prev = tile[key];

        tile[key] = val;

        if (key === "wall") {

            this.crossCall(x, y, "refreshWall");
            // this.crossCall(x, y, "refreshWall");

        }

        if (key === "quantity") {

            var quantity = prev || 0;
            var diff = val - quantity;

            if (diff > 0) {

                this.addItems(x, y, "wood", diff);

            } else if (diff < 0) {

                this.removeItems(x, y, "wood", Math.abs(diff));

            }

        }

        // this.refreshTile(x, y);

    },

    addItems: function(x, y, key, count) {

        var tile = this.get(x, y);

        if (!tile._items)
            tile._items = [];

        for (var i = 0; i < count; i++) {

            var item = this.game.add("Item", {
                gx: x,
                gy: y
            });

            tile._items.push(item);

        }

        this.arrangeItems(x, y);

    },

    removeItems: function(x, y, key, count) {

        var tile = this.get(x, y);

        var index = tile._items.length > 2 ? 1 : 0;

        var item = tile._items[index];

        Utils.pull(tile._items, item);

        item.remove();

    },

    arrangeItems: function(x, y) {

        var tile = this.get(x, y);

        if (!tile.quantity)
            return;

        for (var i = 0; i < tile.quantity; i++)
            tile._items[i].restack(i, tile.quantity - 1);

    },

    adjacentMask: function(tx, ty, key) {

        var mask = 0;

        mask += 1 * this.get(tx - 1, ty, key);
        mask += 2 * this.get(tx, ty - 1, key);
        mask += 4 * this.get(tx + 1, ty, key);
        mask += 8 * this.get(tx, ty + 1, key);

        return mask;

    },

    adjacentCall: function(x, y, method) {

        this[method](x - 1, y);
        this[method](x + 1, y);
        this[method](x, y - 1);
        this[method](x, y + 1);

    },

    adjacentCount: function(x, y, key) {

        var result = 0;

        result += this.get(x - 1, y)[key] ? 1 : 0;
        result += this.get(x + 1, y)[key] ? 1 : 0;
        result += this.get(x, y - 1)[key] ? 1 : 0;
        result += this.get(x, y + 1)[key] ? 1 : 0;

        return result;

    },

    crossCall: function(x, y, method) {

        this[method](x - 1, y);
        this[method](x + 1, y);
        this[method](x, y - 1);
        this[method](x, y + 1);

        this[method](x, y);

    },

    refreshWall: function(x, y) {

        var tile = this.get(x, y);

        if (tile.wall && !tile._wall) {

            tile._wall = this.game.entities.add("Wall", {
                x: Grid.gp(x),
                y: Grid.gp(y) + Grid.size
            });

        }

        if (!tile.wall && tile._wall) {

            tile._wall.collection.remove(tile._wall);

        }

        if (tile._wall) {

            var count = this.adjacentCount(x, y, "wall");

            tile._wall.tile = this.adjacentMask(x, y, "wall");
            tile._wall.count = count;

        }

    },

    adjacent: function(x, y) {

        return [this.get(x - 1, y), this.get(x + 1, y), this.get(x, y - 1), this.get(x, y + 1)];

    },

    refreshAdjacentBuildings: function() {

        this.refreshBuilding

    },

    fget: function(x, y) {

        if (!this.get(x, y))
            this.create(x, y);

        return this.get(x, y);

    },

    put: function(gx, gy, item) {

        var tile = this.fget(gx, gy);

        if (tile.item && tile.item !== item)
            return this.error("item-mismatch");

        if (!tile.quantity)
            tile.quantity = 0;

        tile.quantity++;
        tile.item = item;

        return this.game.entities.add("Item", {
            x: Grid.gpc(gx),
            y: Grid.gpc(gy),
            key: item
        });

    },

    refreshTile: function(x, y) {

        var tile = this.get(x, y);

        if (!tile)
            return;

        if (tile.building) {

            var before = this.wall;

            var count = this.probeCount(x, y, "building");

            this.wall = count < 4;

            if (this.wall !== before)
                this.refreshAdjacent(x, y);

        }

        if (tile.wall && !tile._wall) {

            tile._wall = this.game.entities.add("Wall", {
                x: Grid.gp(x),
                y: Grid.gp(y) + Grid.size,
                tile: this.getWallIndex(x, y)
            });

        }

    },

    refreshAdjacent: function(x, y) {

        this.refreshTile(x - 1, y);
        this.refreshTile(x + 1, y);
        this.refreshTile(x, y - 1);
        this.refreshTile(x, y + 1);

    },

    probeCount: function(tx, ty, key) {

        var result = 0;

        result += this.get(tx - 1, ty, key) ? 1 : 0;
        result += this.get(tx, ty - 1, key) ? 1 : 0;
        result += this.get(tx + 1, ty, key) ? 1 : 0;
        result += this.get(tx, ty + 1, key) ? 1 : 0;

        return result;

    }

};
/* Map */

/* file: script/modules/fx.js */

CLIENT.Game.fx = function(key, data) {

    if (!this.camera.inView(data.x, data.y))
        return;

    CLIENT.FX[key](data, this.entities);

}
;

CLIENT.FX = {};

CLIENT.FX.unlock = function(data, collection) {

    app.sound.play("objects/door_unlock").gpan(data);

}
;

CLIENT.FX.quake = function(data, collection) {

    app.sound.play("impact/ground_heavy").rate(0.3).gpan(data);
    app.sound.play("impact/ground_heavy").rate(0.5).gpan(data);

    for (var i = 0; i < 6; i++) {

        this.plank({
            x: data.x,
            y: data.y
        }, collection);

    }

    let angles = 6;
    let angle_step = Math.TAU / angles;

    for (var i = 0; i < angles; i++) {

        var sprite = collection.add("Sprite");

        sprite.set("fx/quake", false);
        sprite.zIndex = 1;
        sprite.rotation = angle_step * i;
        sprite.x = data.x;
        sprite.y = data.y;
        sprite.force = 200;
        sprite.forceDamping = 100;
        sprite.forceDirection = angle_step * i;
        sprite.duration = sprite.lifespan = 1.0;
        sprite.scale = 2;

        // app.tween(sprite).to({ scale: 0}, sprite.lifespan)

    }

}
;

CLIENT.FX.plank = function(data, collection) {

    data = data || {};

    var sprite = collection.add("Sprite");

    sprite.set("pickups/stone", true);
    sprite.zIndex = 2;
    sprite.loopDuration = 0.2 + Math.random() * 0.3;
    sprite.spin = 0.25;
    sprite.x = data.x;
    sprite.y = data.y;

    sprite.row = Utils.random(0, 15);
    sprite.delay = Math.random() * 0.1;
    sprite.rotation = Math.random() * 6;
    sprite.tc = 2;

    sprite.shadow = true;

    // if (data.color) sprite.color = data.color;

    app.tween(sprite).delay(sprite.delay).to({
        z: Utils.random(30, 90),
        scale: 1.5
    }, 0.25, "outQuad").to({
        z: 0,
        scale: 1.0,
        tc: 0.0
    }, 0.75, "outBounce").delay(1.0).to({
        scaleY: 0,
        scaleX: 0
    }, 1.0);

    app.tween(sprite).delay(sprite.delay).to({
        x: data.x + Utils.random(-160, 160),
        y: data.y + Utils.random(-160, 160),
    }, 1.0)

    sprite.lifespan = 4;

}
;

CLIENT.FX.mirage = function(data, collection) {

    let entity = collection.sid(data.entity_sid);

    if (!entity)
        return;

    let sprite = collection.add("Sprite");

    sprite.follow = entity;
    sprite.zIndex = entity.zIndex + 1;
    sprite.followOffsetZ = 20;
    sprite.scaleX = 0.6;
    sprite.set("fx/blob");
    sprite.setDuration(0.5);

    sprite = collection.add("Sprite");

    sprite.follow = entity;
    sprite.zIndex = entity.zIndex + 1;
    sprite.followOffsetZ = 20;
    sprite.set("fx/lighting");
    sprite.setDuration(0.5);
    sprite.color = "#fff";

    app.sound.play("spells/summon").gpan(entity);
}
;

CLIENT.FX.purchase = function(data, collection) {

    app.sound.play("ui/purchase").gpan(data);

    let sprite = collection.add("Sprite");

    sprite.x = data.x;
    sprite.y = data.y;
    sprite.z = 10;
    sprite.zIndex = 3;
    sprite.set(data.sprite || "pickups/gold_coin", true);
    sprite.setDuration(0.3);

    app.tween(sprite).to({
        y: sprite.y - 50,
        scale: 0
    }, 2.0, "outQuad").once("finished", function() {

        sprite.loop = false;

    })

}
;

CLIENT.FX.bleed = function(data, collection) {

    for (var i = 0; i < 4; i++) {
        data.angle += Utils.randomf(-0.3, 0.3);
        let duration = 0.5;
        var s = collection.add("Sprite");

        s.delay = Math.random() * 0.2;
        s.set("fx/blood", false);
        s.setDuration(duration);
        s.rotation = Math.random() * 6;
        s.x = data.x + Utils.random(-5, 5);
        s.y = data.y + Utils.random(-5, 5);
        s.z = Utils.random(10, 20);
        s.color = "#cc0000";
        s.scale = 0.5;
        var r = 20 + Math.random() * 40;

        app.tween(s).to({
            x: s.x + Math.cos(data.angle) * r,
            y: s.y + Math.sin(data.angle) * r,
        }, s.duration)

        app.tween(s).to({
            z: 0
        }, s.duration, "inQuad")

    }

}

CLIENT.FX.heal = function(data, collection) {

    app.sound.play("spells/swallow").gpan(data.entity);

    var aura = collection.add("Sprite");

    aura.color = data.color || "#f00";
    aura.blendMode = "color-dodge";
    aura.zIndex = 5;
    aura.set("aura", true);
    aura.follow = data.entity;
    aura.scaleY = 1.2;
    aura.scaleX = 0.5;
    aura.alpha = 0;
    aura.alignY = 1.0;
    aura.offsetY = -40;

    app.tween(aura).to({
        alpha: 1.0
    }, 0.2);

    app.tween(aura).wait(0.2).to({
        // scaleX: 0,
        scaleY: 0,
        alpha: 0
    }, 0.2, "linear").once("finished", function() {

        this.context.cease();

    });

}
;

CLIENT.FX.pickup = function(data, collection) {

    var sprite = collection.add("Sprite");

    sprite.zIndex = 3;

    sprite.x = data.x;
    sprite.y = data.y;

    sprite.easing = "linear";

    sprite.set("collect", false);

    sprite.loopDuration = 0.3;

}
;

CLIENT.FX.smoke_puff = function(data, collection) {

    return;

    var sprite = collection.add("Sprite");

    sprite.color = "#a00";

    sprite.zIndex = 3;

    sprite.x = data.x;
    sprite.y = data.y;
    // sprite.scaleY = 0.3;
    // sprite.scaleX = 0.5;

    sprite.set("puff_ring", false);

}
;

CLIENT.FX.blood_explosion = function(data, collection) {

    var sprite = collection.add("Sprite");

    sprite.color = data.color || "#a00";

    sprite.zIndex = 3;

    sprite.x = data.x;
    sprite.y = data.y;

    sprite.scale = data.scale || 1.0;

    // sprite.scaleY = 0.3;
    // sprite.scaleX = 0.5;

    sprite.set("blood_explosion", false);
    sprite.setDuration(1.0);

    app.sound.play("martial/splat").rate(0.5).volume(1.6);

}
;

CLIENT.FX.blood_fountain = function(data, collection) {

    if (!app.game.canDoodle())
        return;

    data.intensity = data.intensity || 1.0;

    var sprite = collection.add("Sprite");
    var duration = 0.3 + Math.random() * 0.7;

    sprite.doodle = true;
    sprite.color = data.color || false;
    sprite.set("fx/blood", false);
    sprite.zIndex = 3;
    sprite.setDuration(duration);
    sprite.scale = 0.5;
    // sprite.scale = 0.2 + Math.random() * 0.5;    
    sprite.x = data.x + Utils.random(-16, 16);
    sprite.y = data.y + Utils.random(-16, 16);
    sprite.force = Utils.random(50, 250 * data.intensity);
    sprite.forceDirection = Math.random() > 0.5 ? 0 : Math.PI;
    // sprite.rotation = Math.random() * 6;

    app.tween(sprite).to({
        z: Utils.random(20, 80 * data.intensity)
    }, duration * 0.5, "linear").to({
        z: 0
    }, duration * 0.5, "outBounce")

    /*
      var s = collection.add("Animation");

      s.set("puff", {
        x: data.x + Utils.random(-8, 8),
        y: data.y - Utils.random(0, 10),
        z: 20,
        auto: true,
        rotation: Math.random() * 6,
        duration: 0.3 + Math.random() * 0.7,
        color: data.color || "#a00",
        zIndex: 2,
        scale: 0.05 + Math.random() * 0.1
      });

      var r = Math.random() * 20;

      app.tween(s).
      to({
        x: s.x + Math.cos(Math.random() * 6) * r,
        y: s.y + Math.sin(Math.random() * 6) * r,
      }, s.duration)

      app.tween(s)
        .to({
          z: 20
        }, s.duration * 0.5, "linear")
        .to({
          z: 0
        }, s.duration * 0.5, "outBounce")
    */

}
;

/* file: script/modules/Scoreboard.js */

CLIENT.Scoreboard = function(game) {

    this.game = game;
    this.players = this.game.entities.groups.citizens;

    this.$container = $(`<div class="scoreboard gui-cols">
        <div class="left scores">
            <h2>Scoreboard</h2>
        </div>
        <div class="right scores">
            <h2>Best today</h2>
        </div>
    </div>`);

    this.$container.appendTo("body");

    this.entries = new Map;

    this.$left = this.$container.children(".left");
    this.$right = this.$container.children(".right");

}
;

CLIENT.Scoreboard.prototype = {

    show: function() {

        this.$container.show();

    },

    hide: function() {

        this.$container.hide();

    },

    destroy: function() {

        this.$container.remove();

    },

    filters: {

        notDead: function(c) {

            if (c === app.game.player)
                return true;
            if (c.key !== "hero")
                return false;

            if (!c.game.fun)
                return true;

            return !c.dead

        },

        byScore: function(a, b) {

            return b.shared.score - a.shared.score;

        },

        elementByScore: function(a, b) {

            return $(b).data("score") - $(a).data("score");

        }

    },

    setBestPlayers(players) {

        players.sort((a,b)=>{
            return b.score - a.score;
        }
        )

        this.$right.children("div").remove();

        for (let player of players) {

            this.addSimpleEntry(player, this.$right);

        }

    },

    step: function() {

        this.updates = 0;

        var top = Utils.filter(this.players, this.filters.notDead);

        top.sort(this.filters.byScore);

        top = top.slice(0, 20);

        var i = 0;

        top = new Set(top);

        for (let player of top) {

            player.place = Math.max(0, Math.min(10, top.size) - i);

            if (!this.entries.has(player))
                this.addEntry(player);

            this.entries.get(player).data("score", player.shared.score);

            i++;

        }

        for (let entry of this.entries) {

            var player = entry[0];

            if (!top.has(player))
                this.removeEntry(player);
            else
                this.updateEntry(player);

        }

        if (this.updates) {
            var $elements = this.$left.children().sort(this.filters.elementByScore);
            this.$left.append($elements);
        }

    },

    addEntry: function(player, $container) {

        var $entry = $("<div>");

        $entry.appendTo($container || this.$left);

        $entry.$color = $("<span>").addClass("color").addClass("color-" + player.shared.team).appendTo($entry);
        $entry.$flag = $("<span>").addClass("flag").appendTo($entry);
        $entry.$score = $("<span>").addClass("score").appendTo($entry);
        $entry.$name = $("<span>").addClass("name").appendTo($entry);

        $entry.$name.html(player.shared.name);

        if (player === app.game.player)
            $entry.addClass("player");

        this.entries.set(player, $entry);

        this.updates++;

    },

    addSimpleEntry: function(player, $container) {

        var $entry = $("<div>");

        $entry.appendTo($container || this.$left);

        // $entry.$color = $("<span>").addClass("color").addClass("color-" + player.shared.team).appendTo($entry);
        $entry.$color = $("<span>").addClass("color").addClass("color-" + 0).appendTo($entry);
        $entry.$flag = $("<span>").addClass("flag").appendTo($entry);
        $entry.$score = $("<span>").addClass("score").appendTo($entry);
        $entry.$name = $("<span>").addClass("name").appendTo($entry);

        $entry.$name.html(player.name);
        $entry.$score.html(player.score);

        {

            let index = COMMON.COUNTRY_INDEX[player.flag];

            var cx = -12 * (index % 20);
            var cy = -8 * (index / 20 | 0);

            $entry.$flag.css({
                backgroundImage: "url(images/flags/all.png)",
                backgroundPosition: cx + "px " + cy + "px"
            });
        }

    },

    removeEntry: function(player) {

        var $entry = this.entries.get(player);

        $entry.remove();

        this.entries.delete(player);

        this.updates++;

    },

    updateEntry: function(player) {

        var $entry = this.entries.get(player);

        if ($entry.score !== player.score) {

            $entry.$score.html(player.score);

            $entry.score = player.score;

            this.updates++;

        }

        if ($entry.flag !== player.shared.flag) {

            this.updates++;

            $entry.flag = player.shared.flag;

            var index = COMMON.COUNTRY_INDEX[player.shared.flag];

            var cx = -12 * (index % 20);
            var cy = -8 * (index / 20 | 0);

            $entry.$flag.css({
                backgroundImage: "url(images/flags/all.png)",
                backgroundPosition: cx + "px " + cy + "px"
            });

        }

    }

};

/* file: script/modules/Announcer.js */

CLIENT.Announcer = function() {

    this.killCounterTimeout = 0;
    this.killCounterWindow = 0;
    this.killCounter = 0;
    this.kills = 0;
    this.timeout = 0;

    this.queue = [];

    for (var i = 0; i < this.execlusive.length; i++) {

        var exclusives = this.execlusive[i];

        for (var j = 0; j < exclusives.length; j++) {

            var key = exclusives[j];

            var announcer = this.announcers[key];

            announcer.exclude = [];

            for (var l = 0; l < exclusives.length; l++) {

                if (j === l)
                    continue;

                announcer.exclude.push(exclusives[l]);

            }

        }

    }

}
;

CLIENT.Announcer.prototype = {

    execlusive: [
    ["double_kill", "triple_kill", "quad_kill", "annihilation"], ["king", "king_lost"]
    ],

    announcers: {

        "get_ready": {

            importance: -1,
            text: "GET READY"

        },

        "go": {

            importance: 0,
            text: "GO!"

        },

        "fight": {

            importance: 2,
            text: "Fight!"

        },

        "score_brown": {

            importance: 1,
            text: "BROWN TEAM SCORES"

        },

        "score_gray": {

            importance: 1,
            text: "SCORE FOR THE GRAY TEAM"

        },

        "revenge": {

            importance: 1,
            text: "REVENGE"

        },

        "glorious": {

            importance: 0,
            text: "GLORIOUS WARRIOR"

        },

        "rampage": {

            importance: 1,
            text: "RAMPAGE"

        },

        "unstoppable": {

            importance: 1,
            text: "UNSTOPPABLE"

        },

        "double_kill": {

            importance: 0,
            text: "DOUBLE KILL"

        },

        "triple_kill": {

            importance: 0,
            text: "TRIPLE KILL"

        },

        "quad_kill": {

            importance: 1,
            text: "QUAD KILL"

        },

        "annihilation": {

            importance: 1,
            text: "ANNIHILATION"

        },

        "king": {

            importance: 1,
            text: "YOU ARE THE NEW KING"

        },

        "king_lost": {

            importance: -1,
            text: "YOU HAVE LOST THE LEAD"

        }

    },

    enqueue: function(key) {

        var announcer = this.announcers[key];

        if (!announcer)
            return;

        for (var i = 0; i < this.queue.length; i++) {

            var item = this.queue[i];

            if (announcer.exclude && announcer.exclude.indexOf(item) > -1)
                this.queue.splice(i--, 1);

        }

        this.queue.push(key);

    },

    kill: function() {

        this.kills++;
        this.killCounter++;
        this.killCounterWindow = 10;
        this.killCounterTimeout = 1;

        if (this.kills === 10)
            this.enqueue("glorious");
        if (this.kills === 20)
            this.enqueue("rampage");
        if (this.kills === 30)
            this.enqueue("unstoppable");

    },

    die: function() {

        this.kills = 0;

    },

    step: function(dt) {

        /* Gather kill statistics */

        if (this.killCounterTimeout > 0) {

            this.killCounterTimeout -= dt;

            if (this.killCounterTimeout <= 0) {

                this.killCounterTimeout = 0;

                var key = {
                    2: "double_kill",
                    3: "triple_kill",
                    4: "quad_kill"
                }[this.killCounter];

                if (this.killCounter >= 5)
                    key = "annihilation";

                if (key)
                    this.enqueue(key);

            }

        }

        if (this.killCounterWindow > 0) {

            this.killCounterWindow -= dt;

            if (this.killCounterWindow <= 0)
                this.killCounter = 0;

        }

        this.timeout -= dt;

        if (this.timeout <= 0 && this.queue.length) {

            this.timeout = 3;

            var key = this.queue.shift();

            this.run(key);

        }

    },

    run: function(key) {

        var announcer = this.announcers[key];

        app.sound.play("voice/" + key);

        if (announcer.importance > 0)
            app.sound.play("drums/major_" + Utils.random(1, 2));
        else if (announcer.importance < 0)
            app.sound.play("drums/negative");
        else
            app.sound.play("drums/minor_" + Utils.random(1, 2));

        /*
        var $text = app.gui.add({
          transparent: true,
          text: announcer.text || key,
          x: "50%",
          color: "#45283c",
          y: 40,
          fontSize: 16,
          anchor: [0.5, 0.0]
        });

        $text.set("zoomX", 0);
        $text.animate({
          zoomX: 1.0
        }, 0.5, "outElastic");

        setTimeout(function() {

          $text.dissolve(0.25);

        }, 3000);

        */

    }

};

/* file: script/modules/Announcer2.js */

CLIENT.Announcer2 = {

    killCounter: 0,
    lastKill: 0,

    announcerData: null,

    announcers: {

        "shadow": {
            text: "KILL A HUMAN TO BECOME A HUMAN",
            size: 32,
            color: "#fff"
        },

        "human": {
            text: "YOU ARE A HUMAN NOW",
            size: 32,
            color: "#fff"
        },

        "highscore": {
            text: "NEW HIGHSCORE",
            size: 40,
            rgb: true,
            color: "#fff"
        }

    },

    addKill() {

        if (Date.now() - this.lastKill > 12000) {

            this.killCounter = 0;

        }

        this.killCounter++;

        if (this.killCounter === 1)
            this.run("kill" + Utils.random(1, 5));
        if (this.killCounter === 2)
            this.run("double_kill");
        if (this.killCounter === 3)
            this.run("triple_kill");
        if (this.killCounter === 4)
            this.run("quad_kill");
        if (this.killCounter > 4)
            this.run("monster_kill");

        this.lastKill = Date.now();

    },

    run(key) {

        // app.sound.play("announcers/default/" + key).volume(0.9);

        this.announcerData = this.announcers[key];
        this.lifespan = 3;

    },

    render(layer, dt) {

        var def = this.announcerData;

        if (this.lifespan && def) {

            this.lifespan -= dt;

            if (this.lifespan <= 0)
                this.announcerData = null;

            if (def.text) {

                layer.textAlign("center").font(def.size + "px 'Oswald'");

                if (def.rgb) {

                    var r = Utils.random(-5, 5);
                    var r2 = Utils.random(-5, 10);

                    layer.fillStyle("#ff4207").fillText(def.text, app.width / 2 + r, app.height * 0.3 + r2);
                    layer.fillStyle("#07ffdf").fillText(def.text, app.width / 2 - r2, app.height * 0.3 - r);

                }

                layer.fillStyle(def.color).fillText(def.text, app.width / 2, app.height * 0.3);

            }

        }

    }

};

/* file: script/modules/BetterAnnouncer.js */

CLIENT.BetterAnnouncer = {

    killCounter: 0,
    lastKill: 0,

    announcerData: null,

    announcers: {

        "double_kill": {
            text: "DOUBLE KILL",
            size: 24,
            color: "#ff4207"
        },
        "triple_kill": {
            text: "TRIPLE KILL",
            size: 32,
            color: "#07ffdf"
        },
        "quad_kill": {
            text: "QUAD_KILL",
            size: 42,
            color: "#ffea07"
        },
        "monster_kill": {
            text: "MONSTER_KILL",
            size: 54,
            color: "#ff4207",
            rgb: true
        },

    },

    addKill() {

        if (Date.now() - this.lastKill > 12000) {

            this.killCounter = 0;

        }

        this.killCounter++;

        // if (this.killCounter === 1) this.run("kill" + Utils.random(1, 5));
        if (this.killCounter === 2)
            this.run("double_kill");
        if (this.killCounter === 3)
            this.run("triple_kill");
        if (this.killCounter === 4)
            this.run("quad_kill");
        if (this.killCounter > 4)
            this.run("monster_kill");

        this.lastKill = Date.now();

    },

    run(key) {

        app.sound.play("announcers/masculine/" + key).volume(0.9);

        this.announcerData = this.announcers[key];
        this.lifespan = 3;

    },

    render(layer, dt) {

        var def = this.announcerData;

        if (this.lifespan && def) {

            this.lifespan -= dt;

            if (this.lifespan <= 0)
                this.announcerData = null;

            if (def.text) {

                layer.textAlign("center").font(def.size + "px 'generic'");

                if (def.rgb) {

                    var r = Utils.random(-5, 5);
                    var r2 = Utils.random(-5, 10);

                    layer.fillStyle("#ff4207").fillText(def.text, app.width / 2 + r, app.height * 0.3 + r2);
                    layer.fillStyle("#07ffdf").fillText(def.text, app.width / 2 - r2, app.height * 0.3 - r);

                }

                layer.fillStyle(def.color).fillText(def.text, app.width / 2, app.height * 0.3);

            }

        }

    }

};

/* file: script/modules/Tween.js */

NAMESPACE.Tween = function(context) {

    this.context = context;

    this.tweensMap = new Map;
    this.tweensArray = [];

    this.easing = "linear";

}
;

NAMESPACE.Tween.LINEAR = 0;
NAMESPACE.Tween.CIRC = 1;

NAMESPACE.Tween.prototype = {

    to: function(property, value, duration, mode=0) {

        var tween = this.tweensMap.get(property);

        if (!tween) {

            var tween = {
            };

            this.tweensMap.set(property, tween)
            this.tweensArray.push(tween);

        }

        tween.property = property;
        tween.before = this.context[property];
        tween.after = value;
        tween.duration = duration;
        tween.lifetime = 0;
        tween.mode = mode;

        if (tween.mode === NAMESPACE.Tween.LINEAR) {

            tween.diff = value - tween.before;

        } else if (tween.mode === NAMESPACE.Tween.CIRC) {

            tween.diff = Utils.circDistance(value, tween.before);

        }

    },

    step: function(dt) {

        for (var i = 0; i < this.tweensArray.length; i++) {

            var tween = this.tweensArray[i];

            tween.lifetime += dt;

            var progress = tween.lifetime / tween.duration;

            if (progress > 1.0)
                progress = 1.0;

            if (tween.mode === NAMESPACE.Tween.LINEAR) {

                this.context[tween.property] = tween.before + tween.diff * app.ease(progress, this.easing);

            } else if (tween.mode === NAMESPACE.Tween.CIRC) {

                this.context[tween.property] = Utils.circWrapTo(tween.before, tween.after, tween.diff * app.ease(progress, this.easing));

            }

            if (progress === 1.0) {

                this.tweensMap.delete(tween.property);
                this.tweensArray.splice(i--, 1);

            }

        }

    }

};

/* file: common/modules/SpamFilter.js */

NAMESPACE.SpamFilter = {

    BAN: 2,

    ban: function(id) {

        this.spammers.set(id, Date.now());

        return this.BAN;

    },

    filter: function(id, text) {

        var now = Date.now();

        text = text.trim();

        if (!text)
            return;

        if (!this.spamStats)
            this.spamStats = new Map;
        if (!this.spammers)
            this.spammers = new Map;

        /* check spammer status */

        var status = this.spammers.get(id);

        if (status && (now - status < 60000))
            return true;

        /* */

        if (!this.spamStats.get(id))
            this.spamStats.set(id, {
                times: [0, 0],
                last: ""
            });

        var stats = this.spamStats.get(id);

        /* Spam interval */

        var times = stats.times;

        var delta = now - times[0];

        times[0] = now;

        if (delta > 3000)
            times[1] = 0;

        else
            times[1]++;

        if (times[1] > 3)
            return this.ban(id);

        /* Phrases */

        if (this.lastText && text === this.lastText && this.lastid === id)
            return this.ban(id);
        if (text.indexOf("http") > -1 && text.indexOf("wilds.io") === -1)
            return this.ban(id);
        if (text.indexOf("recruiter=") > -1)
            return this.ban(id);
        if (text.toLowerCase().indexOf("fuck") > -1)
            return this.ban(id);

        /* Repetitive texts */

        var words = text.split(" ");
        var wordsTable = {};

        for (var i = 0; i < words.length; i++) {

            var word = words[i];
            wordsTable[word] = (wordsTable[words[i]] | 0) + 1;

            if (word.length > 1 && wordsTable[word] >= 5)
                return this.ban(id);
            if (word.length <= 2 && wordsTable[word] >= 6)
                return this.ban(id);

        }

        /* Repeating last text */

        if (stats.last === text) {

            return this.ban(id);

        }

        stats.last = text;

        return false;

    }

};

SpamFilter = NAMESPACE.SpamFilter;

/* file: common/modules/PositionalArray.js */

NAMESPACE.PositionalArray = {

    offset(array, x=0, y=0) {

        for (var i = 0; i < array.length; i += 3) {

            array[i + 0] += x;
            array[i + 1] += y;

        }
    },

    get(array, x, y) {

        for (var i = 0; i < array.length; i += 3) {

            if (array[i] !== x)
                continue;
            if (array[i + 1] !== y)
                continue;

            return array[i + 2];

        }

        return undefined;

    },

    set(array, x, y, value) {

        this.delete(array, x, y);

        array.push(x, y, value);

    },

    delete(array, x, y) {

        for (var i = 0; i < array.length; i += 3) {

            if (array[i] !== x)
                continue;
            if (array[i + 1] !== y)
                continue;

            array.splice(i, 3);

            break;

        }

    },

    union(a, b) {

        if (!b)
            return a;

        for (var i = 0; i < b.length; i += 3) {

            this.delete(a, b[i + 0], b[i + 1]);
            this.set(a, b[i + 0], b[i + 1], b[i + 2]);

        }

        return a;

    }

}

/* file: common/modules/InfiniteMap.js */

{

    let InfiniteMap = function() {

        this.tiles = new Map;
        this.entities = [];

        this.left = 0;
        this.top = 0;
        this.bottom = 0;
        this.right = 0;

        this.width = 1;
        this.height = 1;
        this.padding = 2;

        this.mask = new Map;

        this.tilesToRefresh = [];

        this.meta = {};

    };

    InfiniteMap.prototype = {

        toJSON() {

            return JSON.stringify({
                map: this.export(),
                entities: this.entities
            });

        },

        forEach: function(callback) {

            this.tiles.forEach(function(tile, key) {

                let temp = key.split(",");
                let x = temp[0] | 0;
                let y = temp[1] | 0;

                callback(tile, x, y);

            });

        },

        export: function() {

            var result = {};
            var map = this;

            let exported = ["wall", "ground", "semi"];

            this.tiles.forEach(function(value, key) {

                result[key] = Utils.pick(value, exported);

            });

            return result;

        },

        serialize: function() {

            var exported = this.export();

            return JSON.stringify(exported);

        },

        unserialize: function(raw) {

            this.mask = new Map;

            return this.open(raw);

        },

        open: function(raw) {

            if (typeof raw === "string") {

                var temp = JSON.parse(raw);

            } else
                temp = raw;

            this.raw = temp;

            this.entities = temp.entities;
            this.meta = temp.meta || {};

            this.tiles.clear();

            var sorted = [];

            for (var key in temp.map) {

                let xy = this.xy(key);

                temp.map[key].x = xy.x;
                temp.map[key].y = xy.y;

                sorted.push(temp.map[key]);

            }

            sorted.sort(function(a, b) {

                if (a.y === b.y)
                    return a.x - b.x;
                return a.y - b.y;

            });

            temp = {};

            for (var t of sorted) {

                let id = this.id(t.x, t.y);

                temp[id] = t;

            }

            for (var key in temp) {

                this.tiles.set(key, temp[key]);

                let xy = this.xy(key);

                if (xy.x < this.left)
                    this.left = xy.x;
                if (xy.y < this.top)
                    this.top = xy.y;
                if (xy.x > this.right)
                    this.right = xy.x;
                if (xy.y > this.bottom)
                    this.bottom = xy.y;

            }

            this.left -= this.padding;
            this.top -= this.padding;
            this.right += this.padding;
            this.bottom += this.padding;

            this.width = Math.abs(this.left - this.right) + 1;
            this.height = Math.abs(this.top - this.bottom) + 1;

            this.populateMask();

            return Promise.resolve();

        },

        findTileByID(id) {

            return this.tilesByID[id];

        },

        populateMask: function() {

            this.mask = new Map;
            this.ref = new Map;

            this.tilesByID = {};

            for (var key in this.tileset.tiles) {

                let tile = this.tileset.tiles[key];
                tile.key = key;

                if (!tile.id)
                    continue;

                this.tilesByID[tile.id] = tile;

            }

            let tilesArray = Array.from(this.tiles.values());

            tilesArray.sort(function(a, b) {

                if (a.y !== b.y)
                    return a.y - b.y;

                return a.x - b.x;

            });

            for (let tile of tilesArray) {

                this.refreshTile(tile.x, tile.y);

            }
            ;

        },

        fillData: function() {

            for (var e of this.tiles) {

                var column = e[1];

                for (var i = 0; i < column.length; i++) {

                    var tile = column[i];

                    tile.data = this.td(tile.key);

                }

            }

        },

        isError: function(o) {

            return typeof o === "string";

        },

        isSolid: function(tx, ty) {

            var tile = this.get(tx, ty);

            if (!tile)
                return false;

            return tile.data.solid;

        },

        error: function(msg) {

            return msg;

        },

        id: function(x, y) {

            return x + "," + y;

        },

        xy: function(id) {

            let temp = id.split(",");

            return {
                x: temp[0] | 0,
                y: temp[1] | 0
            }

        },

        emptyTile: false,

        get: function(x, y) {

            var key = this.id(x, y);

            if (!this.tiles.has(key))
                return this.emptyTile;

            var tile = this.tiles.get(key);

            return tile;

        },

        create: function(x, y) {

            var key = this.id(x, y);

            if (!this.tiles.has(key))
                this.tiles.set(key, {});

            var tile = this.tiles.get(key);

            return tile;

        },

        fget: function(x, y) {

            var tile = this.get(x, y);

            if (!tile)
                this.create(x, y);

            return this.get(x, y);

        },

        delete: function(gx, gy) {

            var tile = this.get(gx, gy);

            if (!tile)
                return;

            var key = this.id(gx, gy);

            this.tiles.delete(key);

        },

        set: function(gx, gy, prop, val) {

            var tile = this.fget(gx, gy);

            if (typeof prop === "object") {

                for (var k in prop)
                    this.set(gx, gy, k, prop[k])

            } else {

                tile[prop] = val;

            }

        },

        adjacentCount: function(x, y, key) {

            var result = 0;

            result += this.get(x - 1, y)[key] ? 1 : 0;
            result += this.get(x + 1, y)[key] ? 1 : 0;
            result += this.get(x, y - 1)[key] ? 1 : 0;
            result += this.get(x, y + 1)[key] ? 1 : 0;

            return result;

        },

        squareCount: function(x, y, key) {

            var result = 0;

            result += this.get(x - 1, y)[key] ? 1 : 0;
            result += this.get(x + 1, y)[key] ? 1 : 0;
            result += this.get(x, y - 1)[key] ? 1 : 0;
            result += this.get(x, y + 1)[key] ? 1 : 0;

            result += this.get(x - 1, y - 1)[key] ? 1 : 0;
            result += this.get(x - 1, y + 1)[key] ? 1 : 0;
            result += this.get(x + 1, y - 1)[key] ? 1 : 0;
            result += this.get(x + 1, y + 1)[key] ? 1 : 0;

            return result;

        },

        crossCall: function(x, y, method) {

            this[method](x - 1, y);
            this[method](x + 1, y);
            this[method](x, y - 1);
            this[method](x, y + 1);

            this[method](x, y);

        },

        getBounds: function() {

            this.left = 0;
            this.top = 0;
            this.bottom = 0;
            this.right = 0;

            this.tiles.forEach((tile,key)=>{

                let xy = this.xy(key);

                if (xy.x < this.left)
                    this.left = xy.x;
                if (xy.y < this.top)
                    this.top = xy.y;
                if (xy.x > this.right)
                    this.right = xy.x;
                if (xy.y > this.bottom)
                    this.bottom = xy.y;

            }
            );

            return {
                left: this.left,
                top: this.top,
                bottom: this.bottom,
                right: this.right
            };

        },

        getSub: function(x, y) {

            let id = this.id(x, y);

            return this.mask.get(id) || 0;

        },

        setSub: function(x, y, value) {

            let id = this.id(x, y);

            return this.mask.set(id, value);

        },

        getSubTile: function(x, y) {

            let id = this.id(x, y);

            return this.ref.get(id) || 0;

        },

        getSubAbs: function(x, y) {

            x = Math.floor(x / COMMON.SUBTILE_WIDTH);
            y = Math.floor(y / COMMON.SUBTILE_HEIGHT);

            let id = this.id(x, y);

            return this.mask.get(id) || 0;

        },

        /* Game logic */

        hitTile(tile, object) {

            if (!tile.wall)
                return;

            if (!tile.wallDef.health) {

                tile.data.health -= 50;

                if (tile.data.health <= 0)
                    this.replaceLayer(tile, "wall", tile.wallDef.ondestroy);

            }
            ;
            if (tile.wallDef.resource === object.key) {
            }
            ;

        },

        clearMaskAtTile(tile) {

            let mask = tile.mask;

            for (var i = 0; i < mask.length; i += 3) {

                let ox = mask[i + 0];
                let oy = mask[i + 1];

                let value = mask[i + 2];

                let sx = tile.x * 4 + ox;
                let sy = tile.y * 4 + oy;

                let id = this.id(sx, sy);

                let tx = Math.floor(sx / 4);
                let ty = Math.floor(sy / 4);

                this.mask.delete(id);
                this.ref.delete(id);

            }

            for (var i = -1; i <= 1; i++) {
                for (var j = -1; j <= 1; j++) {

                    this.tilesToRefresh.push(tile.x + i, tile.y + j);

                }
            }

        },

        refreshTile(tx, ty) {

            let tile = this.get(tx, ty);

            if (!tile)
                return;

            let ground = null;
            let wall = null;
            let semi = null;
            let mask = [];

            if (tile.ground)
                ground = this.tileset.tiles[tile.ground];
            if (tile.semi)
                semi = this.tileset.tiles[tile.semi];
            if (tile.wall)
                wall = this.tileset.tiles[tile.wall];

            if (ground)
                NAMESPACE.PositionalArray.union(mask, ground.mask);
            if (semi)
                NAMESPACE.PositionalArray.union(mask, semi.mask);
            if (wall)
                NAMESPACE.PositionalArray.union(mask, wall.mask);

            tile.mask = mask;

            tile.wallDef = wall;
            tile.groundDef = ground;
            tile.semiDef = semi;

            if (!tile.data) {

                tile.data = {};

            }

            for (var i = 0; i < mask.length; i += 3) {

                let ox = mask[i + 0];
                let oy = mask[i + 1];

                let value = mask[i + 2];

                let sx = tx * 4 + ox;
                let sy = ty * 4 + oy;

                let id = this.id(sx, sy);

                let current = this.mask.get(id) | 0;

                let next = this.resolveMaskImportance(current, value);

                if (next === current)
                    continue;

                // if (current > value) continue;

                this.mask.set(id, next);
                this.ref.set(id, tile);

            }

        },

        resolveMaskImportance(a, b) {

            if ((a === 1 && b === 3) || (a === 3 && b === 1))
                return 1;

            return Math.max(a, b);

        },

        refresh() {

            for (var i = 0; i < this.tilesToRefresh.length; i += 2) {

                let tx = this.tilesToRefresh[i];
                let ty = this.tilesToRefresh[i + 1];

                this.refreshTile(tx, ty);

            }

            this.tilesToRefresh.length = 0;

        },

        replaceLayer(tile, layer, key) {

            if (typeof key === "string")
                key = this.findTileByID(key).key;

            this.clearMaskAtTile(tile);

            tile.wall = key;
            tile.wallDef = this.tileset.tiles[tile.wall];

            this.game.enqueue("mapReplaceTile", {
                layer: "wall",
                x: tile.x,
                y: tile.y,
                key: key
            });

            this.refresh();

        }

    };

    if (typeof exports !== "undefined") {

        module.exports = InfiniteMap;

    }

    if (typeof NAMESPACE !== "undefined") {

        NAMESPACE.InfiniteMap = InfiniteMap;

    }

}

/* file: common/modules/Tileset.js */

NAMESPACE.Tileset = class {

    constructor() {

        this.tiles = {};
        this.palettes = [];
        this.imagesCount = 0;
        this.tileIndex = 0;
        this.ready = true;
        this.emptyTile = {};

    }

    unserialize(raw) {

        if (typeof raw === "string") {

            var temp = JSON.parse(raw);

        } else {

            temp = raw;

        }

        this.tileIndex = temp.tileIndex;
        this.tiles = temp.tiles;
        this.imagesCount = temp.imagesCount;
        this.ready = false;

    }

}
;

/* file: common/modules/Components.js */

NAMESPACE.Components = function(subject) {

    this.subject = subject;
    this.components = [];

}
;

NAMESPACE.Components.prototype = {

    call(method, a, b, c) {

        let result = false;

        for (var i = 0; i < this.components.length; i++) {

            let component = this.components[i];

            if (component[method]) {

                result = result || component[method](a, b, c);

            }

        }

        return result;

    },

    fromArray(array) {

        for (var i = 0; i < array.length; i++) {

            let info = array[i];

            let component = new NAMESPACE.Components[info.component];

            component.subject = this.subject;
            component.data = info;

            if (component.create)
                component.create();

            this.components.push(component);

        }

    }

};

/* file: motiongraphics/goal/index.js */

NAMESPACE.MotionGraphics.goal1 = function(config={
    path: ""
}) {

    let path = config.path;

    let motion = new Motion(config);

    motion.rate = config.rate || 1.0;

    motion.loadFont("geometos", path + "geometos.ttf")

    function sunbeamExplosion(x=0, y=0, count=8, scale=0.1, innerRadius=0.15) {

        let angleStep = Math.PI * 2 / count;
        let w = 4.0 / count;

        for (let i = 0; i < count; i++) {

            let angle = Math.PI * 0.5 + i * angleStep;

            let rect = {
                zIndex: 1,
                x: x + Math.cos(angle) * innerRadius,
                y: y + Math.sin(angle) * innerRadius,
                h: 0,
                scale: scale,
                rotation: angle,
                render(ctx) {
                    ctx.fillStyle = "#fff"
                    ctx.fillRect(-1.0, -w / 2, 2.0 * this.h, w);
                }

            };

            let delay = Math.random() * 0.2;

            motion.tween(rect).delay(delay).to({
                x: rect.x + Math.cos(angle) * innerRadius,
                y: rect.y + Math.sin(angle) * innerRadius,
            }, 0.5, "outElastic");

            motion.tween(rect).delay(delay).to({
                h: 1.0
            }, 0.1).to({
                h: 0
            }, 0.4, "inQuad");

            motion.add(rect);

        }

    }
    ;
    let attacker = motion.add(new Motion.Text({
        text: config.playerText || "config.playerText",
        font: "geometos",
        color: "#ff8",
        scale: 0.1,
        y: 0.4,
        x: motion.left,
        alpha: 1.0
    }));

    motion.tween(attacker).delay(0.5).to({
        x: 0
    }, 0.2, "inQuad").delay(1.0).to({
        alpha: 0
    }, 0.5);

    motion.wait(0.5).schedule({
        step() {

            let text = motion.add(new Motion.Rect({
                y: attacker.y + 0.05,
                x: attacker.x,
                scaleY: 0.02,
                color: attacker.color
            }));

            motion.tween(text).to({
                alpha: 0.0
            }, 0.5).call("remove");
        }
    }, 0.3).schedule(function() {

        let text = motion.add(new Motion.Text({
            zIndex: 0,
            text: attacker.text,
            font: attacker.font,
            scale: attacker.scale,
            color: "#000",
            y: attacker.y,
            x: attacker.x,
            alpha: 1.0
        }));

        motion.tween(text).to({
            alpha: 0
        }, 0.2).call("remove");
        ;

    });

    let letters = ["g", "o", "a", "l", "exclamation"];
    let letterObjects = {};

    for (let i = 0; i < letters.length; i++) {

        let letter = letters[i];

        let space = 2.0 / 5;

        let letterObject = new Motion.SVG({
            src: path + letter + ".svg",
            x: -1.0 + space * (i + 1),
            y: 0,
            rotation: 0,
            scale: 0.0,
            zIndex: 2
        });
        let letterShadow = new Motion.SVG({
            src: path + letter + ".svg",
            x: -1.0 + space * (i + 1),
            y: 0,
            rotation: 0,
            scale: 0.0
        });

        letterShadow.query((svg)=>{

            for (let node of svg.querySelectorAll("*")) {

                node.setAttribute("fill", "#004");

            }

        }
        );

        motion.add(new Motion.Tracker(letterObject,letterShadow,{
            x: true,
            y: {
                offset: 0.025
            },
            scale: true,
            rotation: true,
            zIndex: {
                offset: -1
            }
        }));

        var object = letterObject;

        motion.add(letterObject);
        motion.add(letterShadow);

        letterObjects[letter] = object;

        if (letter === "o") {

            motion.tween(object).delay(i * 0.1).to({
                rotation: 6.28,
                scale: 0.15
            }, 1.0, "outQuad");

            let incomingBallShadow = new Motion.Circle({
                x: letterObject.x,
                y: letterObject.y,
                alpha: 0.0,
                scaleY: 0.9
            });

            motion.add(incomingBallShadow);
            motion.tween(incomingBallShadow).to({
                scale: 0,
                alpha: 0.25
            }, 0.7);

        } else {

            motion.tween(object).delay(0.6 + i * 0.1).to({
                rotation: 6.28,
                scale: 0.15
            }, 0.35, "outQuad");

        }

    }

    function shadow(object) {

        let sh = {

            a: 0.0,
            zIndex: -1,

            render(ctx) {

                this.x = object.x;
                this.y = object.y;
                this.scale = object.scale;

                ctx.fillStyle = "#000";
                ctx.globalAlpha = 0.25 * this.a;
                ctx.beginPath();
                ctx.scale(1.25, 1.0);
                ctx.arc(0, 0.5, 1.0, 0, Math.PI * 2);
                ctx.fill();

            }

        };

        motion.tween(sh).to({
            a: 1.0
        }, 0.5)

        motion.add(sh);

    }

    var ball;

    // playSound("ball_kick");
    motion.playSound(path + "flyby").rate(1.5);

    motion
    .wait(0.15).schedule(function() {

        ball = new Motion.SVG({
            x: motion.right + 1.0,
            src: path + "ball.svg",
            scale: 1.0,
            zIndex: 3
        });
        motion.add(ball);

        motion.tween(ball).to({
            x: letterObjects.o.x,
            rotation: 12.0,
            scale: 0.12
        }, 0.5);
        motion.tween(letterObjects.o).delay(0.5).to({
            scale: 0.25
        }, 0.1).to({
            scale: 0.15
        }, 0.5, "outBounce");

    })
    .wait(0.5).schedule(function() {

        motion.playSound(path + "audience_cheers");
        motion.playSound(path + "score");

        setTimeout(function() {
            motion.tween(motion).to({
                rate: 1.5
            }, 0.5);

            let x = letterObjects.exclamation.x;
            let y = letterObjects.exclamation.y;
            motion.playSound(path + "whistle").rate(0.75).volume(0.5);
            motion.sustain(()=>{
                letterObjects.exclamation.x = x + (-0.5 + Math.random()) * 0.05;
                letterObjects.exclamation.y = y + (-0.5 + Math.random()) * 0.05;
            }
            , 0.5);
            motion.tween(letterObjects.exclamation).to({
                scaleY: 2.0,
                rotation: -0.5 + "rad"
            }, 0.5).to({
                rotation: "0rad"
            }, 0.25)
        }, 1200);
        motion.playSound(path + "ball_kick");

        sunbeamExplosion(letterObjects.o.x, 0.0, 16);

        function bounce(object, delay) {

            motion.tween(object).delay(delay).to({
                y: object.y + 0.25,
                rotation: 0.5 + "rad"
            }, 0.15).to({
                y: object.y,
                rotation: 0
            }, 1.0, "outElastic");

        }

        bounce(ball, 0);

    })
    .wait(1.0).schedule(function() {

        motion.tween(motion).to({
            rotation: 0.25
        }, 0.5, "outBounce");

        function out(object, delay=0.0) {

            motion.tween(object).delay(delay).to({
                x: motion.right,
                rotation: 20.0
            }, 2.0, "inQuad");

        }

        for (let e of motion.entities) {

            out(ball, 0.1);

        }
    })
    .wait(0.25).schedule(function() {

        shadow(ball);

        function out(object, delay=0.0) {

            motion.tween(object).delay(delay).to({
                scale: 0.0
            }, 0.5);

        }
        let i = 0;
        for (let e of Object.values(letterObjects)) {

            out(e, i * 0.15);
            i++;

        }

    }).wait(2.5).schedule(function() {

        motion.kill();

    });

    return motion;

}
;

/* file: motiongraphics/get_ready_quick/index.js */

NAMESPACE.MotionGraphics.get_ready_quick = function(config={
    path: ""
}) {

    let path = config.path;

    let motion = new Motion(config);

    /* preload */

    motion.loadFont("geometos", path + "geometos.ttf")

    function spawnLetter(char) {

        let letterObject = new Motion.Text({
            font: "geometos",
            scale: 1.0,
            text: char,
            shadow: "#000",
            x: 0
        });

        motion.add(letterObject);

        motion.tween(letterObject).delay(0.25).to({
            scale: 1.0,
            y: 0.0
        }, 0.25, "outBounce").delay(0.25).to({
            scale: 0
        }, 0.1)

        motion.playSound(path + "../sound/countdown_" + char);

        return letterObject;

    }

    /* action */

    let objects = {};

    motion.schedule(function() {

        {

            let letters = "GET READY";
            let i = 0;
            let duration = 0.3;
            let letter_duration = duration / letters.length;
            for (let letter of letters) {

                let space = 2.0 / (letters.length + 1);
                let letterObject = new Motion.Text({
                    font: "geometos",
                    scale: 0,
                    text: letter,
                    shadow: "#000",
                    y: 0.2,
                    x: -1.0 + space * (i + 1)
                });

                motion.add(letterObject);

                motion.tween(letterObject).delay(letter_duration * i).to({
                    scale: 0.25,
                    y: 0.0
                }, 0.25, "outBounce")

                objects[i] = letterObject;
                i++;

            }

        }

        {
            let rect = new Motion.Rect({
                scaleY: 0.1,
                y: -0.2,
                color: "#fff",
                scaleX: 0.28,
                alignX: 1.0,
                x: motion.left
            });
            motion.add(rect);
            motion.tween(rect).to({
                x: -0.32,
                scaleY: 0.025
            }, 0.2, "outQuad");

            motion.playSound(path + "../sound/whoosh_steam_fast");

            objects.rect1 = rect;

        }

        {
            let rect = new Motion.Rect({
                scaleY: 0.1,
                y: 0.2,
                color: "#fff",
                scaleX: 0.48,
                alignX: -1.0,
                x: motion.right
            });
            motion.add(rect);
            motion.tween(rect).delay(0.2).to({
                x: -0.07,
                scaleY: 0.025
            }, 0.2, "outQuad");
            motion.wait(0.2).schedule(function() {

                motion.playSound(path + "../sound/whoosh_steam_fast");

            });

            objects.rect2 = rect;

        }

    })
    .wait(1.0)
    .schedule({

        start() {

            motion.rate *= 1.25;

            let rect = new Motion.Rect({
                scaleY: 0.2,
                x: motion.left,
                color: "#fff",
                alignX: 1.0,
                y: -0.5
            });

            motion.tween(rect).to({
                x: motion.right + 2.0,
                scaleY: 0.1
            }, 0.25)

            motion.add(rect);

            /* Remove get ready */

            let duration = 0.25;

            motion.tween(objects.rect1).to({
                y: motion.top - 0.5
            }, duration);

            for (let i = 0; i < 3; i++) {

                motion.tween(objects[i]).delay((i + 1) * 0.05).to({
                    y: motion.top - 0.5
                }, duration);

            }

            motion.tween(objects.rect2).to({
                y: motion.bottom + 0.5
            }, duration);

            for (let i = 0; i < 5; i++) {

                let offset = 8 - i;

                motion.tween(objects[offset]).delay((i + 1) * 0.05).to({
                    y: motion.bottom + 0.5
                }, duration);

            }

            motion.playSound(path + "../sound/whoosh_steam_out");

            {

                let rect = new Motion.Rect({
                    scaleX: 0.1,
                    x: -0.2,
                    color: "#fff",
                    alignY: 1.0,
                    y: motion.top
                });

                motion.tween(rect).to({
                    y: motion.bottom + 2.0,
                    scaleX: 0.05
                }, duration)

                motion.add(rect);

            }

            {

                let rect = new Motion.Rect({
                    scaleX: 0.15,
                    x: -0.2,
                    color: "#fff",
                    alignY: -1.0,
                    y: motion.bottom
                });

                motion.tween(rect).delay(0.4).to({
                    y: motion.top - 2.0,
                    scaleX: 0.25
                }, duration)

                motion.add(rect);

            }

        }

    }, 2.42)
    .schedule({

        step() {

            this.go.rotation = (-1.0 + 2.0 * Math.random()) * 0.1;

        },

        start() {

            motion.rate *= 1.25;

            let rect = new Motion.Rect({
                scaleY: 0.2,
                x: motion.left,
                color: "#fff",
                alignX: 1.0,
                y: -0.5
            });

            motion.tween(rect).to({
                x: motion.right + 2.0,
                scaleY: 0.1
            }, 0.25)

            motion.add(rect);

            let letterObject = new Motion.Text({
                font: "geometos",
                scale: 0.6,
                y: -0.5,
                text: "GO!",
                shadow: "#000"
            });

            this.go = letterObject;

            motion.add(letterObject);

            motion.tween(letterObject).delay(0.25).to({
                scale: 0.5
            }, 0.25, "outBounce").delay(0.25).to({
                scale: 0
            }, 0.1)

            motion.playSound(path + "../sound/whistle");
            motion.playSound(path + "../sound/countdown_end");

        }

    }, 0.5)
    .wait(2.0).schedule(()=>{

        motion.kill();

    }
    );

    /* return */

    return motion;

}
;

/* file: motiongraphics/game_over/index.js */

NAMESPACE.MotionGraphics.game_over = function(config={
    progress: 1.0,
    maxScore: 500,
    path: "",
    victory: false
}) {

    function gameOver() {

        {

            let letters = config.victory ? "VICTORY" : "GAME OVER";
            let i = 0;
            let duration = 0.3;
            let letter_duration = duration / letters.length;
            for (let letter of letters) {

                let space = 2.0 / (letters.length + 1);
                let letterObject = new Motion.Text({
                    font: "bungee",
                    scale: 0,
                    color: config.victory ? "#fc0" : "#f00",
                    text: letter,
                    shadow: config.victory ? "#fa0" : "#804",
                    y: -0.4,
                    x: -1.0 + space * (i + 1)
                });

                motion.add(letterObject);

                motion.tween(letterObject).delay(letter_duration * i).to({
                    scale: 0.25,
                    y: -0.75
                }, 0.25, "outBounce")

                objects[i] = letterObject;
                i++;

            }

        }

        motion.wait(0.3).schedule(()=>{

            motion.playSound(path + "../sound/shling");

        }
        );

        smudge("right", -0.7, 0.1, config.victory ? "#fc0" : "#f00");
        motion.playSound(path + "../sound/whoosh_steam_out");

    }
    ;
    function smudge(direction="right", pos=0.0, size=0.25, color="#fff", duration=0.2) {

        let rect;

        if (direction === "right") {
            rect = new Motion.Rect({
                scaleY: size,
                y: pos,
                color,
                alignX: 1.0,
                x: motion.left
            });
            motion.tween(rect).to({
                x: motion.right,
                alignX: -1.0,
                scaleY: size * 1.25
            }, duration, "outQuad");
        }

        if (direction === "left") {
            rect = new Motion.Rect({
                scaleY: size,
                y: pos,
                color,
                alignX: -1.0,
                x: motion.right
            });
            motion.tween(rect).to({
                x: motion.left,
                alignX: 1.0,
                scaleY: size * 1.25
            }, duration, "outQuad");
        }

        if (direction === "up") {
            rect = new Motion.Rect({
                scaleX: size,
                x: pos,
                color,
                alignY: 1.0,
                y: motion.top
            });
            motion.tween(rect).to({
                y: motion.bottom,
                alignY: -1.0,
                scaleX: size * 1.25
            }, duration, "outQuad");
        }

        if (direction === "down") {
            rect = new Motion.Rect({
                scaleX: size,
                x: pos,
                color,
                alignY: -1.0,
                y: motion.bottom
            });
            motion.tween(rect).to({
                y: motion.top,
                alignY: 1.0,
                scaleX: size * 1.25
            }, duration, "outQuad");
        }

        motion.add(rect);

    }

    let ProgressBar = class extends Motion.Entity {

        constructor(args) {

            super(args);

            Object.assign(this, args);

            this.progress = 0.0;

            this.image1 = new Image;
            this.image1.addEventListener("load", this.onLoad.bind(this));
            this.image1.src = path + "score_bar.png";

            this.image2 = new Image;
            this.image2.addEventListener("load", this.onLoad.bind(this));
            this.image2.src = path + "score_bar_progress.png";

            this.ready = -2;

        }

        onLoad() {

            this.ready++;

            if (this.ready >= 0) {
                this.canvas = document.createElement("Canvas");
                this.canvas.width = this.image1.width;
                this.canvas.height = this.image1.height;
                this.ctx = this.canvas.getContext("2d");
            }

        }

        render(ctx) {

            if (this.ready < 0)
                return;

            this.ctx.imageSmoothingEnabled = false;
            this.ctx.drawImage(this.image1, 0, 0);
            this.ctx.beginPath();
            this.ctx.save();
            this.ctx.translate(95, 24)
            this.ctx.rect(0, 0, this.image2.width * this.progress, 50);
            this.ctx.clip();
            this.ctx.drawImage(this.image2, 0, 0);
            this.ctx.restore();

            let ar = this.canvas.height / this.canvas.width;

            ctx.scale(1.0, ar);
            ctx.drawImage(this.canvas, 0, 0, this.canvas.width, this.canvas.height, -1.0, -1.0, 2.0, 2.0);

        }

    }
    ;

    let path = config.path;

    let motion = new Motion(config);

    /* preload */

    motion.loadFont("bungee", path + "../fonts/bungee.ttf")

    /* action */

    let objects = {};

    starsPoked = false;

    let scoreText = new Motion.Text({
        text: "0",
        scale: 0.25,
        "font": "bungee",
        y: 0.25,
        color: "#fff"
    });
    motion.add(scoreText);

    let scoreBar = new ProgressBar({
        src: path + "score_bar.png"
    });

    motion.add(scoreBar);

    let starPlaceholders = [];
    let stars = [];

    for (let i = 0; i < 5; i++) {

        let star = new Motion.SVG({
            src: path + "../svg/empty-star.svg"
        });

        star.scale = 0.0;
        star.y = -0.26;
        star.x = -0.64 + i * 0.32;
        starPlaceholders.push(star);

        motion.add(star);

    }

    let lastStar = 0.0;

    motion.schedule(function() {
        gameOver();

        scoreText.alignX = -1.0;
        scoreText.x = motion.right;

        scoreBar.x = motion.left;
        scoreBar.alignX = 1.0;
        scoreBar.scaleY = -1.0;

    }, 1.0).schedule({

        start(program) {

            motion.tween(scoreText).to({
                x: scoreText.x,
                alignX: 0,
                x: -0.8
            }, program.duration, "outElastic")

            smudge("right", scoreBar.y, 0.1, "#cbdbfc", 0.25);
            smudge("left", scoreText.y, 0.1, "#fff", 0.25);
            motion.playSound(path + "../sound/whoosh_steam_out");
            motion.playSound(path + "../sound/sword_draw");

            motion.tween(scoreBar).to({
                x: -0.36,
                alignX: 0,
                rotation: 0,
                scaleY: 1.0
            }, program.duration, "outElastic")

            for (let i = 0; i < starPlaceholders.length; i++) {

                let star = starPlaceholders[i];

                motion.tween(star).delay(i * 0.15).to({
                    scale: 0.06
                }, program.duration, "outElastic");

                motion.wait(i * 0.15).schedule(function() {

                    motion.playSound(path + "../sound/click1");

                })

            }

        }

    }, 0.6)
    .schedule({

        start() {

            if (config.victory) {

                motion.playSound(path + "../sound/drum_roll");

            }

        },

        step(program) {

            scoreBar.progress = config.progress * Motion.ease(program.progress, "outCirc");
            scoreText.text = String(scoreBar.progress * config.maxScore | 0);
            scoreText.x = -0.8 + scoreBar.progress * 1.5 + Math.sin(program.progress * 40) * 0.05;
            let step = 1.0 / 5;

            if (program.progress > 0.9 && !starsPoked) {

                starsPoked = true;

                for (let i = 0; i < stars.length; i++) {

                    let star = stars[i];

                    motion.tween(star).delay(i * 0.05).to({
                        scale: 0.3,
                        rotation: 1.22
                    }, 0.2, "inQuad").to({
                        scale: 0.15
                    }, 1.0, "outElastic");

                }
            }

            if ((scoreBar.progress * 100 | 0) >= ((lastStar + step) * 100 | 0)) {

                program.delay = 0.2;

                let i = (10 * scoreBar.progress / step | 0) / 10 - 1 | 0;

                lastStar = (i + 1) * step;

                let star = new Motion.SVG({
                    src: path + "../svg/star.svg"
                });
                let placeholder = starPlaceholders[i];
                star.x = placeholder.x;
                star.y = placeholder.y;
                star.rotation = -1;
                star.scale = 1.0;
                star.saturation = 0.25 + i * 0.25;

                motion.tween(star).to({
                    rotation: 0.0,
                    y: placeholder.y
                }, 0.4, "outQuad")
                motion.tween(star).to({
                    scale: 1 / 7
                }, 0.2, "outQuad")

                motion.tween(scoreText).to({
                    scale: 0.4
                }, 0.1, "outQuad").to({
                    scale: 0.25
                }, 0.4, "outElastic");

                motion.playSound(path + "../sound/score" + (i + 1));
                motion.add(star);
                stars.push(star);

            }

            let blood = new Motion.SVG({
                src: path + "../svg/blood.svg"
            });

            blood.scale = 0.01 + Math.random() * 0.03;
            blood.x = -1.0 + scoreBar.progress * 1.5 + Math.random() * 0.1;
            blood.y = 0.0 - Math.random() * 0.25;
            blood.zIndex = -1;

            motion.add(blood);

            motion.tween(blood).to({
                y: blood.y - 0.1,
                zIndex: 0
            }, 0.15, "outQuad").to({
                y: motion.bottom,
                alignY: -1.0,
                scaleY: 3.0
            }, 0.1 + Math.random() * 0.4, "inQuad")

        }

    }, Math.max(0.25, config.progress * 1.25))
    .schedule(function() {

        /*let viking = new Motion.SVG({ src: path + "viking2.svg" });


            viking.alignX = 1.0;
            viking.alignY = -1.0;
            viking.x = motion.right;
            viking.y = motion.bottom;
            viking.scale = 0.5;

            motion.tween(viking).to({
                alignY: 0.9
            }, 0.3, "outBounce");

            motion.add(viking);
*/

        let texts = {
            0: ["Next time you will do better", "C'mon I believe in you", "Try again"],
            1: ["Keep trying", "You deserve more than that", "C'mon I believe in you", "Try again"],
            2: ["You can do better", "Almost a mediocre warrior", "Make your clan proud"],
            3: ["Not bad", "You are improving", "Now get that fourth star"],
            4: ["Good one! So close.", "Well played! Almost there.", "You can reach 5 stars"],
            5: ["Barbaric play My Lord!", "Glorious and victorious!", "You lived like a king!"]
        }[stars.length];

        let text = texts[Math.random() * texts.length | 0];
        let congratulations = new Motion.Text({
            text: text,
            shadow: "#663931",
            scale: 0.1,
            "font": "bungee",
            y: 0.5,
            color: "#8f563b",
            x: motion.right,
            alignX: -1.0
        });

        motion.tween(congratulations).to({
            alignX: 0,
            x: 0
        }, 0.2);

        smudge("left", congratulations.y, 0.1, "#df7126");
        motion.add(congratulations);
        motion.playSound(path + "../sound/victory_growls/" + stars.length);

        let lastStar = stars[stars.length - 1];

        motion.tween(scoreText).to({
            x: 0
        }, 0.5, "outElastic")

        // motion.tween(lastStar).discard().to({ scale: 0.3, rotation: 0 }, 0.3, "outQuad");

        if (config.victory) {

            // motion.playSound(path + "../sound/ooh");
            motion.playSound(path + "../sound/drum");
        }

    })

    /*        .wait(2.0).schedule(() => {

                motion.kill();

            });

            */

    /* return */

    return motion;

}
;

/* file: motiongraphics/victory/index.js */

NAMESPACE.MotionGraphics.victory = function(config={
    path: ""
}) {

    let path = config.path;

    let motion = new Motion(config);

    /* preload */

    motion.loadFont("bungee", path + "../fonts/bungee.ttf")

    /* action */

    let objects = {};

    motion.schedule(function() {

        {

            let letters = "VICTORY";
            let i = 0;
            let duration = 0.3;
            let letter_duration = duration / letters.length;
            for (let letter of letters) {

                let space = 2.0 / (letters.length + 1);
                let letterObject = new Motion.Text({
                    font: "bungee",
                    scale: 0,
                    color: "#fc0",
                    text: letter,
                    shadow: "#fa0",
                    y: -0.4,
                    x: -1.0 + space * (i + 1)
                });

                motion.add(letterObject);

                motion.tween(letterObject).delay(letter_duration * i).to({
                    scale: 0.25,
                    y: -0.75
                }, 0.25, "outBounce")

                objects[i] = letterObject;
                i++;

            }

        }

        {
            let rect = new Motion.Rect({
                scaleY: 0.1,
                y: -0.75,
                color: "#fc0",
                scaleX: 1.0,
                alignX: 1.0,
                x: motion.left
            });
            motion.add(rect);
            motion.tween(rect).to({
                x: motion.right,
                alignX: -1.0,
                scaleY: 0.25
            }, 0.2, "outQuad");

            // motion.playSound(path + "../sound/whoosh_steam_fast");
            motion.playSound(path + "../sound/whoosh_steam_out");
            motion.playSound(path + "../sound/drum_roll");
            motion.playSound(path + "../sound/ooh");

            motion.wait(2.1).schedule(()=>{
                motion.playSound(path + "../sound/drum");
            }
            );

            objects.rect1 = rect;

        }

    })
    .wait(2.0)
    .schedule({

        start() {

            motion.rate *= 1.0;

            /* Remove get ready */

            let duration = 0.25;

            for (let i = 0; i < 7; i++) {

                motion.tween(objects[i]).delay(0.3 - (i + 1) * 0.05).to({
                    y: motion.top - 0.5
                }, duration);

            }

            {
                let rect = new Motion.Rect({
                    scaleY: 0.25,
                    y: -0.75,
                    color: "#fa0",
                    scaleX: 1.0,
                    alignX: 0.0,
                    x: motion.right
                });
                motion.add(rect);
                motion.tween(rect).to({
                    x: motion.left,
                    alignX: 1.0,
                    scaleY: 0.0
                }, 0.35, "linear");

            }

        }
    }, 2.42)
    .schedule({

        step() {
        },

        start() {
        }

    }, 0.5)
    .wait(2.0).schedule(()=>{

        motion.kill();

    }
    );

    /* return */

    return motion;

}
;

/* file: script/ui/UI.js */

UI = {};

UI.fitWindow = function(element) {

    let $element = $(element);

    setTimeout(function() {

        if ($element.outerHeight() > window.innerHeight) {

            var scale = window.innerHeight / ($element.outerHeight() + 32);

            $element.css("transform", `translate(-50%, -50%) scale(${scale})`);

            console.log("SCALE IS", scale)
            console.log($element)

        }

    }, 1000);

}
;

UI.div = document.createElement("div");

UI.html = function(html) {

    this.div.innerHTML = html;

    return this.div.children[0];

}
;

UI.moveToEnd = function(element) {

    $(element).parent().append(element);

}
;

UI.bb = function(text) {

    let find = /{(.*?)}/g;

    return text.replace(find, function(match, sub) {

        let params = sub.split(",");

        let command = params[0];
        let args = params.slice(1);

        switch (command) {

        case "input":

            return app.getInputHTML(args[0]);

            break;

        }

        return ""

    });

}
;

UI.titleBar = function($parent, title, handler) {

    handler = handler || {};
    handler.close = handler.close || function() {
        $parent.remove();
    }

    let $bar = $("<div>").addClass("gui-title-bar gui-cols");
    let $title = $("<div>").addClass("title", "grow").html(title);
    let $close = $("<div>").addClass("gui-button").html("X");

    $title.appendTo($bar);
    $close.appendTo($bar);
    $bar.appendTo($parent);

    $close.on("click touchstart", handler.close.bind(handler));

    $parent.toggleClass("title-bar", true);

    $bar.enhance();
}
;

UI.showFirst = function(first, ...rest) {

    $(first).show();

    for (let e of rest)
        $(e).hide();

    this.moveToEnd(first);

}
;

UI.toggles = function($element, value, callback) {

    var $buttons = $element.children();

    let $active = $element.children("[ui-value=" + value + "]");

    $active.addClass("active");

    $buttons.toggleClass("gui-clickable", true);

    $buttons.enhance();

    $buttons.on("click touchstart", function() {

        var $this = $(this);

        $buttons.removeClass("active");

        $this.addClass("active");

        if (callback) {

            let value = $this.attr("ui-value");

            if ($this.parent().attr("ui-type") === "number")
                value = parseFloat(value);

            callback(value, $this.html());

        }

    });

    callback(value, $active.html());

}
;

UI.toggles.val = function($toggles, value) {

    let $active = $toggles.children("[ui-value=" + value + "]");

    $active.click();

}
;

UI.cycle = function($button, currentValue, callback) {

    $button.children().hide();

    $button.children(`[ui-value=${currentValue}]`).show();

    $button.on("click touchend", ()=>{

        let $current = $button.children(`[ui-value=${currentValue}]`);

        let $next = $current.next();

        if (!$next.length)
            $next = $button.children().first();

        $current.hide();
        $next.show();

        currentValue = $next.attr("ui-value");

        callback(currentValue);

    }
    );

}
;

UI.select = function($toggles, currentValue, callback) {

    let $select = $("<div>").addClass("gui-select");

    let $current = $("<div>").addClass("value");

    $select.append($current);

    $toggles.before($select);

    $select.append($toggles);

    let onChange = (newValue,html)=>{

        $current.html(html)

        callback(newValue);

        $toggles.hide();

    }
    ;

    this.toggles($toggles, currentValue, onChange);

    $select.on("mousedown pointerdown", ()=>{

        $toggles.show();

    }
    );

    $select.addClass("grow");

    onChange(currentValue);

}
;

UI.select.val = function($select, value) {

    UI.toggles.val($select, value);

}
;

UI.icon = function(src, region) {

    var $icon = $("<span>");

    $icon.css("display", "inline-block");
    $icon.css("width", region[2]);
    $icon.css("height", region[3]);
    $icon.css("background", "url(" + src + ") no-repeat");
    $icon.css("background-position", (-region[0]) + "px -" + region[1] + "px");

    return $icon;

}
;

UI.getRankIcon = function(i) {

    var region = COMMON.RANK_ICONS[i];

    var $icon = $("<span>");

    $icon.css("display", "inline-block");
    $icon.css("width", region[2]);
    $icon.css("height", region[3]);
    $icon.css("background", "url(images/rank_icons.png) no-repeat");
    $icon.css("background-position", (-region[0]) + "px -" + region[1] + "px");

    return $icon;

}
;

UI.parse = function(html, handlers) {

    html = html.replace(/{lang:(.*)}/g, function(full, key) {

        return app.lang(key);

    });

    handlers = handlers || {};

    var div = document.createElement("div");
    var $div = $(div);

    div.innerHTML = html;

    if ($div.children().length === 1)
        var $container = $div.children();
    else
        var $container = $div;

    $div.find("[ui-id]").each(function() {

        var id = $(this).attr("ui-id");

        $container["$" + id] = $(this);
        if (handlers)
            handlers["$" + id] = $(this);

        var handler = handlers["on" + Utils.ucfirst(id) + "Click"];

        if (handler)
            $(this).on("click touchstart", handler.bind(handlers));

    });

    $div.find("[ui-insert]").each(function() {

        var $this = $(this);

        var id = $this.attr("ui-insert");

        $this.append($container["$" + id]);

    });

    $div.find("[ui-replace]").each(function() {

        var $this = $(this);

        var id = $this.attr("ui-replace");

        $this.after($container["$" + id]);
        $this.remove();

    });

    return $container;

}
;

UI.parse2 = function(element, result={}) {

    if (typeof element === "string")
        element = this.html(element);

    result.element = element;

    let children = result.element.querySelectorAll("[data-id]");

    for (let child of children) {

        let id = child.dataset.id;

        result[id] = child;

    }

    return result;
}
;

UI.killer = function(widget) {

    if (!Utils.interval(app, "UIKILL", 0.1))
        return;

    var current = widget.$element.get(0);
    var parent = null;

    while (current) {

        current = current.parentElement;

        if (current)
            parent = current;

    }

    if (!parent || parent.nodeName !== "HTML") {

        widget.kill();

    }

}
;

UI.killwatch = function(widget) {

    setInterval(function() {

        UI.killer(widget);

    }, 1000);

}
;

UI.toggle = function(element, state) {

    state ? $(element).show() : $(element).hide();

}
;

UI.hide = function(element) {

    $(element).hide();

}
;

UI.show = function(element) {

    $(element).show();

}
;

UI.replace = function(a, b) {

    $(a).before(b);
    $(a).remove();

}
;

UI.on = function(element, events, callback) {

    let events_array = events;

    if (typeof events === "string")
        events_array = events.split(",");

    for (let event of events_array) {

        element.addEventListener(event.trim(), callback);

    }

    return callback;

}
,

UI.getFlag = function(flag) {

    var index = COMMON.COUNTRY_INDEX[flag];

    var cx = -12 * (index % 20);
    var cy = -8 * (index / 20 | 0);

    var $flag = $("<span>").addClass("flag");

    $flag.css({
        backgroundImage: "url(images/flags/all.png)",
        backgroundPosition: cx + "px " + cy + "px",
        width: 12,
        height: 8
    });

    return $flag;

}

UI.$inspector = $("<div>").appendTo("body").addClass("gui-inspector");

UI.inspect = function($element) {

    if (!$element)
        return UI.$inspector.hide();

    $element = $($element);

    let element = $element[0];

    UI.$inspector.empty();

    UI.$inspector.css({
        left: element.offsetLeft + "px",
        top: (element.offsetTop + element.offsetHeight) + "px",
        width: element.offsetWidth + "px"
    });

    UI.$inspector.show();

    return UI.$inspector;

}

UI.clipboard = function(element) {

    let $element = $(element);

    let clipboard = new Clipboard($element[0],{
        target: ()=>{

            return $element[0]

        }
    });

    clipboard.on("success", ()=>{

        let tooltip = new Opentip($element,"Link coppied to clipboard");

        tooltip.show();

        setTimeout(function() {

            tooltip.deactivate();

        }, 2000);

    }
    );

}

UI.checkbox = function($checkbox, value, callback) {

    $checkbox.addClass("gui-checkbox").data("callback", callback);

    $checkbox.on("click touchstart", this.onCheckboxClick.bind(this, $checkbox));

    this.updateCheckbox($checkbox, Boolean(value));

    return $checkbox;

}
;

UI.onCheckboxClick = function($checkbox) {

    let key = $checkbox.data("key");

    let callback = $checkbox.data("callback");

    this.updateCheckbox($checkbox);

    callback($checkbox.hasClass("checked"));

}
;

UI.updateCheckbox = function($checkbox, value) {

    let key = $checkbox.data("key");

    let current = $checkbox.hasClass("checked");

    if (value === undefined)
        value = !current;

    $checkbox.toggleClass("checked", value);

}
;

UI.popup = function(title, text) {

    let $popup = $(`<div class="popup window center-window gui-cols spacing-md ui">
        <p>${text}</p></div>`);

    UI.titleBar($popup, title, {
        close() {
            $popup.remove()
        }
    });

    $popup.appendTo(document.body);

    return $popup;

}
;

UI.window = function(title, text) {

    let $popup = $(`<div class="window full-window gui-cols spacing-md ui style-1">${text}</div>`);

    UI.titleBar($popup, title, {
        close() {
            $popup.remove()
        }
    });

    $popup.appendTo(document.body);

    return $popup;

}
;

UI.iframeWindow = function(title, text) {

    let $popup = $(`<div class="window iframe-window gui-flex spacing-md ui style-1">${text}</div>`);

    UI.titleBar($popup, title, {
        close() {
            $popup.remove()
        }
    });

    $popup.appendTo(document.body);

    return $popup;

}
;

UI.animateCount = function(element, options) {

    let $element = $(element);
    let $counter = $(element);

    options = options || {};

    if (options.counter)
        $counter = $element.find(options.counter);

    $counter.html(options.from);

    if (options.from === undefined)
        options.value = $counter.html() | 0;
    else
        options.value = options.from;

    let prev = options.value;
    let lastClick = prev;

    let clickDistance = Math.max(1, Math.abs(options.value - options.to) / 50);

    let prevTween = $element.data("tween");

    if (prevTween)
        prevTween.stop();

    var tween = app.tween(options).to({
        value: options.to
    }, options.duration || 0, "outQuad");

    $element.data("tween", tween);

    $element.css("display", "block")

    tween.on("step", function(e) {

        if (Math.abs(lastClick - options.value) > clickDistance) {

            app.sound.play("ui/coin");

            lastClick = options.value;

        }

        $counter.html(options.value | 0);

        prev = options.value;

    });

    tween.on("finish", function() {

        app.sound.play("ui/coin").rate("0.7");

        $element.animate({
            scale: 2.0
        }, 0.5)

    });

}
;

/* file: script/ui/Sprite.js */

UI.Sprite = function(args) {

    this.sprite = args.sprite;

    this.offsetY = args.offsetY || 0;
    this.lastTick = Date.now();
    this.parent = $(args.parent);
    this.paused = false;

    this.width = args.width;
    this.height = args.height;
    this.lifetime = 0;
    this.rotation = args.rotation;
    this.palette = args.palette !== undefined ? args.palette : -1;
    this.spin = args.spin || 0;

    if (!args.width) {

        this.width = this.parent.innerWidth();
        this.height = this.parent.innerHeight();

    }

    this.scale = args.scale || 1.0;

    this.layer = cq(this.width, this.height);
    this.canvas = this.layer.canvas

    if (args.parent)
        this.layer.appendTo(this.parent.get(0));

    this.$widget = this.$element = $(this.layer.canvas);

    if (args.spin)
        this.sprite.spin = args.spin;

    app.on("offscreen", this.offscreenHandler = this.step.bind(this));

}
;

UI.Sprite.prototype = {

    kill: function() {

        app.off("offscreen", this.offscreenHandler);

    },

    step: function() {

        if (!this.$element[0].offsetParent)
            return;
        if (!app.sprites[this.sprite])
            return app.loadSprite(this.sprite);
        if (this.paused && this.renderedOnce)
            return;

        this.renderedOnce = true;

        var dt = app.elapsed;

        this.lifetime += dt;

        if (this.rotation && Utils.interval(this, "rotation", 0.1)) {
        // this.sprite.row = (this.sprite.row + 1) % 16;

        }

        // this.sprite.render(this.layer, this.layer.width / 2 | 0, this.layer.height / 2 + this.offsetY | 0);

        // if (!this.element.offsetParent) return;

        // if (!this.paletteTexture) return;

        UI.killer(this);

        this.offscreen();
    },

    offscreen() {

        let gl = app.gl;

        gl.clearColor(0.0, 0.0, 0.0, 0.0);
        gl.colorMask(1.0, 1.0, 1.0, 1.0);
        gl.clear(gl.COLOR_BUFFER_BIT);

        app.painter.reset();

        app.painter.drawImage(app.textures.tile_desert, 0, 0);
        app.painter.palette(this.palette);
        // app.painter.paletteTexture(this.paletteTexture);
        app.painter.scale(this.scale, this.scale);
        app.painter.drawSprite(this.sprite, this.canvas.width / 2, this.canvas.height / 2, app.lifetime * 16, app.lifetime * this.spin);

        // if (this.spin) this.row = this.data.rows * (this.lifetime % this.spin) / this.spin | 0;

        this.layer.clear();
        this.layer.drawImage(app.canvas, 0, 0);
    }

};

/* file: script/ui/PatreonBox.js */

UI.PatreonBox = function() {

    this.ui = UI.parse2(`
        <div class="gui-rows outgoing-link PatreonBox">
            <p data-id="text">Get access to premium items and display a patron badge</p>
            <a data-id="button" class='gui-button'>Become a Patron</a>
            <span data-id="label" class='gui-label'>Become a Patron</span>
         </div>`);

    this.element = this.ui.element;

    $(this.element).enhance();

    app.emitter.on("update_user_data", this.update.bind(this));

    this.states.NoPatreon.href = Utils.urlTemplate(this.patreonURI, {
        redirect_url: this.patreon_redirect_uri
    });

    $(this.ui.button).on("click touchstart", this.onButtonClick.bind(this));

    this.update();

}
;

UI.PatreonBox.prototype = {

    patreonURI: "https://www.patreon.com/oauth2/authorize?response_type=code&scope=identity+campaigns.members&client_id=wQ-sNpVEdIdgrNr4SuJ17SEr_aZF1vzObb-xLA2Tsffno7tIkVe0Tg74HgXd_dRO&redirect_uri={redirect_url}",
    patreon_redirect_uri: (window.location.origin + window.location.pathname) + "api/patreon_code/",

    states: {

        NoPatreon: {
            className: "patreon-none",
            text: "Get access to premium items, remove ads and display a patron badge.",
            button: "Become a patron"
        },

        NoPledge: {
            className: "patreon-nopledge",
            text: "Your pledge has expired. Please pick subscription plan.",
            button: "Select tier",
            href: "https://www.patreon.com/join/wildsio"

        },

        Patron: {
            className: "patreon-active",
            text: "Thank you for supporting the game.",
            label: "You are a patron"
        }

    },

    update() {

        if (parseInt(app.user.patreon_id) <= 0)
            this.setState("NoPatreon");
        else if (parseInt(app.user.patreon_id) > 0 && !app.user.patron)
            this.setState("NoPledge");
        else
            this.setState("Patron");

    },

    async onButtonClick() {

        if (this.state === "NoPatreon") {

            app.emitter.once("patreon_code", async function(patreon_code) {

                CLIENT.Lobby.Play.lock();

                await app.lobby.ask("connect_patreon_account", {
                    code: patreon_code
                });

                CLIENT.Lobby.Play.unlock();

            });

        } else if (this.state === "NoPledge") {

            app.emitter.once("visibilitychange", this.onVisibilityChange.bind(this))

            console.log("A");

        }

    },

    setState(state) {

        if (this.state === state)
            return;

        let c = (name,state=true)=>this.element.classList.toggle(name, state);

        for (let key in this.states)
            c(this.states[key].className, false);

        let stateData = this.states[state];

        c(stateData.className, true);

        this.ui.text.innerHTML = stateData.text;

        this.ui.button.innerHTML = stateData.button;
        this.ui.label.innerHTML = stateData.label;

        UI.toggle(this.ui.button, stateData.button);
        UI.toggle(this.ui.label, stateData.label);

        if (stateData.href) {

            console.log("SETTING HREF")

            this.ui.button.setAttribute("href", stateData.href);
            this.ui.button.setAttribute("target", "_blank");

        } else {

            this.ui.button.removeAttribute("href");

        }

        this.state = state;

    },

    onVisibilityChange() {

        app.lobby.send("check_patreon_status");

    }

};

/* file: script/ui/Hero.js */

UI.Hero = function(args) {

    this.parent = $(args.parent);

    this.current = {
        weapon: "",
        helmet: "",
        shield: "",
        cape: "",
        key: "run"
    }

    this.width = args.width;
    this.height = args.height;
    this.lifetime = 0;
    this.rotation = args.rotation;
    this.observe = args.observe;

    if (!args.width) {
    }

    this.scale = args.scale || 1.0;

    this.sprite = new CLIENT.Sprite;
    this.helmet = new CLIENT.Sprite;
    this.shield = new CLIENT.Sprite;
    this.cape = new CLIENT.Sprite;
    this.weapon = new CLIENT.Sprite;
    this.legs = new CLIENT.Sprite;

    this.sprite.palette = 0;
    this.helmet.palette = 0;
    this.shield.palette = 0;
    this.weapon.palette = 0;
    this.cape.palette = 0;
    this.legs.palette = 0;

    this.sprite.row = 3;
    this.helmet.row = 3;
    this.shield.row = 3;
    this.weapon.row = 3;
    this.cape.row = 3;
    this.legs.row = 3;
    this.layer = cq(10, 10);

    this.layer.appendTo(this.parent.get(0));

    this.$element = $(this.layer.canvas);

    app.on("offscreen", this.offsreenHandler = this.step.bind(this));

    this.resize();

}
;

UI.Hero.prototype = {

    resize() {

        this.width = this.parent.innerWidth();
        this.height = this.parent.innerHeight();
        this.layer.width = this.width;
        this.layer.height = this.height;

        this.sprite.scale = this.scale;
        this.helmet.scale = this.scale;
        this.shield.scale = this.scale;
        this.weapon.scale = this.scale;
        this.cape.scale = this.scale;
        this.legs.scale = this.scale;

    },

    setSprites: function(hero, helmet, weapon, shield, cape, key) {

        key = key || "run";

        this.current.helmet = helmet;
        this.current.weapon = weapon;
        this.current.shield = shield;
        this.current.cape = cape;

        if (helmet !== "no_helmet") {

            this.helmet.set("grunt/" + helmet + "_" + key, true);
            this.helmet.show();

        } else {

            this.helmet.hide();
        }

        if (cape !== "no_cape") {

            this.cape.set("grunt/" + cape + "_" + key, true);
            this.cape.show();

        } else {

            this.cape.hide();

        }

        this.sprite.set(hero + "/" + "" + key, true);
        this.weapon.set("grunt/" + weapon + "_" + key, true);
        if (shield !== "no_shield") {
            this.shield.show();
            this.shield.set("grunt/" + shield + "_" + key, true);
        } else {
            this.shield.hide();
        }
        this.legs.set("grunt/male/legs_run", true);

    },

    kill: function() {

        app.off("offscreen", this.offsreenHandler);

    },

    step: function() {

        if (!this.$element[0].offsetParent)
            return;

        if (this.observe) {

            if (this.observe.weapon !== this.current.weapon || this.observe.shield !== this.current.shield || this.observe.helmet !== this.current.helmet || this.observe.gender !== this.current.gender || this.observe.cape !== this.current.cape) {

                this.setSprites(this.observe.gender ? "grunt/female" : "grunt/male", this.observe.helmet, this.observe.weapon, this.observe.shield, this.observe.cape, this.observe.key);

                this.current.gender = this.observe.gender;

            }

        }

        var dt = app.elapsed;

        this.lifetime += dt;

        if (!this.parent.get(0).parentElement)
            this.kill();

        this.sprite.step(dt);
        this.legs.step(dt);
        this.helmet.step(dt);
        this.weapon.step(dt);
        this.shield.step(dt);
        this.cape.step(dt);

        this.shield.lifetime = this.sprite.lifetime = this.helmet.lifetime = this.legs.lifetime = this.cape.lifetime = this.weapon.lifetime;

        this.layer.clear();

        var legsY = this.layer.height - 10 * this.scale;

        var oy = COMMON.legsZ[this.legs.frame] * 5 + 10 * this.scale;

        if (this.legs.hidden)
            oy = 0;

        let gl = app.gl;

        gl.clearColor(0.0, 0.0, 0.0, 0.0);
        gl.colorMask(1.0, 1.0, 1.0, 1.0);
        gl.clear(gl.COLOR_BUFFER_BIT);

        app.painter.reset();

        app.painter.scale(app.textures.tile_desert.width / this.width, app.textures.tile_desert.height / this.height);
        app.painter.drawImage(app.textures.tile_desert, 0, 0);

        this.legs.render(this.layer, this.layer.width / 2 | 0, legsY - oy | 0);
        this.layer.drawImage(app.canvas, 0, 0);

        this.sprite.render(this.layer, this.layer.width / 2 | 0, legsY - 10 - oy | 0);
        this.layer.drawImage(app.canvas, 0, 0);

        this.helmet.render(this.layer, this.layer.width / 2 | 0, legsY - 10 - oy | 0);
        this.layer.drawImage(app.canvas, 0, 0);

        this.weapon.render(this.layer, this.layer.width / 2 | 0, legsY - 10 - oy | 0);
        this.layer.drawImage(app.canvas, 0, 0);

        this.shield.render(this.layer, this.layer.width / 2 | 0, legsY - 10 - oy | 0);
        this.layer.drawImage(app.canvas, 0, 0);

        this.cape.render(this.layer, this.layer.width / 2 | 0, legsY - 10 - oy | 0);
        this.layer.drawImage(app.canvas, 0, 0);

        UI.killer(this);

    }

};

/* file: script/ui/AliveCounter.js */

CLIENT.AliveCounter = function() {

    this.$container = UI.parse(`<div>
        <span ui-id="count" class='count'></span>
        <span class='label'>Alive</span>
        </div>`, this);
    this.$container.addClass("AliveCounter");
    this.$container.appendTo("body");

    setInterval(this.step.bind(this), 1000);

}
;

CLIENT.AliveCounter.prototype = {

    show: function() {

        this.$container.show();

    },

    hide: function() {

        this.$container.hide();

    },

    destroy: function() {

        this.$container.remove();

    },

    step: function() {

        let count = 0;

        for (let p of app.game.entities.groups.citizens) {

            if (p.key === "hero" && !p.dead)
                count++;

        }

        this.$count.html(count);

    }

};

/* file: script/ui/Console.js */

UI.Console = function() {

    this.$container = $("<div>");

    this.$container.addClass("console main-console");

    this.$container.appendTo("body");

    this.$top = $("<div>").appendTo(this.$container).addClass("top");
    this.$title = $("<div>").appendTo(this.$container).addClass("title");
    this.$messages = $("<div>").appendTo(this.$container);

}
;

UI.Console.prototype = {

    error: function(text) {

        if (app.data.language[text])
            text = app.lang(text);

        return this.say(text, "error");

    },

    say: function(text, messageClass, special) {

        special = special || {};

        var $message = $("<p>");

        var duration = 10000;

        if (special.direction !== undefined) {

            $message.append(this.getDirectionImage(special.direction))

        }

        if (special.flag) {

            let $flag = UI.getFlag(special.flag);

            $message.append($flag);

        }

        $message.append(text);

        if (messageClass)
            $message.addClass(messageClass);

        this.$messages.append($message);

        // setTimeout(function() {

        //   $message.remove();

        // }, duration);

        if (this.$messages.children().length > 10) {

            this.$messages.children().first().remove();

        }

    },

    fold() {

        let size = this.$messages.children().length;

        this.$messages.children().each(function(i) {

            if (i < 5 && size > 5)
                $(this).hide();

        });

    },

    unfold() {

        this.$messages.children().show();

    },

    hide: function() {

        this.$container.hide();

    },

    setTitle: function(html) {

        this.$title.html("");
        this.$title.append(html);

    },

    setTop: function(html) {

        this.$top.html("");
        this.$top.append(html);

    },

    clear: function() {

        this.$messages.children().hide();

    },

    getDirectionImage: function(direction) {

        var temp = cq(20, 20);

        temp.translate(temp.width / 2, temp.height / 2);
        temp.rotate(direction);
        temp.drawImage(app.images.misc, 0, 0, 16, 16, -8, -8, 16, 16);
        temp.canvas.classList.add("direction");

        return temp.canvas;

    }

};

/* file: script/ui/Notifier.js */

UI.Notifier = function() {

    this.$container = $("<div>");

    this.$container.addClass("notifier");

    this.$container.appendTo("body");

    this.notices = [];

    this.load();

}
;

UI.Notifier.prototype = {

    save: function() {

        localStorage.setItem("notices", JSON.stringify(this.notices));

    },

    load: function() {

        var raw = localStorage.getItem("notices");

        if (raw) {

            this.notices = JSON.parse(raw);

        }

        for (var i = 0; i < this.notices.length; i++) {

            this.openNotice(this.notices[i]);

        }

    },

    notify: function(text, messageClass) {

        var notice = {
            text: text,
            messageClass: messageClass
        }

        this.notices.push(notice);

        this.save();

        this.openNotice(notice);

    },

    openNotice: function(notice) {

        var self = this;
        var $notice = $("<p>");

        $notice.html(notice.text);

        if (notice.messageClass)
            $notice.addClass(notice.messageClass);

        this.$container.prepend($notice);

        $notice.on("click", function() {

            self.closeNotice($notice);

        });

        $notice.on("touchstart", function() {

            self.closeNotice($notice);

        });

        $notice.data("notice", notice);

        return $notice;

    },

    closeNotice: function($notice) {

        var notice = $notice.data("notice");

        Utils.pull(this.notices, notice);

        this.save();

        $notice.remove();

    },

    clear() {
        this.$container.empty();
    }

};

/* file: script/ui/Chat.js */

UI.Chat = function() {

    this.events = new CLIENT.Events();

    var self = this;

    this.autoScroll = true;

    this.$gui = app.parseUI("html/lobby_chat");

    this.$gui.appendTo("body");

    this.$textinput = $("<input>").addClass("gui-input").css("width", "100%").appendTo(this.$gui);
    this.$textinput.on("keydown", this.onKeyDown.bind(this));

    this.$messages = this.$gui.$messages;
    this.$messages.on("scroll", this.onScroll.bind(this));

    this.$gui.on("pointerleave", this.onPointerLeave.bind(this));
    this.$gui.on("pointerenter", this.onPointerEnter.bind(this));

    this.onDocumentClick = (evt)=>{

        let targetElement = evt.target;

        while (targetElement) {

            if (targetElement === this.$gui[0])
                return;

            targetElement = targetElement.parentNode;

        }

        this.blur();

    }
    ;

    document.addEventListener("click", this.onDocumentClick);

}
;

UI.Chat.prototype = {

    modesToList: ["fun", "ctf", "soccer", "arena1"],

    showid: false,

    fold() {
        return;
        if (this.folded)
            return;

        this.folded = true;

        this.$gui.toggleClass("folded", true);
        this.events.trigger("foldChange", true);
        setTimeout(()=>{
            this.scrollToBottom();

        }
        , 100)
    },

    unfold() {
        return;

        if (!this.folded)
            return;

        this.folded = false;

        this.$gui.toggleClass("folded", false);
        this.events.trigger("foldChange", false);
        this.scrollToBottom();

    },

    detach: function() {
        this.$gui.appendTo("body");
        this.$gui.addClass("detached");
    },

    appendTo: function(selector) {

        this.$gui.appendTo(selector);

        this.$gui.removeClass("detached");

    },

    say: function(data) {

        var shouldScroll = false;

        if (this.$messages[0].scrollHeight - this.$messages.scrollTop() == this.$messages.outerHeight()) {

            shouldScroll = true;

        }

        /*
                if (!data.admin && !data.type && data.name) {

                    var result = SpamFilter.filter(data.name, data.text);

                    if (result === SpamFilter.BAN) {

                        this.say({
                            text: data.name + " has been muted for 60 seconds for spamming",
                            type: "system"
                        });

                    }

                    if (result) return;

                }
                */

        var $message = $("<p>");

        if (data.type)
            $message.addClass(data.type);
        if (data.name)
            $("<span>").addClass("name").html(data.name).appendTo($message);
        if (data.connection_id && this.showid)
            $("<span>").addClass("id").html("(" + data.connection_id + ") ").appendTo($message);
        if (data.user_id)
            $("<span>").addClass("user_id").html("(" + data.user_id + ") ").appendTo($message);

        if (data.arena_mmr) {

            let rankIcons = COMMON.RANK_ICONS["arena_mmr"];

            var rank = CLIENT.Ranks.pointsToRank(data.arena_mmr, app.lobby.maxMMR.arena_mmr, rankIcons.length);

            $message.prepend("&nbsp;&nbsp;");
            $message.prepend(UI.icon("images/rank_icons.png?2", rankIcons[rank]).addClass("icon scale-2"));

        }

        if (data.mm)
            $message.append($("<span>").addClass("football"));
        if (data.admin)
            $message.addClass("admin");

        if (!data.admin && data.type !== "system" && data.name) {

            data.text = Utils.escapeHTML(data.text);

            if (data.text.indexOf("recruiter=") > -1) {

                data.text = "Use recruit link to get players outside the wilds.io - it doesn't work for existing players. Post it on facebook, game portals or give it to a friend.";

            }

            data.text = data.text.replace(/(https?:\/\/wilds.userecho.com\/.*?)($|\s)/, function(a) {

                return '<a href="' + a + '">' + a + '</a>';

            });

            data.text = data.text.replace(/(http:\/\/wilds.io\/.*?)($|\s)/, function(a) {

                if (a.indexOf("game_link") > -1) {

                    return '<a href="' + a + '">Click to play the game with ' + data.name + '.</a>';

                }

                return '<a href="' + a + '">' + a + '</a>';

            });

        }

        if (data.arena_mmr > 100) {

            data.text = data.text.replace(/(https?:\/\/i.imgur.com\/.*?)($|\s)/, function(a, b) {

                // return '<a href="' + b + '">' + b + '</a>';
                return '<a class="imgur" target="_blank" href="' + b + '">' + b + '</a>';

            });

        }

        $message.append(data.text);

        if (data.guest)
            $message.addClass("guest");

        this.$messages.append($message);

        if (this.$messages.children().length > 20) {

            this.$messages.children().first().remove();

        }

        $message.find(".imgur").each(function() {
            let $this = $(this);
            let $img = $("<img>");
            $img.attr("src", $this.attr("href"));
            $(this).append($img);
            $img.hide();

            $this.on("mouseover", function() {
                $img.show();
            });

            $this.on("mouseleave", function() {
                $img.hide();
            });

        });

        if (this.autoScroll)
            this.scrollToBottom();

    },

    onmessage: function(data) {

        this.say(data);

    },

    updateQueueCounts: function(counts) {

        var locations = ["EU", "US", "AS"];

        /* Sum mode 1vs1 and 3vs3 */

        for (var j = 0; j < locations.length; j++) {

            var location = locations[j];

            if (counts["arena1"] && counts["arena2"])
                counts["arena1"][location] += counts["arena2"][location];

        }

        for (var modeKey in counts) {

            var $row = this.$gui.$countsInQueue.find(".mode-" + modeKey + "-queue");

            var modeCounts = counts[modeKey];

            for (var j = 0; j < locations.length; j++) {

                var location = locations[j];

                $row.children("." + location).html(modeCounts[location] | 0);

            }

        }

    },

    onKeyDown: function(event) {

        if (event.keyCode === 13) {

            this.send();

        }

    },

    send: function() {

        var text = this.$textinput.val();

        this.$textinput.val("");

        if (text === "/showid") {

            this.showid = true;

            return;

        }

        app.lobby.send("chat", {
            text: text
        })

    },

    close: function() {

        this.$gui.remove();

    },

    step: function() {
    },

    scrollToBottom() {

        this.autoScroll = true;
        this.$messages[0].scrollTop = this.$messages[0].scrollHeight;

    },

    onPointerEnter() {

        this.unfold();

    },

    onPointerLeave() {

        if (document.activeElement !== this.$textinput[0])
            this.fold();

    },

    onScroll() {

        if (this.folded) {

            // this.scrollToBottom();
            this.autoScroll = true;

            return;

        }

        let el = this.$messages[0];

        this.autoScroll = false;

        if (el.offsetHeight + el.scrollTop == el.scrollHeight) {

            this.autoScroll = true;

        }
    },

    focus() {

        this.unfold();
        this.$textinput.focus();

    },

    blur() {

        this.fold();
        this.$textinput.blur();

    }

};

/* file: script/ui/RankMeter.js */

UI.RankMeter = function(args) {

    this.events = new CLIENT.Events(this);

    this.needRedraw = true;
    this.size = 64;
    this.clickSound = 1;
    this.color = "#fc0";
    this.title = "score";

    Object.assign(this, args);

    this.$widget = UI.parse(this.template);

    this.current = this.value || 0;

    this.timer = Utils.timer(this.step.bind(this), 50);

    if (this.icons)
        this.setIcon(CLIENT.Ranks.pointsToRank(this.value, this.max, this.icons.length));

    this.$widget.addClass("animated");

    this.bg = cq(this.$widget.$bg.get(0));
    this.bg.width = this.size;
    this.bg.height = this.size;

    this.lightLifespan = 0;
    this.lightDuration = 1.0;

    this.$widget.$title.css("color", this.color);
    this.$widget.$title.html(this.title);

    this.$element = this.$widget;

    app.loadImage("rank_icons");

    if (this.sprite) {
        this.offscreen = this.offscreen.bind(this);

        app.once("offscreen", this.offscreen);

    }
}

UI.RankMeter.prototype = {

    // <div class="gui-progressbar grow"><div ui-id=progress style="width:60%"></div></div>
    template: `<div class="gui-rank-meter space-start gui-cols">
      <canvas ui-id=bg></canvas>
      <div>
        <span class=title ui-id="title">KILLS</span>
        <span class="value">
          <span class="current" ui-id="current">300</span>
          <span class="max" ui-id="max">/ 500</span>
        </span>
      </div>
    </div>`,

    kill: function() {

        clearInterval(this.timer);

        this.killed = true;

    },

    get done() {

        return this.current === this.value;

    },

    set done(val) {
    },

    step: function(dt) {

        if (this.await && !this.await.done)
            return;

        var prev = this.current;

        if (this.icons) {

            var prevLevel = CLIENT.Ranks.pointsToRank(this.current, this.max, this.icons.length);

            var speed = 1 + Math.abs(this.current - this.value);

            if (this.tween && !this.tween._remove)
                this.tween.step(dt);

            var currentLevel = CLIENT.Ranks.pointsToRank(this.current, this.max, this.icons.length);
            var currentLevelPoints = CLIENT.Ranks.rankToPoints(currentLevel, this.max, this.icons.length);
            var nextLevelPoints = CLIENT.Ranks.rankToPoints(currentLevel + 1, this.max, this.icons.length);

            var progress = (this.current - currentLevelPoints) / (nextLevelPoints - currentLevelPoints);

            if (prevLevel !== currentLevel) {

                setTimeout(()=>{

                    this.setIcon(currentLevel);
                    app.sound.play("ui/meter_up");
                    app.sound.play("ui/impact");

                }
                , 700);

                app.sound.play("drums/minor_1");

                app.sound.play("throw").loop().rate(1.5).rateTo(0, 2.0).fadeOut(2.0);

                this.poke();

            }

        } else {

            var nextLevelPoints = this.max;
            var progress = this.current / this.max;

            if (this.tween && !this.tween._remove)
                this.tween.step(dt);

        }

        if (Math.floor(prev) !== Math.floor(this.current)) {

            var sound = app.sound.play("ui/meter_click");

            if (this.current === this.value)
                sound.rate(0.7);

            this.light(0.2);

        } else if (!this.finished) {
            this.events.trigger("finish");
            this.finished = true;

        }

        if (this.current !== prev || !this.updated) {

            this.updated = true;

            this.$widget.$max.html("/" + nextLevelPoints);
            this.$widget.$current.html(this.current | 0);

        }

        let prevProgress = this.progress;

        this.setProgress(progress);

        if (this.lightLifespan)
            this.needRedraw = true;

        this.lightLifespan = Math.max(0, this.lightLifespan - dt);

        this.redraw();

        UI.killer(this);

    },

    light: function(duration) {

        this.lightLifespan = duration;
        this.lightDuration = duration;

    },

    setProgress: function(progress) {

        if (this.progress === progress)
            return;

        this.progress = progress;

        this.needRedraw = true;

    },

    redraw: function() {

        var end = Utils.ground(this.progress, 0.02) * Math.PI * 2;

        this.bg.fillStyle("rgba(0,0,0,0.5)");
        this.bg.fillCircle(this.size / 2, this.size / 2, this.size / 2);

        this.bg.lineWidth(2);
        this.bg.strokeStyle(this.color);
        this.bg.strokeCircle(this.size / 2, this.size / 2, this.size / 2 - 1);

        this.bg.strokeStyle(cq.color(this.color).mix("#fff", this.lightLifespan / this.lightDuration).toHex());
        this.bg.lineWidth(6);
        this.bg.beginPath();
        this.bg.moveTo(this.size / 2, 6);
        this.bg.arc(this.size / 2, this.size / 2, this.size / 2 - 6, Math.PI * 1.5, Math.PI * 1.5 + end);
        this.bg.stroke();

        if (this.region && this.icons) {

            this.bg.save();
            this.bg.translate(this.bg.width / 2 | 0, this.bg.height / 2 | 0);
            this.bg.align(0.5, 0.5);
            this.bg.scale(2, 2);
            this.bg.drawRegion(app.images.rank_icons, this.region, 0, 0);
            this.bg.restore();

        }

    },

    val: function(value) {

        this.value = value;

        var duration = Math.abs(this.current - this.value) * 0.15;

        duration = Math.min(duration, 3.0);

        this.tween = app.tween(this).to({
            current: value
        }, duration, "outQuad").manual();

    },

    setIcon: function(index) {

        this.region = this.icons[index];

        this.needRedraw = true;

    },

    poke: function() {

        this.$widget.removeClass("flip");
        this.$widget.removeClass("animated");

        this.$widget.addClass("flip");
        this.$widget.addClass("animated");

    },

    offscreen() {

        let gl = app.gl;

        gl.clearColor(0.0, 0.0, 0.0, 0.0);
        gl.colorMask(1.0, 1.0, 1.0, 1.0);
        gl.clear(gl.COLOR_BUFFER_BIT);

        app.painter.reset();
        app.painter.scale(2, 2);
        app.painter.drawSprite(this.sprite, this.bg.width / 2, this.bg.height / 2, app.lifetime * 8);

        this.bg.drawImage(app.canvas, 0, 0);

        if (!this.killed)
            app.once("offscreen", this.offscreen);

    }

};

/* file: script/ui/Settings.js */

{

    let template = `
    <div class="window center-window style-1 gui-vertical settings-window scroll" style="height: 90vh">
      <div ui-id="content" class="gui-scrollable gui-vertical spacing-md" style="height: 100%">
        <div class="gui-form-divide">GENERAL</div>
      </div>
    </div>
  `;

    let togglesTemplate = `<div class="gui-toggles size-md gui-cols grow-equal"></div>`;
    let toggleTemplate = `<span ui-value="0">RUINS</span>`;

    // <span ui-id="autoLogin" class="gui-checkbox">60 FPS</span>

    UI.Settings = function(args) {

        this.events = new CLIENT.Events;

        this.$widget = UI.parse(template);

        this.$widget.css("z-index", 2);

        UI.titleBar(this.$widget, "Settings", this);

        // this.row("60 FPS", this.checkbox("fps_60"));
        this.row("In-game chat", this.checkbox("ingame_chat"));
        this.row("Wait in lobby", this.checkbox("wait_in_lobby"));
        // this.row("Gender", this.toggles("gender", [0, "male"], [1, "female"]));

        this.controls = new UI.Controls();

        this.controls.$widget.appendTo(this.$widget.$content);

        this.$deleteAccount = $("<span class='gui-button'>Delete my account</span>");
        this.$deleteAccount.on("click", this.onDeleteAccountClick.bind(this));

        this.row(null, "<div class='gui-form-divide'>WARNING</div>")
        this.row("Delete account", this.$deleteAccount)

    }
    ;

    UI.Settings.prototype = {

        onDeleteAccountClick() {

            let self = this;

            let widget = new UI.Prompt("Are you sure you want to delete your account?","Account deletion is irreversible. All data associated with your character will be permanently deleted from database.");

            widget.$element.appendTo(document.body);
            widget.$element.addClass("center-window");

            widget.on("yes", function() {

                self.close();

                app.lobby.send("delete_my_account", {
                });

            });

        },

        label(text) {

            this.$widget.append("<div></div>")

        },

        row(label, content) {

            let $row = $("<div>").addClass("gui-cols grow-equal");

            let $label = $(`<div>${label}</div>`).addClass('grow-1')

            if (label)
                $label.appendTo($row);

            let $content = $(`<div></div>`).addClass('grow-2').append(content);

            $content.appendTo($row);

            $row.appendTo(this.$widget.$content);

            return $row;

        },

        toggles(key) {

            let $toggles = UI.parse(togglesTemplate);
            let $toggleTemplate = UI.parse(toggleTemplate);

            for (var i = 1; i < arguments.length; i++) {

                let option = arguments[i];

                let $toggle = $toggleTemplate.clone();

                $toggle.attr("ui-value", option[0]);
                $toggle.attr("ui-type", typeof option[0]);
                $toggle.html(option[1]);

                $toggle.appendTo($toggles);

            }

            $toggles.appendTo(this.$widget.$content);

            UI.toggles($toggles, app.options[key], (value)=>{

                app.options[key] = value;

                this.save();

            }
            );

            return $toggles;

        },

        checkbox(key, title) {

            let $checkbox = $("<span>").addClass("gui-checkbox").data("key", key);

            $checkbox.on("click", this.onCheckboxClick.bind(this, $checkbox));

            this.updateCheckbox($checkbox);

            return $checkbox;

        },

        onCheckboxClick($checkbox) {

            let key = $checkbox.data("key");

            app.options[key] = !Boolean(app.options[key]);

            this.updateCheckbox($checkbox);

            this.save();

        },

        updateCheckbox($checkbox) {

            let key = $checkbox.data("key");

            let value = app.options[key];

            $checkbox.toggleClass("checked", value);

        },

        close() {

            this.$widget.remove();

            this.events.trigger("close");

        },

        save() {

            let json = JSON.stringify(app.options);

            localStorage.setItem("options", json);

        }

    };

}

/* file: script/ui/Controls.js */

UI.Controls = function(args) {

    Object.assign(this, args);

    this.$widget = UI.parse(this.templates.main);
    this.rows = {};

    for (let command in this.commands) {

        this.rows[command] = [];

        let name = this.commands[command];

        let $row = UI.parse(this.templates.row);

        $row.$command.html(name);

        $row.$a.html(app.controls[command][0]);
        $row.$b.html(app.controls[command][1] || "");

        $row.$a.on("click", this.onCommandClick.bind(this, {
            command: command,
            i: 0
        }));

        $row.$b.on("click", this.onCommandClick.bind(this, {
            command: command,
            i: 1
        }));

        this.rows[command][0] = $row.$a;
        this.rows[command][1] = $row.$b;

        $row.children().appendTo(this.$widget.$table);

    }

}
;

UI.Controls.prototype = {

    commands: {
        "up": "up",
        "down": "down",
        "left": "left",
        "right": "right",
        "attack": "attack",
        "block": "block",
        "roll": "roll",
        "run": "run/kick",
        "jump": "jump",
        "throw_weapon": "throw weapon",
        "item1": "healing potion",
        "item2": "haste potion",
        "item3": "mine",
        "item4": "throwing knife",
        "spell1": "special skill",
        "emote": "emote",
        "help": "hotkeys"
    },

    templates: {

        main: `
    <div class="gui-rows spacing-md">
      <div class="gui-form-divide">CUSTOM CONTROLS</div>
      <div class="controls-table" ui-id="table"></div>
    </div>
    `,

        // <div class="grow-equal spacing-md">
        // </div>
        row: `
      <span ui-id=command class="command"></span>
      <span ui-id=a class="a gui-input sunken text-align-center"></span>
      <span ui-id=b class="b gui-input sunken text-align-center"></span>
    `

    },

    save() {

        let json = JSON.stringify(app.controls);

        localStorage.setItem("controls", json);

    },

    onCommandClick(data) {

        this.prompt((key)=>{

            this.$overlay.remove();

            switch (key) {

            case "backspace":

                this.set(data.command, data.i, undefined);

                break;

            case "escape":

                break;

            default:

                this.set(data.command, data.i, key);

                break;
            }

            this.save();

        }
        );

    },

    set(command, slot, key) {

        app.controls[command][slot] = key;

        this.rows[command][slot].html(key || "");

    },

    prompt(callback) {

        let $overlay = $("<div>");

        $overlay.addClass("overlay");
        $overlay.appendTo("body");

        let $prompt = $("<div>");

        $prompt.addClass("window prompt")
        $prompt.html("Assign a new key, gamepad or mouse button.<br> ESC to cancel / BACKSPACE to clear");
        $prompt.appendTo($overlay);

        app.once("keydown", (e)=>{

            callback(e.key);

        }
        );

        this.$overlay = $overlay;

    }

};

/* file: script/ui/Tribe.js */

{

    UI.Tribe = function(args) {

        this.$widget = UI.parse(app.data.html.tribe, this);

        // this.$widget.css("z-index", 500);
        this.$element = this.$widget;

        UI.titleBar(this.$widget, "My tribe", this);

        UI.toggles(this.$widget.$tabs, "tribe_bulletin", this.selectTab.bind(this));

        this.setState(false);

        app.lobby.ask("my_tribe").then(this.start.bind(this));

    }
    ;

    UI.Tribe.prototype = {

        start(data) {

            this.data = data;

            if (!data) {

                this.selectTab("public_tribes");

                return this.setState(false);

            } else {

                this.selectTab("tribe_bulletin");

                this.setState(true);

            }

        },

        isOwner() {

            if (!this.data)
                return false;

            return this.data.owner_id === app.user.id;

        },

        setState(state) {

            this.state = state;

            if (state) {

                this.$widget.find(".logged_in").show();
                this.$widget.find(".not_logged_in").hide();

            } else {

                this.$widget.find(".logged_in").hide();
                this.$widget.find(".not_logged_in").show();

            }

            if (this.isOwner()) {

                this.$widget.find(".owner_only").show();

            } else {

                this.$widget.find(".owner_only").hide();

            }

        },

        selectTab(key) {

            UI.inspect();

            // if (!this.state) return;

            this.tabKey = key;

            this.$tab = UI.parse(app.data.html[key]);

            this.$widget.$content.children().remove();

            this.$widget.$content.append(this.$tab);

            this[key](this.$tab);

        },

        tribe_map($tab) {

            let map = new UI.HistoryMap();

            app.lobby.ask("tribes_history").then((result)=>{

                map.setHistory(result);

                let canvas = map.render();

                $tab.$map.append(canvas);

                let scale = canvas.parentElement.offsetHeight / canvas.height;

                canvas.style.transform = `scale(${scale})`;

                canvas.addEventListener("mousemove", function(e) {
                // let rotate = -50 * (-0.5 + e.offsetX / canvas.offsetWidth) | 0;

                // canvas.style.transform = `rotateY(${rotate}deg) scale(${scale})`;

                });

            }
            );

        },

        tribe_create($tab) {

            $tab.$createTribe.on("click", ()=>{

                app.lobby.state.lock();

                app.lobby.ask("create_tribe", {

                    tag: $tab.$createTribeTag.val(),
                    name: $tab.$createTribeName.val()

                }).then((response)=>{

                    if (response === true) {

                        this.setState(true);

                    } else {

                        app.console.error(response);

                    }

                    app.lobby.state.unlock();

                }
                );

            }
            );

        },

        tribe_members($tab) {

            app.lobby.ask("my_tribe_members", {
                page: 0
            }).then(this.populateMembers.bind(this, $tab, {}));

            $tab.$search.on("keydown change", Utils.throttle(()=>{

                this.searchMembers($tab.$search.val(), $tab);

            }
            , 500));

        },

        prepareBulletinIFRAME(tribe_id) {

            let iframe = document.createElement("iframe");

            iframe.src = "//wilds5125421359.instantonline.io/bulletin/" + tribe_id;

            iframe.setAttribute("sandbox", "allow-scripts allow-top-navigation allow-popups");

            return iframe;

        },

        tribe_bulletin($tab) {

            // app.lobby.ask("my_tribe_text").then((text) => {

            $tab.empty();
            $tab.append(this.prepareBulletinIFRAME(app.user.tribe_id));

            // });

        },

        tribe_edit_bulletin($tab) {

            app.lobby.ask("my_tribe_text").then(init);

            function init(text) {

                $tab.$textarea.val(text);

                $tab.$textarea.on("keyup", Utils.debounce(function() {

                    let text = $tab.$textarea.val();

                    app.lobby.ask("update_tribe_text", {
                        text: text
                    });

                }, 1000));

            }

        },

        tribe_kicked($tab) {

            app.lobby.ask("my_tribe_kicked", {
                page: 0
            }).then(this.populateMembers.bind(this, $tab, {}));

            $tab.$search.on("keydown change", Utils.throttle(()=>{

                this.searchMembers($tab.$search.val(), $tab);

            }
            , 500));

        },

        public_tribes($tab) {

            ask = ()=>{

                app.lobby.ask("public_tribes", {

                    text: $tab.$search.val()

                }).then(this.populateTribes.bind(this, $tab, {}));

            }

            ask();

            $tab.$search.on("keydown change", Utils.throttle(()=>{

                ask();

            }
            , 500));

        },

        tribe_admin($tab) {

            UI.clipboard($tab.$publicLink);
            UI.clipboard($tab.$privateLink);

            app.lobby.ask("my_tribe").then((response)=>{

                if (response.owner_id === app.user.id) {

                    let public_link = app.url("api/tribe_join_public/?token=" + response.public_link);

                    $tab.$publicLink.val(public_link);

                    $tab.$renewPublicLink.on("click", ()=>{

                        if (confirm("Are you sure you want to get a new public link? Your current public link will stop working;")) {

                            app.lobby.ask("renew_tribe_public_link").then((new_link)=>{

                                let public_link = app.url("api/tribe_join_public/?token=" + new_link);

                                $tab.$publicLink.val(public_link);

                            }
                            );

                        }

                    }
                    );

                    $tab.$renewPrivateLink.on("click", ()=>{

                        app.lobby.ask("renew_tribe_private_link").then((new_link)=>{

                            let private_link = app.url("api/tribe_join_private/?token=" + new_link);

                            $tab.$privateLink.val(private_link);

                        }
                        );

                    }
                    );

                    UI.checkbox($tab.$isPublic, response.public, function(state) {

                        console.log('state', state)

                        app.lobby.ask("update_tribe_public", {
                            public: state
                        });

                    });

                    $tab.$description.val(response.description);

                    $tab.$description.on("keyup", Utils.debounce(function() {

                        let text = $tab.$description.val();

                        app.lobby.ask("update_tribe_description", {
                            description: text
                        });

                    }, 1000));

                } else {

                    $tab.find(".admin").hide();

                }

            }
            );

            $tab.$leaveTribe.on("click", ()=>{

                if (confirm("Do you really want to leave this tribe?")) {

                    app.lobby.ask("leave_tribe");

                    this.setState(false);

                }

            }
            );

        },

        searchMembers(text, $element) {

            app.lobby.ask("my_tribe_members", {
                text: text
            }).then(this.populateMembers.bind(this, $element, {}));

        },

        populateMembers($element, options, data) {

            let $members = $element.find(".members");

            $members.empty();

            let $template = $(`<div class="member gui-cols">
          <span class="score"></span>
          <span class="name">name</span>
          <span class="bones">bones</span>
        </div>`);

            for (let member of data.members) {

                let $member = $template.clone();

                $member.children(".name").html(member.name);
                $member.children(".bones").html((member.bones | 0));
                $member.children(".bones").append(UI.icon("images/rank_icons.png?2", COMMON.KILL_RANKS[6]).addClass("icon"));

                var rank = CLIENT.Ranks.pointsToRank(member.score, app.lobby.maxMMR["arena_mmr"], COMMON.ARENA_RANKS.length);

                $member.children(".score").append(UI.icon("images/rank_icons.png?2", COMMON.ARENA_RANKS[rank]).addClass("icon"));
                $member.data("member", member);
                $member.appendTo($members);
                $member.on("click", this.inspectMember.bind(this));

            }

        },

        populateTribes($element, options, data) {

            let $tribes = $element.find(".tribes");

            $tribes.empty();

            let $template = $(`<div class="tribe gui-rows spacing-md">
          <span class="name">name</span>
          <span class="description grow">description</span>
          <span class="population">members</span>
          <span class="gui-button primary join">join</span>
          <span class="gui-button bulletin">bulletin</span>
        </div>`);

            for (let tribe of data.tribes) {

                let $tribe = $template.clone();

                $tribe.children(".name").html(`${tribe.name} [${tribe.tag}]`);
                $tribe.children(".description").html(tribe.description);
                $tribe.children(".population").html(`population: ${tribe.population}`);
                $tribe.children(".join").on("click", ()=>{

                    app.lobby.ask("join_public_tribe", {

                        tribe_id: tribe.id

                    }).then((response)=>{

                        if (typeof response === "object") {

                            app.notifier.notify(`Welcome to ${response.name} tribe`);

                            this.setState(true);
                            this.selectTab("tribe_bulletin");

                        } else {

                            app.console.error(response);

                        }

                    }
                    );

                }
                );

                $tribe.children(".bulletin").on("click", ()=>{

                    this.displayBulletin(tribe.id);

                }
                );

                $tribe.data("tribe", tribe);
                $tribe.appendTo($tribes);

            }

        },

        displayBulletin(tribe_id) {

            let $panel = $("<div>").addClass("full-window bulletin-preview tribe-bulletin window");

            UI.titleBar($panel, "BULLETIN", {
                close: function() {
                    $panel.remove();
                }
            });

            $panel.appendTo("body");

            app.lobby.ask("tribe_text", {
                tribe_id: tribe_id
            }).then((text)=>{

                $panel.append(this.prepareBulletinIFRAME(tribe_id));

            }
            );

        },

        inspectMember(event) {

            if (!event)
                return UI.inspect();

            let $member = $(event.currentTarget);

            let member = $member.data("member");

            let $inspector = UI.inspect(event.currentTarget);

            if (this.isOwner()) {

                let $kick = $("<span>").addClass("gui-button").html("kick").on("click", ()=>{

                    if (confirm("Are you sure you want to KICK this user?")) {

                        app.lobby.ask("kick_from_tribe", {
                            user_id: member.id
                        });

                        $member.remove();

                    }

                    this.inspectMember();

                }
                );

                $inspector.append($kick);

            }

        },

        close() {

            this.$widget.remove();

            app.emitter.kill(this);

            UI.inspect();

        }

    };

}

/* file: script/ui/HistoryMap.js */

{

    UI.HistoryMap = function(history) {

        this.palette = ["#222034", "#663931", "#8f563b", "#df7126", "#fbf236", "#99e550", "#6abe30", "#37946e", "#4b692f", "#524b24", "#323c39", "#3f3f74", "#306082", "#5b6ee1", "#639bff", "#5fcde4", "#cbdbfc", "#9badb7", "#76428a", "#ac3232", "#d95763", "#d77bba", "#8f974a", "#8a6f30"];
        this.pixels = 0;
        this.maskImage = app.images.history_map_mask;
        this.mapWidth = this.maskImage.width;
        this.mapHeight = this.maskImage.height;
        this.mapSize = this.mapWidth * this.mapHeight;
        this.mask = cq(this.maskImage).grayscaleToMask();

        for (var i = 0; i < this.mask.length; i++) {

            if (this.mask[i])
                this.pixels++;

        }

        this.history = history;

        // this.setIndex(0);
        // this.refresh();

        /*
    setInterval(() => {

      this.setIndex(this.index + 1);
      this.refresh();

    }, 100)
    */

    }

    UI.HistoryMap.prototype = {

        setHistory(history) {

            /*
            let a = history[0];

            for (let r of a) {

              r.score = Utils.random(100, 1000);

            }

      */

            this.history = history;

        },

        render() {

            this.setIndex(0);

            return this.refresh();

        },

        setIndex(index) {

            this.index = index;

            this.data = Utils.dcopy(this.history[index]);

        },

        j(x, y) {

            return x + "," + y;

        },

        shuffle() {
        },

        anyOpening(entries) {

            for (let e = 0; e < entries.length; e++) {

                let entry = entries[e];

                if (entry.openings.length) {

                    let opening = entry.openings[0];

                    entry.openings.splice(0, 1);

                    return opening;

                }

            }

        },

        moveToNearestLand(entry) {

            let cursor = this.nearestFreePixel(entry.x, entry.y);

            entry.x = cursor[0];
            entry.y = cursor[1];

        },

        refresh() {

            if (!this.data)
                return;

            let image = cq(app.images.history_map_mask).clone();
            let imageData = image.getImageData(0, 0, image.width, image.height);
            let imagePixels = imageData.data;

            let colorsTaken = {};

            let entries = Utils.sortBy(this.data, e=>-e.score);

            let sum = Utils.sumBy(entries, "score");

            for (var i = 0; i < entries.length; i++) {

                let entry = entries[i];

                entry.percentage = entry.score / sum;

                if (entry.percentage < 0.0025)
                    entries.splice(i--, 1);

            }

            sum = Utils.sumBy(entries, "score");

            for (var entry of entries) {

                entry.random = Utils.seed(entry.id + (entry.id * 2148712874) % 256 | 0);

                entry.percentage = entry.score / sum;
                entry.pixels = this.pixels * (entry.percentage) | 0;

                entry.pixels = Math.min(entry.score * 0.25, entry.pixels);

                entry.color = this.palette[this.palette.length * entry.random | 0];

                var hex = entry.color;

                colorsTaken[hex] = (colorsTaken[hex] | 0) + 1;

                if (colorsTaken[hex] > 1)
                    entry.color = cq.color(entry.color).shiftHsl(0.1 * colorsTaken[hex], -0.1 * colorsTaken[hex], 0.1 * colorsTaken[hex]).toHex();

                entry.color = cq.color(entry.color);

                entry.x = image.width * entry.random | 0;
                entry.y = image.height * Utils.seed(entry.x) | 0;

                this.moveToNearestLand(entry);

                entry.left = entry.x;
                entry.right = entry.x;
                entry.top = entry.y;
                entry.bottom = entry.y;

                entry.index = 0;
                entry.visited = new Array(this.mapSize);

            }

            var done = false;
            var minDistance = 20;
            var guard = 0;

            while (!done) {

                if (guard++ > 100)
                    break;

                done = true;

                for (var i = 0; i < entries.length; i++) {

                    let a = entries[i];

                    for (var j = i + 1; j < entries.length; j++) {

                        let b = entries[j];

                        if (Utils.distance(a, b) < minDistance) {

                            done = false;

                            let angle = Utils.lookAt(a, b);

                            b.x = a.x + Math.cos(angle) * minDistance | 0;
                            b.y = a.y + Math.sin(angle) * minDistance | 0;

                            a.x = a.x + Math.cos(angle - Math.PI) * minDistance * 0.5 | 0;
                            a.y = a.y + Math.sin(angle - Math.PI) * minDistance * 0.5 | 0;

                            this.moveToNearestLand(a);
                            this.moveToNearestLand(b);

                        }

                    }
                }

            }

            for (var entry of entries) {

                entry.openings = [[entry.x, entry.y]];

            }

            let check = [].concat(entries);

            let visited = new Array(this.mapSize);

            let iterations = 0;

            for (var i = 0; i < this.pixels; i++) {

                let done = true;

                for (let e = 0; e < check.length; e++) {

                    let entry = check[e];

                    if (entry.pixels <= 0 || entry.index >= entry.openings.length || !entry.openings.length) {

                        check.splice(e--, 1);

                        continue;

                    }

                    done = false;

                    let next = entry.openings[entry.index];

                    entry.index++;

                    /*
                    let index = entry.openings.length * entry.random | 0;
                    next = entry.openings[index];
                    entry.openings.splice(index, 1);
                    */

                    let x = next[0];
                    let y = next[1];

                    let maskIndex = x + y * this.mapWidth;

                    if (this.mask[maskIndex] && !visited[maskIndex]) {

                        entry.pixels--;

                        // image.fillStyle(entry.color).fillRect(x, y, 1, 1);

                        imagePixels[maskIndex * 4 + 0] = entry.color[0];
                        imagePixels[maskIndex * 4 + 1] = entry.color[1];
                        imagePixels[maskIndex * 4 + 2] = entry.color[2];
                        imagePixels[maskIndex * 4 + 3] = 255;

                        if (x < entry.left)
                            entry.left = x;
                        if (x > entry.right)
                            entry.right = x;
                        if (y < entry.top)
                            entry.top = y;
                        if (y > entry.bottom)
                            entry.bottom = y;

                    } else {
                    // entry.pixels -= 0.05;

                    }

                    visited[maskIndex] = true;

                    for (var i = 0; i < 2; i++) {

                        let d = 1 + i * 1 * entry.random | 0;

                        let added = 0;

                        let rnd = entry.random * 1000 | 0;

                        let pass = iterations % 2 === 0;
                        let num = rnd + iterations;

                        if ((num * 8 | 0) % 8 < 4)
                            added += this.visitIfNotVisited(x + d | 0, y, entry, entry.visited);
                        if ((num * 7 | 0) % 8 < 4)
                            added += this.visitIfNotVisited(x - d | 0, y, entry, entry.visited);
                        if ((num * 6 | 0) % 8 < 4)
                            added += this.visitIfNotVisited(x, y + d | 0, entry, entry.visited);
                        if ((num * 5 | 0) % 8 < 4)
                            added += this.visitIfNotVisited(x, y - d | 0, entry, entry.visited);

                        if (entry.openings.length - entry.index < 8) {

                            this.visitIfNotVisited(x + d | 0, y, entry, entry.visited);
                            this.visitIfNotVisited(x - d | 0, y, entry, entry.visited);
                            this.visitIfNotVisited(x, y + d | 0, entry, entry.visited);
                            this.visitIfNotVisited(x, y - d | 0, entry, entry.visited);

                        }

                    }

                }

                if (done) {

                    break;

                }

                iterations++;

            }

            for (var entry of entries) {

                entry.x = entry.left + Math.abs(entry.left - entry.right) * 0.5;
                entry.y = entry.top + Math.abs(entry.top - entry.bottom) * 0.5;

            }

            image.putImageData(imageData, 0, 0);

            image = cq(image).resize(2);

            let finalImage = cq(app.images.history_map).resize(2).blend(image, "overlay");

            for (let entry of entries) {

                finalImage.fillStyle("#000").fillCircle(entry.x * 2, entry.y * 2, 5);
                finalImage.fillStyle(entry.color).fillCircle(entry.x * 2, entry.y * 2, 3);

                finalImage.textAlign("center");

                finalImage.font("700 11px 'generic'");
                // finalImage.fillStyle("#000").fillText(entry.name, entry.x * 2, entry.y * 2 - 16);
                // finalImage.fillStyle("#fff").fillText(entry.name, entry.x * 2, entry.y * 2 - 18);

                finalImage.fillStyle("#000").wrappedText(entry.name.replace(' ', ' \n '), entry.x * 2, entry.y * 2 - 16, 200);
                finalImage.fillStyle(cq.color(entry.color).setHsl(false, false, 0.92)).wrappedText(entry.name.replace(' ', ' \n '), entry.x * 2, entry.y * 2 - 18, 200);

                delete entry.openings;
                delete entry.visited;

            }

            return finalImage.canvas;

        },

        visitIfNotVisited(x, y, entry, visited) {

            let openings = entry.openings;

            if (x < 0 || x >= this.mapWidth || y < 0 || y >= this.mapHeight)
                return false;

            let index = x + y * this.mapWidth;

            // if (!this.mask[index]) return false;

            if (visited[index])
                return false;

            visited[index] = true;

            // if (map.get(this.j(x, y)) === id) return;

            // openings.push([x, y]);

            openings.splice(entry.index + Math.sin((openings.length % Math.PI) / Math.PI) * (openings.length - 1 - entry.index) | 0, 0, [x, y]);

            return true;

        },

        nearestFreePixel(startX, startY, not) {

            if (startX < 0)
                startX = 0;
            if (startX >= this.mapWidth)
                startX = this.mapWidth - 1;
            if (startY < 0)
                startY = 0;
            if (startY >= this.mapHeight)
                startY = this.mapHeight - 1;

            let guard = 0;

            let openings = [[startX, startY]];

            let visited = new Array(this.mapSize);

            let index = 0;

            while (true) {

                if (!openings.length)
                    return false;

                let cursor = openings[index];

                index++;

                let x = cursor[0];
                let y = cursor[1];

                if (x < 0 || x >= this.mapWidth || y < 0 || y >= this.mapHeight)
                    continue;

                if (visited[x + y * this.mapWidth])
                    continue;

                visited[x + y * this.mapWidth] = true;

                if (this.mask[x + y * this.mapWidth]) {

                    return [x, y];

                }

                openings.push([x + 1, y]);
                openings.push([x - 1, y]);
                openings.push([x, y + 1]);
                openings.push([x, y - 1]);

            }

        }

    };

}

/* file: script/ui/QuickNews.js */

UI.QuickNews = function(history) {

    this.$widget = $("<div>");

    this.$widget.addClass("quick-news");
    this.$widget.addClass("scroll");
    this.$widget.css("maxHeight", ((window.innerHeight - 480) * 0.5) + "px");

    this.$widget.append(UI.parse(app.data.html.quick_news).children());

    this.$widget.find("a").each(function() {

        $(this).attr("target", "_blank");

    });

    let markers = {

        "%": [2, 192, 11, 12],
        "+": [16, 191, 9, 10],
        "-": [28, 194, 9, 4]

    };

    let read = JSON.parse(localStorage.getItem("quick_news") || "{}");

    this.$widget.children().each(function() {

        for (var key in markers) {

            if (this.innerText[0] === key) {

                for (var i = 0; i < this.childNodes.length; i++) {

                    var node = this.childNodes[i];

                    if (node.nodeName === "#text")
                        node.nodeValue = node.nodeValue.substr(1);

                    break;

                }

                $(this).prepend(UI.icon("images/gui.png", markers[key]));

                break;

            }

        }

        let hash = Utils.hash(this.innerText);

        if (hash && !read[hash]) {

            $(this).prepend(UI.icon("images/gui.png", [40, 191, 3, 11]).addClass("unread-icon"));

            read[hash] = true;

        }

    });

    localStorage.setItem("quick_news", JSON.stringify(read));

    if (!app.iaps)
        this.$widget.find(".iap").hide();

}

UI.QuickNews.prototype = {
};

/* file: script/ui/Recruits.js */

UI.Recruits = function() {

    this.$element = UI.parse(this.template, this);

    UI.titleBar(this.$element, "Recruits", this);

    this.$element.$link.val("http://wilds.io/?recruiter=" + app.user.id);

    this.$element.$recruits.html(app.user.recruits | 0);
    this.$element.$gold.html(app.user.recruits_gold | 0);

    if (app.user.guest) {

        this.$element.find(".guest").show();
        this.$element.find(".notguest").hide();

    } else {

        this.$element.find(".guest").hide();
        this.$element.find(".notguest").show();

    }

    app.lobby.ask("top_recruiters").then(this.populateLeaderboards.bind(this));

    this.$element.enhance();

}
;

UI.Recruits.prototype = {

    template: `<div class="ui-recruits style-1 window gui-rows spacing-xl">

  <div class="gui-cols spacing-md grow-equal">

    <div>

      <div class="text-align-center"><img src="templates/images/tribe.gif" class="scale-2"></div>

      <p>Recruit new players and make them work for you. You will receive <b>10%</b> of your recruits gold.</p>

      <p class="notguest">Send this link to recruit new players:</p>
      
      <input class="gui-input size-sm notguest" ui-id="link">

      <div class="guest reminder">
        You have to be logged in
      </div>

      <p>Once a recruit make an account in Wilds - he will be added to your pool.</p>

      <div class="gui-cols spacing-md grow-equal">

          <span class="gui-flat-counter gui-cols space-between align-center" ui-id="recruitsCounter">
                <span ui-id=recruits>0</span>
                <img src="images/recruit.gif" class="coin">
          </span>

          <span class="gui-gold-counter gui-clickable gui-cols space-between align-center" ui-id="goldCounter">
              <span ui-id=gold>0</span>
               <img src="images/coin.gif" class="coin">
          </span>
          
      </div>


      <p>
        <a href="http://wilds.userecho.com/topics/3408-recruiting-system-how-does-it-work/" target="_blank">Read more about recruiting system &raquo;</a>
      </p>

    </div>

    <div class="gui-rows spacing-md" style="opacity:0.8">
      
      <h1 class="text-align-center"><span class="css-sprite css-sprite-leaderboards" style="vertical-align:bottom"></span> TOP RECRUITERS</h1>
      
      <div class="grow scroll gui-scrollable">
      <table class="leaderboards" ui-id=leaderboards style="width:100%"">
        <tr>
          <th class="text-align-left">name</th>
          <th>recruits</th>
        </tr>
      </table>
      </div>


    </div>

</div>`,

    leaderboardsRowTemplate: `<tr ui-id=rowTemplate>
          <td class="name">???</td>
          <td class="recruits text-align-center">0</td>
        </tr>`,

    populateLeaderboards(top) {

        var $template = $(this.leaderboardsRowTemplate);

        for (var entry of top) {

            let $row = $template.clone();

            $row.find(".name").html(entry.name);
            $row.find(".recruits").html(entry.recruits);

            $row.appendTo(this.$element.$leaderboards);

        }

    },

    close() {

        this.$element.remove();

    },

    onGoldCounterClick() {

        UI.animateCount(this.$element.$gold.parent(), {
            to: 0,
            duration: 2.5,
            counter: "[ui-id=gold]"
        });

        app.lobby.ask("claim_recruits_gold");

    }

};

/* file: script/ui/ContainerPanel.js */

UI.ContainerPanel = function(containerEntity) {

    this.containerEntity = containerEntity;

    this.updates = -1;

    this.$widget = UI.parse(this.template);

    this.$widget.css("width", 344);

    /* Player items */

    var options = {
        onClick: this.onPlayerItemClick.bind(this),
        dataSource: this.playerItemDataSource.bind(this)
    }

    var $slots = this.createSlots([0, 1, 2, 3], options);

    $slots.appendTo(this.$widget.$playerItems);

    /* Container items */

    var options = {
        onClick: this.onContainerItemClick.bind(this),
        dataSource: this.containerItemDataSource.bind(this)
    }

    var $slots = this.createSlots(app.data.containable_items, options);

    $slots.appendTo(this.$widget.$containerItems);

    this.timer = setInterval(this.step.bind(this), 100);

    this.$widget.enhance();

}
;

Object.assign(UI.ContainerPanel.prototype, {

    template: `<div>
    <h1>Container</h1>
    <div ui-id=containerItems class="gui-flex wrap gui-window extra-padding-bottom"></div>
    <p class="text-align-center"><span class="css-sprite css-sprite-exchange-horizontal scale-2x"></span></p>
    <h1>You</h1>
    <div ui-id=playerItems class="gui-cols gui-window extra-padding-bottom"></div>
    <p>ESC or SPACE to close</p>
  </div>`,

    kill() {

        clearInterval(this.timer);

    },

    close() {

        this.$widget.remove();
        this.kill();

        if (this.onClose)
            this.onClose();

    },

    /* Generic */

    step() {

        let game = app.game;

        if (this.updates !== this.containerEntity.updates) {

            this.updates = this.containerEntity.updates;

            this.$widget.$containerItems.children().each((index,element)=>{

                this.updateSlot(element);

            }
            );

        }

        if (game.privateData.itemsUpdates !== this.lastItemsUpdate) {

            this.lastItemsUpdate = game.privateData.itemsUpdates;

            this.$widget.$playerItems.children().each((index,element)=>{

                this.updateSlot(element);

            }
            );

        }

    },

    createSlots(keys, options) {

        let $slots = $("<div>");

        for (var key of keys) {

            let $slot = $("<div>").addClass("gui-slot gui-flex just-center align-start ");

            $slot.data("key", key);
            $slot.data("options", options);
            $slot.css({
                height: 80
            })

            $slot.on("click", options.onClick);

            this.updateSlot($slot);

            $slots.append($slot);

        }

        return $slots.children();

    },

    updateSlot($slot) {

        $slot = $($slot);

        let options = $slot.data("options");

        let data = options.dataSource($slot);

        if (!data.key)
            $slot.find(".sprite").remove();

        if (data.key && $slot.find(".sprite").length === 0) {

            let pickupDef = app.data.items[data.key];

            let sprite = new UI.Sprite({
                sprite: pickupDef.sprite || ("pickups/" + data.key),
                palette: pickupDef.palette !== undefined ? pickupDef.palette : -1,
                width: 32,
                height: 32,
                spin: pickupDef.spin ? pickupDef.spin : 0
            });

            sprite.$widget.appendTo($slot);
            sprite.$widget.addClass("sprite scale-2x");

        }

        if (data.count !== undefined && $slot.find(".count").length === 0) {

            let $count = $("<div>").addClass("gui-frame edge-center-bottom count red");

            $count.appendTo($slot);

        }

        if (data.count !== undefined) {

            $slot.find(".count").html(data.count);

        }

        if (data.hide)
            $slot.hide();
        else
            $slot.show();

    },

    /* Player items */

    playerItemDataSource($slot) {

        let index = $slot.data('key');

        return app.game.privateData.items[index];

    },

    onPlayerItemClick(event) {

        let $slot = $(event.currentTarget);

        let index = $slot.data("key");

        app.game.send("put_item_in_container", index);

    },

    /* Container items */

    containerItemDataSource($slot) {

        let key = $slot.data('key');

        let count = this.containerEntity.stock[key] | 0;

        return {
            "key": key,
            "count": count,
            "hide": count <= 0
        };

    },

    onContainerItemClick(event) {

        let $slot = $(event.currentTarget);

        let key = $slot.data("key");

        app.game.send("take_item_from_container", key);

    }

});

/* file: script/ui/LoginPrompt.js */

UI.LoginPrompt = function() {

    this.$element = UI.parse(this.template, this);

    UI.titleBar(this.$element, "Login", this);

    this.$element.$message.hide();

    var url = Utils.urlTemplate(this.facebookURI, {
        redirect_url: this.facebook_redirect_uri,
        app_id: "965055083615420"
    });

    this.$element.$facebookLogin.prop("href", url);

    /* Google login */

    var url = Utils.urlTemplate(this.googleURI, {
        redirect_url: this.google_redirect_uri,
        app_id: "965055083615420"
    });

    this.$element.$googleLogin.prop("href", url);

    /* Patreon login */

    var url = Utils.urlTemplate(this.patreonURI, {
        redirect_url: this.patreon_redirect_uri
    });

    this.$element.$patreonLogin.prop("href", url);

    this.$element.enhance();

    /* Email */

}
;

UI.LoginPrompt.prototype = {

    facebookURI: "https://www.facebook.com/dialog/oauth?client_id={app_id}&scope=email&redirect_uri={redirect_url}",
    patreonURI: "https://www.patreon.com/oauth2/authorize?response_type=code&scope=identity+campaigns.members&client_id=wQ-sNpVEdIdgrNr4SuJ17SEr_aZF1vzObb-xLA2Tsffno7tIkVe0Tg74HgXd_dRO&redirect_uri={redirect_url}",
    // patreonURI: "https://www.patreon.com/oauth2/authorize?response_type=code&client_id=wQ-sNpVEdIdgrNr4SuJ17SEr_aZF1vzObb-xLA2Tsffno7tIkVe0Tg74HgXd_dRO&redirect_uri={redirect_url}",
    googleURI: "https://accounts.google.com/o/oauth2/v2/auth?scope=email%20profile&redirect_uri={redirect_url}&response_type=code&client_id=74417074777-l9141b73533tp6fttd5dtt6uqd57nhq9.apps.googleusercontent.com",

    facebook_redirect_uri: (window.location.origin + window.location.pathname) + "api/facebook_login",
    patreon_redirect_uri: (window.location.origin + window.location.pathname) + "api/patreon_code/",
    google_redirect_uri: (window.location.origin + window.location.pathname) + "api/google_login",

    template: `
  <div class="gui-login-prompt style-1 window gui-rows spacing-md" style="width:380px">

      <p ui-id="message" style="color: #fff; text-align: center"></p>

      <span class="gui-form-divide"">Login using platform</span>      

      <div ui-id="platformLogin" class="gui-rows spacing-md frame-bronze" style="padding: 16px;">

        <div class="gui-cols spacing-md grow-equal">

          <a ui-id="facebookLogin" target="_blank" class="gui-button size-sm just-center facebook" title="Login using Facebook">
            <i class="icon facebook"></i>
            <span>FACEBOOK</span>
          </a>

          <a ui-id="patreonLogin" target="_blank" class="gui-button size-sm just-center patreon">
            <i class="icon patreon"></i>
            <span>PATREON</span>
          </a>

        </div>

        <div class="gui-cols spacing-md grow-equal">
        
          <a ui-id="googleLogin" target="_blank" class="gui-button size-sm just-center google" title="Login using Google">
            <i class="icon google"></i>
            <span>GOOGLE</span>
          </a>

          <a ui-id="twitterLogin" target="_blank" class="gui-button size-sm just-center twitter">
            <i class="icon twitter"></i>
            <span>TWITTER</span>
          </a>

        </div>

      </div>


      <span class="gui-form-divide">Login using email</span>
      
      <div ui-id="emailLogin" class="gui-rows spacing-md frame-silver" style="padding: 16px;">

        <form class="gui-rows spacing-md">
          <input ui-id="email" class="gui-input" placeholder="Email" name="email">
          <input ui-id="password" class="gui-input" placeholder="Password" name="password" type="password">
        </form>

        <div class="gui-cols spacing-md grow-equal">
          <span ui-id="login" class="gui-button green primary">login</span>
          <span ui-id="register" class="gui-button blue ">register</span>
          <span ui-id="recover" class="gui-button ">recover</span>
        </div>

      </div>

  </div>
  `,

    close() {

        this.$element.remove();

    },

    onNewsletterOptinClick() {

        this.$newsletterOptin.toggleClass("checked");

    },

    onTwitterLoginClick: function() {

        app.lobby.send("twitter_get_token");

        // if (window.analytics) analytics('send', 'event', 'menu', 'twitter_login_click');

        app.console.say("If you don't see a login window UNBLOCK POPUPS");

    },

    onRegisterClick() {

        app.lobby.ask("register_email", {

            email: this.$email.val(),
            password: this.$password.val()

        }).then((data)=>{

            if (data === true) {

                this.$emailLogin.html("Awesome. Now check out your email and click the confirmation link. If you don't see the link <b>PLEASE CHECK THE SPAM FOLDER</b>");
                this.$emailLogin.addClass("frame-gold");

            } else {

                app.console.error(data);

            }

        }
        );

    },

    onRecoverClick() {

        app.lobby.ask("request_recovery_email", {

            email: this.$email.val()

        }).then((data)=>{

            if (data === true) {

                this.$emailLogin.html("Great. If the email exists you should be receiving reset password link soon. If you don't see the link <b>PLEASE CHECK THE SPAM FOLDER</b>");
                this.$emailLogin.addClass("frame-gold");

            } else {

                app.console.error(data);

            }

        }
        );

    },

    onLoginClick() {

        app.lobby.ask("login_with_email", {

            email: this.$email.val(),
            password: this.$password.val()

        }).then((data)=>{

            if (data === true) {

                this.$emailLogin.html("You are logged in. Awesome.");
                this.close();

            } else {

                app.console.error(data);

            }

        }
        );

    }

}

/* file: script/ui/NewsletterPrompt.js */

UI.NewsletterPrompt = function() {

    this.$element = UI.parse(this.template, this);

    UI.titleBar(this.$element, "Login", this);

    this.$element.enhance();

    /* Email */

}
;

UI.NewsletterPrompt.prototype = {

    template: `
  <div class="gui-login-prompt style-1 window gui-rows spacing-md" style="width:380px">

      <span class="gui-form-divide"">Newsletter</span>      

      <p>Do you want to receive emails about what's new in the game? I only send important updates once or twice a month.</p>
      
      <div class="gui-cols spacing-md grow-equal">

        <span ui-id="yes" class="gui-button green">Yes, please.</span>
        <span ui-id="later" class="gui-button primary">Ask me later</span>
        <span ui-id="no" class="gui-button red">NO!</span>

      </div>

  </div>
  `,

    close() {

        this.$element.remove();

    },

    onYesClick() {

        app.lobby.ask("newsletter_optin", {
            state: 2
        });

        this.close();

    },

    onNoClick() {

        app.lobby.ask("newsletter_optin", {
            state: 1
        });

        this.close();

    },

    onLaterClick() {

        this.close();

    }

}

/* file: script/ui/ChangePasswordPrompt.js */

UI.ChangePasswordPrompt = function() {

    this.$element = UI.parse(this.template, this);

    UI.titleBar(this.$element, "Change password", this);

    this.$element.$message.hide();

    this.$element.enhance();

    /* Email */

}
;

UI.ChangePasswordPrompt.prototype = {

    template: `
  <div class="gui-login-prompt style-1 window gui-rows spacing-md" style="width:380px">

      <p ui-id="message" style="color: #fff; text-align: center"></p>

      <span class="gui-form-divide">Type new password</span>

      <p>You have requested password reset.</p>
      
      <div ui-id="emailLogin" class="gui-rows spacing-md frame-silver" style="padding: 16px;">

        <form class="gui-rows spacing-md">
          <input ui-id="password" class="gui-input" placeholder="Password" name="password" type="password">
        </form>

        <div class="gui-cols spacing-md grow-equal">
          <span ui-id="change" class="gui-button green">change password</span>
        </div>

      </div>

  </div>
  `,

    close() {

        this.$element.remove();

    },

    onChangeClick() {

        app.lobby.ask("request_recovery", {

            password: this.$password.val(),
            email: $_HASH['email'],
            recovery_key: $_HASH['reset_password'],

        }).then((data)=>{

            if (data === true) {

                this.$emailLogin.html("Your have assigned a new password. You can now close the window and login.");
                this.$emailLogin.addClass("frame-gold");

            } else {

                app.console.error(data);

            }

        }
        );

    }

}

/* file: script/ui/Quests.js */

UI.Quest = function(index, options={}) {

    this.index = index;

    this.$element = $("<div>");

    this.$element.addClass("gui-cols space-around quest gui-clickable gui-quest auto-basis");

    this.setState("login");

    if (options.clickable)
        this.$element.on("pointerup touchstart", this.onClick.bind(this));

}
;

Object.assign(UI.Quest.prototype, {

    update(data) {

        this.quest = data;

        if (data.key)
            this.questData = COMMON.quests[data.key];
        else
            this.questData = null;

        if (app.user.guest)
            this.setState("login");
        else if (!data && app.user.quest_cap)
            this.setState("ready");
        else if (!data && !app.user.quest_cap)
            this.setState("empty");
        else if (data.completed)
            this.setState("completed");
        else
            this.setState("active");

    },

    setState(state) {

        if (this.state === state)
            return;

        this.$element.removeClass("frame-bronze");
        this.$element.removeClass("frame-silver");
        this.$element.removeClass("frame-gold");
        this.$element.removeClass("frame-empty");
        this.$element.removeClass("frame-get-quest");
        this.$element.removeClass("completed");

        switch (state) {

        case "login":

            this.$element.addClass("frame-empty");
            this.$element.html("<p>LOGIN TO GET DAILY QUESTS</p>");

            break;

        case "empty":

            this.$element.tooltip(`<p class="warning">You can get 4 quests per day.</p>`);

            this.$element.addClass("frame-empty");
            this.$element.html("<p>NO MORE QUESTS TODAY. PLEASE CHECK TOMORROW</p>");

            break;

        case "ready":

            this.$element.addClass("frame-get-quest");
            this.$element.html("<p>TAP TO GET A NEW QUEST</p>");

            break

        case "active":
        case "completed":

            if (this.questData.reward >= 200)
                this.$element.addClass("frame-gold");
            else if (this.questData.reward >= 100)
                this.$element.addClass("frame-silver");
            else
                this.$element.addClass("frame-bronze");

            if (state === "active") {

                this.$element.html(`<p class="description">${this.questData.text}</p>`);
                this.$element.append(`<p class="reward gui-rows just-center align-center"><img src="images/coin.gif"><span>${this.questData.reward}</span></p>`);

                this.$element.tooltip(`
            <p class="positive">Left click to PLAY</p>
            <p class="negative">Right click to ABANDON QUEST</p>
          `);

            } else {

                this.$element.tooltip(`<p class="positive">Congratulations. Quest complete. Click to collect your reward.</p>`);

                this.$element.html(`<p><img src="images/coin.gif" class="scale-2"> ${this.questData.reward}</p>`);
                this.$element.addClass("completed");

            }

            if (this.questData.icon) {

                UI.icon("textures/quest_icons.png", this.questData.icon).appendTo(this.$element).addClass("icon");

            }

            break;

        }

        this.state = state;

    },

    onClick(e) {

        switch (this.state) {

        case "login":

            app.lobby.state.promptLogin("You have to be logged in to use that option.");

            break;

        case "active":

            if (e.button === 0) {

                if (this.questData.playMode !== undefined) {
                    app.lobby.state.onPlaytabClick();
                    app.lobby.state.mode = this.questData.playMode;
                    app.lobby.state.onPlayClick();
                }

            } else if (e.button === 2) {

                app.lobby.ask("dismiss_quest", {
                    index: this.index
                });

                app.sound.play("ctf/enemy_score");

            }

            break;

        case "ready":

            app.lobby.ask("get_quest");
            app.sound.play("ui/new_quest");

            break;

        case "completed":

            app.lobby.ask("claim_quest_reward", {
                index: this.index
            });

            app.sound.play("ui/collect_reward");

            break;

        }

    }

});

/* file: script/ui/Prompt.js */

UI.Prompt = function(question, text) {

    CLIENT.Events.call(this);

    this.$element = UI.parse(this.template, this);

    UI.titleBar(this.$element, "Question", this);

    this.$element.enhance();

    this.$element.find(".question").html(question);
    this.$element.find(".text").html(text);

}
;

UI.Prompt.prototype = {

    template: `
  <div class="gui-login-prompt style-1 window gui-rows spacing-md" style="width:380px">

      <span class="gui-form-divide question">Prompt</span>      

      <p class="text"></p>
      
      <div class="gui-cols spacing-md grow-equal">

        <span ui-id="yes" class="gui-button green">Yes.</span>
        <span ui-id="no" class="gui-button red">NO!</span>

      </div>

  </div>
  `,

    close() {

        this.$element.remove();

    },

    onYesClick() {

        this.trigger("yes");

        this.close();

    },

    onNoClick() {

        this.trigger("no");

        this.close();

    }

}

Object.assign(UI.Prompt.prototype, CLIENT.Events.prototype);

/* file: script/ui/QuestCounter.js */

UI.QuestCounter = function(i) {

    this.$element = $("<div>");

    this.$element.addClass("quest-counter");

    this.$element.addClass("quest-counter-" + i);

    this.index = i;

    if (!app.user.quests[i]) {

        this.data = false;

    } else {

        this.data = Object.assign({}, app.user.quests[i], COMMON.quests[app.user.quests[i].key]);

    }

    this.update(this.data)

    this.$element.on("mouseenter", this.onMouseEnter.bind(this));
    this.$element.on("mouseleave", this.onMouseLeave.bind(this));

}
;

UI.QuestCounter.prototype = {

    update(data) {

        this.$element.removeClass("frame-bronze");
        this.$element.removeClass("frame-silver");
        this.$element.removeClass("frame-gold");
        this.$element.removeClass("frame-empty");
        this.$element.removeClass("frame-get-quest");
        this.$element.removeClass("completed");

        if (data) {

            if (data.reward >= 200)
                this.$element.addClass("frame-gold");
            else if (data.reward >= 100)
                this.$element.addClass("frame-silver");
            else
                this.$element.addClass("frame-bronze");

            if (data.completed) {

                this.$element.html(`<img src="images/coin.gif" class="scale-2">`);
                this.$element.addClass("completed");

            } else {

                this.$element.html(data.count || "1");

            }

            if (data.count !== this.data.count)
                app.sound.play("ui/quest_progress");
            if (data.completed !== this.data.completed) {
                app.sound.play("ui/collect_reward");
                app.console.say("Quest complete! " + this.data.text, "good");
                if (window.fbq)
                    fbq('trackCustom', 'QuestComplete');
            }

        } else {

            this.$element.html("?");
            this.$element.addClass("frame-get-quest");

        }

        Object.assign(this.data, data);

    },

    onMouseEnter() {

        if (!this.data) {

            this.$tooltip = $("<div>").addClass("frame-bronze").appendTo(document.body);
            this.$tooltip.html("GO TO MENU TO GET A NEW QUEST");

        } else if (this.data.completed) {

            this.$tooltip = $("<div>").addClass("frame-gold").appendTo(document.body);
            this.$tooltip.html("GO TO MENU TO COLLECT REWARD");

        } else {

            let tooltip = new UI.Quest();

            tooltip.update(this.data);

            tooltip.$element.appendTo(document.body);

            this.$tooltip = tooltip.$element;

        }

        this.$tooltip.css({
            position: "absolute",
            zIndex: 1,
            right: 64,
            top: this.$element.position().top + this.$element.outerHeight() / 2 - this.$tooltip.outerHeight() / 2
        });

    },

    onMouseLeave() {

        if (this.$tooltip) {

            this.$tooltip.remove();

            this.$tooltip = null;

        }

    }

};

/* file: script/ui/GamesList.js */

UI.GamesList = function() {

    this.$element = UI.parse(this.template, this);

    this.$element.addClass("UIGamesList");

    this.askTimer = setInterval(this.ask.bind(this), 5000);

    this.closed = false;

    UI.toggles(this.$tabs, "arena2", this.selectTab.bind(this));

}
;

UI.GamesList.prototype = {

    template: `
    <div class="spacing-sm gui-rows">

      <div ui-id="tabs" class="gui-toggles gui-cols grow-equal" style="position: relative; z-index: 2">
        <span ui-value="arena1">Arena [1vs1]</span>      
        <span ui-value="arena2">Browars [2vs2]</span>      
        <span ui-value="soccer">Soccer [4vs4]</span>      
      </div>

      <div class="spacing-sm gui-rows" ui-id="list"></div>
    </div>
  `,

    selectTab(mode) {

        mode = mode;

        this.mode = mode;

        this.ask();

    },

    kill() {
    },

    ask() {

        app.lobby.ask("list_games", {

            mode: this.mode

        }).then(this.refresh.bind(this));

    },

    refresh(data) {

        this.$list.empty();

        if (!data || !Object.keys(data).length) {

            this.$list.html("<p class='text-align-center'>PLEASE WAIT. NO GAMES OF THIS MODE ARE BEING PLAYED RIGHT NOW</p>");

            return;

        }

        for (let key in data)
            data[key].key = key;

        let entries = Utils.sortBy(data, (e)=>{

            if (!e)
                return 0;
            if (!e.users[0])
                return 0;
            if (!e.users[1])
                return 0;

            return -Math.max(e.users[0].mmr, e.users[1].mmr);

        }
        );

        for (let entry of entries) {

            let key = entry.key;
            let $row = $("<div>").addClass("gui-cols spacing-md row");

            let modeData = COMMON.modes[entry.mode];

            var i = 0;

            let $vs = $("<span class='vs'>vs</span>");

            for (let user of entry.users) {

                if (i > 1)
                    break;

                let $user = $("<span>");

                let rankIcons = COMMON.RANK_ICONS[modeData.scoreKey];

                let rank = CLIENT.Ranks.pointsToRank(user.mmr, app.lobby.maxMMR[modeData.scoreKey], rankIcons.length);

                var $icon = UI.icon("images/rank_icons.png?2", rankIcons[rank]).addClass("icon rank");

                $user.append(user.name || "???");

                user.flag = user.flag || "xx";

                let $flag = UI.getFlag(user.flag);

                if (i === 0) {
                    $vs.prepend($flag.addClass("left"));
                    $vs.prepend($icon.addClass("left"));
                } else {
                    $vs.append($flag.addClass("right"));
                    $vs.append($icon.addClass("right"));
                }

                $user.appendTo($row);
                $user.addClass("grow-2 text-align-center");

                if (!i) {

                    $row.append($vs);

                }

                i++;

            }

            // $row.append(`<span class='grow-1 score'>${entry.score[0]} : ${entry.score[1]}</span>`);

            let clients = entry.clients | 0;

            let $watch = $("<span>").addClass("gui-button green").html(`${clients}`).appendTo($row).data("game_key", key);

            $row.on("click touchstart", this.onWatchClick.bind(this, $watch));

            $row.appendTo(this.$list)

        }

    },

    onWatchClick($button) {

        let key = $button.data("game_key");

        app.lobby.send("spectate", {
            key: key
        });

    },

    close() {

        if (this.closed)
            return;

        this.closed = true;

        this.$element.remove();

        clearInterval(this.askTimer);

    }

}

/* file: script/ui/CountryPicker.js */

UI.CountryPicker = function() {

    this.dialog = UI.parse2(this.dialogTemplate);
    this.dialog.input.addEventListener("keyup", this.onInputKeyUp.bind(this));
    this.dialog.input.addEventListener("keydown", this.onInputKeyDown.bind(this));

    this.flag = new UI.Flag();
    this.flag.element.style.position = "relative";

    this.element = this.flag.element;

    UI.on(this.element, ["mousedown", "touchstart"], this.onClick.bind(this));

    this.element.appendChild(this.dialog.element);

    this.hideDialog();

    this.events = new CLIENT.Events;

}
;

UI.CountryPicker.prototype = {

    dialogTemplate: `
        <div class="CountryPickerDialog flex-rows">
            <input placeholder="Search your country" class="gui-input" data-id="input" type="text">
            <div data-id="results" class="results scroll"></div>
        </div>
    `,

    itemTemplate: `
        <div class="gui-cols align-items-center">
            <span data-id="flagPlaceholder"></span>
            <span data-id="name" class="flex-grow"></span>
        </div>

    `,

    search() {

        let phrase = this.dialog.input.value;

        let results = [];

        let regex;

        if (phrase)
            regex = new RegExp(phrase.split("").join(".*"),"i");
        else
            regex = new RegExp(".*");

        for (var country in COMMON.countryNames) {

            let name = COMMON.countryNames[country];

            if (!name.match(regex))
                continue;

            if (name[0] === phrase[0])
                results.unshift(country);
            else
                results.push(country);

        }

        this.showResults(results);

    },

    showResults(results) {

        if (!results.length)
            return;

        this.dialog.results.innerHTML = "";

        for (let country of results) {

            let name = COMMON.countryNames[country];

            let item = UI.parse2(this.itemTemplate);

            /* flag */

            let flag = new UI.Flag();

            flag.set(country);

            UI.replace(item.flagPlaceholder, flag.element);

            /* name */

            item.name.innerHTML = name.split("|").shift().trim();

            /* append */

            this.dialog.results.appendChild(item.element);

            /* select */

            UI.on(item.element, ["mousedown", "touchstart"], this.onItemClick.bind(this, country));

            item.element.dataset.country = country;

        }

        this.preselect(0);

    },

    showDialog() {

        UI.show(this.dialog.element);
        this.dialog.input.value = "";
        this.search();

    },

    hideDialog() {

        UI.hide(this.dialog.element);

    },

    onClick() {

        this.dialog.input.value = "";

        this.showDialog();

        setTimeout(()=>{

            this.dialog.input.focus();

        }
        );

    },

    onItemClick(country) {

        if (!country)
            return;

        this.set(country, true);

        app.lobby.ask("User/SetCountry", {
            country
        });

        setTimeout(()=>{

            this.hideDialog();

        }
        );

    },

    onInputKeyUp(event) {

        if (this.prevValue !== this.dialog.input.value)
            this.search();

    },

    onInputKeyDown(event) {

        this.prevValue = this.dialog.input.value;

        if (event.key === "ArrowDown")
            this.next();
        if (event.key === "ArrowUp")
            this.prev();
        if (event.key === "Enter") {

            this.onItemClick(this.preselectedValue);

        }

    },

    preselect(element) {

        let $results = $(this.dialog.results);

        if (typeof element === "number")
            element = $results.children().get(element);

        $results.children().removeClass("preselected");
        $(element).addClass("preselected");

        this.preselectedValue = element.dataset.country;

        element.scrollIntoView();

    },

    next() {

        let next = $(this.dialog.results).children(".preselected").next().get(0);
        if (next)
            this.preselect(next);

    },

    prev() {

        let prev = $(this.dialog.results).children(".preselected").prev().get(0);
        if (prev)
            this.preselect(prev);

    },

    set(country, click) {

        this.value = country;
        this.flag.set(country);

        this.events.trigger("change", {
            click,
            country
        });

    }

};

/* file: script/ui/Flag.js */

UI.Flag = function() {

    this.ui = UI.parse2(this.template);

    this.element = this.ui.element;
    this.set("xx");

}
;

UI.Flag.prototype = {

    template: `
		<div class="Flag">			
			<img data-id="image" src="">
        </div>

	`,

    constructor: UI.RankBar,

    set(country) {

        this.ui.image.src = "svg/flags/" + country + ".svg";

        this.value = country;

    }

};

/* file: script/components/MiniShop.js */

CLIENT.Components.MiniShop = function() {

    this.shopkeeperLifespan = 0;

}
;

CLIENT.Components.MiniShop.prototype = {

    create() {
    },

    onevent(event, data) {

        this["on" + event](data);

    },

    onsale() {

        if (this.data.shopkeeper)
            this.shopkeeperLifespan = 1.0;

    },

    step(dt) {

        if (this.shopkeeperLifespan > 0)
            this.shopkeeperLifespan -= dt;

    },

    render(layer) {

        if (this.shopkeeperLifespan > 0) {

            let shopkeeper = this.data.shopkeeper;

            let x = this.subject.x + (shopkeeper.x - this.subject.data.sprite[0]) - this.subject.data.sprite[2] / 2 | 0;
            let y = this.subject.y + (shopkeeper.y - this.subject.data.sprite[1]) - this.subject.data.sprite[3] / 2 | 0;

            app.painter.reset();
            app.painter.align(0, 0);
            app.painter.drawImageRegion(this.subject.image, ...shopkeeper.sprite, x, y)

        }

    }

};

/* file: script/entities/DebugPoint.js */

CLIENT.DebugPoint = function(args) {

    this.x = 0;
    this.y = 0;

    Object.assign(this, args);

    this.update(this.shared);

}
;

CLIENT.DebugPoint.prototype = {

    constructor: CLIENT.DebugPoint,

    zIndex: 5,

    radius: 2,

    shape: CLIENT.CIRCLE,

    update: function(data) {

        Object.assign(this.shared, data);

        if (data.x !== undefined)
            this.x = data.x;
        if (data.y !== undefined)
            this.y = data.y;

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

    },

    step: function(dt) {
    },

    render: function() {

        app.painter.reset();
        app.painter.color(0xffffff);
        app.painter.fillCircle(this.x, this.y, 4);
    }

};

/* file: script/entities/Animation.js */

CLIENT.Animation = function(args) {

    this.reset(args);

}
;

CLIENT.Animation.pool = true;

CLIENT.Animation.prototype = {

    zIndex: 5,

    colorMode: "source-in",

    shape: CLIENT.Circle,

    radius: 2,

    constructor: CLIENT.Animation,

    _destruct: function() {

        app.pool(this);

    },

    reset: function(args) {

        Object.assign(this, args);

        app.tween(this).discard();

        Object.assign(this, this.defaults, args);

        this.delta = 0;

        this.data = {};

        if (this.key)
            this.set(this.key);

        CLIENT.Events.call(this);

    },

    defaults: {
        auto: false,
        color: false,
        blendMode: false,
        colorMode: "source-in",
        loop: false,
        rotation: 0,
        scale: 1,
        attachedTo: false,
        attachedToRotation: false,
        alpha: 1.0,
        offsetX: 0,
        offsetY: 0,
        key: false,
        finished: false,
        offsetRotation: 0,
        reverse: false,
        scaleX: 1,
        scaleY: 1,
        fadingOut: false,
        delay: 0,
        alignX: 0.5,
        alignY: 0.5,
        onion: 0,
        zIndex: 5,
        onstep: false,
        velocity: 0,
        direction: 0,
        shadowOffsetX: 0,
        shadowOffsetY: 0,
        shadowAngle: 1.0,
        shadowRotation: -Math.QPI,
        src: "",
        x: 0,
        y: 0,
        z: 0,
    },

    stateDefaults: {
        loop: false,
        ready: false,
        delta: 0,
        reverse: false,
        finished: false,
        alignX: 0.5,
        alignY: 0.5,
        easing: false,
        flipX: false,
        flipY: false
    },

    set: function(key, more) {

        key = key.toUpperCase();

        this.finished = false;

        var self = this;

        var animation = this;

        var args = app.data.animations[key];

        this.data = args;

        if (!args)
            throw "there is no such animation as " + key;

        this.current = Object.assign({}, args, more);

        Object.assign(this, this.stateDefaults, this.current);

        this.key = key;

        var src = this.src;

        if (!app.images[this.src]) {

            app.loadImage(this.src).then(function() {

                if (src === self.src)
                    self.prepare();
                // else throw "SHIT HAPPENS";

            });

        } else
            this.prepare();

        this.play();

    },

    stop: function() {

        this.stopped = true;
        this.delta = 0;
        this.frame = 0;

    },

    play: function() {

        this.stopped = false;

    },
    pause: function() {

        this.stopped = true;

    },

    prepare: function() {

        if (this.color) {

            this.image = app.getColoredImage(this.src, this.color, this.colorMode);

        } else {

            this.image = app.images[this.src];

        }

        this.framesX = this.image.width / this.width | 0;
        this.region = [0, 0, this.width, this.height];

        if (this.current.absAlignX === undefined)
            this.absAlignX = this.width * this.alignX | 0;
        if (this.current.absAlignY === undefined)
            this.absAlignY = this.height * this.alignY | 0;

        if (this.flipX || this.flipY) {

            if (this.flipX && !this.image.flipX) {

                var temp = cq(this.image.width, this.image.height);

                var cols = Math.ceil(this.image.height / this.height);

                for (var i = 0; i < this.framesX * cols; i++) {

                    var col = i % this.framesX | 0;
                    var row = i / this.framesX | 0;

                    var x = this.width * col;
                    var y = this.height * row;

                    temp.save();
                    temp.translate(x, y);
                    temp.scale(-1.0, 1.0);

                    temp.drawImage(this.image, x, y, this.width, this.height, -this.width, 0, this.width, this.height);
                    temp.restore();

                }

                this.image.mirrorX = temp.cache();

            }

            if (this.flipY && !this.image.flipY) {

                var temp = cq(this.image.width, this.image.height);

                var cols = Math.ceil(this.image.height / this.height);

                for (var i = 0; i < this.framesX * cols; i++) {

                    var col = i % this.framesX | 0;
                    var row = i / this.framesX | 0;

                    var x = this.width * col;
                    var y = this.height * row;

                    temp.save();
                    temp.translate(x, y);
                    temp.scale(1.0, -1.0);

                    temp.drawImage(this.image, x, y, this.width, this.height, 0, -this.height, this.width, this.height);
                    temp.restore();

                }

                this.image.mirrorY = temp.cache();

            }

            if (this.flipX)
                this.image = this.image.mirrorX;
            if (this.flipY)
                this.image = this.image.mirrorY;

        }

        this.ready = true;

        this.step(0);

    },

    then: function(key, data) {

        this.unloop();

        if (this.finished || !this.key)
            return this.set(key, data);

        if (!this.next)
            this.next = [];

        this.next.push(key, data);

    },

    cancel: function() {
        this.loop = false;
        this.delta = this.duration;
    },

    unloop: function() {

        this.loop = false;

    },

    cancel: function() {

        this.next = false;
        this.loop = false;
        this.delta = this.duration - 0.05;

    },

    fadeOut: function(duration) {

        this.fadeOutInc = this.alpha / ((duration || 1) * this.duration);

        this.fadingOut = true;

    },

    step: function(delta) {

        if (!this.ready)
            return;

        // delta *= G.timeFactor;

        if ((this.delay -= delta) > 0)
            return;

        if (!this.firestarted) {
            this.firestarted = true;

            if (this.flash)
                G.flash(0.25, 1);
            if (this.shake)
                G.shake(0.5, 3);
        }

        if (!this.stopped)
            this.delta += delta;

        if (this.onstep)
            this.onstep(delta);

        if (this.fadingOut) {
            this.alpha -= this.fadeOutInc * delta;
            if (this.alpha < 0) {
                this.cancel();
                this.fadingOut = false;
                return;
            }
        }

        if (!this.stopped) {

            if (!this.loop) {

                var progress = Math.min(1.0, this.delta / this.duration);

                if (this.easing)
                    progress = app.ease(progress, this.easing);

                if (this.reverse)
                    this.frame = Math.min(this.frames - 1, (1 - progress) * this.frames | 0);
                else
                    this.frame = Math.min(this.frames - 1, progress * this.frames | 0);

                if (this.delta >= this.duration && !this.finished) {

                    if (this.next && this.next.length) {

                        this.set(this.next.shift(), this.next.shift());

                        return;

                    } else if (this.end) {

                        this.set(this.end.key, this.end);
                        this.end = false;

                    } else {

                        if (this.collection && this.auto)
                            this.collection.remove(this);

                        this.trigger("finish");
                        this.finished = true;
                        this.pause();

                    }

                }

            } else {

                var progress = this.delta % this.duration / this.duration;

                if (this.easing)
                    progress = app.ease(progress, this.easing);

                this.frame = progress * this.frames | 0;

                if (this.reverse)
                    this.frame = (this.frames - 1) - this.frame;

                if (this.delta > this.duration)
                    this.delta = this.delta % this.duration;

            }

            if (this.frameSkip)
                this.frame = (this.frame / this.frameSkip | 0) * this.frameSkip;

        }

        this.region[0] = (this.frame % this.framesX | 0) * this.width;
        this.region[1] = (this.frame / this.framesX | 0) * this.height;

        if (this.velocity) {

            this.x += Math.cos(this.direction) * this.velocity * delta;
            this.y += Math.sin(this.direction) * this.velocity * delta;

            this.velocity = Utils.moveTo(this.velocity, 0, 16 * delta);

        }

        if (this.attachedTo) {

            if (this.attachedToRotation) {

                this.rotation = this.attachedTo.rotation;

                var pos = Utils.rotate(this.offsetX, this.offsetY, 0, 0, this.attachedTo.rotation);

                this.x = this.attachedTo.x + pos[0];
                this.y = this.attachedTo.y + pos[1];

            } else {

                this.x = this.attachedTo.x + this.offsetX;
                this.y = this.attachedTo.y + this.offsetY;

            }

            if (this.attachedTo.z) {

                this.z = this.attachedTo.z;

            }

        }

    },

    renderPreviousFrame: function(steps) {

        var prev = this.frame - steps;

        if (prev < 0) {

            if (!this.loop)
                return;

            prev = this.frames - steps - 1;

        }

        this.region[0] = (prev % this.framesX) * this.width;
        this.region[1] = (prev / this.framesX | 0) * this.height;

        var a = 1 - (steps / (this.onion + 1));

        app.layer.a(this.alpha * a);
        app.layer.drawRegion(this.image, this.region, -this.absAlignX, -this.absAlignY);
        app.layer.ra();

    },

    skip: function(frames) {

        this.delta += (this.duration / this.frames) * frames;

    },

    prerender: function() {

        if (!this.ready)
            return;

        if (this.delay > 0)
            return;

        if (this.alpha < 0)
            return;
        if (this.shadow) {

            app.layer.save();
            app.layer.translate(this.x + this.shadowOffsetX | 0, this.y + this.shadowOffsetY | 0);

            app.layer.scale(0.8, 0.8);
            if (this.scale !== 1)
                app.layer.scale(this.scale, this.scale);
            if (this.scaleX !== 1 || this.scaleY !== 1)
                app.layer.scale(this.scaleX, this.scaleY);
            app.layer.rotate(this.shadowRotation * this.shadowAngle + this.rotation)
            app.layer.drawRegion(app.getColoredImage(this.image, CLIENT.SHADOW_COLOR, "source-in"), this.region, -this.absAlignX, -this.absAlignY - 2);

            app.layer.restore();
        }

    },

    render: function(delta) {
        return;
        if (!this.ready)
            return;

        if (this.delay > 0)
            return;

        if (this.alpha < 0)
            return;

        app.layer.save();
        app.layer.translate(this.x | 0, this.y - this.z | 0);

        if (this.rotation)
            app.layer.rotate(this.rotation + this.offsetRotation);
        if (this.blendMode)
            app.layer.globalCompositeOperation(this.blendMode).a(1.0);

        if (this.scale !== 1)
            app.layer.scale(this.scale, this.scale);
        if (this.scaleX !== 1 || this.scaleY !== 1)
            app.layer.scale(this.scaleX, this.scaleY);

        if (this.alpha < 1)
            app.layer.a(this.alpha);

        app.layer.drawRegion(this.image, this.region, -this.absAlignX, -this.absAlignY);

        for (var i = 0; i < this.onion; i++) {

            this.renderPreviousFrame(i + 1);

        }

        app.layer.restore();

    }

};

Object.assign(CLIENT.Animation.prototype, CLIENT.Events.prototype);

CLIENT.Animation.colorObject = {
    color: "#000",
    mode: "source-in"
};

CLIENT.Animation.color = function(color, mode) {

    CLIENT.Animation.colorObject.color = color;
    CLIENT.Animation.colorObject.mode = mode;

    return CLIENT.Animation.colorObject;

}
;

CLIENT.Animation.LOOP = {
    loop: true
};

CLIENT.Animation.NOLOOP = {
    loop: false
};

/* file: script/entities/Rect.js */

CLIENT.Rect = function(args) {

    this.x = 0;
    this.y = 0;
    this.z = 0;

    Object.assign(this, args);

}
;

CLIENT.Rect.prototype = {

    shape: CLIENT.CIRCLE,

    radius: 2,

    render() {

        app.painter.reset()
        app.painter.color(0x000001);
        app.painter.fillRect(this.x, this.y, 2, 2);
    }

}

/* file: script/entities/Text.js */

CLIENT.Text = function(args) {

    this.x = 0;
    this.y = 0;
    this.z = 0;

    this.offsetZ = 0;
    this.text = "";
    this.foreground = 0x000000;
    this.background = null;
    this.follow = null;

    Object.assign(this, args);

}
;

CLIENT.Text.prototype = {

    shape: CLIENT.CIRCLE,

    radius: 2,

    zIndex: 4,

    step(dt) {
        if (this.follow) {
            this.x = this.follow.x;
            this.y = this.follow.y;
            this.z = this.follow.z;
        }

    },

    render() {

        if (!this.text)
            return;
        if (this.game.hideUI)
            return;

        let textWidth = this.game.nameFont.getWidth(this.text);

        app.painter.reset()

        if (this.background) {

            app.painter.color(this.background);
            app.painter.fillRect(this.x, this.y, textWidth, 12);

        }

        app.painter.color(this.foreground);

        this.game.nameFont.color = this.foreground;
        this.game.nameFont.fillText(this.text, Math.floor(this.x), Math.floor(this.y - this.z - this.offsetZ));

    }

};

/* file: script/entities/Circle.js */

CLIENT.Circle = function(args) {

    this.x = 0;
    this.y = 0;
    this.z = 0;
    this.radius = 2;
    this.alpha = 1.0;
    this.color = 0xffffff;
    this.scaleX = 1.0;
    this.scaleY = 1.0;
    this.scale = 1.0;
    Object.assign(this, args);

}
;

CLIENT.Circle.prototype = {

    shape: CLIENT.CIRCLE,

    radius: 2,

    zIndex: 2,

    step(dt) {
        if (this.follow) {

            this.x = this.follow.x;
            this.y = this.follow.y;
            this.z = this.follow.z;

        }
    },

    render() {

        app.painter.reset()
        app.painter.color(this.color);
        app.painter.alpha(this.alpha);
        app.painter.scale(this.scaleX * this.scale, this.scaleY * this.scale);
        app.painter.fillCircle(this.x, this.y - this.z, this.radius);
    }

}

CLIENT.Snowflake = function(args) {
}
;

CLIENT.Snowflake.prototype = {

    shape: CLIENT.CIRCLE,

    radius: 2,

    colors: [0xaaaabb, 0xffffff],

    groups: ["snowflakes"],

    _destruct: function() {

        if (this._fromPool)
            app.pool(this);

    },

    reset(args) {

        this.x = 0;
        this.y = 0;
        this.z = 200;
        this.radius = 2;
        this.alpha = 1.0;
        this.color = 0xffffff;
        this.scaleX = 1.0;
        this.scaleY = 1.0;
        this.scale = 1.0;
        this.lifetime = 0;
        this.random = Math.random();
        this.random2 = Math.random();
        this.front = Math.random() > 0.5;
        this.zIndex = 5 + this.front;

        Object.assign(this, args);

    },

    render() {
        if (this.z <= 0)
            return;

        app.painter.reset()
        app.painter.color(this.colors[this.front | 0]);
        app.painter.alpha(this.alpha);
        app.painter.translate(this.x, this.y - this.z);
        app.painter.scale(this.scaleX * this.scale, this.scaleY * this.scale);
        app.painter.fillCircle(0, 0, this.radius);

    },

    step(dt) {

        this.inView = true;
        this.lifetime += dt;

        this.z -= dt * (25 + this.front * 25);

        if (this.z <= 0 && !this.lifespan)
            this.lifespan = 0.1;

        this.scale = (1.0 + this.front) * (this.z / 200);

        this.x += Math.sin(this.lifetime * 4 + this.random * 6) * 50 * dt * (0.5 + this.random);
        this.x -= this.random * 100 * dt * 4;

    }

}

/* file: script/entities/VisibilityLayer.js */

CLIENT.VisibilityLayer = function(args) {
    this.x = 0;
    this.y = 0;
    this.z = 0;

    Object.assign(this, args);

}
;

CLIENT.VisibilityLayer.prototype = {

    zIndex: 3,

    render() {

        let game = this.game;

        if (!game.player || (!game.player.tile || !game.player.tile.groundDef || !game.player.tile.groundDef.floor))
            return this.game.setHouseMusic(false);

        this.game.setHouseMusic(true);

        var camera = game.camera;

        var tilesX = camera.ww / COMMON.TILE_WIDTH | 0;
        var tilesY = camera.wh / COMMON.TILE_HEIGHT | 0;

        var startX = Math.floor(camera.wx / COMMON.TILE_WIDTH);
        var startY = Math.floor(camera.wy / COMMON.TILE_HEIGHT);
        app.painter.reset();
        app.painter.align(0.0, 0.0);
        app.painter.color(0x111111);

        for (var x = -1; x <= tilesX + 1; x++) {
            for (var y = -1; y <= tilesY + 2; y++) {

                var tx = startX + x;
                var ty = startY + y;
                var tile = game.map.get(tx, ty);
                var down = game.map.get(tx, ty + 1);
                var up = game.map.get(tx, ty - 1);

                if (tile.groundDef && tile.groundDef.floor)
                    continue;
                if (down.groundDef && down.groundDef.floor)
                    continue;
                if (up.groundDef && up.groundDef.floor)
                    continue;

                // app.painter.fillRect(tx * COMMON.TILE_WIDTH, ty * COMMON.TILE_HEIGHT, COMMON.TILE_WIDTH, COMMON.TILE_HEIGHT);
                app.painter.drawAtlas("dark_tile", tx * COMMON.TILE_WIDTH - 8, ty * COMMON.TILE_HEIGHT - 8)
            }

        }
    }

};

/* file: script/entities/Image.js */

CLIENT.Image = function(args) {

    this.x = 0;
    this.y = 0;
    this.z = 0;
    this.width = 1;
    this.height = 1;

    Object.assign(this, args);

}
;

CLIENT.Image.prototype = {

    shape: CLIENT.RECT,

    step: function() {
    },

    render: function(layer) {

        this.width = this.region[2];
        this.height = this.region[3];

        app.painter.reset();
        app.painter.align(0, 0);
        app.painter.drawImageRegion(this.image, ...this.region, this.x, this.y);

    }

};

/* file: script/entities/FortFlag.js */

CLIENT.FortFlag = function(args) {

    this.x = 0;
    this.y = 0;

    this.width = 32;
    this.height = 64;
    this.alignY = 0.0;

    this.lifetime = Math.random() * 10;

    Object.assign(this, args);

    this.update(this.shared);

}
;

CLIENT.FortFlag.prototype = {

    constructor: CLIENT.FortFlag,

    zIndex: 2,

    shape: CLIENT.RECT,

    update: function(data) {

        if (data.x !== undefined)
            this.x = data.x;
        if (data.y !== undefined)
            this.y = data.y;

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

        Object.assign(this.shared, data);

    },

    step: function(dt) {

        this.lifetime += dt;

    },

    render: function(layer, dt) {

        app.painter.reset();
        app.painter.align(0.5, 0.0);
        app.painter.color(0x663931);
        app.painter.fillRect(this.x + 2, this.y, 4, 64);

        app.painter.reset();
        app.painter.palette(this.shared.team);
        app.painter.drawSprite("flag", this.x, this.y, this.lifetime * 8, 32 + Math.sin(app.lifetime) * 5.0);

    }

};

/* file: script/entities/Blast.js */

CLIENT.Blast = function(args) {

    this.blendMode = false;
    this.delay = 0;
    this.follow = 0;
    this.x = 0;
    this.y = 0;
    this.z = 0;
    this.offsetX = 0;
    this.offsetY = 0;
    this.radius = 50;
    this.color = false;
    this.lifetime = 0;
    this.duration = 0.8;
    this.type = "default";
    this.repeat = 0;
    this.reverse = false;

    Object.assign(this, args);

}
;

CLIENT.Blast.prototype = {
    zIndex: 1,
    shape: CLIENT.CIRCLE,

    types: {
        "default": ["normal", 0],
        "dust": ["dust", "color-dodge"],
        "sunken": ["sunken"],
    },

    step: function(dt) {

        if (this.delay > 0) {

            return this.delay -= dt;

        }

        if (this.follow) {

            this.x = this.follow.x + this.offsetX;
            this.y = this.follow.y + this.offsetY;

        }

        if (this.repeat && !this.init) {

            this.init = true;

            for (var i = 0; i < this.repeat; i++) {

                this.collection.add("Blast", {
                    x: this.x,
                    y: this.y,
                    z: this.z,
                    duration: this.duration,
                    type: this.type,
                    radius: this.radius,
                    reverse: this.reverse
                });

            }

        }

        this.lifetime += dt;

        if (this.duration && this.lifetime > this.duration) {

            this.collection.remove(this);

        }

    },

    render: function(layer, x, y) {

        var def = this.types[this.type];

        x = x | 0;
        y = y | 0;

        var scale = this.radius / 120;

        var progress = Math.min(1.0, this.lifetime / this.duration);

        var alphaProgress = app.ease(progress, "inSine");

        if (this.reverse) {

            var scaleProgress = 1 - app.ease(progress, "outSine");

        } else {

            var scaleProgress = app.ease(progress, "outSine");

        }

        var image = app.textures.blasts[def[0]];

        app.painter.reset();
        app.painter.alpha(1 - alphaProgress);
        app.painter.translate(x + this.x, y + this.y - this.z);
        app.painter.scale(scaleProgress * scale, scaleProgress * scale * 0.6);
        app.painter.align(0.5, 0.5);

        app.painter.drawImage(image, 0, 0);

    }

};

/* file: script/entities/Coin.js */

CLIENT.Coin = function(args) {

    Object.assign(this, args);

    this.x = 0;
    this.y = 0;
    this.z = 0;
    this.speed = 100;

    this.sprite = new CLIENT.Sprite();

    this.sprite.set(Utils.random(this.sprites), true);

    this.sprite.setDuration(0.25 + Math.random() * 0.5);

    this.tween = app.tween(this);

}
;

CLIENT.Coin.prototype = {

    zIndex: 2,
    shape: CLIENT.CIRCLE,
    radius: 8,

    sprites: ["pickups/gold_coin", "pickups/bronze_coin", "pickups/silver_coin"],

    create() {

        let angle = Math.random() * 6;
        let duration = 0.25 + Math.random() * 0.6;

        this.z = 50;

        this.tween.to({
            x: this.x + Math.cos(angle) * 100,
            y: this.y + Math.sin(angle) * 100,
        }, duration);

        this.tween.to({
            z: 0
        }, duration, "outBounce");

    },

    step(dt) {

        this.sprite.step(dt);

        this.sprite.scale = 1 + (this.z / 100);

        if (this.tween.finished) {

            this.speed = Math.min(1000, this.speed + dt * 1000);

            let angle = Utils.lookAt(this, this.follow);

            this.x += Math.cos(angle) * this.speed * dt;
            this.y += Math.sin(angle) * this.speed * dt;

            this.z = Utils.moveTo(this.z, 10, 200 * dt);

            if (Utils.quickPointInRange(this.x, this.y, this.follow.x, this.follow.y, 8))
                this.kill();

        }

    },

    kill() {

        this.collection.remove(this);

        var sprite = this.collection.add("Sprite");

        sprite.x = this.x;
        sprite.y = this.y;
        sprite.z = this.z;
        sprite.set("collect", false);
        sprite.setDuration(0.2);

        if (this.follow === this.game.player)
            app.sound.play("ui/coin_end").rrate(0.1);

    },

    render(layer) {

        this.sprite.render(layer, this.x, this.y - this.z);

    }

};

/* file: script/entities/Door.js */

CLIENT.Door = function(args) {

    Object.assign(this, {

        x: 0,
        y: 0,
        z: 0,
        lifetime: 0,
        random: Math.random()

    }, args);

    this.width = 64;
    this.height = 44;
    this.alignY = 1.0;

    this.state = "closed";

    this.update(this.shared);

}
;

CLIENT.Door.prototype = {

    constructor: CLIENT.Door,

    zIndex: 2,

    shape: CLIENT.RECT,

    radius: 6,

    update: function(data) {

        if (data.x !== undefined || data.y !== undefined) {

            this.x = this.shared.x;
            this.y = this.shared.y;

            this.sortY = this.y + 16;
        }

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

        if (this.shared.locked !== undefined && data.locked !== undefined) {

            this.game.fx("unlock", {
                x: this.x,
                y: this.y
            });

        }

        Object.assign(this.shared, data);
    },

    step: function(dt) {

        this.lifetime += dt;

    },

    prerender: function() {
    },

    updateState() {

        let state;

        if (this.shared.locked) {

            state = "locked";

        } else
            state = Utils.quickDistance(this.x + this.width / 2, this.y + 16, app.game.player.x, app.game.player.y) < 24 ? "opened" : "closed";

        if (this.state !== state) {

            if (state === "opened")
                app.sound.play("objects/door_open").gpan(this);
            if (state === "closed")
                app.sound.play("objects/door_close").gpan(this);

            this.state = state;

        }

    },

    render: function(layer) {

        app.painter.reset();
        app.painter.drawAtlas("objects/door_" + this.state, this.x + 32, this.y - 6);

        if (this.game.interactor === this && this.shared.locked) {

            this.game.setTooltip("Press SPACE to unlock using key");

            app.painter.reset();
            app.painter.drawAtlas("ui/action_circle_neutral", this.center.x, this.center.y - 40);
            app.painter.drawSprite("pickups/key", this.center.x, this.center.y - 40, app.lifetime * 12, 0);
        }

        this.updateState();
        if (this.shared.team > -1) {

            app.painter.reset();
            app.painter.color(COMMON.TEAM_COLORS[this.shared.team].light);
            app.painter.alpha(0.5 + Math.sin(app.lifetime * 3) * 0.15);
            app.painter.drawAtlas("objects/door_closed", this.x + 32, this.y - 6);

        }

    }

};

/* file: script/entities/Stove.js */

CLIENT.Stove = function(args) {

    this.x = 0;
    this.y = 0;

    Object.assign(this, args);

    this.update(this.shared);

    this.maxHealth = 100;

    this.scale = 0;
    this.marker = "house";
}
;

CLIENT.Stove.prototype = {
    groups: ["radar"],
    zIndex: 2,

    shape: CLIENT.CIRCLE,

    radius: 8,

    enterview() {
    },

    leaveview() {

        if (this.sound) {

            this.sound.stop();
            this.sound = null;

        }

    },

    update: function(data) {

        if (data.x !== undefined)
            this.x = data.x;
        if (data.y !== undefined)
            this.y = data.y;

        if (data.health > this.shared.health) {

            this.fuelUp();

        }

        Object.assign(this.shared, data);

    },

    fuelUp() {

        if (!this.inView)
            return;

        app.sound.play("flame").fadeOut(1.0).rate(1.6).nrate(0.2).gpan(this);

    },

    step: function(dt) {

        if (this.inView) {

            if (this.sound) {

                if (this.shared.health <= 0) {

                    this.sound.stop();
                    this.sound = null;

                } else {

                    this.sound.gpan(this);
                    this.sound.rate(1.25 - (this.shared.health / this.maxHealth) * 0.4);
                    this.sound.volume((this.shared.health / this.maxHealth) * 0.25);

                }

            } else {

                if (this.shared.health > 0) {

                    this.sound = app.sound.play("flame").loop().rate(1.5);

                }

            }

        } else if (this.sound) {

            this.sound.stop();
            this.sound = null;

        }

    },

    render: function(layer) {

        let fire = (this.shared.health / this.maxHealth);

        app.painter.reset();

        app.painter.scale(1.0, 0.6);
        app.painter.color(0xffaa00);
        app.painter.alpha(0.2 + Math.sin(app.lifetime) * 0.05);
        app.painter.fillCircle(this.x, this.y, 32);
        app.painter.alpha(1.0);

        app.painter.color(0x111111);
        app.painter.fillRect(this.x, this.y - 12, 28, 16);

        if (fire > 0) {
            app.painter.reset();

            app.painter.scale(1.0 * fire, 0.5);
            app.painter.drawSprite("campfire", this.x, this.y - 20, app.lifetime * 12);

        }
        app.painter.reset();

        app.painter.align(0.5, 0.95);
        app.painter.drawAtlas(app.atlas.objects.stove, this.x, this.y);

        if (fire > 0) {

            app.painter.scale(0.5 + fire, 1.0 + fire * 0.25);
            app.painter.drawSprite("campfire_smoke", this.x, this.y - 54, app.lifetime * 12);

        }

        if (this.game.interactor === this) {

            app.painter.reset();
            app.painter.drawAtlas("ui/action_circle_neutral", this.x, this.y - 40);
            app.painter.drawSprite("pickups/wood", this.x, this.y - 40, 0, app.lifetime * 6);

            this.game.setTooltip("Press SPACE to fuel stove with wood.");

        }

    }

};

/* file: script/entities/Rope.js */

CLIENT.Rope = function(args) {

    Object.assign(this, {
        color: "#8d2727",
        length: 300,
        points: 10,
        periods: 10
    }, args);

    this.x = 0;
    this.y = 0;
    this.ex = 0;
    this.ey = 0;
    this.z = 16;

    this.angleStep = Math.PI * 2 / this.points;

    this.tween = new CLIENT.Tween(this);

    this.x = this.shared.x;
    this.y = this.shared.y;
    this.ex = this.shared.ex;
    this.ey = this.shared.ey;

    this.update(this.shared);

    this.step(0);

}
;

CLIENT.Rope.prototype = {

    constructor: CLIENT.Rope,

    zIndex: 3,

    radius: 1000,

    shape: CLIENT.CIRCLE,

    headSprite: [237, 7, 11, 10],

    update: function(data) {

        Object.assign(this.shared, data);

        if (data.x !== undefined)
            this.tween.to('x', data.x, COMMON.TWEEN_DURATION);
        if (data.y !== undefined)
            this.tween.to('y', data.y, COMMON.TWEEN_DURATION);
        if (data.ex !== undefined)
            this.tween.to('ex', data.ex, COMMON.TWEEN_DURATION);
        if (data.ey !== undefined)
            this.tween.to('ey', data.ey, COMMON.TWEEN_DURATION);

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

    },

    step: function(dt) {

        this.tween.step(dt);

        this.sortX = this.x;
        this.sortY = this.y;

    },

    render: function() {

        this.distance = Utils.distance(this.x, this.y, this.ex, this.ey);
        this.direction = Utils.lookAt(this.x, this.y, this.ex, this.ey);
        this.stress = Math.min(1, this.distance / this.length);

        app.painter.reset();
        app.painter.align(0.0, 0.5);
        app.painter.rotate(this.direction);
        app.painter.scale(1.0, 2.0 - this.stress * 1.5);
        app.painter.color(0x000000, 1.0);
        app.painter.alpha(0.4);
        app.painter.drawImageRegion(app.textures.randoms, 8, 458, 346, 11, this.x, this.y, 1 + this.distance, 11);
        app.painter.alpha(1.0);

        app.painter.color(0x99735e);
        app.painter.drawImageRegion(app.textures.randoms, 8, 458, 346, 11, this.x, this.y - this.z, 1 + this.distance, 11);

        app.painter.reset();
        app.painter.translate(this.ex, this.ey - this.z);
        app.painter.align(0.5, 0.5);
        app.painter.rotate(this.direction);
        app.painter.drawImageRegion(app.textures.randoms, ...this.headSprite, 0, 0);

        return;

        app.layer.beginPath().lineWidth(2).strokeStyle(this.color).moveTo(this.x, this.y - this.z)

        this.pointStep = this.distance / this.points / this.periods;

        var x = this.x;
        var y = this.y;
        var amplitude = (1 - this.stress) * 6;

        for (var i = 0; i < this.periods; i++) {
            for (var j = 0; j < this.points; j++) {

                var angle = this.angleStep * j;

                x += Math.cos(this.direction) * this.pointStep;
                y += Math.sin(this.direction) * this.pointStep;

                var a = Math.sin((j / this.points) * Math.PI * 2);

                var ox = Math.cos(this.direction - Math.PI / 2) * amplitude * a;
                var oy = Math.sin(this.direction - Math.PI / 2) * amplitude * a;

                app.layer.lineTo(x + ox, y + oy - this.z)

            }
        }

        app.layer.stroke();

        app.layer.beginPath();
        app.layer.lineWidth(1 + 5 * (1 - this.stress));
        app.layer.strokeStyle("rgba(0,0,0,0.25)");
        app.layer.strokeLine(this.x, this.y, this.ex, this.ey);

        app.layer.save();
        app.layer.translate(this.ex, this.ey - this.z);
        app.layer.align(0.5, 0.5);
        app.layer.rotate(this.direction);
        app.layer.drawRegion(app.images.randoms, this.headSprite, 0, 0)
        app.layer.restore();

    }

};

/* file: script/entities/Beam.js */

CLIENT.Beam = function(args) {

    Object.assign(this, args);

    this.tween = new CLIENT.Tween(this);

    this.x = this.shared.x;
    this.y = this.shared.y;
    this.z = 20;
    this.length = 2;
    this.direction = this.shared.direction;
    this.color = this.shared.team === app.game.player.team ? "#00c4b8" : "#b20";

    this.lifetime = 0;

    this.def = {};

    this.update(this.shared);

    var duration = [0.2, 0.4, 0.5];

    this.spriteShadow = new CLIENT.Sprite();
    this.spriteShadow.set("fx/beam1", true);
    this.spriteShadow.setDuration(duration)
    this.spriteShadow.color = "#000";
    this.spriteShadow.follow = this;
    this.spriteShadow.alpha = 0.1;
    this.spriteShadow.followOffsetZ = -this.z;

    this.sprite = new CLIENT.Sprite();
    this.sprite.set("fx/beam1", true);
    this.sprite.setDuration(duration)
    this.sprite.color = this.color;
    // this.sprite.colorMode = "color";
    // this.sprite.blendMode = "overlay";
    this.sprite.follow = this;
    this.sprite.blendMode = false;

    this.sprite2 = new CLIENT.Sprite();
    this.sprite2.set("fx/beam1", true);
    this.sprite2.setDuration(duration)
    this.sprite2.color = this.color;
    this.sprite2.colorMode = "color";
    this.sprite2.blendMode = "lighter";
    this.sprite2.scaleX = 1.25;
    this.sprite2.follow = this;
    this.sprite2.alpha = 0.25;

    this.lifespan = 0;

}
;

CLIENT.Beam.images = {};

CLIENT.Beam.prototype = {

    zIndex: 2,

    animationSpeed: 0.5,

    enterview: function() {

        app.sound.play("spells/beam").rrate(0.1).gpan(this);

        this.soundLoop = app.sound.play("spells/beam_loop").loop().rate(1.5).rrate(0.1).gpan(this);

        var sprite = this.collection.add("Sprite");

        sprite.zIndex = 2;
        sprite.color = this.color;
        sprite.colorMode = "color";
        sprite.x = this.x;
        sprite.y = this.y;
        sprite.z = this.z;
        sprite.scale = 0.5;
        sprite.set("fx/lighting", false);
        sprite.setDuration(0.5);
        sprite.rotation = this.shared.direction + Math.HPI;

    },

    leaveview: function() {

        if (this.soundLoop) {

            this.soundLoop.stop();

        }

    },

    _destruct: function() {
    },

    step: function(dt) {

        this.lifetime += dt;

        this.radius = this.length - 2;

        this.ex = this.x + Math.cos(this.direction) * this.radius;
        this.ey = this.y + Math.sin(this.direction) * this.radius;

        this.direction = Utils.circWrapTo(this.direction, this.shared.direction, Math.TAU * 2 * dt);

        this.tween.step(dt);

        if (this.target && this.target.onhit && Utils.interval(this, "hit", 0.1)) {/*
            if (this.target) this.target.onhit({
              x: this.ex + Utils.random(-5, 5),
              y: this.ey + Utils.random(-5, 5),
              z: this.z
            });

            var sprite = this.collection.add("Sprite");

            sprite.z = this.z;
            sprite.x = this.ex;
            sprite.y = this.ey;
            sprite.rotation = Math.random() * 6;
            sprite.color = Utils.random(["#8af", "#fff"]);
            sprite.setDuration(Utils.randomf(0.2, 0.5));
            sprite.set("spark");
      */
        }

        if (this.soundLoop)
            this.soundLoop.gpan(this);

        this.sprite.step(dt);
        this.sprite2.step(dt);
        this.spriteShadow.step(dt);

        if (this.lifespan > 0) {

            this.lifespan -= dt;

            if (this.lifespan <= 0) {

                this.collection.remove(this);

            }

        }

    },

    render: function(layer) {

        let rotation = this.direction - Math.HPI;

        this.sprite.rotation = rotation;
        this.sprite2.rotation = rotation;
        this.spriteShadow.rotation = rotation;

        this.sprite.limitHeight = this.length;
        this.sprite2.limitHeight = this.length;
        this.spriteShadow.limitHeight = this.length;

        this.spriteShadow.render(layer);
        this.sprite.render(layer);
        // this.sprite2.render(layer);

    },

    end: function() {

        this.lifespan = 1.0;

        this.sprite.loop = false;
        this.sprite2.loop = false;
        this.spriteShadow.loop = false;

        this.soundLoop.fadeOut(0.5);

    },

    update: function(data) {

        if (data.x !== undefined)
            this.tween.to('x', data.x, COMMON.TWEEN_DURATION * 2);
        if (data.y !== undefined)
            this.tween.to('y', data.y, COMMON.TWEEN_DURATION * 2);
        // if (data.length !== undefined) this.tween.to('length', data.length, COMMON.TWEEN_DURATION * 2);
        if (data.length !== undefined)
            this.length = data.length;

        if (this.inView && data.direction !== undefined) {

            if (Utils.circDistanceAbs(data.direction, this.shared.direction) > 1) {

                if (this.def.sound)
                    app.sound.play(this.def.sound).rate(0.3).rrate(0.1)

            }

        }

        Object.assign(this.shared, data);

        if (data.remove)
            this.end();

        if (data.target_sid !== undefined) {

            this.target = data.target_sid ? this.collection.sid(data.target_sid) : false;

            if (this.target && this.inView && this.def.sound)
                app.sound.play(this.def.sound).rate(0.5).rrate(0.1)

        }

    }

};

/* file: script/entities/Obstacle.js */

CLIENT.Obstacle = function(args) {

    Object.assign(this, {

        x: 0,
        y: 0,
        z: 0,
        lifetime: 0,
        random: Math.random()

    }, args);

    this.data = app.data[this.shared.type][this.shared.key];
    this.radius = Math.min(this.data.sprite[2], this.data.sprite[3]) / 2;

    this.update(this.shared);

    if (this.data.components) {

        this.components = new CLIENT.Components(this);
        this.components.fromArray(this.data.components);

    }

    this.image = app.textures[this.shared.type];

}
;

CLIENT.Obstacle.prototype = {

    constructor: CLIENT.Obstacle,

    zIndex: 2,

    shape: CLIENT.CIRCLE,

    radius: 6,

    onevent: function(event, data) {

        if (this.components)
            this.components.call("onevent", event, data);

    },

    onhit: function(data) {

        if (this.inView)
            app.sound.play("rock_hit").rrate(0.1);

        var sprite = this.collection.add("Sprite");

        sprite.setDuration(Utils.randomf(0.3, 1.0));
        sprite.scale = Utils.randomf(0.1, 0.4);
        sprite.x = data.x;
        sprite.y = data.y;
        sprite.z = data.z;
        sprite.color = Utils.random(CLIENT.DUST_COLORS);
        sprite.set("debris", false);

    },

    update: function(data) {

        Object.assign(this.shared, data);

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

        this.x = this.shared.x;
        this.y = this.shared.y;

    },

    step: function(dt) {

        this.lifetime += dt;

        if (this.components)
            this.components.call("step", dt);

    },

    prerender: function() {
    },

    render: function(layer) {

        app.painter.reset();
        app.painter.align(0, 0);
        app.painter.drawImageRegion(this.image, ...this.data.sprite, this.x - this.data.sprite[2] / 2, this.y - this.data.sprite[3] / 2);

        if (this.components)
            this.components.call("render", layer);

        // layer.strokeStyle("#fff").lineWidth(2).strokeRect(...this.box);

    }

};

/* file: script/entities/Gate.js */

CLIENT.Gate = function(args) {

    this.x = 0;
    this.y = 0;
    this.a = 0;
    this.b = 0;

    this.lifetime = 0;

    Object.assign(this, args);

    this.width = 192;
    this.height = 64;
    this.alignX = 0.0;
    this.alignY = 1.0;

    this.hitLifespan = 0;

    this.update(this.shared);

    this.maxHealth = 40;

    this.progressSprite = new CLIENT.Sprite;
    this.progressSprite.set("pickups/wood");
    this.progressSprite.spin = 1.0;

}
;

CLIENT.Gate.prototype = {

    constructor: CLIENT.Gate,

    zIndex: 2,

    shape: CLIENT.RECT,

    sprites: {
        "good": [5, 347, 64, 64],
        "a": [74, 281, 64, 64],
        "b": [141, 281, 64, 64],
        "destroyed": [6, 281, 64, 64],
        "damage": [7, 414, 58, 40]
    },

    onhit() {

        this.hitLifespan = 0.15;

        if (this.inView) {

            this.spawnPlank();

            app.sound.play("impact/structure").nrate(0.2).gpan(this);

        }

    },

    update: function(data) {

        if (data.x !== undefined)
            this.x = data.x;
        if (data.y !== undefined)
            this.y = data.y;

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }
        if (data.health !== undefined) {

            if (this.shared.health < data.health)
                this.repair();

        }

        if (data.state !== undefined) {

            if (!this.shared.state && data.state)
                this.demolish();
            if (this.shared.state && !data.state)
                this.constructionComplete();

        }

        Object.assign(this.shared, data);

    },

    spawnPlank: function() {

        var sprite = this.collection.add("Sprite");

        sprite.set("plank_spin", true);
        sprite.zIndex = 2;
        sprite.loopDuration = 0.2 + Math.random() * 0.3;
        sprite.x = this.x + Utils.random(0, this.width);
        sprite.y = this.y - Utils.random(0, 64);
        sprite.scaleY = 2.0;
        sprite.color = "#706654";
        sprite.row = Utils.random(0, 15);
        // sprite.delay = Math.random() * 0.3;

        app.tween(sprite).delay(sprite.delay).to({
            z: Utils.random(10, 50),
            scale: 1.5
        }, 0.5).to({
            z: 0,
            scale: 1.0,
            tc: 0.0
        }, 0.5, "outBounce").delay(1.0).to({
            scaleY: 0,
            scaleX: 0
        }, 1.0);

        app.tween(sprite).delay(sprite.delay).to({
            x: this.x + Utils.random(-100, 100),
            y: this.y + Utils.random(-100, 100),
        }, 1.0)

        sprite.lifespan = 6;

    },

    demolish() {

        if (!this.inView)
            return;

        app.sound.play("explosions/structure").nrate(0.2).gpan(this);

        for (var i = 0; i < 16; i++) {

            this.spawnPlank();

        }

    },

    repair() {

        if (!this.inView)
            return;

        app.sound.play("gameplay/build").rate(0.7).nrate(0.2).gpan(this);

    },

    constructionComplete() {

        if (!this.inView)
            return;

        app.sound.play("gameplay/structure_ready").rrate(0.1).gpan(this);

        var sprite = this.collection.add("Sprite");

        sprite.set("puff_ring");
        sprite.zIndex = 2;
        sprite.x = this.x;
        sprite.y = this.y - 32;
        sprite.setDuration(1.0);

    },

    step: function(dt) {

        this.lifetime += dt;

        this.hitLifespan -= dt;

    },

    render: function(layer, dt) {

        let progress = this.shared.health / this.maxHealth;

        let image = app.textures.randoms;
        let sprite;

        var o = this.hitLifespan > 0 ? Utils.random(-2, 2) : 0;
        if (this.shared.state === 1)
            sprite = this.sprites.destroyed;
        else if (this.shared.team === 0)
            sprite = this.sprites.a;
        else if (this.shared.team === 1)
            sprite = this.sprites.b;
        else
            sprite = this.sprites.good;

        app.painter.reset();
        app.painter.align(0, 1.0);
        app.painter.drawAtlas("objects/" + (this.shared.state === 0 ? "gate_closed" : "gate_destroyed"), this.x, this.y);

        if (this.shared.state === 0) {

            app.painter.alpha(1.0 - this.shared.health / this.maxHealth);
            app.painter.drawAtlas("objects/gate_damaged", this.x, this.y);

        }

        if (this.game.playerInRange(this)) {

            app.painter.reset();

            if (this.shared.team !== this.game.player.team) {

                this.game.renderBar("ui/health_bar_enemy", "ui/health_bar_off_enemy", this.center.x, this.y + 8, this.shared.health / this.maxHealth);

                if (this.shared.health > 0) {
                    app.painter.drawAtlas("ui/action_circle_negative", this.center.x, this.y - 60);
                    app.painter.drawSprite("pickups/mine", this.center.x, this.y - 60, app.lifetime * 6, 0);
                }

            } else {

                this.game.renderBar("ui/health_bar_friendly", "ui/health_bar_off_friendly", this.center.x, this.y + 8, this.shared.health / this.maxHealth);
                if (this.shared.health < this.maxHealth) {
                    app.painter.drawAtlas("ui/action_circle_positive", this.center.x, this.y - 60);
                    app.painter.drawSprite("pickups/wood", this.center.x, this.y - 60, 0, app.lifetime * 6);

                }

            }

        }

    }

};

/* file: script/entities/GroundExplosion.js */

CLIENT.GroundExplosion = function(args) {

    this.duration = 0;
    this.z = 20;

    Object.assign(this, args);
    this.lifespan = this.duration;
    this.lifetime = 0;
}
;

CLIENT.GroundExplosion.prototype = {

    shape: CLIENT.CIRCLE,

    radius: 2,

    zIndex: 0,

    renderStains() {

        let repeat = 1 + 100 / 20 | 0;

        for (var i = 0; i < repeat; i++) {

            let aspectX = this.game.stainsBuffer.width / (this.game.innerWidth * 2);
            let aspectY = this.game.stainsBuffer.height / (this.game.innerHeight * 2);

            let gl = app.gl;

            let angle = Utils.random() * 6.28;
            let progress = this.lifetime / this.duration;

            let radius = this.radius * progress;
            let x = (this.game.width + this.x + Utils.random(-4, 4) + Math.cos(angle) * radius) * aspectX;
            let y = (this.game.height + this.y + Utils.random(-4, 4) + Math.sin(angle) * radius) * aspectY;
            let stain = app.atlas["splats/mud" + Utils.random(1, 3)];
            let scale = 0.3 * Utils.randomf(0.8, 1.4);

            app.painter.reset();

            // app.painter.rotate(this.direction + Utils.randomf(-0.5, 0.5))

            app.painter.blend(gl.FUNC_ADD, gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE)
            app.painter.rotate(Math.random() * 6)
            app.painter.alpha(0.4);
            app.painter.scale(aspectX * scale, aspectY * scale);
            app.painter.drawImageRegion(stain.texture, ...stain.region, x, y);

        }

    },

    step(dt) {

        this.lifetime += dt;

    }
};

/* file: script/entities/ClaimableFlag.js */

CLIENT.ClaimableFlag = function(args) {

    this.x = 0;
    this.y = 0;
    this.a = 0;
    this.b = 0;

    this.lifetime = 0;

    Object.assign(this, args);

    this.width = 37;
    this.height = 115;
    this.alignX = 0.5;
    this.alignY = 0.9;

    this.update(this.shared);

}
;

CLIENT.ClaimableFlag.prototype = {

    constructor: CLIENT.ClaimableFlag,

    zIndex: 2,

    shape: CLIENT.RECT,

    sprites: {
        "base": [10, 142, 37, 115],
        "a": [3, 258, 26, 21],
        "b": [30, 258, 26, 21],
        "emblemA": [50, 145, 35, 47],
        "emblemB": [58, 198, 25, 45]
    },

    update: function(data) {

        if (this.inView && data.team !== undefined && data.team !== this.shared.team) {

            app.sound.play("gameplay/capture_fort");

        }

        Object.assign(this.shared, data);

        if (data.x !== undefined)
            this.x = data.x;
        if (data.y !== undefined)
            this.y = data.y;

        if (data.a !== undefined)
            app.tween(this).to({
                a: data.a
            }, 0.25, "linear");

        if (data.b !== undefined)
            app.tween(this).to({
                b: data.b
            }, 0.25, "linear");

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

    },

    step: function(dt) {

        this.lifetime += dt;
    },

    render: function(layer) {

        app.painter.reset();
        app.painter.align(0, 0);

        app.painter.drawImageRegion(app.textures.randoms, ...this.sprites.base, this.x - this.alignX * this.width, this.y - this.alignY * this.height);

        let a = 80 * this.a;
        let b = 80 * this.b;

        app.painter.drawImageRegion(app.textures.randoms, ...this.sprites.a, this.x - 25, this.y - a - 8);
        app.painter.drawImageRegion(app.textures.randoms, ...this.sprites.b, this.x + 3, this.y - b - 8);

        if (this.a >= 1.0) {

            app.painter.drawImageRegion(app.textures.randoms, ...this.sprites.emblemA, this.x - 35, this.y - a - 32 + Math.cos(app.lifetime * 2) * 3);

        }

        if (this.b >= 1.0) {

            app.painter.drawImageRegion(app.textures.randoms, ...this.sprites.emblemB, this.x + 3, this.y - b - 29 + Math.cos(app.lifetime * 2) * 3);

        }

    }

};

/* file: script/entities/Flag.js */

CLIENT.Flag = function(args) {

    this.x = 0;
    this.y = 0;
    this.z = 0;

    this.lifetime = 0;

    Object.assign(this, args);

    this.sprite = new CLIENT.Sprite();

    this.sprite.set("equipment/flag_turntable", true);

    this.tween = new CLIENT.Tween(this);

    this.x = this.shared.x;
    this.y = this.shared.y;

    this.update(this.shared);

    this.marker = "flag" + this.shared.team;

    this.game.navmarks.push({
        entity: this,
        sprite: this.shared.team ? [23, 29, 21, 14] : [0, 29, 21, 14]
    });

}
;

CLIENT.Flag.prototype = {

    constructor: CLIENT.Flag,

    zIndex: 2,

    shape: CLIENT.CIRCLE,

    groups: ["radar"],

    radius: 6,

    update: function(data) {

        Object.assign(this.shared, data);

        if (data.x !== undefined)
            this.tween.to('x', data.x, COMMON.TWEEN_DURATION * 2);
        if (data.y !== undefined)
            this.tween.to('y', data.y, COMMON.TWEEN_DURATION * 2);

        if (data.team !== undefined) {

            this.sprite.setPalette(data.team ? app.flag_red : false);

        }

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

        if (data.parent_sid !== undefined) {

            if (this.parent && this.parent.detachFlag)
                this.parent.detachFlag();

            this.changeParent(this.parent, this.collection.sid(data.parent_sid));

        }

    },

    changeParent: function(prev, next) {

        this.game.ping(this)

        if (!prev && !next)
            return;

        if (!next) {

            this.show();

            if (this.shared.team === app.game.player.team) {

                app.sound.play("ctf/update");

                app.console.say("Our flag is on the ground");

            } else {

                app.sound.play("ctf/update");

                app.console.say("Enemy flag is on the ground");

            }

        }

        if (next instanceof CLIENT.Citizen) {

            if (next.shared.team === app.game.player.team) {

                if (!prev) {

                    app.console.say("We have enemy flag again");

                    app.sound.play("ctf/update");

                } else {

                    app.console.say("We have stolen enemy flag");

                    app.sound.play("ctf/team_has_flag");

                }

            } else {

                if (!prev) {

                    app.console.say("Enemy has picked up our flag");

                    app.sound.play("ctf/update");

                } else {

                    app.console.say("Enemy has stolen our flag");

                    app.sound.play("ctf/enemy_has_flag");

                }

            }

            next.attachFlag();
            this.hide();

        }

        if (next instanceof CLIENT.FlagBase) {

            this.show();

            if (prev && this.shared.status === "scored") {

                if (next.shared.team === app.game.player.team) {

                    app.console.say("Enemy have scored");

                    app.sound.play("ctf/enemy_score");

                } else {

                    app.console.say("We have scored");

                    app.sound.play("ctf/team_score");

                }

            } else {

                if (next.shared.team === app.game.player.team) {

                    app.console.say("Our flag has returned");

                    app.sound.play("ctf/team_returned_flag");

                } else {

                    app.console.say("Enemy flag has returned");

                    app.sound.play("ctf/enemy_returned_flag");

                }

            }

        }

        this.parent = next;

    },

    step: function(dt) {

        this.tween.step(dt);

        this.lifetime += dt;

        this.sprite.step(dt);

        if (Utils.interval(this, "ping", 1.0)) {

            this.game.ping(this);

        }

    },

    prerender: function() {
    },

    hide: function() {

        this.sprite.hide();

    },

    show: function() {

        this.sprite.show();

    },

    render: function(layer) {

        if (!this.shared.hidden) {

            this.sprite.x = this.x;
            this.sprite.y = this.y - 24;

            this.sprite.render(layer);

        }

    }

};

/* file: script/entities/FlagBase.js */

CLIENT.FlagBase = function(args) {

    console.log("NEW FLAG BASE");

    this.x = 0;
    this.y = 0;
    this.z = 0;

    Object.assign(this, args);

    this.update(this.shared);

}
;

CLIENT.FlagBase.prototype = {

    constructor: CLIENT.FlagBase,

    zIndex: 1,

    shape: CLIENT.CIRCLE,

    radius: 6,

    sprite: [0, 0, 37, 30],

    update: function(data) {

        Object.assign(this.shared, data);

        this.x = this.shared.x;
        this.y = this.shared.y;

        if (data.team !== undefined) {
        }

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

    },

    step: function(dt) {

        this.lifetime += dt;

    },

    render: function(layer) {

        app.painter.reset();
        app.painter.drawImageRegion(app.textures.flag_base, ...this.sprite, this.y | 0, this.y | 0);

    }

};

/* file: script/entities/Sprite.js */

{

    /* TODO 

      If there is no enter defined just skip to the loop part

      Coupling should really just copy durations - not Progress

    */

    var uniqidc = 0;

    let Sprite = NAMESPACE.Sprite = function(args) {

        this.reset(args);

    }
    ;

    Sprite.STATE_NONE = 0;
    Sprite.STATE_ENTER = 1;
    Sprite.STATE_LOOP = 2;
    Sprite.STATE_LEAVE = 3;

    Sprite.prototype = {

        zIndex: 2,

        temp: cq(1, 1),

        shape: CLIENT.CIRCLE,

        radius: 1,

        constructor: NAMESPACE.Sprite,

        remove: function() {

            this.collection.remove(this);

        },

        _destruct: function() {

            if (this._fromPool)
                app.pool(this);

        },

        reset: function(args) {

            app.tween(this).discard();

            if (typeof args === "string")
                args = {
                    key: args
                };

            this.data = {
                rows: 16
            };

            Object.assign(this, this.defaults, args);

            this.region = [0, 0, 0, 0];
            this.trim = [0, 0];

            this.loopDuration = 1.0;
            this.leaveDuration = 0;
            this.enterDuration = 0;
            this.duration = 1.0;

            if (this.key)
                this.set(this.key);

        },

        defaults: {
            zIndex: 2,
            imagekey: "",
            layers: false,
            auto: true,
            blendMode: false,
            alpha: 1.0,
            color: false,
            colorMode: "source-in",
            delay: 0,
            x: 0,
            y: 0,
            z: 0,
            tc: 1.0,
            lifetime: 0,
            frameskip: 1,
            manual: false,
            row: 0,
            state: Sprite.STATE_NONE,
            queue: [],
            loop: true,
            alignX: "0.5",
            alignY: "0.5",
            scaleX: 1.0,
            scaleY: 1.0,
            coupled: false,
            stateCounter: 0,
            coupledStateCounter: -1,
            easing: "linear",
            hidden: false,
            palette: -1,
            offsetX: 0,
            offsetY: 0,
            rotation: 0,
            tempColor: false,
            tempColorMode: "source-in",
            tempColorAlpha: 1.0,
            followOffsetX: 0,
            followOffsetY: 0,
            followOffsetZ: 0,
            follow: null,
            srcX: 0,
            srcY: 0,
            force: 0,
            direction: undefined,
            forceDirection: Math.random() * 6,
            forceDamping: 100,
            ready: false,
            prefix: "",
            outline: 0,
            limitHeight: -1,
            spin: 0,
            doodle: false,
            shadow: false
        },

        couple: function(sprite) {

            this.coupled = sprite;
            this.coupledStateCounter = -1;

        },

        decouple: function() {

            this.coupled = false;

        },

        enqueue: function(key, loop) {

            this.queue.push(key, loop);

        },

        swap: function(key, options) {

            this.manual = false;

            this.ready = false;
            this.key = key;
            this.fullKey = this.prefix + this.key;
            this.options = options;

            if (!app.sprites[this.fullKey]) {

                app.loadSprite(this.fullKey);

                return;
            }

            this.frame = -1;

            if (options === true)
                options = this.OPTIONS_LOOP;
            if (options === false)
                options = this.OPTIONS_NOLOOP;

            if (!options)
                options = this.OPTIONS_NONE;

            this.loop = options.loop;
            this.key = key;

            this.data = app.sprites[this.fullKey];

            this.ready = true;

            /* Ensure markers */

            if (!this.data.markers)
                this.data.markers = {};

            if (this.data.markers.enter === undefined)
                this.data.markers.enter = 0;
            if (this.data.markers.loop === undefined)
                this.data.markers.loop = this.data.markers.enter;
            if (this.data.markers.leave === undefined)
                this.data.markers.leave = this.data.frames - 1;
            if (this.data.markers.end === undefined)
                this.data.markers.end = this.data.frames - 1;

            this.data.srcX = this.data.srcX || 0;
            this.data.srcY = this.data.srcY || 0;

            this.texture = app.sprites[this.fullKey].texture;

            this.lifetime = 0;
            this.progress = 0;

            if (this.data.markers.enter === this.data.markers.loop)
                this.state = Sprite.STATE_ENTER;
            else
                this.state = Sprite.STATE_NONE;

            /* Align */

            if (this.data.alignX !== undefined)
                this.alignX = this.data.alignX;
            if (this.data.alignY !== undefined)
                this.alignY = this.data.alignY;
            // else this.alignX = 0.5;
            // else this.alignY = 0.5;

            if (!this.data.regions) {

                this.cols = this.texture.originalWidth / this.data.width | 0;

            }

            if (!this.manual)
                this.setFrame(0);
            else {

                this.setFrame(this.frame);
                // this.setFrame(0);

            }

            if (!this.manual)
                this.nextState();

            if (options.duration) {

                if (typeof options.duration === "number") {

                    this.setDuration(0, options.duration, 0);

                } else {

                    this.setDuration(options.duration[0], options.duration[1], options.duration[2]);

                }

            }

        },

        updateColor: function(color) {

            this.color = color;

        },

        setPalette: function(palette) {

            this.palette = palette;

        },

        SYMBOL_ID: Symbol("id"),

        uniqid: function(o) {

            if (!o[this.SYMBOL_ID]) {

                o[this.SYMBOL_ID] = ++uniqidc;

            }

            return o[this.SYMBOL_ID];

        },

        OPTIONS_NONE: {
        },

        OPTIONS_LOOP: {
            loop: true
        },

        OPTIONS_NOLOOP: {
            loop: false
        },

        set: function(key, options) {

            this.queue = [];

            this.swap(key, options);

        },

        setFullDuration: function(duration) {

            this.enterDuration = duration * ((this.data.markers.loop - this.data.markers.enter) / this.data.frames);
            this.loopDuration = duration * ((this.data.markers.leave - this.data.markers.loop) / this.data.frames);
            this.leaveDuration = duration * ((this.data.markers.end - this.data.markers.leave) / this.data.frames);

        },

        setDuration: function(enter, loop, leave) {

            if (arguments.length === 1) {

                if (typeof enter === "object") {

                    this.enterDuration = enter[0];
                    this.loopDuration = enter[1];
                    this.leaveDuration = enter[2];

                } else if (!this.loop && this.ready && this.data.markers.loop) {

                    this.setFullDuration(enter);

                } else {

                    this.enterDuration = 0;
                    this.leaveDuration = 0;
                    this.loopDuration = enter;

                }

            } else {

                this.enterDuration = enter;
                this.loopDuration = loop;
                this.leaveDuration = leave;

            }

            this.updateDuration();

        },

        set scale(scale) {

            this.scaleX = this.scaleY = scale;

        },

        get scale() {

            return Math.max(this.scaleX, this.scaleY);

        },

        set alignX(value) {

            this._alignX = value;

            if (typeof value === "string")
                this.alignOffsetX = value | 0;
            else
                this.alignOffsetX = this.data.width * value | 0;

        },

        get alignX() {

            return this._alignX;

        },

        set alignY(value) {

            this._alignY = value;

            if (typeof value === "string")
                this.alignOffsetY = value | 0;
            else
                this.alignOffsetY = this.data.height * value | 0;

        },

        get alignY() {

            return this._alignY;

        },

        pause: function() {

            this.paused = true;

        },

        unpause: function() {

            this.paused = false;

        },

        play: function(start, end, manual=true) {

            this.manual = manual;

            this.lifetime = 0;
            this.progress = 0;

            this.startFrame = start;
            this.endFrame = end;
            this.frames = (end - start) + 1;

        },

        set loopDuration(duration) {

            this._loopDuration = duration;

            this.updateDuration();

        },

        get loopDuration() {

            return this._loopDuration;

        },

        updateDuration: function() {

            switch (this.state) {

            case Sprite.STATE_NONE:

                this.duration = this.enterDuration;

                break;

            case Sprite.STATE_ENTER:

                this.duration = this.enterDuration;

                break;

            case Sprite.STATE_LOOP:

                this.duration = this.loopDuration;

                break;

            case Sprite.STATE_LEAVE:

                this.duration = this.leaveDuration;

                break;

            }

        },

        nextState: function() {

            /* IF no enter defined, just skip */
            /* Or if loop marker is 0 - think about it */

            this.stateCounter++;

            switch (this.state) {

            case Sprite.STATE_NONE:

                this.play(this.data.markers.enter, this.data.markers.loop || this.data.markers.end, false);

                this.state = Sprite.STATE_ENTER;

                break;

            case Sprite.STATE_ENTER:

                this.play(this.data.markers.loop, this.data.markers.leave, false);

                this.state = Sprite.STATE_LOOP;

                break;

            case Sprite.STATE_LOOP:

                if (this.queue.length || !this.loop) {

                    if (this.data.markers.leave !== this.data.markers.end)
                        this.play(this.data.markers.leave, this.data.markers.end, false);

                    this.state = Sprite.STATE_LEAVE;

                } else {

                    this.play(this.data.markers.loop, this.data.markers.leave, false);

                }

                break;

            case Sprite.STATE_LEAVE:

                if (this.queue.length) {

                    this.set(this.queue.shift(), this.queue.shift());

                } else {

                    if (this.auto && this.collection)
                        this.collection.remove(this);

                }

                break;

            }

            this.updateDuration();

        },

        cease: function() {

            this.loop = false;

        },

        skip: function() {

            this.lifetime = this.duration;

        },

        cancel: function() {

            this.lifetime = this.duration;
            this.state = Sprite.STATE_LOOP;

            this.loop = false;

        },

        hide: function() {

            this.hidden = true;

        },

        show: function() {

            this.hidden = false;

        },

        step: function(dt) {

            if (!this.ready) {

                if (app.sprites[this.fullKey]) {

                    var lifetime = this.lifetime;

                    this.swap(this.key, this.options);

                    this.lifetime = lifetime;

                } else
                    return;

            }

            if (this.delay > 0) {

                this.delay -= dt;

                if (this.delay > 0)
                    return;

            }

            if (!this.paused) {

                this.lifetime += dt * this.tc;

            }

            dt *= this.tc;

            if (this.follow) {

                this.x = this.follow.x + this.followOffsetX;
                this.y = this.follow.y + this.followOffsetY;
                this.z = this.follow.z + this.followOffsetZ;

            } else if (this.force) {

                this.force = Math.max(0, this.force - this.forceDamping * dt);

                this.x += Math.cos(this.forceDirection) * this.force * dt;
                this.y += Math.sin(this.forceDirection) * this.force * dt;

            }

            if (this.direction !== undefined) {

                if (this.data.rows > 1) {

                    this.row = Utils.dirrow(this.direction, this.data.rows);

                } else {

                    this.rotation = this.direction;

                }

            }
            if (this.spin)
                this.row = this.data.rows * (this.lifetime % this.spin) / this.spin | 0;

            this.progress = Math.min(1.0, this.lifetime / this.duration);

            /* Progress frame */

            // var progress = (this.lifetime % this.duration) / this.duration;

            // this.progress = Utils.ground(this.progress, 0.1)

            if (this.progress >= 1.0) {

                if (!this.manual)
                    this.nextState();

            }

            var ease = app.ease(this.progress, this.easing);

            if (this.reverse) {

                this.setFrame(Math.min(this.endFrame, this.startFrame + this.frames * (1 - ease) | 0));

            } else {

                this.setFrame(Math.min(this.endFrame, this.startFrame + this.frames * ease | 0));

            }

        },

        setFrame: function(frame) {

            this.frame = frame;
            this.absFrame = this.row * this.data.frames + this.frame;

            if (this.data.regions) {

                /* Update copy area */

                var regionIndex = this.absFrame * 4;

                this.region[0] = this.data.regions[regionIndex + 0];
                this.region[1] = this.data.regions[regionIndex + 1];
                this.region[2] = this.data.regions[regionIndex + 2];
                this.region[3] = this.data.regions[regionIndex + 3];

                var trimIndex = this.absFrame * 2;

                this.trim[0] = this.data.trim[trimIndex + 0];
                this.trim[1] = this.data.trim[trimIndex + 1];

            } else {

                if (this.data.rows) {
                    var x = this.frame % this.frames;
                    var y = this.row + this.frame / this.frames | 0;
                } else {
                    var x = this.frame % this.cols;
                    var y = this.frame / this.cols | 0;
                }

                this.region[0] = x * this.data.width + this.data.srcX;
                this.region[1] = y * this.data.height + this.data.srcY;
                this.region[2] = this.data.width;
                this.region[3] = this.data.height;

                this.trim[0] = 0;
                this.trim[1] = 0;

            }

            if (this.limitHeight >= 0) {

                this.region[3] = Math.min(this.region[3], this.limitHeight);

            }

            // this.radius = Math.max(this.region[2] * this.scaleX, this.region[3] * this.scaleY);

        },

        end: function() {

            this.lifetime = this.duration * 0.99;
            this.step(0);

        },

        render: function(layer, x=0, y=0) {

            if (!this.ready)
                return;

            if (this.delay > 0)
                return;

            if (this.hidden)
                return;

            if (!this.region[2] || !this.region[3])
                return;

            // app.painter.drawSprite(this.texture || this.fullKey, x + this.x, y + this.y, 0, 0);
            app.painter.reset();
            let color = app.intColor(this.color || this.tempColor);

            app.painter.values.width = this.data.width;
            app.painter.values.height = this.data.height;

            app.painter.values.width = this.data.width;
            app.painter.values.height = this.data.height;

            app.painter.values.offset.x = this.trim[0];
            app.painter.values.offset.y = this.trim[1];

            app.painter.align(this.alignX, this.alignY);
            app.painter.rotate(this.rotation);
            app.painter.scale(this.scaleX, this.scaleY);

            if (this.shadow) {
                app.painter.alpha(0.25);
                app.painter.color(0x000000);
                app.painter.drawImageRegion(this.texture, this.region[0], this.region[1], this.region[2], this.region[3], Math.floor(x + this.x), Math.floor(y + this.y));
                app.painter.color(-1);
            }

            if (color > -1)
                app.painter.color(color, 1.0);
            else
                app.painter.color(0, 0.0);
            if (this.blendMode)
                app.painter.blend(app.gl.FUNC_ADD, app.gl.SRC_ALPHA, app.gl.ONE_MINUS_SRC_ALPHA, app.gl.ONE, app.gl.ONE)

            app.painter.palette(this.palette);
            app.painter.alpha(this.alpha);

            app.painter.drawImageRegion(this.texture, this.region[0], this.region[1], this.region[2], this.region[3], Math.floor(x + this.x), Math.floor(y + this.y - this.z));
            // app.painter.drawSprite(this.fullKey, this.x, this.y, this.frame, this.row)
            // this.offsetX + x + this.x + this.trim[0] - this.alignOffsetX * this.scaleX, this.offsetY + y + this.y - this.z + this.trim[1] - this.alignOffsetY * this.scaleY);

        }

    };

    PLAYGROUND.Application.prototype.spritePromises = {};
    PLAYGROUND.Application.prototype.loadSprite = function(key) {

        var app = this;

        if (app.spritePromises[key])
            return app.spritePromises[key];

        if (!app.sprites)
            app.sprites = {};

        if (app.sprites[key])
            return;

        this.loader.add();

        var json_url = app.rewriteURL("sprites/" + key + ".json");

        var path = key.split("/");

        path.pop();
        path = path.join("/");

        var promise = new Promise(function(resolve, reject) {

            return app.request(json_url).then(function(request) {

                var raw = request.responseText;
                var json = JSON.parse(raw);

                // app.sprites[key] = json;

                var url = (json.src ? json.src : key) + ".png";

                let textureOptions = {};

                if (json.usePalette)
                    textureOptions.usePalette = true;

                var result = app.loadTexture("<sprites/" + url + "> sprites/" + key, textureOptions);

                result.then(function(texture) {

                    json.texture = texture;

                    app.insertAsset(json, app.sprites, key);

                    app.loader.success("sprite " + key);

                    resolve();

                });

                return result;

            });

        }
        );

        app.spritePromises[key] = promise;

        return promise;

    }
    ;

    NAMESPACE.Sprite.getRegion = function(sprite, frame, row) {

        let data = app.sprites[sprite];

        frame = frame % data.frames | 0;
        row = row % data.rows | 0;

        let absFrame = row * data.frames + frame;

        let result = [];

        var regionIndex = absFrame * 4;

        result[0] = data.regions[regionIndex + 0];
        result[1] = data.regions[regionIndex + 1];
        result[2] = data.regions[regionIndex + 2];
        result[3] = data.regions[regionIndex + 3];

        return result;

    }
    ;

    NAMESPACE.Sprite.getTrim = function(sprite, frame, row) {

        let data = app.sprites[sprite];

        frame = frame % data.frames | 0;
        row = row % data.rows | 0;

        let absFrame = row * data.frames + frame;

        let result = [];

        var regionIndex = absFrame * 2;

        result[0] = data.trim[regionIndex + 0];
        result[1] = data.trim[regionIndex + 1];

        return result;

    }
    ;

}

/* file: script/entities/Sprites.js */

CLIENT.Sprites = function() {

    this.sprites = [];

    for (var i = 0; i < arguments.length; i++)
        this.sprites.push(arguments[i]);

}
;

CLIENT.Sprites.prototype = {

    push: function(sprite) {

        return this.sprites.push(sprite);

    },

    pull: function(sprite) {

        return Utils.pull(this.sprites, sprite);

    },

    set: function(key, options) {

        for (var i = 0; i < this.sprites.length; i++) {

            this.sprites[i].set(key, options);

        }

    },

    setPalette: function(palette) {

        for (var i = 0; i < this.sprites.length; i++) {

            this.sprites[i].setPalette(palette);

        }

    },

    setNotHidden: function(key, options) {

        for (var i = 0; i < this.sprites.length; i++) {

            if (this.sprites[i].hidden)
                continue;

            this.sprites[i].set(key, options);

        }

    },

    enqueue: function(key, options) {

        for (var i = 0; i < this.sprites.length; i++)
            this.sprites[i].enqueue(key, options);

    },

    pause: function() {

        for (var i = 0; i < this.sprites.length; i++)
            this.sprites[i].pause();

    },

    unpause: function() {

        for (var i = 0; i < this.sprites.length; i++)
            this.sprites[i].unpause();

    },

    end: function() {

        for (var i = 0; i < this.sprites.length; i++)
            this.sprites[i].end();

    },

    setDuration: function(enter, loop, leave) {

        if (arguments.length === 1) {

            for (var i = 0; i < this.sprites.length; i++)
                this.sprites[i].setDuration(enter);

        } else {

            for (var i = 0; i < this.sprites.length; i++)
                this.sprites[i].setDuration(enter, loop, leave);

        }
    },

    assign: function(property, value) {

        for (var i = 0; i < this.sprites.length; i++)
            this.sprites[i][property] = value;

    },

    render: function(layer, x, y) {

        for (var i = 0; i < this.sprites.length; i++)
            this.sprites[i].render(layer, x, y);

    },

    step: function(dt) {

        for (var i = 0; i < this.sprites.length; i++)
            this.sprites[i].step(dt);

    },

    skip: function() {

        for (var i = 0; i < this.sprites.length; i++)
            this.sprites[i].skip();

    },

    cancel: function() {

        for (var i = 0; i < this.sprites.length; i++)
            this.sprites[i].cancel();

    }

};

/* file: script/entities/Quicksand.js */

CLIENT.Quicksand = function(args) {

    Object.assign(this, {

        x: 0,
        y: 0,
        z: 0,
        lifetime: 0,
        random: Math.random()

    }, args);

    this.update(this.shared);

}
;

CLIENT.Quicksand.prototype = {

    constructor: CLIENT.Quicksand,

    zIndex: 0,

    shape: CLIENT.CIRCLE,

    radius: 100,

    _destruct: function() {

        if (this.sound)
            this.sound.stop();

    },

    enterview: function() {

        if (this.sound)
            this.sound.stop();

        this.sound = app.sound.play("quicksand").loop().rrate(0.2);

    },

    leaveview: function() {

        if (this.sound) {

            this.sound.stop();
            this.sound = false;

        }

    },

    update: function(data) {

        Object.assign(this.shared, data);

        this.x = this.shared.x;
        this.y = this.shared.y;

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

    },

    step: function(dt) {

        this.lifetime += dt;

        if (this.sound)
            this.sound.gpan(this);

    },

    render: function(layer) {

        var s = this.shared.radius / 53;

        app.painter.reset();
        app.painter.scale(s, s);
        app.painter.rotate(-app.lifetime / 5);
        app.painter.drawImageRegion(app.textures.quicksand, 0, 0);

    }

};

/* file: script/entities/Ball.js */

CLIENT.Ball = function(args) {

    this.direction = 0;

    Object.assign(this, {

        x: 0,
        y: 0,
        z: 0,
        random: Math.random(),
        frame: 0,
        scaleX: 1.0,
        scaleY: 1.0,
        scale: 1.0

    }, args);

    this.temp = {};
    this.tween = new CLIENT.Tween(this);

    this.update(this.shared);

    this.trail = new CLIENT.MotionTrail(this,{
        alpha: 0.6,
        color: "#cbdbfc",
        maxPoints: 6,
        interval: 0.1,
        width: 8
    });

    this.removeTimeout = 0;

    this.game.ball = this;

}
;

CLIENT.Ball.prototype = {

    zIndex: 2,

    shape: CLIENT.CIRCLE,

    radius: 6,

    groups: ["radar"],

    _destruct: function() {

        var sprite = this.collection.add("Sprite");

        sprite.zIndex = 3;

        sprite.x = this.x;
        sprite.y = this.y;

        sprite.easing = "linear";

        sprite.set("collect", false);

        sprite.loopDuration = 0.5;

    },

    onhit: function() {

        if (this.inView) {

            app.sound.play("martial/ball").gpan(this);

            this.poke(0.5);

        }

    },

    update: function(data) {

        Object.assign(this.shared, data);

        if (data.x !== undefined)
            this.tween.to('x', data.x, COMMON.TWEEN_DURATION * 2);
        if (data.y !== undefined)
            this.tween.to('y', data.y, COMMON.TWEEN_DURATION * 2);
        if (data.z !== undefined)
            this.tween.to('z', data.z, COMMON.TWEEN_DURATION * 2);

        if (data.remove !== undefined && data.remove) {

            this.removeTimeout = 4;

        }

    },

    enterview: function() {
    // app.sound.play("monster/growl" + Utils.random(1, 2));
    // app.sound.play("goblin/angry").rate(1.4).rrate(0.3);

    },

    poke: function(duration, delay) {

        var tween = app.tween(this);

        if (delay)
            tween.delay(delay);

        tween.to({
            scaleY: 0.75,
            scaleX: 1.25
        }, duration * 0.25, "outSine").to({
            scaleY: 1.0,
            scaleX: 1.0
        }, duration * 0.5, "outElastic");

    },

    step: function(dt) {

        this.tween.step(dt);

        if (this.removeTimeout > 0) {
            this.removeTimeout -= dt;

            if (this.removeTimeout <= 0) {

                this.collection.remove(this);

            }
        }

        this.scale = 1.0 + this.z / 60;

        this.lifetime += dt;

        var fx = this.shared.x - this.x;
        var fy = this.shared.y - this.y;

        if (this.removeTimeout > 0)
            fx = 32;

        this.frame += Math.max(Math.abs(fx), Math.abs(fy)) * 0.05;

        if (fx || fy) {

            this.direction = Utils.lookAt(0, 0, fx, fy)

        }

        //this.x = this.shared.x;
        //this.y = this.shared.y;
        //this.z = this.shared.z;

        this.trail.step(dt);

    },

    render: function(layer) {

        app.painter.reset();
        app.painter.translate(this.x, this.y);
        app.painter.scale(this.scale, this.scale * 0.6);
        app.painter.alpha(0.5 / (this.scale * 2));
        app.painter.color(0x000000);
        app.painter.fillCircle(0, 0, this.radius);

        app.painter.reset();
        app.painter.scale(0.7 * this.scale * this.scaleX, 0.7 * this.scale * this.scaleY);
        app.painter.drawSprite("ball", this.x, this.y - this.z, this.frame, Utils.dirrow(this.direction, 32));

        return;

        var frame = Math.abs(this.frame * 0.04 | 0) % 4;

        app.painter.reset();
        app.painter.translate(this.x, this.y - this.z - 5);
        app.painter.scale(this.scale * this.scaleX, this.scale * this.scaleY);
        app.painter.drawImageRegion(app.textures.ball, frame * 16, 0, 16, 16, 0, 0, 16, 16);

        return;
        this.trail.render(layer);

        layer.save();
        layer.translate(this.x, this.y);
        layer.scale(this.scale, this.scale * 0.6);
        layer.a(0.5 / (this.scale * 2));
        layer.fillStyle("#000").fillCircle(0, 0, this.radius);
        layer.restore();

        var frame = Math.abs(this.frame * 0.04 | 0) % 4;

        layer.save();
        layer.translate(this.x, this.y - this.z - 5);
        layer.scale(this.scale * this.scaleX, this.scale * this.scaleY);
        layer.drawImage(app.images.ball, frame * 16, 0, 16, 16, -8, -8, 16, 16);
        layer.restore();

    }

};

/* file: script/entities/MotionTrail.js */

CLIENT.MotionTrail = function(parent, args) {

    this.parent = parent;

    Object.assign(this, {
        alpha: 1.0,
        color: "#0fc",
        points: [],
        maxPoints: 16,
        width: 6,
        lifetime: 0,
        lifespan: 0,
        paused: false,
        interval: 0.03,
        blur: false,
        stroke: true,
        offsetY: 0,
        palette: ["#fbf236", "#df7126", "#ac3232", "#76428a"]
    }, args);

}
;

CLIENT.MotionTrail.prototype = {

    zIndex: 200,

    reaction: 8,

    clear: function() {

        this.points = [];

    },

    step: function(delta) {

        var moved = true;

        if (this.lastParentX === this.parent.x && this.lastParentY === this.parent.y) {

            moved = false;

        }

        this.lifetime += delta;

        if (Utils.interval(this, "point", this.interval)) {

            var diminish = !moved && Utils.interval(this, "diminish", 0.1);

            if (!this.paused && moved)
                this.points.push(this.parent.x, this.parent.y);

            if (this.points.length && (diminish || (this.points.length > this.maxPoints * 2) || (this.paused && this.points.length > 0))) {
                this.points.shift();
                this.points.shift();
            }

        }

        // this.points[this.points.length - 2] = this.parent.x + Math.cos(this.parent.rotation - Math.PI * 1) * 10;
        // this.points[this.points.length - 1] = this.parent.y + Math.sin(this.parent.rotation - Math.PI * 1) * 10 - this.parent.z;

        this.points[this.points.length - 2] = this.parent.x;
        this.points[this.points.length - 1] = this.parent.y - (this.parent.z || 0);

        if (this.lifespan && this.lifetime > this.lifespan) {
            this.paused = true;
        }

        this.lastParentX = this.parent.x;
        this.lastParentY = this.parent.y;

    },

    render: function(layer) {

        return;

        if (this.points.length <= 0)
            return;

        layer.save();
        layer.strokeStyle(this.color);
        layer.lineCap("round");

        if (this.blur) {
            layer.shadowBlur(this.width * 2);
            layer.shadowColor(this.color);
        }

        // if (!this.stroke) layer.strokeStyle("rgba(0,0,0,0.1)");

        for (var i = 2; i < this.points.length; i += 2) {

            var colorIndex = (1 - i / this.points.length) * this.palette.length | 0;

            var ratio = i / (2 * this.maxPoints);
            var px = this.points[i - 2];
            var py = this.points[i - 1];
            var nx = this.points[i];
            var ny = this.points[i + 1];
            layer.beginPath();
            if (this.alpha < 1.0)
                layer.a(this.alpha);
            layer.moveTo(px | 0, py | 0);
            layer.lineTo(nx | 0, ny | 0);
            // layer.a(ratio).lineWidth(ratio * this.width);
            layer.strokeStyle(this.color);
            // layer.strokeStyle(this.palette[colorIndex]);
            layer.lineWidth(ratio * this.width);
            layer.stroke();
        }

        layer.restore();

    }

};

/* file: script/entities/Citizen.js */

CLIENT.Citizen = function(args) {
    this.delay = 0;

    this.torsoDelay = 0.0;
    this.weaponData = COMMON.armory["axe"];
    this.charged = 0;
    this.hidden = false;
    this.flag = null;
    this.hasBlocked = 0;
    this.hasClashed = 0;
    this.ghost = 0;
    this.kind = "human";
    this.clip = false;
    this.helmetDetached = false;
    this.weaponDetached = false;
    this.shieldDetached = false;
    this.healthLost = 0.0;
    this.rank = 0;
    this.temp = Object.create(null);
    this.temp.inSight = true;
    this.bearing = 0;
    this.lifetime = 0;
    this.direction = 0.0;
    this.desiredDirection = 0.0;
    this.facing = 0;
    this.x = 0;
    this.y = 0;
    this.z = 0;
    this.d = 24;
    this.offsetY = 0;
    this.groundLevel = 0;
    this.scaleX = 1.0;
    this.scaleY = 1.0;
    this.scaleZ = 1.0;
    this.jumping = 0;
    this.random = Math.random();
    this.random2 = Math.random();
    this.textTimeout = 0;
    this.lastHit = {};
    this.maxHealth = 3;
    this.hitLifespan = 0;
    this.blinkData = {
        duration: 0,
        lifespan: 0,
        color: "#fff"
    };
    this.shield = "shield_wooden";
    this.weapon = "axe";
    this.helmet = "viking_helmet";

    this.cape = null;

    Object.assign(this, args);

    this.cooldowns = {};

    this.private = {
        items: {},
        cooldowns: {}
    };

    this.sprite = new CLIENT.Sprite();

    this.legs = new CLIENT.Sprite();
    this.legs.set("grunt/male/legs_run", true);
    this.legs.setDuration(0, 1.0, 0);

    this.leftHand = new CLIENT.Sprite();
    this.rightHand = new CLIENT.Sprite();
    this.head = new CLIENT.Sprite();

    this.sprites = new CLIENT.Sprites(this.sprite,this.leftHand,this.rightHand,this.head);
    this.allSprites = new CLIENT.Sprites(this.sprite,this.leftHand,this.rightHand,this.head,this.legs);

    this.state = new CLIENT.StateManager(this,CLIENT.Citizen);

    this.helmetData = COMMON.emptyObject;
    this.weaponData = COMMON.emptyObject;
    this.shieldData = COMMON.emptyObject;

    this.update(Object.assign({}, this.shared));

    // this.state.set("idle");

    this.desiredDirection = this.direction;

    this.setTeam(this.team);

    if (app.game.isMate(this)) {

        app.console.say("Your friend " + this.shared.name + " has joined the game", "friend");

        app.sound.play("ui/friend_join");

    }

    this.revenges = {};

    this.x = this.shared.x;
    this.y = this.shared.y;

    this.respawn();

    this.inView = this.game.camera.inView(this.x, this.y);

}
;

CLIENT.Citizen.prototype = {

    renderStains() {

        let aspectX = this.game.stainsBuffer.width / (this.game.innerWidth * 2);
        let aspectY = this.game.stainsBuffer.height / (this.game.innerHeight * 2);

        if (this.hitLifespan > 0 || this.state.currentKey === "dying") {

            let x = (this.x + Utils.random(-16, 16) + this.game.innerWidth) * aspectX;
            let y = (this.y + Utils.random(-16, 16) + this.game.innerHeight) * aspectY;

            let scale = 0.5 + Math.random();
            app.painter.reset();
            app.painter.align(0.5, 0.5)
            app.painter.scale(scale * 0.25 * aspectX, scale * 0.25 * aspectY)
            // app.painter.fillCircle(x, y, 10);
            app.painter.rotate(Math.random() * 6);
            app.painter.drawSprite("fx/blood_" + Utils.random(1, 2), x, y);

        }

        if (this.z === 0 && this.shared.moving && Utils.interval(this, "footprint", this.legs.loopDuration * 0.5)) {
            let x = (this.x + Utils.random(-4, 4) + this.game.innerWidth) * aspectX;
            let y = (this.y + Utils.random(-4, 4) + this.game.innerHeight) * aspectY;

            app.painter.reset();
            app.painter.color(0x000000);
            app.painter.alpha(0.4);
            app.painter.rotate(Math.random() * 6);
            app.painter.fillRect(x, y, 3 * aspectX, 3 * aspectY);
        }

        if (this.dashingLifespan > 0 || this.state.currentKey === "roll") {

            let gl = app.gl;

            let x = (this.game.width + this.x) * aspectX + Utils.random(-4, 4);
            let y = (this.game.height + this.y) * aspectY + Utils.random(-4, 4);
            let stain = app.atlas["splats/mud" + Utils.random(1, 3)];
            let progress = this.dashingLifespan;
            let scale = 0.15 * (0.5 + 0.5 * progress) * Utils.randomf(0.9, 1.1);

            app.painter.reset();

            // app.painter.rotate(this.direction + Utils.randomf(-0.5, 0.5))

            app.painter.blend(gl.FUNC_ADD, gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE)
            app.painter.rotate(Math.random() * 6)
            app.painter.alpha(0.25);
            app.painter.scale(aspectX * scale, aspectY * scale);
            app.painter.drawImageRegion(stain.texture, ...stain.region, x, y);

        }

    },

    physics: true,

    flags: new Set(["ad", "ae", "af", "ag", "ai", "al", "am", "an", "ao", "ar", "as", "at", "au", "aw", "ax", "az", "ba", "bb", "bd", "be", "bf", "bg", "bh", "bi", "bj", "bm", "bn", "bo", "br", "bs", "bt", "bv", "bw", "by", "bz", "ca", "catalonia", "cc", "cd", "cf", "cg", "ch", "ci", "ck", "cl", "cm", "cn", "co", "cr", "cs", "cu", "cv", "cx", "cy", "cz", "de", "dj", "dk", "dm", "do", "dz", "ec", "ee", "eg", "eh", "england", "er", "es", "et", "europeanunion", "fam", "fi", "fj", "fk", "fm", "fo", "fr", "ga", "gb", "gd", "ge", "gf", "gh", "gi", "gl", "gm", "gn", "gp", "gq", "gr", "gs", "gt", "gu", "gw", "gy", "hk", "hm", "hn", "hr", "ht", "hu", "id", "ie", "il", "in", "io", "iq", "ir", "is", "it", "jm", "jo", "jp", "ke", "kg", "kh", "ki", "km", "kn", "kp", "kr", "kw", "ky", "kz", "la", "lb", "lc", "li", "lk", "lr", "ls", "lt", "lu", "lv", "ly", "ma", "mc", "md", "me", "mg", "mh", "mk", "ml", "mm", "mn", "mo", "mp", "mq", "mr", "ms", "mt", "mu", "mv", "mw", "mx", "my", "mz", "na", "nc", "ne", "nf", "ng", "ni", "nl", "no", "np", "nr", "nu", "nz", "om", "pa", "pe", "pf", "pg", "ph", "pk", "pl", "pm", "pn", "pr", "ps", "pt", "pw", "py", "qa", "re", "ro", "rs", "ru", "rw", "sa", "sb", "sc", "scotland", "sd", "se", "sg", "sh", "si", "sj", "sk", "sl", "sm", "sn", "so", "sr", "st", "sv", "sy", "sz", "tc", "td", "tf", "tg", "th", "tj", "tk", "tl", "tm", "tn", "to", "tr", "tt", "tv", "tw", "tz", "ua", "ug", "um", "us", "uy", "uz", "va", "vc", "ve", "vg", "vi", "vn", "vu", "wales", "wf", "ws", "ye", "yt", "za", "zm", "zw"]),

    ranks: [[1, 0, 3, 12], [10, 0, 7, 12], [21, 0, 11, 12], [0, 14, 5, 12], [9, 14, 10, 12], [21, 14, 15, 12], [0, 28, 5, 12], [9, 28, 10, 12], [21, 28, 15, 12], [0, 43, 9, 9]],

    groups: ["citizens", "radar"],

    zIndex: 2,

    shape: CLIENT.CIRCLE,

    radius: 2,
    uiRadius: 10,

    constructor: CLIENT.Citizen,

    appear() {

        let sprite = this.collection.add("Sprite");

        sprite.follow = this;
        sprite.zIndex = this.zIndex + 1;
        sprite.followOffsetZ = 20;
        sprite.scaleX = 0.6;
        sprite.set("fx/blob");

        if (this.kind === "shadow")
            sprite.color = "#000";

        sprite.setDuration(0.5);

    },

    _destruct: function() {

        if (app.game.isMate(this)) {

            app.console.say("" + this.shared.name + " has left the game", "friend");

            app.sound.play("ui/friend_left");

        }

    },

    enterview() {

        this.scaleX = 0.0;

        app.tween(this).to({
            scaleX: 1.0
        }, 0.5, "outBounce");

    },

    leaveview() {

        if (this.temp.growlLoop) {

            this.temp.growlLoop.stop();
            this.temp.growlLoop = null;

        }

    },

    blink: function(color, duration) {

        this.blinkData.duration = duration;
        this.blinkData.lifespan = duration;
        this.blinkData.color = color;

    },

    renderHighlight() {

        return;

        if (this.game.hideUI)
            return;

        app.painter.reset()
        if (app.game.player && this.shared.team === app.game.player.shared.team)
            return;
        // app.painter.color(0x99cc00);
        // if (this === app.game.player) color = 0xffffff;

        app.painter.alpha(0.45);
        app.painter.align(0.5, 1.0);
        app.painter.scale(0.25 * this.data.bodyScale, 0.35 * this.data.bodyScale);
        app.painter.drawAtlas("player_highlight", this.x, this.y + 16);

    },

    airLaunch: function(duration, height=30) {

        if (this.z > height)
            return;

        app.tween(this).to({
            z: height
        }, duration * 0.6).to({
            z: 0
        }, duration * 0.4);

    },

    attachFlag: function() {

        this.flag = new CLIENT.Sprite();

        this.sprites.push(this.flag);

        if (!this.shared.team) {

            this.flag.setPalette(app.flag_red);

        }

        this.updatePrefix();

    },

    detachFlag: function() {

        this.sprites.pull(this.flag);
        this.flag = null;

    },

    die: function() {

        if (this.inView) {

            if (this.shield && Math.random() > 0.5 && this.shield !== "no_shield") {

                var equipment = this.game.entities.add("Equipment", {
                    x: this.x,
                    y: this.y,
                    key: this.shield,
                    color: this.rightHand.color
                });

                this.shieldDetached = true;

                equipment.sprite.setPalette(this.rightHand.palette);

            }

            if (this.weapon && Math.random() > 0.5 && this.weapon !== "no_weapon") {

                var equipment = this.game.entities.add("Equipment", {
                    x: this.x,
                    y: this.y,
                    key: this.weapon,
                    color: this.leftHand.color
                });

                this.weaponDetached = true;

                equipment.sprite.setPalette(this.leftHand.palette);

            }

            if (this.helmet && Math.random() > 0.5) {

                var equipment = this.game.entities.add("Equipment", {
                    x: this.x,
                    y: this.y,
                    key: this.helmet,
                    palette: this.palette,
                    color: this.head.color
                });

                this.helmetDetached = true;

                equipment.sprite.setPalette(this.head.palette);

            }

        }

    },

    disarm: function(weapon) {

        if (this.inView) {

            this.game.entities.add("Equipment", {
                x: this.x,
                y: this.y,
                key: weapon
            });

        }

    },

    setTeam: function(team) {

        this.team = team;

        if (this.game.modeData.tffa && team < 3) {

            if (this.game.player && this.game.player.shared.gameLink === this.shared.gameLink)
                this.team = 0;
            else
                this.team = Utils.random(1, 2);

        }

        this.color = this.isEnemy() ? "#a00" : "#37946e";

        this.updatePalette();

    },

    updatePalette() {

        let palette = this.shared.kind === "snowman" ? 0 : this.team;

        this.legs.setPalette(palette);

        if (this.shared.armor > 0 && this.shared.kind !== "snowman")
            this.sprite.setPalette(32 + palette);
        else
            this.sprite.setPalette(palette);

        // this.rightHand.setPalette(palette);

        this.leftHand.setPalette(0);
        this.rightHand.setPalette(8 + palette);
        this.head.setPalette(16 + palette);

        this.palette = palette;

        if (this.helmetData.fixedPalette !== undefined)
            this.head.setPalette(this.helmetData.fixedPalette);
        if (this.weaponData.fixedPalette !== undefined)
            this.leftHand.setPalette(this.weaponData.fixedPalette);
        if (this.shieldData.fixedPalette !== undefined)
            this.rightHand.setPalette(this.shieldData.fixedPalette);
    },

    isEnemy: function() {

        if (this.game.connectionData.spectate)
            return this.team > 0;
        if (!this.game.player)
            return false;

        return this.game.areEnemies(this, this.game.player);

    },

    onArmorHit() {

        if (this.inView) {

            var sprite = this.collection.add("Sprite");

            sprite.zIndex = 2;
            sprite.set("debris", false);
            // sprite.color = this.color;
            sprite.followOffsetZ = 5;
            sprite.follow = this;
            sprite.color = "#fff";
            sprite.scale = 1.0;
            sprite.setDuration(1.0);
            sprite.scaleX = 1.25;
            sprite.rotation = 0;

            app.sound.play("axe/armor_hit");

        }

    },

    onArmorLost() {

        if (this.inView) {

            var sprite = this.collection.add("Sprite");

            sprite.zIndex = 2;
            sprite.set("debris", false);
            // sprite.color = this.color;
            sprite.followOffsetZ = 0;
            sprite.follow = this;
            sprite.color = "#fff";
            sprite.scale = 1.5;
            sprite.setDuration(1.5);

            app.sound.play("axe/armor_break");

        }

    },

    onhit: function(data) {

        var attacker = this.collection.sid(data.attacker_sid);

        if (data.fatal && attacker && attacker === this.game.camera.follow) {

            app.sound.play("axe/hit").rate(0.6).rrate(0.1);

            // CLIENT.BetterAnnouncer.addKill();

            if (this.mode === "soccer") {

                app.sound.play("audience/cheers_" + Utils.random(1, 3));

            }

            if (this.game.player && this.game.player.revenges[this.shared.name]) {

                this.game.player.revenges[this.shared.name] = false;

                this.game.announcer.enqueue("revenge");

            }

        }

        if (this.inView && data.fatal && attacker && attacker instanceof CLIENT.Spikes) {

            app.tween(this).to({
                z: 100
            }, 0.5).to({
                z: 0
            }, 0.5);
        }

        if (this.player) {

            if (attacker && attacker instanceof CLIENT.Citizen) {

                this.lastAttacker = attacker;

            }

            if (data.fatal && this.game.mode === "soccer") {

                app.sound.play("audience/haha");

            }

        }

        if (data.armor) {

            this.hitLifespan = 0.5;

            if (this.shared.armor - data.armor <= 0) {

                this.onArmorLost();

            } else {

                this.onArmorHit();

            }

        }

        if (data.projectile_sid) {

            var projectile = this.collection.sid(data.projectile_sid);

            if (projectile && this.inView) {

                if (attacker && attacker.player && data.fatal && projectile instanceof CLIENT.ThrowingKnife) {

                    app.sound.play(Math.random() > 0.5 ? "voice/nice_throw1" : "voice/nice_throw2");

                }

                if (this.game.canDoodle() && (projectile instanceof CLIENT.Wave)) {

                    app.sound.play("martial/hit").rrate(0.2).gpan(this);

                    var sprite = this.collection.add("Sprite");

                    sprite.doodle = true;
                    sprite.color = "#fff";
                    sprite.zIndex = 3;
                    sprite.x = this.x;
                    sprite.y = this.y;
                    sprite.scaleX = 0.3;
                    sprite.scaleY = 0.2;
                    sprite.follow = this;
                    sprite.loopDuration = 0.5;
                    sprite.blendMode = "lighter";
                    sprite.alpha = 0.5;
                    sprite.set("puff_ring", false);

                    app.tween(this).to({
                        z: 15
                    }, 0.3).to({
                        z: 0
                    }, 0.5, "outBounce");

                }

            }

        }

        if (data.damage > 0) {

            this.lastHit = data;

            this.shake = this.shakeDuration = 0.3;
            this.shakeDirection = data.inx < 0 ? -1 : 1;

            if (this.inView) {

                this.hitLifespan = 0.2;

                this.game.fx("bleed", {
                    angle: attacker ? Utils.lookAt(attacker, this) : 0,
                    x: this.x,
                    y: this.y,
                    zIndex: this.zIndex
                });

                this.shake = this.shakeDuration;

                app.sound.play("axe/hit").rrate(0.25).gpan(this);
                app.sound.play("martial/hit").rrate(0.2).gpan(this);
                // app.sound.play("hit_ouch").rate(1.5).rrate(0.1);

                app.sound.play(this.kind + "/pain" + Utils.random(1, 3)).rate(this.data.pitch).rrate(0.1).gpan(this);

                {

                    let angle = 0;

                    if (attacker)
                        angle = Utils.lookAt(attacker, this);

                    let blood = this.collection.add("Sprite");

                    blood.set("fx/blood_" + Utils.random(1, 2), false);
                    blood.setDuration(Utils.randomf(0.2, 0.6));
                    blood.follow = this;
                    // blood.followOffsetX = Math.cos(angle - Math.PI) * 15;
                    // blood.followOffsetY = Math.sin(angle - Math.PI) * 15;

                    blood.rotation = angle;
                    blood.z = Utils.random(10, 20);
                    // blood.scale = 0.5 + (data.damage || 1) / 3;

                }

            }

        }

        if (this.inView) {

            if (data.stun) {

                app.sound.play("axe/stun").rate(0.6).gpan(this);

            }

            if (data.kick || data.fall) {

                app.sound.play("martial/hit").rrate(0.2).gpan(this);
                // app.sound.play(this.kind + "/pain3").rrate(0.1).gpan(this);

            }

            if (data.fatal && data.crush) {

                // app.sound.play("monster/kill").rrate(0.2).gpan(this);

                this.game.fx("blood_explosion", {
                    x: this.x,
                    y: this.y
                });

                this.hidden = false;

            }

        }

    },

    fall: function() {

        var citizen = this;

        if (this.inView) {

            if (this.temp.fallen)
                return;

            this.temp.fallen = true;

            setTimeout(function() {

                app.sound.play("martial/fall").rate(0.25).gpan(citizen);
                app.sound.play("human/scream").rate(0.8 * this.data.pitch).rrate(0.1).gpan(citizen).fadeOut(1.0);

                app.sound.play("monster/sandworm_attack").rate(0.5);
                app.sound.play("monster/kill").rate(0.5);
                app.sound.play("monster/death").rate(0.5);

                var sandworm = citizen.collection.add("Sprite");
                sandworm.set("sandworm/attack", false);
                sandworm.setDuration(4.0);
                sandworm.x = citizen.x;
                sandworm.y = citizen.y;
                sandworm.easing = "outCubic";

            }, 100);

        }

        this.hidden = true;

    },

    stars() {

        for (let i = 0; i < 6; i++) {

            let duration = 1.0;
            let delay = Math.random() * 0.1;

            let sprite = this.collection.add("Sprite");
            sprite.set("fx/star");
            sprite.loop = true;
            sprite.duration = 1.0;
            sprite.x = this.x;
            sprite.y = this.y;
            sprite.tc = 4.0;
            sprite.scale = 0.5;
            sprite.lifespan = duration + delay;

            app.tween(sprite).delay(delay).to({
                x: this.x + Utils.random(-100, 100),
                y: this.y + Utils.random(-100, 100),
                scale: 0.0,
                tc: 0.0
            }, duration);

            app.tween(sprite).delay(delay).to({
                z: Utils.random(50, 100)
            }, duration * 0.25).to({
                z: 0
            }, duration * 0.75, "outBounce");

        }

    },

    setAsPlayer: function() {

        this.player = true;

        this.onFlagChange();

        this.updatePrefix();

        this.game.preloadHero();

    },

    onFlagChange: function() {
    },

    setKey(key) {

        this.key = key;
        this.data = app.data.minions[key];
        this.healthLost = this.data.maxHealth;

    },

    setSprite: function(key, legs, loop, duration) {

        if (!this.sprite.prefix)
            return;

        this.sprite.set(key, loop);

        if (this.weapon)
            this.leftHand.set(key, loop);
        if (this.shield)
            this.rightHand.set(key, loop);
        if (this.helmet)
            this.head.set(key, loop);
        if (this.flag) {

            this.flag.set(key, loop);
            this.flag.easing = "linear";

        }

        if (typeof duration === "object") {

            this.sprites.setDuration(duration[0], duration[1], duration[2])

        } else {

            this.sprites.setDuration(duration)

        }

        this.sprite.easing = "linear";
        this.head.easing = "linear";
        this.leftHand.easing = "linear";
        this.rightHand.easing = "linear";

        // this.leftHand.color = "#fff"
        // this.leftHand.colorMode = "color"

        if (!legs)
            this.legs.hide();
        else
            this.legs.show();

        return this.sprite;

    },

    killedByPlayer() {

        app.happyTime(0.5);

        app.sound.play("gameplay/killed_by_player").volume(1.0).rrate(0.1).gpan(this);

        app.tween(this).to({
            z: 20
        }, 0.2).to({
            z: 0
        }, 1.0, "outBounce");

        for (let i = 0; i < 3; i++) {

            let slash = this.collection.add("Sprite");

            slash.follow = this;
            slash.lifespan = 0.2 + Math.random() * 0.5;
            slash.setDuration(slash.lifespan);
            slash.scale = 0.5 + Math.random();
            slash.rotation = Math.random() * 6.25;
            slash.set("fx/slash_dual_left");
            slash.color = "#cc0000";
            slash.delay = Math.random() * 0.5;
            slash.followOffsetX = Utils.random(-16, 16);
            slash.followOffsetY = Utils.random(-16, 16);

        }

    },

    equip: function(key) {

        var equipment = COMMON.armory[key];

        if (!equipment)
            return;

        if (equipment.spell_one) {

            this.spell_one = equipment.spell_one;

        }

    },

    updatePrefix: function() {

        this.legs.alpha = 1.0;

        if (this.kind === "snowman") {

            this.body = "snowman";
            this.sprite.prefix = "grunt" + "/snowman/";
            this.legs.alpha = 0.0;

        } else if (this.kind === "female") {

            this.body = "female";
            this.sprite.prefix = "grunt" + "/female/";

        } else {

            this.body = "male";
            this.sprite.prefix = "grunt" + "/male/";

        }

        if (this.shared.armor && this.kind !== "snowman") {

            this.sprite.prefix = "grunt" + "/armor/";

        }

        if (this.flag) {

            this.flag.prefix = "grunt" + "/flag_";

        }

        if (this.weapon) {

            this.leftHand.prefix = "grunt" + "/" + (this.weaponData.sprite || this.weapon) + "_";
            this.leftHand.show();

        } else {

            this.leftHand.hide();

        }

        if (this.shield) {

            this.rightHand.prefix = "grunt" + "/" + this.shield + "_";
            this.rightHand.show();

        } else {

            this.rightHand.hide();

        }

        if (this.helmet) {

            this.head.prefix = "grunt" + "/" + this.helmet + "_";

            this.head.show();

        } else {

            this.head.hide();

        }

        this.sprites.setNotHidden(this.sprite.key || "run", this.sprite.options);

        this.setTeam(this.shared.team);

    },

    hitBubble(health) {

        let text = this.collection.add("Text");

        text.text = String("-" + health.toFixed(1));
        text.foreground = 0xcc0000;
        text.offsetZ = 40;
        text.follow = this;
        app.tween(text).to({
            offsetZ: text.offsetZ + 20
        }, 2.0);

        text.lifespan = 2.0;

    },

    update: function(data) {

        var preload = false;
        var updatePrefix = false;

        // this.direction = Utils.lookAt(this.x * 10, this.y * 10, this.shared.x * 10, this.shared.y * 10);

        if (data.armor !== undefined) {

            updatePrefix = true;
            this.updatePalette();

        }

        if (data.key !== undefined) {

            preload = true;
            updatePrefix = true;

            this.setKey(data.key);

        }

        if (data.health !== undefined) {

            if (this.shared.health > data.health) {

                this.hitBubble(this.shared.health - data.health);

            }

            app.tween(this).to({
                healthLost: data.health
            }, 1.5, "inQuad");

        }

        if (data.cape !== undefined) {

            preload = true;

            updatePrefix = true;

            if (data.cape !== "no_cape") {

                this.capeData = COMMON.armory[data.cape];

            } else {

                this.cape = null;
                this.capeData = app.empty;

            }

        }

        if (data.weapon !== undefined) {

            preload = true;

            if (COMMON.armory[data.weapon] && data.weapon !== "no_weapon") {

                this.weaponData = COMMON.armory[data.weapon];
                this.weapon = data.weapon;
                this.equip(data.weapon);

            } else {

                this.weapon = false;
                this.weaponData = COMMON.armory.no_weapon;

            }

            updatePrefix = true;

        }

        if (data.helmet !== undefined) {

            preload = true;

            if (data.helmet !== "no_helmet") {

                this.helmet = data.helmet;
                this.helmetData = COMMON.armory[data.helmet];

            } else {

                this.helmet = false;
                this.helmetData = app.empty;

            }

            updatePrefix = true;

        }

        if (data.shield !== undefined) {

            preload = true;

            if (data.shield !== "no_shield") {

                this.shield = data.shield;
                this.shieldData = COMMON.armory[data.shield];

            } else {

                this.shield = false;
                this.shieldData = app.empty;

            }

            updatePrefix = true;

        }

        if (data.moving !== undefined) {

            if (data.moving && Boolean(data.moving) !== Boolean(this.shared.moving)) {

                this.legs.set("grunt/male/legs_run", true)

            }

            if (!data.moving) {

                this.legs.loop = false;
                this.legs.end();

            }

        }

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

        if (data.direction !== undefined) {

            this.desiredDirection = data.direction;

            // this.sprite.start = ((this.direction / Math.TAU) * this.sprite.data.rows | 0) * this.sprite.data.frames;
            // this.legs.start = ((this.direction / Math.TAU) * this.legs.data.rows | 0) * this.legs.data.frames;

        }

        if (this.inView && data.frozen && !this.shared.frozen) {

            var blast = this.collection.add("Sprite");
            blast.setDuration(0.4);
            blast.set("fx/lighting");
            blast.follow = this;
            blast.color = "#0cf";
            // blast.alpha = 1.0;
            blast.zIndex = 2;

            app.sound.play("spells/freeze2").rate(1.5).rrate(0.2).gpan(this);

        }

        Object.assign(this.shared, data);

        if (data.x !== undefined || data.y !== undefined) {

            this.temp.tweenspeed = Utils.distance(this.x, this.y, this.shared.x, this.shared.y) * (1 / (this.player ? (1 / 30) : COMMON.SHARE_INTERVAL)) * 0.4;

        }

        if (data.kind) {

            updatePrefix = true;

            this.kind = data.kind;

            if (data.kind === "female")
                this.gender = "female";
            else
                this.gender = "male";

        }

        if (updatePrefix) {

            this.updatePrefix();

        }

        if (data.stateQueue) {

            for (var i = 0; i < data.stateQueue.length; i++) {

                var key = this.game.sharer.getKey(data.stateQueue[i]);

                var next = data.stateQueue[i + 1];

                if (typeof next === "object") {

                    i++;

                }

                this.state.set(key, next);

            }

        }

        /*
            if (data.stateKey) {

              if(this.player) console.log(data.stateKey)

              this.state.set(data.stateKey);

            }
        */

        if (data.name !== undefined) {

            let temp = data.name.split("/");

            this.shared.name = temp[0] ? temp[0].toUpperCase() : "";
            this.shared.tribe_tag = temp[1] ? temp[1].toUpperCase() : "";

        }

        if (data.team !== undefined) {

            this.setTeam(data.team);

            if (this.player)
                this.game.refreshTeams();

        }

        if (preload && this.player) {

            this.game.preloadHero();

        }

        if (data.score && this.player) {

            var hs = localStorage.getItem("highscore") | 0;

            if (data.score > hs)
                localStorage.setItem("highscore", data.score);

            if (this.game.modeData.shadows) {

                if (data.score > this.game.hellHighscore) {

                    this.game.hellHighscore = data.score;

                    localStorage.setItem("hell_highscore", this.game.hellHighscore);

                    if (!CLIENT.Announcer2.hellHighscore) {

                        CLIENT.Announcer2.hellHighscore = true;

                        app.sound.play("hell/highscore");

                        CLIENT.Announcer2.run("highscore");

                    }

                }

            }

        }

        if (data.flag && this.player) {

            this.onFlagChange();

        }

    },

    transformation() {

        if (!this.inView)
            return;

        this.hitLifespan = 1.0;

        app.sound.play("hell/transform").gpan(this);
        app.sound.play("impact/ground_heavy").rate(0.5).gpan(this);

        for (var i = 0; i < 6; i++) {

            this.game.fx("plank", {
                x: this.x,
                y: this.y
            });

        }

        let angles = 6;
        let angle_step = Math.TAU / angles;

        for (var i = 0; i < angles; i++) {

            var sprite = this.collection.add("Sprite");

            sprite.set("fx/quake", false);
            sprite.zIndex = 1;
            sprite.rotation = angle_step * i;
            sprite.x = this.x;
            sprite.y = this.y;
            sprite.color = "#fff";
            sprite.force = 500;
            sprite.forceDamping = 300;
            sprite.forceDirection = angle_step * i;
            sprite.duration = sprite.lifespan = 0.5;
            sprite.scale = 2;

            // app.tween(sprite).to({ scale: 0}, sprite.lifespan)

        }
    },

    turnIntoHuman() {

        if (!this.inView)
            return;

        this.hitLifespan = 1.0;

        app.sound.play("hell/transform").gpan(this);
        app.sound.play("impact/ground_heavy").rate(0.5).gpan(this);

        for (var i = 0; i < 6; i++) {

            this.game.fx("plank", {
                x: this.x,
                y: this.y
            });

        }

        let angles = 6;
        let angle_step = Math.TAU / angles;

        for (var i = 0; i < angles; i++) {

            var sprite = this.collection.add("Sprite");

            sprite.set("fx/quake", false);
            sprite.zIndex = 1;
            sprite.rotation = angle_step * i;
            sprite.x = this.x;
            sprite.y = this.y;
            sprite.color = "#fff";
            sprite.force = 500;
            sprite.forceDamping = 300;
            sprite.forceDirection = angle_step * i;
            sprite.duration = sprite.lifespan = 0.5;
            sprite.scale = 2;

            // app.tween(sprite).to({ scale: 0}, sprite.lifespan)

        }
    },

    poke: function(duration, delay) {

        this.sprites.assign("scale", 1.0);
        this.scale = 1.0;

        return;

        duration = duration || 0.5;

        var tween = app.tween(this);

        if (delay)
            tween.delay(delay);

        tween.to({
            scaleY: 0.75,
            scaleX: 1.25
        }, duration * 0.25, "outSine").to({
            scaleY: 1.0,
            scaleX: 1.0
        }, duration * 0.5, "outElastic");

    },

    getBearing: function(key) {

        var mx = 0;
        var my = 0;

        if (key & COMMON.FLAG_UP) {

            my -= 1;

        }

        if (key & COMMON.FLAG_DOWN) {

            my += 1;

        }

        if (key & COMMON.FLAG_LEFT) {

            mx -= 1;

        }

        if (key & COMMON.FLAG_RIGHT) {

            mx += 1;

        }

        return Utils.lookAt(0, 0, mx, my);

    },

    step: function(dt) {

        if (this.delay > 0)
            return this.delay -= dt;

        if (this.torsoDelay > 0) {
            this.torsoDelay = Math.max(0, this.torsoDelay - dt);
        }

        if (this.ghost > 0) {

            this.ghost -= dt;

            let color = app.lifetime % 0.1 < 0.05 ? false : "#fff";

            this.allSprites.assign("alpha", Utils.saw(app.lifetime % 0.4 / 0.4));

            if (this.ghost <= 0) {

                this.allSprites.assign("alpha", 1.0);

            }

        }

        this.hitLifespan = Math.max(-1.0, this.hitLifespan - dt);

        if (this.blinkData.lifespan > 0) {

            this.blinkData.lifespan -= dt;

        }

        if (Utils.quickPointInRange(this.x, this.y, this.shared.x, this.shared.y, 100)) {

            this.x = Utils.moveTo(this.x, this.shared.x, this.temp.tweenspeed * dt);
            this.y = Utils.moveTo(this.y, this.shared.y, this.temp.tweenspeed * dt);

        } else {

            this.x = this.shared.x;
            this.y = this.shared.y;

        }

        this.textTimeout -= dt;

        var fo = -0.5 * Math.TAU / this.sprite.data.rows;

        // this.bearing = Utils.circWrapTo(this.bearing, this.getBearing(), 12 * dt);

        // var dirrow = (Utils.circWrap(this.bearing - fo) / Math.TAU) * this.legs.data.rows | 0;

        if (this.direction !== this.desiredDirection || this.prevRows !== this.sprite.data.rows) {

            this.direction = Utils.circWrapTo(this.direction, this.desiredDirection, Math.TAU * 2 * dt);

            var direction = Utils.lookAt(0, 0, Math.cos(this.direction) * 16, 1.4 * Math.sin(this.direction) * 16);

            var dirrow = (Utils.circWrap(direction - fo) / Math.TAU) * this.sprite.data.rows | 0;

            this.sprite.row = dirrow;
            this.leftHand.row = dirrow;
            this.rightHand.row = dirrow;
            this.head.row = dirrow;
            this.legs.row = dirrow;

            if (this.flag)
                this.flag.row = dirrow;

            this.prevRows = this.sprite.data.rows
        }

        if (this.jumping > 0)
            this.jumping = Math.max(0, this.jumping - dt);

        if (this.shake > 0)
            this.shake -= dt;

        this.lifetime += dt;

        if (this.inView) {

            if (this.z <= 0 && this.shared.moving && Utils.interval(this, "footstep", this.legs.loopDuration * 0.5)) {

                app.sound.play((this.tile && this.tile.groundDef) > 0 ? "footstep_wood" : "footstep").rate(1).volume(0.8).rrate(0.2).gpan(this);

            }

        }

        this.state.step(dt);

        if (this.inView) {

            let sdt = dt;

            if (this.torsoDelay > 0)
                sdt = 0;

            this.sprite.step(sdt);
            this.leftHand.step(sdt);
            this.rightHand.step(sdt);
            this.head.step(sdt);
            this.legs.step(dt);

        }

        if (this.flag)
            this.flag.step(this.flag.key === "run" ? dt * 0.8 : dt);

        if (this.inView && this.prevZ && this.z === 0) {

            this.puff();

            app.sound.play("martial/ground").gpan(this).rrate(0.2);

        }

        this.prevZ = this.z;
        /*
            if (false && this.game.mode !== "soccer") {

              this.scaleX = 0.65 + this.rank * 0.055;
              this.scaleY = 0.65 + this.rank * 0.055;
              this.scaleZ = 0.65 + this.rank * 0.055;

            } else {

              this.scaleX = 1.0;
              this.scaleY = 1.0;
              this.scaleZ = 1.0;

            }
        */

        // if (this.game.modeData.grow) s = s + this.place * 0.06 - 0.2;
        // if (this.kind === "shadow") s = 1.0;

        // if (this.player) console.log(s);

        this.tx = Math.floor(this.x / COMMON.TILE_WIDTH);
        this.ty = Math.floor(this.y / COMMON.TILE_HEIGHT);

        if (this.hasBlocked > 0) {

            this.hasBlocked -= dt;

            if (this.shield) {

                this.rightHand.tempColor = "#fff";

            } else {

                this.leftHand.tempColor = "#fff";

            }

        }

        if (this.hasClashed > 0) {

            this.hasClashed -= dt;
            this.leftHand.tempColor = "#fff";

        }

        this.updateGrowl();

        if (this.inView)
            this.tile = this.game.map.get(this.tx, this.ty);
    },

    updateGrowl: function() {

        if (this.shared.growling && !this.temp.growlLoop && this.inView && this.shared.moving) {

            this.temp.growlLoop = app.sound.play(this.kind + "/growl").loop().fadeIn(0.4);
            this.temp.growlLoop.entity = this;

            if (this.player)
                this.temp.growlLoop.rate(0.9).rateTo(0.8, 1.0);
            else
                this.temp.growlLoop.rate(0.6 + this.random * 0.4).volume(0.6);

        }

        if (this.temp.growlLoop && this.inView) {

            if (!this.shared.moving || !this.shared.growling) {

                this.temp.growlLoop.fadeOut(0.25);

                this.temp.growlLoop = false;

            } else {

                this.temp.growlLoop.gpan(this);

            }

        }

    },

    tick: function() {
    /*
            if (this.player) {

              var bubble = this.collection.add("TextBubble");

              bubble.text = "+40";
              bubble.background = "#000";



            }

            */

    },

    block: function() {

        this.hasBlocked = 0.4;

        if (this.inView) {

            app.sound.play("axe/blocked").rrate(0.1).gpan(this);

            var sprite = this.collection.add("Sprite");
            sprite.rotation = this.direction + Math.PI / 2 + Math.PI;

            sprite.alignY = 0.0;
            sprite.scale = 0.5;
            sprite.setDuration(0.5);
            sprite.followOffsetX = Math.cos(this.direction) * 16;
            sprite.followOffsetY = Math.sin(this.direction) * 16;
            sprite.followOffsetZ = 16;
            sprite.color = "#fff";
            sprite.set("fx/impact_spark");
            sprite.zIndex = 2;
            sprite.follow = this;

        }

    },

    clash: function() {

        this.hasClashed = 0.4;

        if (this.inView) {
        }

    },

    puff: function() {

        if (!this.inView)
            return;

        var dust = this.collection.add("Sprite");

        dust.set("puff_ring");

        // dust.follow = this;
        dust.x = this.x;
        dust.y = this.y - Utils.random(0, 6);
        dust.scaleX = 0.3;
        dust.scaleY = 0.2;
        dust.zIndex = 1;
        dust.setDuration(0, 0.8, 0);

    },

    setGroundLevel: function(level) {

        if (level === this.groundLevel)
            return;

        this.groundLevel = level;

        app.tween(this).to({
            z: this.groundLevel * 8
        }, 0.4, "outBounce");

    },

    prerender: function() {
    },

    isOnFloor() {

        return Boolean(this.tile && this.tile.groundDef && this.tile.groundDef.floor);

    },

    render: function(layer) {

        if (this.game.player && this.isOnFloor() !== this.game.player.isOnFloor())
            return;

        if (this.hidden)
            return;
        let ics = 1 / this.game.camera.scale;

        app.painter.reset();

        app.painter.scale(1.0, 0.6);

        /* shadow */

        app.painter.color(0x000000, 0.25).fillCircle(this.x, this.y, 12);

        if (this.charged > 0)
            app.painter.color(0xffffaa, 0.75).fillCircle(this.x, this.y, this.charged * 14);

        if (this.player && !this.game.hideUI) {

            // this.game.renderSimpleBar(this.x, this.y + 18, 24, 2, 0xffffff, 0x555555, this.game.stamina / 2.0);
            this.game.renderArcBar(this.x, this.y, 9, 12, 1.0, 0, 0x555555);
            this.game.renderArcBar(this.x, this.y, 9, 12, this.game.stamina / 1.0, 0, 0xffffff);

        }

        /* sprites */

        var oy = (this.shared.moving ? COMMON.legsZ[this.legs.frame] : 0);

        oy = oy * 6 + 0.5 | 0;

        this.legsY = oy;
        let scaleX = this.data.bodyScale + (this.shared.armor ? 0.0 : 0);
        let scaleY = this.data.bodyScale + (this.shared.armor ? 0.0 : 0);

        if (this.legs.hidden)
            oy = 0;

        this.legs.x = Math.floor(this.x);
        this.legs.y = Math.floor(this.y - this.z - 14 * scaleY - oy);

        // - 14 * this.scaleY - oy;

        this.sprite.x = Math.floor(this.x);
        this.sprite.y = Math.floor(this.legs.y) + 4 - this.data.height * 6 | 0;

        /* Crouching */
        this.legs.y = Math.floor(this.y - Math.max(0, this.z) - 14 * scaleY - oy);

        this.allSprites.assign("scaleX", scaleX);
        this.allSprites.assign("scaleY", scaleY);

        this.leftHand.x = this.sprite.x;
        this.leftHand.y = this.sprite.y;

        this.rightHand.x = this.sprite.x;
        this.rightHand.y = this.sprite.y;

        this.head.x = this.sprite.x;
        this.head.y = this.sprite.y;

        if (this.flag) {
            this.flag.x = this.sprite.x;
            this.flag.y = this.sprite.y;
        }

        this.legs.render(layer);

        if (this.sprite.row > this.sprite.data.rows * 0.75 || this.sprite.row === 0) {

            if (!this.shieldDetached)
                this.rightHand.render(layer);

            this.sprite.render(layer);

        } else {

            this.sprite.render(layer);
            if (!this.shieldDetached)
                this.rightHand.render(layer);

        }

        this.renderCape();

        if (this.sprite.row <= this.sprite.data.rows * 0.75) {

            if (!this.helmetDetached)
                this.head.render(layer);

            if (!this.weaponDetached) {

                this.leftHand.render(layer);

            }

        } else {

            if (!this.weaponDetached) {

                this.leftHand.render(layer);

            }

            if (!this.helmetDetached)
                this.head.render(layer);

        }

        if (this.flag)
            this.flag.render(layer);

        if (this.shared.frozen > 0) {

            this.allSprites.assign("tempColor", "#0ef");
            this.allSprites.assign("tempColorMode", "lighter");
            this.allSprites.assign("tempColorAlpha", 0.5);
            this.allSprites.assign("tc", 0);

        } else if (this.hitLifespan > 0) {

            if (this.shared.armor) {

                this.sprite.tempColor = "#fff";

            } else {

                this.allSprites.assign("tempColor", "#f00");

            }

        } else if (this.blinkData.lifespan > 0) {

            let a = app.ease(this.blinkData.lifespan / this.blinkData.duration, "outQuad");

            this.allSprites.assign("tempColor", this.blinkData.color);
            this.allSprites.assign("tempColorMode", "source-atop");
            this.allSprites.assign("tempColorAlpha", a);

        } else {

            this.allSprites.assign("tempColor", false);
            this.allSprites.assign("tc", 1.0);

        }

        app.painter.reset();

        let nameWidth = this.game.nameFont.getWidth(this.shared.name);

        if (this.game.showNames && this.shared.key === "hero" && !this.game.hideUI) {

            this.game.nameFont.scale = ics;
            this.game.nameFont.color = this.isEnemy() ? 0xaa0000 : 0x222222;
            this.game.nameFont.fillText(this.shared.name, Math.floor(this.x), Math.floor(this.y) + 24 * ics + 1);

            if (this.shared.tribe_tag) {

                this.game.nameFont.color = 0x666666;
                this.game.nameFont.fillText(this.shared.tribe_tag, Math.floor(this.x), Math.floor(this.y) + 35 * ics);
            }

        }

        if (ENV.DEBUG) {

            this.game.nameFont.scale = ics;
            this.game.nameFont.color = 0x000000;
            this.game.nameFont.fillText(this.sid, this.x, this.y - 64);

        }

        app.painter.reset();
        if (this.shared.badges.letsplayer && !this.game.hideUI && this.game.showNames) {
            app.painter.drawAtlas((app.lifetime % 1.0 < 0.5) ? "ui/record_on" : "ui/record_off", this.x + nameWidth / 2 + 6 * ics | 0, this.y + 27 * ics + 1 | 0);
        }
        app.painter.scale(1 / this.game.camera.scale, 1 / this.game.camera.scale);

        if (this.game.showNames && this.shared.flag && !this.game.hideUI) {

            if (this.game.modeData.fun && this.place > 0 && this.place <= 10) {
                app.painter.scale(app.cycle(0, 2, 0.25, 2.0), 1.0);

                app.painter.alpha(1.0);
                app.painter.align(0.5, 0.5);

                // app.painter.drawAtlas("ranks/ingame/" + this.place, this.x + (nameWidth / 2 + 4) * ics, this.y + 28);
                // app.painter.drawAtlas("ranks/ingame/" + this.place, this.x, this.y - 40 - this.z);
                app.painter.drawAtlas("ranks/ingame/" + this.place, this.x - (nameWidth / 2 + 7) * ics, this.y + 28);

            }

            // && (app.lifetime % 2.0 < 1.0)
            if (this.shared.flag) {

                app.painter.scale(app.cycle(1, 2, 0.25, 2.0), 1.0);

                var index = COMMON.COUNTRY_INDEX[this.shared.flag];

                var cx = 12 * (index % 20);
                var cy = 8 * (index / 20 | 0);

                app.painter.drawImageRegion(app.textures.flags.all, cx, cy, 12, 8, this.x - (nameWidth / 2 + 8) * ics | 0, this.y + 28 * ics | 0);

            }

        }

        if (!this.game.hideUI) {

            this.game.renderArcBar(this.x, this.y, 14, 17, this.shared.health / this.shared.maxHealth, this.healthLost / this.shared.maxHealth, this.isEnemy() ? COMMON.ENEMY_COLOR : COMMON.FRIEND_COLOR);

            if (this.shared.armor) {
                this.game.renderArcBar(this.x, this.y, 19, 22, this.shared.armor / (this.data.maxArmor), 0, 0x869fa8);
            }

            this.postrender();
        }

        if (this.textTimeout > 0) {

            this.game.chatFont.scale = ics;
            // 0x550055
            this.game.chatFont.color = 0x000000;
            this.game.chatFont.fillText(this.text, this.x, this.y - 90 * ics);

        }

        this.renderHighlight();

    },

    renderScore: function(layer) {

        let x = this.x;
        let y = this.y - 60;

        layer.textAlign("center");
        layer.font("700 9px 'Exo 2'");
        layer.fillStyle(this.color);
        layer.fillCircle(x, y + 4, 7)
        layer.fillStyle("#fff");
        // layer.fillText(this.shared.score, x, y);
        layer.context.fillText(this.shared.score, x, y - 2);

    },
    renderArmor() {

        if (this.shared.armor) {

            app.painter.reset();
            if (this.hitLifespan > 0 && this.shared.armor > 0)
                app.painter.color(0xffffff);
            app.painter.palette(0);
            app.painter.scale(this.sprite.scaleX, this.sprite.scaleY);
            app.painter.drawSprite("grunt/" + this.gender + "/armor_" + this.sprite.key, this.sprite.x, this.sprite.y, this.sprite.frame, this.sprite.row);

        }
    },

    renderCape() {

        if (this.shared.cape && this.shared.cape !== "no_cape") {

            app.painter.reset();
            if (this.hitLifespan > 0)
                app.painter.color(0xffffff);
            app.painter.palette(this.capeData.fixedPalette !== undefined ? this.capeData.fixedPalette : this.palette);
            app.painter.scale(this.sprite.scaleX, this.sprite.scaleY);
            app.painter.drawSprite("grunt/" + this.shared.cape + "_" + this.sprite.key, this.sprite.x, this.sprite.y, this.sprite.frame, this.sprite.row);

        }
    },

    renderRank: function(layer) {

        if (!this.temp.rank) {

            var rank = CLIENT.Ranks.pointsToRank(this.shared.mmr, app.lobby.maxMMR[this.game.modeData.scoreKey], COMMON.RANK_ICONS[this.game.modeData.scoreKey].length);

            this.temp.rank = COMMON.RANK_ICONS[this.game.modeData.scoreKey][rank];

        }

        layer.drawRegion(app.images.rank_icons, this.temp.rank, this.x - this.temp.rank[2] / 2 | 0, this.y - 64 * this.scaleY | 0);

    },

    renderPath: function() {

        if (this.shared.path) {

            layer.strokeStyle("#c00").lineWidth(6);

            layer.beginPath();

            layer.moveTo(this.x, this.y);

            for (var i = 0; i < this.shared.path.length; i += 2) {

                x = this.shared.path[i + 1] * COMMON.SUBTILE_WIDTH;
                y = this.shared.path[i] * COMMON.SUBTILE_HEIGHT;

                if (i < 2) {

                    layer.moveTo(x, y);

                } else {

                    layer.lineTo(x, y);

                }

            }

            layer.stroke();

        }

    },

    postrender: function(layer) {

        return;

        let ics = 1 / this.game.camera.scale;
        let face, sprite;

        if (this.player && this.charged > 0) {

            face = Math.min(6, this.charged * 7 | 0);
            sprite = app.atlas["charge_face/" + face];

        } else {

            face = (1.0 - this.shared.health / this.maxHealth) * 6 | 0;
            sprite = app.atlas["health_face/" + face];

        }

        app.painter.reset();
        app.painter.scale(ics, ics);
        app.painter.drawImageRegion(sprite.texture, ...sprite.region, Math.floor(this.x), Math.floor(this.y - this.legsY - 20 * ics));
    },

    renderPlayer: function(layer) {

        for (var i = 0; i < this.game.navmarks.length; i++) {

            var mark = this.game.navmarks[i];

            if (Utils.quickPointInRange(this.x, this.y, mark.entity.x, mark.entity.y, 10))
                continue;

            var angle = Utils.lookAt(this, mark.entity);

            var radius = 40 + i * 5;

            layer.save();
            layer.align(0.5, 0.5);
            layer.translate(Math.cos(angle) * radius, Math.sin(angle) * radius);
            layer.rotate(angle - Math.HPI);
            layer.drawRegion(app.images.markers, mark.sprite, 0, 0);
            layer.restore();

        }

    },

    dash: function(direction) {

        if (!this.inView)
            return;

        this.dashingLifespan = 1.0;

        app.tween(this).to({
            dashingLifespan: 0
        }, 0.5);

        app.sound.play("martial/dash").rrate(0.1).gpan(this);

        emitter = this.collection.add("ParticleEmitter", {
            x: this.shared.x,
            y: this.shared.y,
            zIndex: 0,
            duration: 0.3,
            direction: direction,
            speed: 200,
            interval: 0.03
        });

        emitter.onspawn = function() {

            var sprite = this.collection.add("Sprite");

            sprite.setDuration(0, 0.3, 0);

            sprite.zIndex = 1;

            var mod = 1 - this.lifetime / this.duration;

            sprite.color = "#fff";
            sprite.x = this.x;
            sprite.y = this.y;
            sprite.blendMode = "add";
            sprite.scale = Utils.randomf(0.8, 1.6);
            sprite.offsetY = Math.sin(app.lifetime * 16) * 4;
            sprite.row = Utils.dirrow(this.direction - Math.PI, 24);

            sprite.set("hit_wave", false);

            app.tween(sprite).to({
                alpha: 0
            }, sprite.loopDuration);

        }
        ;

    },

    specialFlags: {

        1: [43, 0, 9, 9],
        2: [53, 0, 9, 9],
        4: [63, 0, 9, 9],
        8: [33, 0, 9, 9]

    },

    patreonSprite: [154, 110, 9, 9],
    verifiedSprite: [164, 110, 9, 9],

    tooltip: function(text) {

        this.text = text;
        this.textTimeout = 4;

    },

    onbuff: function(data) {

        data = data || {};

        if (this.aura)
            this.onbuffend();

        this.aura = this.collection.add("Sprite");
        this.aura.color = data.color || "#fc0";
        this.aura.blendMode = "hard-light";
        this.aura.zIndex = this.zIndex + 1;
        this.aura.set("aura", true);
        this.aura.follow = this;

        this.aura.scaleY = data.scaleY || 1.0;

        this.aura.alpha = 0.0;
        app.tween(this.aura).to({
            alpha: 1.0
        }, 0.25);

    },

    onbuffend: function() {

        if (this.aura) {

            app.tween(this.aura).to({
                alpha: 0
            }, 1.0).once("finish", function() {

                this.context.cease();

            });

        }

    },

    ack: function(key) {

        if (this.temp.lastAck === key && (app.game.lifetime - this.temp.lastAckTimestamp < 5))
            return;
        if (app.game.lifetime - this.temp.lastAckTimestamp < 3)
            return;

        this.temp.lastAckTimestamp = app.game.lifetime;
        this.temp.lastAck = key;

        let voice = COMMON.armory[this.shared.voice];

        app.sound.play("acks/" + this.shared.voice + "/" + key).rate(voice.rate + Math.random() * voice.rateRange).gpan(this);

        this.tooltip(key);

    },

    get score() {

        return this.shared.score;

    },

    set score(score) {
    },

    respawn: function() {

        app.tween(this).discard();

        this.scaleX = 1.0;
        this.scaleY = 1.0;

        if (this.shared.key !== "companion")
            this.appear();

        this.helmetDetached = false;
        this.weaponDetached = false;
        this.shieldDetached = false;

        if (this.player) {

            app.goldBefore = app.user.gold;
            app.eventGameplayStart();

        }

    }

};

/* file: script/entities/Citizen.states.js */

(function() {

    var states = CLIENT.Citizen;

    function spawnSlash(citizen, animation, duration=0.5) {

        let slash = citizen.collection.add("Sprite");

        slash.follow = citizen;

        slash.followOffsetX = Math.cos(citizen.direction) * citizen.weaponData.meleeRange * 0.5;
        slash.followOffsetY = Math.sin(citizen.direction) * citizen.weaponData.meleeRange * 0.5;
        slash.followOffsetZ = 20;

        slash.set(animation);
        slash.setDuration(duration * 1.0);

        slash.color = citizen.weaponData.slashColor;
        slash.blendMode = "overlay";
        slash.alpha = 0.6;
        slash.direction = Utils.groundAngle(citizen.direction + COMMON.slashRotation[animation], 16);
        slash.delay = duration * 0.5;

        return slash;

    }

    states.idle = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_MOVE | COMMON.CAN_ROLL,

        enter: function(citizen, manager) {

            if (citizen.player)
                app.eventGameplayStart();

            citizen.hidden = false;
            citizen.dead = false;

            manager.data.moving = -1;

            citizen.sprites.assign("lifetime", citizen.legs.lifetime);

            citizen.scaleX = 1.0;
            citizen.scaleY = 1.0;

        },

        leave(citizen) {

            citizen.torsoDelay = 0;

        },

        step: function(citizen, manager) {

            let key = 0;

            if (manager.data.moving !== citizen.shared.moving || manager.data.growling !== citizen.shared.growling) {

                let sprite = citizen.shared.growling ? "growl" : (citizen.shield ? "run" : "run_no_shield");

                let duration = 150 / citizen.data.speed;

                if (citizen.shared.moving) {

                    citizen.setSprite(sprite, true, true, duration, true);
                    citizen.sprites.assign("lifetime", citizen.legs.lifetime);

                }

                if (!citizen.shared.moving) {

                    citizen.setSprite(sprite, true, true, duration * 2.5, true);

                }

                manager.data.moving = citizen.shared.moving
                manager.data.growling = citizen.shared.growling

            }

            if (citizen.shared.growling && citizen.shared.moving) {

                if (citizen.player && app.game.canDoodle() && citizen.shared.moving && Utils.interval(citizen, "dust", 0.1)) {

                    var dust = citizen.collection.add("Sprite");

                    dust.set("fx/smoke_puff");

                    dust.doodle = true;
                    dust.x = citizen.x + Utils.random(-3, 3);
                    dust.y = citizen.y + Utils.random(-3, 3);
                    dust.scale = Utils.randomf(0.1, 0.2);
                    dust.zIndex = 1;

                    app.tween(dust).to({
                        z: 16
                    }, dust.duration, "outQuad");
                    // dust.rotation = Math.random() * 6.28;

                }

            }

            if (citizen.direction !== citizen.desiredDirection)
                citizen.torsoDelay = 0.2;

        }

    };

    states.charge = {

        enter: function(citizen, manager) {

            citizen.charged = 0;

            // citizen.setSprite("run", true, true, 1.0);
            citizen.setSprite("charge_meele", true, false, 0.2);

        },

        step: function(citizen, manager, dt) {

            if (citizen.weaponData.subtype === "bow" && manager.runOnce("bow_pull", 0.25)) {

                citizen.setSprite("charge_bow", true, false, 0.25);

                if (citizen.inView)
                    manager.data.soundLoop = app.sound.play("weapons/bow_pull_short").gpan(citizen).rate(1.2).fadeIn(0.2).rrate(0.1);

            }

            let chargeTime = citizen.weaponData.chargeTime || 1.0;

            if (citizen.charged < 1.0 && (citizen.charged += dt / chargeTime) >= 1.0) {

                if (citizen.weaponData.subtype === "bow") {
                // citizen.setSprite("charge_bow", true, false, 0.4);
                // app.sound.play("weapons/bow_pull").gpan(citizen).rate(1.0).rrate(0.1).fadeOut(0.5);

                } else {

                    citizen.setSprite("charge_meele", true, false, 0.2);

                    if (citizen.inView)
                        app.sound.play(citizen.kind + "/woh").gpan(citizen).rate(citizen.data.pitch).rrate(0.1);

                }

            }

        },

        blinkWhen: ["spin", "launchArrow", "launchBolts"],

        leave: function(citizen, manager) {

            if (manager.data.soundLoop) {
                manager.data.soundLoop.stop();
                manager.data.soundLoop = false;
            }

            if (citizen.player && this.blinkWhen.includes(manager.nextKey)) {

                let circle = citizen.collection.add("Circle");

                circle.scaleY = 0.6;
                circle.radius = 12;
                circle.lifespan = 0.5;
                circle.color = 0xffffaa;
                circle.zIndex = 2.0;
                circle.follow = citizen;

                app.tween(circle).to({
                    radius: 20
                }, circle.lifespan, "outQuad");
                app.tween(circle).to({
                    alpha: 0.0
                }, circle.lifespan, "inQuad");

            }

            citizen.charged = 0;

        }

    };

    states.growl = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_MOVE | COMMON.CAN_ROLL,

        enter: function(citizen, manager) {

            citizen.setSprite("growl", true, true, [0.1, 0.7, 0.1]);
            citizen.legs.setDuration(0, 0.7, 0);

        },

        leave: function(citizen, manager) {

            citizen.legs.setDuration(0, 1.0, 0);

            // citizen.sprite.cancel();

        },

        step: function(citizen, manager) {
            /*
                  if (citizen.kind === "fox") {

                    if (citizen.shared.moving && citizen.sprite.key !== "animal_run") {

                      citizen.setSprite("animal_run", false, true, [0.1, 0.4, 0.1]);

                    }

                    if (!citizen.shared.moving && citizen.sprite.key === "animal_run") {

                      citizen.setSprite("growl", true, true, [0.1, 0.7, 0.1]);

                    }

                  }
            */

            if (!PLAYGROUND.MOBILE && citizen.shared.moving && Utils.interval(citizen, "dust", 0.1)) {

                var dust = citizen.collection.add("Sprite");

                dust.set("dust");

                dust.x = citizen.x;
                dust.y = citizen.y - Utils.random(0, 6);
                dust.scale = Utils.randomf(0.4, 0.6);
                dust.zIndex = 1;

            }
            // dust.setDuration(0.5);

        }

    };

    states.cast = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_MOVE,

        enter: function(citizen, manager) {

            if (citizen.inView) {

                app.sound.play("weapons/spell").rrate(0.2).gpan(citizen);
                app.sound.play("axe/swing").rate(0.25).rrate(0.2).gpan(citizen);

                /*
                        var blast = citizen.collection.add("Sprite");
                        blast.setDuration(0.2);
                        blast.set("fx/lighting");
                        blast.follow = citizen;
                        blast.blendMode = "hard-light";
                        // blast.alpha = 1.0;
                        blast.zIndex = 2;
                */

            }

            citizen.setSprite("attack_vertical", true, false, 0.5);
            // citizen.setSprite("cast", true, false, 0.5);

        }

    };

    states.jump = {

        enter: function(citizen, manager) {

            if (citizen.inView) {

                app.sound.play(citizen.kind + "/effort").rate(citizen.data.pitch).rrate(0.1).gpan(citizen);

            }

            app.tween(citizen).to({
                z: 25
            }, 0.5).to({
                z: 0
            }, 0.5);

            citizen.setSprite("roll", false, false, 1.0);

        },

        leave: function(citizen, manager) {
        },

        step: function(citizen, manager) {

            if (manager.runOnce("puff", 0.8)) {
            // citizen.poke(1.0);

            }

        }

    };

    states.jumpAttack = {

        enter: function(citizen, manager) {

            if (citizen.inView) {

                app.sound.play(citizen.kind + "/effort").rate(citizen.data.pitch).rrate(0.1).gpan(citizen);

                app.tween(citizen).discard().to({
                    z: 0
                }, 0.2, "inQuad");
                /*
                                app.tween(citizen).discard().to({
                                    z: 20
                                }, 0.1).to({
                                    z: 0
                                }, 0.1, "inQuad");
                */
                let slash = spawnSlash(citizen, "fx/slash_vertical", 0.5);
                slash.delay = 0;
                app.sound.play("martial/tear_air").rate(1.0).rrate(0.1).gpan(citizen);

            }

            citizen.setSprite("jump_attack", false, false, [0.2, 0.6, 0.2]);

        },

        step(citizen, manager) {

            if (citizen.inView && manager.runOnce("blast", 0.2)) {

                var blast = citizen.collection.add("Blast");

                app.sound.play("impact/ground_heavy").gpan(citizen);

                blast.x = citizen.x + Math.cos(citizen.direction) * 60;
                blast.y = citizen.y + Math.sin(citizen.direction) * 60;
                blast.radius = 50;
                blast.type = "default";
                blast.duration = 0.3;

            }

        }

    };

    states.swirl = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_MOVE,

        enter: function(citizen, manager) {

            citizen.setSprite("spin", true, true, 0.375);

        },

        step: function(citizen, manager, dt) {

            if (citizen.inView) {

                if (Utils.interval(citizen, "swing_sound", 0.375)) {

                    app.sound.play("axe/swing").rate(0.6).gpan(citizen);
                }

            }

        }

    };

    states.powerHit = {

        enter: function(citizen, manager) {

            if (citizen.inView) {

                app.sound.play(citizen.kind + "/woh").rate(citizen.data.pitch).gpan(citizen);

                app.tween(citizen).to({
                    z: 10
                }, 0.2).to({
                    z: 0
                }, 0.1);

                citizen.setSprite("attack_vertical", true, false, 0.6);

                app.sound.play("impact/ground_heavy").delay(0.35).gpan(citizen);

            }

        },

        step: function(citizen, manager) {

            if (citizen.inView && manager.runOnce("blast", 0.3)) {

                var blast = citizen.collection.add("Blast");

                blast.x = citizen.x + Math.cos(citizen.direction) * 60;
                blast.y = citizen.y + Math.sin(citizen.direction) * 60;
                blast.radius = 50;
                blast.type = "default";
                blast.duration = 0.3;

                citizen.game.camera.shake(4, 0.2);

            }

        }

    };

    states.poleVault = {

        enter: function(citizen, manager) {

            if (citizen.inView) {

                app.sound.play(citizen.kind + "/woh").rate(citizen.data.pitch).gpan(citizen);

                citizen.setSprite("spear_jump", false, false, 1.0);
                citizen.z = 1;

            }

        },

        leave: function(citizen) {

            citizen.z = 0;

        },

        step: function(citizen, manager) {

            if (citizen.inView && manager.runOnce("blast", 0)) {

                var blast = citizen.collection.add("Blast");

                blast.x = citizen.x;
                blast.y = citizen.y;
                blast.radius = 50;
                blast.type = "default";
                blast.duration = 0.3;

            }

        }

    };

    states.tear = {

        enter: function(citizen, manager) {

            if (citizen.inView) {

                app.sound.play("spells/tear").volume(0.8).rate(1.0).gpan(citizen);

                let duration = 0.75;

                citizen.setSprite("tear", false, false, duration);

                app.sound.play("martial/dash").rrate(0.1).gpan(citizen);

                for (var i = 0; i < 2; i++) {

                    let slashAnimation = i > 0 ? "fx/slash_claws2" : "fx/slash_claws";

                    let slash = citizen.collection.add("Sprite");

                    slash.follow = citizen;

                    slash.followOffsetX = Math.cos(citizen.direction) * citizen.weaponData.meleeRange * 0.5;
                    slash.followOffsetY = Math.sin(citizen.direction) * citizen.weaponData.meleeRange * 0.5;
                    slash.followOffsetZ = 20;

                    slash.set(slashAnimation);
                    slash.setDuration(duration * 1.0);

                    slash.color = citizen.weaponData.slashColor;
                    slash.blendMode = "overlay";
                    slash.alpha = 0.6;
                    slash.rotation = citizen.direction + COMMON.slashRotation[slashAnimation];

                    citizen.sprites.assign("lifetime", duration * 0.25);

                }

            }

        },

        step: function(citizen, manager) {

            if (citizen.inView && Utils.interval(citizen, "tearwave", 0.1)) {

                var sprite = citizen.collection.add("Sprite");

                sprite.setDuration(0, 0.3, 0);

                sprite.zIndex = 1;

                sprite.color = "#fff";
                sprite.x = citizen.x;
                sprite.y = citizen.y;
                sprite.scale = Utils.randomf(0.8, 1.6);
                sprite.offsetY = Math.sin(app.lifetime * 16) * 4;
                sprite.row = Utils.dirrow(citizen.direction - Math.PI, 24);

                sprite.set("hit_wave", false);

                app.tween(sprite).to({
                    alpha: 0
                }, sprite.loopDuration);

            }

        },

        leave: function(citizen) {
        }

    };

    states.fury = {

        can: 0,

        enter: function(citizen, manager, extra) {

            citizen.dash(citizen.direction);

        },

        step(citizen, manager) {

            if (citizen.inView && Utils.interval(citizen, "fury", 0.2)) {

                var duration = 0.2;
                var soundRate = citizen.weaponData.soundRate || 1.0;
                var sound = citizen.weaponData.sound;

                var animationIndex = Utils.random() * citizen.weaponData.attackAnimations.length | 0;
                var attackAnimation = citizen.weaponData.attackAnimations[animationIndex];
                var slashAnimation = citizen.weaponData.meleeSlash[animationIndex];

                citizen.setSprite(attackAnimation, true, false, duration);
                citizen.sprites.assign("lifetime", 0)

                app.sound.play("martial/wave").rate((0.5 + (0.4 / (duration + 0.4)))).rrate(0.1).gpan(citizen);
                if (sound)
                    app.sound.play(sound).rate((0.5 + (0.4 / (duration + 0.4))) * soundRate).rrate(0.1).gpan(citizen);
                app.sound.play(citizen.kind + "/woh").rate(citizen.data.pitch).rrate(0.2).gpan(citizen);

                let slash = citizen.collection.add("Sprite");

                slash.follow = citizen;

                slash.followOffsetX = Math.cos(citizen.direction) * citizen.weaponData.meleeRange * 0.5;
                slash.followOffsetY = Math.sin(citizen.direction) * citizen.weaponData.meleeRange * 0.5;
                slash.followOffsetZ = 20;

                slash.set(slashAnimation);
                slash.setDuration(duration * 1.0);
                slash.color = citizen.weaponData.slashColor;
                slash.blendMode = "overlay";
                slash.alpha = 0.6;
                slash.rotation = Utils.groundAngle(citizen.direction + COMMON.slashRotation[slashAnimation]);
                slash.delay = duration * 0.5;

            }
        }

    };

    states.attack = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_MOVE,

        enter: function(citizen, manager, extra) {

            if (citizen.inView) {

                citizen.poke(0.4);

                var duration = citizen.weaponData.attackDuration * citizen.data.attackDuration;
                var soundRate = citizen.weaponData.soundRate || 1.0;
                var sound = citizen.weaponData.sound;

                if (extra && extra.duration)
                    duration = extra.duration;

                var animationIndex = Utils.random() * citizen.weaponData.attackAnimations.length | 0;
                var attackAnimation = citizen.weaponData.attackAnimations[animationIndex];
                var slashAnimation = citizen.weaponData.meleeSlash[animationIndex];

                citizen.setSprite(attackAnimation, true, false, duration);
                citizen.sprites.assign("lifetime", 0)

                app.sound.play("martial/wave").rate((0.5 + (0.4 / (duration + 0.4)))).rrate(0.1).gpan(citizen);
                if (sound)
                    app.sound.play(sound).rate((0.5 + (0.4 / (duration + 0.4))) * soundRate).rrate(0.1).gpan(citizen);

                // if (attack === "attack_vertical") app.sound.play("martial/hit").delay(0.1).rate(0.6).rrate(0.2).gpan(citizen);

                let slash = spawnSlash(citizen, slashAnimation, duration);

            }

        }
        // citizen.sprite.lifetime = citizen.sprite.duration * 0.5;

    };

    states.stun = {

        can: COMMON.CAN_MOVE,

        enter: function(citizen, manager, extra) {

            if (citizen.inView) {

                citizen.setSprite("attack_vertical", true, false, 0.5)

                citizen.dash(citizen.shared.direction);

                app.sound.play(citizen.kind + "/woh").rate(citizen.data.pitch).gpan(citizen);

            }

        }
        // citizen.sprite.lifetime = citizen.sprite.duration * 0.5;

    };

    states.lunge = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_MOVE,

        enter: function(citizen, manager, extra) {

            if (citizen.inView) {

                citizen.setSprite("spear_attack", true, false, 0.75)

                citizen.dash(citizen.shared.direction);

            }

        }
        // citizen.sprite.lifetime = citizen.sprite.duration * 0.5;

    };

    states.spin = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_MOVE,

        enter: function(citizen, manager, extra) {

            if (citizen.inView) {

                app.tween(citizen).to({
                    z: Math.random() > 0.5 ? -8 : +8
                }, 0.3).to({
                    z: 0
                }, 0.2);

                app.sound.play(citizen.kind + "/heavy_effort").rate(citizen.data.pitch).rrate(0.1).gpan(citizen);

                citizen.setSprite("spin", true, false, [0.0, 0.4, 0.1]);
                let duration = 0.5;
                var soundRate = citizen.weaponData.soundRate || 1.0;
                var sound = citizen.weaponData.sound;

                app.sound.play("martial/wave").rate((0.5 + (0.4 / (duration + 0.4)))).rrate(0.1).gpan(citizen);

                if (sound) {
                    let rateSound = (0.5 + (0.4 / (duration + 0.4))) * soundRate;
                    app.sound.play(sound).rate(rateSound).rrate(0.1).gpan(citizen);
                    app.sound.play(sound).rate(rateSound * 0.8).rrate(0.1).gpan(citizen);

                }

                let angleStep = Math.PI * 2 / 5;

                for (var i = 0; i < 5; i++) {

                    let direction = citizen.direction - angleStep * i;

                    let slashAnimation = "fx/slash_horizontal";

                    let slash = citizen.collection.add("Sprite");

                    slash.follow = citizen;

                    slash.followOffsetX = Math.cos(direction) * citizen.weaponData.meleeRange * 0.5;
                    slash.followOffsetY = Math.sin(direction) * citizen.weaponData.meleeRange * 0.5;
                    slash.followOffsetZ = 20;
                    slash.delay = i * 0.1;
                    slash.doodle = true;

                    slash.set(slashAnimation);
                    slash.setDuration(0.25 * 1.0);
                    slash.color = citizen.weaponData.slashColor;
                    slash.blendMode = "overlay";
                    slash.alpha = 0.6;
                    slash.rotation = direction + COMMON.slashRotation[slashAnimation];

                }

            }

        }
        // citizen.sprite.lifetime = citizen.sprite.duration * 0.5;

    };

    states.launchArrow = {

        can: COMMON.CAN_MOVE,

        enter: function(citizen, manager, extra) {

            if (citizen.inView) {

                app.sound.play("weapons/bow").rate(1.2).rrate(0.2).gpan(citizen);

                citizen.setSprite("attack_bow", true, false, 0.3);

            }

        }

    };

    states.launchBeam = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_ROTATE,

        enter: function(citizen, manager, extra) {

            if (citizen.inView) {

                citizen.setSprite("charge_spell", true, false, 0.3);

            }

        }

    };

    states.launchBolts = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_ROTATE,

        enter: function(citizen, manager, extra) {

            if (citizen.inView) {

                citizen.setSprite("charge_spell", true, false, 0.3);

            }

        }

    };

    states.punch = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_MOVE,

        enter: function(citizen, manager, extra) {

            manager.data.lastPunch = !Boolean(manager.data.lastPunch);

            if (citizen.inView) {

                app.sound.play(citizen.kind + "/heavy_effort").rate(citizen.data.pitch).rrate(0.1).gpan(citizen);

                citizen.setSprite(manager.data.lastPunch ? "punch1" : "punch2", true, false, 0.35);

                app.sound.play("martial/punch").rrate(0.15).gpan(citizen);

                let slash = citizen.collection.add("Sprite");

                slash.follow = citizen;

                // slash.followOffsetX = Math.cos(citizen.direction) * citizen.weaponData.meleeRange * 0.5;
                // slash.followOffsetY = Math.sin(citizen.direction) * citizen.weaponData.meleeRange * 0.5;
                slash.followOffsetZ = 20;

                slash.set(manager.data.lastPunch ? "fx/slash_punch" : "fx/slash_punch2");
                slash.setDuration(0.35);
                slash.rotation = citizen.direction;
                slash.doodle = true;
                slash.color = "#d9a066";
                slash.blendMode = "overlay";
                slash.alpha = 0.6;
            }

        }

    };

    states.kick = {

        can: 0,

        enter: function(citizen, manager) {

            if (citizen.inView)
                app.sound.play("martial/kick").rrate(0.2).gpan(citizen);

            citizen.setSprite("kick", false, true, 0.7);

            app.tween(citizen).to({
                z: 5
            }, 0.7 * 0.3).to({
                z: 0
            }, 0.7 * 0.5);

            let slash = citizen.collection.add("Sprite");

            slash.follow = citizen;

            slash.followOffsetZ = 20;

            slash.set("fx/slash_vertical");
            slash.setDuration(0.4);
            slash.rotation = citizen.direction;
            slash.color = "#c1defb";
            slash.blendMode = "overlay";
            slash.alpha = 0.6;
        }

    };

    states.throwWeapon = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_MOVE,

        enter: function(citizen, manager, extra) {

            let weaponData = COMMON.armory[extra.weapon];

            if (!weaponData)
                return;

            if (weaponData.throwAnimation) {

                citizen.setSprite(weaponData.throwAnimation.sprite, true, false, weaponData.throwAnimation.duration);

                if (citizen.inView && weaponData.throwAnimation.sound)
                    app.sound.play(weaponData.throwAnimation.sound).gpan(citizen);

            } else {

                citizen.setSprite("spin", true, false, 0.5);
            }

            if (citizen.inView)
                app.sound.play("human/effort").rate(citizen.data.pitch).rrate(0.2).gpan(citizen);

        }

    };

    states.throw = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_MOVE,

        enter: function(citizen, manager) {

            if (citizen.inView) {

                app.sound.play("weapons/missile").rate(1).rrate(0.2).gpan(citizen);
                app.sound.play(citizen.kind + "/effort").rate(citizen.data.pitch).rrate(0.1).gpan(citizen);

            }

            citizen.setSprite("throw", true, false, [0.1, 0, 0.65]);

        }

    };

    states.throwKnife = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_MOVE,

        enter: function(citizen, manager) {

            if (citizen.inView)
                app.sound.play("weapons/missile").rate(1).rrate(0.2).gpan(citizen);

            citizen.setSprite("throw", true, false, [0.1, 0, 0.65]);

        }

    };

    states.block = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_MOVE,

        enter: function(citizen, manager) {

            if (citizen.inView)
                app.sound.play(citizen.kind + "/effort").rate(citizen.data.pitch).rrate(0.2).gpan(citizen);

            var d = 1.0;

            citizen.setSprite(citizen.shield ? "block" : "block_without_shield", true, false, [d * 0.2, d * 0.6, d * 0.2]);

        }

    };

    states.blocked = {

        enter: function(citizen, manager) {

            citizen.setSprite("stunned", true, false, 1.0);

            if (citizen.inView) {

                // app.sound.play("stun").gpan(citizen).volume(0.5);

                var sprite = citizen.collection.add("Sprite");

                sprite.set("fx/dizzy", false);
                sprite.zIndex = 3;
                sprite.loopDuration = 1.0;
                sprite.lifespan = 2.0;
                sprite.follow = citizen;
                sprite.followOffsetZ = 30;
            }

        }

    };

    states.focus = {

        can: 0,

        enter: function(citizen, manager) {

            if (citizen.inView) {
                app.sound.play("human/focus").rate(0.5).rateTo(citizen.data.pitch, 1.0).gpan(citizen);

                citizen.setSprite("focus", false, true, 0.5);

                var sprite = citizen.collection.add("Sprite");

                sprite.set("fx/focus", false);
                sprite.zIndex = 3;
                sprite.color = "#fc5"
                sprite.setDuration(1.0)
                sprite.follow = citizen;
                sprite.followOffsetY = -24;
                sprite.scale = 0.5;

            }
        }

    };

    states.sit = {

        enter: function(citizen, manager) {

            citizen.setSprite("sit", false, true, [0.5, 1.0, 0.0]);

        }

    };

    states.yuppie = {

        enter: function(citizen, manager) {

            if (citizen.inView) {

                app.sound.play("human/yuppie").rate(citizen.data.pitch).gpan(citizen);

            }

            app.tween(citizen).to({
                z: 70
            }, 0.2).to({
                z: 0
            }, 0.8, "outBounce");

            citizen.setSprite("roll", false, true, 0.25);

        },

        leave: function(citizen, manager) {
        },

        step: function(citizen, manager) {

            if (manager.runOnce("puff", 0.8)) {
            // citizen.poke(1.0);

            }

        }

    };

    states.operate = {

        enter: function(citizen, manager) {

            citizen.setSprite("operate", true, true, [0.5, 1.0, 0.0]);

        }

    };

    states.receiveDamage = {

        can: COMMON.CAN_ROTATE | COMMON.CAN_MOVE,

        enter: function(citizen, manager) {

            citizen.setSprite("stunned", true, false, 0.3);

        }

    };

    states.roll = {

        can: 0,

        leave: function(citizen, manager) {

            citizen.z = 0;

        },

        enter: function(citizen, manager) {

            citizen.z = 1;

            if (citizen.inView) {

                app.sound.play("martial/rolla").rrate(0.2).gpan(citizen);
                app.sound.play("martial/roll").rate(1).volume(0.7).gpan(citizen);

            }

            citizen.setSprite("roll", false, true, 0.8);

        },

        step: function(citizen, manager) {

            if (manager.runOnce("puff", 1.0)) {

                citizen.poke(0.5);

            }

            if (manager.runOnce("land", 1.2))
                citizen.z = 0;

        }

    };

    states.fallFront = {

        enter: function(citizen, manager) {

            let duration = citizen.data.fall_recovery;

            if (citizen.inView) {

                app.sound.play("martial/fall").rrate(0.2).gpan(citizen);
                app.sound.play(citizen.kind + "/pain3").rate(citizen.data.pitch).rrate(0.1).gpan(citizen);

            }

            citizen.setSprite("fall_front", false, false, duration);

            citizen.airLaunch(duration * 0.4);

        },

        leave: function(citizen) {
        }

    };

    states.lieDown = {

        enter(citizen, manager) {

            let animation = Math.random() > 0.5 ? "fall_front" : "fall_back";

            citizen.setSprite(animation, false, true, [0.5, 0.5, 1.0]);

        }

    };

    states.getUp = {

        enter(citizen, manager) {

            citizen.sprites.cancel();

            app.sound.play("shadow/getup" + Utils.random(1, 3)).delay(Math.random).gpan(citizen);

        }

    };

    states.pickedUp = {

        enter: function(citizen, manager) {

            citizen.setSprite("fall_back", false, false, 1.0);
            citizen.sprites.assign("lifetime", 0.5);
            citizen.sprites.pause();

            app.tween(citizen).to({
                z: 100
            }, 0.9, "inQuad");
            citizen.zIndex = 3;

        },

        leave(citizen) {

            citizen.sprites.unpause();

            citizen.zIndex = 2;

        }

    };

    states.beingThrown = {

        enter: function(citizen, manager) {

            if (citizen.inView) {

                // citizen.setSprite("fall_back", false, false, 1.0);
                citizen.setSprite("roll", false, true, 1.2);
                citizen.sprites.assign("lifetime", 0.5);
                // citizen.sprites.pause();

                app.tween(citizen).to({
                    z: citizen.z * 1.25
                }, 0.4).to({
                    z: 0
                }, 1.0, "outBounce");
                citizen.zIndex = 3;

                app.sound.play(citizen.kind + "/growl").loop().rate(1.2 * citizen.data.pitch).fadeOut(1.5).gpan(citizen);

            } else {

                citizen.z = 0;

            }

        },

        leave(citizen) {

            citizen.sprites.unpause();

            citizen.zIndex = 2;

        }

    };

    states.fallBack = {

        enter: function(citizen, manager) {

            let duration = citizen.data.fall_recovery;

            if (citizen.inView) {

                app.sound.play(citizen.kind + "/pain3").rate(citizen.data.pitch).rrate(0.1).gpan(citizen);
                app.sound.play("martial/fall").rrate(0.2).gpan(citizen);

            }

            citizen.setSprite("fall_back", false, false, duration);

            citizen.airLaunch(duration * 0.4);

            /*
                  app.tween(citizen).to({
                    z: 20
                  }, 0.5).to({
                    z: 0
                  }, 1.0, "outBounce");
            */

        },

        leave: function(citizen) {
        }

    };

    states.fallDeep = {

        enter: function(citizen, manager) {

            if (citizen.inView) {

                app.sound.play("martial/fall").rate(0.25).gpan(citizen);
                app.sound.play("human/scream").rate(0.8 * citizen.data.pitch).rrate(0.1).gpan(citizen).fadeOut(1.0);

                citizen.zIndex = 3;

                citizen.setSprite(Math.random() > 0.5 ? "fall_front" : "fall_back", false, true, [1.0, 1.0, 1.0]);

                app.tween(citizen).discard().to({
                    z: -10
                }, 1.5);

            }

            // citizen.temp.tweenspeed = 20;
        },

        leave: function(citizen) {

            app.tween(citizen).discard();

            if (citizen.inView) {

                var sprite = citizen.collection.add("Sprite");

                sprite.color = "#fff";
                sprite.set("collect", false);
                sprite.zIndex = 3;
                sprite.loopDuration = 0.5;
                sprite.scale = 1.0;
                sprite.x = citizen.x;
                sprite.y = citizen.y - citizen.z;

                app.sound.play("human/splat").rate(1.0).rrate(0.1).gpan(citizen).volume(2.0);

            }

            citizen.z = 0;

        },

        step: function(citizen, manager) {

            citizen.scaleX = citizen.scaleY = Math.max(0, 1.0 - (manager.elapsed / 1.5));

        }

    };

    states.dead = {

        enter: function(citizen, manager) {

            if (citizen.player)
                app.eventGameplayStop();

            if (citizen.player && citizen.lastAttacker) {

                citizen.revenges[citizen.lastAttacker.shared.name] = true;

            }

            if (citizen.player) {

                if (citizen.game.mode === "soccer") {

                    citizen.game.camera.setFollow(citizen.game.ball);

                }

            }

            citizen.dead = true;

            if (!manager.data.dyingAnimation)
                manager.data.dyingAnimation = Utils.random(["fall_back", "fall_front"]);

            citizen.setSprite(manager.data.dyingAnimation, false, true, [1.0, 1.0, 1.0]);
            citizen.sprites.skip();
            // citizen.sprite.pause();

            citizen.zIndex = 1;

            // && app.lobby.Play.patreonState !== "patron"
            if (citizen.player) {

                app.game.announcer.die();

            }

            if (app.game.isMate(citizen)) {

                app.console.say("Your mate " + citizen.shared.name + " has been killed.", "friend");

            }

        },

        leave: function(citizen) {

            citizen.place = 0;
            citizen.dead = false;
            citizen.helmetDetached = false;
            citizen.weaponDetached = false;
            citizen.shieldDetached = false;
            citizen.scaleX = 1.0;
            citizen.scaleY = 1.0;
            citizen.zIndex = 2;
            citizen.temp.fallen = false;

            citizen.scaleX = 1.0;
            citizen.scaleY = 1.0;

            citizen.z = 0;

            if (citizen.player) {

                citizen.game.hideRespawn();

                if (app.game.player)
                    citizen.game.camera.setFollow(app.game.player);

            }

            citizen.respawn();

        }

    };

    states.dying = {

        enter: function(citizen, manager) {

            if (citizen.player)
                app.eventGameplayStop();

            citizen.dead = true;

            if (citizen.inView) {

                app.sound.play(citizen.kind + "/death").rate(citizen.data.pitch).rrate(0.2).gpan(citizen);

                var obj = {
                    x: citizen.x,
                    y: citizen.y - citizen.z
                };

                if (citizen.kind === "shadow")
                    obj.color = "#000";

            }

            manager.data.dyingAnimation = Utils.random(["fall_back", "fall_front"]);

            citizen.setSprite(manager.data.dyingAnimation, false, true, [1.5, 0, 0]);

            citizen.airLaunch(0.5);

            citizen.die();

        },

        leave: function() {
        },

        step: function(citizen, manager) {

            if (manager.elapsed < 0.6 && Utils.interval(citizen, "blood", 0.05)) {
                let duration = Utils.randomf(0.6, 1.0);
                let blood = citizen.collection.add("Sprite");

                blood.set("fx/leaves", false);
                blood.setDuration(duration);
                blood.x = citizen.x + Utils.random(-10, 10);
                blood.y = citizen.y + Utils.random(-10, 10);
                blood.z = Utils.random(10, 20);
                blood.scale = 0.75;
                blood.color = "#cc0000";
                blood.rotation = Math.random() * 6;
                app.tween(blood).to({
                    x: blood.x + Utils.random(-20, 20),
                    y: blood.y + Utils.random(-20, 20)
                }, duration);
                // app.tween(blood).to({ z: blood.z + Utils.random(20, 50) }, duration * 0.5, "outQuad").to({ z: 0 }, duration * 0.5, "inQuad");

            }

        }

    };

}
)();

/* file: script/entities/Sandworm.js */

CLIENT.Sandworm = function(args) {

    this.x = 0;
    this.y = 0;
    this.z = 0;

    this.lifetime = 0;
    this.updated = 0;
    this.shown = 0;

    Object.assign(this, args);

    this.sprite = new CLIENT.Sprite;

    this.state = new CLIENT.StateManager(this,CLIENT.Sandworm);
    this.state.set("idle");

    this.tween = new CLIENT.Tween(this);

    this.update(this.shared);

    this.game.preloadSprite("sandworm/attack");

}
;

CLIENT.Sandworm.prototype = {

    constructor: CLIENT.Sandworm,

    shape: CLIENT.CIRCLE,

    radius: 160,

    zIndex: 2,

    renderStains() {

        let aspectX = this.game.stainsBuffer.width / (this.game.innerWidth * 2);
        let aspectY = this.game.stainsBuffer.height / (this.game.innerHeight * 2);

        let x = (this.x + Utils.random(-8, 8) + this.game.innerWidth) * aspectX;
        let y = (this.y + Utils.random(-8, 8) + this.game.innerHeight) * aspectY;

        var image = app.textures.blasts.sunken;

        app.painter.reset();
        app.painter.alpha(1.0);
        app.painter.scale(0.1, 0.1);
        app.painter.rotate(Math.random() * 7);

        app.painter.drawImage(image, x, y);

    },

    step: function(dt) {

        this.lifetime += dt;

        this.tween.step(dt);
        this.state.step(dt);
        this.sprite.step(dt);

        if (false && this.shown > 0) {

            this.shown -= dt;

        } else if (false && this.inView && Utils.interval(this, "blast", 0.1)) {

            var blast = this.collection.add("Blast");

            blast.x = this.x + Utils.random(-4, 4);
            blast.y = this.y + Utils.random(-4, 4);
            blast.radius = 30 + Utils.random(0, 5);
            blast.type = "sunken";
            blast.duration = 1.5;
            blast.reverse = true;

        }

    },

    render: function(layer) {

        // app.layer.fillStyle("#000").fillCircle(this.x, this.y, 10);

        this.sprite.render(layer, this.x, this.y);

    },

    update: function(data) {

        Object.assign(this.shared, data);

        if (!this.updated) {

            this.x = data.x;
            this.y = data.y;

        }

        if (data.x !== undefined || data.y !== undefined) {

            this.tween.to("x", this.shared.x, COMMON.TWEEN_DURATION);
            this.tween.to("y", this.shared.y, COMMON.TWEEN_DURATION);

            this.direction = Utils.lookAt(this.x, this.y, this.shared.x, this.shared.y);

        }

        if (data.stateQueue) {

            for (var i = 0; i < data.stateQueue.length; i++) {

                var key = this.game.sharer.getKey(data.stateQueue[i]);

                this.state.set(key);

            }

        }

        if (data.remove)
            this.collection.remove(this);

        this.updated++;

    }

};

/* file: script/entities/Sandworm.states.js */

CLIENT.Sandworm.idle = {

    enter: function(sandworm) {

        sandworm.sprite.hide();

    },

    step: function(sandworm) {

        if (sandworm.inView && Utils.interval(sandworm, "show", 4)) {

            sandworm.shown = 1.5;

            app.sound.play("monster/sandworm_move").rate(0.3).rrate(0.1).volume(0.15).gpan(sandworm);
            app.sound.play("monster/sandworm_growl").rate(0.8).rrate(0.1).volume(1.0).gpan(sandworm);

            var sprite = sandworm.collection.add("Sprite");

            sprite.zIndex = -1;
            sprite.x = sandworm.x - Math.cos(sandworm.direction) * 10;
            sprite.y = sandworm.y - Math.sin(sandworm.direction) * 10;
            sprite.follow = sandworm;
            sprite.set("sandworm/move", false);
            sprite.setDuration(1.5);
            sprite.row = Utils.dirrow(sandworm.direction, 8);
            sprite.forceDirection = sandworm.direction;
            sprite.forceDamping = 0;
            sprite.force = 50;

            var blast = sandworm.collection.add("Blast");

            blast.x = sandworm.x + Utils.random(-4, 4);
            blast.y = sandworm.y + Utils.random(-4, 4);
            blast.radius = 50 + Utils.random(0, 5);
            blast.type = "sunken";
            blast.duration = 2.5;

        }

    }

};

CLIENT.Sandworm.attack = {

    enter: function(sandworm) {

        if (sandworm.inView) {

            app.sound.play("monster/sandworm_attack").rate(0.5);
            app.sound.play("monster/kill").rate(0.5);
            app.sound.play("monster/death").rate(0.5);

            sandworm.sprite.show();
            sandworm.sprite.set("sandworm/attack", false);
            sandworm.sprite.setDuration(4.0);

            sandworm.sprite.easing = "outCubic";

        }

    }

};

/* file: script/entities/Tile.js */

CLIENT.Tile = function(args) {
}
;

CLIENT.Tile.prototype = {

    constructor: CLIENT.Tile,

    shape: CLIENT.RECT,

    groups: ["tiles"],

    viewRadius: 100,

    reset: function(args) {

        this.isLinked = false;
        this.zIndex = 0;
        this.sortY = 0;
        this.z = 0;

        Object.assign(this, args);

        this.children = [];

        this.def = app.data.tileset.tiles[this.key];

        this.random = Math.random();

        this.x = this.tx * COMMON.TILE_WIDTH;
        this.y = this.ty * COMMON.TILE_HEIGHT;

        this.width = this.def.region[2];
        this.height = this.def.height || this.def.region[3];

        this.transparent = 0;

        this.alignX = (-this.def.offset[0]) / this.width;
        this.alignY = (-this.def.offset[1]) / this.height;

        this.timeout = 0.0;

    },

    _destruct: function() {

        if (!this.isLinked) {

            var index = this.tx + "," + this.ty + "," + this.type;

            this.game.tiles.delete(index);

        }

        app.pool(this);

    },

    render: function(layer, dt) {

        if (!this.def)
            return;

        if (!this.game.spectate && this.type === "roof" && (!app.game.player || (app.game.player.tile && app.game.player.tile.groundDef && app.game.player.tile.groundDef.floor)))
            return false;

        if (this.type === "roof" && this.game.hideRoofs)
            return false;

        if (this.type !== "wall")
            this.sortY = this.box[1];

        var image = app.textures.tilesets[this.def.image];

        var x = Math.floor(this.x + this.def.offset[0]);
        var y = Math.floor(this.y + this.def.offset[1]);

        app.painter.reset();
        if (this.transparent > 0)
            app.painter.alpha(0.7);
        app.painter.align(0, 0);
        app.painter.drawImageRegion(image, this.def.region[0], this.def.region[1], this.def.region[2], this.def.region[3], x, y - this.z, this.def.region[2], this.def.region[3]);

    },

    renderDebug() {

        app.painter.reset();

        app.painter.align(0, 0);

        app.painter.color(0xffffff).fillRect(this.box[0], this.box[1] + this.box[3], this.box[2], 2);
        app.painter.color(0xff0000).fillRect(this.box[0], this.box[1], this.box[2], 2);

        this.game.nameFont.color = 0xffffff;
        this.game.nameFont.fillText(this.type + ":" + String(this.key), this.center.x, this.center.y);

    },

    step: function(dt) {

        this.transparent -= dt;

        if (!this.isLinked) {

            if (!this.inView) {

                this.timeout += dt;

                if (this.timeout > 1) {
                    this.collection.remove(this);

                    if (!this.isLinked) {

                        for (let child of this.children)
                            this.collection.remove(child);

                    }

                }

            } else {

                this.timeout = 0;

            }
        }

    },

    renderMask() {

        if (!this.def.mask)
            return;

        for (var i = 0; i < this.def.mask.length; i += 3) {

            let mx = this.def.mask[i];
            let my = this.def.mask[i + 1];
            let mv = this.def.mask[i + 2];

            let x = this.x + mx * COMMON.SUBTILE_WIDTH;
            let y = this.y + my * COMMON.SUBTILE_HEIGHT;

            this.game.nameFont.color = 0xffffff;
            this.game.nameFont.fillText(this.type + ":" + String(this.key), this.center.x, this.center.y);

        }

    },

};

/* file: script/entities/Guillotine.js */

CLIENT.Guillotine = function(args) {

    this.updated = false;
    this.opened = 0;

    Object.assign(this, {

        x: 0,
        y: 0,
        z: 0,
        lifetime: 0,
        random: Math.random()

    }, args);

    this.region = [0, 56, 43, 38];

    this.update(this.shared);

}
;

CLIENT.Guillotine.prototype = {

    width: 64,
    height: 56,

    constructor: CLIENT.Guillotine,

    zIndex: 2,

    shape: CLIENT.RECT,

    alignY: 1.0,
    alignX: 0.5,

    radius: 10,

    wallRegion: [0, 0, 64, 56],

    update: function(data) {

        Object.assign(this.shared, data);

        if (data.x !== undefined || data.y !== undefined) {

            this.x = this.shared.x;
            this.y = this.shared.y;

        }

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

        if (data.closed !== undefined) {

            if (this.inView) {

                if (data.closed)
                    this.close();
                else
                    this.open();

            }

        }

        this.region[1] = this.shared.dirty ? 94 : 56;

        this.updated = true;

    },

    enterview: function() {

        this.opened = this.shared.closed ? 0 : 1;

    },

    open: function() {

        app.tween(this).to({
            opened: 1.0
        }, 0.3, "linear");

    },

    close: function() {

        app.tween(this).to({
            opened: 0
        }, 0.1, "linear");

        app.sound.play("impact/guillotine").delay(0.1).volume(0.1).gpan(this);

        var sprite = this.collection.add("Sprite");

        sprite.zIndex = 3;
        sprite.delay = 0.1;
        sprite.set("collect", false);
        sprite.loopDuration = 0.3;
        sprite.scale = 2;
        sprite.x = this.x + 8 + Utils.random(0, 48);
        sprite.y = this.y + 10;
        sprite.z = 20;
        sprite.scaleY = 1.0;
        sprite.blendMode = "lighter";
        sprite.alpha = 0.5;

    },

    step: function(dt) {

        this.lifetime += dt;

        if (this.hitLifespan > 0) {

            this.hitLifespan -= dt;

        }

        this.region[0] = 43 * (this.opened * 4 | 0);

    },

    prerender: function() {
    },

    render: function(layer) {

        app.painter.reset();
        app.painter.align(0, 0);
        app.painter.translate(this.x, this.y - this.z - 45);
        app.painter.drawImageRegion(app.textures.guillotine, ...this.wallRegion, 0, 0);
        app.painter.drawImageRegion(app.textures.guillotine, ...this.region, 10, 17);

    }

};

/* file: script/entities/Spikes.js */

CLIENT.Spikes = function(args) {

    this.updated = false;
    this.opened = 0;

    Object.assign(this, {

        x: 0,
        y: 0,
        z: 0,
        lifetime: 0,
        random: Math.random()

    }, args);

    this.region = [0, 0, 64, 64];

    this.update(this.shared);

    var bg = this.collection.add("Image");

    bg.x = this.x;
    bg.y = this.y - 16;
    bg.region = [0, 64, 64, 64];
    bg.image = app.textures.spikes;
    bg.zIndex = 1;

    this.bg = bg;

}
;

CLIENT.Spikes.prototype = {

    width: 64,
    height: 48,

    constructor: CLIENT.Spikes,

    _destruct: function() {

        this.collection.remove(this.bg);

    },

    zIndex: 1,

    shape: CLIENT.RECT,

    radius: 40,

    holesRegion: [0, 64, 64, 64],

    update: function(data) {

        Object.assign(this.shared, data);

        if (data.x !== undefined || data.y !== undefined) {

            this.x = this.shared.x;
            this.y = this.shared.y;

        }

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

        if (data.closed !== undefined) {

            this.zIndex = data.closed ? 0 : 2;

            if (this.inView) {

                if (data.closed)
                    this.close();
                else
                    this.open();

            }

        }

        this.updated = true;

    },

    enterview: function() {

        this.opened = this.shared.closed ? 0 : 1;

    },

    open: function() {

        app.tween(this).to({
            opened: 1.0
        }, 0.1, "linear");

        app.sound.play("objects/spikes").delay(0.1).volume(0.25).gpan(this);

    },

    close: function() {

        app.tween(this).to({
            opened: 0
        }, 0.3, "linear");

    },

    step: function(dt) {

        this.bg.inView = this.inView;

        this.lifetime += dt;

        if (this.hitLifespan > 0) {

            this.hitLifespan -= dt;

        }

        this.region[0] = 64 * (this.opened * 6 | 0);

    },

    render: function(layer) {

        app.painter.reset();
        app.painter.align(0, 0);
        app.painter.drawImageRegion(app.textures.spikes, ...this.region, this.x, this.y - this.z - 16);

    }

};

/* file: script/entities/Grenade.js */

CLIENT.Grenade = function(args) {

    this.direction = 0;
    this.duration = 0;
    this.z = 20;

    Object.assign(this, args);

    this.data = app.data.projectiles[this.shared.key];

    this.lifetime = 0;

    if (this.shared.parent_sid)
        this.parent = app.game.entities.sid(this.shared.parent_sid);

    // var keys = Object.keys(app.ease.cache);
    this.tween = new CLIENT.Tween(this);
    this.tween.easing = "outSine";

    this.sprite = new CLIENT.Sprite;
    this.sprite.set("items/bomb_spin", true);
    this.sprite.setDuration(0.4);

    this.delay = COMMON.SHARE_INTERVAL * 2;

    this.update(this.shared);

    app.tween(this).to({
        z: 70
    }, this.shared.speed * 0.3, "outSine").to({
        z: 0
    }, this.shared.speed * 0.7, "outBounce");

}
;

CLIENT.Grenade.easingIndex = 0;

CLIENT.Grenade.prototype = {

    shape: CLIENT.CIRCLE,

    radius: 2,

    zIndex: 2,

    enterview: function() {

        app.sound.play("weapons/spark").gpan(this);

    },

    _destruct: function() {
    },

    explode: function() {

        if (this.inView) {

            app.game.camera.shake(2, 0.5);

            for (var i = 0; i < 1; i++) {

                var sprite = this.collection.add("Sprite");

                sprite.zIndex = 3;
                sprite.x = this.x;
                sprite.y = this.y;
                sprite.scale = 1.5;
                sprite.set("heavy_explosion", false);
                sprite.loopDuration = 1.5;

            }

            app.sound.play("explosions/grenade").gpan(this);

            app.sound.play("explosions/heavy").rrate(0.2).gpan(this);

            this.game.add("GroundExplosion", {
                duration: 0.25,
                radius: 80,
                x: this.x,
                y: this.y
            });

        }

    },

    render: function(layer) {

        if (this.delay > 0)
            return;
        if (this.shared.delay > 0)
            return;

        if (!this.exploded) {

            app.painter.reset();
            app.painter.color(0x000000, 0.2);
            app.painter.fillCircle(this.x, this.y, this.radius);
            this.sprite.render(layer, this.x, this.y - this.z);

        }

    },

    step: function(dt) {

        if (this.delay > 0) {
            this.delay -= dt;
            return;
        }

        if (this.shared.delay > 0) {

            this.shared.delay -= dt;

            if (this.shared.delay <= 0) {

                if (this.parent) {

                    this.x = this.parent.x;
                    this.y = this.parent.y;

                }

            } else
                return;

        }

        this.lifetime += dt;

        var progress = Math.min(1.0, 0.2 + this.lifetime / this.shared.speed);

        // this.z = Math.sin(progress * Math.PI) * 60;

        this.tween.step(dt);

        this.sprite.step(dt);

        this.sprite.scale = 1.0 + this.z / 50;

        if (this.inView && !this.exploded && Utils.interval(this, "smoke", 0.01)) {

            var sprite = this.collection.add("Sprite");

            sprite.scale = Utils.randomf(0.1, 0.2);
            sprite.setDuration(Utils.randomf(0.3, 1.0));
            sprite.z = this.z;
            sprite.x = this.x;
            sprite.y = this.y;
            // sprite.color = "#9badb7";

            sprite.set("fx/smoke_puff", false);

        }

    },

    updateDirection: function() {

        if (this.shared.remove)
            return;

        this.direction = Utils.lookAt(this.shared.x, this.shared.y, this.shared.targetX, this.shared.targetY);
        this.sprite.row = Utils.dirrow(this.direction);

    },

    update: function(data) {

        if (data.x !== undefined)
            this.x = data.x;
        if (data.y !== undefined)
            this.y = data.y;

        this.tween.to("x", this.shared.targetX, this.shared.speed);
        this.tween.to("y", this.shared.targetY, this.shared.speed);

        Object.assign(this.shared, data);

        if (data.remove) {

            this.explode();
            this.collection.remove(this);

        }

        this.updateDirection();

    }

};

/* file: script/entities/Container.js */

CLIENT.Container = function(args) {

    this.x = 0;
    this.y = 0;

    this.stock = {};

    Object.assign(this, args);

    this.update(this.shared);

    this.updates = 0;

}
;

Object.assign(CLIENT.Container.prototype, {

    zIndex: 2,

    radius: 32,

    shape: CLIENT.CIRCLE,

    sprite: [288, 234, 79, 92],

    groups: ["interactive"],

    update(data) {

        if (data.x !== undefined)
            this.x = data.x;
        if (data.y !== undefined)
            this.y = data.y;

        if (data.serialized) {

            let items = data.serialized[0];

            this.updates++;

            for (var i = 0; i < items.length; i += 2) {

                let key = this.game.sharer.getKey(items[i]);
                let count = items[i + 1];

                this.stock[key] = count;

            }

        }

        if (this.shared.locked !== undefined && data.locked !== undefined) {

            this.game.fx("unlock", {
                x: this.x,
                y: this.y
            });

        }
        Object.assign(this.shared, data);

    },

    render(layer) {

        this.sortY = this.y;

        app.painter.reset();
        app.painter.align(0.5, 1.0);
        // app.painter.drawImageRegion(app.textures.randoms, ...this.sprite, this.x, this.y);

        app.painter.drawAtlas("objects/" + this.shared.key + (this.shared.locked ? "_locked" : "_unlocked"), this.x, this.y);

        app.painter.align(0.5, 0.5);

        if (this.game.interactor === this) {

            if (this.shared.locked) {

                this.game.setTooltip("Use key to unlock");

                app.painter.reset();
                app.painter.drawAtlas("ui/action_circle_neutral", this.center.x, this.center.y - 40);
                app.painter.drawSprite("pickups/key", this.center.x, this.center.y - 40, app.lifetime * 12, 0);

            } else {

                this.game.setTooltip("Hit SPACE to open");

            }

        }

    },

    step() {
    }

});

/* file: script/entities/Marker.js */

CLIENT.Marker = function(args) {
    this.x = 0;
    this.y = 0;
    this.marker = false;
    this.globalMarker = false;
    this.hidden = false;

    Object.assign(this, args);

    this.update(this.shared);

}
;

CLIENT.Marker.prototype = {

    groups: ["radar"],

    shape: CLIENT.CIRCLE,
    radius: 1,

    update(data) {

        Object.assign(this, data);

    }

};

/* file: script/entities/Equipment.js */

CLIENT.Equipment = function(args) {

    this.palette = 0;

    Object.assign(this, args);

    var sprite = this.sprite = new CLIENT.Sprite;

    this.data = COMMON.armory[this.key];
    sprite.set("equipment/" + (this.data.sprite || this.key) + "_spin", true);

    sprite.color = args.color;

    sprite.duration
    sprite.row = Utils.random(0, 7);
    sprite.auto = false;
    sprite.loopDuration = 1.0;
    sprite.palette = (this.data.fixedPalette || this.palette);
    sprite.setPalette(0);

    this.z = 0;
    this.lifetime = 0;
    this.forceZ = Utils.random(100, 350);
    this.forceP = this.forceZ;
    this.forceDirection = Math.random() * 6.2;
    this.force = Utils.random(100, 250);
    this.forceDamping = 100;
    this.row = Utils.random(0, 7);

    this.spin = 4;

}
;

CLIENT.Equipment.prototype = {

    constructor: CLIENT.Equipment,

    zIndex: 2,

    shape: CLIENT.CIRCLE,
    radius: 30,

    _destruct: function() {
    },

    enterview: function() {

        app.sound.play("weapons/long_throw").loop(true).rate(3.0).volume(0.25).fadeOut(1.0).rateTo(1.0, 1.0).gpan(this);

    },

    step: function(dt) {

        this.spin = Math.max(0, this.spin - dt);

        if (this.force) {

            this.force = Math.max(0, this.force - this.forceDamping * dt);

            this.x += Math.cos(this.forceDirection) * this.force * dt;
            this.y += Math.sin(this.forceDirection) * this.force * dt;

        }

        this.lifetime += dt;

        var g = 400;

        if (this.forceZ)
            this.forceZ -= g * dt;
        this.z += dt * this.forceZ;

        if (this.z <= 0 && this.forceP > 0) {

            app.sound.play("fall").rrate(0.5).gpan(this);

            this.z = 0;

            if ((this.forceP) > 40) {

                this.forceP *= 0.5;
                this.forceZ = this.forceP;

            } else {

                this.sprite.loop = false;
                this.forceP = 0;
                this.forceZ = 0;

            }

        }

        this.sprite.x = this.x;
        this.sprite.y = this.y - this.z;
        this.sprite.step(dt * this.spin);
        this.sprite.scale = 1.0 + this.z / 100;

        if (this.lifetime > 4.0) {

            this.sprite.alpha -= dt * 0.5;

            if (this.sprite.alpha <= 0.0)
                this.collection.remove(this);

        }

    },

    render: function(layer) {

        app.painter.reset();
        app.painter.scale(1.0, 0.6);
        app.painter.color(0x000000, 0.2);
        app.painter.fillCircle(this.x, this.y + 16, 8 + (this.z / 15 | 0));

        this.sprite.render(layer);

    }

};

/* file: script/entities/Pickup.js */

CLIENT.Pickup = function(args) {
}
;

CLIENT.Pickup.prototype = {

    zIndex: 2,

    shape: CLIENT.CIRCLE,

    radius: 3,

    _destruct: function() {

        app.pool(this);

    },

    reset: function(args) {

        this.groups = [];

        this.x = 0;
        this.y = 0;
        this.z = 0;
        this.random = Math.random();

        Object.assign(this, args);

        this.temp = Object.create(null);

        this.lifetime = 0;

        if (this.shared)
            this.update(this.shared);

        if (this.shared) {

            this.x = this.shared.x;
            this.y = this.shared.y;
            this.data = app.data.items[this.shared.key];

            if (this.data.equipment) {
                this.groups = ["radar"];
                this.marker = "weapon";
            }

        }

        if (this.shared.key === "surprise") {
            this.marker = "important";
            this.groups = ["radar"];
        }

        var self = this;

        this.dropped = false;

        app.tween(this).to({
            z: 40
        }, 0.4, "outQuad").to({
            z: 0
        }, 0.6, "outBounce");

    },

    enterview: function() {

        this.sprite = new CLIENT.Sprite();
        this.sprite.alignY = 1.0;
        this.sprite.scale = this.data.scale || 1.0;

        this.sprite.set(this.data.sprite || ("pickups/" + this.shared.key), true);

        if (this.data.palette !== undefined)
            this.sprite.setPalette(this.data.palette);

        if (this.data.randomFrame) {

            this.sprite.manual = true;
            this.sprite.setFrame(Utils.random(0, 3));

        }

        if (this.lifetime < 0.25) {

            /* Star Blink */

            var sprite = this.collection.add("Sprite");

            sprite.zIndex = 4;
            sprite.follow = this;
            sprite.set("collect", false);
            sprite.setDuration(0.4);
            sprite.scale = 2;

        }

        if (this.data.spin) {

            this.sprite.lifetime = Math.random() * 10;
            this.sprite.spin = 1.0;

        }

    },

    update: function(data) {

        Object.assign(this.shared, data);

        if (data.x !== undefined || data.y !== undefined) {

            this.temp.tweenspeed = Utils.distance(this.x, this.y, this.shared.x, this.shared.y) * (1 / COMMON.SHARE_INTERVAL) * 0.5;

        }

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

    },

    poke: function(duration, delay) {

        var tween = app.tween(this);

        if (delay)
            tween.delay(delay);

        tween.to({
            scaleY: 0.75,
            scaleX: 1.25
        }, duration * 0.25, "outSine").to({
            scaleY: 1.0,
            scaleX: 1.0
        }, duration * 0.5, "outElastic");

    },

    step: function(dt) {

        this.lifetime += dt;

        if (this.x !== this.shared.x)
            this.x = Utils.moveTo(this.x, this.shared.x, this.temp.tweenspeed * dt);
        if (this.y !== this.shared.y)
            this.y = Utils.moveTo(this.y, this.shared.y, this.temp.tweenspeed * dt);

        if (this.sprite) {
            this.sprite.step(this.z ? dt * 3 : dt);
            this.sprite.scaleX = 1.0 + this.z * 0.025;
            this.sprite.scaleY = 1.0 + this.z * 0.025;
        }

        if (!this.dropped && this.lifetime > 0.5) {

            this.dropped = true;

            if (this.inView)
                app.sound.play("pickups/drop").rate(1.0).gpan(this).rrate(0.1);

        }

    },

    oncollect: function(entity) {

        this.game.fx("pickup", {
            x: this.x,
            y: this.y - this.z - 4
        });

        var data = app.data.items[this.shared.key];

        var sound = app.sound.play("pickups/" + data.pickup_sound).gpan(this).rrate(0.1);

        if (data.pickup_sound2)
            app.sound.play("pickups/" + data.pickup_sound2).gpan(this);

    },

    prerender: function() {
    },

    render: function(layer) {

        app.painter.reset();
        app.painter.translate(this.x, this.y);
        app.painter.scale(1.0, 0.6);
        app.painter.color(0x111111, 0.25);
        app.painter.fillCircle(0, 0, 8);

        var linear = app.lifetime % 0.5 / 0.5;
        var o = Utils.saw(linear) * 6;

        if (this.sprite) {
            this.sprite.x = this.x;
            this.sprite.y = this.y - this.z - o;
            this.sprite.render(layer);
        }

    }

};

/* file: script/entities/Stone.js */

CLIENT.Stone = function(args) {

    Object.assign(this, {

        x: 0,
        y: 0,
        z: 0,
        lifetime: 0,
        random: Math.random()

    }, args);

    this.update(this.shared);

    this.region = app.data.stones[this.shared.key];

    this.radius = this.region[2] / 2 | 0;
    this.hitLifespan = 0.0;
}
;

CLIENT.Stone.prototype = {

    constructor: CLIENT.Stone,

    zIndex: 1,

    shape: CLIENT.CIRCLE,

    radius: 6,

    onhit() {

        this.hitLifespan = 0.25;

        if (this.inView) {

            app.sound.play("gameplay/mine_1").rrate(0.1).gpan(this);

            let spark = this.game.entities.add("Sprite");

            spark.x = this.x + Utils.random(-16, 16);
            spark.y = this.y + Utils.random(-16, 16);
            spark.set("fx/impact_spark_radial");
            spark.scale = 0.5;

            this.game.fx("plank", {
                color: "#847e87",
                x: this.x + Utils.random(-16, 16),
                y: this.y + Utils.random(-16, 16)
            });

        }
    },

    explode() {

        if (!this.inView)
            return;

        for (var i = 0; i < 5; i++) {

            this.game.fx("plank", {
                color: "#847e87",
                x: this.x + Utils.random(-16, 16),
                y: this.y + Utils.random(-16, 16)
            });
        }
        for (var i = 0; i < 5; i++) {

            let puff = this.game.entities.add("Sprite");

            puff.x = this.x + Utils.random(-16, 16);
            puff.y = this.y + Utils.random(-12, 12);
            puff.set("fx/smoke_puff");
            puff.scale = Utils.randomf(0.2, 0.35);
            puff.setDuration(Utils.randomf(0.5, 1.0));
            puff.delay = Utils.randomf(0.0, 0.25);
            puff.rotation = Math.random() * 6.28;
            app.game.ejectaTween(puff, Math.random() * 32, puff.delay + puff.duration);

        }

        app.sound.play("explosions/rock").gpan(this);
    },

    update: function(data) {

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

        if (data.x)
            this.x = data.x;
        if (data.y)
            this.y = data.y;

        if (data.dead)
            this.explode();

        Object.assign(this.shared, data);

    },

    step: function(dt) {

        this.lifetime += dt;

    },

    prerender: function() {
    },

    render: function(layer) {

        if (this.shared.dead)
            return;

        this.hitLifespan -= app.elapsed;

        app.painter.reset();
        if (this.hitLifespan > 0)
            app.painter.color(0xffffff);
        app.painter.drawImageRegion(app.textures.stones, this.region[0], this.region[1], this.region[2], this.region[3], this.x, this.y);

    }

};

/* file: script/entities/Pedestal.js */

CLIENT.Pedestal = function(args) {

    Object.assign(this, {

        x: 0,
        y: 0,
        z: 0,
        lifetime: 0,
        random: Math.random()

    }, args);

    this.update(this.shared);

}
;

CLIENT.Pedestal.prototype = {

    constructor: CLIENT.Pedestal,

    zIndex: 1,

    shape: CLIENT.CIRCLE,

    groups: ["radar"],

    radius: 6,

    update: function(data) {

        Object.assign(this.shared, data);

        if (data.x !== undefined || data.y !== undefined) {

            this.x = this.shared.x;
            this.y = this.shared.y;

        }

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

    },

    step: function(dt) {

        this.lifetime += dt;

    },

    prerender: function() {
    },

    render: function(layer) {

        app.painter.reset();
        app.painter.drawAtlas("objects/pedestal", this.x, this.y + 4);

    }

};

/* file: script/entities/Crate.js */

CLIENT.Crate = function(args) {

    this.updated = false;
    this.hitLifespan = 0;
    this.scaleX = 1.0;
    this.scaleY = 1.0;

    this.x = 0;
    this.y = 0;
    this.z = 0;
    this.lifetime = 0;
    this.random = Math.random();

    Object.assign(this, args);

    this.update(this.shared);

    if (this.def.gold) {

        this.marker = "treasure";
        this.groups = ["radar"];

    }

}
;

CLIENT.Crate.prototype = {

    constructor: CLIENT.Crate,

    zIndex: 2,

    shape: CLIENT.CIRCLE,

    radius: 10,

    deadSprite: [148, 88, 30, 21],

    groups: [],

    _destruct: function() {

        app.pool(this);

    },

    spawnPlank: function() {

        if (!this.inView)
            return;

        if (!this.game.canDoodle)
            return;

        var sprite = this.collection.add("Sprite");

        sprite.doodle = true;
        sprite.set("plank_spin", true);
        sprite.zIndex = 2;
        sprite.loopDuration = 0.2 + Math.random() * 0.3;
        sprite.x = this.x;
        sprite.y = this.y;
        sprite.row = Utils.random(0, 15);
        sprite.delay = Math.random() * 0.3;

        app.tween(sprite).delay(sprite.delay).to({
            z: Utils.random(10, 50),
            scale: 1.5
        }, 0.5).to({
            z: 0,
            scale: 1.0,
            tc: 0.0
        }, 0.5, "outBounce").delay(1.0).to({
            scaleY: 0,
            scaleX: 0
        }, 1.0);

        app.tween(sprite).delay(sprite.delay).to({
            x: this.x + Utils.random(-100, 100),
            y: this.y + Utils.random(-100, 100),
        }, 1.0)

        sprite.lifespan = 6;

    },

    respawn: function() {

        this.zIndex = 2;

        if (this.inView) {

            this.scaleX = 0.0;
            this.scaleY = 1.0;
            this.z = 70;

            app.tween(this).to({
                scaleX: 1.3,
                scaleY: 1.3
            }, 0.2).to({
                z: 0,
                scaleX: 1.0,
                scaleY: 1.0
            }, 0.4, "outBounce");

            app.sound.play("impact/wood").delay(0.3).rate(0.6).gpan(this);

        }

    },

    crush: function() {

        this.zIndex = 1;

        if (this.inView) {

            app.sound.play("explosions/wood").rrate(0.2).gpan(this);
            app.sound.play("explosions/wood").rate(1.5).rrate(0.2).gpan(this);

            for (var i = 0; i < 6; i++) {

                this.spawnPlank();

            }

            if (this.def.splash) {

                var sprite = this.collection.add("Sprite");

                sprite.set("heavy_explosion", false);
                // sprite.blendMode = "darker";
                sprite.zIndex = 3;
                sprite.scale = 0.4 + Math.random() * 0.4;
                sprite.loopDuration = Utils.randomf(0.4, 0.7);
                sprite.x = this.x;
                sprite.y = this.y;

                sprite.color = this.def.splash;

            }

        }

    },

    onhit: function() {

        if (this.inView) {

            this.hitLifespan = 0.2;

            app.sound.play("impact/wood").rrate(0.2).gpan(this);
            app.sound.play("axe/hit").rrate(0.2).gpan(this);

            this.spawnPlank();

            app.tween(this).to({
                z: 10
            }, 0.1).to({
                z: 0
            }, 0.3, "outBounce");

            this.poke();

        }

    },

    update: function(data) {

        if (data.dead !== undefined) {

            if (data.dead) {

                if (this.updated && this.inView) {

                    this.crush();
                }

            }

            if (this.shared.dead && !data.dead) {

                this.respawn();

            }

        }

        Object.assign(this.shared, data);

        if (data.x !== undefined || data.y !== undefined) {

            this.x = this.shared.x;
            this.y = this.shared.y;

        }

        if (data.key !== undefined) {

            this.def = app.data.crates[data.key];

        }

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

        this.updated = true;
    },

    poke: function(duration, delay) {

        duration = duration || 1.0;

        var tween = app.tween(this);

        if (delay)
            tween.delay(delay);

        tween.to({
            scaleY: 0.75,
            scaleX: 1.25
        }, duration * 0.25, "outSine").to({
            scaleY: 1.0,
            scaleX: 1.0
        }, duration * 0.5, "outElastic");

    },

    step: function(dt) {

        this.lifetime += dt;

        if (this.hitLifespan > 0) {

            this.hitLifespan -= dt;

        }

    },

    prerender: function() {
    },

    render: function(layer) {

        app.painter.reset();
        app.painter.drawImageRegion(app.textures.crates, ...(this.shared.dead ? this.deadSprite : this.def.sprite), Math.floor(this.x), Math.floor(this.y - this.z));

    }

};

/* file: script/entities/SoccerGoalLine.js */

/*
CLIENT.Image = function(args) {

  Object.assign(this, args);

};

CLIENT.Image.prototype = {

  step: function() {

  },

  render: function(layer) {

    if (this.region)
      layer.drawRegion(this.image, this.region, this.x, this.y);
    else
      layer.drawRegion(this.image, this.x, this.y);

  }

};
*/

CLIENT.SoccerGoalLine = function(args) {

    Object.assign(this, {

        x: 0,
        y: 0,
        z: 0,
        lifetime: 0,
        random: Math.random()

    }, args);

    this.update(this.shared);

    this.spriteA = this.spritesA[this.shared.team];
    this.spriteB = this.spritesB[this.shared.team];

    this.width = 127;
    this.height = 32;

    this.collection.add("Image", {
        image: app.textures.soccer,
        region: this.spriteB,
        x: this.x - 10,
        y: this.y - 34 - 7,
        zIndex: 3
    });

}
;

CLIENT.SoccerGoalLine.prototype = {

    constructor: CLIENT.SoccerGoalLine,

    zIndex: 0,

    shape: CLIENT.RECT,

    radius: 6,

    update: function(data) {

        Object.assign(this.shared, data);

        if (data.x !== undefined || data.y !== undefined) {

            this.x = this.shared.x;
            this.y = this.shared.y;

        }

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

    },

    step: function(dt) {

        this.lifetime += dt;

    },

    prerender: function() {
    },

    spritesA: [[0, 86, 127, 15], [0, 34, 127, 15]],

    spritesB: [[0, 53, 127, 34], [0, 0, 127, 34]],

    render: function(layer) {

        app.painter.reset();
        app.painter.align(0.0, 0.0);
        app.painter.drawImageRegion(app.textures.soccer, ...this.spriteA, this.x - 10, this.y - 7);

    }

};

/* file: script/entities/ThrowingKnife.js */

CLIENT.ThrowingKnife = function(args) {
}
;

CLIENT.ThrowingKnife.prototype = {

    zIndex: 2,

    shape: CLIENT.CIRCLE,

    radius: 6,

    sprites: {

        "mine": [6, 15, 11, 11],
        "potion_health": [0, 0, 8, 14],
        "potion_haste": [9, 0, 8, 14],
        "knife": [0, 15, 5, 22]

    },

    constructor: CLIENT.ThrowingKnife,

    reset: function(args) {

        this.throttles = null;

        this.lifetime = 0;
        this.killTimeout = 0;

        this.palette = -1;
        this.x = 0;
        this.y = 0;
        this.z = 15;
        this.random = Math.random();

        Object.assign(this, args);

        this.hit = false;

        this.x = this.shared.x;
        this.y = this.shared.y;

        this.tween = new CLIENT.Tween(this);

        this.data = app.data.projectiles[this.shared.key];

        if (this.data.sprite) {

            this.sprite = new CLIENT.Sprite();
            this.sprite.set(this.data.sprite.key, true);
            this.sprite.setDuration(this.data.sprite.duration);
            this.sprite.scaleX = this.data.sprite.scaleX;
            this.sprite.scaleY = this.data.sprite.scaleY;
            this.sprite.palette = this.data.sprite.palette === undefined ? 0 : this.data.sprite.palette;

        }

        this.update(this.shared);

        this.color = this.shared.team === app.game.player.team ? "#00c4b8" : "#b20";

        if (this.data.lighting) {

            var sprite = this.collection.add("Sprite");

            sprite.set("fx/lighting", false);
            sprite.zIndex = 2;
            // sprite.palette = this.palette;
            // sprite.colorMode = "source-in";
            sprite.x = this.x + Math.cos(this.shared.direction) * 20;
            sprite.y = this.y + Math.sin(this.shared.direction) * 20;
            sprite.z = this.z;

            // sprite.follow = this;
            sprite.scale = 0.5;
            sprite.setDuration(0.3);
            sprite.rotation = this.shared.direction + Math.HPI;

        }

    },

    kill: function() {

        if (this.inView) {

            var sprite = this.collection.add("Sprite");

            if (this.data.explosion.color)
                sprite.color = this.data.explosion.color;
            if (this.data.explosion.colorMode)
                sprite.colorMode = this.data.explosion.colorMode;

            sprite.x = this.shared.x;
            sprite.y = this.shared.y;
            sprite.z = this.z;
            sprite.set(this.data.explosion.key, false);
            sprite.setDuration(this.data.explosion.duration);

            if (this.data.impactSound)
                app.sound.play(this.data.impactSound).rrate(0.1).gpan(this);

        }

        this.lifespan = 0.25;

    },

    update: function(data) {

        Object.assign(this.shared, data);

        if (data.x !== undefined)
            this.x = data.x;
        if (data.y !== undefined)
            this.y = data.y;

        // if (data.x !== undefined) this.tween.to('x', data.x, COMMON.TWEEN_DURATION * 2);
        // if (data.y !== undefined) this.tween.to('y', data.y, COMMON.TWEEN_DURATION * 2);
        // if (data.z !== undefined) this.tween.to('z', data.z, COMMON.TWEEN_DURATION * 2);

        if (data.remove !== undefined && data.remove) {

            // this.killTimeout = COMMON.TWEEN_DURATION * 2;
            this.kill();

        }

    },

    killSound: function() {

        if (this.soundLoop) {

            this.soundLoop.stop();

            this.soundLoop = false;

        }

    },

    enterview: function() {

        // this.radius = 1000;

        if (this.shared.key && !this.hit && this.data.soundLoop && !this.soundLoop) {

            let rate = this.data.soundLoopRate || 1.25;

            this.soundLoop = app.sound.play("weapons/long_throw").loop().rate(rate).volume(1.5);

            // setTimeout(this.killSound.bind(this), 8000);

        }

        if (this.data.sound) {

            let sound = app.sound.play(this.data.sound).rrate(0.1).gpan(this);

            if (this.data.soundRate)
                sound.rate(this.data.soundRate).rrate(0.1);

        }

        // app.sound.play("monster/growl" + Utils.random(1, 2));
        // app.sound.play("goblin/angry").rate(1.4).rrate(0.3);

        if (this.data.smokeTrail) {

            {
                let trail = this.collection.add("Sprite");

                trail.set("fx/smoke_trail");
                trail.x = this.x;
                trail.y = this.y;
                trail.alpha = 0.1;
                trail.scaleX = 0.5;
                trail.scaleY = 0.5;
                trail.alignY = 1.0;
                trail.rotation = this.shared.direction + Math.PI / 2;
                trail.color = "#000";
            }

            {
                let trail = this.collection.add("Sprite");

                trail.set("fx/smoke_trail");
                trail.x = this.x;
                trail.y = this.y;
                trail.z = this.z;
                trail.scaleX = 0.5;
                trail.alignY = 1.0;
                trail.rotation = this.shared.direction + Math.PI / 2;
                if (this.data.trail.color)
                    trail.color = this.data.trail.color;
            }
        }

    },

    _destruct: function() {

        if (this.soundLoop) {

            this.soundLoop.stop();

            this.soundLoop = false;

        }

        this.sprite = null;

        app.pool(this);

    },

    leaveview: function() {

        if (this.soundLoop) {

            this.soundLoop.stop();

            this.soundLoop = false;

        }

    },

    step: function(dt) {

        // this.tween.step(dt);

        this.lifetime += dt;

        if (this.killTimeout) {

            if ((this.killTimeout -= dt) <= 0)
                this.kill();

        }

        if (this.sprite) {

            this.sprite.x = this.x;
            this.sprite.y = this.y;
            this.sprite.step(dt);

        }

        if (!(this.lifespan > 0)) {

            this.x += Math.cos(this.shared.direction) * this.shared.speed * dt;
            this.y += Math.sin(this.shared.direction) * this.shared.speed * dt;

        }

        if (this.sprite)
            this.sprite.z = this.z + (this.data.sprite.offsetZ | 0);

        // if (this.lifetime > 3) this.collection.remove(this);

        if (this.soundLoop)
            this.soundLoop.gpan(this);

    },

    prerender: function() {
    },

    doodles() {
        if (!this.hit) {

            if (this.data.piercing && this.inView && Utils.interval(this, "stars", 0.05) && this.game.canDoodle()) {

                var sprite = this.collection.add("Sprite");

                sprite.zIndex = 2;
                sprite.x = this.x + Utils.random(-10, 10);
                sprite.y = this.y + Utils.random(-10, 10) - 20
                sprite.set("collect", false);
                sprite.setDuration(0.3);

            }

            if (this.data.trail && this.game.canDoodle()) {

                var sprite = this.collection.add("Sprite");

                if (this.data.trail.color)
                    sprite.color = this.data.trail.color;
                sprite.zIndex = 2;
                sprite.x = this.x;
                sprite.y = this.y;
                sprite.z = this.z;
                if (this.sprite)
                    sprite.z = this.sprite.z;

                sprite.scale = 1;
                sprite.set(this.data.trail.key, false);
                sprite.setDuration(this.data.trail.duration);
                sprite.scaleY = this.data.trail.scaleY;
                sprite.scaleX = this.data.trail.scaleX;
                sprite.rotation = this.shared.direction + Math.HPI;

            }

            if (this.data.spinTrail) {

                if (Utils.interval(this, "spin_trail", 0.05) && this.game.canDoodle()) {

                    let slash = this.collection.add("Sprite");

                    slash.doodle = true;
                    slash.x = this.x;
                    slash.y = this.y;

                    slash.set("fx/slash_horizontal");
                    slash.setDuration(0.25);
                    slash.color = this.data.spinTrail.color;
                    // slash.blendMode = "overlay";
                    slash.alpha = 0.6;
                    // slash.reverse = true;
                    slash.rotation = (this.sprite.row / this.sprite.data.rows) * 6.28 + COMMON.slashRotation["fx/slash_horizontal"];
                    slash.zIndex = this.zIndex - 0.1;
                }
            }

            if (this.data.sparks && this.game.canDoodle()) {

                var sprite = this.collection.add("Sprite");

                sprite.zIndex = 2;
                // sprite.color = this.color;
                sprite.x = this.x + Utils.random(-10, 10);
                sprite.y = this.y - 15 + Utils.random(-10, 10);
                sprite.color = Math.random() > 0.5 ? this.color : "#fff";
                sprite.scale = 0.4;
                sprite.set("debris", false);
                sprite.rotation = Math.random() * 6;
                sprite.setDuration(1.0);

            }

        }
    },

    render: function(layer) {

        this.doodles();

        app.painter.reset();
        app.painter.scale(1.0, 0.6);
        app.painter.color(0x000000, 0.2);
        app.painter.fillCircle(this.x, this.y, 8);

        if (this.sprite) {

            if (this.sprite.ready) {

                if (this.data.sprite.spin) {

                    this.sprite.row = ((1 - (this.lifetime % 0.4) / 0.4) * this.sprite.data.rows) | 0;

                }

                if (this.data.sprite.lookAt) {

                    var fo = -0.5 * Math.TAU / this.sprite.data.rows;

                    this.sprite.row = (Utils.circWrap(this.shared.direction - fo) / Math.TAU) * this.sprite.data.rows | 0;

                }

                if (this.data.sprite.frame)
                    this.sprite.setFrame(this.data.sprite.frame)

            }

            this.sprite.render(layer);

        }

        if (this.data.head) {

            app.painter.reset();
            app.painter.align(1.0, 0.5);
            app.painter.translate(this.x, this.y - this.z);
            app.painter.rotate(this.shared.direction);
            app.painter.drawImageRegion(app.textures.projectiles, ...this.data.head, 0, 0);

        }

    }

};

CLIENT.ThrowingKnife.validate = function() {

    let projectiles = app.data.projectiles;

    for (var key in projectiles) {

        let projectile = projectiles[key];

        Utils.defaults(projectile, {
            sprite: false,
            trail: false,
            impactSound: "impact/generic"
        });

        if (typeof projectile.sprite === "string") {

            projectile.sprite = {
                key: projectile.sprite
            };

        }

        if (projectile.sprite) {

            Utils.defaults(projectile.sprite, {
                scaleX: 1.0,
                scaleY: 1.0,
                duration: 0.5,
                offsetZ: 0
            });

        }

        if (!projectile.explosion)
            projectile.explosion = {};

        Utils.defaults(projectile.explosion, {
            key: "debris",
            scaleX: 1.0,
            scaleY: 1.0,
            duration: 0.4
        });

        if (projectile.trail) {

            if (projectile.trail === true)
                projectile.trail = {};

            Utils.defaults(projectile.trail, {
                key: "fx/trail",
                scaleX: 1.0,
                scaleY: 1.0,
                offsetY: 0,
                duration: 0.4
            });

        }

    }

}
;

/* file: script/entities/Projectile.js */

CLIENT.Projectile = function(args) {

    Object.assign(this, {

        x: 0,
        y: 0,
        z: 15,
        random: Math.random()

    }, args);

    this.hit = false;

    this.sprite = new CLIENT.Sprite();

    //      "#9badb7": "#cbdbfc"

    this.sprite.set("knife_spin", true);
    this.sprite.loopDuration = 0.5;

    this.x = this.shared.x;
    this.y = this.shared.y;

    this.tween = new CLIENT.Tween(this);

    this.update(this.shared);

    this.lifetime = 0;

    this.lifespan = 0;

    this.sound = app.sound.play("spells/shoot").gpan(this);

}
;

CLIENT.Projectile.prototype = {

    zIndex: 2,

    shape: CLIENT.CIRCLE,

    radius: 6,

    sprites: {

        "mine": [6, 15, 11, 11],
        "potion_health": [0, 0, 8, 14],
        "potion_haste": [9, 0, 8, 14],
        "knife": [0, 15, 5, 22]

    },

    constructor: CLIENT.ThrowingKnife,

    update: function(data) {

        Object.assign(this.shared, data);

        if (data.x !== undefined)
            this.tween.to('x', data.x, COMMON.TWEEN_DURATION * 2);
        if (data.y !== undefined)
            this.tween.to('y', data.y, COMMON.TWEEN_DURATION * 2);
        if (data.z !== undefined)
            this.tween.to('z', data.z, COMMON.TWEEN_DURATION * 2);

        if (data.remove !== undefined && data.remove) {

            this.hit = true;
            this.sprite.pause();

            if (this.soundLoop)
                this.soundLoop.stop();

            if (this.inView) {

                app.tween(this).to({
                    z: 0
                }, 1.0, "outBounce");

                this.lifespan = 5.0;

            } else {

                this.lifespan = 0.25;

            }

        }

        if (data.key === "arrow") {

            this.sprite.set("arrow", false);

        } else if (data.key) {

            this.sprite.set("equipment/" + data.key + "_spin", false);

            this.sprite.alignY = 0.6;
            this.sprite.pause();

        }
    },

    enterview: function() {

        if (this.shared.key && !this.hit && this.shared.key !== "arrow") {

            this.soundLoop = app.sound.play("weapons/long_throw").loop().rate(1.5).volume(1.5);
            app.sound.play("human/effort").rate(0.9).rrate(0.2).gpan(this);

        }

        // app.sound.play("monster/growl" + Utils.random(1, 2));
        // app.sound.play("goblin/angry").rate(1.4).rrate(0.3);

    },

    leaveview: function() {

        if (this.soundLoop) {
            this.soundLoop.stop();
            this.soundLoop = false;
        }

    },

    step: function(dt) {

        this.tween.step(dt);

        this.lifetime += dt;

        this.sprite.step(dt);

        this.sprite.x = this.x;
        this.sprite.y = this.y;
        if (this.shared.key)
            this.sprite.z = this.z + 10;
        else
            this.sprite.z = this.z;

        if (!this.hit) {

            if (this.shared.key === "arrow") {

                var fo = -0.5 * Math.TAU / this.sprite.data.rows;

                this.sprite.row = (Utils.circWrap(this.shared.direction - fo) / Math.TAU) * this.sprite.data.rows | 0;

            } else if (this.shared.key) {

                this.sprite.row = ((1 - (this.lifetime % 0.4) / 0.4) * 16) | 0;
                this.sprite.setFrame(6)

            } else {

                var fo = -0.5 * Math.TAU / this.sprite.data.rows;

                this.sprite.row = (Utils.circWrap(this.shared.direction - fo) / Math.TAU) * this.sprite.data.rows | 0;

            }

        }

        if (!this.hit && !(this.lifespan > 0)) {

            this.x += Math.cos(this.shared.direction) * this.shared.speed * dt;
            this.y += Math.sin(this.shared.direction) * this.shared.speed * dt;

        }

        // if (this.lifetime > 3) this.collection.remove(this);

        if (this.soundLoop)
            this.soundLoop.gpan(this);

        if (this.sound)
            this.sound.gpan(this);

        if (false && this.inView) {

            var sprite = this.collection.add("Sprite");

            sprite.x = this.x;
            sprite.y = this.y;
            sprite.z = 15;
            sprite.color = "#8cf";
            sprite.blendMode = "lighter";
            sprite.setDuration(0.1);
            sprite.set("collect");

        }

    },

    prerender: function() {
    },

    render: function() {

        this.sprite.render();

    }

};

/* file: script/entities/Monster.js */

CLIENT.Monster = function(args) {

    this.offsetX = 0.5;
    this.offsetY = 0.5;

    Object.assign(this, {

        x: 0,
        y: 0,
        z: 0,

        lifetime: Math.random(),

        scaleX: 1.0,
        scaleY: 1.0,

        direction: 0,
        finalDirection: 0

    }, args);

    this.update(this.shared);

    if (this.type === "goblin")
        this.maxHealth = 1;
    else if (this.type === "ogre")
        this.maxHealth = 200;
    else
        this.maxHealth = 20;

    if (this.shared.type === "ogre") {

        app.loadSprite("ogre/death");
        app.loadSprite("ogre/jump");
        app.loadSprite("ogre/charge");
        app.loadSprite("ogre/run");
        app.loadSprite("ogre/attack");

    }

}
;

CLIENT.Monster.prototype = {

    zIndex: 2,

    shape: CLIENT.CIRCLE,

    radius: 40,

    onhit: function(data) {

        var attacker = this.collection.sid(data.attacker_sid);

        if (!attacker)
            attacker = this;

        this.hitLifespan = 0.2;

        if (this.inView) {

            if (this.type === "ogre") {

                app.sound.play("monster/ogre_hit").gpan(this);

            } else if (this.type === "goblin") {

                app.sound.play("goblin/hurt").gpan(this);

            } else {

                app.sound.play("monster/hurt").rrate(0.3).gpan(this);

                app.sound.play("axe/hit").rrate(0.2).gpan(this);

                this.game.fx("bleed", {
                    angle: Utils.lookAt(attacker, this),
                    x: this.x,
                    y: this.y,
                    zIndex: this.zIndex
                });

            }

            app.sound.play("axe/hit").rrate(0.2).gpan(this);
            app.sound.play("martial/hit").rate(1.4).rrate(0.2).gpan(this);

        }

    },

    setType: function(type) {

        this.type = type;

        this.state = new CLIENT.StateManager(this,CLIENT.Monster[type]);
        this.sprite = new CLIENT.Sprite();
        // this.sprite.color = "#222034";

        if (this.type === "goblin") {

            this.sprite.scaleX = 0.7;
            this.sprite.scaleY = 0.7;

        } else {

            this.sprite.scaleX = 1.5;
            this.sprite.scaleY = 1.5;
        }

        Object.assign(this, CLIENT.Monster[type].properties);

    },

    update: function(data) {

        if (data.type) {

            this.setType(data.type);

        }

        Object.assign(this.shared, data);

        app.tween(this).to({

            x: this.shared.x,
            y: this.shared.y

        }, COMMON.SHARE_INTERVAL * 2, "linear");

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

        if (data.stateKey) {

            this.state.set(data.stateKey);

        }

        if (data.direction !== undefined) {

            this.finalDirection = data.direction;

        }

    },

    enterview: function() {
    // app.sound.play("monster/growl" + Utils.random(1, 2));
    // app.sound.play("goblin/angry").rate(1.4).rrate(0.3);

    },

    poke: function(duration, delay) {

        var tween = app.tween(this);

        if (delay)
            tween.delay(delay);

        tween.to({
            scaleY: 0.75,
            scaleX: 1.25
        }, duration * 0.25, "outSine").to({
            scaleY: 1.0,
            scaleX: 1.0
        }, duration * 0.5, "outElastic");

    },

    step: function(dt) {

        this.sortX = this.x;
        this.sortY = this.y;

        if (this.hitLifespan)
            this.hitLifespan = Math.max(0, this.hitLifespan - dt);

        this.lifetime += dt;

        this.state.step(dt);

        this.sprite.step(dt);

        if (this.direction !== this.finalDirection) {

            var fo = -0.5 * Math.TAU / this.sprite.data.rows;

            this.direction = Utils.circWrapTo(this.direction, this.finalDirection, 12 * dt);

            this.sprite.row = Utils.dirrow(this.direction, this.sprite.data.rows);

            if (this.type === "ogre") {// console.log(this.finalDirection, this.direction)
            }

        }

        if (this.inView && !this.shared.dead && (this.state.current.can & COMMON.CAN_MOVE)) {

            if (Utils.interval(this, "footstep", this.sprite.duration * 0.5)) {

                if (this.heavy) {

                    app.sound.play("footsteps/heavy").rrate(0.2);

                    app.game.camera.shake(1, 0.25);

                } else {

                    // var pan = (this.x - this.game.playersCitizen.x) / 300;

                    app.sound.play("footsteps/normal").rate(2).rrate(0.2).gpan(this);

                }

            }

        }

        if (this.hitLifespan > 0) {

            this.sprite.tempColor = "#fff";

        } else {

            this.sprite.tempColor = false;

        }

    },

    prerender: function() {
    },

    renderStains() {

        let aspectX = this.game.stainsBuffer.width / (this.game.innerWidth * 2);
        let aspectY = this.game.stainsBuffer.height / (this.game.innerHeight * 2);

        if (this.z === 0 && Utils.interval(this, "footprint", this.sprite.loopDuration * 0.5)) {

            let x = (this.x + Utils.random(-4, 4) + this.game.innerWidth) * aspectX;
            let y = (this.y + Utils.random(-4, 4) + this.game.innerHeight) * aspectY;

            app.painter.reset();
            app.painter.color(0x000000);
            app.painter.alpha(0.4);
            app.painter.rotate(Math.random() * 6);
            app.painter.fillRect(x, y, 2 + this.radius * 0.2, 2 + this.radius * 0.2);
        }
    },

    render: function(layer) {

        if (!this.dead && this.maxHealth > 1) {

            app.painter.reset();
            // this.game.renderDamageArc(this, 0, -this.z, this.radius + 4, this.shared.health, this.maxHealth, "#a00");
            this.game.renderBar("ui/health_bar_enemy", "ui/health_bar_off_enemy", this.x, this.y + this.radius + 8, this.shared.health / this.maxHealth);

        }

        // if (!this.ownShadow) {

        app.painter.reset();
        app.painter.scale(1.0, 0.6);
        // app.painter.color(0x000000, 0.2);
        app.painter.color(0x990000, 0.5);
        // app.painter.fillCircle(this.x, this.y, 16);
        app.painter.fillCircle(this.x, this.y, this.radius);

        // }

        this.sprite.x = this.x;
        this.sprite.y = this.y - 6 - this.z + this.offsetY;

        this.sprite.render(layer);

    }

};

/* file: script/entities/monsters/yeti.js */

CLIENT.Monster.yeti = {

    properties: {

        heavy: true,
        radius: 30

    }

};

CLIENT.Monster.yeti.idle = {

    can: COMMON.CAN_MOVE,

    enter: function(monster, manager) {

        monster.sprite.set("yeti/run", true);
        monster.sprite.loopDuration = 1.0;
        monster.sprite.easing = "linear";

    }

};

CLIENT.Monster.yeti.attack = {

    enter: function(monster, manager) {

        if (monster.inView) {

            app.sound.play("monster/attack");

        }

        monster.sprite.set("yeti/attack", true);
        monster.sprite.loopDuration = 1.0;
        monster.sprite.easing = "linear";

    },

    step: function(monster, manager) {

        if (manager.runOnce("hit", 0.5)) {

            if (monster.inView) {

                app.sound.play("impact/ground_heavy");

                monster.game.fx("smoke_puff", {
                    x: monster.x + Math.cos(monster.direction) * 32,
                    y: monster.y + Math.sin(monster.direction) * 32
                });

                if (Utils.distance(app.game.player, monster) < 200) {

                    monster.game.camera.shake(4);

                }

            }

        }

    }

};

CLIENT.Monster.yeti.dying = {

    enter: function(monster, manager) {

        monster.sprite.set("yeti/death", false);
        monster.sprite.setDuration(2.0);

        if (monster.inView) {

            app.sound.play("monster/death").rrate(0.2);
            app.sound.play("monster/death").rate(0.6);
            if (monster.inView)
                app.sound.play("impact/ground_heavy").delay(0.5).rate(0.5).gpan(monster);
            if (monster.inView)
                app.sound.play("impact/ground_heavy").delay(0.6).rate(0.6).gpan(monster);

        }

    }

};

CLIENT.Monster.yeti.dead = {

    enter: function(monster, manager) {

        monster.sprite.set("yeti/death", false);
        monster.sprite.cancel();

    }

};

/* file: script/entities/monsters/ogre.js */

CLIENT.Monster.ogre = {

    properties: {

        heavy: true,
        radius: 30,
        offsetY: -40,
        ownShadow: true

    }

};

CLIENT.Monster.ogre.idle = {

    can: COMMON.CAN_MOVE,

    enter: function(monster, manager) {

        monster.sprite.set("ogre/run", true);
        monster.sprite.loopDuration = 1.5;
        monster.sprite.easing = "linear";

    }

};

CLIENT.Monster.ogre.prepareCharge = {

    enter: function(monster, manager) {

        monster.sprite.set("ogre/jump", false);
        monster.sprite.play(0, 1);
        monster.sprite.setDuration(0.5);

    }

};

CLIENT.Monster.ogre.charge = {

    can: COMMON.CAN_MOVE,

    enter: function(monster, manager) {

        if (monster.inView)
            app.sound.play("monster/ogre_effort").rate(0.5).gpan(monster);

        monster.sprite.set("ogre/charge", true);
        monster.sprite.loopDuration = 0.75;
        monster.sprite.easing = "linear";

    }

};

CLIENT.Monster.ogre.prepareStomp = {

    enter: function(monster, manager) {

        monster.sprite.set("ogre/jump", false);
        monster.sprite.play(0, 1);
        monster.sprite.setDuration(0.25);

    }

};

CLIENT.Monster.ogre.stomp = {

    enter: function(monster, manager) {

        monster.sprite.set("ogre/jump", false);
        monster.sprite.play(2, 5);
        monster.sprite.setDuration(0.7);
        monster.sprite.easing = "outQuad";
        manager.data.jumped = false;

    },

    step: function(monster, manager) {

        if (manager.elapsed > 0.5 && !manager.data.jumped) {

            manager.data.jumped = true;

            monster.sprite.play(5, 9);
            monster.sprite.setDuration(0.3);
            monster.sprite.easing = "inQuad";

        }

    }

};

CLIENT.Monster.ogre.stompRecover = {

    enter: function(monster, manager) {

        monster.sprite.set("ogre/jump", false);
        monster.sprite.play(9, 12);
        monster.sprite.setDuration(0.5);
        monster.sprite.easing = "linear";

    }

};

CLIENT.Monster.ogre.pick = {

    enter: function(monster, manager) {

        monster.sprite.set("ogre/pick", false);
        monster.sprite.loopDuration = 1.0;

    }

};

CLIENT.Monster.ogre.throw = {

    enter: function(monster, manager) {

        if (monster.inView)
            app.sound.play("monster/ogre_effort").rate(1.25).gpan(monster);

        monster.sprite.set("ogre/throw", false);
        monster.sprite.loopDuration = 0.8;

    }

};

CLIENT.Monster.ogre.attack = {

    enter: function(monster, manager) {

        if (monster.inView) {

            app.sound.play("monster/ogre_effort").gpan(monster);

        }

        monster.sprite.set("ogre/attack", true);
        monster.sprite.loopDuration = 1.0;
        monster.sprite.easing = "linear";

    },

    step: function(monster, manager) {

        if (manager.runOnce("hit", 0.4)) {

            if (monster.inView) {

                for (var i = 0; i < 10; i++) {

                    monster.game.fx("plank", {
                        color: "#847e87",
                        x: monster.x + Utils.random(-50, 50) + Math.cos(monster.shared.direction) * 100,
                        y: monster.y + Utils.random(-50, 50) + Math.sin(monster.shared.direction) * 100
                    });

                }

                app.sound.play("impact/ground_heavy");

                if (Utils.distance(app.game.player, monster) < 200) {

                    monster.game.camera.shake(4);

                }

            }

        }

    }

};

CLIENT.Monster.ogre.dying = {

    enter: function(monster, manager) {

        monster.sprite.set("ogre/death", false);
        monster.sprite.setDuration(2.0);

        if (monster.inView) {

            app.sound.play("monster/ogre_death").rrate(0.2);
            app.sound.play("monster/ogre_death").rate(0.6);

            if (monster.inView) {

                app.sound.play("impact/ground_heavy").delay(1.5).rate(0.7).gpan(monster);
                setTimeout(()=>{
                    monster.game.camera.shake(4);
                }
                , 1500)

            }

        }

    }

};

CLIENT.Monster.ogre.dead = {

    enter: function(monster, manager) {

        monster.sprite.set("ogre/death", false);
        monster.sprite.cancel();

        if (manager.data.pickedUp) {

            manager.data.pickedUp.state.set("idle");

        }

    }

};

/* file: script/entities/monsters/goblin.js */

CLIENT.Monster.goblin = {

    properties: {
        speed: 80,
        radius: 8
    }

};

CLIENT.Monster.goblin.idle = {

    can: COMMON.CAN_MOVE,

    enter: function(monster, manager) {

        monster.sprite.set("goblin/run", true);
        monster.sprite.loopDuration = 0.3;
        monster.sprite.easing = "linear";

    }

};

CLIENT.Monster.goblin.attack = {

    can: COMMON.CAN_MOVE,

    enter: function(monster, manager) {

        if (monster.inView) {

            app.sound.play("goblin/attack").rrate(0.2).gpan(monster);

            app.tween(monster).to({
                z: 25
            }, 0.25, "outQuad").to({
                z: 0
            }, 0.25, "inQuad");

        }

        monster.sprite.set("goblin/attack", true);
        monster.sprite.loopDuration = 0.5;
        monster.sprite.easing = "linear";

    },

    step: function(monster, manager) {

        if (manager.runOnce("hit", 0.5)) {

            // app.sound.play("impact/ground_heavy");

            monster.game.fx("smoke_puff", {
                x: monster.x + Math.cos(monster.direction) * 32,
                y: monster.y + Math.sin(monster.direction) * 32
            });

            // monster.game.camera.shake(10);

        }

    }

};

CLIENT.Monster.goblin.fall = {

    enter: function(monster, manager) {

        monster.sprite.set("goblin/death");
        monster.sprite.loopDuration = 2.0;
        monster.sprite.easing = "linear";

    }

};

CLIENT.Monster.goblin.dying = {

    enter: function(monster, manager) {

        if (monster.inView) {

            app.sound.play("goblin/death").rate(1.3).rrate(0.3).gpan(monster);

            for (var i = 0; i < 8; i++) {

                monster.game.fx("blood_fountain", {
                    intensity: 0.25,
                    x: monster.x,
                    y: monster.y,
                    color: "#99ac2e"
                });

            }

        }

        monster.sprite.set("goblin/death", false);
        monster.sprite.loopDuration = 0.5;
        monster.sprite.easing = "linear";

    },

    step: function(monster, manager) {
    }

};

CLIENT.Monster.goblin.dead = {

    enter: function(monster, manager) {

        monster.sprite.set("goblin/death", false);
        monster.sprite.cancel();

    }

};

/* file: script/entities/ParticleEmitter.js */

CLIENT.ParticleEmitter = function(args) {

    Object.assign(this, {

        x: 0,
        y: 0,
        z: 0,
        interval: 0.1,
        duration: 1.0,
        lifetime: 0,
        direction: 0,
        speed: 0,
        hidden: false

    }, args);

}
;

CLIENT.ParticleEmitter.prototype = {

    shape: CLIENT.CIRCLE,
    radius: 100,

    zIndex: 0,

    onspawn: function() {},

    hide: function() {

        this.hidden = true;

    },

    show: function() {

        this.hidden = false;

    },

    pause: function() {

        this.paused = true;

    },

    play: function() {

        this.paused = false;

    },

    step: function(dt) {

        this.lifetime += dt;

        if (this.lifetime >= this.duration) {

            return this.collection.remove(this);

        }

        if (!this.hidden && Utils.interval(this, "spawn", this.interval))
            this.spawn();

        if (this.speed) {

            this.x += Math.cos(this.direction) * this.speed * dt;
            this.y += Math.sin(this.direction) * this.speed * dt;

        }

    },

    kill: function() {

        if (this._remove)
            return;

        this.collection.remove(this);

    },

    spawn: function() {

        this.onspawn();

    }

};

/* file: script/entities/Wave.js */

CLIENT.Wave = function(args) {

    this.random = Math.random();
    Object.assign(this, args);

    this.update(this.shared);

    this.x = this.shared.x;
    this.y = this.shared.y;
    this.z = 0;

    this.emitter = this.collection.add("ParticleEmitter", {
        x: this.shared.x,
        y: this.shared.y,
        zIndex: 1,
        duration: this.shared.duration,
        direction: this.shared.direction,
        speed: this.shared.speed,
        interval: 0.04
    });

    this.emitter.hide();

    this.emitter.onspawn = function() {

        if (app.game.canDoodle()) {

            var sprite = this.collection.add("Sprite");

            sprite.setDuration(0, 0.8, 0);
            sprite.doodle = true;

            sprite.zIndex = 1;

            var mod = 1 - this.lifetime / this.duration;

            sprite.color = "#fff";
            sprite.x = this.x;
            sprite.y = this.y;
            sprite.scale = Utils.randomf(0.8, 1.6);
            sprite.offsetY = Math.sin(app.lifetime * 16) * 4;
            sprite.blendMode = "add";
            // sprite.blendMode = "lighter";
            // sprite.alpha = 0.6 * mod;    
            sprite.row = Utils.dirrow(this.direction, 24);

            sprite.set("hit_wave", false);

            app.tween(sprite).to({
                alpha: 0
            }, sprite.loopDuration);

        }

    }
    ;

    this.emitter.renderStains = function() {

        let gl = app.gl;

        // let aspectX = this.game.stainsBuffer.scaleX;
        // let aspectY = this.game.stainsBuffer.scaleY;

        let aspectX = this.game.stainsBuffer.width / (this.game.innerWidth * 2);
        let aspectY = this.game.stainsBuffer.height / (this.game.innerHeight * 2);

        let x = (this.game.width + this.x) * aspectX + Utils.random(-4, 4);
        let y = (this.game.height + this.y) * aspectY + Utils.random(-4, 4);
        let stain = app.atlas["splats/mud" + Utils.random(1, 3)];
        let progress = (this.lifetime / this.duration);
        let scale = 0.25 * (0.5 + 0.5 * progress) * Utils.randomf(0.9, 1.1);

        app.painter.reset();

        // app.painter.rotate(this.direction + Utils.randomf(-0.5, 0.5))

        app.painter.blend(gl.FUNC_ADD, gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE)
        app.painter.rotate(Math.random() * 6)
        app.painter.alpha(0.25);
        app.painter.scale(aspectX * scale, aspectY * scale);
        app.painter.drawImageRegion(stain.texture, ...stain.region, x, y);

    }
    ;

    this.sounds = [];

}
;

CLIENT.Wave.prototype = {

    zIndex: 2,

    shape: CLIENT.CIRCLE,

    radius: 6,

    construct: CLIENT.Wave,

    _destruct: function() {

        this.emitter.kill();

    },

    enterview: function() {

        this.sounds.push(app.sound.play("martial/wave").rate(0.2).volume(2.0), app.sound.play("martial/wave").rate(0.4).volume(2.0), app.sound.play("martial/wave").rate(0.6).volume(2.0));

        this.emitter.show();

    },

    update: function(data) {

        Object.assign(this.shared, data);

        if (data.remove) {

            this.collection.remove(this);

        }

    },

    render: function() {
    // app.layer.fillStyle("#000").fillRect(this.shared.x, this.shared.y, 4, 4);

    },

    step: function(dt) {

        this.lifetime += dt;

        for (var sound of this.sounds)
            sound.gpan(this.emitter);

    }

};

/* file: script/entities/Animal.js */

CLIENT.Animal = function(args) {

    Object.assign(this, {

        x: 0,
        y: 0,
        lifetime: Math.random(),
        scaleX: 1.0,
        scaleY: 1.0,
        chirpInterval: Math.random() * 3,
        lifespan: 0

    }, args);

    this.animation = new CLIENT.Animation({
        shadow: true,
        zIndex: this.zIndex
    });

    this.state = new CLIENT.StateManager(this,CLIENT.Animal);

    this.sprite = new CLIENT.Sprite("duckling_run");

    this.sprite.set("duckling_run");

    this.update(args.shared);

    this.x = this.shared.x;
    this.y = this.shared.y;

}
;

CLIENT.Animal.prototype = {

    zIndex: 2,

    shape: CLIENT.CIRCLE,

    radius: 2,

    update: function(data) {

        Object.assign(this.shared, data);

        app.tween(this).to({

            x: this.shared.x,
            y: this.shared.y

        }, COMMON.SHARE_INTERVAL * 2, "linear");

        if (data.remove) {

            this.lifespan = Math.random();

        }

        if (data.state) {

            this.state.set(data.state);

        }

        if (data.direction !== undefined) {

            var fo = -0.2;

            var dirrow = (Utils.circWrap(data.direction - fo) / Math.TAU) * this.sprite.data.rows | 0;

            this.sprite.row = dirrow;

        }

    },

    poke: function(duration, delay) {

        duration = duration || this.animation.duration;

        var tween = app.tween(this);

        if (delay)
            tween.delay(delay);

        tween.to({
            scaleY: 0.75,
            scaleX: 1.25
        }, duration * 0.25, "outSine").to({
            scaleY: 1.0,
            scaleX: 1.0
        }, duration * 0.5, "outElastic");

    },

    step: function(dt) {

        this.lifetime += dt;

        this.state.step(dt);

        this.sprite.step(dt);

        if (false && Utils.timer(this, 0.5)) {

            this.collection.add("Footprint", {
                x: this.x - 5,
                y: this.y - 4,
                rotation: 0
            });

            this.collection.add("Footprint", {
                x: this.x + 5,
                y: this.y - 4,
                rotation: 0
            });

        }

        if (this.inView && Utils.interval(this, "chirp", this.chirpInterval)) {

            app.sound.play("chicken/" + Utils.random(1, 3)).rate(0.8 + Math.random() * 0.5).pan(Utils.randomf(-0.6, 0.6));

            this.chirpInterval = 0.5 + Math.random() * 4;

        }

        if (this.lifespan) {
            this.lifespan -= dt;

            if (this.lifespan <= 0) {

                this.collection.remove(this);

                if (this.inView) {

                    app.sound.play("pop").rate(1.0).rrate(0.25).gpan(this);

                    var sprite = this.collection.add("Sprite");

                    sprite.zIndex = 2;
                    // sprite.color = this.color;
                    sprite.x = this.x;
                    sprite.y = this.y;
                    sprite.color = Math.random() > 0.5 ? "#fbf236" : "#df7126";
                    sprite.scale = 1.0;
                    sprite.set("debris", false);
                    // sprite.rotation = Math.random() * 6;
                    sprite.delay = Math.random() * 0.5;
                    sprite.setDuration(0.25 + Math.random() * 0.75);

                }

            }
        }

    },

    prerender: function() {

        this.animation.prerender();

    },

    render: function(layer) {

        return;

        /*layer.save();
    layer.translate(this.x, this.y);
    layer.scale(1.0, 0.6);
    layer.fillStyle("rgba(0,0,0,0.1)").fillCircle(0, 0, 4);
    layer.restore();
*/
        this.sprite.x = this.x;
        this.sprite.y = this.y - Utils.saw(this.lifetime % 0.3 / 0.3) * 4;

        this.sprite.render(layer);

        /*
        this.animation.x = this.x;
        this.animation.y = this.y;
        this.animation.scaleX = this.scaleX;
        this.animation.scaleY = this.scaleY;


        this.animation.render(dt);
    */
    }

};

/* file: script/entities/Animal.states.js */

CLIENT.Animal.idle = {

    enter: function(animal) {

        animal.animation.then("DEER_IDLE", CLIENT.Animation.LOOP);

    }

};

CLIENT.Animal.alert = {

    enter: function(animal) {

        animal.poke(0.5);

        animal.animation.set("DEER_ALERT");

        app.sound.play("deer/alert").rate(1.5).rrate(0.25);

    },

    leave: function(animal) {

        animal.animation.set("DEER_ALERT", {

            reverse: true

        });

    }

};

CLIENT.Animal.running = {

    enter: function(animal) {

        animal.animation.then("DEER_TO_RUNNING");

        animal.animation.then("DEER_RUNNING", CLIENT.Animation.LOOP);

        app.sound.play("deer/run_growl").rate(1.5).rrate(0.25);
        app.sound.play("deer/run_whoosh");

    },

    step: function(animal, manager) {

        if (manager.elapsed > 0.5 && Utils.interval(animal, "footsound", 0.5)) {

            app.sound.play("deer/foot");

            var s = animal.collection.add("Animation");

            s.set("PUFF", {

                // attachedTo: animal,
                direction: Math.PI,
                velocity: 50,
                x: animal.x,
                y: animal.y,
                auto: true,
                color: Utils.random(CLIENT.DUST_CLOUD_COLORS),
                duration: Utils.randomf(0.5, 1.0),
                zIndex: animal.zIndex + 1,
                shadow: true,
                alpha: 0.5,
                scaleX: Utils.randomf(0.5, 1.0),
                scaleY: 0.5

            });
        }

    },

    leave: function(animal) {

        animal.animation.set("DEER_TO_RUNNING", {
            reverse: true
        });

        app.sound.play("deer/stop").rate(1.5).rrate(0.25).volume(0.5);

    }

};

/* Duckling */

CLIENT.Animal.duckling_idle = {

    enter: function(animal) {

        console.log("I AM AN IDLE DUCKLING")

        // animal.animation.then("DEER_IDLE", CLIENT.Animation.LOOP);
        animal.sprite.set("duckling_run", true);

        animal.sprite.lifetime = Math.random();

        // animal.sprite.scaleX = 0.6;
        // animal.sprite.scaleY = 0.6;

    }

};

/* file: script/entities/Footprint.js */

CLIENT.Footprint = function(args) {
}
;

CLIENT.Footprint.prototype = {

    doodle: true,

    duration: 2.0,

    zIndex: 1,

    radius: 4,

    shape: CLIENT.CIRCLE,

    reset: function(args) {

        this.scale = 1.0;
        this.x = 0;
        this.y = 0;
        this.z = 0;
        this.lifetime = 0;
        this.rotation = 0;

        Object.assign(this, args);

    },

    step: function(dt) {

        this.lifetime += dt;

        if (this.lifetime >= 2)
            this.collection.remove(this);

    },

    render: function() {

        app.painter.reset();
        app.painter.align(0, 0);
        app.painter.drawImageRegion(app.textures.footprints, this.x, this.y);

    }

};

/* file: script/entities/Campfire.js */

CLIENT.Campfire = function(args) {

    this.x = 0;
    this.y = 0;

    Object.assign(this, args);

    this.update(this.shared);

    this.fire = new CLIENT.Sprite;
    this.fire.set("campfire", true);
    this.fire.setDuration(2);
    this.fire.blendMode = "hard-light";

    this.smoke = new CLIENT.Sprite;
    this.smoke.set("campfire_smoke", true);
    this.smoke.setDuration(2);

    this.maxHealth = 100;

    this.scale = 0;

}
;

CLIENT.Campfire.prototype = {

    zIndex: 2,

    shape: CLIENT.CIRCLE,

    radius: 8,

    baseSprite: [244, 299, 34, 28],

    enterview() {
    },

    leaveview() {

        if (this.sound) {

            this.sound.stop();
            this.sound = null;

        }

    },

    update: function(data) {

        if (data.x !== undefined)
            this.x = data.x;
        if (data.y !== undefined)
            this.y = data.y;

        if (data.health > this.shared.health) {

            this.fuelUp();

        }

        Object.assign(this.shared, data);

    },

    fuelUp() {

        if (!this.inView)
            return;

        app.sound.play("flame").fadeOut(1.0).rate(1.6).nrate(0.2).gpan(this);

        let fire = this.collection.add("Sprite");

        fire.set("campfire", true);
        fire.setDuration(1.0);
        fire.blendMode = "lighter";
        fire.lifespan = 2.0;
        fire.scale = 0.5 + this.scale;
        fire.x = this.x;
        fire.y = this.y;
        fire.zIndex = 3;

        app.tween(fire).to({
            alpha: 0.0
        }, 2.0);

    },

    step: function(dt) {

        if (this.inView) {

            if (this.sound) {

                if (this.shared.health <= 0) {

                    this.sound.stop();
                    this.sound = null;

                } else {

                    this.sound.gpan(this);
                    this.sound.rate(1.25 - (this.shared.health / this.maxHealth) * 0.4);
                    this.sound.volume((this.shared.health / this.maxHealth) * 0.25);

                }

            } else {

                if (this.shared.health > 0) {

                    this.sound = app.sound.play("flame").loop().rate(1.5);

                }

            }

        } else if (this.sound) {

            this.sound.stop();
            this.sound = null;

        }

    },

    render: function(layer) {

        this.scale = (this.shared.health / this.maxHealth) * 2.5;

        this.fire.scale = this.scale;
        this.smoke.scale = this.scale;

        app.painter.reset();

        app.painter.align(0.5, 0.5);

        app.painter.drawImageRegion(app.textures.randoms, ...this.baseSprite, this.x, this.y);

        app.painter.align(0, 0);

        this.smoke.step(app.elapsed);
        this.smoke.render(app.painter, this.x, this.y);

        this.fire.step(app.elapsed);
        this.fire.render(app.painter, this.x, this.y);

        if (this.game.playerInRange(this)) {

            app.painter.reset();
            app.painter.drawAtlas("ui/action_circle_neutral", this.x, this.y - 60);
            app.painter.drawSprite("pickups/wood", this.x, this.y - 60, 0, app.lifetime * 6);

        }

    }

};

/* file: script/entities/Wall.js */

CLIENT.Wall = function(args) {

    Object.assign(this, args);

    this.z = 0;

}
;

CLIENT.Wall.prototype = {

    zIndex: 2,

    step: function(dt) {
    },

    render: function() {

        app.layer.drawImage(app.images.tilesets.frame, this.tile * 16, 0, 16, 16, this.x, this.y - 24, 16, 16);
        // app.layer.font("16px arial").fillStyle("#f00").fillText(this.count, this.x + 8, this.y - 16);
    }

};

/* file: script/entities/Javelin.js */

CLIENT.Javelin = function(args) {

    this.x = 0;
    this.y = 0;
    this.z = 8;

    Object.assign(this, args);

    this.animation = this.collection.add("Animation", {
        attachedTo: this,
        shadow: true
    });

    var angle = Utils.lookAt(this.x, this.y, this.targetX, this.targetY);
    var facing = Utils.circWrap(angle + Math.QPI) / Math.HPI | 0;
    var facingKey = ["RIGHT", "DOWN", "LEFT", "UP"][facing];

    var shadowRotation = Math.QPI;
    var duration = 0.5;
    var rotation = 0;

    if (facingKey === "UP") {
        shadowRotation = +Math.QPI + 0.15;

        // rotation = angle - Math.PI * 1.5;

        // shadowRotation = -rotation + Math.HPI * (angle - Math.PI * 1.25) / Math.HPI;

    } else if (facingKey === "LEFT") {
        // rotation = Math.QPI;
        shadowRotation = 0.4;

        // shadowRotation = -rotation + Math.HPI * (angle - Math.PI * 1.25) / Math.HPI;
    } else if (facingKey === "RIGHT") {

        shadowRotation = -0.4;
    } else if (facingKey === "DOWN") {

        shadowRotation = -0.4;
    }

    this.animation.set("JAVELIN_" + facingKey, {
        duration: duration,
        shadowRotation: shadowRotation,
        zIndex: this.zIndex
    });

    app.tween(this.animation).to({// shadowRotation: Math.QPI
    }, duration)

    app.tween(this).to({
        x: this.targetX,
        y: this.targetY
    }, duration, "linear").on("finish", this.onfinish.bind(this));

    app.tween(this).to({
        z: 24
    }, duration * 0.5, "outQuad").to({
        z: 0
    }, duration * 0.5, "inQuad");

    app.sound.play("javelin_throw").rrate(0.25);

}
;

CLIENT.Javelin.prototype.zIndex = 2;

CLIENT.Javelin.prototype.onfinish = function() {

    app.tween(this.animation).to({
        frame: 15
    }, 0.2, "outQuad").to({
        frame: 8
    }, 0.4, "outBounce");

    app.sound.play("arrow_rattle").rrate(0.25);
    app.sound.play("javelin_hit").rrate(0.25).volume(1.5);

    var s = this.collection.add("Animation");

    s.set("PUFF", {

        attachedTo: this,
        auto: true,
        color: Utils.random(CLIENT.DUST_CLOUD_COLORS),
        duration: 0.5,
        zIndex: this.zIndex - 1,
        shadow: true,
        scaleY: 0.2,
        scaleX: 0.2
    });

}
;

CLIENT.Javelin.prototype.step = function() {
}
;

CLIENT.Javelin.prototype.render = function() {
// app.layer.fillStyle("#000").fillRect(this.x, this.y - this.z, 2, 2);

}
;

/* file: script/entities/Tree.js */

CLIENT.Tree = function(args) {

    Object.assign(this, {
        x: 0,
        y: 0,
    }, args);

    this.shake = 0;
    this.sprite = new CLIENT.Sprite;
    this.update(this.shared);

    if (this.shared.health <= 0)
        this.sprite.unpause();

    this.sprite.set(this.shared.pine ? "pine_fall" : "tree_fall");
    this.sprite.pause();
    this.sprite.row = Utils.random(0, 7);
    this.sprite.easing = "inSine";

}
;

CLIENT.Tree.prototype = {

    zIndex: 2,

    shape: CLIENT.CIRCLE,
    radius: 4,
    groups: ["radar"],
    marker: "tree",
    _destruct: function() {
    },

    onhit: function(data) {

        if (this.inView) {

            app.sound.play("woodcut").rrate(0.25).gpan(this);

            var s = this.collection.add("Sprite");

            s.set("debris");

            s.x = this.x;
            s.y = this.y;
            s.z = 10;
            s.color = "#840";
            s.duration = 1.0;

            this.shake = 0.5;

            app.tween(this.sprite).discard().to({
                scale: 1.2
            }, 0.1).to({
                scale: 1.0
            }, 0.4, "outElastic");

        }

    },

    update: function(data) {

        if (data.x !== undefined)
            this.x = data.x;
        if (data.y !== undefined)
            this.y = data.y;

        if (data.health !== undefined) {

            if (data.health < this.shared.health) {

                this.onhit();

                if (data.health <= 0)
                    this.fall();

            }

            if (data.health > 0 && this.shared.health <= 0)
                this.respawn();

        }

        if (data.remove) {

            this.collection.remove(this);

        }

        if (data.pine !== undefined) {

            this.sprite.set(data.pine ? "pine_fall" : "tree_fall");

        }

        Object.assign(this.shared, data);

    },

    fall() {

        this.zIndex = 0;

        this.sprite.unpause();

        if (this.inView) {

            app.sound.play("axe/hit").rate(0.7).gpan(this);
            app.sound.play("impact/wood").rate(0.8).gpan(this);
            app.sound.play("tree_fall_short").delay(0.25).gpan(this);

            var s = this.collection.add("Sprite");

            s.set("fx/slash_punch");

            s.x = this.x;
            s.y = this.y;
            s.z = 10;
            s.zIndex = 3;
            s.duration = 0.4;

            var s = this.collection.add("Sprite");

            s.set("blood_explosion");

            let angle = this.sprite.row * (Math.TAU / 8);

            s.x = this.x + Math.cos(angle) * 30;
            s.y = this.y + Math.sin(angle) * 30;
            s.z = 8;
            s.delay = 0.6;
            s.scale = 1.2;
            s.scaleY = 0.8;
            s.zIndex = 3;
            s.color = "#840";
            s.duration = 0.5;

        }

    },

    respawn() {

        this.sprite.set(this.shared.pine ? "pine_fall" : "tree_fall");
        this.sprite.pause();
        this.zIndex = 2;

    },

    step: function(dt) {

        this.lifetime += dt;

        this.sprite.step(dt);

    },

    render: function(layer) {

        let o = 0;

        this.sprite.render(layer, this.x + o, this.y + o);

        if (this.game.playerInRange(this) && this.shared.health > 0) {

            app.painter.reset();
            app.painter.drawAtlas("ui/action_circle_neutral", this.x, this.y - 60);
            app.painter.palette(0);
            app.painter.scale(0.5, 0.5)
            app.painter.drawSprite("equipment/axe_turntable", this.x, this.y - 68, app.lifetime * 12, 0);

        }

    }

};

/* file: script/entities/Mine.js */

CLIENT.Mine = function(args) {

    Object.assign(this, {

        x: 0,
        y: 0,
        z: 0,
        lifetime: 0,
        random: Math.random()

    }, args);

    this.update(this.shared);

    this.sprite = new CLIENT.Sprite();
    this.sprite.set("pickups/mine", true);
    this.sprite.rotation = -Math.PI * 0.5;

    this.blinkState = false;

}
;

CLIENT.Mine.prototype = {

    zIndex: 2,

    shape: CLIENT.CIRCLE,

    radius: 6,

    sprite: [6, 27, 11, 11],

    _destruct: function() {

        if (!this.inView)
            return;

        if (this.shared.exploded) {

            this.game.add("GroundExplosion", {
                duration: 0.25,
                radius: 120,
                x: this.x,
                y: this.y
            });

            app.game.camera.shake(2, 0.5);

            for (var i = 0; i < 1; i++) {

                var sprite = this.collection.add("Sprite");

                sprite.zIndex = 3;
                sprite.x = this.x;
                sprite.y = this.y;
                sprite.scale = 1.5;
                sprite.set("heavy_explosion", false);
                sprite.loopDuration = 1.5;

            }

            app.sound.play("explosions/heavy").rrate(0.2).gpan(this);

        }

    },

    update: function(data) {

        Object.assign(this.shared, data);

        if (data.x !== undefined || data.y !== undefined) {

            this.x = this.shared.x;
            this.y = this.shared.y;

            this.z = 20;

            app.tween(this).to({
                z: 50,
            }, 0.4, "outQuad").to({
                z: 0
            }, 0.8, "outBounce");

        }

        if (data.remove !== undefined && data.remove) {

            this.collection.remove(this);

        }

    },

    enterview: function() {
    // app.sound.play("monster/growl" + Utils.random(1, 2));
    // app.sound.play("goblin/angry").rate(1.4).rrate(0.3);

    },

    step: function(dt) {

        this.lifetime += dt;

        if (this.inView) {

            if (Utils.interval(this, "tick", Math.max(0.25, this.shared.timeout - this.lifetime) / 4)) {

                app.sound.play("weapons/tick").gpan(this);

                this.blinkState = !this.blinkState;

                this.sprite.updateColor(this.blinkState ? "#a00" : false);

            }

        }

        this.sprite.step(dt * 3);

        if (this.z < 6) {
            this.sprite.paused = true;
            this.sprite.setFrame(1);
        }

    },

    prerender: function() {
    },

    render: function(layer) {

        app.painter.reset();
        app.painter.color(0x000000, 0.2);
        app.painter.fillCircle(this.x, this.y, this.radius);

        app.painter.color(0xff0000, 0.2);
        app.painter.fillCircle(this.x, this.y, this.shared.range);

        this.sprite.render(layer, this.x, this.y - this.z);

        return;
        layer.save();
        layer.translate(this.x, this.y);
        layer.scale(1.0, 1.0);
        layer.fillStyle("rgba(0,0,0,0.2)").fillCircle(0, 0, this.radius);

        layer.fillStyle("#f00");
        // layer.strokeStyle("#a00").setLineDash([10, 10]).lineWidth(2).strokeCircle(0, 0, this.shared.range);
        layer.a(0.1).fillStyle("#a00").fillCircle(0, 0, this.shared.range);
        layer.restore();

        this.sprite.render(layer, this.x, this.y - this.z);
        // layer.drawRegionCentered(app.images.pickups, this.sprite, this.x, this.y - this.z);

    }

};

/* file: script/entities/Tree.states.js */

CLIENT.Tree.standing = {

    step: function(subject, manager, dt) {

        if (subject.shake > 0) {

            subject.shake -= dt;

            // ox = Utils.saw(subject.shake % 0.1 / 0.1) * 1;

            var amplitude = subject.shake / subject.shakeDuration;

            subject.rotation = (Utils.saw(subject.shake % 0.25 / 0.25) - 0.5) * amplitude * 0.3;

        }

    }

};

CLIENT.Tree.squeak = {

    enter: function(subject, manager) {

        subject.shake = 0;

        app.sound.play("tree_fall");

        subject.rotation = 0;

        app.tween(subject).to({
            rotation: 0.2 + "rad"
        }, app.data.animations.TREE_SQUEAK.duration * 0.3, "linear").to({
            rotation: 0.5 + "rad"
        }, app.data.animations.TREE_SQUEAK.duration * 0.7, "linear");
    }

};

CLIENT.Tree.falling = {

    enter: function(subject, manager) {

        app.tween(subject).to({
            rotation: Math.HPI + "rad",
            offset: 8
        }, app.data.animations.TREE_FALL.duration, "inCubic").once("finish", function() {// manager.set("fallen");
        });

        if (manager.elapsed >= 0.4)
            manager.set("fallen");

    },

    leave: function(subject, manager) {

        for (var i = 0; i < 6; i++) {

            var s = subject.collection.add("Animation");

            s.set("SMOKE_PUFF", {
                alpha: 0.8,
                x: subject.x + 36 * i / 6,
                y: subject.y + 10,
                alignY: 1.0,
                auto: true,
                scale: Utils.randomf(0.25, 0.5),
                color: Utils.random(CLIENT.DUST_COLORS),
                duration: Utils.randomf(0.5, 3.5),
                zIndex: subject.zIndex + 1,
                delay: 0.05 * i
            });

        }

    }

};

CLIENT.Tree.fallen = {

    enter: function(subject) {

        subject.fall();

    }

};

CLIENT.Tree.removing = {

    enter: function(subject) {

        app.sound.play("wood_split").rrate(0.25);

        for (var i = 0; i < 6; i++) {

            var s = subject.collection.add("Animation");

            s.set("SMOKE_PUFF", {
                alpha: 0.8,
                x: subject.x + 36 * i / 6,
                y: subject.y + 10,
                alignY: 1.0,
                auto: true,
                scale: Utils.randomf(0.25, 0.5),
                color: Utils.random(CLIENT.DUST_COLORS),
                duration: Utils.randomf(0.5, 3.5),
                zIndex: subject.zIndex + 1,
                delay: 0.05 * i
            });

        }
    }
}

/* file: script/main.js */

if (window.location.hostname.indexOf("www") > -1)
    window.location = "http://wilds.io";
if (window.location.href.indexOf("localhost") < 0 && window.location.protocol.indexOf("https") === -1)
    window.location = window.location.href.replace("http", "https");

var LOCALHOST = window.location.hostname === "localhost";

COMMON.COUNTRY_INDEX = {};

var uaparser = new UAParser();

for (var i = 0; i < COMMON.COUNTRIES.length; i++)
    COMMON.COUNTRY_INDEX[COMMON.COUNTRIES[i]] = i;

cq.textBaseline = "top";

var $_GET = {};

window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m, key, value) {

    $_GET[key] = value;

});

// if ($_GET.length === 0 && Math.random() > 0.95) window.location = "http://mechar.io?ref=wildsiolocation";

var $_HASH = {};

window.location.hash.replace(/[#&]+([^=&]+)=([^&]*)/gi, function(m, key, value) {

    $_HASH[key] = value;

});

window.location.hash = "";

var appConfig = {

    background: false,

    user: {
        guest: true
    },

    altport: $_GET.altport,

    smoothing: false,

    ads: ENV.ads,
    iaps: ENV.iaps,

    empty: {},

    // scale: 2,
    // purgeCache: true,

    frameskip: 0,

    options: {

        ingame_chat: window.innerWidth > 1200,
        fps_60: true,
        gender: 0,
        wait_in_lobby: false

    },

    url: function(link) {

        return window.location.origin + location.pathname + link;

    },

    controls: {
        "up": ["w", "gamepadup"],
        "down": ["s", "gamepaddown"],
        "left": ["a", "gamepadleft"],
        "right": ["d", "gamepadright"],
        "attack": ["mouseleft", "gamepad1"],
        "block": ["mousewheeldown", "gamepad2"],
        "roll": ["mousewheelup", "gamepad4"],
        "run": ["mouseright", "gamepad3"],
        "jump": ["space", null],
        "throw_weapon": ["f", "gamepadstick1"],
        "item1": ["1", "gamepadl1"],
        "item2": ["2", "gamepadl2"],
        "item3": ["q", "gamepadr1"],
        "item4": ["e", "gamepadr2"],
        "spell1": ["r", "gamepadstick2"],
        "emote": ["mousemiddle", "t"],
        "help": ["h", "f1"]
    },

    helmetPalettes: {
        0: false,
        1: {

            "#663931": "#9badb7",
            "#8f563b": "#cbdbfc",
            "#cbdbfc": "#8f563b",
            "#9badb7": "#663931",
            "#ac3232": "#595652"

        },

        2: {

            "#663931": "#323c39",
            "#8f563b": "#847e87",
            // "#cbdbfc": "#8f563b",
            // "#9badb7": "#663931",
            // "#ac3232": "#595652"

        },

    },

    shieldPalettes: {
        0: false,
        1: {
            "#663931": "#9badb7",
            "#8f563b": "#cbdbfc",
            "#9badb7": "#cbdbfc",
            "#cbdbfc": "#ebf0f8"

        },
        2: {
            "#663931": "#222034",
            "#8f563b": "#847e87",
        }
    },

    palettes: {

        0: false,

        1: {

            "#663931": "#9badb7",
            "#45283c": "#847e87",
            "#8f563b": "#cbdbfc",
            "#cbdbfc": "#8f563b",
            "#9badb7": "#663931",
            // "#df7126": "#37946e",
            // "#ac3232": "#4b692f"
            "#df7126": "#696a6a",
            "#ac3232": "#595652"

        },

        2: {

            "#663931": "#323c39",
            "#8f563b": "#847e87",
            "#df7126": "#fbf236",
            "#ac3232": "#df7126"
        }

    },

    red: {

        "#663931": "#9badb7",
        "#45283c": "#847e87",
        "#8f563b": "#cbdbfc",
        "#cbdbfc": "#8f563b",
        "#9badb7": "#663931",
        "#df7126": "#696a6a",
        "#ac3232": "#595652"
    },

    flag_red: {
        "#ac3232": "#9badb7",
        "#8f563b": "#222034"
    },

    initNGon(sides) {

        let gl = this.gl;

        if (!this.ngons)
            this.ngons = Object.create(null);

        let temp = [];

        let angleStep = Math.TAU / sides;

        for (var i = 0; i < sides; i++) {

            temp.push(0.5 + Math.cos(i * angleStep) * 0.5, 0.5 + Math.sin(i * angleStep) * 0.5);

        }

        let vertices = new Float32Array(temp);

        let meshBuffer = gl.createBuffer();
        let indicesBuffer = gl.createBuffer();

        let indices = new Uint16Array(earcut(temp));

        indicesBuffer.count = indices.length;

        gl.bindBuffer(gl.ARRAY_BUFFER, meshBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);

        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indicesBuffer);
        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, indices, gl.STATIC_DRAW);

        this.ngons[sides] = {
            mesh: meshBuffer,
            indices: indicesBuffer
        };

    },

    happyTime() {
    },

    showHelp() {

        UI.iframeWindow("HELP", "<iframe src='tutorial/' class='full'></iframe>");

    },

    eventGameplayStart() {},
    eventGameplayStop() {},

    preload() {

        document.body.classList.toggle("loading", true);

        this.dataSource = window.JSONS || {};

        this.loadData("<textures/atlas.json> atlas");

    },

    create: function() {

        this.cq = cq(1, 1);

        this.iog = new InstantOnlineGaming();

        this.paths.rewriteURL = window.REWRITE_URL ? window.REWRITE_URL : {};

        this.canvas = document.createElement("canvas");

        this.canvas.style.left = "0px";
        this.canvas.style.top = "0px";
        this.canvas.style.position = "absolute";
        this.canvas.style.background = "#000";
        this.canvas.width = window.innerWidth / 2 | 0;
        this.canvas.height = window.innerHeight / 2 | 0;
        this.canvas.classList.toggle("main", true);
        this.canvas.style.display = "none";

        document.body.appendChild(this.canvas);

        this.gl = this.canvas.getContext('webgl', {
            alpha: true,
            antialias: false,
            premultipliedAlpha: true,
            depth: false,
            stencil: false
        });

        let gl = this.gl;

        this.painter = new PLAYGROUND.Painter(this);

        gl.disable(gl.DEPTH_TEST);

        this.loadImage("<textures/spritesheet.png> spritesheet");

        this.loadTexture("spritesheet");
        this.loadTexture("palette");

        this.loadProgram("sprite", "sprite_vertex", "sprite_fragment");
        this.loadProgram("tiling_image", "image_vertex", "tiling_image_fragment");
        this.loadProgram("shade", "sprite_vertex", "shade_fragment");
        this.loadProgram("polygon", "polygon_vertex", "polygon_fragment");
        this.loadProgram("gui", "gui_vertex", "gui_fragment");
        this.loadProgram("text", "gui_vertex", "text_fragment");
        this.loadProgram("circle", "circle_vertex", "circle_fragment");
        this.loadProgram("eclipse", "rect_vertex", "eclipse_fragment");
        this.loadProgram("rect", "rect_vertex", "rect_fragment");

        /* Init gl helpers */

        this.initNGon(4);
        this.initNGon(8);
        this.initNGon(16);
        this.initNGon(24);
        this.initNGon(32);

        {

            let vertices = new Float32Array([0.0, 0.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 0.0, 0.0]);

            let meshBuffer = gl.createBuffer();

            gl.bindBuffer(gl.ARRAY_BUFFER, meshBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);

            this.quad = meshBuffer;

        }

        /* -- */

        this.ad = new PLAYGROUND.Ad();
        this.ad.threshold = 3;

        let lang = String(navigator.language).substr(0, 2).toLowerCase();

        if (this.languages.indexOf(lang) > -1)
            this.language = lang;

        if ($_HASH.lang)
            this.language = $_HASH['lang'];

        // this.language = "fr";

        this.emitter = new Emitter;

        if (this.altport)
            console.warn("altport is enabled by default");

        this.ref = $_GET['ref'] || "";

        // this.createBitset();

        this.sound = this.audio.channel("sound");

        // this.sound.volume(0);

        // this.sound.play("wind").loop().volume(0.3);
        // this.sound.play("music/world").loop().volume(0.6).rate(1.0);

        // this.bgmusic = this.sound.play("background/groovy_battle").loop().volume(0.4).rate(1.0).volume(0);

        // this.loadFont("neoletters");

        this.loadData("<common/data/minions.json> minions");
        this.loadData("<common/data/items.json> items");
        this.loadData("<common/data/animations.json> animations");
        this.loadData("<common/data/crates.json> crates");
        this.loadData("<common/data/skills.json> skills");
        this.loadData("<common/data/stones.json> stones");
        this.loadData("<common/data/shared.json> shared");
        this.loadData("<common/data/projectiles.json> projectiles");
        this.loadData("<common/data/randoms.json> randoms");
        this.loadData("<common/data/badges.json> badges");

        this.loadData("<common/maps/tileset.json> tileset");
        this.loadData(`<lang/${this.language}.json> language`);
        this.loadData(`<lang/en.json> en`);
        this.loadData("flags64");

        this.loadData("<templates/tribe_bulletin.css> css/tribe_bulletin");
        this.loadData("<templates/html/lobby_play.html> html/lobby_play");
        this.loadData("<templates/html/armory.html> html/armory");
        this.loadData("<templates/html/respawn.html> html/respawn");
        this.loadData("<templates/html/help.html> html/help");
        this.loadData("<templates/html/lobby_chat.html> html/lobby_chat");
        this.loadData("<templates/html/leaderboards.html> html/leaderboards");
        this.loadData("<templates/html/training.html> html/training");
        this.loadData("<templates/html/acks.html> html/acks");
        this.loadData("<templates/html/tribe.html> html/tribe");
        this.loadData("<templates/html/tribe_members.html> html/tribe_members");
        this.loadData("<templates/html/tribe_kicked.html> html/tribe_kicked");
        this.loadData("<templates/html/tribe_admin.html> html/tribe_admin");
        this.loadData("<templates/html/tribe_map.html> html/tribe_map");
        this.loadData("<templates/html/public_tribes.html> html/public_tribes");
        this.loadData("<templates/html/tribe_create.html> html/tribe_create");
        this.loadData("<templates/html/tribe_bulletin.html> html/tribe_bulletin");
        this.loadData("<templates/html/tribe_edit_bulletin.html> html/tribe_edit_bulletin");
        this.loadData("<templates/html/quick_news.html> html/quick_news");
        this.loadData("<templates/html/mode_fun.html> html/mode_fun");
        this.loadData("<templates/html/mode_deathmatch.html> html/mode_fun2");
        this.loadData("<templates/html/mode_battle_royale.html> html/mode_battle_royale");
        // this.loadData("<templates/html/mode_ctf.html> html/mode_ctf");
        this.loadData("<templates/html/mode_soccer.html> html/mode_soccer");
        this.loadData("<templates/html/mode_arena1.html> html/mode_arena1");
        this.loadData("<templates/html/mode_graveyard.html> html/mode_graveyard");
        this.loadData("<templates/html/mode_arena2.html> html/mode_arena2");
        // this.loadData("<templates/html/mode_graveyard.html> html/mode_graveyard");
        this.loadData("<templates/html/mode_practice.html> html/mode_practice");

        this.loadImages("rank_icons", "history_map", "history_map_mask", "ditherlight");

        /*
         for (var i = 0; i < COMMON.COUNTRIES.length; i++) {

            var country = COMMON.COUNTRIES[i];

            this.loadImages("flags/" + country)

        }*/

        this.sprites = {};
        this.loadAtlas("<textures/atlas.json> atlas");

        this.loadTexture("tile_grass");
        this.loadTexture("tile_desert");
        this.loadTexture("tile_snow");

        this.loadTexture("<textures/tile_new.png> tile_new");
        this.loadTexture("flags64");

    },

    language: "en",
    languages: ["en", "pl", "fr", "tr"],

    lang: function(key) {

        return this.data.language[key] || this.data.en[key] || key;

    },

    promises: [],
    _cache: {},

    cache(name, value) {

        if (arguments.length === 1) {

            return this._cache[name];

        } else {

            return this._cache[name] = value;

        }

    },

    promise() {

        let resolve, reject;

        let promise = new Promise(function(_resolve, _reject) {

            resolve = _resolve;
            reject = _reject;

        }
        );

        promise.resolve = resolve;
        promise.reject = reject;

        return promise;
    },

    async loadAtlas(path, prefix="") {

        if (!this.atlas)
            this.atlas = {};

        let entry = this.getAssetEntry(path, "atlas", "json");
        // app.insertAsset(json, app.sprites, key);

        let json = JSON.parse((await this.request(entry.url)).responseText);

        /* Load textures */

        let loaders = [];

        this.loader.add();

        for (let image of json.images) {

            loaders.push(this.loadTexture(image.src));

        }

        Promise.all(loaders).then(()=>{

            for (let sprite_key in json.sprites) {

                let sprite = json.sprites[sprite_key];
                let src = (json.images[sprite.image].src).split(".").shift();
                sprite.texture = this.textures[src];

            }

            this.loader.success();

            for (let sprite_key in json.sprites) {

                this.insertAsset(json.sprites[sprite_key], this.atlas, prefix ? prefix + "/" + sprite_key : sprite_key);

            }

        }
        );

    },
    /*
    loadAtlas() {

        this.atlas = Object.assign({}, app.data.atlas.sprites);

        let loaders = [];

        this.loader.add();

        for (let image of this.data.atlas.images) {

            loaders.push(this.loadTexture(image.src));

        }

        Promise.all(loaders).then(() => {

            for (let key in this.atlas) {

                let sprite = this.atlas[key];

                sprite.texture = this.textures["atlas_" + sprite.image];

            }

            this.loader.success();

        });

    },
*/
    wsURL(ip, wsPort, wssPort) {

        let url;

        if (location.protocol === "https:") {

            url = "wss://" + ip + (wssPort != 443 ? ":" + wssPort : "");

        } else {

            url = "ws://" + ip + (wsPort != 80 ? ":" + wsPort : "");

        }

        return url;

    },

    loadTextures() {

        for (let i = 0; i < arguments.length; i++) {

            let arg = arguments[i];

            this.loadTexture(arg);

        }

    },

    loadGameSprites: function() {

        if (this.loadGameSpritesPromise)
            return this.loadGameSpritesPromise;

        this.loadFoo(0.1);

        this.loadTexture("<common/maps/1.png> tilesets/1");

        this.loadTexture("<common/maps/2.png> tilesets/2");
        this.loadTexture("<common/maps/3.png> tilesets/3");

        this.loadTexture("pickups");
        this.loadTexture("crates");

        this.loadImages("misc", "flags/all");

        this.loadTextures("fonts/numbers_5px", "ball", "flags/all", "soccer", "thumb", "quicksand", "quicksand_clean");
        this.loadTextures("footprints", "trees", "items", "keys", "ranks", "skills", "guillotine", "spikes", "misc", "rank_icons");
        this.loadTextures("abyss", "pickups", "pedestal", "hud/slots", "markers", "time_belt", "score_belt", "stones", "gui", "ui");
        this.loadTextures("blasts/normal", "blasts/sunken", "blasts/dust");
        this.loadTextures("flag_base", "randoms", "projectiles");

        this.loadTexture("<textures/tile_hell.png> tile_hell");
        this.loadTexture("<textures/tile_pavement.png> tile_pavement");

        return this.loadGameSpritesPromise = new Promise(function(resolve, reject) {

            app.loader.once("ready", function() {

                resolve();

            });

        }
        );

    },

    intColors: {},

    intColor(hex) {

        if (!hex)
            return -1;

        if (!this.intColors[hex]) {

            let rgb = cq.hexToRgb(hex);

            let int = rgb[0] * 65536 + rgb[1] * 256 + rgb[2];

            this.intColors[hex] = int;

        }

        return this.intColors[hex];

    },

    reload: function() {

        window.location = window.location.origin + window.location.pathname;

    },

    ready: function() {

        for (let key in this.data.minions) {

            let kindData;
            let pair = key.split("_");

            if (pair.length) {

                kindData = this.data.minions[pair[0]];
            }

            this.data.minions[key] = Object.assign({}, this.data.minions.default, kindData, this.data.minions[key]);

        }

        this.fonts = {};

        this.fonts.default = new CLIENT.BitmapFont(this.images.spritesheet,[0, 231, 222, 11, "AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTt()[]?"],[0, 243, 222, 11, "UuVvWwXxYyZz0123456789.,|!\"/-+_%*❤Ã┌┐┼"]);
        this.fonts.small = new CLIENT.BitmapFont(this.images.spritesheet,[0, 191, 101, 8, "abcdefghijklmnopqrstuvwxyz"],[0, 201, 180, 8, "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.,!?()[]/:'"]);
        this.fonts.fat = new CLIENT.BitmapFont(this.images.spritesheet,[0, 220, 55, 9, "0123456789"]);
        this.fonts.small_shadeless = new CLIENT.BitmapFont(this.images.spritesheet,[0, 255, 101, 8, "abcdefghijklmnopqrstuvwxyz"],[0, 265, 173, 8, "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.,!?()[]/"]);

        /* containable items */

        this.data.containable_items = [];

        for (var key in this.data.items) {

            if (this.data.items[key].containable)
                this.data.containable_items.push(key);

        }

        /* load controls */

        let controls = localStorage.getItem("controls");

        if (controls) {

            Object.assign(this.controls, JSON.parse(controls));

            if (window.analytics)
                analytics('send', 'event', 'menu', 'custom_controls');

        }

        /* load options */

        let options = localStorage.getItem("options");

        if (options)
            Object.assign(this.options, JSON.parse(options));

        CLIENT.ThrowingKnife.validate();

        this.console = new UI.Console;
        this.notifier = new UI.Notifier;

        if (window != window.top)
            PLAYGROUND.IFRAME = true;

        // if (window != window.top) this.ads = false;

        // if ($_GET['miniclip']) this.ads = true;
        // if ($_GET['spil']) this.ads = true;

        if ($_GET['no_ads'])
            this.ads = true;
        if ($_GET['ref'] === "gamedistribution")
            this.ads = false;
        if ($_GET['ref'] === "gamedistribution")
            this.iaps = false;

        this.game = CLIENT.Game;
        this.lobby = CLIENT.Lobby;

        this.setState(this.lobby);

        setTimeout(function() {

            app.loadGameSprites();

        }, 1000);

        this.probeVolume();

        if (document.getElementById('ads')) {

            if (window.analytics)
                analytics('send', 'event', 'adblock', 'no');

        } else {

            if (window.analytics)
                analytics('send', 'event', 'adblock', 'yes');

            this.adblock = true;

        }

    },

    async probeBestLocation() {

        return new Promise((resolve,reject)=>{

            let resolved = false;

            let servers = {
                US: "wilds149561416.instantonline.io",
                EU: "wilds2133267148.instantonline.io",
                AS: "wilds1399999125.instantonline.io"
            };

            let results = [];

            for (let location in servers) {

                let url = this.wsURL(servers[location], ENV.wsPort, ENV.wssPort);

                let socket = new WebSocket(url);

                socket.addEventListener("open", ()=>{

                    let now = Date.now();

                    socket.send(msgpack.encode(["ping", {}]));

                    socket.addEventListener("message", (event)=>{

                        if (!resolved)
                            return resolve(location);

                        resolved = true;

                        socket.close();

                    }
                    );

                }
                );

            }

        }
        )

    },

    async captcha() {

        let promise = Utils.promise();

        let token = "nhhhh";

        await this.lobby.ask("captcha", {
            token
        });

        promise.resolve();

        return promise;

    },

    probeVolume: function() {

        var vol = localStorage.getItem("volume");

        if (vol === undefined || vol === null) {

            vol = 0.5;

        }

        this.setVolume(parseFloat(vol));

        $("#mute").enhance();

        $("#mute").on("click", function() {

            if (app.volume) {

                app.prevVolume = app.volume;
                app.setVolume(0.0);

            } else {

                if (app.prevVolume)
                    app.setVolume(app.prevVolume);
                else
                    app.setVolume(0.5);

            }

        });

        $("#mute").on("mousewheel", function(e) {

            let delta = e.originalEvent.deltaY;

            app.setVolume(app.volume - (delta / Math.abs(delta) * 0.1));

        });

    },

    setVolume: function(val) {

        val = Utils.limit(val, 0.0, 1.0);

        // We are now only using 0.0 or 1.0
        // But some old users have intermediate values saved

        this.volume = val;

        this.sound.volume(val);

        localStorage.setItem("volume", val);

        $("#mute .volume").css("height", (val * 100) + "%")

        if (val) {

            // $("#mute").toggleClass("primary", true);
            $("#mute").toggleClass("disabled", false);

        } else {

            // $("#mute").toggleClass("primary", false);
            $("#mute").toggleClass("disabled", true);

        }

        this.sound.muteWith(val ? false : "empty");

    },

    createBitset: function() {

        var temp = cq(16 * 16, 16);

        for (var i = 0; i < 16; i++) {

            var tile = cq(16, 16);

            tile.fillStyle("#d9a066");

            if (i & 1)
                tile.fillRect(0, 0, 4, 16);
            if (i & 2)
                tile.fillRect(0, 0, 16, 4);
            if (i & 4)
                tile.fillRect(16 - 4, 0, 4, 16);
            if (i & 8)
                tile.fillRect(0, 16 - 4, 16, 4);

            tile.strokeStyle("#000").lineWidth(2).strokeRect(0, 0, 16, 16);

            temp.drawImage(tile.canvas, i * 16, 0);

        }

        window.open(temp.canvas.toDataURL());
        document.body.appendChild(temp.canvas);

    },

    step: function(dt) {
    },

    render: function(dt) {

        if (!this.loading)
            this.offscreen();

    },

    offscreen() {

        let gl = this.gl;

        app.painter.setFramebuffer(null);

        gl.viewport(0, 0, app.canvas.width, app.canvas.height);

        var projectionMatrix = Matrix3.projection(app.canvas.width, app.canvas.height);

        gl.clearColor(0.0, 0.0, 0.0, 1.0);
        gl.colorMask(1.0, 1.0, 1.0, 1.0);
        gl.clear(gl.COLOR_BUFFER_BIT);

        for (var key in app.programs) {

            let program = app.programs[key];

            gl.useProgram(program.native);

            program.set("viewMatrix", projectionMatrix);

        }

        // var pixels = new Uint8Array(gl.drawingBufferWidth * gl.drawingBufferHeight * 4);
        // gl.readPixels(0, 0, 128, 128, gl.RGBA, gl.UNSIGNED_BYTE, pixels);

        this.trigger("offscreen");

    },

    postrender: function() {
    },

    pointermove: function(e) {
    },

    pointerup: function(e) {
    },

    pointerdown: function(e) {
    },

    pointerwheel: function(e) {
    },

    pointerdoubletap: function(e) {
    },

    keyup: function(e) {
    },

    beforeresize: function() {
    // this.scale = 2;

    // this.scale = Math.min(window.innerWidth, window.innerHeight) / 800;
    // Math.min(2, PLAYGROUND.MOBILE ? 2 : Math.max(2, window.innerWidth / 500) | 0);

    },

    setGold(gold) {

        this.user.gold = gold;

    },

    getGoldReward(mode) {

        let modeData = COMMON.modes[mode];
        let max = app.lobby.maxMMR[modeData.scoreKey];
        let mmr = app.user[modeData.scoreKey];

        let reward = 10 + (mmr / max) * COMMON.RANKED_MAX_REWARD | 0;

        return reward;

    },

    osc(period=1.0, offset=0.0) {

        return (1.0 + Math.sin((this.lifetime + offset) * Math.PI * 2 / period)) / 2.0;

    },

    cycle(index, count, transition, spacing) {

        let segment = (spacing + transition * 2);
        let duration = segment * count;
        let normalized = (this.lifetime % duration) - segment * index;

        if (normalized < 0 || normalized > segment)
            return 0;
        else if (normalized < transition)
            return Math.sin(Math.PI * 0.5 * (normalized / transition));
        else if (normalized > segment - transition)
            return Math.sin(Math.PI * 0.5 + Math.PI * 0.5 * ((normalized - transition - spacing) / transition));
        else
            return 1.0;

    },

    resize: function() {

        let scale = this.forceScale || 1.0;

        scale = window.innerWidth > 1024 ? 2.0 : 1.0;

        if (this.canvas) {

            this.width = window.innerWidth / scale;
            this.height = window.innerHeight / scale;
            this.scale = scale;

            this.canvas.width = this.width;
            this.canvas.height = this.height;
            this.canvas.style.transform = "scale(" + (this.scale) + ")";
            this.canvas.style.transformOrigin = "left top";

            this.gl.viewport(0, 0, this.canvas.width, this.canvas.height);

            this.pixelWidth = 1.0 / this.width;
            this.pixelHeight = 1.0 / this.height;

        }

    },

    enhancableElements: ["gui-slot", "gui-button", "gui-clickable", "enhance"],

    enhanceElement(element) {

        let enhance = false;

        for (var i = 0; i < this.enhancableElements.length; i++) {

            let className = this.enhancableElements[i];

            if (element.className.indexOf(className) > -1) {
                enhance = true;
                break
            }

        }

        if (!enhance)
            return;

        if (element.className.indexOf("gui-slot") > -1 || element.className.indexOf("gui-button") > -1 || element.className.indexOf("gui-clickable") > -1) {
            this.enhanceElementWithSound(element, "mouseenter", "ui/hover");
            this.enhanceElementWithSound(element, "mousedown", "ui/press");
            this.enhanceElementWithSound(element, "mouseup", "ui/release");
        }

        if (element.getAttribute("tooltip"))
            $(element).tooltip(element.getAttribute("tooltip"));

    },

    enhanceElementWithSound(element, eventName, sound) {

        element.addEventListener(eventName, function() {

            app.sound.play(sound);

        });

    },

    iframe: function(url) {

        var iframe = document.createElement("iframe");

        iframe.setAttribute("src", url);

        document.body.appendChild(iframe);

    },

    parseUI: function(key) {

        var html = this.data[key];

        html = html.replace(/{lang:(.*)}/g, function(full, key) {

            return app.lang(key);

        });

        var div = document.createElement("div");

        div.innerHTML = html;

        var $container = $(div.childNodes[0]);

        $container.find("[ui-id]").each(function() {

            var id = $(this).attr("ui-id");

            $container["$" + id] = $(this);

        });

        return $container;

    },

    mmrToIcon: function(mmr) {

        var factor = Math.min(0.99, mmr / app.lobby.maxMMR["arena1"]);

        return factor * COMMON.RANK_ICONS.length | 0;

    }

};

if ($_GET['ref'] === 'gamedistribution') {

    appConfig.scale = window.innerWidth / 1000;

} else {

    appConfig.width = 1000;

}

var app = new PLAYGROUND.Application(appConfig);

PLAYGROUND.Application.prototype.getColoredImage = function(key, color, mode, amount) {

    if (typeof mode === "undefined")
        mode = "source-in";

    if (typeof key === "string") {

        var image = this.images[key];

    } else {

        var image = key;

    }

    var storekey = key + color + mode;

    if (!image[storekey]) {

        var temp = cq(image).clone().blend(color, mode, amount || 1.0);

        image[storekey] = temp.cache();

        this.toImageBitmap(image, storekey)

    }

    return image[storekey];

}
;

PLAYGROUND.Application.prototype.getOutlinedImage = function(key, color, mode, amount) {

    if (typeof key === "string") {

        var image = this.images[key];

    } else {

        var image = key;

        if (!image.uniqid)
            image.uniqid = String(Math.random());

        key = image.uniqid;

    }

    var storekey = "outline" + key + color;

    if (!image[storekey]) {

        var temp = cq(image).clone();
        var outline = temp.clone().outline(color);

        // temp.blend(outline.canvas, mode, amount || 1.0)

        temp.a(amount || 1.0);

        temp.drawImage(outline.canvas, 0, 0)

        image[storekey] = temp.cache();

    }

    return image[storekey];

}
;

PLAYGROUND.Application.prototype.toImageBitmap = function(object, key) {

    return;

    if (!window.chrome)
        return;

    if (!window.createImageBitmap)
        return;

    createImageBitmap(object[key]).then(function(response) {

        object[key] = response;

    });

}
;

CanvasQuery.Layer.prototype.textWithBackground = function(text, x, y, background, padding) {
    var w = this.measureText(text).width;
    var h = this.fontHeight() * 0.8;
    var f = this.fillStyle();
    var padding = padding || 2;

    var a = this.context.textAlign;

    if (a === "center")
        x -= w / 2;

    this.fillStyle(background).fillRect(x - padding * 2 | 0, y - padding | 0, w + padding * 4, h + padding * 2)
    this.fillStyle(f).textAlign("left").textBaseline("top").fillText(text, x | 0, y | 0);

    return this;
}
;

SoundOnDemand.Sound.prototype.gpan = function(o) {

    var distX = (o.x - app.game.camera.center.x) / (app.width * 0.5);
    // var distY = Math.abs((o.y - app.game.camera.center.y) / (app.width * 0.5));

    var pan = distX;
    // var vol = this.current.volume * (1 - Math.max(Math.abs(distX), distY));
    // .volume(vol);

    this.pan(pan || 0);

    return this;

}

SoundOnDemand.Sound.prototype.limitVolume = function() {

    let divide = 0;

    for (var i = 0; i < this.channel.queue.length; i++) {

        let sound = this.channel.queue[i];

        if (sound.key !== this.key)
            continue;

        if (sound === this)
            continue;

        divide++;

    }

    this.volume(this.current.volume / divide);

    return this;

}
;

SoundOnDemand.Sound.prototype.grate = function(rate, gender) {

    this.rate(rate + gender * 1.0);

    return this;

}

document.body.querySelector("#disableMusic").addEventListener("click", function() {

    // app.bgmusic.stop();

    this.style.display = "none";

});

document.body.querySelector("#fullscreen").addEventListener("click", function() {

    var el = document.body;

    // app.layer.canvas;

    if (el.requestFullscreen) {

        el.requestFullscreen();

    } else if (el.msRequestFullscreen) {

        el.msRequestFullscreen();

    } else if (el.mozRequestFullScreen) {

        el.mozRequestFullScreen();

    } else if (el.webkitRequestFullscreen) {

        el.webkitRequestFullscreen();

    }

    app.fullscreen = true;

});

var errlogs = 0;

window.onerror = function(message, where, line, char, error) {

    if (++errlogs > 3)
        return;

    var msg = {
        ua: uaparser.getBrowser(),
        msg: message,
        stack: error.stack
    };

    Utils.xpost(`//${ENV.LOBBY_URL}/report-error`, msg);
    // Utils.xpost("http://localhost:9111/error", msg);

}

app.inputTranslation = {

    mouseleft: "MOUSE LEFT BUTTON",
    mouseright: "MOUSE RIGHT BUTTON",
    mousewheelup: "MOUSE WHEEL UP",
    mousewheeldown: "MOUSE WHEEL DOWN"

};

app.getInputHTML = function(command) {

    let key = this.controls[command][0] || "NONE";

    return (this.inputTranslation[key] || key).toUpperCase();

}

$("#zoomIn").on("click", function() {

    app.game.camera.scale = Math.min(2.0, app.game.camera.scale + 0.2);

});

$("#zoomOut").on("click", function() {

    app.game.camera.scale = Math.max(0.6, app.game.camera.scale - 0.1);

});

$.fn.enhance = function() {

    let $this = $(this).find('*').addBack().each(function(index, element) {
        app.enhanceElement(element);
    });

}
;

setTimeout(function() {

    $(".ad").on("mousedown", function() {

        if (window.fbq)
            fbq('trackCustom', 'AdClick');

        if (window.analytics)
            analytics('send', 'event', 'ads', 'click', app.adstate);

    });

    if (false && window.navigator.languages) {

        $("#SuperGroup").hide();
        $("#gamezoo").hide();
        $("#IOG_CP").hide();

        var show = true;

        for (var i = 0; i < window.navigator.languages.length; i++) {

            var lang = window.navigator.languages[i];

            if (["us", "en-us", "en-US", "en_us", "en_US"].indexOf(lang) > -1) {

                show = false;
                break;

            }

        }

        if (show) {
            $("#SuperGroup").show();
            $("#gamezoo").show();
            $("#IOG_CP").show();
        }

    }

}, 1000);

PLAYGROUND.Application.prototype.promises = {};

Motion.prototype._playSound = function(file) {

    return app.sound.play("<" + file + ">");

}
;
